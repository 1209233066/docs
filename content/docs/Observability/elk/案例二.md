---
date: '2025-09-12T15:22:40+08:00'
draft: false
title: '收集操作系统日志'
linkTitle: '收集操作系统日志'
type: blog
toc_hide: false
hide_summary: true
weight: 7
description: >
  使用filebeat收集linux操作系统日志
tags: ["linux","filebeat"]
categories: ["ELK"]
url: elk/example/linux.html
author: "wangendao"
---

{{% alert title="文档环境" color="" %}}

os 版本： `CentOS Linux release 7.9.2009 (Core)`

filebeat版本：`7.17.19`

elasticsearch版本： `7.15.0`

{{% /alert %}}



| 日志                                           | 路径                        | 日志格式                                                     |
| ---------------------------------------------- | --------------------------- | ------------------------------------------------------------ |
| 查看系统启动、硬件                             | `dmesg` 或 `/var/log/dmesg` |                                                              |
| 系统日志，记录内核、服务、应用程序的非关键信息 | `/var/log/messages`         |                                                              |
| 用户登录日志                                   | `/var/log/secure`           |                                                              |
| `cron` 定时任务日志                            | `/var/log/cron`             | `Sep 17 15:58:01 mysql-uat02-s3 CROND[16632]: (root) CMD (/usr/bin/echo 1 &>/dev/null)` |
| 审计日志                                       | `/var/log/audit/audit.log`  |                                                              |
| yum日志                                        | `/var/log/yum.log`          |                                                              |
| `postfix` 或 `sendmail` 等邮件服务的日志       | `/var/log/maillog`          |                                                              |



修改启动文件



```bash
cat >/data/elasticsearch/filebeat.sh<<'EOF'
#!/bin/bash

export power_time=$(uptime -s)
export power_timestamp=$(date -d "$power_time" +%s)
/data/elasticsearch/filebeat/filebeat --environment systemd $@
EOF

chmod +x /data/elasticsearch/filebeat.sh
```



```bash
tee /etc/systemd/system/filebeat.service <<'EOF'
[Unit]
Description=Filebeat sends log files to Logstash or directly to Elasticsearch.
Documentation=https://www.elastic.co/products/beats/filebeat
Wants=network-online.target
After=network-online.target

[Service]


Environment="BEAT_LOG_OPTS="
Environment="BEAT_CONFIG_OPTS=-c /data/elasticsearch/filebeat/filebeat.yml"
Environment="BEAT_PATH_OPTS=--path.home /data/elasticsearch/filebeat --path.config /data/elasticsearch/filebeat --path.data /data/elasticsearch/filebeat/data --path.logs /data/elasticsearch/filebeat/logs"
ExecStart=/data/elasticsearch/filebeat.sh $BEAT_LOG_OPTS $BEAT_CONFIG_OPTS $BEAT_PATH_OPTS
Restart=always

[Install]
WantedBy=multi-user.target

EOF
```

```bash
systemctl daemon-reload
systemctl enable filebeat --now
systemctl status filebeat
```





```yaml
cat >/data/elasticsearch/filebeat/filebeat.yml <<'EOF'
filebeat.inputs:
- type: filestream
  enabled: true
  id: osMessage
  paths:
  - "/var/log/messages"
  tags: ["osMessage"]
  exclude_lines:
  - "^$"
  
- type: filestream
  enabled: true
  id: osDmesg
  paths:
  - "/var/log/dmesg"
  tags: ["osDmesg"]
  exclude_lines:
  - "^$"
  processors:
  - dissect:
      tokenizer: "[%{dmesg_seconds}] %{msg}"
      target_prefix: ""
  - script:
      lang: javascript
      id: dmesg_ts
      params:
        power_timestamp: ${power_timestamp} # 环境变量
      source: >
        var params = {};
        function register(scriptParams) {
          params = scriptParams;
        }
        function process(event) {
            // 操作系统启动时间
            var bootSec = parseFloat(event.Get("dmesg_seconds"));

            event.Put(
            	"LOG_RECORD_TIME",
            	new Date(parseFloat(params.power_timestamp)*1000 + bootSec*1000).toISOString()
            	)
        }
        
processors:
- rename:
    fields:
    - from: log.file.path
      to: FILE_PATH
    - from: message
      to: LOG

output.elasticsearch:
  hosts: ["192.168.0.114:9200"]
  indices:
    - index: "zero-dew-linux-os-message-%{+yyyy.MM.dd}"
      when:
        contains:
          tags: "osMessage"
    - index: "zero-dew-linux-os-dmesg-%{+yyyy.MM.dd}"
      when:
        contains:
          tags: "osDmesg"

setup.ilm.enabled: false
setup.template.enabled: true
setup.template.name: "zero-dew"
setup.template.pattern: "zero-dew-*"
setup.template.overwrite: true

setup.template.settings:
  index.number_of_shards: 3
  index.number_of_replicas: 0

EOF
```

