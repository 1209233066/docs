---
date: '2025-06-26T15:04:12+08:00'
draft: false
title: '告警收敛'
type: blog
toc_hide: false
hide_summary: true
weight: 5
description: >
  告警收敛,减少告警噪音
tags: ["alertmanager"]
categories: ["告警"]
url: prometheus/alertmanager/group.html
author: "wangendao"
---
需求：
  1.按照故障等级，故障名称进行告警收敛
顶级路由`group_wait` 和 `repeat_interval` 验证步骤：

  1. 发送告警示例1，预期30s后收到告警   
  2. 等待步骤1完成后，再次发送告警示例1，预期10m + 30s 后收到告警
顶级路由`group_interval`  验证步骤：
  1. 发送告警示例1，在过20s后发送告警示例2，预期在告警2发送后20s收到告警 

子路由 `group_wait` 和 `repeat_interval` 验证步骤：
  1. 发送告警示例3，预期10m后收到告警
  2. 等待步骤1完成后，再次发送告警示例3，预期1h后收到告警

子路由 `group_interval`  验证步骤：
  1. 发送告警示例3，在过5m后发送告警示例4，预期在告警4发送后10m收到告警


```yaml
global:
  resolve_timeout: 30m
route:
  receiver: 'webhook'
  group_by: ['alertname']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 10m
  
  routes:
  - receiver: 'webhook'
    group_by: ['alertname']
    group_wait: 10m
    group_interval: 20m
    repeat_interval: 1h
    matchers:
    - alertname=~"database|web"
    - severity="E4"

receivers:
  - name: 'webhook'
    webhook_configs:
    - url: 'http://127.0.0.1:5001'
      send_resolved: true
```

{{< tabpane text=true right=false >}}
  {{% tab header="告警示例1" lang="bash" %}}
```bash
curl -X POST -H "Content-Type: application/json" -d '[
    {
        "labels": {
            "alertname": "cpuHigh",
            "instance": "node01:9100",
            "job": "node_exporter",
            "severity": "E3"
        },
        "annotations": {
            "description": "node01:9100 of job node_exporter has been used cpu >85 more than 5 minutes. (current value: 89.99%)",
            "summary": "Instance node01:9100 cpu usage more than 85%"
        },
        "generatorURL": "http://prometheus.pytc.com/prom"

    }
]' "http://127.0.0.1:9093/alert/api/v2/alerts"

```
  {{% /tab %}}
  {{% tab header="告警示例2" lang="bash" %}}
```bash
curl -X POST -H "Content-Type: application/json" -d '[
    {
        "labels": {
            "alertname": "cpuHigh",
            "instance": "node02:9100",
            "job": "node_exporter",
            "severity": "E3"
        },
        "annotations": {
            "description": "node02:9100 of job node_exporter has been used cpu >85 more than 5 minutes. (current value: 99.99%)",
            "summary": "Instance node02:9100 cpu usage more than 85%"
        },
        "generatorURL": "http://prometheus.pytc.com/prom"

    }
]' "http://127.0.0.1:9093/alert/api/v2/alerts"

```
  {{% /tab %}}
  {{% tab header="告警示例3" lang="bash" %}}

```bash
curl -X POST -H "Content-Type: application/json" -d '[
    {
        "labels": {
            "alertname": "database",
            "instance": "node01:9100",
            "job": "node_exporter",
            "severity": "E3"
        },
        "annotations": {
            "description": "node01:9100 of job node_exporter has been used cpu >85 more than 5 minutes. (current value: 89.99%)",
            "summary": "Instance node01:9100 cpu usage more than 85%"
        },
        "generatorURL": "http://prometheus.pytc.com/prom"

    }
]' "http://127.0.0.1:9093/alert/api/v2/alerts"

```
  {{% /tab %}}
  {{% tab header="告警示例4" lang="bash" %}}

```bash
curl -X POST -H "Content-Type: application/json" -d '[
    {
        "labels": {
            "alertname": "database",
            "instance": "node01:9100",
            "job": "node_exporter",
            "severity": "E4"
        },
        "annotations": {
            "description": "node01:9100 of job node_exporter has been used cpu >85 more than 5 minutes. (current value: 89.99%)",
            "summary": "Instance node01:9100 cpu usage more than 85%"
        },
        "generatorURL": "http://prometheus.pytc.com/prom"

    }
]' "http://127.0.0.1:9093/alert/api/v2/alerts"

```
  {{% /tab %}}
{{< /tabpane >}}
