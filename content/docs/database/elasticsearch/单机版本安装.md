---
date: '2025-06-12T15:22:40+08:00'
draft: false
title: '单机版本安装'
linkTitle: '单机版本安装'
type: blog
toc_hide: false
hide_summary: true
weight: 1
description: >
  部署单机版本elasticsearch
tags: ["elasticsearch"]
categories: ["ELK"]
url: elasticsearch/install.html
author: "wangendao"
---



{{% alert title="" color="" %}}
文档适用于操作系统centos7.x  和 elasticsearch `7.15.0 ` 、`8.8.1`

+ elasticsearch 依赖jdk 环境，[如果无法判断使用哪个版本jdk]( https://www.elastic.co/cn/support/matrix#matrix_jvm)。可以[下载](https://www.elastic.co/cn/downloads/past-releases#elasticsearch)/[国内下载镜像](https://repo.huaweicloud.com)带有jdk版本的elasticsearch。

+ 启动后监听本机的9200端口为客户端提供数据访问，监听9300端口用于集群内部集群选举和数据同步。

+ elasticsearch 属于io密集型应用，尽可能把数据目录单独挂载出来。并使用高性能磁盘。

{{% /alert %}}



### 单机部署



1. max_map_count 

   > 内存映射（Memory Mapping）是一种在应用程序地址空间和物理存储器之间建立映射关系的技术
   >
   > `max_map_count` 参数是用于限制每个进程能够使用的最大内存映射区域数量。
   >
   > 如果不修改，启动时提示错误： *max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]*
   >
   
   ```bash
   sysctl -w vm.max_map_count=655360
   echo 'vm.max_map_count=655360' >>/etc/sysctl.conf
   ```
   
1. <font color=red>当开启内存锁定后，以下参数必须设定</font>

   > 报错信息： memory locking requested for elasticsearch process but memory is not locked
   
   ```bash
   echo "DefaultLimitMEMLOCK=infinity" >>/etc/systemd/system.conf
   ```
   
   ```bash
   # 该命令会重启systemd 进程
   systemctl daemon-reexec
   ```
   
1. 文件描述符设置

   以下内容建议执行，不执行并不会导致报错
   
   ```bash
   cat >>/etc/security/limits.conf<<EOF
   * soft nofile 65536
   * hard nofile 65536
   * soft nproc 32000
   * hard nproc 32000
   * hard memlock unlimited
   * soft memlock unlimited
   EOF
   ```
   
   
   
   ```bash
   cat >> /etc/systemd/system.conf<<EOF
   DefaultLimitNOFILE=65536
   DefaultLimitNPROC=32000
   DefaultLimitMEMLOCK=infinity
   EOF
   ```
   
   
   
2. 添加服务用户

   > elasticsearch 不能以root用户启动

   ```bash
   useradd  elasticsearch
   ```

   

3. 创建数据目录

   ```bash
   lvcreate -L 500G --thinpool data centos
   lvcreate -n elasticsearch --virtualsize 500G --thinpool data seagullcore
   mkfs.ext4 /dev/mapper/seagullcore-elasticsearch
   # 
   mkdir /data/elasticsearch -p
   # 挂载
   mount /dev/mapper/seagullcore-elasticsearch /data/elasticsearch
   echo "$(blkid /dev/mapper/seagullcore-elasticsearch | awk -F '"' '{printf "UUID=%s", $2}') /data/elasticsearch ext4 defaults 0 0" >>/etc/fstab
   ```
   
   
   
3. 下载安装包

   *安装java*

   ```bash
   wget https://download.java.net/java/ga/jdk11/openjdk-11_linux-x64_bin.tar.gz
   tar xf openjdk-11_linux-x64_bin.tar.gz -C /opt
   ln -svf  /opt/{jdk-11,jdk}
   
   cat>>/etc/profile<<'EOF'
   export JAVA_HOME=/opt/jdk
   export JAVA_JRE=$JAVA_HOME/jre
   export CLASSPATH=$JAVA_HOME/lib:$JAVA_HOME/jre/lib
   export PATH=$JAVA_HOME/bin:$JAVA_JRE/bin:$PATH:.
   EOF
   
   source /etc/profile
   java -version
   ```

   *安装elasticsearch*

   ```bash
   version=8.8.1
   
   wget https://repo.huaweicloud.com/elasticsearch/${version}/elasticsearch-${version}-linux-x86_64.tar.gz
   
   tar xf elasticsearch-${version}-linux-x86_64.tar.gz -C /data/elasticsearch
   ```

4. 修改配置文件

   ```bash
   tee /data/elasticsearch/elasticsearch-${version}/config/elasticsearch.yml <<EOF
   cluster.name: my-application
   node.name: node-1
   path.data: /data/elasticsearch/elasticsearch-data
   
   path.logs: /data/elasticsearch/elasticsearch-log
   # 是否在程序启动时立即分配指定大小内存给elasticsearch进程
   bootstrap.memory_lock: false 
   network.host: 0.0.0.0
   http.port: 9200
   
   cluster.initial_master_nodes: ["node-1"]
   EOF
   ```

   ```bash
   mkdir /data/elasticsearch/elasticsearch-data
   mkdir /data/elasticsearch/elasticsearch-log
   ```

   ```bash
   chown -R elasticsearch:elasticsearch /data/elasticsearch
   ```

   

6. 创建systemd启动文件

   {{% alert title="使用命令启动elasticsearch验证" color="" %}}

   ```bash
   su - elasticsearch -c \
   /data/elasticsearch/elasticsearch-${version}/bin/elasticsearch
   ```

   {{% /alert %}}

   

   ```bash
   tee /etc/systemd/system/elasticsearch.service <<EOF
   [Unit]
   Description= elasticsearch serveice
   After=network.target
    
   [Service]
   WorkingDirectory=/data/elasticsearch/elasticsearch-${version}
   ExecStart=/data/elasticsearch/elasticsearch-${version}/bin/elasticsearch
   User=elasticsearch
   LimitNOFILE=65535
   [Install]
   WantedBy=multi-user.target
   EOF
   ```

   ```bash
   systemctl daemon-reload
   systemctl enable elasticsearch --now
   systemctl status elasticsearch
   ```

   *启动日志*

   ```log
   ✅ Elasticsearch security features have been automatically configured!
   ✅ Authentication is enabled and cluster connections are encrypted.
   
   ℹ️  Password for the elastic user (reset with `bin/elasticsearch-reset-password -u elastic`):
     FcbikS-B88goqIIR65H=
   
   ℹ️  HTTP CA certificate SHA-256 fingerprint:
     35235d8fac4c43cf8f12ebf0a9a7c50a7f8796ebfa38be00bd9faf0934257ff4
   
   ℹ️  Configure Kibana to use this cluster:
   • Run Kibana and click the configuration link in the terminal when Kibana starts.
   • Copy the following enrollment token and paste it into Kibana in your browser (valid for the next 30 minutes):
     eyJ2ZXIiOiI4LjguMSIsImFkciI6WyIxOTIuMTY4LjAuMTYxOjkyMDAiXSwiZmdyIjoiMzUyMzVkOGZhYzRjNDNjZjhmMTJlYmYwYTlhN2M1MGE3Zjg3OTZlYmZhMzhiZTAwYmQ5ZmFmMDkzNDI1N2ZmNCIsImtleSI6ImNtYVVXSmNCQzN2UnctdlB3T09OOkRPVGRETWJXVGpTV0Y3YU1xU1lXVUEifQ==
   
   ℹ️ Configure other nodes to join this cluster:
   • Copy the following enrollment token and start new Elasticsearch nodes with `bin/elasticsearch --enrollment-token <token>` (valid for the next 30 minutes):
     eyJ2ZXIiOiI4LjguMSIsImFkciI6WyIxOTIuMTY4LjAuMTYxOjkyMDAiXSwiZmdyIjoiMzUyMzVkOGZhYzRjNDNjZjhmMTJlYmYwYTlhN2M1MGE3Zjg3OTZlYmZhMzhiZTAwYmQ5ZmFmMDkzNDI1N2ZmNCIsImtleSI6ImNXYVVXSmNCQzN2UnctdlB3T09OOkFYOWc5ZHFnU1A2SWxJOFlPRmNldVEifQ==
   
     If you're running in Docker, copy the enrollment token and run:
     `docker run -e "ENROLLMENT_TOKEN=<token>" docker.elastic.co/elasticsearch/elasticsearch:8.8.1`
   ```

   

6. 验证服务

   通常情况下使用 `elasticsearch-head` 插件来监听elasticsearch。也可以使用[api接口来查询](https://www.elastic.co/guide/en/elasticsearch/reference/6.0/_cluster_health.html)

   {{% alert title="" color="" %}}
   
   + 通过chrome 商店安装，需要vpn
   + 通过github上提供的docker 镜像启动
   
   ```bash
   #由于前后端服务做了分离，因此需要开启elasticsearch跨域请求
   http.cors.enabled: true 
   http.cors.allow-origin: "*"
   ```
   
   ```bash
   docker run --rm -it -p9100:9100 mobz/elasticsearch-head:5-alpine
   ```
   
   {{% /alert %}}
   
   
   
   查看当前集群状态
   
   ```bash
   curl https://127.0.0.1:9200/_cat/nodes?v
   curl -s  http://127.0.0.1:9200/_cluster/health?pretty=true |jq ".status"
   ```
   



### 监控exporter

```bash
docker run --rm -it -p9114:9114 quay.io/prometheuscommunity/elasticsearch-exporter:latest --es.uri=http://10.4.7.250:9200
```

