---
date: '2025-08-01T10:10:00+08:00'
draft: false
title: 'mysql数据库搬迁'
type: blog
toc_hide: false
hide_summary: true
weight: 9
description: >
  数据中心搬迁，龙腾出行mysql数据库迁移
tags: ["迁移案例"]
categories: ["mysql"]
url: mysql/longtengchuxing.html
author: "wangendao"
---



| 版本   | 旧环境                                                       | 新环境                                                       | root密码           |
| ------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------ |
| 8.0.22 | 192.168.100.157  主库  4C  32GB  350G  + 100GB <br/>192.168.100.158   从库. 4C  32GB  350G  + 0GB | 已部署<br/>10.128.99.157  主库   主库  4C  32GB /Data=  350G  + /Backup = 100GB <br/>10.128.99.158   从库  从库. 4C  32GB /Data= 350G  +  /Backup = null | d988ec6a93!@#MYSQL |

### 全量迁移

并发请求不高，在主节点执行全量备份

```bash
yum install -y percona-xtrabackup-80.x86_64 
```

> 耗时14分钟

```bash
xtrabackup \
--defaults-file=/etc/mysql80/mysql80_6301.cnf \
--backup \
--user="root" --password='d988ec6a93!@#MYSQL' --port=6301 \
--target-dir="/Backup/fullbackup-$(date +%F)" \
--compress --compress-threads=1  2>&1 | tee /tmp/mysql6301_$(date +%F_%H%M%S).log
```



```bash
# 限速50MB
# 10.128.99.157 10.128.99.158
#### service mysql stop
#### rm -fr /Data/bak/* 
#### rm -fr /Data/mysql6301/* &&  mkdir /Data/mysql6301/{binlog,data,log} -p ;touch /Data/mysql6301/log/mysqld-error.log 

# 10分
scp -l 409600 -rp /Backup/fullbackup-2025-08-01/* bak@10.128.99.157:/Data/bak/
scp -l 409600 -rp /Backup/fullbackup-2025-08-01/* bak@10.128.99.158:/Data/bak/
```

全量恢复

{{% alert title="" color="warning" %}}
从库备份时会将主从复制关系备份过来, 恢复数据时希望手动指定复制关系，可以通过只读参数取消**slave进程**启动
```ini
[mysqld]
skip_slave_start = ON
```

{{% /alert %}}

```bash
# 解压 16gb 耗时 2分钟
xtrabackup --decompress --parallel=2 --target-dir=/Data/bak --remove-original
# 应用undolog
xtrabackup --prepare --apply-log-only --target-dir=/Data/bak
xtrabackup --prepare --target-dir=/Data/bak
# 拷贝全量备份到datadir
xtrabackup --defaults-file=/etc/my.cnf --copy-back --target-dir=/Data/bak
```

```bash
chown -R mysql.mysql /Data/mysql6301
service mysql start 
chkconfig mysql on
```

设置只读

```sql
mysql -h 10.128.99.157 --port=6301 -uroot -p'd988ec6a93!@#MYSQL' -e "
set global super_read_only=on; set global read_only=on;
show variables like 'super_read_only';
show variables like 'read_only';
"
```

```sql
mysql -h 10.128.99.158 --port=6301 -uroot -p'd988ec6a93!@#MYSQL' -e "
set global super_read_only=on; set global read_only=on;
show variables like 'super_read_only';
show variables like 'read_only';
"
```



### 增量同步

```sql
CREATE USER 'replUser'@'%' IDENTIFIED  BY 'RsU#58d1@' WITH mysql_native_password ; 
GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO 'replUser'@'%'; 
flush privileges;
```



查找全备时binlog位置



```bash
[root@db3-mysql80-m ~]# cat /Data/bak/xtrabackup_binlog_info 
mysql-bin.000451       156
```

```sql
mysql -h 10.128.99.157 --port=6301 -uroot -p'd988ec6a93!@#MYSQL' -e "
reset slave all;
CHANGE MASTER TO 
    MASTER_HOST='192.168.100.157',
    MASTER_PORT=6301,
    MASTER_USER='replUser',
    MASTER_PASSWORD='RsU#58d1@',
    MASTER_LOG_FILE='mysql-bin.000451',
    MASTER_LOG_POS=156;

start slave ;
show slave status \G
"
```



```bash
mysql -h 10.128.99.158 --port=6301 -uroot -p'd988ec6a93!@#MYSQL' -e "
reset slave all;
CHANGE MASTER TO 
    MASTER_HOST='10.128.99.157',
    MASTER_PORT=6301,
    MASTER_USER='replUser',
    MASTER_PASSWORD='RsU#58d1@',
    MASTER_LOG_FILE='mysql-bin.000453',
    MASTER_LOG_POS=156;

start slave ;
show slave status \G
"
```



### 数据对比


检查主从同步状态
```sql
mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.157 -e "show slave status\G show variables like '%read_only%'"|grep -E "Slave_IO_Running:|Slave_SQL_Running:|Seconds_Behind_Master:|read_only"

mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.158 -e "show slave status\G show variables like '%read_only%'"|grep -E "Slave_IO_Running:|Slave_SQL_Running:|Seconds_Behind_Master:|read_only"
```

统计数据库元数据信息。确保数据库数量、表数量、索引数量、触发器、函数、存储过程、用户数量一致
```sql
mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.158 -e "
SELECT 
    object_type,
    COUNT(*) AS count
FROM (
    SELECT 'Users' AS object_type FROM mysql.user
    UNION ALL
    SELECT 'Databases' FROM information_schema.SCHEMATA WHERE SCHEMA_NAME NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
    UNION ALL
    SELECT 'Tables' FROM information_schema.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
    UNION ALL
    SELECT 'Views' FROM information_schema.VIEWS WHERE TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
    UNION ALL
    SELECT 'Triggers' FROM information_schema.TRIGGERS WHERE TRIGGER_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
    UNION ALL
    SELECT 'Routines' FROM information_schema.ROUTINES WHERE ROUTINE_TYPE IN ('FUNCTION', 'PROCEDURE') AND ROUTINE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
    UNION ALL
    SELECT 'Events' FROM information_schema.EVENTS WHERE EVENT_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
    UNION ALL
    SELECT 'Indexes' FROM information_schema.STATISTICS WHERE TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
) AS all_objects
GROUP BY object_type WITH ROLLUP;
"
```



### 应用切割


1. 网络层做隔离(网络工程师)

2. 旧库设置只读，杀连接 192.168.100.157

   ```sql
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 192.168.100.157  -e "set global read_only=on;set global super_read_only=on;show variables like '%read_only%';"
   
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 192.168.100.157    -e "SELECT CONCAT('KILL ', id, ';') FROM information_schema.processlist WHERE user NOT IN ('root', 'replUser','event_scheduler');"  | grep -v CONCAT > /tmp/kill192.168.100.157
   
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 192.168.100.157  < /tmp/kill192.168.100.157
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 192.168.100.157   -e "show processlist;"
   ```

   旧库设置只读，杀连接 192.168.100.158

   ```bash
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 192.168.100.158  -e "set global read_only=on;set global super_read_only=on;show variables like '%read_only%';"
   
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 192.168.100.158    -e "SELECT CONCAT('KILL ', id, ';') FROM information_schema.processlist WHERE user NOT IN ('root', 'replUser','event_scheduler');"  | grep -v CONCAT > /tmp/kill192.168.100.158
   
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 192.168.100.158  < /tmp/kill192.168.100.158
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 192.168.100.158   -e "show processlist;"
   ```

   

3. 停旧库和新库之间的数据同步

   ```bash
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.157  -e "show slave status\G" >/tmp/last_slave_state
   
   sleep 5;
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.157  -e "stop slave;reset slave all;show slave status\G"
   ```

   

   

4. 记录当前binglog位置用于回滚

   ```sql
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.157 -e "show master status;" >/tmp/binlog_rollback_info
   ```

   

5. 创建双主关系 10.128.99.157 --> 10.128.99.158

   {{% alert title="多次执行确认master 位置不在变化" color="warning" %}}

   ```sql
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.158 -e "show master status;" |tee /tmp/master1012899158
   
   cat /tmp/master1012899158
   ```

   

   {{% /alert %}}

   

   ```sql
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.157 -e "
   CHANGE MASTER TO
   MASTER_HOST='10.128.99.158',
   MASTER_PORT=6301,
   MASTER_USER='replUser',
   MASTER_PASSWORD='RsU#58d1@',
   MASTER_LOG_FILE='',
   MASTER_LOG_POS=;
   "
   ```

   启动主从关系

   ```bash
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.157 -e "start slave ; show slave status \G"
   ```

   

6. 新库关闭只读

   ```sql
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.157 -e "
   set global read_only=off;
   set global super_read_only=off;
   show variables like '%read_only%';
   "
   ```

   ```sql
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.158 -e "
   set global read_only=off;
   set global super_read_only=off;
   show variables like '%read_only%';
   "
   ```

   

7. 观察连接情况

   ```sql
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.157  -e "show processlist;show variables like '%read_only%';"
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.158  -e "show processlist;show variables like '%read_only%';"
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 192.168.100.157  -e "show processlist;show variables like '%read_only%';"
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 192.168.100.158  -e "show processlist;show variables like '%read_only%';"
   ```

   

### 回退环境搭建


```sql
mysql -uroot  -p'd988ec6a93!@#MYSQL' --port=6301 -h 192.168.100.157 -e "
stop slave; reset slave all; show slave status \G
"
```



```bash
cat /tmp/binlog_rollback_info
```

```bash
mysql -uroot  -p'd988ec6a93!@#MYSQL' --port=6301 -h 192.168.100.157 -e \
"CHANGE MASTER TO
MASTER_HOST='10.128.99.157',
MASTER_PORT=6301,
MASTER_USER='replUser',
MASTER_PASSWORD='RsU#58d1@',
MASTER_LOG_FILE='',
MASTER_LOG_POS=;"
```

```bash
mysql -uroot  -p'd988ec6a93!@#MYSQL' --port=6301 -h 192.168.100.157 -e "start slave;show slave status\G"
```

### 执行回退

1. 旧库设置只读，杀连接

   ```sql
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.157 -e "set global read_only=on;set global super_read_only=on;show variables like '%read_only%';"
   
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.157  -e "SELECT CONCAT('KILL ', id, ';') FROM information_schema.processlist WHERE user NOT IN ('root', 'replUser','event_scheduler');"  | grep -v CONCAT > /tmp/kill10.128.99.157 
   
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.157   < /tmp/kill10.128.99.157 
   
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.157    -e "show processlist;"
   ```

   

2. 停旧库和新库之间的数据同步

   ```sql
   # 没有延迟后，重置主从同步，取消只读。
   mysql -uroot  -p'd988ec6a93!@#MYSQL' --port=6301 -h 192.168.100.157 -e "stop slave;reset slave all;"
   ```

   恢复 192.168.100.157 --> 192.168.100.158 的数据同步

   {{% alert title="多次执行确认master 位置不在变化" color="warning" %}}

   ```sql
   mysql -uroot  -p'd988ec6a93!@#MYSQL' --port=6301 -h 192.168.100.158 -e "show master status;" |tee /tmp/master192168100158
   
   cat /tmp/master192168100158
   ```

   {{% /alert %}}

   ```bash
   mysql -uroot  -p'd988ec6a93!@#MYSQL' --port=6301 -h 192.168.100.157 -e "
   CHANGE MASTER TO
   MASTER_HOST='192.168.100.158',
   MASTER_PORT=6301,
   MASTER_USER='replUser',
   MASTER_PASSWORD='RsU#58d1@',
   MASTER_LOG_FILE='',
   MASTER_LOG_POS=;
   "
   ```

   ```sql
   mysql -uroot  -p'd988ec6a93!@#MYSQL' --port=6301 -h 192.168.100.157 -e "
   start slave ;show slave status \G
   "
   ```

   

   ```sql
   mysql -uroot  -p'd988ec6a93!@#MYSQL' --port=6301 -h 192.168.100.157 -e "
   set global super_read_only=off;
   set global read_only=off;"
   ```

   ```sql
   mysql -uroot  -p'd988ec6a93!@#MYSQL' --port=6301 -h 192.168.100.158 -e "
   set global super_read_only=off;
   set global read_only=off;"
   ```

3. 查看连接状态

   ```sql
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.157  -e "show processlist;show variables like '%read_only%';"
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 10.128.99.158  -e "show processlist;show variables like '%read_only%';"
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 192.168.100.157  -e "show processlist;show variables like '%read_only%';"
   mysql -uroot  -p'd988ec6a93!@#MYSQL'  --port=6301 -h 192.168.100.158  -e "show processlist;show variables like '%read_only%';"
   ```

   

