---
date: '2025-08-01T10:10:00+08:00'
draft: false
title: 'redis数据库搬迁方案2'
type: blog
toc_hide: false
hide_summary: true
weight: 9
description: >
  数据中心搬迁，龙腾出行redis数据库迁移
tags: ["迁移案例"]
categories: ["redis"]
url: redis/longtengchuxing2.html
author: "wangendao"
---


| 旧环境                                             | 新环境                                      | 密码              |
| -------------------------------------------------- | ------------------------------------------- | ----------------- |
| 192.168.100.66、192.168.100.67 11G                 | 10.128.100.66（主）、10.128.100.67（从）    | YSxeEr3e4ZdF      |
| 192.168.100.34 11G                                 | 10.128.100.34(主）、10.128.99.34(从)        |                   |
| 192.168.100.57, 192.168.100.58, 192.168.100.59  6G | 10.128.100.57, 10.128.100.58, 10.128.100.59 | xb91830913039bhdk |





{{% alert title="内存空余的情况下，被同步的源端执行" color="warning" %}}

```bash
# 默认 256m 64m 60 调整为 512m 128m 60
CONFIG set client-output-buffer-limit "slave 536870912 134217728 60"
CONFIG GET client-output-buffer-limit 
```

```bash
# 默认1m 调整为1gb
config set repl-backlog-size 1073741824
CONFIG GET repl-backlog-size
```

{{% /alert %}}



### 切换

{{< tabpane text=true right=false >}}

  {{% tab header="redis01" lang="en" %}}

**redis01登录 10.128.100.66 杀连接**

```bash
redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 client list|awk -F " |="  '!/127.0.0.1/ && !/10.128.100.66/ && !/10.128.100.67/ {print "client kill", $4}'| redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66
# 
redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 client list|awk -F " |="  '!/127.0.0.1/ && !/10.128.100.66/ && !/10.128.100.67/ {print "client kill", $4}'
```



**停同步**

数据校验

```bash
redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info keyspace
redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 info keyspace
```



```bash
redis_check.sh --source-ip 192.168.100.67 --source-pwd YSxeEr3e4ZdF \
               --target-ip 10.128.100.66 --target-pwd YSxeEr3e4ZdF \
               --compare-mode 4 \
               --qps 5000 \
               --db-file redis01.db
```



```bash
redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 client list
redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 slaveof no one 
redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 info replication
echo "set a b\n del a" | redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66
```

添加从节点

```bash
redis-cli -a YSxeEr3e4ZdF -h 10.128.100.67 slaveof 10.128.100.66 6379
redis-cli -a YSxeEr3e4ZdF -h 10.128.100.67 info replication
```



  {{% /tab %}}
  {{% tab header="redis02" lang="de" %}}

**redis02登录 10.128.99.34 杀连接**

```bash
redis-cli -h 192.168.100.34 client list|awk -F " |="  '!/127.0.0.1/ && !/10.128.99.34/ && !/10.128.100.34/{print "client kill", $4}'|redis-cli -h 192.168.100.34
#
redis-cli -h 192.168.100.34 client list|awk -F " |="  '!/127.0.0.1/ && !/10.128.99.34/ && !/10.128.100.34/{print "client kill", $4}'
```



**停同步**

数据校验

```bash
redis-cli -h 192.168.100.34 info keyspace
redis-cli -h 10.128.100.34 info keyspace
```



```bash
redis_check.sh --source-ip 192.168.100.34 \
                 --target-ip 10.128.100.34 \
                 --compare-mode 4 \
                 --qps 5000 \
                 --db-file redis02.db
```



```bash
redis-cli -h 10.128.100.34 client list
redis-cli -h 10.128.100.34 slaveof no one 
redis-cli -h 10.128.100.34 info replication
echo "set a b\n del a" | redis-cli -h 10.128.100.34  
```



  {{% /tab %}}
{{< /tabpane >}}



### 回退

```bash

    ## redis01登录 10.128.100.66 清理旧库数据
    # redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 bgsave 
    # mv /dump.rdb /dump.rdb.$(date +%F\ %H:%M:%S)
    # 确认没有从节点连接
    # redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info replication 
    
    # redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 slaveof 10.128.100.66 6379 
    
    # redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info replication
    
    ## redis02登录 10.128.99.34 清理旧库数据 
    # redis-cli -h 192.168.100.34 bgsave 
    # mv /dump.rdb /dump.rdb.$(date +%F\ %H:%M:%S)
    # 确认没有从节点连接
    # redis-cli -h 192.168.100.34 info replication 

    
    # redis-cli -a YSxeEr3e4ZdF -h 192.168.100.34 slaveof 10.128.100.34 6379 
    
    # redis-cli -a YSxeEr3e4ZdF -h 192.168.100.34 info replication

```

{{< tabpane text=true right=false >}}

  {{% tab header="redis01" lang="en" %}}

**redis01登录 10.128.100.66 杀连接**

```bash
redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 client list|awk -F " |="  '!/127.0.0.1/ && !/10.128.100.66/ && !/10.128.100.67/ && !/192.168.100.66/{print "client kill", $4}'| redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66
#
redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 client list|awk -F " |="  '!/127.0.0.1/ && !/10.128.100.66/ && !/10.128.100.67/ && !/192.168.100.66/{print "client kill", $4}'
```

**停同步**

数据校验

```bash
redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info keyspace
redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 info keyspace
```



```bash
redis_check.sh --source-ip 10.128.100.66 --source-pwd YSxeEr3e4ZdF \
               --target-ip 192.168.100.66 --target-pwd YSxeEr3e4ZdF \
               --compare-mode 4 \
               --qps 50000 \
               --db-file redis01.db
```



```bash
redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 client list

redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 slaveof no one 
redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info replication
echo "set a b\n del a" | redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 
```

  {{% /tab %}}
  {{% tab header="redis02" lang="en" %}}

**redis02登录 10.128.99.34 杀连接**

```bash
# redis02登录 10.128.99.34 杀连接
redis-cli -h 10.128.100.34 client list|awk -F " |="  '!/127.0.0.1/ && !/10.128.99.34/ && !/192.168.100.34/{print "client kill", $4}'|redis-cli -h 10.128.100.34

redis-cli -h 10.128.100.34 client list|awk -F " |="  '!/127.0.0.1/ && !/10.128.99.34/ && !/192.168.100.34/{print "client kill", $4}'
```

**停同步**

数据校验

```bash
redis-cli -h 192.168.100.34 info keyspace
redis-cli -h 10.128.100.34 info keyspace
```



```bash
redis_check.sh --source-ip 10.128.100.34 \
                 --target-ip 192.168.100.34 \
                 --compare-mode 4 \
                 --qps 50000 \
                 --db-file redis02.db
```



```bash
# 停同步
redis-cli -h 192.168.100.34  client list
redis-cli -h 192.168.100.34 slaveof no one 
redis-cli -h 192.168.100.34 info replication
echo "set a b\n del a" | redis-cli -h 192.168.100.34 
```

  {{% /tab %}}
{{< /tabpane >}}









### 收尾工作

1. 停止集群的同步工具

   ```bash
   /Data/redis7/redis7_6379/bin/redis-cli -a xb91830913039bhdk --cluster call 192.168.100.58:6379 dbsize
   ```

   ```bash
   systemctl status redis_sync_cluster01
   ```

    

2. 从节点接入到master

   ```bash
   redis-cli -h 10.128.99.34 slaveof 10.128.100.34 6379
   redis-cli -h 10.128.100.67 -a YSxeEr3e4ZdF slaveof 10.128.100.66 6379
   ```

   ```bash
   redis-cli -h 10.128.99.34 config set save "900 1 300 10 60 10000"
   redis-cli -h 10.128.99.34 config rewirte
   ```

   ```bash
   redis-cli -h 10.128.100.67 -a YSxeEr3e4ZdF config set save "900 1 300 10 60 10000"
   redis-cli -h 10.128.100.67 -a YSxeEr3e4ZdF config rewirte
   ```

   

   
