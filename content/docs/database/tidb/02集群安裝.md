---
date: '2025-05-20T08:30:28+08:00'
draft: false
title: '集群安装'
type: blog
toc_hide: false
hide_summary: true
weight: 2
description: >
  install|tidb
tags: ["install"]
categories: ["tidb"]
url: tidb/install.html
author: "wangendao"
---

![](https://docs-download.pingcap.com/media/images/docs-cn/tidb-architecture-v6.png)

{{< tabpane text=true right=false >}}
  {{% tab header="**环境准备**:" disabled=true /%}}
  {{% tab header="主机环境" lang="en" %}}
| os        | 主机名        | ip            | cpu  | 内存 | 磁盘 | 网卡 | 集群 |
| --------- | ------------- | ------------- | ---- | ---- | ---- | --------- | --------- |
| centos7.6 | tidb-dev01-s2 | 192.168.0.223 |  |  |  |  | 中控机 |
| centos7.6 | tidb-cmb01-s3 | 192.168.0.105 | 8    | 8    | 200G  | 千兆 | cluster01 |
| centos7.6 | tidb-cmb02-s3 | 192.168.0.106 | 8    | 8    | 200G  | 千兆 | cluster01 |
| centos7.6 | tidb-cmb03-s3 | 192.168.0.107 | 8    | 8    | 200G  | 千兆 | cluster01 |
| centos7.6 | tidb-cmb04-s3 | 192.168.0.108 | 8    | 8    | 200G  | 千兆 | cluster02 |
| centos7.6 | tidb-cmb05-s3 | 192.168.0.140 | 8    | 8    | 200G  | 千兆 | cluster02 |
| centos7.6 | tidb-cmb06-s3 | 192.168.0.162 | 8    | 8    | 200G  | 千兆 | cluster02 |

  {{% /tab %}}

  {{% tab header="系统环境" lang="en" %}}

+ 必备软件

  | 软件    | 版本          | 目标主机          |
  | :------ | :------------ | ----------------- |
  | sshpass | 1.06 及以上   | 中控机 & 集群主机 |
  | numactl | 2.0.12 及以上 | 集群主机          |
  | tar     | 任意          | 集群主机          |

  

+ 时间同步

+ 关闭swap

  ```bash
  echo "vm.swappiness = 0">> /etc/sysctl.conf
  sysctl -p
  swapoff -a && swapon -a
  ```

  

+ 关闭防火墙

+ 关闭selinux

+ 关闭透明大页

  ```bash
  [root@tidb-cmb01-s3 ~]# echo never >/sys/kernel/mm/transparent_hugepage/enabled
  [root@tidb-cmb01-s3 ~]# cat /sys/kernel/mm/transparent_hugepage/enabled
  # always madvise [never]
  ```

+ 关闭数据目录所在磁盘的i/o调度器

  ```bash
  [root@tidb-cmb01-s3 ~]# echo noop >/sys/block/sd[bc]/queue/scheduler
  [root@tidb-cmb01-s3 ~]# cat /sys/block/sd[bc]/queue/scheduler
  [noop] deadline cfq 
  ```

  

+ 挂载磁盘

  ```bash
   mkfs.ext4 /dev/mapper/data-tidb 
   mount -o noatime -o nodelalloc -t ext4 /dev/mapper/data-tidb /data/
   mkdir -p /data/cluster01
   chown -R tidb:tidb /data/cluster01
  ```

  

  {{% /tab %}}
{{< /tabpane >}}



**安装tiup工具**

```bash
curl --proto '=https' --tlsv1.2 -sSf https://tiup-mirrors.pingcap.com/install.sh | sh

source /root/.bash_profile
```



**下载离线镜像**

```bash
version=v5.2.4
#version=v6.5.12
wget https://download.pingcap.org/tidb-community-server-${version}-linux-amd64.tar.gz
tar xf tidb-community-server-${version}-linux-amd64.tar.gz
```

**设置本地镜像仓库**

```bash
tiup mirror set tidb-community-server-${version}-linux-amd64
# 验证设置是否成功
tiup mirror show
```

**配置部署文件**

```yaml
# 通过该命令获取基础配置文件 
tiup cluster template > /tmp/topology.yaml
```

检查配置文件语法和集群依赖

{{% details %}}

```yaml
global:
  user: "root"
  ssh_port: 22
  deploy_dir: "/tidb-deploy"
  data_dir: "/tidb-data"
  arch: "amd64"

monitored:
  node_exporter_port: 0
  blackbox_exporter_port: 0 
server_configs:
  pd:
    replication.location-labels: ["host", "disk"]
  
pd_servers:
  - host: 192.168.0.115
    client_port: 2379
    peer_port: 2380
    deploy_dir: "/tidb-deploy/pd-2379"
    data_dir: "/tidb-data/pd-2379"
    log_dir: "/tidb-deploy/pd-2379/log"
  - host: 192.168.0.115
    client_port: 3379
    peer_port: 3380
    deploy_dir: "/tidb-deploy/pd-3379"
    data_dir: "/tidb-data/pd-3379"
    log_dir: "/tidb-deploy/pd-3379/log"
  - host: 192.168.0.115
    client_port: 4379
    peer_port: 4380
    deploy_dir: "/tidb-deploy/pd-4379"
    data_dir: "/tidb-data/pd-4379"
    log_dir: "/tidb-deploy/pd-4379/log"


tidb_servers:
  - host: 192.168.0.115
    port: 4000
    status_port: 10080
    deploy_dir: "/tidb-deploy/tidb-4000"
    log_dir: "/tidb-deploy/tidb-4000/log"

tikv_servers:
  - host: 192.168.0.115
    port: 20160
    status_port: 20180
    deploy_dir: "/tidb-deploy/tikv-20160"
    data_dir: "/tidb-data/tikv-20160"
    log_dir: "/tidb-deploy/tikv-20160/log"
    config:
      server.labels:
        host: tikv1
        disk: disk1
  - host: 192.168.0.115
    port: 20161
    status_port: 20181
    deploy_dir: "/tidb-deploy/tikv-20161"
    data_dir: "/tidb-data/tikv-20161"
    log_dir: "/tidb-deploy/tikv-20161/log"
    config:
      server.labels:
        host: tikv2
        disk: disk2
  - host: 192.168.0.115
    port: 20162
    status_port: 20182
    deploy_dir: "/tidb-deploy/tikv-20162"
    data_dir: "/tidb-data/tikv-20162"
    log_dir: "/tidb-deploy/tikv-20162/log"
    config:
      server.labels:
        host: tikv3
        disk: disk3
monitoring_servers:
- host: 192.168.0.114
  port: 9090
  ng_port: 12020
  deploy_dir: /tidb-deploy/prometheus-9090
  data_dir: /tidb-data/prometheus-9090
  log_dir: /tidb-deploy/prometheus-9090/log
```



{{% /details %}}

```bash
tiup cluster check /tmp/topology.yaml --user root -p
tiup cluster check /tmp/topology.yaml --apply --user root -p
```



**部署集群**

```bash
tiup cluster deploy cluster01 v5.2.4 /tmp/topology.yaml --user root -p
```

**启动集群**

```bash
[tidb@tidb-dev01-s2 ~]$ tiup cluster start cluster01 --init

Started cluster `cluster01` successfully
The root password of TiDB database has been changed.
The new password is: 'jS7y!61*gz8MUZ50_%'.
Copy and record it to somewhere safe, it is only displayed once, and will not be stored.
The generated password can NOT be get and shown again.
```

**查看tiup管理的集群**

```bash
tiup cluster list 
tiup cluster display cluster01
```



**验证功能**

```bash
mysql -P 4000 -uroot -p'jS7y!61*gz8MUZ50_%' -h 127.0.0.1
```

**dashboar:** `http://192.168.0.115:3379/dashboard`

默认用户： `root`

默认密码： `jS7y!61*gz8MUZ50_%`



**销毁集群**

```bash
tiup cluster stop cluster01
tiup cluster destroy cluster01
```



### 数据备份

```bash
tiup install br:v6.5.12
```



### 数据迁移

[数据迁移概述 | TiDB 文档中心](https://docs.pingcap.com/zh/tidb/stable/migration-overview/)

### 数据同步

[数据同步概述 | TiDB 文档中心](https://docs.pingcap.com/zh/tidb/stable/ticdc-overview/)

### tidb工具链

[TiDB 工具功能概览 | TiDB 文档中心](https://docs.pingcap.com/zh/tidb/stable/ecosystem-tool-user-guide/)