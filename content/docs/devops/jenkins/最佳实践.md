---
date: '2025-05-20T21:47:29+08:00'
draft: false
title: '最佳实践'
type: blog
toc_hide: false
hide_summary: true
weight: 3
description: >
  最佳实践|jenkins
tags: ["jenkins"]
categories: ["devops"]
url: devops/最佳实践.html
author: "wangendao"
---

![](https://rpic.origz.com/api.php?category=photography)

### pipeline 最佳实践

+ 处理逻辑抽离成函数，通过[共享库](https://www.jenkins.io/doc/book/pipeline/shared-libraries/)的方式调用。

+ Jenkinsfile 通过代码仓库管理

**共享库实践**

1. 配置jenkins 共享库

   > ​	路径： Dashboard > 系统管理 > System >  Global Trusted Pipeline Libraries

   ![alt text](/docs/devops/jenkins/img/image-14.png)
   ![alt text](/docs/devops/jenkins/img/image-15.png)
   ![alt text](/docs/devops/jenkins/img/image-16.png)
   
2. 编写共享库文件

   ```bash
   # 目录结构
   # src 下放置 具体实现逻辑函数
   mylib
       ├─resources
       │  └─config
       ├─src
       │  └─org
       │      └─jenkins
       |            └─ hello.groovy
       └─vars
   ```

   ```groovy
   package org.jenkins
   
   def hi(data) {
       printf("%s","来自共享库函数")
       return data
   }
   ```

   

3. 在Jenkinsfile中调用共享库

   ```groovy
   /* @Library 为固定语法声明加载共享库
       jenkinslib 为jenkins 全局配置中配置的共享库的名称
       _ 加载共享库
   */
   @Library('jenkinslib') _
   
   // 实例化 org.jenkins 包下 hello.groovy 文件
   def tools=new org.jenkins.hello()
   
   pipeline {
       agent any
       stages {
           stage("run") {
               steps {
                   script {
                       // 调用共享库中的hi 函数
                       tools.hi("123")
   
                       // 调用共享库中的配置文件
                       def data=libraryResource 'config/config.json'
                       result=tools.hi(data)
                       println result
                   }
               }
           }
       }
   }
   ```

   
#### gitlab 代码提交触发流水线
安装插件 【 Generic Webhook Trigger 】
支持jsonpath 语法解析 【 Pipeline Utility Steps 】
```bash
pipeline {
    agent any

    stages {
        stage('Parse JSON') {
            steps {
                script {
                    // JSON 字符串
                    def jsonString = '{"name": "John", "age": 30, "city": "New York"}'

                    // 解析 JSON 字符串
                    def jsonObj = readJSON text: jsonString

                    // 访问 JSON 对象中的属性
                    def name = jsonObj.name
                    def age = jsonObj.age
                    def city = jsonObj.city

                    // 打印 JSON 数据
                    echo "Name: ${name}"
                    echo "Age: ${age}"
                    echo "City: ${city}"
                }
            }
        }
    }
}
```
![alt text](/docs/devops/jenkins/img/image-17.png)

```bash
http://175.178.65.213:18080/generic-webhook-trigger/invoke?token=qGv2J.wXhNnzg
```

1. 分支名称
2. commit_id

### 运维管理


#### 备份jenkins

+ 停止进程
+ 打包 `JENKINS_HOME` 目录
  ```bash
  cd /root
  tar --exclude .jenkins/workspace  -cvzf  jenkins.tar.gz .jenkins
  ```
+ 恢复方式： 解压打包文件到当前环境 `JENKINS_HOME` 目录



#### 用户和权限管理
https://mp.weixin.qq.com/s/_DIWInIddfcsdggDCGOCyA

jenkins使用基于RBAC(role base access contoller)进项授权控制，要使用该功能需要安装对应插件【 Role-based Authorization Strategy 】


1. 添加用户
   > Dashboard > Manage Jenkins > Jenkins’ own user database
   ![alt text](/docs/devops/jenkins/img/image-5.png)

2. 修改授权策略
   
   修改jenkins授权策略。修改为 `Role-Based Strategy`
   
   > 修改方式： Dashboard > Manage Jenkins > Security


   ![alt text](/docs/devops/jenkins/img/image-6.png)




3. 添加权限
   > 示例中实现目标： 开发人员dev01 只拥有自己项目 `seagull` 流水线的构建权限

   修改/新增jenkins角色权限
   > 修改方式：Dashboard > Manage Jenkins > Manage and Assign Roles
   
   ![alt text](/docs/devops/jenkins/img/image-8.png)

   新增权限
   > [Warning] 
   >
   > 确保 `Item roles` 中已经存在的不可以在 `Global roles` 中配置，否则`Global roles`中权限会覆盖掉 `Item roles` 中配置
   
   ![alt text](/docs/devops/jenkins/img/image-9.png)

4. 授权给用户
   > [Warning] 
   >
   > 需要双重授权
   
   ![alt text](/docs/devops/jenkins/img/image-10.png)
   
   使用dev01 用户登录检查权限
   ![alt text](/docs/devops/jenkins/img/image-11.png)

 



#### 邮件、钉钉通知

**邮件通知**
安装邮件插件 【 Email Extension 】

```bash
smtp_address = smtp.qq.com
smtp_port = 465
smtp_user_name = 810654947@qq.com
smtp_password = kqaexaxpbrbdbajd
smtp_domain = smtp.qq.com
smtp_tls = true
```
添加凭据
![alt text](/docs/devops/jenkins/img/image-18.png)
设置管理员邮箱
![alt text](/docs/devops/jenkins/img/image-20.png)
![alt text](/docs/devops/jenkins/img/image-21.png)


![alt text](/docs/devops/jenkins/img/image-19.png)

```groovy
pipeline {
    agent any

    stages {
        stage('Hello') {
            steps {
                emailext to: '1209233066@qq.com',
                    mimeType: "text/html",
                    subject: "流水线'${JOB_NAME}' (${BUILD_NUMBER})构建通知",
                    body: """
                    项目名称: ${PROJECT_NAME } <br>
                    
                    构建详情：<a href=${BUILD_URL}console>查看详情</a>
                    """
                    
            }
        }
    }
}
```
```groovy
def now = new Date()

pipeline {
    agent any

    stages {
        stage('Hello') {
            steps {

                emailext to: '1209233066@qq.com',
                    mimeType: "text/html",
                    subject: "流水线'${JOB_NAME}' (${BUILD_NUMBER}) ${currentBuild.currentResult}构建通知",
                    body: """
                        <table border=1>
                            <th>项目名称</th>
                            <th>构建id</th>
                            <th>构建状态</th>
                            <th>构建日志</th>
                            <th>邮件发送时间</th>

                            <tr>
                                <td> ${JOB_NAME} </td>
                                <td> ${BUILD_NUMBER} </td>
                                <td> ${currentBuild.currentResult} </td>
                                <td><a href=${BUILD_URL}console>查看详情</a></td>
                                <td>${now.format('yyyy-MM-dd HH:mm:ss')}</td>
                            </tr>

                        </table>
                    """
                    
            }
        }
    }
}
```











### 代码扫描

jenkins 集成sonarqube
1. 创建凭据
   ![alt text](/docs/devops/jenkins/img/image-22.png)
2. 在clone后 添加扫描阶段（golang）
    ![alt text](/docs/devops/jenkins/img/image-23.png)
    ![alt text](/docs/devops/jenkins/img/image-24.png)
    ```groovy
          stage('sonarqube') {
                environment {
                  SONAR_SCANNER_HOME = "/opt/sonar-scanner"
                  PATH = "${SONAR_SCANNER_HOME}/bin:$PATH"
                }
                steps {
                  withCredentials([usernamePassword(
                    credentialsId: 'sonarQube', 
                    passwordVariable: 'password', 
                    usernameVariable: 'username')]) {
                      script {
                          sh '''
                          sonar-scanner \
                          -Dsonar.host.url=http://175.178.65.213:9000 \
                          -Dsonar.projectKey=seagull-agent \
                          -Dsonar.projectName=seagull-agent \
                          -Dsonar.projectVersion=1.1 \
                          -Dsonar.login="${username}" \
                          -Dsonar.password="${password}" \
                          -Dsonar.ws.timeout=30 \
                          -Dsonar.projectDescription='seagull-agent' \
                          -Dsonar.links.homepage=https://e.gitee.com/bj-pytc/repos/bj-pytc/pcloud-agent/sources \
                          -Dsonar.links.ci=http://175.178.65.213:18080/job/seagull-agent/job/seagull-agent/ \
                          -Dsonar.sourceEncoding=UTF-8
                          '''
                      }
                    }
    
                }
            }
    ```

通过安装插件执行代码扫描【 SonarQube Scanner 】
1. sonarQube 中生成token
    ![alt text](/docs/devops/jenkins/img/image-25.png)
    `sqa_718d7307c781818bbecdd30871d28061280a7a26`
    ![alt text](image-26.png)

2. 将token 转换为jenkins的 credentials
    ![alt text](/docs/devops/jenkins/img/image-27.png)

3. 添加扫描阶段
    ![alt text](/docs/devops/jenkins/img/image-28.png)
    ![alt text](/docs/devops/jenkins/img/image-29.png)

    ```groovy
          stage('sonarqube') {
                environment {
                  SONAR_SCANNER_HOME = "/opt/sonar-scanner"
                  PATH = "${SONAR_SCANNER_HOME}/bin:$PATH"
                }
                steps {
                  // installationName 是第三步创建的名称
                  // credentialsId 为 第二步中创建的credentials
                  withSonarQubeEnv(installationName: 'sonarQube',credentialsId: 'sonarQubetoken') {
                      script {
                          sh '''
                          sonar-scanner \
                          -Dsonar.host.url=http://175.178.65.213:9000 \
                          -Dsonar.projectKey=seagull-agent \
                          -Dsonar.projectName=seagull-agent \
                          -Dsonar.projectVersion=1.1 \
                          -Dsonar.login="${SONAR_AUTH_TOKEN}" \
                          -Dsonar.ws.timeout=30 \
                          -Dsonar.projectDescription='seagull-agent' \
                          -Dsonar.links.homepage=https://e.gitee.com/bj-pytc/repos/bj-pytc/pcloud-agent/sources \
                          -Dsonar.links.ci=http://175.178.65.213:18080/job/seagull-agent/job/seagull-agent/ \
                          -Dsonar.sourceEncoding=UTF-8
                          '''
                      }
                    }
    
                }
            }
    ```
4. 执行結果，此时多个一个sonarQube的扫描结构连接
   ![alt text](/docs/devops/jenkins/img/image-30.png)

### 创建凭证拉取代码

jienkins 提供了凭据管理，避免将密码或token 暴露在流水线中。需要插件 【 Credentials 】
> 配置方式： Dashboard > Manage Jenkins > Credentials

1. 添加全局作用域的credentials
   ![alt text](/docs/devops/jenkins/img/image-2.png)
   
   创建一个全局的，基于用户名和密码的credentials,该credentials会在后面流水线中引用。
   > 引用时使用 `Description ` 作为标识引用该credentials
   ![alt text](/docs/devops/jenkins/img/image-7.png)





### FQA

#### 任务无法停止

**问题描述：**

在构建一个nodejs项目时，一个构建任务运行了3天5小时。这时通过jenkins 页面取消该任务时没有响应，重启jenkins进程后jenkins会把未完成的任务直接拉起继续运行。

![jenkins单个任务运行了3天，一直卡着](https://img2024.cnblogs.com/blog/2108528/202410/2108528-20241029092021368-6290231.png)





**解决办法**

1. 强制取消任务

   > 【系统管理】> 【节点和运管理】>【master】>【脚本命令行】
   >
   > master 表示当前任务运行的节点
   >
   > seagull-app 表示当前的job 名称
   >
   > 2 表示需要取消的构建号

   ```groovy
   Jenkins.instance.getItemByFullName("seagull-app")
   	.getBuildByNumber(2)
   	.finish(
   		hudson.model.Result.ABORTED,
       	new java.io.IOException("Aborting build")
   );
   ```

2. 为流水线设置超时时间

   ```bash
       options {
         timeout(time:3,unit: 'HOURS')
       }
   ```





参考

[Jenkins 强制停止 job 执行_jenkins强制停止任务-CSDN博客](https://blog.csdn.net/wxw4814/article/details/124904402)

[【Jenkins】Pipeline - 设置超时时间_jenkins设置超时时间-CSDN博客](https://blog.csdn.net/weixin_43277055/article/details/130380924)

[groovy](https://www.groovy-lang.org/documentation.html)

https://mp.weixin.qq.com/s/TqFCyCmLHEtWoVJNq6_0cw

