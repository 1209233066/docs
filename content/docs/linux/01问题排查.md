---
date: '2025-05-21T16:12:16+08:00'
draft: false
title: '问题排查'
type: blog
toc_hide: false
hide_summary: true
weight: 1
description: >
  问题排查|linux
tags: ["问题排查"]
categories: ["linux"]
url: linux/system.html
author: "wangendao"
---

![](https://rpic.origz.com/api.php?category=photography)



### 查看服务器基本信息

| 分类 | 功能                                           | 命令                                        |
| ---- | ---------------------------------------------- | ------------------------------------------- |
| 硬件 | 通过DMI获取系统硬件信息                        | `dmidecode` 或 `lshw`                       |
|      | 显示PCI/USB接口信息                            | `lspci`/`lsusb`                             |
|      | 显示CPU信息                                    | `lscpu` 或 `cat /proc/cpuinfo`              |
|      | 检查硬件虚拟化的支持                           | `egrep --color "vmx\|svm" /proc/cpuinfo`    |
|      | 显示物理内存大小                               | `free -m` 或 `cat /proc/meminfo | grep Mem` |
| 系统 | 查看系统发行版本                               | `cat /etc/system-release`                   |
|      | 查看系统内核版本                               | `uname -r`                                  |
|      | 显示机器的体系结构                             | `arch` 或 `uname -m`                        |
|      | 显示系统加载的内核模块                         | `lsmod`                                     |
|      | 查看磁盘的`inode size`  和 `block size`        | `dumpe2fs /dev/mapper/seagullcore-data`     |
| 日志 | 查看系统启动、硬件                             | `dmesg` 或 `/var/log/dmesg`                                |
|      | 系统日志，记录内核、服务、应用程序的非关键信息 | `/var/log/messages `                        |
|      | 用户登录日志                                   | `/var/log/secure`                           |
|      | `cron` 定时任务日志                            | `/var/log/cron`                             |
|      | 审计日志                                       | `/var/log/audit/audit.log`                  |
|      | yum日志                                        | `/var/log/yum.log`                  |
|      | `postfix` 或 `sendmail` 等邮件服务的日志       | `/var/log/maillog`                          |


### journalctl 命令
centos7 中`journalctl` 命令用于显示系统日志。
默认情况下，`journalctl` 仅显示当前会话的日志，并滚动显示最新的日志条目。
若要显示完整的日志信息，应使用 `journalctl` 命令配合一些选项来获取更多的日志细节。以下是一些常用的选项：
- `-u <unit>`：指定要查看的服务名称，例如 `-u nginx`。
- `-f`：以滚动模式显示日志，实时显示新日志条目。
- `-r`：以逆序（即从新到旧的顺序）显示日志条目。
- `-o <format>`：指定输出格式，可以是 `short`、`verbose`、`json` 等。例如，使用 `journalctl -o json` 将输出日志以 JSON 格式显示。
- `--since <time>`：指定要显示的日志开始时间，该参数可以是时间戳，或者使用类似 `yesterday`，`1 hour ago` 的相对时间。例如，使用 `journalctl --since "2023-06-24 10:00:00"` 将显示从 2023-06-24 10:00:00 开始的所有日志。
- `--until <time>`：指定要显示的日志截止时间。例如: `journalctl --until "1 hour ago"` 将显示截止到 1 小时前的所有日志。
- `-n <number>`：指定要显示的日志条目数量。例如，使用 `journalctl -n 50` 将仅显示最新的 50 条日志。

以下是一个示例，可以使用该示例来查看系统的所有服务的日志，显示所有启动时间为 2022 年 1 月 1 日之后的日志，以详细模式显示这些日志，并按照事件发生的反向顺序排列输出：

```bash
journalctl --since "2022-01-01" -o verbose -u all -r
```


### journald 日志系统
centos7 中journalctl是systemd日志系统的管理工具，默认临时存储在`/run/log/journal/`目录中，重启后丢失。

**开启持久化:**

> `/etc/systemd/journald.conf` 配置文件中关键参数：
>
> | 指标名称            | 可选值     | 注释                                                         |
> | ------------------- | ---------- | ------------------------------------------------------------ |
> | **`Storage`**       | volatile   | 仅保存在内存中。 例如  `Storage=volatile`                    |
> |                     | persistent | 优先保存在磁盘。例如：`Storage=persistent`                   |
> |                     | auto       | 若存在`/var/log/journal`则持久化，否在仅保存内存中。例如：`Storage=auto` |
> | **`SystemMaxUse`**  |            | 限制最大磁盘使用量。例如 `SystemMaxUse=10G`                  |
> | **`RuntimeMaxUse`** |            | 限制最大内存使用量。例如 `RuntimeMaxUse=1G`                  |

{{% alert title="日志清理" color="warning" %}}

```bash
# 清理早于指定时间的日志
journalctl --vacuum-time=7d

# 限制日志体积（如保留500MB）
journalctl --vacuum-size=500M
```

{{% /alert %}}

```bash
mkdir -p /var/log/journal
chown root:systemd-journal /var/log/journal
chmod 2755 /var/log/journal
sed -i 's/.*Storage.*/Storage=persistent/' /etc/systemd/journald.conf
systemctl restart systemd-journald
```


### 系统性能监视工具
> `  yum install htop iftop iptraf nethogs iperf3 strace perf systemtap-sdt-devel.x86_64 -y`

| 工具    | 说明                                                         |
| ------- | ------------------------------------------------------------ |
| htop    | 动态显示系统进程任务                                         |
| top     | 动态显示系统进程任务                                         |
| iotop   | 显示进程的磁盘 I/O 信息（iostat 和 top 的结合体）            |
| slabtop |                                                              |
| iftop   |                                                              |
| vmstat  | 显示进程队列、内存、交换空间、块 I/O、CPU 活动信息           |
| sysstat | 输出 CPU 的各种统计信息。可以用来分析程序运行时在内核态和用户态的时间 |
| iostat  | 显示当前的网络流量                                           |
| pidstat |                                                              |
| fstat   | 输出 CPU、IO 系统和磁盘分区的统计信息。可以用来分析磁盘 I/O、带宽等 |
| uptime  | 显示系统的运行时间和平均负载                                 |
| procps  | 显示系统内存的使用                                           |
| sar     | 定时搜集系统的各种状态信息，然后对系统各个时间点的状态进行监控 |
| pmap    |                                                              |
| iptraf  |                                                              |
| nethogs |                                                              |
| iperf3  |                                                              |
| strace  |                                                              |
| dtrace  |                                                              |
| ionice  |                                                              |
| nice    |                                                              |
| renice  |                                                              |

### top命令



**VIRT：virtual memory usage 虚拟内存**

1、进程“需要的”虚拟内存大小，包括进程使用的库、代码、数据等
2、假如进程申请100m的内存，但实际只使用了10m，那么它会增长100m，而不是实际的使用量

**RES：resident memory usage 常驻内存**
1、进程当前使用的内存大小，但不包括swap out
2、包含其他进程的共享
3、如果申请100m的内存，实际使用10m，它只增长10m，与VIRT相反
4、关于库占用内存的情况，它只统计加载的库文件所占内存大小
**SHR：shared memory 共享内存**
1、除了自身进程的共享内存，也包括其他进程的共享内存
2、虽然进程只使用了几个共享库的函数，但它包含了整个共享库的大小
3、计算某个进程所占的物理内存大小公式：RES – SHR
4、swap out后，它将会降下来
**DATA**
1、数据占用的内存。如果top没有显示，按f键可以显示出来。
2、真正的该程序要求的数据空间，是真正在运行中要使用的。

| 快捷键           | 注释                                                      |
| :--------------- | :-------------------------------------------------------- |
| 1                | 展开逻辑cpu详情                                           |
| u                | 显示指定用户的进程                                        |
| k                | 杀死指定进程                                              |
| c                | 显示命令的完整信息                                        |
| f                | 选择要输出显示的列                                        |
| <Space>或<Enter> | 立即刷新显示                                              |
| l                | – 关闭或开启第一部分第一行 top 信息的表示                 |
| t                | – 关闭或开启第一部分第二行 Tasks 和第三行 Cpus 信息的表示 |
| m                | – 关闭或开启第一部分第四行 Mem 和 第五行 Swap 信息的表示  |
| N                | – 以 PID 的大小的顺序排列表示进程列表                     |
| P                | – 以 CPU 占用率大小的顺序排列进程列表                     |
| M                | – 以内存占用率大小的顺序排列进程列表                      |



### iostat命令

| 选项             | 说明                                               |
| ---------------- | -------------------------------------------------- |
| -c               | 仅显示 CPU 统计信息。与 -d 选项互斥                |
| -d               | 仅显示磁盘统计信息。与 -c 选项互斥                 |
| -k               | 以 KB 为单位显示每秒的磁盘请求数。默认单位为块     |
| -m               | 以 MB 为单位显示每秒的磁盘请求数。默认单位为块     |
| -p {device\|ALL} | 用于显示块设备及系统分区的统计信息。与 -x 选项互斥 |
| -x               | 输出扩展信息                                       |

```bash
[root@iostat ~]# iostat -x
Linux 3.10.0-957.el7.x86_64 (redis-uat07-s1)    05/27/2025      _x86_64_        (2 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           2.56    0.00    3.90    0.00    0.00   93.54

Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
sda               0.00     0.01    0.00    0.29     0.04     8.19    56.11     0.00    0.43   17.40    0.37   0.11   0.00
dm-0              0.00     0.00    0.00    0.30     0.03     8.19    54.11     0.00    0.44   18.19    0.38   0.11   0.00
dm-1              0.00     0.00    0.00    0.00     0.00     0.00    54.67     0.00    0.33    0.33    0.00   0.30   0.00
```

avg-cpu 部分输出项说明

| 输出项  | 含义                                                         |
| ------- | ------------------------------------------------------------ |
| %user   | 在用户级别运行所使用的 CPU 的百分比                          |
| %nice   | 高优先级进程（nice=0）使用的 CPU 的百分比                    |
| %system | 在核心级别（kernel）运行所使用 CPU 的百分比                  |
| %iowait | CPU 等待硬件 IO 所占用 CPU 的百分比                          |
| %steal  | 当管理程序（hypervisor）为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比 |
| %idle   | CPU 空闲时间的百分比                                         |

Device 部分基本输出项说明

| 输出项     | 含义                                  |
| ---------- | ------------------------------------- |
| Blk_read   | 读入的数据总量，单位为块              |
| Blk_wrtn   | 写入的数据总量，单位为块              |
| kb_read    | 读入的数据总量，单位为 KB             |
| kb_wrtn    | 写入的数据总量，单位为 KB             |
| MB_read    | 读入的数据总量，单位为 MB             |
| MB_wrtn    | 写入的数据总量，单位为 MB             |
| Blk_read/s | 每秒从驱动器读入的数据量，单位为块/s  |
| Blk_wrtn/s | 每秒向驱动器写入的数据量，单位为块/s  |
| KB_read/s  | 每秒从驱动器读入的数据量，单位为 KB/s |
| KB_wrtn/s  | 每秒向驱动器写入的数据量，单位为 KB/s |
| MB_read/s  | 每秒从驱动器读入的数据量，单位为 MB/s |
| MB_wrtn/s  | 每秒向驱动器写入的数据量，单位为 MB/s |
| tps        | 每秒向物理设备写入的 IO 传输总量      |

Device 部分扩展输出项说明

| 输出项   | 含义                                                         |
| -------- | ------------------------------------------------------------ |
| rrqm/s   | 将读入请求合并后，每秒发送到设备的读入请求数                 |
| wrqm/s   | 将写入请求合并后，每秒发送到设备的写入请求数                 |
| r/s      | 每秒发送到设备的读入请求数                                   |
| w/s      | 每秒发送到设备的写入请求数                                   |
| rkB/s    | 每秒从设备读入的数据量，单位为 KB/s                          |
| wkB/s    | 每秒向设备写入的数据量，单位为 KB/s                          |
| avgrq-sz | 发送到设备的请求的平均大小，单位为扇区                       |
| avgqu-sz | 发送到设备的请求的平均队列长度                               |
| await    | IO 请求平均执行时间，包括发送请求和执行的时间，单位为毫秒    |
| r_await  | 读入请求平均执行时间，单位为毫秒                             |
| w_await  | 写入请求平均执行时间，单位为毫秒                             |
| svctm    | IO 请求在设备上的平均执行时间，单位为毫秒                    |
| %util    | 设备利用率，表示设备的忙碌程度，当值接近 100% 时，表示设备带宽已占满 |
| usec/s   | 每秒向设备写入的扇区数                                       |
| rMB/s    | 每秒从设备读入的数据量，单位为 MB/s                          |
| wMB/s    | 每秒向设备写入的数据量，单位为 MB/s                          |



### vmstat命令

| 选项 | 说明                                                         |
| ---- | ------------------------------------------------------------ |
| -n   | 只在开始时显示一次各字段名称                                 |
| -a   | 显示活跃和非活跃内存                                         |
| -m   | 显示 procs/abinfo                                            |
| -S   | 使用指定单位显示，K(1000)、K(1024)、M(1000000)、M(1048576) 字节，默认单位为 K |

```bash
[root@vmstat ~]# vmstat  5
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 159304     64 1821284    0    0     0     4    0    0  3  4 94  0  0
```

输出结果字段说明

| 分类                   | 输出项   | 说明                                                         |
| ---------------------- | -------- | ------------------------------------------------------------ |
| procs                  | r        | 在运行队列中等待运行的进程数                                 |
|                        | b        | 等待 IO 的进程数                                             |
| memory (默认单位为 KB) | swpd     | 当前使用的交换空间                                           |
|                        | free     | 当前空闲的物理内存                                           |
|                        | buff     | 用作缓冲的内存大小                                           |
|                        | cache    | 用作缓存的内存大小                                           |
|                        | inactive | 非活跃的内存大小（当使用 -a 选项时显示）                     |
|                        | active   | 活跃的内存大小（当使用 -a 选项时显示）                       |
| swap                   | si       | 每秒写入交换区的内存大小                                     |
|                        | so       | 每秒写入交换区的内存大小                                     |
| io                     | bi       | 每秒读取块设备的块数                                         |
|                        | bo       | 每秒写入块设备的块数                                         |
| system                 | in       | 每秒的中断数，包括时钟中断                                   |
|                        | cs       | 每秒的环境（上下文）切换次数                                 |
| cpu                    | us       | 用户进程执行时间的百分比                                     |
|                        | sy       | 系统进程执行时间的百分比                                     |
|                        | id       | 空闲时间（包括等待 IO 时间）的百分比                         |
|                        | wa       | 等待 IO 时间的百分比                                         |
|                        | st       | 管理程序（hypervisor）为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比 |





### mpstat命令

> mpstat 通过分析 `/proc/stat` 文件报告cpu相关信息

输出结果字段说明

| 输出项  | 说明                                                         |
| ------- | ------------------------------------------------------------ |
| %user   | 在多 CPU 系统里，每个 CPU 有一个 ID 号。第一个 CPU 为 0，all 表示统计信息为所有 CPU 的平均值 |
| %nice   | 显示在用户级别运行所占用 CPU 总时间的百分比                  |
| %system | 显示在核心级别（kernel）运行所占用 CPU 总时间的百分比。这个值并不包括服务中断和 softirq |
| %iowait | 显示用于等待 IO 操作中，占用 CPU 总时间的百分比              |
| %steal  | 显示用于虚拟机管理程序（hypervisor）为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比 |
| %idle   | 显示 CPU 在空闲状态，占用 CPU 总时间的百分比                 |
| intr/s  | 显示 CPU 每秒接收到的中断总数                                |

### sar命令

> 用于收集、报告、保存系统活跃信息

在`sar`的基础上增加 `sar [ interval [ count ] ]`选项。可以指定统计间隔和统计次数：

```bash
[root@master01 ~]# sar 1 2
Linux 3.10.0-1160.92.1.el7.x86_64 (master01)    10/03/2023      _x86_64_        (4 CPU)

11:20:15 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
11:20:16 AM     all      4.11      0.00      4.38      0.00      0.00     91.51
11:20:17 AM     all      2.79      0.00      5.29      0.00      0.00     91.92
Average:        all      3.45      0.00      4.83      0.00      0.00     91.71
```

将 `sar [ interval [ count ] ] -o datafile` 命令结果输出到文件中。

举例：

```bash
sar -o datafile 1 2 >/dev/null 2>&1 &
```

查看datafile 中的内容 :

```bash
sar -f ./datafile 
```

查看cpu状态

`sar -u 1 2 ` 查看cpu的统计信息，此时和 `sar 1 2` 结果一样

```bash
[root@master01 ~]# sar -u 1 2
Linux 3.10.0-1160.92.1.el7.x86_64 (master01)    10/03/2023      _x86_64_        (4 CPU)

11:22:44 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
11:22:45 AM     all      2.41      0.00      4.83      0.00      0.00     92.76
11:22:46 AM     all      2.66      0.00      3.99      0.00      0.00     93.35
Average:        all      2.54      0.00      4.41      0.00      0.00     93.06
```

`sar -P 0 1 2` 查看cpu0的统计信息

```bash
[root@master01 ~]# sar  -P 0 1 2 
Linux 3.10.0-1160.92.1.el7.x86_64 (master01)    10/03/2023      _x86_64_        (4 CPU)

11:19:19 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
11:19:20 AM       0      5.26      0.00      2.11      0.00      0.00     92.63
11:19:21 AM       0      2.08      0.00      5.21      0.00      0.00     92.71
Average:          0      3.66      0.00      3.66      0.00      0.00     92.67
```

`sar -P ALL 1 2` 展开显示所有核心的统计信息

```bash
[root@master01 ~]# sar -P ALL 1 2 
Linux 3.10.0-1160.92.1.el7.x86_64 (master01)    10/03/2023      _x86_64_        (4 CPU)

11:26:58 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
11:26:59 AM     all      2.70      0.00      4.59      0.00      0.00     92.70
11:26:59 AM       0      3.37      0.00      3.37      0.00      0.00     93.26
11:26:59 AM       1      3.30      0.00      4.40      0.00      0.00     92.31
11:26:59 AM       2      3.09      0.00      5.15      0.00      0.00     91.75
11:26:59 AM       3      3.23      0.00      4.30      0.00      0.00     92.47

11:26:59 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
11:27:00 AM     all      3.98      0.00      2.39      0.00      0.00     93.63
11:27:00 AM       0      2.13      0.00      3.19      0.00      0.00     94.68
11:27:00 AM       1      6.32      0.00      4.21      0.00      0.00     89.47
11:27:00 AM       2      3.16      0.00      2.11      0.00      0.00     94.74
11:27:00 AM       3      3.12      0.00      3.12      0.00      0.00     93.75

Average:        CPU     %user     %nice   %system   %iowait    %steal     %idle
Average:        all      3.35      0.00      3.48      0.00      0.00     93.17
Average:          0      2.73      0.00      3.28      0.00      0.00     93.99
Average:          1      4.84      0.00      4.30      0.00      0.00     90.86
Average:          2      3.12      0.00      3.65      0.00      0.00     93.23
Average:          3      3.17      0.00      3.70      0.00      0.00     93.12
```



### lsof命令
Lsof是遵从Unix哲学的典范，它只完成一个功能，并且做的相当完美——它可以列出某个进程打开的所有文件信息。打开的文件可能是普通的文件、目录、NFS文件、块文件、字符文件、共享库、常规管道、命名管道、符号链接、Socket流、网络Socket、UNIX域Socket，以及其它更多类型。因为“一切皆文件”乃为Unix系统的重要哲学思想之一，因此可以想象lsof命令的重要地位。

```bash
lsof ［options］ filename

lsof  /path/to/somefile：显示打开指定文件的所有进程之列表
lsof -c string：显示其COMMAND列中包含指定字符(string)的进程所有打开的文件；此选项可以重复使用，以指定多个模式；
lsof -p PID：查看该进程打开了哪些文件；进程号前可以使用脱字符“^”取反；
lsof -u USERNAME：显示指定用户的进程打开的文件；用户名前可以使用脱字符“^”取反，如“lsof -u ^root”则用于显示非root用户打开的所有文件；
lsof -g GID：显示归属gid的进程情况
lsof +d /DIR/：显示指定目录下被进程打开的文件
lsof +D /DIR/：基本功能同上，但lsof会对指定目录进行递归查找，注意这个参数要比grep版本慢：
lsof -a：按“与”组合多个条件，如lsof -a -c apache -u apache
lsof -N：列出所有NFS（网络文件系统）文件
lsof -d FD：显示指定文件描述符的相关进程；也可以为描述符指定一个范围，如0-2表示0,1,2三个文件描述符；另外，-d还支持其它很多特殊值，如：
	mem: 列出所有内存映射文件；
	mmap：显示所有内存映射设备；
	txt：列出所有加载在内存中并正在执行的进程，包含code和data；
	cwd：正在访问当前目录的进程列表；
	
lsof -n：不反解IP至HOSTNAME
lsof -i：用以显示符合条件的进程情况
lsof -i[46] [protocol][@hostname|hostaddr][:service|port]
	46：IPv4或IPv6
	protocol：TCP or UDP
	hostname：Internet host name
	hostaddr：IPv4地址
	service：/etc/service中的服务名称(可以不只一个)
	port：端口号 (可以不只一个)

例如： 查看22端口现在运行的情况
[root@www ~]# lsof -i :22
COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
sshd     1390 root    3u  IPv4  13050      0t0  TCP *:ssh (LISTEN)
sshd     1390 root    4u  IPv6  13056      0t0  TCP *:ssh (LISTEN)
sshd    36454 root    3r  IPv4  94352      0t0  TCP www.magedu.com:ssh->172.16.0.1:50018 (ESTABLISHED)


上述命令中，每行显示一个打开的文件，若不指定条件默认将显示所有进程打开的所有文件。lsof输出各列信息的意义如下：
	COMMAND：进程的名称
	PID：进程标识符
	USER：进程所有者
	FD：文件描述符，应用程序通过文件描述符识别该文件。如cwd、txt等
	TYPE：文件类型，如DIR、REG等
	DEVICE：指定磁盘的名称
	SIZE：文件的大小
	NODE：索引节点（文件在磁盘上的标识）
	NAME：打开文件的确切名称

```



