<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://zero-dew.netlify.app/docs/database/">
<link rel="alternate" type="application/rss&#43;xml" href="https://zero-dew.netlify.app/docs/database/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>零露云</title>
<meta name="description" content="database 文档中心">
<meta property="og:url" content="https://zero-dew.netlify.app/docs/database/">
  <meta property="og:site_name" content="零露云">
  <meta property="og:title" content="零露云">
  <meta property="og:description" content="database 文档中心">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="零露云">
  <meta itemprop="description" content="database 文档中心">
  <meta itemprop="datePublished" content="2025-05-20T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-05-20T00:00:00+00:00">
  <meta itemprop="wordCount" content="7">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="零露云">
  <meta name="twitter:description" content="database 文档中心">
<link rel="preload" href="/scss/main.min.18c08ee35308968138c55945e86231cae563e39470a6efcb36f516f6b21b6a02.css" as="style" integrity="sha256-GMCO41MIloE4xVlF6GIxyuVj45Rwpu/LNvUW9rIbagI=" crossorigin="anonymous">
<link href="/scss/main.min.18c08ee35308968138c55945e86231cae563e39470a6efcb36f516f6b21b6a02.css" rel="stylesheet" integrity="sha256-GMCO41MIloE4xVlF6GIxyuVj45Rwpu/LNvUW9rIbagI=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section td-blog">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">零露云</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/about"><i class="fa-solid fa-house"></i><span>关于</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/docs"><i class="fa-solid fa-book"></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/blog"><i class="fa-solid fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/google/docsy/" target="_blank" rel="noopener"><i class='fa-brands fa-github'></i><span></span></a>
      </li>
      <li class="td-light-dark-menu nav-item dropdown">
        <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
  <symbol id="check2" viewBox="0 0 16 16">
    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
  </symbol>
  <symbol id="circle-half" viewBox="0 0 16 16">
    <path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/>
  </symbol>
  <symbol id="moon-stars-fill" viewBox="0 0 16 16">
    <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
    <path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/>
  </symbol>
  <symbol id="sun-fill" viewBox="0 0 16 16">
    <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
  </symbol>
</svg>

<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center"
        id="bd-theme"
        type="button"
        aria-expanded="false"
        data-bs-toggle="dropdown"
        data-bs-display="static"
        aria-label="Toggle theme (auto)">
  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg>
</button>
<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#sun-fill"></use></svg>
      Light
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"></use></svg>
      Dark
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
      <svg class="bi me-2 opacity-50"><use href="#circle-half"></use></svg>
      Auto
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
</ul>

      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.a779bd279239ad7d8c03caec2282ddc3.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="25"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/database/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title"></h1>
<div class="lead">database 文档中心</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-daab71bd6c339cc69eec143a409d109c"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-ab65920c557ab2b33439fc56e73645b6">install mysql5.6</a></li>



    
  
    
    
	

    <li><a href="#pg-aa85c31520ed761c10303a065029e27b">install mysql5.7</a></li>



    
  
    
    
	

    <li><a href="#pg-c2bad65068c0dc6f4d1427dce06dd4fd">master_slave</a></li>



    
  
    
    
	

    <li><a href="#pg-0e11fa2ec489b8755847ce6778235e54">mha</a></li>



    
  
    
    
	

    <li><a href="#pg-b808a50b951bb2eae264b55dcb7e33fc">mgr</a></li>



    
  
    
    
	

    <li><a href="#pg-c8013d862a736f0c8b81cda693116416">mysqldump</a></li>



    
  
    
    
	

    <li><a href="#pg-ce9d44ed09004288aefaac879ed320af">xtrabackup</a></li>



    
  
    
    
	

    <li><a href="#pg-4bf71c58d88b7380dd55e728c09e47c2">config</a></li>



    
  
    
    
	

    <li><a href="#pg-a051ebfaac6fc3a51384fae8d41525a3">mysql数据库搬迁</a></li>



    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-600b4b95c21a8be4c420759c9c310fb0"></a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-c17b09cb9416e4f7264c73ad103ea272"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-e77814dc865bc892f94ffc02d54f2cfc">安装部署</a></li>



    
  
    
    
	

    <li><a href="#pg-c15fb40811dca9bb931163d78690c06b">redis-shake2.1.2</a></li>



    
  
    
    
	

    <li><a href="#pg-6ddb86c8e13cf6905967891813012ff5">redis-shake3.1.11</a></li>



    
  
    
    
	

    <li><a href="#pg-9171779f07ad97b25103d1ce9ca3b8a7">redis数据库搬迁方案2</a></li>



    
  
    
    
	

    <li><a href="#pg-a9beb947715b173b615f76eaebc63922">Redis8.4.0版本</a></li>



    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-c8553d33d8183ae3ce84731b8c2608db"></a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-13e8e3ce9786760d8157f34cd761bd21"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-67eb87020312586dadda63d97ee6dd73">pcta</a></li>



    
  
    
    
	

    <li><a href="#pg-6cd2fa811bb545211e56673b02260128">环境检查</a></li>



    
  
    
    
	

    <li><a href="#pg-c968788ec97c1b8ea0974bc58c38f16b">集群安装</a></li>



    
  
    
    
	

    <li><a href="#pg-187ec7198335d617c91d9604a38255b3">tiup工具</a></li>



    
  
    
    
	

    <li><a href="#pg-b6a1b6b4042adf75eca6f429ffbb92d1">checkssh</a></li>



    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-b7925a763a64b7d08f88e8b0539bd62d"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-3ae4dfccf1d4f425261aade622c853db">单机版本安装</a></li>



    
  
    
    
	

    <li><a href="#pg-2d9ddeb9ab30ddfb699011cd96663611">集群版本安装</a></li>



    
  
    
    
	

    <li><a href="#pg-0211872ddd3d7ac997b074513c5e8671">配置文件</a></li>



    
  
    
    
	

    <li><a href="#pg-2457b5f6d965f967eb0a2d2d273f1823">RestfullAPI</a></li>



    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-6be196ad1a32509a6c7bc2a224b2a9e3"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-4fd1811155c0b30c4801ab6b3f671eaf">部署zookeeper</a></li>



    
  
    
    
	

    <li><a href="#pg-a2ebb8369fef061edbf7f3c10100d052">部署kafka</a></li>



    
  
    
    
	

    <li><a href="#pg-dc4ad1ef352d1381b1276b6e775efacb">kafka核心概念和配置文件</a></li>



    
  
    
    
	

    <li><a href="#pg-4ca462b874e0f51208f6529a334ea449">Kafka认证和授权</a></li>



    
  
    
    
	

    <li><a href="#pg-5408ed3211021d47e8c86495e76d3ace">Kafka 如何进行复制</a></li>



    
  
    
    
	

    <li><a href="#pg-3f35b0366995d1b427499856875e611b">kafka_exporter</a></li>



    
  
    
    
	

    <li><a href="#pg-25e990c22a9d5ff7c6e251af66967092">kafka可视化管理工具</a></li>



    
  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-9faafc121020cd39ed50e11e26aaa6b3"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-c9fd25539bbddcf7221fed520f3d1a93">快速开始</a></li>



    
  

    </ul>
    
  
    
    
	
<li>9: <a href="#pg-fd72358146a710880fd761142ab540c9"></a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>


<div class="content">
      <p>通常数据库需要服务器提供低延迟、高i/o的能力</p>
<p>开启服务器的性能优化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo performance | tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
</span></span></code></pre></div>
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-daab71bd6c339cc69eec143a409d109c">1 - </h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-ab65920c557ab2b33439fc56e73645b6">install mysql5.6</h1>
	<div class="lead">mysql 5.6版本二进制安装和编译安装</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	<h3 id="部署安装">部署安装</h3>
<ul>
<li>
<p>实例名称 <code>mysql-01</code> 示例使用全局变量引用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export clsName<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mysql-01&#39;</span>
</span></span></code></pre></div></li>
</ul>
<ol>
<li>
<p>添加用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>useradd -s /sbin/nologin -u <span style="color:#ae81ff">3306</span> -M mysql
</span></span></code></pre></div><p>安装mysql依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># libaio提供 Linux 原生异步 I/O（AIO）支持，允许程序发起非阻塞的磁盘读写操作，提高高并发场景下的 I/O 性能</span>
</span></span><span style="display:flex;"><span>yum install -y libaio libaio-devel ncurses ncurses-devel cpanminus
</span></span></code></pre></div></li>
<li>
<p>mysql软件安装，示例安装在<code>/opt/mysql</code>目录下</p>

    
    
    
<ul class="nav nav-tabs justify-content-end" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>软件安装</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="二进制安装" aria-controls="tabs-00-01" aria-selected="true">
        二进制安装
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="编译安装" aria-controls="tabs-00-02" aria-selected="false">
        编译安装
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <p><em>软件下载</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://downloads.mysql.com/archives/get/p/23/file/mysql-5.6.40-linux-glibc2.12-x86_64.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf mysql-5.6.40-linux-glibc2.12-x86_64.tar.gz -C /opt
</span></span></code></pre></div><p><em>安装到/opt/mysql下</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln -svf /opt/<span style="color:#f92672">{</span>mysql-5.6.40-linux-glibc2.12-x86_64,mysql<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>ln -svf /opt/mysql-5.6.40-linux-glibc2.12-x86_64/bin/mysql /usr/bin/mysql
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <p><em>软件下载</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://downloads.mysql.com/archives/get/p/23/file/mysql-5.6.40.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf mysql-5.6.40.tar.gz -C /opt
</span></span><span style="display:flex;"><span>cd /opt/mysql-5.6.40
</span></span></code></pre></div><p><em>安装编译依赖</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y cmake  libaio-devel  gcc-c++ perl-devel cpanminus ncurses-devel
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cmake . -DCMAKE_INSTALL_PREFIX<span style="color:#f92672">=</span>/opt/mysql <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DMYSQL_DATADIR<span style="color:#f92672">=</span>/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DMYSQL_UNIX_ADDR<span style="color:#f92672">=</span>/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DDEFAULT_CHARSET<span style="color:#f92672">=</span>utf8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DDEFAULT_COLLATION<span style="color:#f92672">=</span>utf8_general_ci <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_EXTRA_CHARSETs<span style="color:#f92672">=</span>all <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_INNOBASE_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_FEDERATED_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_BLACKHOLE_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_EXAMPLE_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_ZLIB<span style="color:#f92672">=</span>bundled <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_SSL<span style="color:#f92672">=</span>bundled <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DENABLED_LOCAL_INFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_EMBEDDED_SERVER<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DENABLE_DOWNLOADS<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_DEBUG<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make -j <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> make install
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> ln -svf /opt/mysql/bin/mysql /usr/bin/mysql
</span></span></code></pre></div>
    </div>
</div>

</li>
<li>
<p>初始化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 构建目录结构</span>
</span></span><span style="display:flex;"><span>mkdir -p /data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/<span style="color:#f92672">{</span>data,binlog,logs,relay_log,conf<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>chown -R mysql:mysql /data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化数据库</span>
</span></span><span style="display:flex;"><span>/opt/mysql/scripts/mysql_install_db <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--basedir<span style="color:#f92672">=</span>/opt/mysql/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--datadir<span style="color:#f92672">=</span>/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--explicit_defaults_for_timestamp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>mysql
</span></span></code></pre></div>
<details>
  <summary>Details</summary>
  <pre tabindex="0"><code class="language-log" data-lang="log">[root@seagullcore01-uat-s2 ~]# /opt/mysql/scripts/mysql_install_db \
&gt; --basedir=/opt/mysql/ \
&gt; --datadir=/data/instances/${clsName}/data \
&gt; --explicit_defaults_for_timestamp \
&gt; --user=mysql
Installing MySQL system tables...2025-07-28 11:23:40 0 [Note] Ignoring --secure-file-priv value as server is running with --bootstrap.
2025-07-28 11:23:40 0 [Note] /opt/mysql//bin/mysqld (mysqld 5.6.40) starting as process 29771 ...
2025-07-28 11:23:40 29771 [Note] InnoDB: Using atomics to ref count buffer pool pages
2025-07-28 11:23:40 29771 [Note] InnoDB: The InnoDB memory heap is disabled
2025-07-28 11:23:40 29771 [Note] InnoDB: Mutexes and rw_locks use GCC atomic builtins
2025-07-28 11:23:40 29771 [Note] InnoDB: Memory barrier is not used
2025-07-28 11:23:40 29771 [Note] InnoDB: Compressed tables use zlib 1.2.3
2025-07-28 11:23:40 29771 [Note] InnoDB: Using Linux native AIO
2025-07-28 11:23:40 29771 [Note] InnoDB: Using CPU crc32 instructions
2025-07-28 11:23:40 29771 [Note] InnoDB: Initializing buffer pool, size = 128.0M
2025-07-28 11:23:40 29771 [Note] InnoDB: Completed initialization of buffer pool
2025-07-28 11:23:40 29771 [Note] InnoDB: The first specified data file ./ibdata1 did not exist: a new database to be created!
2025-07-28 11:23:40 29771 [Note] InnoDB: Setting file ./ibdata1 size to 12 MB
2025-07-28 11:23:40 29771 [Note] InnoDB: Database physically writes the file full: wait...
2025-07-28 11:23:40 29771 [Note] InnoDB: Setting log file ./ib_logfile101 size to 48 MB
2025-07-28 11:23:40 29771 [Note] InnoDB: Setting log file ./ib_logfile1 size to 48 MB
2025-07-28 11:23:40 29771 [Note] InnoDB: Renaming log file ./ib_logfile101 to ./ib_logfile0
2025-07-28 11:23:40 29771 [Warning] InnoDB: New log files created, LSN=45781
2025-07-28 11:23:40 29771 [Note] InnoDB: Doublewrite buffer not found: creating new
2025-07-28 11:23:40 29771 [Note] InnoDB: Doublewrite buffer created
2025-07-28 11:23:40 29771 [Note] InnoDB: 128 rollback segment(s) are active.
2025-07-28 11:23:40 29771 [Warning] InnoDB: Creating foreign key constraint system tables.
2025-07-28 11:23:40 29771 [Note] InnoDB: Foreign key constraint system tables created
2025-07-28 11:23:40 29771 [Note] InnoDB: Creating tablespace and datafile system tables.
2025-07-28 11:23:40 29771 [Note] InnoDB: Tablespace and datafile system tables created.
2025-07-28 11:23:40 29771 [Note] InnoDB: Waiting for purge to start
2025-07-28 11:23:40 29771 [Note] InnoDB: 5.6.40 started; log sequence number 0
2025-07-28 11:23:41 29771 [Note] Binlog end
2025-07-28 11:23:41 29771 [Note] InnoDB: FTS optimize thread exiting.
2025-07-28 11:23:41 29771 [Note] InnoDB: Starting shutdown...
2025-07-28 11:23:42 29771 [Note] InnoDB: Shutdown completed; log sequence number 1625977
OK

Filling help tables...2025-07-28 11:23:42 0 [Note] Ignoring --secure-file-priv value as server is running with --bootstrap.
2025-07-28 11:23:42 0 [Note] /opt/mysql//bin/mysqld (mysqld 5.6.40) starting as process 29794 ...
2025-07-28 11:23:42 29794 [Note] InnoDB: Using atomics to ref count buffer pool pages
2025-07-28 11:23:42 29794 [Note] InnoDB: The InnoDB memory heap is disabled
2025-07-28 11:23:42 29794 [Note] InnoDB: Mutexes and rw_locks use GCC atomic builtins
2025-07-28 11:23:42 29794 [Note] InnoDB: Memory barrier is not used
2025-07-28 11:23:42 29794 [Note] InnoDB: Compressed tables use zlib 1.2.3
2025-07-28 11:23:42 29794 [Note] InnoDB: Using Linux native AIO
2025-07-28 11:23:42 29794 [Note] InnoDB: Using CPU crc32 instructions
2025-07-28 11:23:42 29794 [Note] InnoDB: Initializing buffer pool, size = 128.0M
2025-07-28 11:23:42 29794 [Note] InnoDB: Completed initialization of buffer pool
2025-07-28 11:23:42 29794 [Note] InnoDB: Highest supported file format is Barracuda.
2025-07-28 11:23:42 29794 [Note] InnoDB: 128 rollback segment(s) are active.
2025-07-28 11:23:42 29794 [Note] InnoDB: Waiting for purge to start
2025-07-28 11:23:43 29794 [Note] InnoDB: 5.6.40 started; log sequence number 1625977
2025-07-28 11:23:43 29794 [Note] Binlog end
2025-07-28 11:23:43 29794 [Note] InnoDB: FTS optimize thread exiting.
2025-07-28 11:23:43 29794 [Note] InnoDB: Starting shutdown...
2025-07-28 11:23:44 29794 [Note] InnoDB: Shutdown completed; log sequence number 1625987
OK

To start mysqld at boot time you have to copy
support-files/mysql.server to the right place for your system

PLEASE REMEMBER TO SET A PASSWORD FOR THE MySQL root USER !
To do so, start the server, then issue the following commands:

  /opt/mysql//bin/mysqladmin -u root password &#39;new-password&#39;
  /opt/mysql//bin/mysqladmin -u root -h seagullcore01-uat-s2 password &#39;new-password&#39;

Alternatively you can run:

  /opt/mysql//bin/mysql_secure_installation

which will also give you the option of removing the test
databases and anonymous user created by default.  This is
strongly recommended for production servers.

See the manual for more instructions.

You can start the MySQL daemon with:

  cd . ; /opt/mysql//bin/mysqld_safe &amp;

You can test the MySQL daemon with mysql-test-run.pl

  cd mysql-test ; perl mysql-test-run.pl

Please report any problems at http://bugs.mysql.com/

The latest information about MySQL is available on the web at

  http://www.mysql.com

Support MySQL by buying support/licenses at http://shop.mysql.com

New default config file was created as /opt/mysql//my.cnf and
will be used by default by the server when you start it.
You may edit this file to change server settings

WARNING: Default config file /etc/my.cnf exists on the system
This file will be read by default by the MySQL server
If you do not want to use this, either remove it, or use the
--defaults-file argument to mysqld_safe when starting the server
</code></pre></details>

</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/conf/my.cnf<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mysqld]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">performance_schema=ON
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server_id=1921680152
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port=3306
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">character-set-server=utf8mb4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basedir=/opt/mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datadir=/data/instances/${clsName}/data/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pid-file=/data/instances/${clsName}/mysql.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socket=/data/instances/${clsName}/mysql.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log_error=/data/instances/${clsName}/logs/mysql-error.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">slow_query_log_file=/data/instances/${clsName}/logs/mysql_slow_query.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">slow_query_log=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">long_query_time=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">binlog_format=row
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-bin=/data/instances/${clsName}/binlog/log_bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-bin-index=/data/instances/${clsName}/binlog/binlog.index
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#gtid-mode=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#enforce-gtid-consistency=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log=/data/instances/${clsName}/relay_log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log_index=/data/instances/${clsName}/relaylog/relay-bin.index
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log_recovery=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_authentication_plugin=mysql_native_password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">master_info_repository=table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log_info_repository=table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/mysql.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=mysql service https://dev.mysql.com/doc/refman/5.6/en
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/mysql/bin/mysqld_safe \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--defaults-file=/data/instances/mysql-01/conf/my.cnf \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--pid-file=/data/instances/mysql-01/mysql.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/bin/kill -HUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置最大文件描述符
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=1024
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置CPU使用率限制为50%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CPUQuota=50%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置内存限制为1G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MemoryLimit=1G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable mysql --now
</span></span><span style="display:flex;"><span>systemctl status  mysql
</span></span></code></pre></div></li>
<li>
<p>创建用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 修改root密码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>; 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 超管用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">grant</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">privileges</span> <span style="color:#66d9ef">on</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">OPTION</span> ;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 管理用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;rdsAdmin&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">grant</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">privileges</span> <span style="color:#66d9ef">on</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;rdsAdmin&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">OPTION</span>  ; 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 复制用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;rdsRpl&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> REPLICATION SLAVE, REPLICATION CLIENT <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;rdsRpl&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div></li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-aa85c31520ed761c10303a065029e27b">install mysql5.7</h1>
	<div class="lead">mysql 5.7版本二进制安装和编译安装</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	<h3 id="部署安装">部署安装</h3>
<ul>
<li>
<p>实例名称 <code>mysql-01</code> 示例使用全局变量引用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export clsName<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mysql-01&#39;</span>
</span></span></code></pre></div></li>
</ul>
<ol>
<li>
<p>添加用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>useradd -s /sbin/nologin -u <span style="color:#ae81ff">3306</span> -M mysql
</span></span></code></pre></div><p>安装mysql依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># libaio提供 Linux 原生异步 I/O（AIO）支持，允许程序发起非阻塞的磁盘读写操作，提高高并发场景下的 I/O 性能</span>
</span></span><span style="display:flex;"><span>yum install -y libaio libaio-devel ncurses ncurses-devel cpanminus
</span></span></code></pre></div></li>
<li>
<p>mysql软件安装，示例安装在<code>/opt/mysql</code>目录下</p>

    
    
    
<ul class="nav nav-tabs justify-content-end" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>软件安装</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="二进制安装" aria-controls="tabs-00-01" aria-selected="true">
        二进制安装
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="编译安装" aria-controls="tabs-00-02" aria-selected="false">
        编译安装
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <p><em>软件下载</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.40-linux-glibc2.12-x86_64.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf mysql-5.7.40-linux-glibc2.12-x86_64.tar.gz -C /opt
</span></span></code></pre></div><p><em>安装到/opt/mysql下</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln -svf /opt/<span style="color:#f92672">{</span>mysql-5.7.40-linux-glibc2.12-x86_64,mysql<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>ln -svf /opt/mysql-5.7.40-linux-glibc2.12-x86_64/bin/mysql /usr/bin/mysql
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <p><em>软件下载,5.7.5之后的版本需要boost</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://downloads.mysql.com/archives/get/p/23/file/mysql-boost-5.7.40.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf mysql-boost-5.7.40.tar.gz -C /opt
</span></span><span style="display:flex;"><span>cd /opt/mysql-5.7.40
</span></span></code></pre></div><p><em>安装编译依赖</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y cmake  libaio-devel  gcc-c++ perl-devel cpanminus ncurses-devel
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cmake . -DCMAKE_INSTALL_PREFIX<span style="color:#f92672">=</span>/opt/mysql <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DMYSQL_DATADIR<span style="color:#f92672">=</span>/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DMYSQL_UNIX_ADDR<span style="color:#f92672">=</span>/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DDEFAULT_CHARSET<span style="color:#f92672">=</span>utf8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DDEFAULT_COLLATION<span style="color:#f92672">=</span>utf8_general_ci <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_EXTRA_CHARSETs<span style="color:#f92672">=</span>all <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_INNOBASE_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_FEDERATED_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_BLACKHOLE_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_EXAMPLE_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_ZLIB<span style="color:#f92672">=</span>system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_SSL<span style="color:#f92672">=</span>system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DENABLED_LOCAL_INFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_EMBEDDED_SERVER<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DENABLE_DOWNLOADS<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_DEBUG<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_BOOST<span style="color:#f92672">=</span>boost
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make -j <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> make install
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln -svf /opt/mysql/bin/mysql /usr/bin/mysql
</span></span></code></pre></div>
    </div>
</div>

</li>
<li>
<p>初始化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 构建目录结构</span>
</span></span><span style="display:flex;"><span>mkdir -p /data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/<span style="color:#f92672">{</span>data,binlog,logs,relay_log,conf<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>chown -R mysql:mysql /data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>配置文件


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">mysql从5.7开始支持 GTID(Global Transaction Identifiers)，开启gtid功能配置如下：</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">gtid-mode</span><span style="color:#f92672">=</span><span style="color:#e6db74">on</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enforce-gtid-consistency</span><span style="color:#f92672">=</span><span style="color:#e6db74">on</span>
</span></span></code></pre></div>

</div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/conf/my.cnf<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mysqld]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">performance_schema=ON
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server_id=1921680152
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port=3306
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">character-set-server=utf8mb4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basedir=/opt/mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datadir=/data/instances/${clsName}/data/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pid-file=/data/instances/${clsName}/mysql.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socket=/data/instances/${clsName}/mysql.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log_error=/data/instances/${clsName}/logs/mysql-error.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">slow_query_log_file=/data/instances/${clsName}/logs/mysql_slow_query.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">slow_query_log=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">long_query_time=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log_timestamps=SYSTEM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">binlog_format=row
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-bin=/data/instances/${clsName}/binlog/log_bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-bin-index=/data/instances/${clsName}/binlog/binlog.index
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gtid-mode=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enforce-gtid-consistency=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log=/data/instances/${clsName}/relay_log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log_index=/data/instances/${clsName}/relaylog/relay-bin.index
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log_recovery=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_authentication_plugin=mysql_native_password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">master_info_repository=table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log_info_repository=table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>初始化数据库


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">查看初始化密码</h4>

    <code>cat /data/instances/${clsName}/logs/mysql-error.log</code>

</div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/mysql/bin/mysqld --defaults-file<span style="color:#f92672">=</span>/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/conf/my.cnf --user<span style="color:#f92672">=</span>mysql --initialize
</span></span></code></pre></div></li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/mysql.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=mysql service https://dev.mysql.com/doc/refman/5.7/en
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/mysql/bin/mysqld_safe \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--defaults-file=/data/instances/mysql-01/conf/my.cnf \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--pid-file=/data/instances/mysql-01/mysql.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/bin/kill -HUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置最大文件描述符
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=1024
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置CPU使用率限制为50%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CPUQuota=50%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置内存限制为1G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MemoryLimit=1G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable mysql --now
</span></span><span style="display:flex;"><span>systemctl status  mysql
</span></span></code></pre></div></li>
<li>
<p>创建用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 修改root密码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>; 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 超管用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">grant</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">privileges</span> <span style="color:#66d9ef">on</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">OPTION</span> ;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 管理用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;rdsAdmin&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">grant</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">privileges</span> <span style="color:#66d9ef">on</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;rdsAdmin&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">OPTION</span>  ; 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 复制用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;rdsRpl&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> REPLICATION SLAVE, REPLICATION CLIENT <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;rdsRpl&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div></li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c2bad65068c0dc6f4d1427dce06dd4fd">master_slave</h1>
	<div class="lead">mysql主从同步的原理和实现</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-04" class="text-body-secondary">Friday, July 04, 2025</time>
        
	</div>
	<table>
    <tr>
        <td><img src="/docs/database/mysql/主从架构.png" alt="主从架构图"></td>
        <td><img src="/docs/database/mysql/主从复制原理.png" alt="主从复制原理"></td>
    </tr>
</table>
<hr>
<h3 id="mater-slave-实现">Mater-Slave 实现</h3>
<p>主从是一种异步同步，主库在执行完客户端提交的事务后会立即将结果返回给客户端，并不关心从库是否已经接收并处理。


<div class="alert alert-warning" role="alert">


    <ol>
<li>主库开启binlog</li>
<li>主从之间设置不同的server_id</li>
<li>从库设置为只读，防止多点写入</li>
</ol>


</div>
</p>
<hr>

  
  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>搭建主备关系</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="主库" aria-controls="tabs-01-01" aria-selected="true">
        主库
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="从库" aria-controls="tabs-01-02" aria-selected="false">
        从库
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;replUser&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> IDENTIFIED  <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;RsU#58d1@&#39;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> REPLICATION SLAVE,REPLICATION CLIENT <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;replUser&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span>; 
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">---
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> MASTER STATUS;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----------------+----------+--------------+------------------+------------------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> File           <span style="color:#f92672">|</span> <span style="color:#66d9ef">Position</span> <span style="color:#f92672">|</span> Binlog_Do_DB <span style="color:#f92672">|</span> Binlog_Ignore_DB <span style="color:#f92672">|</span> Executed_Gtid_Set                        <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----------------+----------+--------------+------------------+------------------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> log_bin.<span style="color:#ae81ff">000002</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">551</span> <span style="color:#f92672">|</span>              <span style="color:#f92672">|</span>                  <span style="color:#f92672">|</span> b2a464ed<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>c16<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>f0<span style="color:#f92672">-</span><span style="color:#ae81ff">8445</span><span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c299bad95:<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----------------+----------+--------------+------------------+------------------------------------------+
</span></span></span></code></pre></div><p><strong>同步指定库/表</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">在主库的配置文件中执行</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[mysqld]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">binlog-do-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">mysql</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">binlog-do-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">radius</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">binlog-ignore-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">syslog</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">binlog-ignore-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">sys</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <h3 id="57-之前没有开启gtid的数据库">5.7 之前没有开启gtid的数据库</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">reset</span> slave <span style="color:#66d9ef">all</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">---
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>CHANGE MASTER <span style="color:#66d9ef">TO</span> 
</span></span><span style="display:flex;"><span>  MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;10.128.99.157&#39;</span>,
</span></span><span style="display:flex;"><span>  MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span>,
</span></span><span style="display:flex;"><span>  MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rdsRpl&#39;</span>,
</span></span><span style="display:flex;"><span>  MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RsU#58d1@&#39;</span>,
</span></span><span style="display:flex;"><span>  master_log_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;log_bin.000002&#39;</span>,
</span></span><span style="display:flex;"><span>  MASTER_LOG_POS<span style="color:#f92672">=</span><span style="color:#ae81ff">551</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">start</span> slave;<span style="color:#66d9ef">show</span> slave status <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 设置只读
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>;
</span></span></code></pre></div><h3 id="57-及之后版本开始gtid的数据库">5.7 及之后版本开始gtid的数据库</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">reset</span> slave <span style="color:#66d9ef">all</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">--- 重置gtid执行历史
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">reset</span> slave <span style="color:#66d9ef">all</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">reset</span> master;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> <span style="color:#f92672">@@</span><span style="color:#66d9ef">GLOBAL</span>.GTID_PURGED<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;b2a464ed-6c16-11f0-8445-000c299bad95:1-2&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">---
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>CHANGE MASTER <span style="color:#66d9ef">TO</span> 
</span></span><span style="display:flex;"><span>  MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;10.128.99.157&#39;</span>,
</span></span><span style="display:flex;"><span>  MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span>,
</span></span><span style="display:flex;"><span>  MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rdsRpl&#39;</span>,
</span></span><span style="display:flex;"><span>  MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RsU#58d1@&#39;</span>,
</span></span><span style="display:flex;"><span>  MASTER_AUTO_POSITION<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">start</span> slave;<span style="color:#66d9ef">show</span> slave status <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">关键指标：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Slave_IO_Running: Yes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Slave_SQL_Running: Yes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Seconds_Behind_Master: 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 设置只读
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>;
</span></span></code></pre></div><p><strong>同步指定库/表&ndash;在配置文件中指定</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">或在从库的配置文件中指定</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">[mysqld] </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">replicate-do-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">mysql</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">replicate-do-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">radius</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">replicate-ignore-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">syslog</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">replicate-ignore-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">sys</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 通配符表级</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">replication-wild-do-table</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">db1.user_% </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">replication-wild-ignore-table</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">db1.log_%</span>
</span></span></code></pre></div><p><strong>同步指定库/表&ndash;动态修改</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 停止 SQL 线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>STOP SLAVE SQL_THREAD;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 修改过滤规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>CHANGE REPLICATION FILTER
</span></span><span style="display:flex;"><span>    REPLICATE_DO_DB <span style="color:#f92672">=</span> (db1, db2),
</span></span><span style="display:flex;"><span>    REPLICATE_IGNORE_TABLE <span style="color:#f92672">=</span> (db3.log);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 重新启动 SQL 线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">START</span> SLAVE SQL_THREAD;
</span></span></code></pre></div>
    </div>
</div>

<h3 id="主从报错处理">主从报错处理</h3>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">从库连接异常</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>Slave_IO_Running: Connecting
</span></span><span style="display:flex;"><span>Last_IO_Errno: <span style="color:#ae81ff">1045</span>
</span></span><span style="display:flex;"><span>Last_IO_Error: error connecting <span style="color:#66d9ef">to</span> master <span style="color:#e6db74">&#39;rep@168.101.1.177:3306&#39;</span> <span style="color:#f92672">-</span> retry<span style="color:#f92672">-</span>time: <span style="color:#ae81ff">60</span>  retries: <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>处理办法</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">update</span> mysql.<span style="color:#66d9ef">user</span> <span style="color:#66d9ef">set</span> authentication_string<span style="color:#f92672">=</span>password(<span style="color:#e6db74">&#39;rep&#39;</span>) <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">user</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rep&#39;</span>;
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div>

</div>



<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">从库sql线程错误</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">跳过主从复制的</span>sql线程错误
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> sql_slve_skip_counter  <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div>

</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-0e11fa2ec489b8755847ce6778235e54">mha</h1>
	<div class="lead">mha是使用ruby语言实现的高可用方案</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	<table>
  <thead>
      <tr>
          <th>主机名</th>
          <th>IP</th>
          <th>server_id</th>
          <th>角色</th>
          <th>版本</th>
          <th>设置</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>mysqldbphw01</td>
          <td>172.32.4.10/24</td>
          <td>1</td>
          <td><code>master</code>/<code>MHA Node</code></td>
          <td>5.6.40</td>
          <td>1.设置server-id<br>2.开启binlog<br>3.配置vip 172.32.4.50/24</td>
      </tr>
      <tr>
          <td>mysqldbphw02</td>
          <td>172.32.4.20/24</td>
          <td>2</td>
          <td><code>slave</code>/<code>MHA Node</code></td>
          <td>5.6.40</td>
          <td>1.设置server-id<br>2.设置为只读</td>
      </tr>
      <tr>
          <td>mysqldbphw03</td>
          <td>172.32.4.30/24</td>
          <td>3</td>
          <td><code>slave</code>/<code>MHA Node</code></td>
          <td>5.6.40</td>
          <td>1.设置server-id<br/>2.设置为只读</td>
      </tr>
      <tr>
          <td>mysqldbphw04</td>
          <td>172.32.4.40/24</td>
          <td></td>
          <td><code>MHA Manager</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>

<div class="alert alert-primary" role="alert">


    <ul>
<li>添加一个vip 用于应用接入</li>
<li>设置ssh免密要认证，用于failover时执行网络、binlog拷贝等动作</li>
</ul>


</div>
</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ifconfig eth0:2 172.32.4.50/24
</span></span><span style="display:flex;"><span>ssh-keygen -t rsa -f /root/.ssh/id_rsa -N <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>2.5测试
</span></span><span style="display:flex;"><span>主库手工绑定vip：ifconfig eth0:1 168.204.37.17/24 up 
</span></span><span style="display:flex;"><span>masterha_check_ssh --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf 
</span></span><span style="display:flex;"><span>masterha_check_repl --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf
</span></span><span style="display:flex;"><span>2.6启动
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@mysqldbphw04 /<span style="color:#f92672">]</span><span style="color:#75715e"># nohup masterha_manager --conf=/etc/mha/app1.cnf &gt; /mha/manager.log &lt; /dev/null &amp;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#ae81ff">933</span>
</span></span><span style="display:flex;"><span>查看运行状态
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@mysqldbphw04 /<span style="color:#f92672">]</span><span style="color:#75715e"># masterha_check_status --conf=/etc/mha/app1.cnf</span>
</span></span><span style="display:flex;"><span>app1 <span style="color:#f92672">(</span>pid:933<span style="color:#f92672">)</span> is running<span style="color:#f92672">(</span>0:PING_OK<span style="color:#f92672">)</span>, master:mysqldbphw01
</span></span><span style="display:flex;"><span>2.7关闭
</span></span><span style="display:flex;"><span>masterha_sotp  --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@mysqldbphw04 /<span style="color:#f92672">]</span><span style="color:#75715e"># masterha_secondary_check -s mysqldbphw01 -s  mysqldbp</span>
</span></span><span style="display:flex;"><span>hw02  -s mysqldbphw03 --user<span style="color:#f92672">=</span>root --master_host<span style="color:#f92672">=</span>mysqldbphw01 --master_ip<span style="color:#f92672">=</span><span style="color:#ae81ff">172</span>
</span></span><span style="display:flex;"><span>.32.4.10 --master_port<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>Master is reachable from mysqldbphw01!
</span></span></code></pre></div><p><a href="https://www.cnblogs.com/xiaoyuxixi/p/13814811.html" target="_blank">MYSQL高可用架构MGR、MHA对比 - 小雨淅淅o0 - 博客园 (cnblogs.com)</a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-b808a50b951bb2eae264b55dcb7e33fc">mgr</h1>
	<div class="lead">MGR是 MySQL 官方提供的高可用、高一致性的分布式数据库解决方案</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	<p>MySQL Group Replication（MGR）是 MySQL 官方提供的高可用、高一致性的分布式数据库解决方案，基于原生 MySQL 实现多主/单主架构的同步复制。其核心原理是通过 Paxos 协议变种（Group Communication System, GCS） 实现节点间的数据强一致性，MGR和传统主从复制的本质区别——不是简单的异步复制改进，而是基于paxos的同步复制。</p>
<ul>
<li>使用 <strong>Paxos 分布式共识算法</strong>（具体实现为 <code>XCom</code>）确保集群内节点状态一致。</li>
<li>所有事务需在组内<strong>多数节点（N/2+1）</strong> 确认后才提交（避免脑裂）。</li>
<li>通信基于 <strong>MySQL 插件 <code>group_replication</code></strong> 实现。</li>
</ul>
<pre class="mermaid">graph LR
A[客户端发起事务] --&gt; B[本地节点执行]
B --&gt; C[生成Binlog Event]
C --&gt; D[广播到组内所有节点]
D --&gt; E[多数节点验证冲突]
E --&gt; F{多数节点通过?}
F --&gt;|Yes| G[提交事务并通知组]
F --&gt;|No| H[回滚事务]</pre>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c8013d862a736f0c8b81cda693116416">mysqldump</h1>
	<div class="lead">mysqldump逻辑备份工具</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	

<div class="alert alert-warning" role="alert">


    <ol>
<li><strong>InnoDB 优先用 <code>--single-transaction</code></strong>，避免锁表影响业务。</li>
<li><strong>MyISAM 必须锁表</strong>（默认行为），需在低峰期操作。</li>
<li><strong>大表备份</strong>：结合 <code>--quick</code> 和输出压缩（如 <code>gzip</code>）。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--备份前先执行flush tables 将内容写入磁盘（mysql必知必会中提到）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>flush tables ;
</span></span></code></pre></div>

</div>


  
  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>逻辑备份</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="备份所有库" aria-controls="tabs-01-01" aria-selected="true">
        备份所有库
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="备份指定库" aria-controls="tabs-01-02" aria-selected="false">
        备份指定库
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <p>创建备份用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;backup&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">SELECT</span>, <span style="color:#66d9ef">SHOW</span> <span style="color:#66d9ef">VIEW</span>, RELOAD, <span style="color:#66d9ef">LOCK</span> TABLES, PROCESS <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;backup&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div><p>备份命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 备份所有数据库</span>
</span></span><span style="display:flex;"><span>/usr/local/mysql80/bin/mysqldump <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-A <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--single-transaction --master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-u root -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> -h 10.128.99.157 -P <span style="color:#ae81ff">6301</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>|gzip &gt;/Backup/fullbackup<span style="color:#e6db74">`</span>date +%F-%H:%M:%S<span style="color:#e6db74">`</span>.sql.gz
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <p>创建备份用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;backup&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">SELECT</span>, <span style="color:#66d9ef">SHOW</span> <span style="color:#66d9ef">VIEW</span>, RELOAD, <span style="color:#66d9ef">LOCK</span> TABLES, PROCESS <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;backup&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div><p>备份命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 备份指定数据库</span>
</span></span><span style="display:flex;"><span>/usr/local/mysql80/bin/mysqldump <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-B infra_settle <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--single-transaction --master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-u root -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> -h 10.128.99.157 -P <span style="color:#ae81ff">6301</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>|gzip &gt;/Backup/fullbackup<span style="color:#e6db74">`</span>date +%F-%H:%M:%S<span style="color:#e6db74">`</span>.sql.gz
</span></span></code></pre></div>
    </div>
</div>

<table>
  <thead>
      <tr>
          <th style="text-align: left">参数</th>
          <th style="text-align: left">说明</th>
          <th style="text-align: left">示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><code>-u</code>, <code>--user</code></td>
          <td style="text-align: left">指定用户名</td>
          <td style="text-align: left"><code>-u root</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-p</code>, <code>--password</code></td>
          <td style="text-align: left">密码（建议不加密码，后续输入）</td>
          <td style="text-align: left"><code>-p</code> 或 <code>-p'123'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-h</code>, <code>--host</code></td>
          <td style="text-align: left">MySQL 服务器地址</td>
          <td style="text-align: left"><code>-h 127.0.0.1</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-P</code>, <code>--port</code></td>
          <td style="text-align: left">端口号（默认3306）</td>
          <td style="text-align: left"><code>-P 6301</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--socket</code></td>
          <td style="text-align: left">指定 Unix Socket 文件路径</td>
          <td style="text-align: left"><code>--socket=/tmp/mysql.sock</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-A</code>, <code>--all-databases</code></td>
          <td style="text-align: left">备份所有数据库</td>
          <td style="text-align: left"><code>mysqldump -A &gt; full_backup.sql</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-B</code>, <code>--databases</code></td>
          <td style="text-align: left">备份指定数据库（可多个）</td>
          <td style="text-align: left"><code>-B db1 db2</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--tables</code></td>
          <td style="text-align: left">指定表（需先指定数据库）</td>
          <td style="text-align: left"><code>dbname --tables table1 table2</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--ignore-table</code></td>
          <td style="text-align: left">排除指定表</td>
          <td style="text-align: left"><code>--ignore-table=db.logs</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--no-data</code></td>
          <td style="text-align: left">仅备份表结构，不备份数据</td>
          <td style="text-align: left"><code>--no-data</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--no-create-info</code></td>
          <td style="text-align: left">仅备份数据，不备份表结构</td>
          <td style="text-align: left"><code>--no-create-info</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--routines</code></td>
          <td style="text-align: left">包含存储过程和函数</td>
          <td style="text-align: left"><code>--routines</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--triggers</code></td>
          <td style="text-align: left">包含触发器</td>
          <td style="text-align: left"><code>--triggers</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--events</code></td>
          <td style="text-align: left">包含事件调度器</td>
          <td style="text-align: left"><code>--events</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--skip-triggers</code></td>
          <td style="text-align: left">排除触发器</td>
          <td style="text-align: left"><code>--skip-triggers</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--single-transaction</code></td>
          <td style="text-align: left">开启事务保证 InnoDB 一致性快照</td>
          <td style="text-align: left">InnoDB</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--lock-tables</code></td>
          <td style="text-align: left">备份前锁定所有表（默认开启）</td>
          <td style="text-align: left">MyISAM</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--skip-lock-tables</code></td>
          <td style="text-align: left">不锁表（可能导致不一致）</td>
          <td style="text-align: left">紧急情况</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--flush-logs</code></td>
          <td style="text-align: left">备份前刷新日志（用于 Binlog 增量恢复）</td>
          <td style="text-align: left">所有引擎</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--master-data</code></td>
          <td style="text-align: left">记录 Binlog 位置（<code>=1</code>注释，<code>=2</code>SQL语句）</td>
          <td style="text-align: left">主从复制</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--result-file</code></td>
          <td style="text-align: left">指定输出文件（避免 Windows 换行问题）</td>
          <td style="text-align: left"><code>--result-file=backup.sql</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--compress</code></td>
          <td style="text-align: left">压缩传输（节省网络带宽）</td>
          <td style="text-align: left"><code>--compress</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--tz-utc</code></td>
          <td style="text-align: left">统一时区为 UTC（默认开启）</td>
          <td style="text-align: left"><code>--tz-utc</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--hex-blob</code></td>
          <td style="text-align: left">二进制数据以十六进制导出</td>
          <td style="text-align: left"><code>--hex-blob</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--quick</code></td>
          <td style="text-align: left">逐行导出（避免内存溢出）</td>
          <td style="text-align: left">大表备份</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--extended-insert</code></td>
          <td style="text-align: left">合并多行 INSERT（默认开启）</td>
          <td style="text-align: left">减少备份体积</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--skip-extended-insert</code></td>
          <td style="text-align: left">每行单独 INSERT（可读性高）</td>
          <td style="text-align: left">调试用途</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--opt</code></td>
          <td style="text-align: left">启用所有优化选项（默认开启）</td>
          <td style="text-align: left">综合优化</td>
      </tr>
  </tbody>
</table>
<p>备份脚本
<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e"># 脚本名称: mysql_backup.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 描述: MySQL数据库备份脚本，支持全库备份、binlog同步及过期清理</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 作者: wangendao(1209233066@qq.com)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建日期: 2019/03/01</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 最后修改日期: $(date +%F)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 调试选项 (取消注释以启用)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># set -euo pipefail  # 更严格的错误检查</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># set -x            # 显示执行过程</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置变量</span>
</span></span><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span>/application/mysql5.6/bin:$PATH
</span></span><span style="display:flex;"><span>datadir<span style="color:#f92672">=</span>/application/mysql5.6/
</span></span><span style="display:flex;"><span>backupdir<span style="color:#f92672">=</span>/backup
</span></span><span style="display:flex;"><span>logdir<span style="color:#f92672">=</span>/var/log/mysql_backup
</span></span><span style="display:flex;"><span>timestamp<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>date +%F_%H%M%S<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>user<span style="color:#f92672">=</span>root
</span></span><span style="display:flex;"><span>password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;123&#39;</span>
</span></span><span style="display:flex;"><span>socket<span style="color:#f92672">=</span>/application/mysql5.6/mysql.sock
</span></span><span style="display:flex;"><span>rsync_ip<span style="color:#f92672">=</span>168.204.37.25
</span></span><span style="display:flex;"><span>retention_days<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>  <span style="color:#75715e"># 备份保留天数</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建必要的目录</span>
</span></span><span style="display:flex;"><span>mkdir -p <span style="color:#e6db74">&#34;</span>$backupdir<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$logdir<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 日志函数</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;[</span><span style="color:#66d9ef">$(</span>date <span style="color:#e6db74">&#39;+%F %T&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">] </span>$1<span style="color:#e6db74">&#34;</span> &gt;&gt; <span style="color:#e6db74">&#34;</span>$logdir<span style="color:#e6db74">/mysql_backup_</span><span style="color:#e6db74">${</span>timestamp<span style="color:#e6db74">}</span><span style="color:#e6db74">.log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 错误处理函数</span>
</span></span><span style="display:flex;"><span>error_exit<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    log <span style="color:#e6db74">&#34;ERROR: </span>$1<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    sendEmail -f wangendao@crv.com.cn -t wangendao@crv.com.cn <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              -s 10.248.2.15 -u <span style="color:#e6db74">&#34;MySQL备份失败警报&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              -o tls<span style="color:#f92672">=</span>no -o message-content-type<span style="color:#f92672">=</span>html <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              -o message-charset<span style="color:#f92672">=</span>utf8 -xu wangendao@crv.com.cn <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              -xp Wed10203040 -m <span style="color:#e6db74">&#34;MySQL备份失败: </span>$1<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取数据库列表</span>
</span></span><span style="display:flex;"><span>DBlist<span style="color:#f92672">=(</span><span style="color:#66d9ef">$(</span>mysql -u <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>user<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -p<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>password<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -S <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>socket<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -e <span style="color:#e6db74">&#34;SHOW DATABASES;&#34;</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          awk <span style="color:#e6db74">&#39;!/^(information_schema|performance_schema|test|database|mysql)$/&#39;</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          tail -n +2<span style="color:#66d9ef">)</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">${#</span>DBlist[@]<span style="color:#e6db74">}</span> -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    error_exit <span style="color:#e6db74">&#34;未获取到数据库列表&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 备份每个数据库</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> db in <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DBlist[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    backup_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>backupdir<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>db<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">${</span>timestamp<span style="color:#e6db74">}</span><span style="color:#e6db74">.gz&#34;</span>
</span></span><span style="display:flex;"><span>    md5_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>backupdir<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>db<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">${</span>timestamp<span style="color:#e6db74">}</span><span style="color:#e6db74">.md5&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    log <span style="color:#e6db74">&#34;开始备份数据库: </span>$db<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ! mysqldump -B <span style="color:#e6db74">&#34;</span>$db<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        -u<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>user<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -p<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>password<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -S <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>socket<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --single-transaction <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --routines <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --triggers | gzip &gt; <span style="color:#e6db74">&#34;</span>$backup_file<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        error_exit <span style="color:#e6db74">&#34;数据库 </span>$db<span style="color:#e6db74"> 备份失败&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 生成MD5校验文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ! md5sum <span style="color:#e6db74">&#34;</span>$backup_file<span style="color:#e6db74">&#34;</span> &gt; <span style="color:#e6db74">&#34;</span>$md5_file<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        error_exit <span style="color:#e6db74">&#34;无法生成MD5校验文件&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    log <span style="color:#e6db74">&#34;数据库 </span>$db<span style="color:#e6db74"> 备份完成, 文件: </span>$backup_file<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 同步备份文件</span>
</span></span><span style="display:flex;"><span>log <span style="color:#e6db74">&#34;开始同步备份文件到远程服务器&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ! rsync -az --delete <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>backupdir<span style="color:#e6db74">}</span><span style="color:#e6db74">/&#34;</span> <span style="color:#e6db74">&#34;rsync@</span><span style="color:#e6db74">${</span>rsync_ip<span style="color:#e6db74">}</span><span style="color:#e6db74">::ftp&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --password-file<span style="color:#f92672">=</span>/etc/rsync.password &gt;&gt; <span style="color:#e6db74">&#34;</span>$logdir<span style="color:#e6db74">/rsync.log&#34;</span> 2&gt;&amp;1; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    error_exit <span style="color:#e6db74">&#34;备份文件同步失败&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 同步binlog文件</span>
</span></span><span style="display:flex;"><span>log <span style="color:#e6db74">&#34;开始同步binlog文件&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ! rsync -az <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>datadir<span style="color:#e6db74">}</span><span style="color:#e6db74">/&#34;</span> --include <span style="color:#e6db74">&#39;mysql-bin*&#39;</span> --exclude <span style="color:#e6db74">&#39;*&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     <span style="color:#e6db74">&#34;rsync@</span><span style="color:#e6db74">${</span>rsync_ip<span style="color:#e6db74">}</span><span style="color:#e6db74">::ftp&#34;</span> --password-file<span style="color:#f92672">=</span>/etc/rsync.password <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     &gt;&gt; <span style="color:#e6db74">&#34;</span>$logdir<span style="color:#e6db74">/binlog_sync.log&#34;</span> 2&gt;&amp;1; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    error_exit <span style="color:#e6db74">&#34;binlog文件同步失败&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清理过期备份</span>
</span></span><span style="display:flex;"><span>log <span style="color:#e6db74">&#34;清理</span><span style="color:#e6db74">${</span>retention_days<span style="color:#e6db74">}</span><span style="color:#e6db74">天前的备份&#34;</span>
</span></span><span style="display:flex;"><span>find <span style="color:#e6db74">&#34;</span>$backupdir<span style="color:#e6db74">&#34;</span> -type f -name <span style="color:#e6db74">&#34;*.gz&#34;</span> -mtime +<span style="color:#e6db74">&#34;</span>$retention_days<span style="color:#e6db74">&#34;</span> -delete
</span></span><span style="display:flex;"><span>find <span style="color:#e6db74">&#34;</span>$backupdir<span style="color:#e6db74">&#34;</span> -type f -name <span style="color:#e6db74">&#34;*.md5&#34;</span> -mtime +<span style="color:#e6db74">&#34;</span>$retention_days<span style="color:#e6db74">&#34;</span> -delete
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 发送成功通知</span>
</span></span><span style="display:flex;"><span>log <span style="color:#e6db74">&#34;备份任务完成&#34;</span>
</span></span><span style="display:flex;"><span>sendEmail -f wangendao@crv.com.cn -t wangendao@crv.com.cn <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -s 10.248.2.15 -u <span style="color:#e6db74">&#34;MySQL备份成功通知&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -o tls<span style="color:#f92672">=</span>no -o message-content-type<span style="color:#f92672">=</span>html <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -o message-charset<span style="color:#f92672">=</span>utf8 -xu wangendao@crv.com.cn <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -xp Wed10203040 -m <span style="color:#e6db74">&#34;MySQL备份任务已完成&lt;br&gt;&lt;br&gt;备份数据库列表:&lt;br&gt;</span><span style="color:#e6db74">${</span>DBlist[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;br&gt;&lt;br&gt;备份文件已保留最近</span><span style="color:#e6db74">${</span>retention_days<span style="color:#e6db74">}</span><span style="color:#e6db74">天&#34;</span>
</span></span></code></pre></div></details>
</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-ce9d44ed09004288aefaac879ed320af">xtrabackup</h1>
	<div class="lead">mysql 备份工具之xtrabackup</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-23" class="text-body-secondary">Wednesday, July 23, 2025</time>
        
	</div>
	<h3 id="xtrabackup">xtrabackup</h3>
<p>xtrabackup 与mysql版本矩阵：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">XtraBackup 版本</th>
          <th style="text-align: left">支持的 MySQL 版本</th>
          <th style="text-align: left">关键限制</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>8.0 系列</strong></td>
          <td style="text-align: left">MySQL 8.0.x（推荐 8.0.20+）</td>
          <td style="text-align: left">完全兼容 MySQL 8.0，<strong>不支持 MySQL 5.7 及以下</strong></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>2.4 系列</strong></td>
          <td style="text-align: left">MySQL 5.6、5.7</td>
          <td style="text-align: left">不支持 MySQL 8.0</td>
      </tr>
  </tbody>
</table>
<blockquote>
<p><strong>注意</strong>：</p>
<ul>
<li>XtraBackup <strong>8.0 不支持备份 MySQL 5.7</strong>。若需备份 MySQL 5.7，必须使用 XtraBackup 2.4。</li>
<li>Percona 强烈建议 <strong>XtraBackup 小版本号与 MySQL 大版本一致</strong>（例如 MySQL 8.0.32 搭配 XtraBackup 8.0.32）。</li>
</ul>
</blockquote>
<h5 id="安装xtrabackup">安装xtrabackup</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/etc/yum.repos.d/percona-original-release.repo <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[percona-release-x86_64]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name = Percona Original release/x86_64 YUM repository
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl = http://repo.percona.com/percona/yum/release/$releasever/RPMS/x86_64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey = file:///etc/pki/rpm-gpg/PERCONA-PACKAGING-KEY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[percona-release-noarch]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name = Percona Original release/noarch YUM repository
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl = http://repo.percona.com/percona/yum/release/$releasever/RPMS/noarch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey = file:///etc/pki/rpm-gpg/PERCONA-PACKAGING-KEY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[percona-release-sources]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name = Percona Original release/sources YUM repository
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl = http://repo.percona.com/percona/yum/release/$releasever/SRPMS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey = file:///etc/pki/rpm-gpg/PERCONA-PACKAGING-KEY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y percona-xtrabackup-80.x86_64 
</span></span></code></pre></div><h5 id="全量备份">全量备份</h5>
<blockquote>
<p>170G 数据压缩后16g,全备耗时7分钟,占用1.5核心cpu</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>xtrabackup <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--defaults-file<span style="color:#f92672">=</span>/etc/mysql80/mysql80_6301.cnf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--backup <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;root&#34;</span> --password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--target-dir<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Backup/fullbackup-</span><span style="color:#66d9ef">$(</span>date +%F<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--compress --compress-threads<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>  2&gt;&amp;<span style="color:#ae81ff">1</span> | tee /tmp/mysql6301_<span style="color:#66d9ef">$(</span>date +%F_%H%M%S<span style="color:#66d9ef">)</span>.log
</span></span></code></pre></div><h5 id="恢复全量备份">恢复全量备份</h5>
<blockquote>
<p>限速100Mb 传输16G, 耗时3分钟</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>scp -l <span style="color:#ae81ff">819200</span> -rp /Backup/fullbackup-2025-07-22/* bak@10.128.99.157:/Data/bak/
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rm -fr /Data/mysql6301/<span style="color:#f92672">{</span>binlog,data,log<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>mkdir  /Data/mysql6301/<span style="color:#f92672">{</span>binlog,data,log<span style="color:#f92672">}</span> -p
</span></span><span style="display:flex;"><span>touch /Data/mysql6301/log/mysqld-error.log
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 解压 16gb 耗时 2分钟</span>
</span></span><span style="display:flex;"><span>xtrabackup --decompress --parallel<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --target-dir<span style="color:#f92672">=</span>/Data/bak --remove-original
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 应用undolog</span>
</span></span><span style="display:flex;"><span>xtrabackup --prepare --apply-log-only --target-dir<span style="color:#f92672">=</span>/Data/bak
</span></span><span style="display:flex;"><span>xtrabackup --prepare --target-dir<span style="color:#f92672">=</span>/Data/bak
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 拷贝全量备份到datadir</span>
</span></span><span style="display:flex;"><span>xtrabackup --defaults-file<span style="color:#f92672">=</span>/etc/my.cnf --copy-back --target-dir<span style="color:#f92672">=</span>/Data/bak
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown -R mysql.mysql /Data/mysql6301
</span></span><span style="display:flex;"><span>service mysql start 
</span></span><span style="display:flex;"><span>chkconfig mysql on
</span></span></code></pre></div><h5 id="增量同步数据">增量同步数据</h5>


  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="主库" aria-controls="tabs-00-00" aria-selected="true">
        主库
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="从库" aria-controls="tabs-00-01" aria-selected="false">
        从库
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <p>创建复制用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;replUser&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> IDENTIFIED <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;Repl#0001&#39;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> REPLICATION SLAVE <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;replUser&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span>; 
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span> ;
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <p>设置只读，预防多点写入</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/local/mysql80/bin/mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> --socket<span style="color:#f92672">=</span>/Data/mysql6301/mysql6301.sock --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; set global read_only<span style="color:#f92672">=</span>on;
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> rows affected <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; set global super_read_only<span style="color:#f92672">=</span>on;
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> rows affected <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; show variables like <span style="color:#e6db74">&#39;%read_only%&#39;</span>;
</span></span><span style="display:flex;"><span>+-----------------------+-------+
</span></span><span style="display:flex;"><span>| Variable_name         | Value |
</span></span><span style="display:flex;"><span>+-----------------------+-------+
</span></span><span style="display:flex;"><span>| innodb_read_only      | OFF   |
</span></span><span style="display:flex;"><span>| read_only             | ON    |
</span></span><span style="display:flex;"><span>| super_read_only       | ON    |
</span></span><span style="display:flex;"><span>| transaction_read_only | OFF   |
</span></span><span style="display:flex;"><span>+-----------------------+-------+
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span> rows in set <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>找到全备时的binlog位置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@db3-mysql80-m data<span style="color:#f92672">]</span><span style="color:#75715e"># cat xtrabackup_binlog_info </span>
</span></span><span style="display:flex;"><span>mysql-bin.000362        <span style="color:#ae81ff">156</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">/*从库*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">reset</span> slave <span style="color:#66d9ef">all</span>;
</span></span><span style="display:flex;"><span>CHANGE MASTER <span style="color:#66d9ef">TO</span> 
</span></span><span style="display:flex;"><span>    MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;10.128.111.157&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span>,
</span></span><span style="display:flex;"><span>    MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;replUser&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Repl#0001&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mysql-bin.000362&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_LOG_POS<span style="color:#f92672">=</span><span style="color:#ae81ff">156</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">start</span> slave ;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> slave status <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span></code></pre></div><p>检查slave状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@db3-mysql80 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /usr/local/mysql80/bin/mysql -uroot  -p&#39;d988ec6a93!@#MYSQL&#39; --socket=/Data/mysql6301/mysql6301.sock --port=6301 -e &#34;show slave status\G&#34;|grep -E &#34;Slave_IO_Running|Slave_SQL_Running:|Seconds_Behind_Master&#34;</span>
</span></span><span style="display:flex;"><span>mysql: <span style="color:#f92672">[</span>Warning<span style="color:#f92672">]</span> Using a password on the command line interface can be insecure.
</span></span><span style="display:flex;"><span>             Slave_IO_Running: Yes
</span></span><span style="display:flex;"><span>            Slave_SQL_Running: Yes
</span></span><span style="display:flex;"><span>        Seconds_Behind_Master: <span style="color:#ae81ff">0</span>
</span></span></code></pre></div>
    </div>
</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-4bf71c58d88b7380dd55e728c09e47c2">config</h1>
	<div class="lead">mysql 配置文件解析</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[mysqld]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">innodb_lock_wait_timeout</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">60</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sort_buffer_size</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">8M</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">query_cache_limit</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">32M</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto_increment_offset</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1 </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto_increment_increment</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_database</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_results</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_server</span>  <span style="color:#f92672">=</span> <span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">init_connect</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;启动时自动执行的内容&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#php设置为短连接</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">interactive_timeout</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">30;  #合作的超时时间</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wait_tiemout</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">30;	#闲置的超时时间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#java 设置长连接</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">interactive_timeout</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">28800;  </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wait_tiemout</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">28800;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#一个端口最大连接数</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">max_connections</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">800</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#一个用户的最大连接数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#max_user_connections = 800</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#连接错误的最大数量</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">max_connect_errors</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#兼容旧的密码模式</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#old_password = on</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">read_only</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">on</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#默认情况下从库启动自动开始同步，添加参数后需要手动start slave ;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">skip_slave_start</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">on</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#更新master_info 信息</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sync_master_info</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">记录relaylog，默认开启</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sync_relay_log</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">记录relaylog info </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sync_relay_log_info</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[client]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_client</span> <span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_connection</span> <span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_results</span> <span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[mysql]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_connection</span><span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span></code></pre></div><p>mysql 乱码字符集设置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">字符集设置</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">names</span> utf8 ;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">等同于</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#f92672">@@</span><span style="color:#66d9ef">session</span>.character_set_client <span style="color:#f92672">=</span>utf8;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#f92672">@@</span><span style="color:#66d9ef">session</span>.character_set_connection <span style="color:#f92672">=</span>utf8;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#f92672">@@</span><span style="color:#66d9ef">session</span>.character_set_results <span style="color:#f92672">=</span>utf8;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#f92672">@@</span><span style="color:#66d9ef">session</span>.character_set_database <span style="color:#f92672">=</span>utf8;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#f92672">@@</span><span style="color:#66d9ef">session</span>.character_set_server <span style="color:#f92672">=</span>utf8;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[client]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_client</span> <span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_connection</span> <span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_results</span> <span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[mysql]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_connection</span><span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#导入表时关闭外检检查</span>
</span></span><span style="display:flex;"><span>set foreign_key_check <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#查询语句的性能</span>
</span></span><span style="display:flex;"><span>show profing;
</span></span><span style="display:flex;"><span>show profie all;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#设置为分页查询</span>
</span></span><span style="display:flex;"><span>mysql&gt; page less 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; show master logs ;
</span></span><span style="display:flex;"><span>mysql&gt; purge master logs to <span style="color:#e6db74">&#39;binlog文件&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>修复表
</span></span><span style="display:flex;"><span>mysql&gt; repair table 表名
</span></span><span style="display:flex;"><span>myisamchk -r /var/lib/mysql/*.MYI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>查询 innodb 的状态<span style="color:#f92672">(</span>比如死锁<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>show engine innodb status <span style="color:#ae81ff">\G</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>查询运行状态
</span></span><span style="display:flex;"><span>show global status <span style="color:#ae81ff">\G</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>查询增删改的数量
</span></span><span style="display:flex;"><span>mysqladmin -uroot -i <span style="color:#ae81ff">3</span> -r exten|egrep -i <span style="color:#e6db74">&#39;(com_insert\b)|(com_select)|(com_delete\b)|(com_update\b)&#39;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#查询进程号</span>
</span></span><span style="display:flex;"><span>pidof mysqld
</span></span><span style="display:flex;"><span>gdb -p <span style="color:#e6db74">`</span>pidof mysqld<span style="color:#e6db74">`</span> -ex <span style="color:#e6db74">&#34;set opt_log_slave_updates=1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IO PS 每秒吞吐量
</span></span><span style="display:flex;"><span>flashcache 开源软件 可以把ssd和sas磁盘虚拟化一块
</span></span><span style="display:flex;"><span>把热数据存在ssd上把sas放在sas上
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>查询 cp io
</span></span><span style="display:flex;"><span>mpstats -P ALL <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">100</span>   查询所有cpu的使用情况 每秒打印一个打印100次
</span></span><span style="display:flex;"><span>sar -u <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">100</span>          查询所有cpu的使用情况 每秒打印一个打印100次
</span></span><span style="display:flex;"><span>iostat -x <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>sar -b <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>sar -d <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>sar -q
</span></span><span style="display:flex;"><span>sar -n DEV  查看网路
</span></span><span style="display:flex;"><span>sar -W    查看内存
</span></span><span style="display:flex;"><span>sar -r
</span></span><span style="display:flex;"><span>sar -B
</span></span><span style="display:flex;"><span>top 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dmesg -H --level<span style="color:#f92672">=</span>err,warn -k
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>优化
</span></span><span style="display:flex;"><span>numad 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>不使用swap
</span></span><span style="display:flex;"><span>sysctl -a|grep swap 
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;vm.swappiness = 0&#34;</span> &gt;&gt;/etc/sysctl.conf  
</span></span><span style="display:flex;"><span>sysctl -p 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io调度
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@localhost ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat /sys/block/sda/queue/scheduler </span>
</span></span><span style="display:flex;"><span>noop <span style="color:#f92672">[</span>deadline<span style="color:#f92672">]</span> cfq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ulimit 设定
</span></span><span style="display:flex;"><span>软硬文件打开数
</span></span><span style="display:flex;"><span>ulimit -HSn <span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#stack size</span>
</span></span><span style="display:flex;"><span>ulimit -s <span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>查看raid信息
</span></span><span style="display:flex;"><span>megacil 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@localhost ~<span style="color:#f92672">]</span><span style="color:#75715e"># top -b -n 1 | grep Cpu </span>
</span></span><span style="display:flex;"><span>%Cpu<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>:  0.0 us,  6.2 sy,  0.0 ni, 93.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>性能调优
</span></span><span style="display:flex;"><span>https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/6/html/performance_tuning_guide/index
</span></span><span style="display:flex;"><span>https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/performance_tuning_guide/index
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>《mysql反范式》
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>数据类型
</span></span><span style="display:flex;"><span>timestamp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; <span style="color:#66d9ef">select</span> current_time<span style="color:#f92672">()</span>,now<span style="color:#f92672">()</span>,sysdate<span style="color:#f92672">()</span>;
</span></span><span style="display:flex;"><span>+----------------+---------------------+---------------------+
</span></span><span style="display:flex;"><span>| current_time<span style="color:#f92672">()</span> | now<span style="color:#f92672">()</span>               | sysdate<span style="color:#f92672">()</span>           |
</span></span><span style="display:flex;"><span>+----------------+---------------------+---------------------+
</span></span><span style="display:flex;"><span>| 12:08:14       | 2020-03-08 12:08:14 | 2020-03-08 12:08:14 |
</span></span><span style="display:flex;"><span>+----------------+---------------------+---------------------+
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> row in set <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; <span style="color:#66d9ef">select</span> inet_aton<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;192.168.0.1&#39;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>+--------------------------+
</span></span><span style="display:flex;"><span>| inet_aton<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;192.168.0.1&#39;</span><span style="color:#f92672">)</span> |
</span></span><span style="display:flex;"><span>+--------------------------+
</span></span><span style="display:flex;"><span>|               <span style="color:#ae81ff">3232235521</span> |
</span></span><span style="display:flex;"><span>+--------------------------+
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> row in set <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; <span style="color:#66d9ef">select</span> inet_ntoa<span style="color:#f92672">(</span>3232235521<span style="color:#f92672">)</span>;    
</span></span><span style="display:flex;"><span>+-----------------------+
</span></span><span style="display:flex;"><span>| inet_ntoa<span style="color:#f92672">(</span>3232235521<span style="color:#f92672">)</span> |
</span></span><span style="display:flex;"><span>+-----------------------+
</span></span><span style="display:flex;"><span>| 192.168.0.1           |
</span></span><span style="display:flex;"><span>+-----------------------+
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> row in set <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>1.xtrabackup 安装
</span></span><span style="display:flex;"><span>wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.4/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.4-1.el7.x86_64.rpm
</span></span><span style="display:flex;"><span>yum install libev-devel.x86_64
</span></span><span style="display:flex;"><span>yum install numactl-libs.x86_64
</span></span><span style="display:flex;"><span>yum install perl-DBD-MySQL.x86_64
</span></span><span style="display:flex;"><span>rpm -ivh percona-xtrabackup-24-2.4.4-1.el7.x86_64.rpm 
</span></span><span style="display:flex;"><span>which xtrabackup
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>备份原理
</span></span><span style="display:flex;"><span>xtrabackup 
</span></span><span style="display:flex;"><span>首先启动备份innodb 引擎的线程 redolog 的备份和监听线程，
</span></span><span style="display:flex;"><span>并开始备份ibd 数据文件。
</span></span><span style="display:flex;"><span>当innodb引擎的数据文件备份完毕后，
</span></span><span style="display:flex;"><span>flust table with read lock;
</span></span><span style="display:flex;"><span>备份 .frm .myd .myi 文件。非innodb引擎数据文件备份完毕后
</span></span><span style="display:flex;"><span>通知redolog 线程结束并记录数据文件的lsn号，便于下次增量
</span></span><span style="display:flex;"><span>备份
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 性能测试工具
</span></span><span style="display:flex;"><span> mysqlslap
</span></span><span style="display:flex;"><span> 日志分析工具
</span></span><span style="display:flex;"><span>https://www.jb51.net/article/75064.htm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### Centos7,centos6适用</span>
</span></span><span style="display:flex;"><span>yum groupinstall <span style="color:#e6db74">&#34;X Window System&#34;</span>
</span></span><span style="display:flex;"><span>yum groupinstall <span style="color:#e6db74">&#34;GNOME Desktop&#34;</span>
</span></span><span style="display:flex;"><span>通过命令 startx 进入图形界面
</span></span><span style="display:flex;"><span>图形到dos：ctrl+alt+f2
</span></span><span style="display:flex;"><span>dos到图形：输入startx
</span></span><span style="display:flex;"><span>或者
</span></span><span style="display:flex;"><span>在命令上输入 init <span style="color:#ae81ff">3</span> 命令 切换到dos界面
</span></span><span style="display:flex;"><span>输入 init 5命令 切换到图形界面
</span></span><span style="display:flex;"><span><span style="color:#75715e">### centos 7</span>
</span></span><span style="display:flex;"><span>systemctl get-default
</span></span><span style="display:flex;"><span>graphical.target代表开机时启动图形化界面
</span></span><span style="display:flex;"><span>multi-user.target代表开机时启动dos界面
</span></span><span style="display:flex;"><span>systemctl set-default graphical.target 
</span></span><span style="display:flex;"><span>systemctl set-default multi-user.target 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh 连接客户端长时间不使用自动断开
</span></span><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span><span style="color:#ae81ff">\$</span>PATH:.
</span></span><span style="display:flex;"><span>export PS1<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\`hostname\`:\$PWD&gt;&#39;</span>
</span></span><span style="display:flex;"><span>set -o vi
</span></span><span style="display:flex;"><span>stty erase ^H
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>back_log <span style="color:#f92672">=</span> <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>external-locking <span style="color:#f92672">=</span> FALSE
</span></span><span style="display:flex;"><span>max_allowed_packet <span style="color:#f92672">=</span>8M
</span></span><span style="display:flex;"><span>thread_stack <span style="color:#f92672">=</span> 192K
</span></span><span style="display:flex;"><span>thread_stack <span style="color:#f92672">=</span> <span style="color:#ae81ff">192</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>mysql<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>no-auto-rehash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>过滤
</span></span><span style="display:flex;"><span>change master to Replicate_Ignore_DB <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;test&#39;</span>;
</span></span><span style="display:flex;"><span>Replicate_Do_DB:
</span></span><span style="display:flex;"><span>Replicate_Ignore_DB: 
</span></span><span style="display:flex;"><span>Replicate_Do_Table: 
</span></span><span style="display:flex;"><span>Replicate_Ignore_Table: 
</span></span><span style="display:flex;"><span>Replicate_Wild_Do_Table: 
</span></span><span style="display:flex;"><span>Replicate_Wild_Ignore_Table:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http://itindex.net/index/mha
</span></span><span style="display:flex;"><span>http://mysqlserverteam.com/
</span></span><span style="display:flex;"><span>https://www.cnblogs.com/xiaoboluo768/p/5973827.html
</span></span><span style="display:flex;"><span>https://blog.51cto.com/8370646/2150179
</span></span><span style="display:flex;"><span>https://www.cnblogs.com/zengkefu/p/5600776.html
</span></span><span style="display:flex;"><span>http://www.mamicode.com/info-detail-1488956.html?__cf_chl_jschl_tk__<span style="color:#f92672">=</span>864bd8082fbcc44cff88faa95540ef89c8b1b1ed-1584599149-0-AZzn7zH3F9Q-fMosxg8_z2LhSKfhM8v8fHU4CwyiFxVIk0VzRZI1cOMDw3H6MDQvflAFPsEL9s1MKiUp0hv-9DgUhwYnONrP7mGzp5ZLoSQBlxx9PK4W74ZQrzdsLbUqj3x_clEVUJwdXTPNq-3NiQ0Oz08ONGXWoF2Bx9WfddC9sPngJHUB9CgTE-TKk6o1ktyutexm0QT_zn1jyvml2RK4N133vdGwewmb4QttA_CjOSV4ftDAhu5284B86HQd3Q8VGbn0W9aIC0VGHARUdb5JE0tb2usYTx_IbtaG-QglcJIVYJD5eFWX8Vf7_Okbtw
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a051ebfaac6fc3a51384fae8d41525a3">mysql数据库搬迁</h1>
	<div class="lead">数据中心搬迁，龙腾出行mysql数据库迁移</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-01" class="text-body-secondary">Friday, August 01, 2025</time>
        
	</div>
	<table>
  <thead>
      <tr>
          <th>版本</th>
          <th>旧环境</th>
          <th>新环境</th>
          <th>root密码</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>8.0.22</td>
          <td>192.168.100.157  主库  4C  32GB  350G  + 100GB <br/>192.168.100.158   从库. 4C  32GB  350G  + 0GB</td>
          <td>已部署<br/>10.128.99.157  主库   主库  4C  32GB /Data=  350G  + /Backup = 100GB <br/>10.128.99.158   从库  从库. 4C  32GB /Data= 350G  +  /Backup = null</td>
          <td>d988ec6a93!@#MYSQL</td>
      </tr>
  </tbody>
</table>
<h3 id="全量迁移">全量迁移</h3>
<p>并发请求不高，在主节点执行全量备份</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y percona-xtrabackup-80.x86_64 
</span></span></code></pre></div><blockquote>
<p>耗时14分钟</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>xtrabackup <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--defaults-file<span style="color:#f92672">=</span>/etc/mysql80/mysql80_6301.cnf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--backup <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;root&#34;</span> --password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--target-dir<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Backup/fullbackup-</span><span style="color:#66d9ef">$(</span>date +%F<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--compress --compress-threads<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>  2&gt;&amp;<span style="color:#ae81ff">1</span> | tee /tmp/mysql6301_<span style="color:#66d9ef">$(</span>date +%F_%H%M%S<span style="color:#66d9ef">)</span>.log
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 限速50MB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 10.128.99.157 10.128.99.158</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### service mysql stop</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### rm -fr /Data/bak/* </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### rm -fr /Data/mysql6301/* &amp;&amp;  mkdir /Data/mysql6301/{binlog,data,log} -p ;touch /Data/mysql6301/log/mysqld-error.log </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 10分</span>
</span></span><span style="display:flex;"><span>scp -l <span style="color:#ae81ff">409600</span> -rp /Backup/fullbackup-2025-08-01/* bak@10.128.99.157:/Data/bak/
</span></span><span style="display:flex;"><span>scp -l <span style="color:#ae81ff">409600</span> -rp /Backup/fullbackup-2025-08-01/* bak@10.128.99.158:/Data/bak/
</span></span></code></pre></div><p>全量恢复</p>


<div class="alert alert-warning" role="alert">


    <p>从库备份时会将主从复制关系备份过来, 恢复数据时希望手动指定复制关系，可以通过只读参数取消<strong>slave进程</strong>启动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[mysqld]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">skip_slave_start</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">ON</span>
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 解压 16gb 耗时 2分钟</span>
</span></span><span style="display:flex;"><span>xtrabackup --decompress --parallel<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --target-dir<span style="color:#f92672">=</span>/Data/bak --remove-original
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 应用undolog</span>
</span></span><span style="display:flex;"><span>xtrabackup --prepare --apply-log-only --target-dir<span style="color:#f92672">=</span>/Data/bak
</span></span><span style="display:flex;"><span>xtrabackup --prepare --target-dir<span style="color:#f92672">=</span>/Data/bak
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 拷贝全量备份到datadir</span>
</span></span><span style="display:flex;"><span>xtrabackup --defaults-file<span style="color:#f92672">=</span>/etc/my.cnf --copy-back --target-dir<span style="color:#f92672">=</span>/Data/bak
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown -R mysql.mysql /Data/mysql6301
</span></span><span style="display:flex;"><span>service mysql start 
</span></span><span style="display:flex;"><span>chkconfig mysql on
</span></span></code></pre></div><p>设置只读</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>h <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">128</span>.<span style="color:#ae81ff">99</span>.<span style="color:#ae81ff">157</span> <span style="color:#75715e">--port=6301 -uroot -p&#39;d988ec6a93!@#MYSQL&#39; -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>; <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;super_read_only&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;read_only&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>h <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">128</span>.<span style="color:#ae81ff">99</span>.<span style="color:#ae81ff">158</span> <span style="color:#75715e">--port=6301 -uroot -p&#39;d988ec6a93!@#MYSQL&#39; -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>; <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;super_read_only&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;read_only&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><h3 id="增量同步">增量同步</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;replUser&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> IDENTIFIED  <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;RsU#58d1@&#39;</span> <span style="color:#66d9ef">WITH</span> mysql_native_password ; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> REPLICATION SLAVE,REPLICATION CLIENT <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;replUser&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span>; 
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div><p>查找全备时binlog位置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@db3-mysql80-m ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat /Data/bak/xtrabackup_binlog_info </span>
</span></span><span style="display:flex;"><span>mysql-bin.000451       <span style="color:#ae81ff">156</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>h <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">128</span>.<span style="color:#ae81ff">99</span>.<span style="color:#ae81ff">157</span> <span style="color:#75715e">--port=6301 -uroot -p&#39;d988ec6a93!@#MYSQL&#39; -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">reset</span> slave <span style="color:#66d9ef">all</span>;
</span></span><span style="display:flex;"><span>CHANGE MASTER <span style="color:#66d9ef">TO</span> 
</span></span><span style="display:flex;"><span>    MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.100.157&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span>,
</span></span><span style="display:flex;"><span>    MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;replUser&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RsU#58d1@&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mysql-bin.000451&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_LOG_POS<span style="color:#f92672">=</span><span style="color:#ae81ff">156</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">start</span> slave ;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> slave status <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -h 10.128.99.158 --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -uroot -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> -e <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">reset slave all;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CHANGE MASTER TO 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    MASTER_HOST=&#39;10.128.99.157&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    MASTER_PORT=6301,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    MASTER_USER=&#39;replUser&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    MASTER_PASSWORD=&#39;RsU#58d1@&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    MASTER_LOG_FILE=&#39;mysql-bin.000453&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    MASTER_LOG_POS=156;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start slave ;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">show slave status \G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><h3 id="数据对比">数据对比</h3>
<p>检查主从同步状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157 -e &#34;show slave status\G show variables like &#39;%read_only%&#39;&#34;|grep -E &#34;Slave_IO_Running:|Slave_SQL_Running:|Seconds_Behind_Master:|read_only&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.158 -e &#34;show slave status\G show variables like &#39;%read_only%&#39;&#34;|grep -E &#34;Slave_IO_Running:|Slave_SQL_Running:|Seconds_Behind_Master:|read_only&#34;
</span></span></span></code></pre></div><p>统计数据库元数据信息。确保数据库数量、表数量、索引数量、触发器、函数、存储过程、用户数量一致</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.158 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>    object_type,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">COUNT</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">AS</span> <span style="color:#66d9ef">count</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Users&#39;</span> <span style="color:#66d9ef">AS</span> object_type <span style="color:#66d9ef">FROM</span> mysql.<span style="color:#66d9ef">user</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Databases&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.SCHEMATA <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">SCHEMA_NAME</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Tables&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.TABLES <span style="color:#66d9ef">WHERE</span> TABLE_TYPE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;BASE TABLE&#39;</span> <span style="color:#66d9ef">AND</span> TABLE_SCHEMA <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Views&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.VIEWS <span style="color:#66d9ef">WHERE</span> TABLE_SCHEMA <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Triggers&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.TRIGGERS <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">TRIGGER_SCHEMA</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Routines&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.ROUTINES <span style="color:#66d9ef">WHERE</span> ROUTINE_TYPE <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;FUNCTION&#39;</span>, <span style="color:#e6db74">&#39;PROCEDURE&#39;</span>) <span style="color:#66d9ef">AND</span> <span style="color:#66d9ef">ROUTINE_SCHEMA</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Events&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.EVENTS <span style="color:#66d9ef">WHERE</span> EVENT_SCHEMA <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Indexes&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.<span style="color:#66d9ef">STATISTICS</span> <span style="color:#66d9ef">WHERE</span> TABLE_SCHEMA <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">AS</span> all_objects
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> object_type <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">ROLLUP</span>;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><h3 id="应用切割">应用切割</h3>
<ol>
<li>
<p>网络层做隔离(网络工程师)</p>
</li>
<li>
<p>旧库设置只读，杀连接 192.168.100.157</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.157  -e &#34;set global read_only=on;set global super_read_only=on;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.157    -e &#34;SELECT CONCAT(&#39;KILL &#39;, id, &#39;;&#39;) FROM information_schema.processlist WHERE user NOT IN (&#39;root&#39;, &#39;replUser&#39;,&#39;event_scheduler&#39;);&#34;  | grep -v CONCAT &gt; /tmp/kill192.168.100.157
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.157  &lt; /tmp/kill192.168.100.157
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.157   -e &#34;show processlist;&#34;
</span></span></span></code></pre></div><p>旧库设置只读，杀连接 192.168.100.158</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.158  -e <span style="color:#e6db74">&#34;set global read_only=on;set global super_read_only=on;show variables like &#39;%read_only%&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.158    -e <span style="color:#e6db74">&#34;SELECT CONCAT(&#39;KILL &#39;, id, &#39;;&#39;) FROM information_schema.processlist WHERE user NOT IN (&#39;root&#39;, &#39;replUser&#39;,&#39;event_scheduler&#39;);&#34;</span>  | grep -v CONCAT &gt; /tmp/kill192.168.100.158
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.158  &lt; /tmp/kill192.168.100.158
</span></span><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.158   -e <span style="color:#e6db74">&#34;show processlist;&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>停旧库和新库之间的数据同步</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 10.128.99.157  -e <span style="color:#e6db74">&#34;show slave status\G&#34;</span> &gt;/tmp/last_slave_state
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sleep 5;
</span></span><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 10.128.99.157  -e <span style="color:#e6db74">&#34;stop slave;reset slave all;show slave status\G&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>记录当前binglog位置用于回滚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157 -e &#34;show master status;&#34; &gt;/tmp/binlog_rollback_info
</span></span></span></code></pre></div></li>
<li>
<p>创建双主关系 10.128.99.157 &ndash;&gt; 10.128.99.158</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">多次执行确认master 位置不在变化</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.158 -e &#34;show master status;&#34; |tee /tmp/master1012899158
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>cat <span style="color:#f92672">/</span>tmp<span style="color:#f92672">/</span>master1012899158
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>CHANGE MASTER <span style="color:#66d9ef">TO</span>
</span></span><span style="display:flex;"><span>MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;10.128.99.158&#39;</span>,
</span></span><span style="display:flex;"><span>MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span>,
</span></span><span style="display:flex;"><span>MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;replUser&#39;</span>,
</span></span><span style="display:flex;"><span>MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RsU#58d1@&#39;</span>,
</span></span><span style="display:flex;"><span>MASTER_LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>MASTER_LOG_POS<span style="color:#f92672">=</span>;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><p>启动主从关系</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 10.128.99.157 -e <span style="color:#e6db74">&#34;start slave ; show slave status \G&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>新库关闭只读</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%read_only%&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.158 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%read_only%&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div></li>
<li>
<p>观察连接情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.158  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.157  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.158  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span></code></pre></div></li>
</ol>
<h3 id="回退环境搭建">回退环境搭建</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> <span style="color:#75715e">--port=6301 -h 192.168.100.157 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>stop slave; <span style="color:#66d9ef">reset</span> slave <span style="color:#66d9ef">all</span>; <span style="color:#66d9ef">show</span> slave status <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /tmp/binlog_rollback_info
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.157 -e <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;CHANGE MASTER TO
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_HOST=&#39;10.128.99.157&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PORT=6301,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_USER=&#39;replUser&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PASSWORD=&#39;RsU#58d1@&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_LOG_FILE=&#39;&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_LOG_POS=;&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.157 -e <span style="color:#e6db74">&#34;start slave;show slave status\G&#34;</span>
</span></span></code></pre></div><h3 id="执行回退">执行回退</h3>
<ol>
<li>
<p>旧库设置只读，杀连接</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157 -e &#34;set global read_only=on;set global super_read_only=on;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157  -e &#34;SELECT CONCAT(&#39;KILL &#39;, id, &#39;;&#39;) FROM information_schema.processlist WHERE user NOT IN (&#39;root&#39;, &#39;replUser&#39;,&#39;event_scheduler&#39;);&#34;  | grep -v CONCAT &gt; /tmp/kill10.128.99.157 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157   &lt; /tmp/kill10.128.99.157 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157    -e &#34;show processlist;&#34;
</span></span></span></code></pre></div></li>
<li>
<p>停旧库和新库之间的数据同步</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">没有延迟后，重置主从同步，取消只读。</span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> <span style="color:#75715e">--port=6301 -h 192.168.100.157 -e &#34;stop slave;reset slave all;&#34;
</span></span></span></code></pre></div><p>恢复 192.168.100.157 &ndash;&gt; 192.168.100.158 的数据同步</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">多次执行确认master 位置不在变化</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> <span style="color:#75715e">--port=6301 -h 192.168.100.158 -e &#34;show master status;&#34; |tee /tmp/master192168100158
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>cat <span style="color:#f92672">/</span>tmp<span style="color:#f92672">/</span>master192168100158
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.157 -e <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CHANGE MASTER TO
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_HOST=&#39;192.168.100.158&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PORT=6301,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_USER=&#39;replUser&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PASSWORD=&#39;RsU#58d1@&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_LOG_FILE=&#39;&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_LOG_POS=;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> <span style="color:#75715e">--port=6301 -h 192.168.100.157 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">start</span> slave ;<span style="color:#66d9ef">show</span> slave status <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> <span style="color:#75715e">--port=6301 -h 192.168.100.157 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;<span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> <span style="color:#75715e">--port=6301 -h 192.168.100.158 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;<span style="color:#e6db74">&#34;
</span></span></span></code></pre></div></li>
<li>
<p>查看连接状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.158  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.157  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.158  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span></code></pre></div></li>
</ol>

</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-600b4b95c21a8be4c420759c9c310fb0">2 - </h1>
    
	<p><a href="https://www.bilibili.com/video/BV1vL4y1J7i3/?p=14&amp;spm_id_from=pageDriver" target="_blank">mongo入门bilibili</a></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c17b09cb9416e4f7264c73ad103ea272">3 - </h1>
    
	<table>
  <thead>
      <tr>
          <th>特性</th>
          <th>开源版</th>
          <th>企业版</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>部署与管理</td>
          <td>手动部署、配置复杂</td>
          <td>支持多种部署模式，提供管理工具（GUI/CLI/API）  - 自建环境（软件安装） - Kubernetes - 托管服务（DBaaS） - 多云/混合云</td>
      </tr>
      <tr>
          <td>扩展性</td>
          <td>扩展需手动分片，可能停机</td>
          <td>支持在线水平和垂直扩容</td>
      </tr>
      <tr>
          <td>数据同步</td>
          <td>无内置数据同步工具</td>
          <td>RDI 自动同步关系数据库 - RDI（Redis Data Integration）自动同步关系型数据库 - 支持 Write Behind 模式</td>
      </tr>
      <tr>
          <td>技术支持</td>
          <td>社区支持</td>
          <td>24x7 原厂 + 虹科技术支持</td>
      </tr>
      <tr>
          <td>监控与运维</td>
          <td>需自行集成监控工具</td>
          <td>内置可观测性，支持多种监控平台 - 集成 Prometheus、Grafana、DataDog、Dynatrace 等 - 提供 Admin GUI、CLI、REST API、Terraform</td>
      </tr>
      <tr>
          <td>安全性</td>
          <td>基础认证，无企业级加密与审计</td>
          <td>全链路加密、ACL、LDAP、SSO、合规支持</td>
      </tr>
      <tr>
          <td>多租户</td>
          <td>-</td>
          <td>支持多租户，资源隔离</td>
      </tr>
      <tr>
          <td>Proxy支持</td>
          <td>-</td>
          <td>内置高性能 Proxy，简化客户端接入</td>
      </tr>
      <tr>
          <td>AI/ML支持</td>
          <td>-</td>
          <td>完整向量数据库与特征存储 - 向量数据库（Vector Database） - 特征存储（Feature Store） - 加速大语言模型（LLM）应用</td>
      </tr>
      <tr>
          <td>双主架构</td>
          <td>-</td>
          <td>支持Active-Active系统架构</td>
      </tr>
  </tbody>
</table>
<h3 id="常见问题">常见问题</h3>
<p>redis 主从切换
1.由于主节点阻塞通讯异常导致的主从切换 ==&gt; 检查慢查询命令（批量写入、批量删除、lua脚本等）、bigkeys</p>
<pre><code>2.主节点所在机器硬件故障导致的主从切换 ==》 检查主节点是否宕机，等待机器修复；检查服务器日志是否存在硬件报错
</code></pre>
<p>redis 内存使用率过高 ==》 检查是否存在内存泄漏（如：缓存未过期、缓存未命中等）；检查是否存在bigkeys（如：hash、list、set、zset等）
==》 redis节点扩容内存</p>
<p>redis 连接数过高 ==》 导出客户端连接明细给开发分析，分析是否存在异常连接数增加的客户端或者调整最大连接数配置</p>
<p>redis 响应时间过高 ==》 检查是否存在慢查询命令（如：批量写入、批量删除、lua脚本等）</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-e77814dc865bc892f94ffc02d54f2cfc">安装部署</h1>
	<div class="lead">redis部署安装</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-01" class="text-body-secondary">Friday, August 01, 2025</time>
        
	</div>
	<p>redis（<em>remote dictionary server</em>） 是开源的k-v<a href="https://db-engines.com/en/ranking" target="_blank">数据库</a>，使用内存存储，主要定位为数据缓存。除此之外还可以用于 <em>session 共享</em>，<em>排行榜、计数器</em>，<em>消息队列</em></p>

  
  
  

  
   
     

<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>安装部署</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="单节点" aria-controls="tabs-00-01" aria-selected="true">
        单节点
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="主从" aria-controls="tabs-00-02" aria-selected="false">
        主从
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="哨兵" aria-controls="tabs-00-03" aria-selected="false">
        哨兵
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-04" role="tab"
          data-td-tp-persist="集群" aria-controls="tabs-00-04" aria-selected="false">
        集群
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <p><span id=redis部署之单节点><font color=red size=4px>redis部署之单节点</font></span></p>
<ol>
<li>
<p>部署安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget http://download.redis.io/releases/redis-5.0.14.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf redis-5.0.14.tar.gz <span style="color:#f92672">&amp;&amp;</span> cd redis-5.0.14
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make <span style="color:#f92672">&amp;&amp;</span> make PREFIX<span style="color:#f92672">=</span>/opt/redis install 
</span></span></code></pre></div><p>二进制文件介绍</p>
<table>
  <thead>
      <tr>
          <th>命令</th>
          <th>释义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis-server</code></td>
          <td>启动server</td>
      </tr>
      <tr>
          <td><code>redis-cli</code></td>
          <td>客户端工具</td>
      </tr>
      <tr>
          <td><code>redis-benchmark</code></td>
          <td>基准测试工具</td>
      </tr>
      <tr>
          <td><code>redis-check-aof</code></td>
          <td>aof 检测和修复工具</td>
      </tr>
      <tr>
          <td><code>redis-check-dump</code></td>
          <td>rdb 检测和修复工具</td>
      </tr>
      <tr>
          <td><code>redis-sentinel</code></td>
          <td>启动 sentinel</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server
</span></span></code></pre></div></li>
</ol>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <p><span id=redis部署之主从><font color=red size=4px>redis部署之主从</font></span></p>
<blockquote>
<p><sub>主从架构在单节点基础上提供了数据的冗余能力，提升了redis的读取能力</sub></p>
</blockquote>
<ol>
<li>
<p>部署安装</p>
<p>参照 <a href=#redis部署之单节点>redis部署之单节点</a></p>
</li>
<li>
<p>启动服务</p>
<blockquote>
<p><sub>【支持三种配置方式：】</sub></p>
<p><sub>1. 在启动命令中添加<code> --SLAVEOF 10.4.7.251 6379</code></sub></p>
<p><sub>2. 通过redis-cli 登录到redis 执行 <code>slaveof 10.4.7.251 6379</code></sub></p>
<p><sub>3. 在redis.conf配置文件中写入 <code>slaveof 10.4.7.251 6379</code></sub></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6379</span> --daemonize yes --protected-mode no 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6380</span> --daemonize yes  --protected-mode no --SLAVEOF 10.4.7.251 <span style="color:#ae81ff">6379</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6381</span> --daemonize yes  --protected-mode no --SLAVEOF 10.4.7.251 <span style="color:#ae81ff">6379</span>
</span></span></code></pre></div><p>确认主从关系</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /opt/redis/bin/redis-cli -h 10.4.7.251 -p 6379 info replication</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Replication</span>
</span></span><span style="display:flex;"><span>role:master
</span></span><span style="display:flex;"><span>connected_slaves:2
</span></span><span style="display:flex;"><span>slave0:ip<span style="color:#f92672">=</span>10.4.7.251,port<span style="color:#f92672">=</span>6380,state<span style="color:#f92672">=</span>online,offset<span style="color:#f92672">=</span>56,lag<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>slave1:ip<span style="color:#f92672">=</span>10.4.7.251,port<span style="color:#f92672">=</span>6381,state<span style="color:#f92672">=</span>online,offset<span style="color:#f92672">=</span>56,lag<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div></li>
<li>
<p>测试主从切换</p>
<p>首先观察从节点复制偏移量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6380</span> info replication|grep master_repl_offset
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6381</span> info replication|grep master_repl_offset
</span></span></code></pre></div><p>选择一个偏移量最大的从节点，执行切换为主节点。当前环境我们把 <code>10.4.7.251:6381</code>切换为新的主节点。其他节点从新建立与该节点的主从关系</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6381</span> slaveof no one
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6381</span> role
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6379</span> SLAVEOF 10.4.7.251 <span style="color:#ae81ff">6381</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6380</span> SLAVEOF 10.4.7.251 <span style="color:#ae81ff">6381</span>
</span></span></code></pre></div></li>
<li>
<p>复制原理及相关参数</p>
<p><strong>复制原理</strong></p>
<pre><code>1. 从库通过slaveof 指令连接到master，并发起sync请求
2. master确认后，派生子线程bgsave生成rdb快照，并将快照传递给salve
3. salve接收到rdb快照后，清空本机rdb,加载主库传递过来的rdb 到内存
4. 以上完成后，master 会将变更数据缓存到本地 buffer中，按照一定规则传递给slave。允许从节点在短时间与主节点断开。
</code></pre>
<table>
  <thead>
      <tr>
          <th>复制相关参数</th>
          <th>解释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>repl-backlog-szie 1M</code></td>
          <td>环形复制积压缓冲区。最小值16k</td>
      </tr>
      <tr>
          <td><code>repl-diskless-sync yes</code></td>
          <td>开启无盘复制</td>
      </tr>
      <tr>
          <td><code>repl-diskless-sync-delay 5</code></td>
          <td>无盘复制延迟等待时长</td>
      </tr>
  </tbody>
</table>
</li>
</ol>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <p><span id=redis部署之哨兵><a herf=https://redis.io/docs/management/sentinel/><font color=red size=4px>redis部署之哨兵</font></a></span></p>
<blockquote>
<p><sub>哨兵集群是对主从的扩展，提供了主节点故障的自动转移并通知应用方能力。Redis从2.8开始正式 提供了Redis Sentinel</sub></p>
</blockquote>
<p>架构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>       +----+
</span></span><span style="display:flex;"><span>       | M1 |
</span></span><span style="display:flex;"><span>       | S1 |
</span></span><span style="display:flex;"><span>       +----+
</span></span><span style="display:flex;"><span>          |
</span></span><span style="display:flex;"><span>+----+    |    +----+
</span></span><span style="display:flex;"><span>| R2 |----+----| R3 |
</span></span><span style="display:flex;"><span>| S2 |         | S3 |
</span></span><span style="display:flex;"><span>+----+         +----+
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Configuration: quorum <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span></code></pre></div><ol>
<li>
<p>部署安装</p>
<p>参照<a href=#redis部署之单节点>redis部署之单节点</a></p>
</li>
<li>
<p>启动服务</p>
<p>参照<a href=#redis部署之主从>redis部署之主从</a></p>
</li>
<li>
<p>配置sentinel</p>
<blockquote>
<p><sub>Master-specific configuration parameters are modified using：<code>SENTINEL SET</code></sub></p>
<p><sub>Global configuration parameters are modified using <code>SENTINEL CONFIG SET</code>.</sub></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee redis-sentinel.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">daemonize yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># mymaster 为该集群起一个别名。一个sentinel 可以同时监控多个集群，因此使用别名区分
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># redis master的地址和端口10.4.7.251 6379
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2 表示有2个sentinel 判断master失败后才进行主从切换
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sentinel monitor mymaster 10.4.7.251 6379 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 每个Sentinel节点都要通过定期发送ping命令来判断Redis数据节点和其
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 余Sentinel节点是否可达，如果超过了down-after-milliseconds配置的时间且没
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 有有效的回复，则判定节点不可达 30000ms
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sentinel down-after-milliseconds mymaster 30000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 选举出新的主节点后，同时向主节点执行psync的从节点个数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sentinel parallel-syncs mymaster 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 故障转移超时时间 180000ms（选举新的主节点+从节点完成主从复制）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sentinel failover-timeout mymaster 180000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置sentinel 密码
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sentinel auth-pass mymaster 123456
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#sentinel auth-pass mymaster 12345
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#### 一组sentinel 支持多个主从集群
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#sentinel monitor resque 192.168.1.3 6380 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#sentinel down-after-milliseconds resque 10000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#sentinel failover-timeout resque 180000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#sentinel parallel-syncs resque 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>启动sentinel【默认监听26379】</p>
<blockquote>
<p><sub>【sentinel 的启动方式有2种：】</sub></p>
<p><sub><code>redis-sentinel /path/to/sentinel.conf</code></sub></p>
<p><sub><code>redis-server /path/to/sentinel.conf --sentinel</code></sub></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /tmp/<span style="color:#f92672">{</span>26379,26380,26381<span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server redis-sentinel.conf --sentinel <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bind 10.4.7.251 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--port <span style="color:#ae81ff">26379</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--dir /tmp/26379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--logfile /tmp/26379.log
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server redis-sentinel.conf --sentinel <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bind 10.4.7.251 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--port <span style="color:#ae81ff">26380</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--dir /tmp/26380 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--logfile /tmp/26380.log
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server redis-sentinel.conf --sentinel <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bind 10.4.7.251 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--port <span style="color:#ae81ff">26381</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--dir /tmp/26381 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--logfile /tmp/26381.log
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis-4.2/bin/redis-server ./redis-4.0.2/redis-sentinel17778.conf --port <span style="color:#ae81ff">17778</span> --sentinel --protected-mode no  --logfile /tmp/17778.log 
</span></span><span style="display:flex;"><span>/opt/redis-4.2/bin/redis-server ./redis-4.0.2/redis-sentinel17779.conf --port <span style="color:#ae81ff">17779</span> --sentinel --protected-mode no --logfile /tmp/17779.log
</span></span><span style="display:flex;"><span>/opt/redis-4.2/bin/redis-server ./redis-4.0.2/redis-sentinel17777.conf --port <span style="color:#ae81ff">17777</span> --sentinel --protected-mode no --logfile /tmp/17777.log
</span></span></code></pre></div></li>
<li>
<p>验证状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /opt/redis/bin/redis-cli -p 26379 -h 10.4.7.251</span>
</span></span><span style="display:flex;"><span>10.4.7.251:26379&gt; info sentinel
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sentinel</span>
</span></span><span style="display:flex;"><span>sentinel_masters:1
</span></span><span style="display:flex;"><span>sentinel_tilt:0
</span></span><span style="display:flex;"><span>sentinel_running_scripts:0
</span></span><span style="display:flex;"><span>sentinel_scripts_queue_length:0
</span></span><span style="display:flex;"><span>sentinel_simulate_failure_flags:0
</span></span><span style="display:flex;"><span>master0:name<span style="color:#f92672">=</span>mymaster,status<span style="color:#f92672">=</span>ok,address<span style="color:#f92672">=</span>10.4.7.251:6379,slaves<span style="color:#f92672">=</span>2,sentinels<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ok  状态正常</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#sdown 主观下线</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#odown 客观下线</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Redis Sentinel 有两种不同的宕机概念，一种称为 主观上为 Down 条件 （SDOWN），并且是 local 添加到给定的 Sentinel 实例。另一个称为客观关闭条件 （ODOWN），当有足够的 Sentinel（至少 number 配置为被监控 master 的参数）具有 SDOWN 条件</span>
</span></span></code></pre></div></li>
<li>
<p>验证主宕机</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -p <span style="color:#ae81ff">6379</span> -h 10.4.7.251 shutdown 
</span></span></code></pre></div><p>sentinel 节点30s 后标记节点主观（Subjectively）下线</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sentinel1_1  | 1:X <span style="color:#ae81ff">15</span> Apr <span style="color:#ae81ff">2024</span> 08:40:26.982 <span style="color:#75715e"># +sdown master mymaster 10.4.7.251 6379</span>
</span></span><span style="display:flex;"><span>sentinel2_1  | 1:X <span style="color:#ae81ff">15</span> Apr <span style="color:#ae81ff">2024</span> 08:40:26.983 <span style="color:#75715e"># +sdown master mymaster 10.4.7.251 6379</span>
</span></span><span style="display:flex;"><span>sentinel3_1  | 1:X <span style="color:#ae81ff">15</span> Apr <span style="color:#ae81ff">2024</span> 08:40:27.032 <span style="color:#75715e"># +sdown master mymaster 10.4.7.251 6379</span>
</span></span></code></pre></div><p>等待30s 后选出主节&hellip;.</p>
<p>重新启动宕机的节点，会自动加入到该主从中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> /opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6379</span> --daemonize yes
</span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>命令</th>
          <th>解释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>sentinel master mymaster</code></td>
          <td>查询主节点状态</td>
      </tr>
      <tr>
          <td><code>sentinel slaves mymaster</code></td>
          <td>查询从节点状态。或者命令 <code>sentinel replicas mymaster</code></td>
      </tr>
      <tr>
          <td><code>sentinel sentinels mymaster</code></td>
          <td>查询除自己外的sentinel节点信息</td>
      </tr>
      <tr>
          <td><code>sentinel get-master--by-name mymaster</code></td>
          <td>查询主节点的ip:port</td>
      </tr>
      <tr>
          <td><code> sentinel ckquorum mymaster</code></td>
          <td>检查哨兵集群是否满足切换需求</td>
      </tr>
      <tr>
          <td><code>sentinel flushconfig</code></td>
          <td>强制将sentinel 配置写入磁盘</td>
      </tr>
      <tr>
          <td><code>sentinel failover mymaster</code></td>
          <td>强制主从切换</td>
      </tr>
      <tr>
          <td><code>sentinel info-cache</code></td>
          <td>返回master-slave的缓存信息</td>
      </tr>
      <tr>
          <td><code>sentinel config get *</code></td>
          <td>获取sentinel 配置信息 &gt;=6.2</td>
      </tr>
      <tr>
          <td><code>sentinel config set &lt;key&gt; &lt;value&gt;</code></td>
          <td>动态设置sentinel 配置 &gt;=6.2</td>
      </tr>
  </tbody>
</table>
</li>
</ol>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-04" role="tabpanel" aria-labelled-by="tabs-00-04-tab" tabindex="0">
        <p><span id=redis部署之集群><font color=red size=4px>redis部署之集群</font></span></p>
<blockquote>
<p><sub>redis cluster 是redis 的分布式解决方案，在3.0后正式推出。其主要解决<strong>单节点写能力</strong>和<strong>存储能力</strong>受限的问题。</sub></p>
<p><sub>Redis集群相对单机在功能上存在一些限制，需要开发人员提前了解， 在使用时做好规避。限制如下：</sub></p>
<p><sub>1）key批量操作支持有限。如mset、mget，目前只支持具有相同slot值的 key执行批量操作。对于映射为不同slot值的key由于执行mset、mget等操作可能存在于多个节点上因此不被支持。<br>2）key事务操作支持有限。同理只支持多key在同一节点上的事务操作，当多个key分布在不同的节点上时无法使用事务功能。<br>3）key作为数据分区的最小粒度，因此不能将一个大的键值对象如 hash、list等映射到不同的节点。<br>4）不支持多数据库空间。单机下的Redis可以支持16个数据库，集群模式下只能使用一个数据库空间，即db0。<br>5）复制结构只支持一层，从节点只能复制主节点，不支持嵌套树状复制结构。</sub></p>
</blockquote>
<p><strong>部署方法一：</strong></p>
<ol>
<li>
<p>部署安装</p>
<p>参照 <a href=#redis部署之单节点>redis部署之单节点</a></p>
</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> port in <span style="color:#f92672">{</span>6379,6380,6381,7379,7380,7381<span style="color:#f92672">}</span>;<span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    mkdir -p /opt/redis_<span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>	/opt/redis/bin/redis-server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--bind 0.0.0.0 --port <span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--daemonize yes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--cluster-enabled yes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--cluster-config-file /opt/redis_<span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span>/nodes.conf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--logfile  /opt/redis_<span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span>/redis.log <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--cluster-node-timeout <span style="color:#ae81ff">1500</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--requirepass pytc@2024
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div></li>
<li>
<p>创建集群</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo yes |/opt/redis/bin/redis-cli -a pytc@2024 --cluster create <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster-replicas <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>192.168.0.161:6379 192.168.0.161:6380 192.168.0.161:6381 192.168.0.161:7379 192.168.0.161:7380 192.168.0.161:7381 
</span></span></code></pre></div></li>
</ol>
<p><strong>部署方法二：</strong></p>
<ol>
<li>
<p>部署安装</p>
<p>参照 <a href=#redis部署之单节点>redis部署之单节点</a></p>
</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6379</span> --daemonize yes  --cluster-enabled yes --cluster-config-file nodes-6379.conf --cluster-node-timeout <span style="color:#ae81ff">1500</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6380</span> --daemonize yes  --cluster-enabled yes --cluster-config-file nodes-6380.conf --cluster-node-timeout <span style="color:#ae81ff">1500</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6381</span> --daemonize yes  --cluster-enabled yes --cluster-config-file nodes-6381.conf --cluster-node-timeout <span style="color:#ae81ff">1500</span>
</span></span></code></pre></div></li>
<li>
<p>安装ruby环境</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rpm -e ruby --nodeps
</span></span><span style="display:flex;"><span>wget https://github.com/postmodern/ruby-install/archive/refs/tags/v0.8.5.tar.gz
</span></span><span style="display:flex;"><span>tar xf v0.8.5.tar.gz
</span></span><span style="display:flex;"><span>cd ruby-install-0.8.5/
</span></span><span style="display:flex;"><span>make install
</span></span><span style="display:flex;"><span>ruby-install --system ruby 2.6.10
</span></span></code></pre></div></li>
<li>
<p>安装redis-trib 工具</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># gem 是ruby的包管理工具，可以类比python的pip</span>
</span></span><span style="display:flex;"><span>yum install rubygems redis-trib -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gem sources
</span></span><span style="display:flex;"><span>gem sources --remove https://rubygems.org/
</span></span><span style="display:flex;"><span>gem sources -a https://mirrors.aliyun.com/rubygems/
</span></span><span style="display:flex;"><span>gem install redis
</span></span></code></pre></div></li>
<li>
<p>创建集群</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-trib create --replicas <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>10.4.7.251:6379 10.4.7.251:6380 10.4.7.251:6381
</span></span></code></pre></div></li>
</ol>
<p><strong>部署方法三：</strong></p>
<ol>
<li>
<p>部署安装</p>
<p>参照 <a href=#redis部署之单节点>redis部署之单节点</a></p>
</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6379</span> --daemonize yes  --cluster-enabled yes --cluster-config-file nodes-6379.conf --cluster-node-timeout <span style="color:#ae81ff">1500</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6380</span> --daemonize yes  --cluster-enabled yes --cluster-config-file nodes-6380.conf --cluster-node-timeout <span style="color:#ae81ff">1500</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6381</span> --daemonize yes  --cluster-enabled yes --cluster-config-file nodes-6381.conf --cluster-node-timeout <span style="color:#ae81ff">1500</span>
</span></span></code></pre></div></li>
<li>
<p>加入集群</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 cluster meet 10.4.7.251 <span style="color:#ae81ff">6380</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 cluster meet 10.4.7.251 <span style="color:#ae81ff">6381</span>
</span></span></code></pre></div></li>
<li>
<p>分配槽位</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 cluster addslots <span style="color:#f92672">{</span>0..5460<span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6380</span> cluster addslots <span style="color:#f92672">{</span>5461..10921<span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6381</span> cluster addslots <span style="color:#f92672">{</span>10922..16383<span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>建立主从关系</p>
</li>
</ol>
<p><strong>新增分片</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli --cluster add-node 127.0.0.1:7006 127.0.0.1:7000
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli -p <span style="color:#ae81ff">7000</span> cluster nodes
</span></span><span style="display:flex;"><span>46a768cfeadb9d2aee91ddd882433a1798f53271 127.0.0.1:7006@17006 master - <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754504000</span> <span style="color:#ae81ff">0</span> connected
</span></span><span style="display:flex;"><span>1f2bc068c7ccc9e408161bd51b695a9a47b890b2 127.0.0.1:7003@17003 slave a138f48fe038b93ea2e186e7a5962fb1fa6e34fa <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754504551</span> <span style="color:#ae81ff">3</span> connected
</span></span><span style="display:flex;"><span>5b4e4be56158cf6103ffa3035024a8d820337973 127.0.0.1:7001@17001 master - <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754505584</span> <span style="color:#ae81ff">2</span> connected 5461-10922
</span></span><span style="display:flex;"><span>a138f48fe038b93ea2e186e7a5962fb1fa6e34fa 127.0.0.1:7002@17002 master - <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754505000</span> <span style="color:#ae81ff">3</span> connected 10923-16383
</span></span><span style="display:flex;"><span>71e078dab649166dcbbcec51520742bc7a5c1992 127.0.0.1:7005@17005 slave 5b4e4be56158cf6103ffa3035024a8d820337973 <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754505584</span> <span style="color:#ae81ff">2</span> connected
</span></span><span style="display:flex;"><span>f224ecabedf39d1fffb34fb6c1683f8252f3b7dc 127.0.0.1:7000@17000 myself,master - <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754502000</span> <span style="color:#ae81ff">1</span> connected 0-5460
</span></span><span style="display:flex;"><span>04d71d5eb200353713da475c5c4f0a4253295aa4 127.0.0.1:7004@17004 slave f224ecabedf39d1fffb34fb6c1683f8252f3b7dc <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754505896</span> <span style="color:#ae81ff">1</span> connect
</span></span></code></pre></div><p>添加从节点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli -p <span style="color:#ae81ff">7000</span> --cluster add-node 127.0.0.1:7007 127.0.0.1:7000 --cluster-slave --cluster-master-id 46a768cfeadb9d2aee91ddd882433a1798f53271
</span></span></code></pre></div><p>为新分片分配slot</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli -p <span style="color:#ae81ff">7000</span> --cluster reshard 127.0.0.1:7000
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>How many slots <span style="color:#66d9ef">do</span> you want to move <span style="color:#f92672">(</span>from <span style="color:#ae81ff">1</span> to 16384<span style="color:#f92672">)</span>? <span style="color:#ae81ff">4096</span>
</span></span><span style="display:flex;"><span>What is the receiving node ID? 46a768cfeadb9d2aee91ddd882433a1798f53271
</span></span><span style="display:flex;"><span>Please enter all the source node IDs.
</span></span><span style="display:flex;"><span>  Type <span style="color:#e6db74">&#39;all&#39;</span> to use all the nodes as source nodes <span style="color:#66d9ef">for</span> the hash slots.
</span></span><span style="display:flex;"><span>  Type <span style="color:#e6db74">&#39;done&#39;</span> once you entered all the source nodes IDs.
</span></span><span style="display:flex;"><span>Source node <span style="color:#75715e">#1: all</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Ready to move <span style="color:#ae81ff">4096</span> slots.
</span></span><span style="display:flex;"><span>  Source nodes:
</span></span><span style="display:flex;"><span>	M: f224ecabedf39d1fffb34fb6c1683f8252f3b7dc 127.0.0.1:7000
</span></span><span style="display:flex;"><span>   	slots:<span style="color:#f92672">[</span>0-5460<span style="color:#f92672">]</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">5461</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   	<span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	M: 5b4e4be56158cf6103ffa3035024a8d820337973 127.0.0.1:7001
</span></span><span style="display:flex;"><span>   	slots:<span style="color:#f92672">[</span>5461-10922<span style="color:#f92672">]</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">5462</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   	<span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	M: a138f48fe038b93ea2e186e7a5962fb1fa6e34fa 127.0.0.1:7002
</span></span><span style="display:flex;"><span>   	slots:<span style="color:#f92672">[</span>10923-16383<span style="color:#f92672">]</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">5461</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   	<span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  Destination node:
</span></span><span style="display:flex;"><span>	M: 46a768cfeadb9d2aee91ddd882433a1798f53271 127.0.0.1:7006
</span></span><span style="display:flex;"><span>   	slots: <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   	<span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  Resharding plan:
</span></span><span style="display:flex;"><span>	Moving slot <span style="color:#ae81ff">5461</span> from 5b4e4be56158cf6103ffa3035024a8d820337973
</span></span><span style="display:flex;"><span>	Moving slot <span style="color:#ae81ff">5462</span> from 5b4e4be56158cf6103ffa3035024a8d820337973
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want to proceed with the proposed reshard plan <span style="color:#f92672">(</span>yes/no<span style="color:#f92672">)</span>? 
</span></span><span style="display:flex;"><span>Moving slot <span style="color:#ae81ff">5461</span> from 127.0.0.1:7001 to 127.0.0.1:7006:
</span></span><span style="display:flex;"><span>Moving slot <span style="color:#ae81ff">5462</span> from 127.0.0.1:7001 to 127.0.0.1:7006:
</span></span><span style="display:flex;"><span>Moving slot <span style="color:#ae81ff">5463</span> from 127.0.0.1:7001 to 127.0.0.1:7006:
</span></span></code></pre></div>
    </div>
</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c15fb40811dca9bb931163d78690c06b">redis-shake2.1.2</h1>
	<div class="lead">redis-shake2.1.2 docker镜像构建</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-01" class="text-body-secondary">Friday, August 01, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">


    redis-shake2.1.2 版本支持 redis 2.x to 6.x

</div>

<p><strong>参数</strong></p>
<table>
  <thead>
      <tr>
          <th>变量名</th>
          <th>可选值（举例）</th>
          <th><strong>备注</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>sourceType</td>
          <td>standalone sentinel cluster proxy</td>
          <td></td>
      </tr>
      <tr>
          <td>sourceAddress</td>
          <td>10.1.1.1:20331;10.1.1.2:20441</td>
          <td></td>
      </tr>
      <tr>
          <td>sourcePassword</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>targetType</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>targetAddress</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>targetPassword</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>keyExists</td>
          <td>rewrite none ignore</td>
          <td></td>
      </tr>
      <tr>
          <td>filterKeyWhitelist</td>
          <td>&ldquo;abc;bzz&rdquo;</td>
          <td>filterKeyWhitelist 和 filterKeyBlacklist 不能同时设置</td>
      </tr>
      <tr>
          <td>filterKeyBlacklist</td>
          <td>&ldquo;abc;bzz&rdquo;</td>
          <td></td>
      </tr>
      <tr>
          <td>filterDbWhitelist</td>
          <td>0;5;10</td>
          <td></td>
      </tr>
      <tr>
          <td>filterDbBlacklist</td>
          <td>0;5;10</td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="构建镜像">构建镜像</h3>

<details>
  <summary>Details</summary>
  <p>启动脚本<code>entrypoint.sh</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>set -ex
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>config<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>cat &gt;/etc/redis-shake.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">conf.version = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">id = redis-shake
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">system_profile = 9310
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http_profile = 9320
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">parallel = 32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">source.type = ${sourceType:- &#34;cluster&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">source.address = ${sourceAddress}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">source.password_raw = ${sourcePassword}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">source.auth_type = auth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target.type = ${targetType:- &#34;cluster&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target.address = ${targetAddress}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target.password_raw = ${targetPassword}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target.auth_type = auth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target.db = -1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">key_exists = ${keyExists:-&#34;ignore&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filter.db.whitelist = ${filterDbWhitelist}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filter.db.blacklist = ${filterDbBlacklist}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filter.key.whitelist = ${filterKeyWhitelist}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filter.key.blacklist = ${filterKeyBlacklist}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">big_key_threshold = 524288000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metric = true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metric.print_log = false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sender.size = 104857600
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sender.count = 4095
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sender.delay_channel_size = 65535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keep_alive = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">scan.key_number = 50
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">scan.special_cloud =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">scan.key_file =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">qps = 200000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">resume_from_break_point = false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">replace_hash_tag = false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exec <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div></details>


<details>
  <summary>Details</summary>
  <p><code>Dockerfile.yml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>FROM alpine:3.13
</span></span><span style="display:flex;"><span>ARG version<span style="color:#f92672">=</span>2.1.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN sed -i s#dl-cdn.alpinelinux.org#mirrors.tuna.tsinghua.edu.cn#g /etc/apk/repositories <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\ </span>
</span></span><span style="display:flex;"><span>    apk update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apk add vim curl python3 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    alias python<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;python3&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    rm -rf /var/cache/apk/*
</span></span><span style="display:flex;"><span><span style="color:#75715e">#wget https://github.com/tair-opensource/RedisShake/releases/download/release-v2.1.2-20220329/release-v2.1.2-20220329.tar.gz</span>
</span></span><span style="display:flex;"><span>COPY entrypoint.sh /
</span></span><span style="display:flex;"><span>COPY redis-shake.linux /usr/bin/redis-shake.linux
</span></span><span style="display:flex;"><span>EXPOSE <span style="color:#ae81ff">9320</span>
</span></span><span style="display:flex;"><span>ENTRYPOINT <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/entrypoint.sh&#34;</span><span style="color:#f92672">]</span>
</span></span></code></pre></div></details>

<p>构建镜像</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod +x  entrypoint.sh
</span></span><span style="display:flex;"><span>docker build . -t redis-shake:2.1.2-alpine
</span></span></code></pre></div><h3 id="迁移示例">迁移示例</h3>
<ol>
<li>
<p>docker环境测试变量解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee env<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sourceType=cluster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sourceAddress=127.0.0.1:6379;127.0.0.1:6380;127.0.0.1:6381;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sourcePassword=123
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetType=cluster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetAddress= 127.0.0.1:6479;127.0.0.1:6480;127.0.0.1:6481;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetPassword=456
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keyExists=rewrite
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filterKeyWhitelist=&#34;abc;bzz&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filterKeyBlacklist=&#34;abc;bzz&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filterDbWhitelist=0;5;10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filterKeyBlacklist=0;5;10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it  --env-file env redis-shak:2.1.2-alpine sh
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it  --env-file env redis-shak:2.1.2-alpine redis-shake.linux -type<span style="color:#f92672">=</span>sync -conf<span style="color:#f92672">=</span>/etc/redis-shake.conf
</span></span></code></pre></div></li>
<li>
<p>资源压力测试</p>
<table>
  <thead>
      <tr>
          <th>源端（版本5.0）</th>
          <th>目标端（版本5.0）</th>
          <th>数据量</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>8分片</td>
          <td>3分片</td>
          <td>12GB</td>
      </tr>
  </tbody>
</table>
<p>2.1 在源端生成数据</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 约12G数据</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nodelist<span style="color:#f92672">=(</span>
</span></span><span style="display:flex;"><span>node01
</span></span><span style="display:flex;"><span>node02
</span></span><span style="display:flex;"><span>node03
</span></span><span style="display:flex;"><span>node04
</span></span><span style="display:flex;"><span>node05
</span></span><span style="display:flex;"><span>node06
</span></span><span style="display:flex;"><span>node07
</span></span><span style="display:flex;"><span>node08
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#e6db74">${</span>nodelist[@]<span style="color:#e6db74">}</span>;<span style="color:#66d9ef">do</span> redis-cli -a <span style="color:#ae81ff">123</span> -h $i debug populate <span style="color:#ae81ff">12000000</span> $i;<span style="color:#66d9ef">done</span>
</span></span></code></pre></div>
     
     
<ul class="nav nav-tabs" id="tabs-3" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-03-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-00" role="tab"
          data-td-tp-persist="资源使用情况1" aria-controls="tabs-03-00" aria-selected="true">
        资源使用情况1
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-03-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-01" role="tab"
          data-td-tp-persist="资源使用情况2" aria-controls="tabs-03-01" aria-selected="false">
        资源使用情况2
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-3-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-03-00" role="tabpanel" aria-labelled-by="tabs-03-00-tab" tabindex="3">
        <p>2.2.1  配置同步</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d --net<span style="color:#f92672">=</span>host --env-file env nosql.registry.io:5000/redis-shak:2.1.2-alpine redis-shake.linux -type<span style="color:#f92672">=</span>sync -conf<span style="color:#f92672">=</span>/etc/redis-shake.conf
</span></span></code></pre></div><p>2.3.1 资源使用情况和同步耗时</p>
<p><img src="/docs/database/redis/%E8%B5%84%E6%BA%90%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B52.png" alt=""></p>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-03-01" role="tabpanel" aria-labelled-by="tabs-03-01-tab" tabindex="3">
        <p>2.2.1  配置同步，限制为 3c 4g</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d --cpus<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> -m 4G --net<span style="color:#f92672">=</span>host --env-file env nosql.registry.io:5000/redis-shak:2.1.2-alpine redis-shake.linux -type<span style="color:#f92672">=</span>sync -conf<span style="color:#f92672">=</span>/etc/redis-shake.conf
</span></span></code></pre></div><p>2.3.1 资源使用情况和同步耗时</p>
<p><img src="/docs/database/redis/%E8%B5%84%E6%BA%90%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5.png" alt=""></p>

    </div>
</div>

</li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-6ddb86c8e13cf6905967891813012ff5">redis-shake3.1.11</h1>
	<div class="lead">redis-shake3.1.11 docker镜像构建</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-01" class="text-body-secondary">Friday, August 01, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">


    Tested on Redis 5.0, Redis 6.0 and Redis 7.0

</div>

<p><strong>参数</strong></p>
<table>
  <thead>
      <tr>
          <th>变量名</th>
          <th>可选值（举例）</th>
          <th>备注</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>redisSourceVersion</td>
          <td>such as 2.8, 4.0, 5.0, 6.0, 6.2, 7.0, &hellip;</td>
          <td>浮点类型，赋值不需要加引号</td>
      </tr>
      <tr>
          <td>sourceAddress</td>
          <td>10.1.1.1:20331</td>
          <td>字符串类型，赋值需要加引号。集群中任意节点</td>
      </tr>
      <tr>
          <td>sourcePassword</td>
          <td></td>
          <td>字符串类型，赋值需要加引号</td>
      </tr>
      <tr>
          <td>targetType</td>
          <td>&ldquo;standalone&rdquo; or &ldquo;cluster&rdquo;</td>
          <td>字符串类型，赋值需要加引号</td>
      </tr>
      <tr>
          <td>redisTargetVersion</td>
          <td>such as 2.8, 4.0, 5.0, 6.0, 6.2, 7.0, &hellip;</td>
          <td>浮点类型，赋值不需要加引号</td>
      </tr>
      <tr>
          <td>targetAddress</td>
          <td>10.1.1.1:20331</td>
          <td>如果是集群模式，只写其中一个node,其他node信息redis-shake 通过 <code>cluster nodes</code>获取</td>
      </tr>
      <tr>
          <td>targetPassword</td>
          <td></td>
          <td>字符串类型，赋值需要加引号</td>
      </tr>
      <tr>
          <td>keyExists</td>
          <td>rewrite panic ignore</td>
          <td>字符串类型，赋值需要加引号</td>
      </tr>
      <tr>
          <td>prefixfilter</td>
          <td>true false</td>
          <td>确定前缀后后缀匹配</td>
      </tr>
      <tr>
          <td>filterKey</td>
          <td>{&ldquo;ABC&rdquo;,&ldquo;abc&rdquo;,&ldquo;def&rdquo;,&ldquo;def_&rdquo;}</td>
          <td></td>
      </tr>
      <tr>
          <td>blackfilter</td>
          <td>true false</td>
          <td>确定是黑名单还是白名单过滤</td>
      </tr>
  </tbody>
</table>
<h3 id="构建镜像">构建镜像</h3>

<details>
  <summary>Details</summary>
  <p>启动脚本<code>entrypoint.sh</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>set -ex
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>config<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>cat &gt;/etc/sync.toml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">type = &#34;sync&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[source]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">version = ${redisSourceVersion}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">address = ${sourceAddress}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">username = &#34;&#34; # keep empty if not using ACL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password = ${sourcePassword}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tls = false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[target]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">type = ${targetType}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">version = ${redisTargetVersion}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">address = ${targetAddress}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">username = &#34;&#34; # keep empty if not using ACL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password = ${targetPassword}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tls = false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[advanced]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dir = &#34;data&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># runtime.GOMAXPROCS, 0 means use runtime.NumCPU() cpu cores
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ncpu = 4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pprof_port = 9310
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metrics_port = 9320
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rdb_restore_command_behavior = ${keyExists:-&#34;ignore&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pipeline_count_limit = 1024
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target_redis_client_max_querybuf_len = 1024_000_000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target_redis_proto_max_bulk_len = 512_000_000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#array = {&#34;ABC&#34;,&#34;abc&#34;,&#34;def&#34;,&#34;def_&#34;}</span>
</span></span><span style="display:flex;"><span>array<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>filterKey<span style="color:#66d9ef">:-</span><span style="color:#e6db74">&#34;{}&#34;</span><span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">${</span>prefixfilter<span style="color:#e6db74">}</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#34;^&#34;&#39;</span>
</span></span><span style="display:flex;"><span>    suffix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#34;&#34;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#34;&#34;&#39;</span>
</span></span><span style="display:flex;"><span>    suffix<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">${</span>blackfilter<span style="color:#e6db74">}</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    allow<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    disallow<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    allow<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    disallow<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>cat &gt;/etc/filter.lua<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">function filter(id, is_base, group, cmd_name, keys, slots, db_id, timestamp_ms)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    -- 对mset多key的判断
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    if #keys ~= 1 then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        for _k,key in ipairs(keys)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            for k,v in ipairs(${array})
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                -- if string.match(key,string.format(&#34;^%s&#34;,v)) then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                if string.match(key,string.format(&#34;%s%s%s&#34;,${prefix:-&#34;&#34;},v,${suffix:-&#34;&#34;})) then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -- print(key,v)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    return ${allow:-0}, db_id -- 0 is  allow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        return ${disallow:-0}, db_id --1 is disallow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for k,v in ipairs(${array})
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        -- if string.sub(keys[1], -3, -1) == v then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        if string.match(keys[1],string.format(&#34;%s%s%s&#34;,${prefix},v,${suffix})) then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            return ${allow:-0}, db_id -- allow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    return ${disallow:-0}, db_id -- disallow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exec <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div></details>


<details>
  <summary>Details</summary>
  <p><code>Dockerfile.yml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>FROM alpine:3.13
</span></span><span style="display:flex;"><span>ARG version<span style="color:#f92672">=</span>3.1.11
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN sed -i s#dl-cdn.alpinelinux.org#mirrors.tuna.tsinghua.edu.cn#g /etc/apk/repositories <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\ </span>
</span></span><span style="display:flex;"><span>    apk update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apk add vim curl python3 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    alias python<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;python3&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    rm -rf /var/cache/apk/*
</span></span><span style="display:flex;"><span><span style="color:#75715e">#wget https://github.com/tair-opensource/RedisShake/releases/download/v3.1.11/redis-shake-linux-amd64.tar.gz</span>
</span></span><span style="display:flex;"><span>COPY entrypoint.sh /
</span></span><span style="display:flex;"><span>COPY redis-shake /usr/bin/redis-shake
</span></span><span style="display:flex;"><span>EXPOSE <span style="color:#ae81ff">9320</span>
</span></span><span style="display:flex;"><span>ENTRYPOINT <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/entrypoint.sh&#34;</span><span style="color:#f92672">]</span>
</span></span></code></pre></div></details>

<p>构建镜像</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod +x  entrypoint.sh
</span></span><span style="display:flex;"><span>docker build . -t redis-shake:3.1.11-alpine 
</span></span></code></pre></div><h3 id="迁移示例">迁移示例</h3>
<ol>
<li>
<p>docker环境测试变量解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee env<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">redisSourceVersion=5.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sourceAddress=&#34;127.0.0.1:6379&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sourcePassword=&#34;123&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">redisTargetVersion=5.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetType=&#34;cluster&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetAddress=&#34;127.0.0.1:6479&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetPassword=&#34;456&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keyExists=&#34;rewrite&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prefixfilter=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filterKey={&#34;ABC&#34;,&#34;abc&#34;,&#34;def&#34;,&#34;def_&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">blackfilter=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it  --env-file env redis-shake:3.1.11-alpine sh
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it  --env-file env redis-shake:3.1.11-alpine  redis-shake /etc/sync.toml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it  --env-file env redis-shake:3.1.11-alpine  redis-shake /etc/sync.toml /etc/filter.lua
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker exec -it 36e54 curl 127.0.0.1:9320/metrics|python -m json.tool
</span></span></code></pre></div><p>指标监控：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>syncing aof. allowOps<span style="color:#f92672">=[</span>0.60<span style="color:#f92672">]</span>, disallowOps<span style="color:#f92672">=[</span>0.00<span style="color:#f92672">]</span>, entryId<span style="color:#f92672">=[</span>2<span style="color:#f92672">]</span>, InQueueEntriesCount<span style="color:#f92672">=[</span>0<span style="color:#f92672">]</span>, unansweredBytesCount<span style="color:#f92672">=[</span>0<span style="color:#f92672">]</span>bytes, diff<span style="color:#f92672">=[</span>0<span style="color:#f92672">]</span>, aofReceivedOffset<span style="color:#f92672">=[</span>9808<span style="color:#f92672">]</span>, aofAppliedOffset<span style="color:#f92672">=[</span>9808<span style="color:#f92672">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>allowOps：代表每秒向目的端发送多少条命令
</span></span><span style="display:flex;"><span>disallowOps：代表每秒有多少条命令被过滤掉
</span></span><span style="display:flex;"><span>entryId：从 <span style="color:#ae81ff">1</span> 开始计数，代表 redis-shake 从启动开始总共处理多少条命令
</span></span><span style="display:flex;"><span>InQueueEntriesCount：代表多少条命令待发送
</span></span><span style="display:flex;"><span>unansweredBytesCount：代表多少 bytes 命令已经发送了，但是对端还没有答复
</span></span><span style="display:flex;"><span>diff：aofReceivedOffset-aofAppliedOffset
</span></span><span style="display:flex;"><span>aofReceivedOffset：已经从源端接收到的点位
</span></span><span style="display:flex;"><span>aofAppliedOffset：已经在目的端恢复的点位
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>一般当 allowOps 为 <span style="color:#ae81ff">0</span> 时，代表数据迁移完成，可以停止 redis-shake。⚠️注意，因为源端会定时发送 PING 命令，所以哪怕源端没有写入，allowOps 偶尔也会不是 0。
</span></span></code></pre></div></li>
<li>
<p>资源压力测试</p>
<table>
  <thead>
      <tr>
          <th>源端（版本5.0）</th>
          <th>目标端（版本5.0）</th>
          <th>数据量</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>8分片</td>
          <td>3分片</td>
          <td>12GB</td>
      </tr>
  </tbody>
</table>
<p>测试结果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>单pod 消耗 220% cpu
</span></span><span style="display:flex;"><span>单pod 消耗 12MB memory
</span></span><span style="display:flex;"><span>全量同步耗时 6分钟
</span></span></code></pre></div></li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-9171779f07ad97b25103d1ce9ca3b8a7">redis数据库搬迁方案2</h1>
	<div class="lead">数据中心搬迁，龙腾出行redis数据库迁移</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-01" class="text-body-secondary">Friday, August 01, 2025</time>
        
	</div>
	<table>
  <thead>
      <tr>
          <th>旧环境</th>
          <th>新环境</th>
          <th>密码</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>192.168.100.66、192.168.100.67 11G</td>
          <td>10.128.100.66（主）、10.128.100.67（从）</td>
          <td>YSxeEr3e4ZdF</td>
      </tr>
      <tr>
          <td>192.168.100.34 11G</td>
          <td>10.128.100.34(主）、10.128.99.34(从)</td>
          <td></td>
      </tr>
      <tr>
          <td>192.168.100.57, 192.168.100.58, 192.168.100.59  6G</td>
          <td>10.128.100.57, 10.128.100.58, 10.128.100.59</td>
          <td>xb91830913039bhdk</td>
      </tr>
  </tbody>
</table>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">内存空余的情况下，被同步的源端执行</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 默认 256m 64m 60 调整为 512m 128m 60</span>
</span></span><span style="display:flex;"><span>CONFIG set client-output-buffer-limit <span style="color:#e6db74">&#34;slave 536870912 134217728 60&#34;</span>
</span></span><span style="display:flex;"><span>CONFIG GET client-output-buffer-limit 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 默认1m 调整为1gb</span>
</span></span><span style="display:flex;"><span>config set repl-backlog-size <span style="color:#ae81ff">1073741824</span>
</span></span><span style="display:flex;"><span>CONFIG GET repl-backlog-size
</span></span></code></pre></div>

</div>

<h3 id="切换">切换</h3>


  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="redis01" aria-controls="tabs-01-00" aria-selected="true">
        redis01
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="redis02" aria-controls="tabs-01-01" aria-selected="false">
        redis02
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <p><strong>redis01登录 10.128.100.66 杀连接</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.100.66/ &amp;&amp; !/10.128.100.67/ {print &#34;client kill&#34;, $4}&#39;</span>| redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.100.66/ &amp;&amp; !/10.128.100.67/ {print &#34;client kill&#34;, $4}&#39;</span>
</span></span></code></pre></div><p><strong>停同步</strong></p>
<p>数据校验</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info keyspace
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 info keyspace
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis_check.sh --source-ip 192.168.100.67 --source-pwd YSxeEr3e4ZdF <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --target-ip 10.128.100.66 --target-pwd YSxeEr3e4ZdF <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --compare-mode <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --qps <span style="color:#ae81ff">5000</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --db-file redis01.db
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 client list
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 slaveof no one 
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 info replication
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;set a b\n del a&#34;</span> | redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66
</span></span></code></pre></div><p>添加从节点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.67 slaveof 10.128.100.66 <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.67 info replication
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <p><strong>redis02登录 10.128.99.34 杀连接</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 192.168.100.34 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.99.34/ &amp;&amp; !/10.128.100.34/{print &#34;client kill&#34;, $4}&#39;</span>|redis-cli -h 192.168.100.34
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>redis-cli -h 192.168.100.34 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.99.34/ &amp;&amp; !/10.128.100.34/{print &#34;client kill&#34;, $4}&#39;</span>
</span></span></code></pre></div><p><strong>停同步</strong></p>
<p>数据校验</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 192.168.100.34 info keyspace
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.34 info keyspace
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis_check.sh --source-ip 192.168.100.34 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --target-ip 10.128.100.34 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --compare-mode <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --qps <span style="color:#ae81ff">5000</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --db-file redis02.db
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 10.128.100.34 client list
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.34 slaveof no one 
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.34 info replication
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;set a b\n del a&#34;</span> | redis-cli -h 10.128.100.34  
</span></span></code></pre></div>
    </div>
</div>

<h3 id="回退">回退</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## redis01登录 10.128.100.66 清理旧库数据</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 bgsave </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># mv /dump.rdb /dump.rdb.$(date +%F\ %H:%M:%S)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 确认没有从节点连接</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info replication </span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 slaveof 10.128.100.66 6379 </span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info replication</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## redis02登录 10.128.99.34 清理旧库数据 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -h 192.168.100.34 bgsave </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># mv /dump.rdb /dump.rdb.$(date +%F\ %H:%M:%S)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 确认没有从节点连接</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -h 192.168.100.34 info replication </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -a YSxeEr3e4ZdF -h 192.168.100.34 slaveof 10.128.100.34 6379 </span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -a YSxeEr3e4ZdF -h 192.168.100.34 info replication</span>
</span></span></code></pre></div>

  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          data-td-tp-persist="redis01" aria-controls="tabs-02-00" aria-selected="true">
        redis01
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="redis02" aria-controls="tabs-02-01" aria-selected="false">
        redis02
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        <p><strong>redis01登录 10.128.100.66 杀连接</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.100.66/ &amp;&amp; !/10.128.100.67/ &amp;&amp; !/192.168.100.66/{print &#34;client kill&#34;, $4}&#39;</span>| redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.100.66/ &amp;&amp; !/10.128.100.67/ &amp;&amp; !/192.168.100.66/{print &#34;client kill&#34;, $4}&#39;</span>
</span></span></code></pre></div><p><strong>停同步</strong></p>
<p>数据校验</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info keyspace
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 info keyspace
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis_check.sh --source-ip 10.128.100.66 --source-pwd YSxeEr3e4ZdF <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --target-ip 192.168.100.66 --target-pwd YSxeEr3e4ZdF <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --compare-mode <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --qps <span style="color:#ae81ff">50000</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --db-file redis01.db
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 client list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 slaveof no one 
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info replication
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;set a b\n del a&#34;</span> | redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <p><strong>redis02登录 10.128.99.34 杀连接</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># redis02登录 10.128.99.34 杀连接</span>
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.34 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.99.34/ &amp;&amp; !/192.168.100.34/{print &#34;client kill&#34;, $4}&#39;</span>|redis-cli -h 10.128.100.34
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.34 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.99.34/ &amp;&amp; !/192.168.100.34/{print &#34;client kill&#34;, $4}&#39;</span>
</span></span></code></pre></div><p><strong>停同步</strong></p>
<p>数据校验</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 192.168.100.34 info keyspace
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.34 info keyspace
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis_check.sh --source-ip 10.128.100.34 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --target-ip 192.168.100.34 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --compare-mode <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --qps <span style="color:#ae81ff">50000</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --db-file redis02.db
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 停同步</span>
</span></span><span style="display:flex;"><span>redis-cli -h 192.168.100.34  client list
</span></span><span style="display:flex;"><span>redis-cli -h 192.168.100.34 slaveof no one 
</span></span><span style="display:flex;"><span>redis-cli -h 192.168.100.34 info replication
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;set a b\n del a&#34;</span> | redis-cli -h 192.168.100.34 
</span></span></code></pre></div>
    </div>
</div>

<h3 id="收尾工作">收尾工作</h3>
<ol>
<li>
<p>停止集群的同步工具</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/Data/redis7/redis7_6379/bin/redis-cli -a xb91830913039bhdk --cluster call 192.168.100.58:6379 dbsize
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl status redis_sync_cluster01
</span></span></code></pre></div></li>
<li>
<p>从节点接入到master</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 10.128.99.34 slaveof 10.128.100.34 <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.67 -a YSxeEr3e4ZdF slaveof 10.128.100.66 <span style="color:#ae81ff">6379</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 10.128.99.34 config set save <span style="color:#e6db74">&#34;900 1 300 10 60 10000&#34;</span>
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.99.34 config rewirte
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 10.128.100.67 -a YSxeEr3e4ZdF config set save <span style="color:#e6db74">&#34;900 1 300 10 60 10000&#34;</span>
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.67 -a YSxeEr3e4ZdF config rewirte
</span></span></code></pre></div></li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a9beb947715b173b615f76eaebc63922">Redis8.4.0版本</h1>
	<div class="lead">背景:Redis5.0.14 被爆出存在多种安全漏洞，为规避漏洞考虑升级为8.4.0</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-12-23" class="text-body-secondary">Tuesday, December 23, 2025</time>
        
	</div>
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker network create 8.4.0 --subnet 100.100.1.0/24
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#f92672">{</span>2..7<span style="color:#f92672">}</span>;<span style="color:#66d9ef">do</span> docker rm -fv cmbredis<span style="color:#e6db74">${</span>i<span style="color:#e6db74">}</span>;<span style="color:#66d9ef">done</span> 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#f92672">{</span>2..7<span style="color:#f92672">}</span>;<span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>docker run -d <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--name<span style="color:#f92672">=</span>cmbredis<span style="color:#e6db74">${</span>i<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--net<span style="color:#f92672">=</span>8.4.0 --ip<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100.100.1.</span><span style="color:#e6db74">${</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e SALT_MASTER_IP_LIST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;192.168.0.1&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_CONFIG<span style="color:#f92672">=</span>pcloud_config <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_BGSAVE<span style="color:#f92672">=</span>bgsave <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_DEBUG<span style="color:#f92672">=</span>debug <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_SAVE<span style="color:#f92672">=</span>save <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_SHUTDOWN<span style="color:#f92672">=</span>shutdown <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_SLAVEOF<span style="color:#f92672">=</span>slaveof <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_BGREWRITEAOF<span style="color:#f92672">=</span>bgrewriteaof <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e REDIS_PASSWORD<span style="color:#f92672">=</span><span style="color:#ae81ff">123</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>cmb-redis:8.4.0-alpine313;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker exec -it cmbredis2  redis-cli --user default -a <span style="color:#ae81ff">123</span> --cluster create <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster-replicas <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>100.100.1.2:6379 100.100.1.3:6379 100.100.1.4:6379 100.100.1.5:6379 100.100.1.6:6379 100.100.1.7:6379
</span></span></code></pre></div>
</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c8553d33d8183ae3ce84731b8c2608db">4 - </h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-13e8e3ce9786760d8157f34cd761bd21">5 - </h1>
    
	<p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tidb-architecture-v6.png" alt=""></p>
<h3 id="集群安装">集群安装</h3>
<h3 id="数据同步">数据同步</h3>
<h3 id="数据迁移">数据迁移</h3>
<h3 id="数据备份">数据备份</h3>
<h3 id="数据恢复">数据恢复</h3>
<h3 id="命令行工具">命令行工具</h3>
<h3 id="监控">监控</h3>
<h3 id="安全">安全</h3>
<h3 id="性能优化">性能优化</h3>
<h3 id="故障处理">故障处理</h3>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-67eb87020312586dadda63d97ee6dd73">pcta</h1>
	<div class="lead">平凯数据库认证 TiDB 数据库专员（简称 PCTA）是平凯星辰对于数据库从业者安装部署及日常运维分布式关系型数据库能力的认证，要求数据库从业者熟练掌握 TiDB Open Core 架构原理、安装部署、周边工具等基础知识。</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-11" class="text-body-secondary">Monday, August 11, 2025</time>
        
	</div>
	<p><img src="https://asktug.com/uploads/default/original/4X/c/d/9/cd9bcb7f3bd551a7febf28c9f79c86cd81589517.png" alt=""></p>
<p>Tso(timestamp oracle) 用于标识事务的先后顺序</p>
<h3 id="tidb数据库架构">tidb数据库架构</h3>
<p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tidb-architecture-v6.png" alt=""></p>
<h4 id="tidb-server">tidb server</h4>
<p>tidb server为<font color=red>无状态</font>服务，在生产中可以启动多个实例并通过LB对外提供统一的连接地址。</p>
<p><strong>主要功能：</strong></p>
<ol>
<li>
<p>对外提供mysql 5.7协议的连接服务 （<code>protocol layer</code>）</p>
</li>
<li>
<p>负责对sql解析、编译、优化并最终生成执行计划 (<code>parese</code>、<code>compile</code>)</p>
<p><code>parse</code> 通过此法分析器将sql 拆借成一个一个的字段，接着进行此法分析。将解析后的内容传递给 <code>compile</code>, 编译器执行逻辑优化和物理优化生成执行计划</p>
</li>
<li>
<p>执行sql (<code>executor</code>、<code>distsql</code>、<code>kv</code>)、事务（<code>transaction</code>、<code>kv</code>）</p>
</li>
<li>
<p>负责sql语句与tikv 数据结构的转化 。</p>
<p><strong>表数据与 Key-Value 的映射关系:</strong></p>
<p>TiDB 会为每个表分配一个表 ID，用 <code>TableID</code> 表示。表 ID 是一个整数，在整个集群内唯一。TiDB 会为表中每行数据分配一个行 ID，用 <code>RowID</code> 表示。行 ID 也是一个整数，在表内唯一。对于行 ID，TiDB 做了一个小优化，如果某个表有整数型的主键，TiDB 会使用主键的值当做这一行数据的行 ID。</p>
<p>最终将每一行转换成以k:v 格式的数据,其中 <code>tablePrefix</code> 和 <code>recordPrefixSep</code> 都是特定的字符串常量，用于在 Key 空间内区分其他数据</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Key:   tablePrefix<span style="color:#f92672">{</span>TableID<span style="color:#f92672">}</span>_recordPrefixSep<span style="color:#f92672">{</span>RowID<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Value: <span style="color:#f92672">[</span>col1, col2, col3, col4<span style="color:#f92672">]</span>
</span></span></code></pre></div><p><strong>索引数据和 Key-Value 的映射关系:</strong></p>
<p>与表数据映射方案类似，TiDB 为表中每个索引分配了一个索引 ID，用 <code>IndexID</code> 表示。</p>
<p>对于主键和唯一索引，需要根据键值快速定位到对应的 RowID，因此，按照如下规则编码成 (Key, Value) 键值对：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Key:   tablePrefix<span style="color:#f92672">{</span>tableID<span style="color:#f92672">}</span>_indexPrefixSep<span style="color:#f92672">{</span>indexID<span style="color:#f92672">}</span>_indexedColumnsValue
</span></span><span style="display:flex;"><span>Value: RowID
</span></span></code></pre></div><p>对于不需要满足唯一性约束的普通二级索引，一个键值可能对应多行，需要根据键值范围查询对应的 RowID。因此，按照如下规则编码成 (Key, Value) 键值对：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Key:   tablePrefix<span style="color:#f92672">{</span>TableID<span style="color:#f92672">}</span>_indexPrefixSep<span style="color:#f92672">{</span>IndexID<span style="color:#f92672">}</span>_indexedColumnsValue_<span style="color:#f92672">{</span>RowID<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Value: null
</span></span></code></pre></div></li>
<li>
<p>执行online DDL (<code>schema load</code>、<code>worker</code>、<code>start job</code>)在同一时刻只有一个tidbserver执行该操作</p>
</li>
<li>
<p>垃圾回收（对于update 等多次的修改，数据库会保留历史版本，tidbserver 每隔10分钟(gc lifetime)执行一次历史版本的回收） （gc）</p>
</li>
<li>
<p>缓存（memBuffer）默认使用tidb-server 所有内存。</p>
<ul>
<li>sql结果</li>
<li>线程缓存</li>
<li>元数据，统计信息</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 每个sql可以使用最大内存</span>
</span></span><span style="display:flex;"><span>tidb_mem_quota_query
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 超过最大缓存时的动作，可以是杀掉sql</span>
</span></span><span style="display:flex;"><span>oom-action
</span></span></code></pre></div></li>
<li>
<p>热点小表缓存功能（v6.0版本开始支持对热点表缓存）(<code>cache table</code>)</p>
<ul>
<li>
<p>64MB 以下的表</p>
</li>
<li>
<p>查询频繁，修改极少</p>
</li>
<li>
<p>缓存租约时间内，阻塞写操作。</p>
</li>
<li>
<p>开启热点小表缓存的表，无法执行ddl 修改。</p>
</li>
</ul>
<p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250801085345694.png" alt=" "></p>
</li>
</ol>
<h4 id="pd">pd</h4>
<p>被称为<code>placement driver</code> 是整个集群的大脑内置etcd,<font color=red>有状态</font>建议部署奇数实现高可用。</p>
<ol>
<li>
<p>存储每个 TiKV 节点实时的数据分布情况和集群的整体拓扑结构等元数据</p>
</li>
<li>
<p>分配全局id和事务id</p>
</li>
<li>
<p>负责为集群内各组件分配TSO 时间戳。这些时间戳用于为事务和数据分配时间标记。对于事务提供一个开始TSO 和一个结束TSO 。</p>
<p>TSO 时间戳由两部分组成：</p>
<ul>
<li>物理时间戳：自 1970 年 1 月 1 日以来的 UNIX 时间戳，单位为毫秒</li>
<li>逻辑时间戳：递增计数器，用于需要在一毫秒内使用多个时间戳的情况，或某些事件可能触发时钟进程逆转的情况。在这些情况下，物理时间戳会保持不变，而逻辑时间戳保持递增。该机制可以确保 TSO 时间戳的完整性，确保时间戳始终递增而不会倒退。</li>
</ul>
</li>
<li>
<p>根据 TiKV 节点上报的数据动态均衡数据分布,例如：</p>
<ul>
<li>对tikv执行leader、热点region 均衡</li>
</ul>
<ul>
<li>集群拓扑</li>
<li>缩容</li>
<li>故障恢复</li>
<li>Region merge</li>
</ul>
</li>
<li>
<p>根据label，支持对region分布的手动调度。</p>
<p>tikv实例添加zone 、rack、host等标签后，可以通过pd的调度功能实现基于标签不同级别的高可用。（k8s的node节点添加标签后当pod调度时添加亲和反亲和策略）</p>
</li>
<li>
<p>提供 TiDB Dashboard 管控界面</p>
</li>
</ol>
<p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250808112254855.png" alt="image-20250808112254855"></p>
<p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250808112604664.png" alt="image-20250808112604664"></p>
<h4 id="tikv">TiKV</h4>
<p>作为分布式存储系统,tikv基于key-value方式存储数据。数据按照key的范围保存到region中，region是tikv的最小存储单元（大小在96MB-144MB之间），每个region默认保证三个副本通过raft协议保证数据的强一致性，而数据的落盘则调用 Facebook 开源的rocksDB实现。<font color=red>有状态服务</font></p>
<h5 id="rocksdb">RocksDB</h5>
<p><code>RocksDB</code> 是 Facebook 开源的单机 KV 存储引擎，内部使用LSM存储引擎</p>
<p><strong>数据存储流程：</strong> 数据存储时先写入wal 预写日志和 memTable中，当memtable 写入达到指定大小后将该memtable 归档并入immutable 的队列中，从新开启一个新的memtable继续接收新的写入。开启一个新线程将队列中的数据持续写入磁盘持久化</p>
<p>当队列中等待写入磁盘的队列大于5时，rocksdb开启流量控制降低写入速度。</p>
<p>磁盘中文件按照压缩级别分为6个级别：</p>
<p>level0 是 immutable的数据复刻，level0数据达到一定大小时rocksdb 执行数据合并压缩（compaction）生成level1文件，依次类推。 每一个文件称为SST（stored string table）</p>
<p><strong>数据读取流程：</strong> rocksdb中存在一个<em>blockcache</em> 的查询内存空间用于缓存最近查询，如果缓存中不存在则从memtable中查找，如果memtable找不到，继续去磁盘中通过<em>二分查找法</em>继续查找</p>
<p><strong>数据删除流程：</strong> 无需要查找到原始数据，只需要执行del操作</p>
<p><strong>RocksDB列族（column family）:</strong> 是rocksdb的数据分片技术，可以按照不同的id分配给不同的<strong>列族</strong>，如果未指定列族则写入default。一个rocksdb 实例可以对应多个列族，每个列族有自己的memtabl 、SST ，共享wal</p>
<p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250807084844225.png" alt="image-20250807084844225"></p>
<h5 id="raft">Raft</h5>
<p>RocksDB提供单机存储能力，为保证数据的高可用引入了<a href="https://raft.github.io/raft.pdf" target="_blank">raft协议</a>。TiKV 利用 Raft 来做数据复制，每个数据变更都会落地为一条 Raft 日志，通过 Raft 的日志复制功能，将数据安全可靠地同步到复制组的每一个节点中。通过实现 Raft，TiKV 变成了一个分布式的 Key-Value 存储。</p>
<ul>
<li>
<p>Leader选举。</p>
<p>在raft协议中节点刚创建时所有节点都处于<em>flollower</em>状态，在指定的 <em>election timeout</em>  时间内如果没有找到 <em>leader</em> ,优先达到 <em>election timeout</em> 的节点将发起选举进入<em>candidate</em> 状态并将<code>term+1</code>，在获得多数投票后该成员状态转为 <em>leader</em> 状态。</p>
<p>集群关系建立后，<em>leader</em>定期向<em>follower</em> 发送心跳消息，在指定的 <em>heartbeat time interval</em> 内未收到 <em>leader</em> 的心跳信息的<em>follwer</em> 将会进入下一个<em>term</em> 并发起选举进去<em>candidate</em>状态，在获得多数投票后该成员状态转为 <em>leader</em> 状态。</p>
</li>
<li>
<p>日志复制</p>
<p>raft 主从节点之间通过日志复制实现数据的一致性，期间经历以下阶段：</p>
<ol>
<li><code>propose</code> leader将写入请求转成raft log 格式</li>
<li><code>append</code> 保存日志到 <em>leader</em> 本地</li>
<li><code>replicate</code> 收到集群内大多数节点日志复制成功的确认消息</li>
<li><code>commited</code> 收到集群内大多数节点日志复制成功并持久化到本地确认消息</li>
<li><code>apply</code> 成功完成日志的持久化写入</li>
</ol>
</li>
<li>
<p>成员变更（如添加副本、删除副本、转移 Leader 等操作）</p>
</li>
</ul>
<p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250807111853595.png" alt="image-20250807111853595"></p>
<p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250807112836082.png" alt="image-20250807112836082"></p>
<h5 id="mvcc">MVCC</h5>
<p><code>MVCC (Multi-Version Concurrency Control)</code>假设有这样一种场景：某客户端 A 在写一个 Key，另一个客户端 B 同时在对这个 Key 进行读操作。如果没有数据的多版本控制机制，那么这里的读写操作必然互斥。在分布式场景下，这种情况可能会导致性能问题和死锁问题。有了 MVCC，只要客户端 B 执行的读操作的逻辑时间早于客户端 A，那么客户端 B 就可以在客户端 A 写入的同时正确地读原有的值。即使该 Key 被多个写操作修改过多次，客户端 B 也可以按照其逻辑时间读到旧的值。</p>
<h5 id="transaction">Transaction</h5>
<ol>
<li>
<p><code>Transaction</code>提供了分布式事务能力</p>
<p>两阶段提交</p>
<p>第一阶段：<code>prewrite</code>  设置锁信息，并将锁在rocksdb的lock列族中（锁信息仅在事务的第一行所在的tikv实例的lock列族中添加锁，其他行所在tikv lock列族引用该锁的地址）。需要修改的信息放入到default 列族中（修改信息大于255byte 放入default 列族中，小于255bytes放入到write列族中）</p>
<p>第二阶段：<code>commit</code> 从pd中获取tso,在write列族中写入提交信息。并释放lock 列族中的锁信息</p>
</li>
</ol>
<h5 id="coprocessor">coprocessor</h5>
<ol>
<li>coprocessor算子下推(在每个tikv中执行例如 <code>where</code> 、<code>group by</code> 等操作，过滤后再发给tidb server)</li>
</ol>
<p><strong>tikv 数据读取流程</strong></p>
<p>用户从tidb-server 发起查询请求，此时从pd 分配一个tso给到该线程，并告知该线程用户需要读取的数据在哪个tikv节点</p>
<p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tikv-arch.png" alt=""></p>
<pre class="mermaid">   graph TB
   
       subgraph TiKV node
       A(Transation)
       B(MVCC)
       C(Raft)
           subgraph rocksdb
           D[(RocksDB raft)]
           E[(RocksDB kv)]
           end
       end</pre>
<h3 id="tidb-htap">tidb HTAP</h3>
<p>TiDB 是PingCAP 公司开源的分布式数据库，兼容mysql协议支持水平扩缩容能力，同时实现HTAP（OLTP online transactional processing 和 OLAP online analytical processing）。具备智能选择（CBO自动或人工选择）能力</p>
<p><strong>OLTP 特征：</strong></p>
<ul>
<li>支持试试更新的行存</li>
<li>高并发、一致性要求高</li>
<li>每次操作少量数据</li>
</ul>
<p><strong>OLAP 特征：</strong></p>
<ul>
<li>
<p>批量更新列存</p>
</li>
<li>
<p>并发数低</p>
</li>
<li>
<p>每次操作大量数据</p>
</li>
<li>
<p><strong>tiflash：</strong> 是TiDB HTAP(OLAP OLTP ) 形态的关键组件，它是 TiKV 的列存扩展。和普通 TiKV 节点不一样的是，在 TiFlash 内部作为<code>learner</code>角色加入到tikv 的<code>region</code> 通过<code>raft log</code> 异步复制leader数据,tiflash不参与tikv数据选举、投票，数据是以列式的形式进行存储，主要的功能是为分析型的场景加速。可以理解为<font color=red>tikv是行存储，tiflash 是列存储。</font></p>
<p>MPP架构：每个tiflash 作为worker节点首先过滤符合条件的数据，之后按照 <strong>等值连接</strong> 将具有符合条件的数据执行数据交换到同一台tiflash中执行聚合计算</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>tidb_allow_mpp      
</span></span><span style="display:flex;"><span>tidb_enforce_mpp
</span></span></code></pre></div><p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tidb-storage-architecture-1.png" alt=""></p>
</li>
</ul>
<h3 id="60新功能">6.0新功能</h3>
<ul>
<li>
<p>热点小表缓存（表的特征：1. 表的数据不大(小于64MB) 2. 只读表或者修改不频繁的表 3.表的访问特别频繁）用于将表缓存在tidb server 的<code>cache table</code> 中提升读性能。</p>
<p>开启热点小表缓存的表，无法做ddl 的修改</p>
<p>实现原理：通过租约的方式缓存表内容，在租约时间范围内该表只能读，写处于阻塞状态。租约到期后批量将写内容更新的tikv，并更新tidb server的<code>cache table</code>重新计算租约时间。 相关参数 <code>tidb_table_cache_lease=5</code></p>
<p>具体实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t1 <span style="color:#66d9ef">cache</span>;
</span></span></code></pre></div><p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250810204836420.png" alt="image-20250810204836420"></p>
</li>
<li>
<p><code>placement rules in sql </code> 使用sql的方式精细化调度表在tikv的分布、副本数</p>
<p>创建一个规则</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> PLACEMENT POLICY P1
</span></span><span style="display:flex;"><span>PRIMARY_REGION <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Beijing&#34;</span>   <span style="color:#75715e">--leader 角色的region位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>REGIONS <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Beijing, Tokyo, Shanghai, London&#34;</span>  <span style="color:#75715e">--follower角色的region位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>FOLLOWERS <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>; <span style="color:#75715e">--follower数量
</span></span></span></code></pre></div><p>创建表时引用该规则</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> T5 (id INT) PLACEMENT POLICY<span style="color:#f92672">=</span>P1;
</span></span></code></pre></div></li>
<li>
<p>内存悲观锁, 事务的锁信息放置在leader 所在tikv的缓存中不会将锁信息复制到follwer节点，减少了磁盘io。当leader所在节点的tivk宕机后锁信息会丢失此时事务执行回滚。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--在线开启内存悲观锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> config tikv pessimistic<span style="color:#f92672">-</span>txn.pipelined<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;true&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> config tikv pessimistic<span style="color:#f92672">-</span>txn.<span style="color:#66d9ef">in</span><span style="color:#f92672">-</span>memory<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;true&#39;</span>;
</span></span></code></pre></div></li>
<li>
<p>topsql 基于cpu的使用量查找对应的sql。</p>
<p>例如：单个tikv 实例负载较高，此时可以使用topsql 功能查找到对应sql</p>
</li>
<li>
<p>tidb enterprise manager (TiEM) 可视化管理工具</p>
<ol>
<li>部署集群</li>
<li>升级集群</li>
<li>参数管理</li>
<li>组件管理</li>
<li>备份恢复与高可用管理</li>
<li>集群监控与告警</li>
<li>集群日志收集</li>
<li>审计与安全</li>
</ol>
</li>
</ul>
<h3 id="tidb-cloud">tidb cloud</h3>
<p>是一个DBaas 服务</p>
<p><strong>1. 关于 TiKV 或 TiDB Server，下列说法不正确的是?</strong></p>
<ul>
<li><input disabled="" type="checkbox"> A. 数据被持久化在 TiKV 的 RocksDB 引擎中</li>
<li><input disabled="" type="checkbox"> B. 对于老版本数据的回收（GC），是由 TiDB Server 在 TiKV 上完成的</li>
<li><input checked="" disabled="" type="checkbox"> C. 两阶段提交的锁信息被持久化到 TiDB Server 中</li>
<li><input disabled="" type="checkbox"> D. Region 可以在多个 TiKV 节点上进行调度，但是需要 PD 节点发出调度指令</li>
</ul>
<p>解题：tidb server 不存储数据</p>
<p><strong>2.关于关系型数据与KV的转化，下列说法不正确的是？</strong></p>
<ul>
<li><input disabled="" type="checkbox"> A. 如果没有定义主键，key中包含RowID，IndexID和TableID，都是int64类型</li>
<li><input disabled="" type="checkbox"> B. Table ID在整个集群内唯一</li>
<li><input checked="" disabled="" type="checkbox"> C. 如果定义了主键，那么将使用主键作为RowID</li>
<li><input disabled="" type="checkbox"> D. 不需要为每张表指定主键</li>
</ul>
<p><strong>3.关于关系型数据与 KV 的转化，下列说法</strong>不正确<strong>的是？</strong></p>
<ul>
<li><input disabled="" type="checkbox"> A. 如果没有定义主键，key 中包含 RowID、IndexID 和 TableID，都是 int64 类型</li>
<li><input disabled="" type="checkbox"> B. Table ID 在整个集群内唯一</li>
<li><input checked="" disabled="" type="checkbox"> C. 如果定义了主键，那么将使用主键作为 RowID</li>
<li><input disabled="" type="checkbox"> D. 不需要为每张表指定主键</li>
</ul>
<p><strong>解释：</strong> C 如果定义了主键，并主键为整数型的，TiDB 会使用主键的值当做这一行数据的RowID。</p>
<ul>
<li>
<p>6.0版本region 默认96MB,当达到144MB 是自动分裂</p>
</li>
<li>
<p>所有tidb server都可以接受ddl任务，并将ddl任务放在tikv 队列中。同一时刻只有一个tidb server的worker 模块是ower角色，该worker拥有执行ddl 任务的权利</p>
</li>
<li>
<p>tidb server 的gc 间隔默认10m一次</p>
</li>
</ul>
<p><a href="https://learn.pingcap.cn/learner/course" target="_blank">课程中心</a></p>
<p><a href="https://docs.pingcap.com/zh/tidb/stable/tidb-architecture/" target="_blank">TiDB 整体架构 | TiDB 文档中心</a></p>
<p><a href="https://docs.pingcap.com/zh/tidb/stable/tikv-overview/" target="_blank">TiKV 简介 | TiDB 文档中心</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span>  tidb_enable_top_sql<span style="color:#f92672">=</span><span style="color:#66d9ef">ON</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%top%&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">------------------------------------+------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Variable_name                      <span style="color:#f92672">|</span> Value      <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">------------------------------------+------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> ft_stopword_file                   <span style="color:#f92672">|</span> (built<span style="color:#f92672">-</span><span style="color:#66d9ef">in</span>) <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> innodb_ft_enable_stopword          <span style="color:#f92672">|</span> <span style="color:#66d9ef">ON</span>         <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> innodb_ft_server_stopword_table    <span style="color:#f92672">|</span>            <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> innodb_ft_user_stopword_table      <span style="color:#f92672">|</span>            <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> rpl_stop_slave_timeout             <span style="color:#f92672">|</span> <span style="color:#ae81ff">31536000</span>   <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> tidb_enable_top_sql                <span style="color:#f92672">|</span> <span style="color:#66d9ef">ON</span>         <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> tidb_top_sql_max_meta_count        <span style="color:#f92672">|</span> <span style="color:#ae81ff">5000</span>       <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> tidb_top_sql_max_time_series_count <span style="color:#f92672">|</span> <span style="color:#ae81ff">100</span>        <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">------------------------------------+------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">8</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
</span></span></code></pre></div><h3 id="sql-中的锁和事务">sql 中的锁和事务</h3>
<p>SQL-92 标准定义了 4 种隔离级别：读未提交 ()、读已提交 ()、可重复读 ()、串行化 ()。 详见下表：<code>READ UNCOMMITTED</code>、<code>READ COMMITTED</code>、<code>REPEATABLE READ</code>、<code>SERIALIZABLE</code></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">隔离级别</th>
          <th style="text-align: left">脏写</th>
          <th style="text-align: left">脏读</th>
          <th style="text-align: left">模糊读取</th>
          <th style="text-align: left">幻读</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">READ UNCOMMITTED</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">可能</td>
          <td style="text-align: left">可能</td>
          <td style="text-align: left">可能</td>
      </tr>
      <tr>
          <td style="text-align: left">READ COMMITTED</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">可能</td>
          <td style="text-align: left">可能</td>
      </tr>
      <tr>
          <td style="text-align: left">REPEATABLE READ</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">可能</td>
      </tr>
      <tr>
          <td style="text-align: left">SERIALIZABLE</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">不可能</td>
      </tr>
  </tbody>
</table>
<p>TiDB 语法上支持设置 和 两种隔离级别：<code>READ COMMITTED``REPEATABLE READ</code></p>
<p>缓存表的功能</p>
<p>rocksdb 性能与cpu数量的关系</p>
<p>导入数据后的一致性校验可以借助Coprocessor 由TiKV来完成</p>
<p>tidb server 各个组件的功能</p>
<p>GC life time是无法手工调整的</p>
<p>SQL语句的解析和编译可以与TSO的获取异步执行</p>
<p>sql 解析和编译流程，物理编译和逻辑编译</p>
<p>tidb cloud 的功能</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-6cd2fa811bb545211e56673b02260128">环境检查</h1>
	<div class="lead">prerun| tidb</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-17" class="text-body-secondary">Saturday, May 17, 2025</time>
        
	</div>
	<h3 id="版本选择">版本选择</h3>
<p>企业版和社区版的区别</p>
<h3 id="安装前环境检查">安装前环境检查</h3>
<p><strong>操作系统</strong>
支持部署在x86_64、arm_64、容器环境的 Linux 操作系统。</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    <ul>
<li>
<p>TiDB 在 v8.4.0 DMR 和 v8.5.0 版本中移除了对 glibc 2.17 的适配，以及对 CentOS Linux 7 的兼容性测试和支持，建议使用 Rocky Linux 9.1 及以上的版本。</p>
<p>如果在使用 CentOS Linux 7 的情况下将 TiDB 升级到 v8.4.0 DMR 或 v8.5.0 版本，将存在导致集群不可用的风险。</p>
</li>
<li>
<p>为了更好地服务仍在使用 CentOS Linux 7 的用户，TiDB 从 v8.5.1 版本起重新适配 glibc 2.17，恢复了对 CentOS Linux 7 的兼容性支持和测试。</p>
</li>
</ul>


</div>


  
  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>软件要求</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="中控机" aria-controls="tabs-01-01" aria-selected="true">
        中控机
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="目标主机" aria-controls="tabs-01-02" aria-selected="false">
        目标主机
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <table>
  <thead>
      <tr>
          <th style="text-align: left">软件</th>
          <th style="text-align: left">版本</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">sshpass</td>
          <td style="text-align: left">1.06 及以上</td>
      </tr>
      <tr>
          <td style="text-align: left">TiUP</td>
          <td style="text-align: left">1.5.0 及以上</td>
      </tr>
  </tbody>
</table>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <table>
  <thead>
      <tr>
          <th style="text-align: left">软件</th>
          <th style="text-align: left">版本</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">sshpass</td>
          <td style="text-align: left">1.06 及以上</td>
      </tr>
      <tr>
          <td style="text-align: left">numa</td>
          <td style="text-align: left">2.0.12 及以上</td>
      </tr>
      <tr>
          <td style="text-align: left">tar</td>
          <td style="text-align: left">任意</td>
      </tr>
  </tbody>
</table>

    </div>
</div>



<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    <ul>
<li>生产环境中的 TiDB 和 PD 可以部署和运行在同一台服务器上，如对性能和可靠性有更高的要求，应尽可能分开部署。</li>
<li>强烈建议分别为生产环境中的 TiDB、TiKV 和 TiFlash 配置至少 8 核的 CPU。强烈推荐使用更高的配置，以获得更好的性能。</li>
<li>TiKV 硬盘大小配置建议 PCIe SSD 不超过 4 TB，普通 SSD 不超过 1.5 TB。</li>
</ul>


</div>


  
  
  
<ul class="nav nav-tabs" id="tabs-3" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-03-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-00" role="tab"
          aria-controls="tabs-03-00" aria-selected="false">
        <strong>硬件要求</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-03-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-01" role="tab"
          data-td-tp-persist="开发及测试环境" aria-controls="tabs-03-01" aria-selected="true">
        开发及测试环境
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-03-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-02" role="tab"
          data-td-tp-persist="生产环境" aria-controls="tabs-03-02" aria-selected="false">
        生产环境
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-3-content">
    <div class="tab-body tab-pane fade"
        id="tabs-03-00" role="tabpanel" aria-labelled-by="tabs-03-00-tab" tabindex="3">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-03-01" role="tabpanel" aria-labelled-by="tabs-03-01-tab" tabindex="3">
        <table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>组件</strong></th>
          <th style="text-align: left"><strong>CPU</strong></th>
          <th style="text-align: left"><strong>内存</strong></th>
          <th style="text-align: left"><strong>本地存储</strong></th>
          <th style="text-align: left"><strong>网络</strong></th>
          <th style="text-align: left"><strong>实例数量(最低要求)</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">TiDB</td>
          <td style="text-align: left">8 核+</td>
          <td style="text-align: left">16 GB+</td>
          <td style="text-align: left"><a href="https://docs.pingcap.com/zh/tidb/stable/hardware-and-software-requirements/#%e7%a3%81%e7%9b%98%e7%a9%ba%e9%97%b4%e8%a6%81%e6%b1%82" target="_blank">磁盘空间要求</a></td>
          <td style="text-align: left">千兆网卡</td>
          <td style="text-align: left">1（可与 PD 同机器）</td>
      </tr>
      <tr>
          <td style="text-align: left">PD</td>
          <td style="text-align: left">4 核+</td>
          <td style="text-align: left">8 GB+</td>
          <td style="text-align: left">SAS, 200 GB+</td>
          <td style="text-align: left">千兆网卡</td>
          <td style="text-align: left">1（可与 TiDB 同机器）</td>
      </tr>
      <tr>
          <td style="text-align: left">TiKV</td>
          <td style="text-align: left">8 核+</td>
          <td style="text-align: left">32 GB+</td>
          <td style="text-align: left">SSD, 200 GB+</td>
          <td style="text-align: left">千兆网卡</td>
          <td style="text-align: left">3</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">32 核+</td>
          <td style="text-align: left">64 GB+</td>
          <td style="text-align: left">SSD, 200 GB+</td>
          <td style="text-align: left">千兆网卡</td>
          <td style="text-align: left">1</td>
      </tr>
      <tr>
          <td style="text-align: left">TiCDC</td>
          <td style="text-align: left">8 核+</td>
          <td style="text-align: left">16 GB+</td>
          <td style="text-align: left">SAS, 200 GB+</td>
          <td style="text-align: left">千兆网卡</td>
          <td style="text-align: left">1</td>
      </tr>
  </tbody>
</table>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-03-02" role="tabpanel" aria-labelled-by="tabs-03-02-tab" tabindex="3">
        <table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>组件</strong></th>
          <th style="text-align: left"><strong>CPU</strong></th>
          <th style="text-align: left"><strong>内存</strong></th>
          <th style="text-align: left"><strong>硬盘类型</strong></th>
          <th style="text-align: left"><strong>网络</strong></th>
          <th style="text-align: left"><strong>实例数量(最低要求)</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">TiDB</td>
          <td style="text-align: left">16 核+</td>
          <td style="text-align: left">48 GB+</td>
          <td style="text-align: left">SSD</td>
          <td style="text-align: left">万兆网卡（2 块最佳）</td>
          <td style="text-align: left">2</td>
      </tr>
      <tr>
          <td style="text-align: left">PD</td>
          <td style="text-align: left">8 核+</td>
          <td style="text-align: left">16 GB+</td>
          <td style="text-align: left">SSD</td>
          <td style="text-align: left">万兆网卡（2 块最佳）</td>
          <td style="text-align: left">3</td>
      </tr>
      <tr>
          <td style="text-align: left">TiKV</td>
          <td style="text-align: left">16 核+</td>
          <td style="text-align: left">64 GB+</td>
          <td style="text-align: left">SSD</td>
          <td style="text-align: left">万兆网卡（2 块最佳）</td>
          <td style="text-align: left">3</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">48 核+</td>
          <td style="text-align: left">128 GB+</td>
          <td style="text-align: left">1 or more SSDs</td>
          <td style="text-align: left">万兆网卡（2 块最佳）</td>
          <td style="text-align: left">2</td>
      </tr>
      <tr>
          <td style="text-align: left">TiCDC</td>
          <td style="text-align: left">16 核+</td>
          <td style="text-align: left">64 GB+</td>
          <td style="text-align: left">SSD</td>
          <td style="text-align: left">万兆网卡（2 块最佳）</td>
          <td style="text-align: left">2</td>
      </tr>
      <tr>
          <td style="text-align: left">监控</td>
          <td style="text-align: left">8 核+</td>
          <td style="text-align: left">16 GB+</td>
          <td style="text-align: left">SAS</td>
          <td style="text-align: left">千兆网卡</td>
          <td style="text-align: left">1</td>
      </tr>
  </tbody>
</table>

    </div>
</div>

<p><strong>网络要求</strong></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">组件</th>
          <th style="text-align: left">默认端口</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">TiDB</td>
          <td style="text-align: left">4000</td>
          <td style="text-align: left">应用及 DBA 工具访问通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiDB</td>
          <td style="text-align: left">10080</td>
          <td style="text-align: left">TiDB 状态信息上报通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiKV</td>
          <td style="text-align: left">20160</td>
          <td style="text-align: left">TiKV 通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiKV</td>
          <td style="text-align: left">20180</td>
          <td style="text-align: left">TiKV 状态信息上报通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">PD</td>
          <td style="text-align: left">2379</td>
          <td style="text-align: left">提供 TiDB 和 PD 通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">PD</td>
          <td style="text-align: left">2380</td>
          <td style="text-align: left">PD 集群节点间通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">9000</td>
          <td style="text-align: left">TiFlash TCP 服务端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">3930</td>
          <td style="text-align: left">TiFlash RAFT 服务和 Coprocessor 服务端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">20170</td>
          <td style="text-align: left">TiFlash Proxy 服务端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">20292</td>
          <td style="text-align: left">Prometheus 拉取 TiFlash Proxy metrics 端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">8234</td>
          <td style="text-align: left">Prometheus 拉取 TiFlash metrics 端口</td>
      </tr>
      <tr>
          <td style="text-align: left">CDC</td>
          <td style="text-align: left">8300</td>
          <td style="text-align: left">CDC 通信接口</td>
      </tr>
      <tr>
          <td style="text-align: left">Monitoring</td>
          <td style="text-align: left">9090</td>
          <td style="text-align: left">Prometheus 服务通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">Monitoring</td>
          <td style="text-align: left">12020</td>
          <td style="text-align: left">NgMonitoring 服务通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">Node_exporter</td>
          <td style="text-align: left">9100</td>
          <td style="text-align: left">TiDB 集群每个节点的系统信息上报通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">Blackbox_exporter</td>
          <td style="text-align: left">9115</td>
          <td style="text-align: left">Blackbox_exporter 通信端口，用于 TiDB 集群端口监控</td>
      </tr>
      <tr>
          <td style="text-align: left">Grafana</td>
          <td style="text-align: left">3000</td>
          <td style="text-align: left">Web 监控服务对外服务和客户端(浏览器)访问端口</td>
      </tr>
      <tr>
          <td style="text-align: left">Alertmanager</td>
          <td style="text-align: left">9093</td>
          <td style="text-align: left">告警 web 服务端口</td>
      </tr>
      <tr>
          <td style="text-align: left">Alertmanager</td>
          <td style="text-align: left">9094</td>
          <td style="text-align: left">告警通信端口</td>
      </tr>
  </tbody>
</table>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c968788ec97c1b8ea0974bc58c38f16b">集群安装</h1>
	<div class="lead">install|tidb</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	<p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tidb-architecture-v6.png" alt=""></p>

  
  

  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>环境准备</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="主机环境" aria-controls="tabs-00-01" aria-selected="true">
        主机环境
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="系统环境" aria-controls="tabs-00-02" aria-selected="false">
        系统环境
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <table>
  <thead>
      <tr>
          <th>os</th>
          <th>主机名</th>
          <th>ip</th>
          <th>cpu</th>
          <th>内存</th>
          <th>磁盘</th>
          <th>网卡</th>
          <th>集群</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>centos7.6</td>
          <td>tidb-dev01-s2</td>
          <td>192.168.0.223</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td>中控机</td>
      </tr>
      <tr>
          <td>centos7.6</td>
          <td>tidb-cmb01-s3</td>
          <td>192.168.0.105</td>
          <td>8</td>
          <td>8</td>
          <td>200G</td>
          <td>千兆</td>
          <td>cluster01</td>
      </tr>
      <tr>
          <td>centos7.6</td>
          <td>tidb-cmb02-s3</td>
          <td>192.168.0.106</td>
          <td>8</td>
          <td>8</td>
          <td>200G</td>
          <td>千兆</td>
          <td>cluster01</td>
      </tr>
      <tr>
          <td>centos7.6</td>
          <td>tidb-cmb03-s3</td>
          <td>192.168.0.107</td>
          <td>8</td>
          <td>8</td>
          <td>200G</td>
          <td>千兆</td>
          <td>cluster01</td>
      </tr>
      <tr>
          <td>centos7.6</td>
          <td>tidb-cmb04-s3</td>
          <td>192.168.0.108</td>
          <td>8</td>
          <td>8</td>
          <td>200G</td>
          <td>千兆</td>
          <td>cluster02</td>
      </tr>
      <tr>
          <td>centos7.6</td>
          <td>tidb-cmb05-s3</td>
          <td>192.168.0.140</td>
          <td>8</td>
          <td>8</td>
          <td>200G</td>
          <td>千兆</td>
          <td>cluster02</td>
      </tr>
      <tr>
          <td>centos7.6</td>
          <td>tidb-cmb06-s3</td>
          <td>192.168.0.162</td>
          <td>8</td>
          <td>8</td>
          <td>200G</td>
          <td>千兆</td>
          <td>cluster02</td>
      </tr>
  </tbody>
</table>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <ul>
<li>
<p>必备软件</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">软件</th>
          <th style="text-align: left">版本</th>
          <th>目标主机</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">sshpass</td>
          <td style="text-align: left">1.06 及以上</td>
          <td>中控机 &amp; 集群主机</td>
      </tr>
      <tr>
          <td style="text-align: left">numactl</td>
          <td style="text-align: left">2.0.12 及以上</td>
          <td>集群主机</td>
      </tr>
      <tr>
          <td style="text-align: left">tar</td>
          <td style="text-align: left">任意</td>
          <td>集群主机</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>时间同步</p>
</li>
<li>
<p>关闭swap</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;vm.swappiness = 0&#34;</span>&gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span>sysctl -p
</span></span><span style="display:flex;"><span>swapoff -a <span style="color:#f92672">&amp;&amp;</span> swapon -a
</span></span></code></pre></div></li>
<li>
<p>关闭防火墙</p>
</li>
<li>
<p>关闭selinux</p>
</li>
<li>
<p>关闭透明大页</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@tidb-cmb01-s3 ~<span style="color:#f92672">]</span><span style="color:#75715e"># echo never &gt;/sys/kernel/mm/transparent_hugepage/enabled</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@tidb-cmb01-s3 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat /sys/kernel/mm/transparent_hugepage/enabled</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># always madvise [never]</span>
</span></span></code></pre></div></li>
<li>
<p>关闭数据目录所在磁盘的i/o调度器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@tidb-cmb01-s3 ~<span style="color:#f92672">]</span><span style="color:#75715e"># echo noop &gt;/sys/block/sd[bc]/queue/scheduler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@tidb-cmb01-s3 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat /sys/block/sd[bc]/queue/scheduler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>noop<span style="color:#f92672">]</span> deadline cfq 
</span></span></code></pre></div></li>
<li>
<p>挂载磁盘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> mkfs.ext4 /dev/mapper/data-tidb 
</span></span><span style="display:flex;"><span> mount -o noatime -o nodelalloc -t ext4 /dev/mapper/data-tidb /data/
</span></span><span style="display:flex;"><span> mkdir -p /data/cluster01
</span></span><span style="display:flex;"><span> chown -R tidb:tidb /data/cluster01
</span></span></code></pre></div></li>
</ul>

    </div>
</div>

<p><strong>安装tiup工具</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl --proto <span style="color:#e6db74">&#39;=https&#39;</span> --tlsv1.2 -sSf https://tiup-mirrors.pingcap.com/install.sh | sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>source /root/.bash_profile
</span></span></code></pre></div><p><strong>下载离线镜像</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>version<span style="color:#f92672">=</span>v5.2.4
</span></span><span style="display:flex;"><span><span style="color:#75715e">#version=v6.5.12</span>
</span></span><span style="display:flex;"><span>wget https://download.pingcap.org/tidb-community-server-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar xf tidb-community-server-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-amd64.tar.gz
</span></span></code></pre></div><p><strong>设置本地镜像仓库</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tiup mirror set tidb-community-server-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-amd64
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 验证设置是否成功</span>
</span></span><span style="display:flex;"><span>tiup mirror show
</span></span></code></pre></div><p><strong>配置部署文件</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 通过该命令获取基础配置文件 </span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">tiup cluster template &gt; /tmp/topology.yaml</span>
</span></span></code></pre></div><p>检查配置文件语法和集群依赖</p>
<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">user</span>: <span style="color:#e6db74">&#34;root&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ssh_port</span>: <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">arch</span>: <span style="color:#e6db74">&#34;amd64&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">monitored</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">node_exporter_port</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">blackbox_exporter_port</span>: <span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">server_configs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pd</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replication.location-labels</span>: [<span style="color:#e6db74">&#34;host&#34;</span>, <span style="color:#e6db74">&#34;disk&#34;</span>]
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">pd_servers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">client_port</span>: <span style="color:#ae81ff">2379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">peer_port</span>: <span style="color:#ae81ff">2380</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/pd-2379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data/pd-2379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/pd-2379/log&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">client_port</span>: <span style="color:#ae81ff">3379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">peer_port</span>: <span style="color:#ae81ff">3380</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/pd-3379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data/pd-3379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/pd-3379/log&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">client_port</span>: <span style="color:#ae81ff">4379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">peer_port</span>: <span style="color:#ae81ff">4380</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/pd-4379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data/pd-4379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/pd-4379/log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">tidb_servers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">4000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">status_port</span>: <span style="color:#ae81ff">10080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tidb-4000&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tidb-4000/log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">tikv_servers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">20160</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">status_port</span>: <span style="color:#ae81ff">20180</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tikv-20160&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data/tikv-20160&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tikv-20160/log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server.labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">tikv1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">disk</span>: <span style="color:#ae81ff">disk1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">20161</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">status_port</span>: <span style="color:#ae81ff">20181</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tikv-20161&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data/tikv-20161&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tikv-20161/log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server.labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">tikv2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">disk</span>: <span style="color:#ae81ff">disk2</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">20162</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">status_port</span>: <span style="color:#ae81ff">20182</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tikv-20162&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data/tikv-20162&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tikv-20162/log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server.labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">tikv3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">disk</span>: <span style="color:#ae81ff">disk3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">monitoring_servers</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.114</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9090</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ng_port</span>: <span style="color:#ae81ff">12020</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">deploy_dir</span>: <span style="color:#ae81ff">/tidb-deploy/prometheus-9090</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">data_dir</span>: <span style="color:#ae81ff">/tidb-data/prometheus-9090</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">log_dir</span>: <span style="color:#ae81ff">/tidb-deploy/prometheus-9090/log</span>
</span></span></code></pre></div></details>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tiup cluster check /tmp/topology.yaml --user root -p
</span></span><span style="display:flex;"><span>tiup cluster check /tmp/topology.yaml --apply --user root -p
</span></span></code></pre></div><p><strong>部署集群</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tiup cluster deploy cluster01 v5.2.4 /tmp/topology.yaml --user root -p
</span></span></code></pre></div><p><strong>启动集群</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>tidb@tidb-dev01-s2 ~<span style="color:#f92672">]</span>$ tiup cluster start cluster01 --init
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Started cluster <span style="color:#e6db74">`</span>cluster01<span style="color:#e6db74">`</span> successfully
</span></span><span style="display:flex;"><span>The root password of TiDB database has been changed.
</span></span><span style="display:flex;"><span>The new password is: <span style="color:#e6db74">&#39;jS7y!61*gz8MUZ50_%&#39;</span>.
</span></span><span style="display:flex;"><span>Copy and record it to somewhere safe, it is only displayed once, and will not be stored.
</span></span><span style="display:flex;"><span>The generated password can NOT be get and shown again.
</span></span></code></pre></div><p><strong>查看tiup管理的集群</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tiup cluster list 
</span></span><span style="display:flex;"><span>tiup cluster display cluster01
</span></span></code></pre></div><p><strong>验证功能</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -P <span style="color:#ae81ff">4000</span> -uroot -p<span style="color:#e6db74">&#39;jS7y!61*gz8MUZ50_%&#39;</span> -h 127.0.0.1
</span></span></code></pre></div><p><strong>dashboar:</strong> <code>http://192.168.0.115:3379/dashboard</code></p>
<p>默认用户： <code>root</code></p>
<p>默认密码： <code>jS7y!61*gz8MUZ50_%</code></p>
<p><strong>销毁集群</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tiup cluster stop cluster01
</span></span><span style="display:flex;"><span>tiup cluster destroy cluster01
</span></span></code></pre></div><h3 id="数据备份">数据备份</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tiup install br:v6.5.12
</span></span></code></pre></div><h3 id="数据迁移">数据迁移</h3>
<p><a href="https://docs.pingcap.com/zh/tidb/stable/migration-overview/" target="_blank">数据迁移概述 | TiDB 文档中心</a></p>
<h3 id="数据同步">数据同步</h3>
<p><a href="https://docs.pingcap.com/zh/tidb/stable/ticdc-overview/" target="_blank">数据同步概述 | TiDB 文档中心</a></p>
<h3 id="tidb工具链">tidb工具链</h3>
<p><a href="https://docs.pingcap.com/zh/tidb/stable/ecosystem-tool-user-guide/" target="_blank">TiDB 工具功能概览 | TiDB 文档中心</a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-187ec7198335d617c91d9604a38255b3">tiup工具</h1>
	<div class="lead">tiup|tidb</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	<p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tidb-architecture-v6.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查看集群列表</span>
</span></span><span style="display:flex;"><span>tiup cluster list
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看集群每个组件的运行状态</span>
</span></span><span style="display:flex;"><span>tiup cluster display &lt;cluster-name&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动集群</span>
</span></span><span style="display:flex;"><span>tiup cluster start &lt;cluster-name&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -R 启动指定组件</span>
</span></span><span style="display:flex;"><span>tiup cluster start &lt;cluster-name&gt; -R pd
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -N 启动指定进程</span>
</span></span><span style="display:flex;"><span>tiup cluster start <span style="color:#e6db74">${</span>cluster-name<span style="color:#e6db74">}</span> -N 1.2.3.4:2379,1.2.3.5:2379
</span></span><span style="display:flex;"><span><span style="color:#75715e"># show-config 查看当前配置</span>
</span></span><span style="display:flex;"><span>tiup cluster show-config cluster01
</span></span><span style="display:flex;"><span><span style="color:#75715e"># edit-config 在线编辑配置</span>
</span></span><span style="display:flex;"><span>tiup cluster edit-config cluster01
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看tiup仓库</span>
</span></span><span style="display:flex;"><span>tiup mirror  show
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 默认读取变量 ${TIUP_MIRRORS} 的值</span>
</span></span><span style="display:flex;"><span>tiup mirror set 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>tiup mirror merge
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看仓库中可用的包 , 查看已安装包 tiup list --installed</span>
</span></span><span style="display:flex;"><span>tiup list
</span></span></code></pre></div><p><a href="https://docs.pingcap.com/zh/tidb/stable/maintain-tidb-using-tiup/" target="_blank">https://docs.pingcap.com/zh/tidb/stable/maintain-tidb-using-tiup/</a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-b6a1b6b4042adf75eca6f429ffbb92d1">checkssh</h1>
	<div class="lead">checkssh|tidb</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-19" class="text-body-secondary">Thursday, June 19, 2025</time>
        
	</div>
	<p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tidb-architecture-v6.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e"># description: 在中控机tidb用户下，检查集群节点ssh秘钥认证</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PasswordAuthentication=no  禁用密码认证</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># StrictHostKeyChecking=no 禁用know_hosts 检查</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>declare -A info
</span></span><span style="display:flex;"><span>clusterName<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>tiup cluster list |awk <span style="color:#e6db74">&#39;NR&gt;2{print $1}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> cls in $clusterName;<span style="color:#66d9ef">do</span>  
</span></span><span style="display:flex;"><span>  iplist<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>tiup cluster display $cls|awk -F <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#e6db74">&#39;/^[0-9].*/{print $1}&#39;</span>|sort |uniq<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>  info<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;</span>$cls<span style="color:#e6db74">&#34;</span><span style="color:#f92672">]=</span>$iplist
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> cls in <span style="color:#e6db74">${</span>!info[@]<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> host in <span style="color:#e6db74">${</span>info[$cls]<span style="color:#e6db74">}</span>;<span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    rsa<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/tidbdata/tiupshare/tiuptool/storage/cluster/clusters/</span><span style="color:#e6db74">${</span>cls<span style="color:#e6db74">}</span><span style="color:#e6db74">/ssh/id_rsa&#34;</span>
</span></span><span style="display:flex;"><span>    ssh -o PasswordAuthentication<span style="color:#f92672">=</span>no -o StrictHostKeyChecking<span style="color:#f92672">=</span>no -T -i <span style="color:#e6db74">${</span>rsa<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>host<span style="color:#e6db74">}</span> exit 2&gt;/dev/null
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>       printf <span style="color:#e6db74">&#34;集群：%s,主机:%s  [OK]\n&#34;</span> $cls $host
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>       printf <span style="color:#e6db74">&#34;集群：%s,主机:%s  [Failed]\n&#34;</span> $cls $host
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">done</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>输出结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>集群：cluster01,主机:192.168.0.105  <span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>集群：cluster01,主机:192.168.0.106  <span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>集群：cluster01,主机:192.168.0.107  <span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>集群：tidb_dev_001,主机:192.168.0.223  <span style="color:#f92672">[</span>Failed<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>集群：tidb_dev_001,主机:192.168.0.224  <span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>集群：tidb_dev_001,主机:192.168.0.225  <span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>
</span></span></code></pre></div>
</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b7925a763a64b7d08f88e8b0539bd62d">6 - </h1>
    
	<ul>
<li><input disabled="" type="checkbox"> <a href="https://elkguide.elasticsearch.cn/" target="_blank">前言 · ELKstack 中文指南</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1ZL411k7HK/?spm_id_from=333.337.search-card.all.click&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76" target="_blank">老男孩教育倾向于运维</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1hh411D7sb/?spm_id_from=333.337.search-card.all.click&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76" target="_blank">尚硅谷讲解通过restful操作elasticsearch</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1iJ411c7Az/?spm_id_from=333.788.player.switch&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76&amp;p=7" target="_blank">07.Elasticsearch快速入门之基本概念_哔哩哔哩_bilibili</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1Zz4y1R7tq/?spm_id_from=333.337.search-card.all.click&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76" target="_blank">千锋教育ElasticSearch教程（深入讲解,一套掌握）_哔哩哔哩_bilibili</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1rG411x71e/?spm_id_from=333.337.search-card.all.click&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76" target="_blank">ElasticSearch面试50问保姆级教程入门到精通（基于ELK技术栈elasticsearch 7.17.3最新教程通俗易懂）_哔哩哔哩_bilibili</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1pY411F7QW/?spm_id_from=333.337.search-card.all.click&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76" target="_blank">马士兵教育ELK保姆级教程，从入门到精通！ElasticSearch+Logstash+Kibana精讲_哔哩哔哩_bilibili</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1Cd4y1773M/?spm_id_from=333.337.search-card.all.click&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76" target="_blank">【全网最细】耗时72小时整理的ElasticSearch教程入门到精通，让你少走99%的弯路！！_哔哩哔哩_bilibili</a></li>
</ul>
<ul>
<li>各组件兼容性： <a href="https://www.elastic.co/cn/support/matrix#matrix_compatibility" target="_blank">https://www.elastic.co/cn/support/matrix#matrix_compatibility</a></li>
<li>操作系统兼容性：https://www.elastic.co/cn/support/matrix</li>
</ul>
<p>龙腾出行公司elasticsearch版本： 7.17.3</p>
<p>日志量每天1.5TB</p>
<h3 id="面试题">面试题</h3>
<ol>
<li>使用的什么版本</li>
<li>日志量</li>
<li>遇到过哪些坑</li>
<li>elasticsearch 集群选主、数据复制原理</li>
</ol>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-3ae4dfccf1d4f425261aade622c853db">单机版本安装</h1>
	<div class="lead">使用elasticsearch</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-27" class="text-body-secondary">Saturday, September 27, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>elasticsearch版本： <code>7.15.0</code>、<code>7.17.27</code></p>
<hr>
<p>【注意事项】| <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/index.html" target="_blank">doc</a></p>
<ul>
<li>
<p>elasticsearch 依赖jdk 环境，<a href="https://www.elastic.co/cn/support/matrix#matrix_jvm" target="_blank">如果无法判断使用哪个版本jdk</a>。可以<a href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch" target="_blank">下载</a>/<a href="https://repo.huaweicloud.com" target="_blank">国内下载镜像</a>带有jdk版本的elasticsearch。</p>
</li>
<li>
<p>elasticsearch默认监听9200（提供restfull风格的服务） 和 9300 （集群内部选举和数据同步）</p>
</li>
<li>
<p>elasticsearch 属于io密集型应用，尽可能把数据目录单独挂载出来。并使用高性能磁盘。</p>
</li>
</ul>


</div>

<h3 id="部署环境准备">部署环境准备</h3>
<p><strong>内存映射</strong></p>
<blockquote>
<p>内存映射（Memory Mapping）是一种在应用程序地址空间和物理存储器之间建立映射关系的技术</p>
<p><code>max_map_count</code> 参数是用于限制每个进程能够使用的最大内存映射区域数量。</p>
<p>如果不修改，启动时提示错误： <em>max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</em></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sysctl -w vm.max_map_count<span style="color:#f92672">=</span><span style="color:#ae81ff">655360</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;vm.max_map_count=655360&#39;</span> &gt;&gt;/etc/sysctl.conf
</span></span></code></pre></div><p><strong>内存锁定</strong></p>
<blockquote>
<p><font color=red>当开启内存锁定后，以下参数必须设定</font>报错信息： <code>memory locking requested for elasticsearch process but memory is not locked</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;DefaultLimitMEMLOCK=infinity&#34;</span> &gt;&gt;/etc/systemd/system.conf
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 该命令会重启systemd 进程</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reexec
</span></span></code></pre></div><p><strong>文件描述符设置</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;&gt;/etc/security/limits.conf<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nofile 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nofile 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nproc 32000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nproc 32000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard memlock unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt;&gt; /etc/systemd/system.conf<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DefaultLimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DefaultLimitNPROC=32000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DefaultLimitMEMLOCK=infinity
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h3 id="安装部署">安装部署</h3>
<ol>
<li>
<p>创建服务账号</p>
<blockquote>
<p><font color=red>elasticsearch 无法以root用户启动</font></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>useradd  elasticsearch
</span></span></code></pre></div></li>
<li>
<p>安装elasticsearch</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>version<span style="color:#f92672">=</span>7.17.29
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>tar -xzf elasticsearch-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-x86_64.tar.gz -C /data/elk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># $ES_HOME 对应/data/elk/elasticsearch</span>
</span></span><span style="display:flex;"><span>ln -svf /data/elk/<span style="color:#f92672">{</span>elasticsearch-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>,elasticsearch<span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>创建日志和数据目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /data/elk/instance1/<span style="color:#f92672">{</span>data,log,config<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>chown -R elasticsearch:elasticsearch /data/elk/<span style="color:#f92672">{</span>elasticsearch-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>,elasticsearch<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>chown -R elasticsearch:elasticsearch /data/elk/instance1
</span></span></code></pre></div></li>
<li>
<p>启动elasticsearch</p>
<blockquote>
<p><em>本示例实现单机多实例的部署，因此需要实现在配置文件、日志文件、数据文件上隔离。Elasticsearch 有三个配置文件：</em></p>
<ul>
<li><em><code>elasticsearch.yml</code>用于配置 Elasticsearch</em></li>
<li><em><code>jvm.options</code>用于配置 Elasticsearch JVM 设置</em></li>
<li><em><code>log4j2.properties</code>用于配置 Elasticsearch 日志记录</em></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grep -vE <span style="color:#e6db74">&#34;^#|^</span>$<span style="color:#e6db74">&#34;</span> /data/elk/elasticsearch/config/jvm.options &gt;/data/elk/instance1/config/jvm.options
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>grep -vE <span style="color:#e6db74">&#34;^#|^</span>$<span style="color:#e6db74">&#34;</span> /data/elk/elasticsearch/config/log4j2.properties &gt;/data/elk/instance1/config/log4j2.properties
</span></span></code></pre></div></blockquote>
<p>主配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/elk/instance1/config/elasticsearch.yml <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">path:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: /data/elk/instance1/data  # 等同path.data: /data/elk/instance1/data，其他依次类推
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  logs: /data/elk/instance1/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: node-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cluster:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: cluster-alerts
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  initial_master_nodes: [&#34;node-1&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bootstrap: 						# 是否在程序启动时立即分配指定大小内存给elasticsearch进程
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  memory_lock: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">network:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  port: 9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ingest:                        # 关闭geoip 组件下载
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  geoip:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    downloader:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p><em>systemd 管理服务</em></p>
<blockquote>
<p>测试启动命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># *命令行传参启动，在参数前添加`-E`来覆盖配置文件对应参数*</span>
</span></span><span style="display:flex;"><span>su - elasticsearch -c <span style="color:#e6db74">&#34;export ES_PATH_CONF=/data/elk/instance1/config ;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export ES_JAVA_HOME=/data/elk/elasticsearch/jdk ;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/data/elk/elasticsearch/bin/elasticsearch \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-Ehttp.port=8200&#34;</span>
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /etc/systemd/system/elasticsearch.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description= elasticsearch service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://www.elastic.co/docs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;ES_PATH_CONF=/data/elk/instance1/config&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;ES_JAVA_HOME=/data/elk/elasticsearch/jdk&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/elk/elasticsearch/bin/elasticsearch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=elasticsearch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable elasticsearch --now
</span></span><span style="display:flex;"><span>systemctl status elasticsearch
</span></span></code></pre></div></li>
<li>
<p>验证集群状态</p>
<p>通常情况下使用 <code>elasticsearch-head</code> 插件来监听elasticsearch。也可以使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.0/_cluster_health.html" target="_blank">api接口来查询</a></p>


<div class="alert alert-primary" role="alert">


    <ul>
<li>通过chrome 商店安装，需要vpn</li>
<li>通过github上提供的docker 镜像启动</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#由于前后端服务做了分离，因此需要开启elasticsearch跨域请求</span>
</span></span><span style="display:flex;"><span>http.cors.enabled: true 
</span></span><span style="display:flex;"><span>http.cors.allow-origin: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it -p9100:9100 mobz/elasticsearch-head:5-alpine
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl http://127.0.0.1:9200/_cat/nodes?v
</span></span><span style="display:flex;"><span>curl -s  http://127.0.0.1:9200/_cluster/health?pretty<span style="color:#f92672">=</span>true |jq <span style="color:#e6db74">&#34;.status&#34;</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="安全设置">安全设置</h3>
<ul>
<li>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/security-minimal-setup.html" target="_blank"><strong>开启用户认证</strong></a></p>


<div class="alert alert-warning" role="alert">


    <p>&#x26a0;&#xfe0f;</p>
<p>ERROR: [1] bootstrap checks failed. You must address the points described in the following [1] lines before starting Elasticsearch.
bootstrap check failure [1] of [1]: Transport SSL must be enabled if security is enabled on a [basic] license. Please set [xpack.security.transport.ssl.enabled] to [true] or disable security by setting [xpack.security.enabled] to [false]</p>


</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">xpack</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">security</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">transport</span>:  <span style="color:#75715e"># xpack.security.enabled 依赖xpack.security.transport.ssl.enabled 功能开启，实现在9300端口的https,而不是9200</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ssl</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>设置密码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/data/elk/elasticsearch/bin/elasticsearch-setup-passwords interactive
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@seagullcore01-uat-s2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /data/elk/elasticsearch/bin/elasticsearch-setup-passwords interactive -u  http://100.64.0.5:8200</span>
</span></span><span style="display:flex;"><span>warning: usage of JAVA_HOME is deprecated, use ES_JAVA_HOME
</span></span><span style="display:flex;"><span>Initiating the setup of passwords <span style="color:#66d9ef">for</span> reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.
</span></span><span style="display:flex;"><span>You will be prompted to enter passwords as the process progresses.
</span></span><span style="display:flex;"><span>Please confirm that you would like to <span style="color:#66d9ef">continue</span> <span style="color:#f92672">[</span>y/N<span style="color:#f92672">]</span>y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>elastic<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Reenter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>elastic<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Enter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>apm_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Reenter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>apm_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Enter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>kibana_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Reenter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>kibana_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Enter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>logstash_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Reenter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>logstash_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Enter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>beats_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Reenter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>beats_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Enter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>remote_monitoring_user<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Reenter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>remote_monitoring_user<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>apm_system<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>kibana_system<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>kibana<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>logstash_system<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>beats_system<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>remote_monitoring_user<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>elastic<span style="color:#f92672">]</span>
</span></span></code></pre></div></li>
<li>
<p><strong>开启https</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 生成ca</span>
</span></span><span style="display:flex;"><span>su - elasticsearch -c <span style="color:#e6db74">&#34;/data/elk/elasticsearch/bin/elasticsearch-certutil ca \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--out /data/elk/instance1/config/certs/ca.crt --pass mypass&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 生成公钥</span>
</span></span><span style="display:flex;"><span>su - elasticsearch -c <span style="color:#e6db74">&#34;/data/elk/elasticsearch/bin/elasticsearch-certutil cert --ca /data/elk/instance1/config/certs/ca.crt \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--out /data/elk/instance1/config/certs/server.crt --ca-pass mypass&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>xpack.security.http.ssl.enabled: true
</span></span><span style="display:flex;"><span>xpack.security.http.ssl.keystore.path: certs/server.crt
</span></span></code></pre></div></li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-2d9ddeb9ab30ddfb699011cd96663611">集群版本安装</h1>
	<div class="lead">部署集群版本elasticsearch</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-12" class="text-body-secondary">Thursday, June 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>elasticsearch版本： <code>7.15.0</code>、<code>7.17.27</code></p>
<hr>
<p>【注意事项】| <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/index.html" target="_blank">doc</a></p>
<ul>
<li>
<p>elasticsearch 依赖jdk 环境，<a href="https://www.elastic.co/cn/support/matrix#matrix_jvm" target="_blank">如果无法判断使用哪个版本jdk</a>。可以<a href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch" target="_blank">下载</a>/<a href="https://repo.huaweicloud.com" target="_blank">国内下载镜像</a>带有jdk版本的elasticsearch。</p>
</li>
<li>
<p>elasticsearch默认监听9200（提供restfull风格的服务） 和 9300 （集群内部选举和数据同步）</p>
</li>
<li>
<p>elasticsearch 属于io密集型应用，尽可能把数据目录单独挂载出来。并使用高性能磁盘。</p>
</li>
<li>
<p><font color=red>关闭防火墙、selinux、swap。并时间同步。</font></p>
</li>
</ul>


</div>

<h3 id="集群部署">集群部署</h3>
<table>
  <thead>
      <tr>
          <th>节点名称</th>
          <th>ip</th>
          <th>elasticsearch集群名</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>node-1</code></td>
          <td><code>192.168.0.151</code></td>
          <td><code>cluster-alerts</code></td>
      </tr>
      <tr>
          <td><code>node-2</code></td>
          <td><code>192.168.0.152</code></td>
          <td><code>cluster-alerts</code></td>
      </tr>
      <tr>
          <td><code>node-3</code></td>
          <td><code>192.168.0.153</code></td>
          <td><code>cluster-alerts</code></td>
      </tr>
  </tbody>
</table>

  
  
  

  

<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>集群配置文件</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="**节点一**" aria-controls="tabs-01-01" aria-selected="true">
        <strong>节点一</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="**节点二**" aria-controls="tabs-01-02" aria-selected="false">
        <strong>节点二</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="**节点三**" aria-controls="tabs-01-03" aria-selected="false">
        <strong>节点三</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/elk/instance1/config/elasticsearch.yml <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">path:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: /data/elk/instance1/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  logs: /data/elk/instance1/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: node-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  master: true                   # 节点可以是master角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: true                     # 节点可以是data角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">discovery:    # 启动时向哪些主机进行宣告，进行集群选举，集群内的主机都要填写上。包括自己
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  seed_hosts: [&#34;192.168.0.151&#34;,&#34;192.168.0.152&#34;,&#34;192.168.0.153&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cluster:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: cluster-alerts
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  initial_master_nodes: [&#34;192.168.0.151&#34;,&#34;192.168.0.152&#34;,&#34;192.168.0.153&#34;] #初始化时哪些节点可以被选举为master ，集群内的主机可以都填写上，也可以填写部分主机。支持使用 `node.name` 或者 `ip地址`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  routing:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    allocation:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cluster_concurrent_rebalance: 16         # 集群内同时启动的数据任务个数，默认是2个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_concurrent_recoveries: 16           # 添加或删除节点及负载均衡时并发恢复的线程个数，默认4个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_initial_primaries_recoveries: 16    # 初始化数据恢复时，并发恢复线程的个数，默认4个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">network:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tcp:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    keep_alive: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    no_delay: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  port: 9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  max_content_length: 200mb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  cors: # 允许跨域请求9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    allow-origin: &#34;*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gateway:               # 当集群进行数据恢复时必须大于指定数量的节点在线，才可以进行数据恢复。通常设置为 (集群节点数量/2+1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  recover_after_nodes: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">transport:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tcp:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    compress: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bootstrap: # 是否在程序启动时立即分配指定大小内存给elasticsearch进程
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  memory_lock: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ingest:             # 关闭geoip 组件下载
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  geoip:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    downloader:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/elk/instance1/config/elasticsearch.yml <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">path:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: /data/elk/instance1/data  # 等同path.data: /data/elk/instance1/data，其他依次类推
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  logs: /data/elk/instance1/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: node-2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  master: true                   # 节点可以是master角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: true                     # 节点可以是data角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">discovery:    # 启动时向哪些主机进行宣告，进行集群选举，集群内的主机都要填写上。包括自己
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  seed_hosts: [&#34;192.168.0.151&#34;,&#34;192.168.0.152&#34;,&#34;192.168.0.153&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cluster:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: cluster-alerts
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  initial_master_nodes: [&#34;192.168.0.151&#34;,&#34;192.168.0.152&#34;,&#34;192.168.0.153&#34;] #初始化时哪些节点可以被选举为master ，集群内的主机可以都填写上，也可以填写部分主机。支持使用 `node.name` 或者 `ip地址`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  routing:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    allocation:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cluster_concurrent_rebalance: 16         # 集群内同时启动的数据任务个数，默认是2个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_concurrent_recoveries: 16           # 添加或删除节点及负载均衡时并发恢复的线程个数，默认4个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_initial_primaries_recoveries: 16    # 初始化数据恢复时，并发恢复线程的个数，默认4个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">network:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tcp:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    keep_alive: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    no_delay: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  port: 9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  max_content_length: 200mb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  cors: # 允许跨域请求9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    allow-origin: &#34;*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gateway:               # 当集群进行数据恢复时必须大于指定数量的节点在线，才可以进行数据恢复。通常设置为 (集群节点数量/2+1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  recover_after_nodes: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">transport:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tcp:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    compress: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bootstrap: # 是否在程序启动时立即分配指定大小内存给elasticsearch进程
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  memory_lock: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ingest:             # 关闭geoip 组件下载
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  geoip:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    downloader:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/elk/instance1/config/elasticsearch.yml <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">path:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: /data/elk/instance1/data  # 等同path.data: /data/elk/instance1/data，其他依次类推
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  logs: /data/elk/instance1/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: node-3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  master: true                   # 节点可以是master角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: true                     # 节点可以是data角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">discovery:    # 启动时向哪些主机进行宣告，进行集群选举，集群内的主机都要填写上。包括自己
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  seed_hosts: [&#34;192.168.0.151&#34;,&#34;192.168.0.152&#34;,&#34;192.168.0.153&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cluster:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: cluster-alerts
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  initial_master_nodes: [&#34;192.168.0.151&#34;,&#34;192.168.0.152&#34;,&#34;192.168.0.153&#34;] #初始化时哪些节点可以被选举为master ，集群内的主机可以都填写上，也可以填写部分主机。支持使用 `node.name` 或者 `ip地址`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  routing:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    allocation:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cluster_concurrent_rebalance: 16         # 集群内同时启动的数据任务个数，默认是2个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_concurrent_recoveries: 16           # 添加或删除节点及负载均衡时并发恢复的线程个数，默认4个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_initial_primaries_recoveries: 16    # 初始化数据恢复时，并发恢复线程的个数，默认4个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">network:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tcp:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    keep_alive: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    no_delay: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  port: 9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  max_content_length: 200mb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  cors: # 允许跨域请求9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    allow-origin: &#34;*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gateway:               # 当集群进行数据恢复时必须大于指定数量的节点在线，才可以进行数据恢复。通常设置为 (集群节点数量/2+1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  recover_after_nodes: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">transport:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tcp:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    compress: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bootstrap: # 是否在程序启动时立即分配指定大小内存给elasticsearch进程
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  memory_lock: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ingest:             # 关闭geoip 组件下载
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  geoip:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    downloader:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>
    </div>
</div>

<p>如果可以查看到node信息，则集群节点创建成功</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/_cat/nodes
</span></span></code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">集群选举失败</h4>

    <hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Nov <span style="color:#ae81ff">25</span> 16: 12: <span style="color:#ae81ff">10</span> node-2 elasticsearch<span style="color:#f92672">[</span>8964<span style="color:#f92672">]</span>: <span style="color:#f92672">[</span>2025-11-25T16: 12: 10,131<span style="color:#f92672">][</span>WARN<span style="color:#f92672">][</span>o.e.c.c.ClusterFormationFailureHelper<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>node-2<span style="color:#f92672">]</span> master not discovered or elected yet, an election requires at least <span style="color:#ae81ff">2</span> nodes with ids from <span style="color:#f92672">[</span>VBlfeDBuQ0aKmj6sXYYDCA, YqHqBfh_TtSeyx8ToGC7cA, lsEs2XMTTRmteL7yxEiuOg<span style="color:#f92672">]</span>, have only discovered non-quorum <span style="color:#f92672">[{</span>node-2<span style="color:#f92672">}{</span>YqHqBfh_TtSeyx8ToGC7cA<span style="color:#f92672">}{</span>qOajkkUJQH6ks4hwaZ02Lw<span style="color:#f92672">}{</span>192.168.0.152<span style="color:#f92672">}{</span>192.168.0.152: 9300<span style="color:#f92672">}{</span>cdfhilmrstw<span style="color:#f92672">}]</span>; discovery will <span style="color:#66d9ef">continue</span> using <span style="color:#f92672">[</span>192.168.0.151: 9300,192.168.0.153: 9300<span style="color:#f92672">]</span> from hosts providers and <span style="color:#f92672">[{</span>node-2<span style="color:#f92672">}{</span>YqHqBfh_TtSeyx8ToGC7cA<span style="color:#f92672">}{</span>qOajkkUJQH6ks4hwaZ02Lw<span style="color:#f92672">}{</span>192.168.0.152<span style="color:#f92672">}{</span>192.168.0.152: 9300<span style="color:#f92672">}{</span>cdfhilmrstw<span style="color:#f92672">}]</span> from last-known cluster state; node term 4, last-accepted version <span style="color:#ae81ff">1272</span> in term <span style="color:#ae81ff">4</span>
</span></span></code></pre></div><hr>
<p>解决方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  检查9300集群通讯端口是否互访正常。例如<span style="color:#e6db74">`</span>telnet 192.168.0.152 9300<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>  关闭selinux 和 firewalld
</span></span></code></pre></div>

</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-0211872ddd3d7ac997b074513c5e8671">配置文件</h1>
	<div class="lead">elasticsearch支持restfull 方式的CRUD</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-12" class="text-body-secondary">Thursday, June 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">


    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>elasticsearch版本： <code>7.15.0</code>、<code>7.17.27</code></p>
<hr>
<p><strong>elasticsearch 包含三个主要的配置:</strong></p>
<p>大多数配置可以在运行时通过<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-update-settings.html" target="_blank">api</a>热修改，配置文件默认在<code>$ES_HOME/config</code> 目录下，可以通过变量 <code>export ES_PATH_CONF=/path/to/my/config</code> 自定义配置文件的路径</p>
<ul>
<li><code>elasticsearch.yml</code>用于配置 Elasticsearch</li>
<li><code>jvm.options</code>用于配置 Elasticsearch JVM</li>
<li><code>log4j2.properties</code>用于配置 Elasticsearch 日志记录</li>
</ul>


</div>

<p>集群管理</p>
<p>节点管理</p>
<p>数据和日志路径管理</p>
<p>内存管理</p>
<p>网络管理</p>
<p>自动发现</p>
<p><strong>数据/日志目录配置</strong></p>


  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="yaml" aria-controls="tabs-01-00" aria-selected="true">
        yaml
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="yaml扁平格式" aria-controls="tabs-01-01" aria-selected="false">
        yaml扁平格式
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">path</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">data</span>: <span style="color:#ae81ff">/data/elk/instance1/data</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">logs</span>: <span style="color:#ae81ff">/data/elk/instance1/log</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">path.data</span>: <span style="color:#ae81ff">/data/elk/instance1/data</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">path.logs</span>: <span style="color:#ae81ff">/data/elk/instance1/log</span>
</span></span></code></pre></div>
    </div>
</div>

<p><strong>集群名称</strong> 不同的集群用名字来区分，配置成相同集群名字的各个节点形成一个集群</p>


  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          data-td-tp-persist="yaml" aria-controls="tabs-02-00" aria-selected="true">
        yaml
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="yaml扁平格式" aria-controls="tabs-02-01" aria-selected="false">
        yaml扁平格式
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-alerts</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">cluster.name</span>: <span style="color:#ae81ff">cluster-alerts</span>
</span></span></code></pre></div>
    </div>
</div>

<p><strong>节点名称</strong> 可以不定义此参数，这时，Elasticsearch自动选择一个唯一的名称</p>


  
  
<ul class="nav nav-tabs" id="tabs-3" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-03-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-00" role="tab"
          data-td-tp-persist="yaml" aria-controls="tabs-03-00" aria-selected="true">
        yaml
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-03-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-01" role="tab"
          data-td-tp-persist="yaml扁平格式" aria-controls="tabs-03-01" aria-selected="false">
        yaml扁平格式
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-3-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-03-00" role="tabpanel" aria-labelled-by="tabs-03-00-tab" tabindex="3">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">node</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">node-1</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-03-01" role="tabpanel" aria-labelled-by="tabs-03-01-tab" tabindex="3">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">node.name</span>: <span style="color:#ae81ff">node-1</span>
</span></span></code></pre></div>
    </div>
</div>

<p><strong>网络设置</strong></p>


  
  
<ul class="nav nav-tabs" id="tabs-4" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-04-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-04-00" role="tab"
          data-td-tp-persist="yaml" aria-controls="tabs-04-00" aria-selected="true">
        yaml
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-04-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-04-01" role="tab"
          data-td-tp-persist="yaml扁平格式" aria-controls="tabs-04-01" aria-selected="false">
        yaml扁平格式
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-4-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-04-00" role="tabpanel" aria-labelled-by="tabs-04-00-tab" tabindex="4">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">network</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host</span>: <span style="color:#ae81ff">0.0.0.0</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-04-01" role="tabpanel" aria-labelled-by="tabs-04-01-tab" tabindex="4">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">network.host</span>: <span style="color:#ae81ff">0.0.0.0</span>
</span></span></code></pre></div>
    </div>
</div>

<p><strong>自动创建索引</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 关闭自动创建索引，默认为true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">action.auto_create_index</span>: <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 允许自动创建a开头但不能是an开头的索引</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">action.auto_create_index</span>: -<span style="color:#ae81ff">an*,+a,-*</span>
</span></span></code></pre></div><p><strong>跨域请求</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#由于前后端服务做了分离，因此需要开启elasticsearch跨域请求</span>
</span></span><span style="display:flex;"><span>http.cors.enabled: true 
</span></span><span style="display:flex;"><span>http.cors.allow-origin: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@node-1 bin<span style="color:#f92672">]</span><span style="color:#75715e"># /data/elk/elasticsearch/bin/elasticsearch-plugin  install https://get.infini.cloud/elasticsearch/analysis-ik/7.17.29</span>
</span></span><span style="display:flex;"><span>-&gt; Installing https://get.infini.cloud/elasticsearch/analysis-ik/7.17.29
</span></span><span style="display:flex;"><span>-&gt; Downloading https://get.infini.cloud/elasticsearch/analysis-ik/7.17.29
</span></span><span style="display:flex;"><span>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span></span><span style="display:flex;"><span>@     WARNING: plugin requires additional permissions     @
</span></span><span style="display:flex;"><span>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span></span><span style="display:flex;"><span>* java.net.SocketPermission * connect,resolve
</span></span><span style="display:flex;"><span>See https://docs.oracle.com/javase/8/docs/technotes/guides/security/permissions.html
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> descriptions of what these permissions allow and the associated risks.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Continue with installation? <span style="color:#f92672">[</span>y/N<span style="color:#f92672">]</span>y
</span></span><span style="display:flex;"><span>-&gt; Installed analysis-ik
</span></span><span style="display:flex;"><span>-&gt; Please restart Elasticsearch to activate any plugins installed
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -XPOST http://192.168.0.151:9200/_analyze <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;analyzer&#34;: &#34;ik_max_word&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;text&#34;: &#34;千锋教育&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>su - elasticsearch -c <span style="color:#e6db74">&#34;export ES_PATH_CONF=/data/elk/instance1/config ;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export ES_JAVA_HOME=/data/elk/elasticsearch/jdk ;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/data/elk/elasticsearch/bin/elasticsearch-plugin list &#34;</span>
</span></span></code></pre></div><h3 id="mapping">mapping</h3>

  
  
<ul class="nav nav-tabs" id="tabs-5" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-05-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-00" role="tab"
          data-td-tp-persist="**定义索引分片和副本数量**" aria-controls="tabs-05-00" aria-selected="true">
        <strong>定义索引分片和副本数量</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-05-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-01" role="tab"
          data-td-tp-persist="**定义数据类型**" aria-controls="tabs-05-01" aria-selected="false">
        <strong>定义数据类型</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-5-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-05-00" role="tabpanel" aria-labelled-by="tabs-05-00-tab" tabindex="5">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;settings&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;number_of_shards&#34;</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;number_of_replicas&#34;</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-05-01" role="tabpanel" aria-labelled-by="tabs-05-01-tab" tabindex="5">
        <p>支持的数据类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;mappings&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;name&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;index&#34;</span>: <span style="color:#66d9ef">false</span>  <span style="color:#75715e">// false 表示不创建索引不支持查询
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;value&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;integer&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;describe&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;text&#34;</span>, <span style="color:#75715e">// 支持分词检索
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">&#34;fields&#34;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;keyword&#34;</span>: { <span style="color:#75715e">// 保留原始值，用于聚合/排序/精确查询
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&#34;ignore_above&#34;</span>: <span style="color:#ae81ff">256</span> <span style="color:#75715e">// 长度超限就忽略，防止膨胀
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
</div>

<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X PUT 127.0.0.1:9200/alerts <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -d<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;mappings&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;properties&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;name&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;type&#34;: &#34;keyword&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;index&#34;: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;value&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;type&#34;: &#34;integer&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;describe&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;type&#34;: &#34;text&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;fields&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    &#34;keyword&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;type&#34;: &#34;keyword&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;ignore_above&#34;: 256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;settings&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;number_of_shards&#34;: 1,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;number_of_replicas&#34;: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><p>示例：动态调整分片的副本数量</p>
<blockquote>
<p>分片数量创建后不可以调整除非删除重建索引。副本数量可以动态调整</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X PUT 127.0.0.1:9200/alerts/_settings <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -d<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;number_of_replicas&#34; : 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }&#39;</span>
</span></span></code></pre></div><h3 id="index-template">index template</h3>
<p>分片数量在index创建后不能调整，一旦创建好索引，更改分片数量的唯一途径就是创建另一个索引并重新索引数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -XGET http://192.168.0.151:9200/_cluster/state/nodes/
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cluster_name&#34;</span>: <span style="color:#e6db74">&#34;cluster-alerts&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cluster_uuid&#34;</span>: <span style="color:#e6db74">&#34;sel1D22xQzWTiq_vZYiGow&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;nodes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;KrYRJaO-Qwq0FmnCETRnrw&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;node-3&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;ephemeral_id&#34;</span>: <span style="color:#e6db74">&#34;gOriln-aRNWmGg_6JdwkRA&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;transport_address&#34;</span>: <span style="color:#e6db74">&#34;192.168.0.153:9300&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.machine_memory&#34;</span>: <span style="color:#e6db74">&#34;8182120448&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.max_open_jobs&#34;</span>: <span style="color:#e6db74">&#34;512&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;xpack.installed&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.max_jvm_size&#34;</span>: <span style="color:#e6db74">&#34;1073741824&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;transform.node&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;roles&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_cold&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_content&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_frozen&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_hot&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_warm&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ingest&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;master&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;remote_cluster_client&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;transform&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;j1aQHoGtSGORdRYqSrosIQ&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;node-2&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;ephemeral_id&#34;</span>: <span style="color:#e6db74">&#34;bDT3W7RzTVyvXbRfbznVvQ&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;transport_address&#34;</span>: <span style="color:#e6db74">&#34;192.168.0.152:9300&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.machine_memory&#34;</span>: <span style="color:#e6db74">&#34;8182112256&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.max_open_jobs&#34;</span>: <span style="color:#e6db74">&#34;512&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;xpack.installed&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.max_jvm_size&#34;</span>: <span style="color:#e6db74">&#34;1073741824&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;transform.node&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;roles&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_cold&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_content&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_frozen&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_hot&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_warm&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ingest&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;master&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;remote_cluster_client&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;transform&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;28LwCUt0RmqDo0zSbmo8cg&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;node-1&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;ephemeral_id&#34;</span>: <span style="color:#e6db74">&#34;D8-vfrz0SY6uHru_WC84Dg&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;transport_address&#34;</span>: <span style="color:#e6db74">&#34;192.168.0.151:9300&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.machine_memory&#34;</span>: <span style="color:#e6db74">&#34;8182120448&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;xpack.installed&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;transform.node&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.max_open_jobs&#34;</span>: <span style="color:#e6db74">&#34;512&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.max_jvm_size&#34;</span>: <span style="color:#e6db74">&#34;1073741824&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;roles&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_cold&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_content&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_frozen&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_hot&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_warm&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ingest&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;master&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;remote_cluster_client&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;transform&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>&#x2753; 主节点和工作节点，主节点承担了什么任务，通过哪种协议选举出的主节点</p>
<ol>
<li>分片数量不超过节点熟练的3倍</li>
<li>内存分配不超过操作系统的50%，但最大不超过32GB</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -XPUT http://192.168.0.151:9200/a/_settings <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;settings&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;index.unassigned.node_left.delayed_timeout&#34;: &#34;5m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-2457b5f6d965f967eb0a2d2d273f1823">RestfullAPI</h1>
	<div class="lead">elasticsearch支持restfull 方式的CRUD</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-12" class="text-body-secondary">Thursday, June 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">


    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>elasticsearch版本： <code>7.15.0</code>、<code>7.17.27</code></p>


</div>

<h3 id="概念">概念</h3>
<p>Elasticsearch 是一个分布式文档存储，使用一种全文搜索的倒排索引，倒排索引列出任何文档中出现的每个唯一单词，并标识所有 每个单词都出现在文档中。</p>
<p>索引可以被认为是文档的集合，每个文档 document 是字段的集合</p>
<p>默认情况下，Elasticsearch 会索引每个字段和每个索引中的所有数据字段具有专用的、优化的数据结构。例如，文本字段是存储在倒排索引中，数字和地理字段存储在 BKD 树中。</p>
<ul>
<li>
<p>Lucene 是 Apache 软件基金会下的一个「<strong>纯 Java 编写的开源全文检索引擎库</strong>」。
它本身不是一套完整的搜索服务器，而是一组「<strong>jar 包</strong>」：你的应用把 Lucene 的代码直接引入，就能在 JVM 进程里完成倒排索引的构建、分词、打分、查询、高亮、拼写检查等全部搜索相关功能。换句话说，Lucene 是「<strong>搜索引擎的内核</strong>」。</p>
</li>
<li>
<p>Elasticsearch 是对Lucene 的封装,在Lucene功能的基础上实现了数据分片、副本、REST API、聚合、SQL、安全、监控等。</p>
</li>
<li>
<p>Index（索引）物理上就是一组 Segment 文件，内部采用「倒排索引」结构，保证关键词 → 文档列表的快速映射。</p>
</li>
<li>
<p>Document（文档）一条可被搜索的业务数据，由多个 Field 组成，等价于 ES 里的一条 JSON 记录。</p>
</li>
</ul>
<h3 id="index操作">index操作</h3>
<ul>
<li>
<p>创建索引<code>alerts</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># curl -X PUT 127.0.0.1:9200/alerts</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X PUT 127.0.0.1:9200/alerts <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -d<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;mappings&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;properties&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;name&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;type&#34;: &#34;keyword&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;value&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;type&#34;: &#34;integer&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;describe&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;type&#34;: &#34;text&#34;,               // 支持分词检索
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;fields&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;keyword&#34;: {                // 保留原始值，用于聚合/排序/精确查询
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;type&#34;: &#34;keyword&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;ignore_above&#34;: 256       // 长度超限就忽略，防止膨胀
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>列出所有索引</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X GET 127.0.0.1:9200/_cat/indices
</span></span></code></pre></div></li>
<li>
<p>列出索引<code>alerts</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X GET 127.0.0.1:9200/alerts?pretty
</span></span></code></pre></div></li>
<li>
<p>删除索引<code>alerts</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X DELETE 127.0.0.1:9200/alerts
</span></span></code></pre></div></li>
</ul>
<h3 id="document操作">document操作</h3>
<ul>
<li>
<p>写入一条数据</p>
<blockquote>
<p>格式： <code>127.0.0.1:9200/{索引名称}/{文档类型}/{文档id}</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST 127.0.0.1:9200/alerts/_doc/1001 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&#34;name&#34;: &#34;MemHigh&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&#34;value&#34;: &#34;80&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&#34;describe&#34;: &#34;instance [node-1] memory high,please recheck&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>写入多条数据</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST 127.0.0.1:9200/alerts/_bulk <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/x-ndjson&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -d<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{ &#34;index&#34; : { &#34;_index&#34; : &#34;alerts&#34;, &#34;_id&#34; : &#34;1002&#34; } }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{ &#34;name&#34; : &#34;MemHigh&#34;, &#34;value&#34; : 85 ,&#34;describe&#34; : &#34;instance [node-2] memory high,please recheck[cpu/diskio/memory]&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{ &#34;index&#34; : { &#34;_index&#34; : &#34;alerts&#34;, &#34;_id&#34; : &#34;1003&#34; } }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{ &#34;name&#34; : &#34;CpuHigh&#34;, &#34;value&#34; : 95 ,&#34;describe&#34; : &#34;instance [node-3] cpu high,please recheck[cpu/diskio/memory]&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>               <span style="color:#75715e"># ← 这里隐含 \n，确保最后有空行</span>
</span></span></code></pre></div></li>
<li>
<p>查看数据</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_doc/1001?pretty
</span></span></code></pre></div>

    

    

    

    
    

    

    

  <ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="*查找所有文档*" aria-controls="tabs-01-00" aria-selected="true">
        <em>查找所有文档</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="*分页显示*和排序" aria-controls="tabs-01-01" aria-selected="false">
        <em>分页显示</em>和排序
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="*仅展示指定字段*" aria-controls="tabs-01-02" aria-selected="false">
        <em>仅展示指定字段</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="*范围查找*" aria-controls="tabs-01-03" aria-selected="false">
        <em>范围查找</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-04" role="tab"
          data-td-tp-persist="*关键字查找和高亮显示*" aria-controls="tabs-01-04" aria-selected="false">
        <em>关键字查找和高亮显示</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-05-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-05" role="tab"
          data-td-tp-persist="*全文匹配*" aria-controls="tabs-01-05" aria-selected="false">
        <em>全文匹配</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-06-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-06" role="tab"
          data-td-tp-persist="*聚合查询*" aria-controls="tabs-01-06" aria-selected="false">
        <em>聚合查询</em>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;match_all&#34;: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;match_all&#34;: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;from&#34;: 0,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;match_all&#34;: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;from&#34;: 0,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;sort&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;value&#34;: {&#34;order&#34;:&#34;desc&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;match_all&#34;: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;from&#34;: 0,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;sort&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;value&#34;: {&#34;order&#34;:&#34;desc&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;_source&#34;: [&#34;name&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;range&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;value&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;gte&#34;: 85,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;lt&#34;: 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-04" role="tabpanel" aria-labelled-by="tabs-01-04-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查找 name=&#34;MemHigh&#34;</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;name&#34;: &#34;MemHigh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 多条件查找，name=&#34;MemHigh&#34; and value=85</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;bool&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;must&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;name&#34;: &#34;MemHigh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;value&#34;: &#34;85&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 高亮显示name字段值。适用于keyword类型字段</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;bool&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;must&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;name&#34;: &#34;MemHigh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;value&#34;: &#34;85&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;highlight&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;fields&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;name&#34;: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-05" role="tabpanel" aria-labelled-by="tabs-01-05-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># match 分词后不考虑`cpu` `High` 分词的顺序只要出现过的都会匹配到</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;describe&#34;:&#34;cpu High&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># match_phrase 分词后考虑`cpu` `High` 分词的顺序，只有完全符合的会匹配到</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;match_phrase&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;describe&#34;:&#34;cpu  High&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-06" role="tabpanel" aria-labelled-by="tabs-01-06-tab" tabindex="1">
        <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" target="_blank">文档参考</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 按照name 聚合计数</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;count_high&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;terms&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             &#34;field&#34;: &#34;name&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 求内存告警中最大值,类推 max / min / avg / sum</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;name&#34;:&#34;MemHigh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;mem_max&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;max&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             &#34;field&#34;: &#34;value&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;_source&#34;: false // 不显示原始数据
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
</div>

</li>
<li>
<p>修改数据</p>


    
    
  <ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          data-td-tp-persist="*全量覆盖1001*" aria-controls="tabs-02-00" aria-selected="true">
        <em>全量覆盖1001</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="*更新其中某些字段*" aria-controls="tabs-02-01" aria-selected="false">
        <em>更新其中某些字段</em>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X PUT 127.0.0.1:9200/alerts/_doc/1001 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&#34;name&#34;: &#34;MemHigh&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&#34;value&#34;: &#34;80&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST 127.0.0.1:9200/alerts/_update/1001 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -d<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;doc&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;value&#34;: &#34;88&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
</div>

</li>
</ul>

</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6be196ad1a32509a6c7bc2a224b2a9e3">7 - </h1>
    
	<p><img src="https://pic2.zhimg.com/v2-d4bcfceda6ff7e56c16d2191b8d45ee9_r.jpg" alt="img"></p>
<h3></h3>
<table>
  <thead>
      <tr>
          <th>java版本</th>
          <th>zookeeper版本</th>
          <th>kafka版本</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>java8</td>
          <td></td>
          <td>0.7 至 3.0</td>
      </tr>
      <tr>
          <td>java11</td>
          <td></td>
          <td>0.7 至 3.7</td>
      </tr>
      <tr>
          <td>java17</td>
          <td></td>
          <td>0.7 至</td>
      </tr>
  </tbody>
</table>
<p><a href="https://www.bilibili.com/video/BV1a4411B7V9?spm_id_from=333.788.player.switch&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76&amp;p=6" target="_blank">尚硅谷_Kafka入门_</a></p>
<p>kafka可视化管理和监控工具<a href="https://www.kafka-eagle.org/" target="_blank">EFAK</a>，同样是使用jmx抓取数据</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-4fd1811155c0b30c4801ab6b3f671eaf">部署zookeeper</h1>
	<div class="lead"><em>如何快速启动一个zookeeper服务</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-12" class="text-body-secondary">Friday, September 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code> 支持jdk1.8</p>
<p>kafka版本：<code>3.3.2</code></p>
<p>zookeeper可视化工具: <a href="https://github.com/vran-dev/PrettyZoo?tab=readme-ov-file" target="_blank">PrettyZoo</a></p>
<hr>
<p><em>通常多个kafka集群通过chroot的方式使用同一个zookeer集群。在Kafka 0.9.0.0 版本之前，除了 broker 之外，消费者也会使用 Zookeeper 来保存一些信息，比如消费者群组的信息、主题信息、消费分区的偏移量</em></p>


</div>

<h3 id="安装部署">安装部署</h3>
<p><strong>安装依赖</strong></p>
<ul>
<li>
<p>jdk</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://download.java.net/java/ga/jdk11/openjdk-11_linux-x64_bin.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf openjdk-11_linux-x64_bin.tar.gz -C /opt
</span></span><span style="display:flex;"><span>ln -svf  /opt/<span style="color:#f92672">{</span>jdk-11,jdk<span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat&gt;&gt;/etc/profile<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/opt/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_JRE=$JAVA_HOME/jre
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=$JAVA_HOME/lib:$JAVA_HOME/jre/lib
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=$JAVA_HOME/bin:$JAVA_JRE/bin:$PATH:.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>source /etc/profile
</span></span><span style="display:flex;"><span>java -version
</span></span></code></pre></div></li>
</ul>
<p><strong>部署安装</strong></p>
<ul>
<li>
<p>下载软件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://archive.apache.org/dist/zookeeper/zookeeper-3.4.14/zookeeper-3.4.14.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf zookeeper-3.4.14.tar.gz -C /opt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ln -sv /opt/<span style="color:#f92672">{</span>zookeeper-3.4.14,zookeeper<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p /opt/zookeeper/<span style="color:#f92672">{</span>data,logs<span style="color:#f92672">}</span> 
</span></span></code></pre></div></li>
<li>
<p>修改配置文件</p>

    
    
    
  <ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>配置zookeeper</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="**单节点配置**" aria-controls="tabs-01-01" aria-selected="true">
        <strong>单节点配置</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="**集群配置**" aria-controls="tabs-01-02" aria-selected="false">
        <strong>集群配置</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /opt/zookeeper/conf/zoo.cfg<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 集群成员间每隔2000毫秒检查一下集群心跳 2s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tickTime=2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># follower 初次连接leader 的tick次数。例如 10 * 2000 =20s ,follower要在20s内连接上leader 否则被视为超时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">initLimit=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># follower 与leader通讯的tick 次数。例如 5*2000=10s,follower要在10s内与leader完成通讯，否则被视为超时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">syncLimit=5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># zookeeper 会定期在内存中生成快照，并定义把快照内容写入 dataDir
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dataDir=/opt/zookeeper/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dataLogDir=/opt/zookeeper/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2181 用于接受客户端连接的主要端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clientPort=2181
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /opt/zookeeper/conf/zoo.cfg<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 集群成员间每隔2000毫秒检查一下集群心跳 2s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tickTime=2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># follower 初次连接leader 的tick次数。例如 10 * 2000 =20s ,follower要在20s内连接上leader 否则被视为超时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">initLimit=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># follower 与leader通讯的tick 次数。例如 5*2000=10s,follower要在10s内与leader完成通讯，否则被视为超时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">syncLimit=5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># zookeeper 会定期在内存中生成快照，并定义把快照内容写入 dataDir
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dataDir=/opt/zookeeper/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dataLogDir=/opt/zookeeper/logs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2181 用于接受客户端连接的主要端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clientPort=2181
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2888 用于 ZooKeeper 集群内节点从leader同步数据，只有leader才监听该端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3888 用于 ZooKeeper 集群中的 Leader 选举过程中节点之间的通信
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># server.X=host:port:port 这里的X（1～255）必须是一个全局唯一的数字，且需要与 myid文件中的数字相对应
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server.1=node-1:2888:3888
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server.2=node-2:2888:3888
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server.3=node-3:2888:3888
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 为每个节点分配id，在dataDir下myid文件中</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># node-1</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;1&#34;</span> &gt;/opt/zookeeper/data/myid
</span></span><span style="display:flex;"><span><span style="color:#75715e"># node-2</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;2&#34;</span> &gt;/opt/zookeeper/data/myid
</span></span><span style="display:flex;"><span><span style="color:#75715e"># node-3</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;3&#34;</span> &gt;/opt/zookeeper/data/myid
</span></span></code></pre></div><p>​</p>

    </div>
</div>

</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/zookeeper.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=zookeeper service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://zookeeper.apache.org/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=forking
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=JAVA_HOME=/opt/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/zookeeper/bin/zkServer.sh start
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStop=/opt/zookeeper/bin/zkServer.sh stop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/opt/zookeeper/bin/zkServer.sh restart
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PIDFile=/opt/zookeeper/data/zookeeper_server.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>

<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    zookeeper 主进程名为 <code>QuorumPeerMain</code>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable zookeeper --now
</span></span></code></pre></div></li>
<li>
<p>功能验证</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/zookeeper/bin/zkServer.sh  status
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@hdss7-12 bin<span style="color:#f92672">]</span><span style="color:#75715e">#  /opt/zookeeper/bin/zkCli.sh -server localhost:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>zk: localhost:2181<span style="color:#f92672">(</span>CONNECTED<span style="color:#f92672">)</span> 2<span style="color:#f92672">]</span> ls /
</span></span></code></pre></div></li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a2ebb8369fef061edbf7f3c10100d052">部署kafka</h1>
	<div class="lead"><em>如何快速启动一个kafka服务</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-12" class="text-body-secondary">Friday, September 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code></p>
<p>kafka版本：<code>3.3.2</code></p>
<hr>
<p><em>2011年初，美国领英公司（LinkedIn）开源了一款基础架构软件，以奥地利作家弗兰兹·卡夫卡（Franz Kafka）的名字命名，之后 LinkedIn将其贡献给 Apache基金会，随后该软件于2012年10月完成孵化并顺利晋升为Apache顶级项目——这便是大名鼎鼎的Apache Kafka</em></p>


</div>

<h3 id="安装部署">安装部署</h3>
<blockquote>
<p>作为高吞吐的数据流引擎，磁盘和网络性能对kafka影响最大。24C 、32GB 、1TB 7200转sas盘2块、1gb/s 带宽</p>
</blockquote>
<p><strong>安装依赖</strong></p>
<ul>
<li>安装<code>jdk</code> 和 <code>zookeeper</code>参考 <a href="zookeeper.html">部署zookeeper</a></li>
</ul>
<p><strong>部署安装<sub>【elk建议Kafka 版本 0.8.2.0+】</sub></strong></p>
<ul>
<li>
<p>下载软件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#												 kafaka_&lt;scala版本&gt;-&lt;kafka版本&gt;.tgz	</span>
</span></span><span style="display:flex;"><span>wget https://archive.apache.org/dist/kafka/3.3.2/kafka_2.13-3.3.2.tgz
</span></span><span style="display:flex;"><span>tar xf kafka_2.13-3.3.2.tgz -C /opt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ln -sv  /opt/<span style="color:#f92672">{</span>kafka_2.13-3.3.2,kafka<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir /opt/kafka/data
</span></span></code></pre></div></li>
<li>
<p>修改配置文件</p>

    
    
    
  <ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>配置kafka</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="**单节点配置**" aria-controls="tabs-01-01" aria-selected="true">
        <strong>单节点配置</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="**集群配置**" aria-controls="tabs-01-02" aria-selected="false">
        <strong>集群配置</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kafka_svc<span style="color:#f92672">=</span>kafka-1:9092
</span></span><span style="display:flex;"><span>broker_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>zookeeper_svc<span style="color:#f92672">=</span>zookeeper-1:2181,zookeeper-2:2181,zookeeper-3:2181
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tee /opt/kafka/config/server.properties <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">broker.id=${broker_id}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 尽量使用域名而不是ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listeners=PLAINTEXT://${kafka_svc}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">advertised.listeners=PLAINTEXT://${kafka_svc}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log.dirs=/opt/kafka/data/kafka1-logs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">zookeeper.connect=${zookeeper_svc}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">zookeeper.connection.timeout.ms=18000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">delete.topic.enable=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">unclean.leader.election.enable=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <p>同一集群中保证<code>broker_id</code>唯一，同时修改 <code>listeners</code> 和 <code>advertised.listeners</code></p>

    </div>
</div>

</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/kafka.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=zookeeper service 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://kafka.apache.org/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=forking
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=JAVA_HOME=/opt/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kafka/bin/kafka-server-start.sh -daemon /opt/kafka/config/server.properties
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStop=/opt/kafka/bin/kafka-server-stop.sh /opt/kafka/config/server.properties
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload 
</span></span><span style="display:flex;"><span>systemctl enable kafka --now
</span></span></code></pre></div></li>
<li>
<p>功能验证</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建topics</span>
</span></span><span style="display:flex;"><span>/opt/kafka/bin/kafka-topics.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--create --topic app-log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看topics</span>
</span></span><span style="display:flex;"><span>/opt/kafka/bin/kafka-topics.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看topics详情</span>
</span></span><span style="display:flex;"><span>/opt/kafka/bin/kafka-topics.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--describe <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--topic app-log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 向topics产生一个事件</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;This is my first event\nThis is my second event&#34;</span> |<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>/opt/kafka/bin/kafka-console-producer.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--topic  app-log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从头消费topics事件</span>
</span></span><span style="display:flex;"><span>/opt/kafka/bin/kafka-console-consumer.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--topic app-log <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--from-beginning 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#This is my first event</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#This is my second event</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除topic</span>
</span></span><span style="display:flex;"><span>/opt/kafka/bin/kafka-topics.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bootstrap-server localhost:9092  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--delete --topic app-log
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建指定分区和副本数量的topic</span>
</span></span><span style="display:flex;"><span>/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--create --topic app-log <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--replication-factor <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--partitions <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --describe --topic app-log</span>
</span></span><span style="display:flex;"><span>Topic: app-log        TopicId: sJH_EE1KT-aYppxi8Eq6qg PartitionCount: <span style="color:#ae81ff">2</span>       ReplicationFactor: <span style="color:#ae81ff">2</span>    Configs: unclean.leader.election.enable<span style="color:#f92672">=</span>false
</span></span><span style="display:flex;"><span>        Topic: app-log        Partition: <span style="color:#ae81ff">0</span>    Leader: <span style="color:#ae81ff">2</span>       Replicas: 2,1   Isr: 2,1
</span></span><span style="display:flex;"><span>        Topic: app-log        Partition: <span style="color:#ae81ff">1</span>    Leader: <span style="color:#ae81ff">1</span>       Replicas: 1,0   Isr: 1,0
</span></span></code></pre></div></li>
<li>
<p>压测</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 生产者压测脚本</span>
</span></span><span style="display:flex;"><span>kafka-producer-perf-test
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 消费者压测脚本</span>
</span></span><span style="display:flex;"><span>kafka-consumer-perf-test
</span></span></code></pre></div></li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-dc4ad1ef352d1381b1276b6e775efacb">kafka核心概念和配置文件</h1>
	<div class="lead"><em>剖析kafka架构、核心概念和配置</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-10-15" class="text-body-secondary">Wednesday, October 15, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code></p>
<p>kafka版本：<code>2.13-3.3.2</code>  龙腾出行生产环境使用<code>2.11-2.2.0</code></p>
<hr>
<p><em>2011年初，美国领英公司（LinkedIn）开源了一款基础架构软件，以奥地利作家弗兰兹·卡夫卡（Franz Kafka）的名字命名，之后 LinkedIn将其贡献给 Apache基金会，随后该软件于2012年10月完成孵化并顺利晋升为Apache顶级项目——这便是大名鼎鼎的Apache Kafka</em></p>


</div>

<h3 id="核心概念">核心概念</h3>
<ul>
<li><strong>broker</strong> 一个kafka进程实例可以称作一个broker,主要功能是持久化消息以及将消息队列中的消息从发送端传输到消费端</li>
<li><strong>topic</strong>主题就好比数据库的表，或者文件系统里的文件夹。一个主题可以有若干个<strong>partition</strong>，是实现分布式和高可用的关键</li>
<li><strong>producer</strong>生产者可能被称为发布者或写入者。</li>
<li><strong>consumer</strong>消费者可能被称为订阅者或读者。</li>
<li><strong>offset</strong>是一个不断递增的整数值，在创建消息时，Kafka 会把它添加到消息里。在给定的分区里，每个消息的偏移量都是唯一的。消费者把每个分区最后读取的消息偏移量保存在 Zookeeper 或 Kafka 上，如果消费者关闭或重启，它的读取状态不会丢失。</li>
<li><strong>consumer group</strong> 为使消费者按照消息顺序消费和避免重复消费，群组保证每个分区只能被一个消费者使用</li>
</ul>
<h3 id="核心配置">核心配置</h3>
<blockquote>
<p>kafka不支持动态调整参数，调整后需要重启broker</p>
</blockquote>


  
  



  

  

<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="**broker端参数**" aria-controls="tabs-01-00" aria-selected="true">
        <strong>broker端参数</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="**topic级别参数**" aria-controls="tabs-01-01" aria-selected="false">
        <strong>topic级别参数</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="**jvm参数**" aria-controls="tabs-01-02" aria-selected="false">
        <strong>jvm参数</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="**os参数**" aria-controls="tabs-01-03" aria-selected="false">
        <strong>os参数</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <p><a href="https://kafka.apache.org/30/documentation.html#brokerconfigs" target="_blank">文档</a></p>
<ul>
<li>
<p><strong>broker.id</strong></p>
<blockquote>
<p>Broker唯一标识，不指定时broker随机生成一个</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span></code></pre></div></li>
<li>
<p><strong>log.dirs</strong></p>
<blockquote>
<p>kafka数据存放位置，可以填写多个。多个使用<code>,</code>间隔</p>
</blockquote>
<p>示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span></code></pre></div></li>
<li>
<p><strong>zookeeper.connect</strong></p>
<blockquote>
<p>ZooKeeper服务器地址，多个使用<code>,</code>间隔。</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span></code></pre></div></li>
<li>
<p><strong>listeners</strong></p>
<blockquote>
<p>监听信息。格式:   <code>[协议]://[主机名]:[端口],[[协议]]://[主机名]:[端口]] </code></p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span></code></pre></div></li>
<li>
<p><strong>advertised.listeners</strong></p>
<blockquote>
<p>和listeners类似，该参数也是用于发布给clients的监听器，不过该参数主要用于 IaaS 环境，比如云上的机器通常都配有多块网卡（私网网卡和公网网卡）。对于这种机器，用户可以设置该参数绑定公网IP供外部clients使用，然后配置上面的listeners来绑定私网 IP供broker间通信使用</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span></code></pre></div></li>
<li>
<p><strong>auto.create.topics.enable</strong></p>
<blockquote>
<p>是否允许自动创建topic,默认值<em>true</em></p>
</blockquote>
<p>示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span></code></pre></div></li>
<li>
<p><strong>delete.topic.enable</strong></p>
<blockquote>
<p>是否允许删除topic,默认为true。建议配合acl使用</p>
</blockquote>
<p>示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span></code></pre></div></li>
<li>
<p><strong>log.retention.{hours|minutes|ms}</strong></p>
<blockquote>
<p>控制了消息数据的留存时间。如果同时设置，优先选取ms的设置，minutes次之，hours最后。默认值7天</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span></code></pre></div></li>
<li>
<p><strong>log.retention.bytes</strong></p>
<blockquote>
<p>空间上控制了消息数据的留存多大的数据。默认值是-1</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span></code></pre></div></li>
<li>
<p><strong>log.flush.interval.messages</strong></p>
<blockquote>
<p>写入的消息放置在kafka缓存中，达到指定条记录后写入到磁盘中，这个参数用于控制多少条数据后执行强制刷新</p>
</blockquote>
</li>
<li>
<p><strong>log.flush.interval.ms</strong></p>
</li>
<li>
<p><strong>log.flush.scheduler.interval.ms</strong></p>
</li>
<li>
<p><strong>unclean.leader.election.enable</strong></p>
<blockquote>
<p>如果我们允许不同步的副本成为首领，那么就要承担丢失数据和出现数据不一致的风险。如果不允许它们成为首领，那么就要接受较低的可用性，因为我们必须等待原先的首领恢复到可用状态。 默认为true</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span></code></pre></div></li>
<li>
<p><strong>min.insync.replicas</strong></p>
<blockquote>
<p>至少有多少个副本确认写入成功才会给生成者返回写入成功（数据可靠性）</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">min.insync.replicas</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
</span></span></code></pre></div></li>
<li>
<p><strong>num.network.threads</strong></p>
<blockquote>
<p>默认是3</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">min.insync.replicas</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.network.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3</span>
</span></span></code></pre></div></li>
<li>
<p><strong>num.io.threads</strong></p>
<blockquote>
<p>默认是8</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">min.insync.replicas</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.network.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.io.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">8</span>
</span></span></code></pre></div></li>
<li>
<p><strong>num.partitions</strong></p>
<blockquote>
<p>topic默认分区数</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">min.insync.replicas</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.network.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.io.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.partitions</span><span style="color:#f92672">=</span><span style="color:#e6db74">3</span>
</span></span></code></pre></div></li>
<li>
<p><strong>default.replication.factor</strong></p>
<blockquote>
<p>topic 默认副本数量</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">min.insync.replicas</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.network.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.io.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.partitions</span><span style="color:#f92672">=</span><span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">default.replication.factor</span><span style="color:#f92672">=</span><span style="color:#e6db74">2</span>
</span></span></code></pre></div></li>
<li>
<p><strong>message.max.bytes</strong></p>
<blockquote>
<p>能够接受的最大消息，默认 977kb</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">min.insync.replicas</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.network.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.io.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.partitions</span><span style="color:#f92672">=</span><span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">default.replication.factor</span><span style="color:#f92672">=</span><span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">message.max.bytes</span><span style="color:#f92672">=</span><span style="color:#e6db74">977</span>
</span></span></code></pre></div></li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <ul>
<li>
<p><strong>num.partitions</strong></p>
<blockquote>
<p>通过设置指定<code>topic partitions</code> 数量来覆盖broker启动文件中的 <code>num.paritions</code>配置。</p>
<p>分区数量只能增加不能减少，但如果消息是按照不同的键来写入分区的，那么为已有的主题新增分区就会很困难</p>
</blockquote>
</li>
<li>
<p><strong>log.retention.ms</strong></p>
</li>
<li>
<p><strong>log.retention.bytes</strong></p>
<blockquote>
<p>覆盖全局的 log.retention.bytes，每个 topic 设置不同的日志留存尺寸。</p>
</blockquote>
</li>
<li>
<p><strong>log.segment.bytes</strong></p>
</li>
<li>
<p><strong>log.segment.ms</strong></p>
</li>
<li>
<p><strong>max.message.bytes</strong></p>
<blockquote>
<p>覆盖全局的 message.max.bytes，即为每个 topic指定不同的最大消息尺寸。</p>
</blockquote>
</li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-Xmx6g -Xms6g
</span></span><span style="display:flex;"><span>-XX:MetaspaceSize<span style="color:#f92672">=</span>96m
</span></span><span style="display:flex;"><span>-XX:+UseG1GC -XX:MaxGCPauseMillis<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>-XX:InitiatingHeapOccupancyPercent<span style="color:#f92672">=</span><span style="color:#ae81ff">35</span>
</span></span><span style="display:flex;"><span>-XX:G1HeapRegionSize<span style="color:#f92672">=</span>16M -XX:MinMetaspaceFreeRatio<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>-XX:MaxMetaspaceFreeRatio<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <ul>
<li>文件描述符</li>
<li>socket缓冲区</li>
<li>使用ext4 或xfs</li>
<li>关闭swap</li>
<li>设置更长的flush时间</li>
</ul>

    </div>
</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-4ca462b874e0f51208f6529a334ea449">Kafka认证和授权</h1>
	<div class="lead"><em>Kafka认证和授权</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-11-10" class="text-body-secondary">Monday, November 10, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code></p>
<p>kafka版本：<code>2.13-3.3.2</code>  龙腾出行生产环境使用<code>2.11-2.2.0</code></p>
<hr>
<p><em>2011年初，美国领英公司（LinkedIn）开源了一款基础架构软件，以奥地利作家弗兰兹·卡夫卡（Franz Kafka）的名字命名，之后 LinkedIn将其贡献给 Apache基金会，随后该软件于2012年10月完成孵化并顺利晋升为Apache顶级项目——这便是大名鼎鼎的Apache Kafka</em></p>


</div>

<h3 id="用户">用户</h3>
<p><font color=＃008B8B><strong>创建用户</strong></font></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建用户test 密码123456 加密方式SCRAM-SHA-256</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@seagullcore01-uat-s2 kafka_2.13-3.3.2<span style="color:#f92672">]</span><span style="color:#75715e"># bin/kafka-configs.sh \</span>
</span></span><span style="display:flex;"><span>--bootstrap-server 192.168.0.161:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--alter <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--add-config <span style="color:#e6db74">&#39;SCRAM-SHA-256=[password=123456]&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--entity-type users <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--entity-name test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Completed updating config <span style="color:#66d9ef">for</span> user test.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查看用户</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@seagullcore01-uat-s2 kafka_2.13-3.3.2<span style="color:#f92672">]</span><span style="color:#75715e"># bin/kafka-configs.sh \</span>
</span></span><span style="display:flex;"><span>--bootstrap-server 192.168.0.161:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--describe <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-entity-type users <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--entity-name test 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SCRAM credential configs <span style="color:#66d9ef">for</span> user-principal <span style="color:#e6db74">&#39;test&#39;</span> are SCRAM-SHA-256<span style="color:#f92672">=</span>iterations<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>
</span></span></code></pre></div><p><font color=＃008B8B><strong>修改kafka配置文件并重启服务</strong></font></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;&gt;config/server.properties <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 添加以下配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sasl.enabled.mechanisms=SCRAM-SHA-256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 如果已有 SSL，可写 SASL_SSL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">security.inter.broker.protocol=SASL_PLAINTEXT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sasl.mechanism.inter.broker.protocol=SCRAM-SHA-256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listeners=SASL_PLAINTEXT://192.168.0.161:9092
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">advertised.listeners=SASL_PLAINTEXT://192.168.0.161:9092
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 用于集群成员间通讯
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listener.name.sasl_plaintext.scram-sha-256.sasl.jaas.config=\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  org.apache.kafka.common.security.scram.ScramLoginModule required \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  username=&#34;test&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  password=&#34;123456&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt;config/kafka_server_jaas.conf <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KafkaServer {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    org.apache.kafka.common.security.scram.ScramLoginModule required
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    username=&#34;test&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    password=&#34;123456&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">};
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export KAFKA_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-Djava.security.auth.login.config=config/kafka_server_jaas.conf&#34;</span>
</span></span><span style="display:flex;"><span>./bin/kafka-server-start.sh  config/server.properties
</span></span></code></pre></div><p><font color=＃008B8B><strong>修改filebeat配置启动密码认证</strong></font></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>filebeat.inputs:
</span></span><span style="display:flex;"><span>- type: filestream
</span></span><span style="display:flex;"><span>  enabled: true
</span></span><span style="display:flex;"><span>  paths:
</span></span><span style="display:flex;"><span>  - /var/log/messages
</span></span><span style="display:flex;"><span>output.kafka:
</span></span><span style="display:flex;"><span>  enabled: true
</span></span><span style="display:flex;"><span>  hosts: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.0.161:9092&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  username: test
</span></span><span style="display:flex;"><span>  password: <span style="color:#e6db74">&#39;123456&#39;</span>
</span></span><span style="display:flex;"><span>  sasl.mechanism: <span style="color:#e6db74">&#39;SCRAM-SHA-256&#39;</span>
</span></span><span style="display:flex;"><span>  topic: <span style="color:#e6db74">&#39;foobar&#39;</span>
</span></span><span style="display:flex;"><span>  required_acks: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  compression: gzip
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 1MB</span>
</span></span><span style="display:flex;"><span>  max_message_bytes: <span style="color:#ae81ff">1000000</span>
</span></span></code></pre></div><h3 id="acl鉴权">acl鉴权</h3>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-5408ed3211021d47e8c86495e76d3ace">Kafka 如何进行复制</h1>
	<div class="lead"><em>剖析kafka副本之间数据如何复制</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-11-10" class="text-body-secondary">Monday, November 10, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code></p>
<p>kafka版本：<code>2.13-3.3.2</code>  龙腾出行生产环境使用<code>2.11-2.2.0</code></p>
<hr>
<p><em>2011年初，美国领英公司（LinkedIn）开源了一款基础架构软件，以奥地利作家弗兰兹·卡夫卡（Franz Kafka）的名字命名，之后 LinkedIn将其贡献给 Apache基金会，随后该软件于2012年10月完成孵化并顺利晋升为Apache顶级项目——这便是大名鼎鼎的Apache Kafka</em></p>


</div>

<p>Kafka 组件订阅 Zookeeper 的 /brokers/ids 路径（broker 在 Zookeeper 上的注册路径），当有 broker 加入集群或退出集群时，这些组件就可以获得通知。</p>
<p><strong>控制器</strong>其实就是一个 broker，只不过它除了具有一般 broker 的功能之外，还负责分区首领的选举</p>
<p>集群里第一个启动的 broker 通过在Zookeeper 里创建一个临时节点 /controller 让自己成为控制器其他 broker 在启动时也会尝试创建这个节点，不过它们会收到一个“节点已存在”的异常，然后“意识”到控制器节点已存在，也就是说集群里已经有一个控制器了其他 broker 在控制器节点上创建Zookeeper watch 对象，这样它们就可以收到这个节点的变更通知。这种方式可以确保集群里一次只有一个控制器存在。</p>
<p>每个新选出的控制器通过 Zookeeper 的条件递增操作获得一个全新的、数值更大的 controller epoch。其他 broker 在知道当前 controller epoch 后，如果收到由控制器发出的包含较旧epoch 的消息，就会忽略它们。</p>
<p>Kafka 使用主题来组织数据，每个主题被分为若干个分区，每个分区有多个副本,副本有以下两种类型。</p>
<p><strong>首领副本</strong>每个分区都有一个首领副本。为了保证一致性，所有生产者请求和消费者请求都会经过这个副本。</p>
<p><strong>跟随者副本</strong>首领以外的副本都是跟随者副本。跟随者副本不处理来自客户端的请求，它们唯一的任务就是从首领那里复制消息，保持与首领一致的状态。如果首领发生崩溃，其中的一个跟随者会被提升为新首领。</p>
<p>为了与首领保持同步，跟随者向首领发送获取数据的请求，这种请求与消费者为了读取消息而发送的请求是一样的。请求消息里包含了跟随者想要获取消息的偏移量，而且这些偏移量总是有序的。</p>
<p>如果跟随者在 10s 内没有请求任何消息，或者虽然在请求消息，但在 10s 内没有请求最新的数据，那么它就会被认为是不同步的,通过<code>replica.lag.time.max.ms</code>参数来配置超时时长</p>
<p><strong>首选首领</strong>的主要目的是保证集群的负载均衡。除了当前首领之外，每个分区都有一个首选首领——创建主题时选定的首领就是分区的首</p>
<p>选首领，如果不是，并且该副本是同步的，那么就会触发首领选举，让首选首领成为当前首领。</p>
<p><code>auto.leader.rebalance.enable=true</code> 默认已开启</p>
<p><strong>元数据请求</strong>服务器端的响应消息里指明了这些主题所包含的分区、每个分区都有哪些副本，以及哪个副本是首领。元数据请求可以发送给任意一个 broker，因为所有 broker 都缓存了这些信息。</p>
<p>客户端会把这些信息缓存起来，并直接往目标 broker 上发送生产请求和获取请求。它们需要时不时地通过发送元数据请求来刷新这些信息（python客户端中通过 <code>metadata_max_age_ms</code>参数来配置）</p>
<p><strong>生产请求</strong> 通过<code>acks</code>参数broker确认消息的成功写入，在 Linux 系统上，消息会被写到文件系统缓存里，并不保证它们何时会被刷新到磁盘上</p>
<p><strong>获取请求</strong> broker按照批次向客户端响应数据，客户端同步配置 <code>fetch_min_bytes</code>和<code>fetch_max_wait_ms</code>参数来控制每个批次大小或批次间隔。同时在多副本中消费者只能消费所有ISR副本已经完成复制的消息（也就是kafka数据的高水位），既然有了高水位也就引出了主从分片间数据同步超时时间<code>replica.lag.time.max.ms</code>(超过该时长的副本会被leader partition从ISR列表中提出，从而减少对消费者进度造成影响)</p>
<pre class="mermaid">flowchart LR

	A(元数据请求)
	B(生产请求)
	C(获取请求)
	Z&gt;请求类型]
	Z -..-&gt; A
	Z -..-&gt; B
	Z -..-&gt; C


    style A fill:#bbf,stroke:#333,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style B fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style C fill:#bbf,stroke:#333,stroke-width:2px,color:#fff,stroke-dasharray: 5 5</pre>
<p>kafka 数据保留策略：</p>
<ul>
<li>
<p><code>log.dir</code> 确认数据保留位置</p>
</li>
<li>
<p><code>log.retention.hours = 168</code> 和 <code>log.retention.bytes = 1073741824</code> 确认数据保留的时长或大小。</p>
<p>数据文件按照片段保留数据默认1g（ <code>log.segment.bytes=1073741824</code> ）如果达到片段上限，就关闭当前文件，并打开一个新文件。当前正在写入数据的片段叫作活跃片段。活动片段永远不会被删除，所以如果你要保留数据 1 天(<code>log.retention.hours = 24</code>)，但片段里包含了 5 天的数据，那么这些数据会被保留 5 天</p>
<p>kafka 提供了工具查看片段中的内容:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/kafka/bin/kafka-dump-log.sh --files 00000000000000000504.log |less
</span></span></code></pre></div></li>
</ul>
<p>JMX 全称为 Java Management Extensions，用来管理和监测 Java 程序。最常用到的就是对于 JVM 的监测和管理，比如 JVM 内存、CPU 使用率、线程数、垃圾收集情况等等。另外，还可以用作日志级别的动态修改，比如 log4j 就支持 JMX 方式动态修改线上服务的日志级别.</p>
<p>JMX是一个标准接口，不但可以用于管理JVM，还可以管理应用程序自身。下图是JMX的架构</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    ┌─────────┐  ┌─────────┐
</span></span><span style="display:flex;"><span>    │jconsole │  │   Web   │
</span></span><span style="display:flex;"><span>    └─────────┘  └─────────┘
</span></span><span style="display:flex;"><span>         │            │
</span></span><span style="display:flex;"><span>┌ ─ ─ ─ ─│─ ─ ─ ─ ─ ─ ┼ ─ ─ ─ ─
</span></span><span style="display:flex;"><span> JVM     ▼            ▼        │
</span></span><span style="display:flex;"><span>│   ┌─────────┐  ┌─────────┐
</span></span><span style="display:flex;"><span>  ┌─┤Connector├──┤ Adaptor ├─┐ │
</span></span><span style="display:flex;"><span>│ │ └─────────┘  └─────────┘ │
</span></span><span style="display:flex;"><span>  │       MBeanServer        │ │
</span></span><span style="display:flex;"><span>│ │ ┌──────┐┌──────┐┌──────┐ │
</span></span><span style="display:flex;"><span>  └─┤MBean1├┤MBean2├┤MBean3├─┘ │
</span></span><span style="display:flex;"><span>│   └──────┘└──────┘└──────┘
</span></span><span style="display:flex;"><span> ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-3f35b0366995d1b427499856875e611b">kafka_exporter</h1>
	<div class="lead"><em>通过kafka-exporter监控broker、producer、consumer</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-12" class="text-body-secondary">Friday, September 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code></p>
<p>kafka版本：<code>3.3.2</code></p>
<hr>
<p><em>2011年初，美国领英公司（LinkedIn）开源了一款基础架构软件，以奥地利作家弗兰兹·卡夫卡（Franz Kafka）的名字命名，之后 LinkedIn将其贡献给 Apache基金会，随后该软件于2012年10月完成孵化并顺利晋升为Apache顶级项目——这便是大名鼎鼎的Apache Kafka</em></p>


</div>

<h3 id="kafka_"><strong>kafka_exporter</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/danielqsj/kafka_exporter/releases/download/v1.9.0/kafka_exporter-1.9.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf kafka_exporter-1.9.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mv kafka_exporter-1.9.0.linux-amd64/kafka_exporter /usr/bin/kafka_exporter 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/kafka_exporter.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=kafka_exporter service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/danielqsj/kafka_exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/kafka_exporter \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=&#34;:9309&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kafka.server=192.168.0.151:9092 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kafka.server=192.168.0.152:9092 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kafka.server=192.168.0.153:9092
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 监控有密码认证的kafka
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#--sasl.enabled \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#--sasl.username=filebeat \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#--sasl.password=ZmlsZWJlYXRAMjAyNgo= \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#--sasl.mechanism=scram-sha256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload 
</span></span><span style="display:flex;"><span>systemctl enable kafka_exporter --now 
</span></span><span style="display:flex;"><span>systemctl status kafka_exporter
</span></span></code></pre></div><p>grafna 报表id <code>21078</code></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">指标名称</th>
          <th style="text-align: left">指标含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><code>kafka_consumergroup_lag</code></td>
          <td style="text-align: left"><strong>消费者组的滞后消息数</strong>，即消息积压量</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_consumergroup_members</code></td>
          <td style="text-align: left">消费者组中成员数量</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_consumergroup_current_offset</code></td>
          <td style="text-align: left">消费者组在当前分区的最新提交偏移量</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_topic_partition_current_offset</code></td>
          <td style="text-align: left">主题分区在Broker上的最新消息偏移量（生产者偏移）</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_brokers</code></td>
          <td style="text-align: left">Kafka集群中的代理（Broker）数量</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_broker_info</code></td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_topic_partitions</code></td>
          <td style="text-align: left">指定主题的分区数量</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_topic_partition_replicas</code></td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_topic_partition_in_sync_replica</code></td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>process_cpu_seconds_total</code></td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>process_max_fds</code></td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>process_open_fds</code></td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>process_start_time_seconds</code></td>
          <td style="text-align: left"></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kafka</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">KAFKA_brokers异常</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">kafka_broker_info != 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">2m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.name }}当前brokers异常：{{ $labels.address }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">电商生产KAFKA消息整体积压</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">sum(kafka_consumergroup_lag_sum{job=&#34;kafka-exporter&#34;}) by (name,consumergroup, topic)&gt;5000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">2m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;【环境】{{ $labels.name }}\n【消费组】{{ $labels.consumergroup }}\n【topic】{{ $labels.topic }}【积压】：{{ $value | printf \&#34;%.2f\&#34; }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">电商生产KAFKA消息分区积压</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">(sum(kafka_consumergroup_lag{job=&#34;kafka-exporter&#34;}) by (name,consumergroup, topic, partition)&gt;1500) AND ON() (hour()+8)%24 &gt;= 7 &lt;= 21</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">3m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;【环境】{{ $labels.name }}\n【消费组】{{ $labels.consumergroup }}\n【topic】{{$labels.topic}}【分区】{{ $labels.partition }}【积压】：{{ $value | printf \&#34;%.2f\&#34; }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">电商生产KAFKA分区数过多</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">sum by(name)(kafka_topic_partitions{job=&#34;kafka-exporter&#34;,topic !~&#34;__.*&#34;})&gt;1500</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">2m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.name }}当前分区数：{{ $value | printf \&#34;%.2f\&#34; }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">电商生产KAFKA_brokers丢失</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">kafka_brokers{job=&#34;kafka-exporter&#34;} &lt; 3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">2m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.name }}当前brokers数：{{ $value | printf \&#34;%.2f\&#34; }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">电商生产KAFKA_TopicsReplicas</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">sum(kafka_topic_partition_in_sync_replica{job=&#34;kafka-exporter&#34;}) by (name,topic) &lt;1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">2m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.name }} Kafka topic in-sync partition：{{ $value | printf \&#34;%.2f\&#34; }}&#34;</span>
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-25e990c22a9d5ff7c6e251af66967092">kafka可视化管理工具</h1>
	<div class="lead"><em>如何可视化管理kafka,给开发使用</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-12" class="text-body-secondary">Friday, September 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code></p>
<p>kafka版本：<code>3.3.2</code></p>
<hr>
<p><em>2011年初，美国领英公司（LinkedIn）开源了一款基础架构软件，以奥地利作家弗兰兹·卡夫卡（Franz Kafka）的名字命名，之后 LinkedIn将其贡献给 Apache基金会，随后该软件于2012年10月完成孵化并顺利晋升为Apache顶级项目——这便是大名鼎鼎的Apache Kafka</em></p>


</div>

<ul>
<li>
<p><a href="https://github.com/yahoo/CMAK.git" target="_blank">雅虎开源的kafka管理工具CMAK</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export ZK_HOSTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181&#34;</span>
</span></span><span style="display:flex;"><span>wget https://github.com/yahoo/CMAK/releases/download/3.0.0.6/cmak-3.0.0.6.zip
</span></span><span style="display:flex;"><span>unzip cmak-3.0.0.6.zip
</span></span><span style="display:flex;"><span>cmak-3.0.0.6/bin/cmak
</span></span></code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">启动报错</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>025-10-13 10:11:20,623 - <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> k.m.KafkaManager - Failed on input : KMAddCluster<span style="color:#f92672">(</span>ClusterConfig<span style="color:#f92672">(</span>demo,CuratorConfig<span style="color:#f92672">(</span>192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181,10,100,1000<span style="color:#f92672">)</span>,true,3.1.0,false,None,None,false,false,true,true,false,false,Some<span style="color:#f92672">(</span>ClusterTuning<span style="color:#f92672">(</span>Some<span style="color:#f92672">(</span>30<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>100<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>100<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>100<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>30<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>5<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>4<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>1000<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>4<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>1000<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>4<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>1000<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>30000<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>1000000<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>7<span style="color:#f92672">)))</span>,PLAINTEXT,None,None<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>org.apache.zookeeper.KeeperException$UnimplementedException: KeeperErrorCode <span style="color:#f92672">=</span> Unimplemented <span style="color:#66d9ef">for</span> /kafka-manager/mutex
</span></span><span style="display:flex;"><span>        at org.apache.zookeeper.KeeperException.create<span style="color:#f92672">(</span>KeeperException.java:106<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.zookeeper.KeeperException.create<span style="color:#f92672">(</span>KeeperException.java:54<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.zookeeper.ZooKeeper.create<span style="color:#f92672">(</span>ZooKeeper.java:1538<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.utils.ZKPaths.mkdirs<span style="color:#f92672">(</span>ZKPaths.java:291<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl$11.call<span style="color:#f92672">(</span>CreateBuilderImpl.java:746<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl$11.call<span style="color:#f92672">(</span>CreateBuilderImpl.java:723<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.RetryLoop.callWithRetry<span style="color:#f92672">(</span>RetryLoop.java:109<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl.pathInForeground<span style="color:#f92672">(</span>CreateBuilderImpl.java:720<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl.protectedPathInForeground<span style="color:#f92672">(</span>CreateBuilderImpl.java:484<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl.forPath<span style="color:#f92672">(</span>CreateBuilderImpl.java:474<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2025-10-13 10:11:20,623 - <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> k.m.ApiError$ - error : KeeperErrorCode <span style="color:#f92672">=</span> Unimplemented <span style="color:#66d9ef">for</span> /kafka-manager/mutex
</span></span><span style="display:flex;"><span>org.apache.zookeeper.KeeperException$UnimplementedException: KeeperErrorCode <span style="color:#f92672">=</span> Unimplemented <span style="color:#66d9ef">for</span> /kafka-manager/mutex
</span></span><span style="display:flex;"><span>        at org.apache.zookeeper.KeeperException.create<span style="color:#f92672">(</span>KeeperException.java:106<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.zookeeper.KeeperException.create<span style="color:#f92672">(</span>KeeperException.java:54<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.zookeeper.ZooKeeper.create<span style="color:#f92672">(</span>ZooKeeper.java:1538<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.utils.ZKPaths.mkdirs<span style="color:#f92672">(</span>ZKPaths.java:291<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl$11.call<span style="color:#f92672">(</span>CreateBuilderImpl.java:746<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl$11.call<span style="color:#f92672">(</span>CreateBuilderImpl.java:723<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.RetryLoop.callWithRetry<span style="color:#f92672">(</span>RetryLoop.java:109<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl.pathInForeground<span style="color:#f92672">(</span>CreateBuilderImpl.java:720<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl.protectedPathInForeground<span style="color:#f92672">(</span>CreateBuilderImpl.java:484<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl.forPath<span style="color:#f92672">(</span>CreateBuilderImpl.java:474<span style="color:#f92672">)</span>
</span></span></code></pre></div><p><strong>解决办法</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建 kafka-manager 基础路径</span>
</span></span><span style="display:flex;"><span>create /kafka-manager <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>create /kafka-manager/mutex <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>create /kafka-manager/mutex/locks <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>create  /kafka-manager/mutex/leases <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div>

</div>

</li>
<li>
<p><a href="https://github.com/didi/KnowStreaming.git" target="_blank">滴滴开源的kafka管理工具</a></p>
</li>
<li>
<p><a href="https://www.kafkatool.com/download.html" target="_blank">Offset Explorer (kafkatool.com)</a></p>
</li>
</ul>

</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9faafc121020cd39ed50e11e26aaa6b3">8 - </h1>
    
	<p>RabbitMQ安装、集群</p>
<p>安全</p>
<p>监控</p>
<p>学习前3章</p>
<p>AMQP advanced message queuing protocol 2004公布协议标准</p>
<p>交换机 exchange</p>
<p>队列 queue</p>
<p>绑定</p>
<p>虚拟机 vhost： 是一个迷你版的rabbitMQ，可以隔离队列、交换机、绑定以及权限。默认vhost 为 “/“</p>
<p>rabbitmqctl add_vhost test</p>
<p>rabbitmqctl list_vhost test</p>
<p>rabbitmqctl delete_vhost test</p>
<p>消息持久化</p>
<ul>
<li>
<p>交换机和队列同时开启持久化参数durable = true</p>
</li>
<li>
<p>消息投递时开启持久化参数 delivery_mode=2</p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c9fd25539bbddcf7221fed520f3d1a93">快速开始</h1>
	
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">内容概要</h4>

    <ul>
<li>什么是rabbitMQ</li>
<li>安装单机版本rabbitMQ</li>
<li>python 编写demo</li>
</ul>


</div>

<hr>
<p>RabbitMQ 是一个开源的消息中间件（Message Broker），实现了 AMQP（Advanced Message Queuing Protocol） 协议，同时也支持 STOMP、MQTT 等协议。它用于在分布式系统中异步传递消息，解决系统间解耦、削峰、异步处理等问题。</p>
<p><strong>RabbitMQ 的核心概念</strong></p>
<table>
  <thead>
      <tr>
          <th>概念</th>
          <th>说明</th>
          <th>类比</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>Producer</code></td>
          <td>生产者发送消息到 RabbitMQ 的应用程序。</td>
          <td>寄快递的人</td>
      </tr>
      <tr>
          <td><code>Consumer</code></td>
          <td>消费者从队列中接收并处理消息的程序。</td>
          <td>收快递的人</td>
      </tr>
      <tr>
          <td><code>Queue</code></td>
          <td>存储消息的缓冲区，消息在这里等待被消费。</td>
          <td>快递柜</td>
      </tr>
      <tr>
          <td><a href="#exchange_type"><code>Exchange</code></a></td>
          <td>接收生产者消息，根据规则路由到一个或多个队列。</td>
          <td>快递分拣中心</td>
      </tr>
      <tr>
          <td><code>Routing Key</code></td>
          <td>生产者发送消息时指定的“地址”，用于匹配绑定的规则。</td>
          <td>快递上的地址</td>
      </tr>
      <tr>
          <td><code>Binding</code></td>
          <td>定义 Exchange 和 Queue 之间的关系，包含路由规则。</td>
          <td>快递分拣规则</td>
      </tr>
      <tr>
          <td><code>Channel</code></td>
          <td>轻量级连接，复用 TCP 连接，减少资源消耗。</td>
          <td>快递员的送货路线</td>
      </tr>
      <tr>
          <td><code>Virtual Host</code></td>
          <td>逻辑隔离的命名空间，类似数据库的 schema。</td>
          <td>不同快递公司的仓库</td>
      </tr>
  </tbody>
</table>
<hr>
<span id="exchange_type" />
<p>常见 Exchange 类型</p>
<table>
  <thead>
      <tr>
          <th>类型</th>
          <th>描述</th>
          <th>场景</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>Direct</code></td>
          <td>精确匹配 routing key。</td>
          <td>日志级别分发（error、info、warn）。</td>
      </tr>
      <tr>
          <td><code>Fanout</code></td>
          <td>广播消息到所有绑定队列，忽略 routing key。</td>
          <td>群发通知。</td>
      </tr>
      <tr>
          <td><code>Topic</code></td>
          <td>模糊匹配 routing key（支持通配符 <code>*</code> 和 <code>#</code>）。</td>
          <td>多维度日志分类。</td>
      </tr>
      <tr>
          <td><code>Headers</code></td>
          <td>基于消息头（headers）匹配，少用。</td>
          <td>复杂规则匹配。</td>
      </tr>
  </tbody>
</table>
<hr>
<h3 id="单机部署">单机部署</h3>
<table>
  <thead>
      <tr>
          <th>软件</th>
          <th>版本</th>
          <th>端口</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>erlang</td>
          <td>26.2</td>
          <td></td>
      </tr>
      <tr>
          <td>rabbitMQ</td>
          <td>3.12.10、4.1.3</td>
          <td>提供给客户端连接 <code>5672</code>   浏览器管理<code>15672</code>  集群内部通讯 <code>25672</code></td>
      </tr>
  </tbody>
</table>
<p><strong>第一步：安装erlang依赖</strong></p>
<blockquote>
<p>erlang 环境可以将其理解为运行java程序时的jre 环境</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install make gcc gcc-c++ perl ncurses-devel
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/erlang/otp.git <span style="color:#f92672">&amp;&amp;</span> cd otp/
</span></span><span style="display:flex;"><span>git checkout maint-26
</span></span><span style="display:flex;"><span>git reset --hard OTP-26.2
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./configure --prefix /opt/erlang
</span></span><span style="display:flex;"><span>make -j <span style="color:#ae81ff">8</span> 
</span></span><span style="display:flex;"><span>make install 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 26.2 是erlang软件的版本，这里看到的14.2是erlang内部运行时系统的版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@seagullcore01-uat-s2 rabbitmq_server-3.12.10<span style="color:#f92672">]</span><span style="color:#75715e"># /opt/erlang/bin/erl -version</span>
</span></span><span style="display:flex;"><span>Erlang <span style="color:#f92672">(</span>SMP,ASYNC_THREADS<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>BEAM<span style="color:#f92672">)</span> emulator version 14.2
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span>/opt/erlang/bin:$PATH
</span></span></code></pre></div><p><strong>第二步：安装rabbitMQ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://mirrors.huaweicloud.com/rabbitmq-server/v3.12.10/rabbitmq-server-generic-unix-3.12.10.tar.xz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf rabbitmq-server-generic-unix-3.12.10.tar.xz -C /opt
</span></span><span style="display:flex;"><span>ln -svf /opt/rabbitmq_server-3.12.10 /opt/rabbitmq
</span></span></code></pre></div><p>启动</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">管理插件</h4>

    <p>3.12.10版本没有自带管理页面，因此需要提前启用该plugins</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/rabbitmq/sbin/rabbitmq-plugins enable rabbitmq_management
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 启动rabbitMQ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 日志文件：/opt/rabbitmq/var/log/rabbitmq/rabbit@seagullcore01-uat-s2.log</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 数据文件：/opt/rabbitmq/var/lib/rabbitmq/mnesia/rabbit@seagullcore01-uat-s2</span>
</span></span><span style="display:flex;"><span>/opt/rabbitmq/sbin/rabbitmq-server -detached
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看rabbtiMQ状态 </span>
</span></span><span style="display:flex;"><span>/opt/rabbitmq/sbin/rabbitmqctl status
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 停止rabbitMQ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /opt/rabbitmq/sbin/rabbitmqctl shutdown</span>
</span></span></code></pre></div><p>创建管理员用户<code>admin</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># /opt/rabbitmq//sbin/rabbitmqctl delete_user admin</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>/opt/rabbitmq//sbin/rabbitmqctl add_user admin
</span></span><span style="display:flex;"><span> /opt/rabbitmq//sbin/rabbitmqctl change_password admin admin
</span></span><span style="display:flex;"><span>/opt/rabbitmq//sbin/rabbitmqctl set_user_tags admin administrator
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 授予 / vhost的所有权限，给admin 用户</span>
</span></span><span style="display:flex;"><span>/opt/rabbitmq/sbin/rabbitmqctl set_permissions -p / admin <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span>
</span></span><span style="display:flex;"><span>/opt/rabbitmq/sbin/rabbitmqctl set_permissions -p test admin <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span><span style="color:#75715e"># /opt/rabbitmq/sbin/rabbitmqctl list_users</span>
</span></span><span style="display:flex;"><span>Listing users ...
</span></span><span style="display:flex;"><span>user    tags
</span></span><span style="display:flex;"><span>admin   <span style="color:#f92672">[</span>administrator<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>guest   <span style="color:#f92672">[</span>administrator<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span><span style="color:#75715e"># /opt/rabbitmq/sbin/rabbitmqctl list_permissions -p /</span>
</span></span><span style="display:flex;"><span>Listing permissions <span style="color:#66d9ef">for</span> vhost <span style="color:#e6db74">&#34;/&#34;</span> ...
</span></span><span style="display:flex;"><span>user    configure       write   read
</span></span><span style="display:flex;"><span>guest   .*      .*      .*
</span></span><span style="display:flex;"><span>admin   .*      .*      .*
</span></span></code></pre></div><hr>
<h3 id="配置rabbitmq">配置rabbitmq</h3>
<p>通过上面启动示例，rabbitmq 启动时并没有指定配置文件。如果我们希望做一些定制化的参数修改可以在<code>/opt/rabbitmq/etc/rabbitmq/</code> 目录中创建 <code>rabbitmq.config</code>配置文件</p>
<blockquote>
<p>查看运行时配置: <code>/opt/rabbitmq/sbin/rabbitmq-diagnostics environment</code></p>
</blockquote>
<ul>
<li>
<p>修改端口和内存限制</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/opt/rabbitmq/etc/rabbitmq/rabbitmq.conf <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 网络配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listeners.tcp.default = 0.0.0.0:5672
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 资源限制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 允许使用总内存的40%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#vm_memory_high_watermark.relative = 0.4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 允许使用1G内存
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vm_memory_high_watermark.absolute = 1073741824
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>修改数据文件和日志文件路径</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /data/rabbitmq/<span style="color:#f92672">{</span>mnesia,logs<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#chown -R rabbitmq:rabbitmq /data/rabbitmq</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt;/opt/rabbitmq/etc/rabbitmq/rabbitmq-env.conf<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 数据目录（Mnesia 数据库、消息存储等）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RABBITMQ_MNESIA_BASE=/data/rabbitmq/mnesia
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 日志目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RABBITMQ_LOG_BASE=/data/rabbitmq/logs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
</ul>
<ol>
<li>声明交换机 <code>exchange.declare</code></li>
<li>声明队列 <code>queue.declare</code></li>
<li>队列绑定到交换机 <code>queue.bind</code></li>
</ol>

</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fd72358146a710880fd761142ab540c9">9 - </h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="联系我" aria-label="联系我">
    <a target="_blank" rel="noopener" href="/about/#%e8%81%94%e7%b3%bb%e6%96%b9%e5%bc%8f" aria-label="联系我">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="微信" aria-label="微信">
    <a target="_blank" rel="noopener" href="/about/#%e8%81%94%e7%b3%bb%e6%96%b9%e5%bc%8f" aria-label="微信">
      <i class="fa-brands fa-weixin"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">零露云©2025版权所有</span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.bf0cab613e991fc11bc28a4a07b0aedef47c7c7c2595703ac3adf962fd6a8099.js" integrity="sha256-vwyrYT6ZH8EbwopKB7Cu3vR8fHwllXA6w635Yv1qgJk=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
