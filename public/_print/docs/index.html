<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://zero-dew.netlify.app/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://zero-dew.netlify.app/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>文档中心 | 零露云</title>
<meta name="description" content="山不却垒土之功，故能成其高；
海不避涓涓细流，故能成其大。">
<meta property="og:url" content="https://zero-dew.netlify.app/docs/">
  <meta property="og:site_name" content="零露云">
  <meta property="og:title" content="文档中心">
  <meta property="og:description" content="山不却垒土之功，故能成其高；
海不避涓涓细流，故能成其大。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="文档中心">
  <meta itemprop="description" content="山不却垒土之功，故能成其高；
海不避涓涓细流，故能成其大。">
  <meta itemprop="datePublished" content="2026-01-11T00:00:00+00:00">
  <meta itemprop="dateModified" content="2026-01-11T00:00:00+00:00">
  <meta itemprop="wordCount" content="2">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="文档中心">
  <meta name="twitter:description" content="山不却垒土之功，故能成其高；
海不避涓涓细流，故能成其大。">
<link rel="preload" href="/scss/main.min.18c08ee35308968138c55945e86231cae563e39470a6efcb36f516f6b21b6a02.css" as="style" integrity="sha256-GMCO41MIloE4xVlF6GIxyuVj45Rwpu/LNvUW9rIbagI=" crossorigin="anonymous">
<link href="/scss/main.min.18c08ee35308968138c55945e86231cae563e39470a6efcb36f516f6b21b6a02.css" rel="stylesheet" integrity="sha256-GMCO41MIloE4xVlF6GIxyuVj45Rwpu/LNvUW9rIbagI=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">零露云</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/about"><i class="fa-solid fa-house"></i><span>关于</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/docs"><i class="fa-solid fa-book"></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/blog"><i class="fa-solid fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/google/docsy/" target="_blank" rel="noopener"><i class='fa-brands fa-github'></i><span></span></a>
      </li>
      <li class="td-light-dark-menu nav-item dropdown">
        <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
  <symbol id="check2" viewBox="0 0 16 16">
    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
  </symbol>
  <symbol id="circle-half" viewBox="0 0 16 16">
    <path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/>
  </symbol>
  <symbol id="moon-stars-fill" viewBox="0 0 16 16">
    <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
    <path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/>
  </symbol>
  <symbol id="sun-fill" viewBox="0 0 16 16">
    <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
  </symbol>
</svg>

<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center"
        id="bd-theme"
        type="button"
        aria-expanded="false"
        data-bs-toggle="dropdown"
        data-bs-display="static"
        aria-label="Toggle theme (auto)">
  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg>
</button>
<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#sun-fill"></use></svg>
      Light
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"></use></svg>
      Dark
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
      <svg class="bi me-2 opacity-50"><use href="#circle-half"></use></svg>
      Auto
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
</ul>

      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.a779bd279239ad7d8c03caec2282ddc3.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="25"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">文档中心</h1>





    <ul>
    
  
  
  
  

  
    
    
	

    <li><a href="#pg-1910481f80a466f934fdc89c9141f0d1"></a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-d14a3b965d9b8088d7b0b18e93bd6282">hugo 工具</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-f341a40c2b0c953031f7747d0ed7bccd">shortcode</a></li>


    
  
    
    
	
<li>1.3: <a href="#pg-fc299664a98179afc2f231a070879a49">时钟和天气</a></li>


    
  
    
    
	
<li>1.4: <a href="#pg-5f5229a28caafe4fb0c5638f4bde7484">图床工具</a></li>


    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-11f98d6e9161e47829b0f9c66e7d3eab"></a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-b21cef90d38e157d83247a3e5fbb37b1">环境搭建</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-c3188cc99ff9218efbcfa8aa68cadd56">kubeadm环境搭建</a></li>



    
  
    
    
	

    <li><a href="#pg-eca395938eb773382579cec33e1f3ce5">kubeaz环境搭建</a></li>



    
  
    
    
	

    <li><a href="#pg-5c10bf9a703182f522d9ebb359005d06">kubeadm工具</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-dd7941a6270f9943e10317dd4ce21b21">etcd</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-6757bf3544222965ccef5d381b5403b3">etcd</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-4ce3ee82b87425866c30064e2fe818d1">coredns</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-6f870bba994b1b821803cd715828f8ab">快速开始</a></li>



    
  
    
    
	

    <li><a href="#pg-d11a373a06597e58266f084a9f1fdd5a">基础插件</a></li>



    
  
    
    
	

    <li><a href="#pg-d6e10aa56c3961e7ad7d849aacfab3cd">示例</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-0e13b09fa49eb36f4aa92da86316e142">serviceless</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-f5cae64815306b93313fe5895c3a2356">appolo</a></li>



    
  
    
    
	

    <li><a href="#pg-1cdf62915ca26163127e89c641cd248c">nacos</a></li>



    
  
    
    
	

    <li><a href="#pg-06d2f0f41ee04d596dec7e89e00984b3">dubbo</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-66884a4a655d39b27854970cab32611a">Ingress</a></li>



    
  
    
    
	

    <li><a href="#pg-2edba2c1f66b93237c4b506cd72afb66">Hpa</a></li>



    
  
    
    
	

    <li><a href="#pg-2e948d266023dafd4653deef64951b82">RBAC实践</a></li>



    
  
    
    
	

    <li><a href="#pg-063e043514cff8f2d2dd97614abf8168">sriov</a></li>



    
  
    
    
	

    <li><a href="#pg-c38bfc2197bb43631ae6342438e8e031">dashboard</a></li>



    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-8da20eaf4a37cf2e2b8da8804cb927e7"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-7a3994c6b4d24a86bf72f3809febdaeb">ELK</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-2970ad726135b6520ed814ee01e5ce24">kibana</a></li>



    
  
    
    
	
<li>3.1.2: <a href="#pg-f1b87c7ae6c9da4a7e1f6f0e6bd35a51">filebeat</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-7f1952ab27641fd069c1c88a62d2ff1b">filebeat_install</a></li>



    
  
    
    
	
<li>3.1.2.2: <a href="#pg-4a5a9fd6df7d5d4fb4e086d2cb64f014">config</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1.2.2.1: <a href="#pg-f2caea531a3ea24ebe8dbad2309c1375">通用配置</a></li>


    
  
    
    
	
<li>3.1.2.2.2: <a href="#pg-a46b543e3d8a01cd19ad4825c7503d9c">filebeat_inputs</a></li>


    
  
    
    
	
<li>3.1.2.2.3: <a href="#pg-0913be866ef74da65568b4fc853dba4f">扩展配置</a></li>


    
  
    
    
	

    <li><a href="#pg-227f470a0c5173ec7bf9f53ce8c25f13">filebeat_output</a></li>



    
  
    
    
	

    <li><a href="#pg-351dbe8af926b8ca2d59ea7c4aa1f9e8">filebeat_processors</a></li>



    
  
    
    
	

    <li><a href="#pg-4f0c7d5f2d4d7c2f7a8f6d626bcc40a0">filebeat_autodiscover</a></li>



    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>3.1.3: <a href="#pg-f1ee3803d3307ddce7d45e950c702fe9">logstash</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-1118f37e282b1f000d6ebbf259286d13">logstash_install</a></li>



    
  
    
    
	

    <li><a href="#pg-a1725c220824bf5195e849bc4136f881">logstash-input</a></li>



    
  
    
    
	

    <li><a href="#pg-5f3628e70e31bf85b61b399a02603abb">logstash-output</a></li>



    
  
    
    
	

    <li><a href="#pg-661fea39a83a2a82899e5e5ac2a6108c">logstash-filter</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-b6ffb1adcf9657142fa7b1e7673d5360">收集nginx日志</a></li>



    
  
    
    
	

    <li><a href="#pg-756092d38de03bd5359baff0af077343">收集操作系统日志</a></li>



    
  

    </ul>
    
  
    
    
	
<li>3.2: <a href="#pg-fdae7a6f05f611b1e476fea05daecc00">grafana</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.2.1: <a href="#pg-ef8f9704dcbc2f6ec4e012b9ac9e891f">quitstart</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3.3: <a href="#pg-cfdc302ad63fe20042c868c382ad0403">prometheus</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.3.1: <a href="#pg-863efec26236baab21735f111ba52bf3">install</a></li>


    
  
    
    
	
<li>3.3.2: <a href="#pg-cbf04b1f9c33b34119d6b5481bfb28c0">operator</a></li>


    
  
    
    
	
<li>3.3.3: <a href="#pg-8dd2a702f5ca9e0b663fa00c19f6ce84">config</a></li>


    
  
    
    
	
<li>3.3.4: <a href="#pg-05ff6cc9cc00a9f65de4bbb0f9434aeb">kubernetes_sd_configs</a></li>


    
  
    
    
	
<li>3.3.5: <a href="#pg-882797a566a6d870802dfa95b7787f8a">consul_sd_configs</a></li>


    
  
    
    
	
<li>3.3.6: <a href="#pg-be6a851a8907242be24193da43e763a0">PromeQL</a></li>


    
  
    
    
	
<li>3.3.7: <a href="#pg-f429588e5a52c95dd5bec002541ac0aa">夜莺·监控系统</a></li>


    
  
    
    
	
<li>3.3.8: <a href="#pg-fc27d5a38407c7add3b1bb091b945197">federation</a></li>


    
  
    
    
	
<li>3.3.9: <a href="#pg-c6ca951d0441de2c3fbff37db4cd100a">附录</a></li>


    
  
    
    
	
<li>3.3.10: <a href="#pg-d5033e8c9a46dd0403d5bde3fa28069c">exporter</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.3.10.1: <a href="#pg-624d0b59238886cb73ea365101d34bb0">node_exporter</a></li>


    
  
    
    
	
<li>3.3.10.2: <a href="#pg-d2d65a85ce96b5d2e1c53c6332d4b35d">blackbox</a></li>


    
  
    
    
	
<li>3.3.10.3: <a href="#pg-f2088b66d721f30cecd45b9172151883">jmx_exporter</a></li>


    
  
    
    
	
<li>3.3.10.4: <a href="#pg-5d8b8cd5776ff486cdacaf0443afe506">nginx-exporter</a></li>


    
  
    
    
	
<li>3.3.10.5: <a href="#pg-a91649f35c1611e400ba18dd4dfe3c9a">minio</a></li>


    
  
    
    
	
<li>3.3.10.6: <a href="#pg-ab1b654ca9a964046d54e4a76701e2bc">redis-exporter</a></li>


    
  
    
    
	
<li>3.3.10.7: <a href="#pg-31569474fbadc76b9e8fdcd9f370ea84">mysql-exporter</a></li>


    
  
    
    
	
<li>3.3.10.8: <a href="#pg-b668d0cb90e19dfdc045d5bb7bc1a106">mongo-exporter</a></li>


    
  
    
    
	
<li>3.3.10.9: <a href="#pg-12149c930cfe1dac8487f4da8d8be7d2">prometheus-sdk</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3.3.11: <a href="#pg-b0b1ba15faa9a6ebeb9137c6c9e73f6a">alertmanager</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.3.11.1: <a href="#pg-cdd3077d065775a419d9597d5a6c38ba">部署alertmanager</a></li>


    
  
    
    
	
<li>3.3.11.2: <a href="#pg-24c9374cc0495f3c971a09cf688a7112">配置alertmanager</a></li>


    
  
    
    
	
<li>3.3.11.3: <a href="#pg-c5c6014e5263533687c85e13e12dcd41">amtool</a></li>


    
  
    
    
	

    <li><a href="#pg-1ecaff05acb725a9eaabec72c0c0fa35">告警收敛</a></li>



    
  

    </ul>
    
  
    
    
	
<li>3.3.12: <a href="#pg-3c434868253797ecc1f1e40600c22b80">monitor</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.3.12.1: <a href="#pg-8d14d03086c49edb38caab12c6d62a82">prometheus</a></li>


    
  
    
    
	
<li>3.3.12.2: <a href="#pg-5605bee91439f7db78272ae6244fd177">alertmanager</a></li>


    
  
    
    
	
<li>3.3.12.3: <a href="#pg-8fb98d401496b16c1a7d7ad67b7b3bb1">pushgateway</a></li>


    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-09903d68b7f1b7714677112922b831b4">victorametrics</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.3.13.1: <a href="#pg-8c8d43a049d000cfadffd58670f39f1e">victoriaMetrics</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3.3.14: <a href="#pg-bfa75dc49b199dd86701654b7a8dd70f">kubernetes</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.3.14.1: <a href="#pg-25b4a44cfb54668617235e697b78af35">kube-apiserver</a></li>


    
  
    
    
	
<li>3.3.14.2: <a href="#pg-7bb3b9db4f2ef41eaaf1bbd09fa2e996">kube-controller</a></li>


    
  
    
    
	
<li>3.3.14.3: <a href="#pg-e3a8bfe7e2de471dc46cdfcd846b0686">kube-controller</a></li>


    
  
    
    
	
<li>3.3.14.4: <a href="#pg-b2a97e471d481fe1bb9c8b592ca62eab">kube-proxy</a></li>


    
  
    
    
	
<li>3.3.14.5: <a href="#pg-92571de61259ce57bcb0c1a9e852b932">kubelet</a></li>


    
  
    
    
	
<li>3.3.14.6: <a href="#pg-31806350774a7c031b15b5c616430c3e">etcd</a></li>


    
  
    
    
	
<li>3.3.14.7: <a href="#pg-5cb338fcb7d2487aba8e3851f63fe4e9">coredns</a></li>


    
  
    
    
	
<li>3.3.14.8: <a href="#pg-8e244531e3aa17ff54cd0173cf6f4016">cadvisor</a></li>


    
  
    
    
	
<li>3.3.14.9: <a href="#pg-0f8ec29a41b1721d7cd9fe76cf6dc070">kube-state-metrics</a></li>


    
  

    </ul>
    
  

    </ul>
    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-85678841c2799ee0263a00ba7f20650b"></a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-652da66038de8db9de90975a7d28f264">ArgoCD</a></li>



    
  
    
    
	

    <li><a href="#pg-57d91b933c05dbf4df1f70a14c3ca6cf"></a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-397d2bc7c55645a7a639502d8299f63e">jenkins</a></li>



    
  
    
    
	

    <li><a href="#pg-e70e4767203973da4f764db10a25a174">Groovy</a></li>



    
  
    
    
	

    <li><a href="#pg-277dce042328e5428c35cce84a8879d0">最佳实践</a></li>



    
  
    
    
	
<li>4.2.4: <a href="#pg-c5f5608a160b96f6156ab9b2314910a0"></a></li>


    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-7ce15bd88923cb2e5537446987acf846"></a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-4f10deba18f8d41941436cd61400206f">sonarqube</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-17d758a8d89013ee2076a8dd028cf84b"></a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-8e6de4f3d030c0a6cc8e5398fdcee5f6">gitlab</a></li>



    
  
    
    
	

    <li><a href="#pg-8afbf6f159cf24c2fc7f40f4cf6afc70">ci/cd</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-4572c2ec7409e33797ae2a1657dd1e52"></a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-6135d11c82eb95bad75696659564e90f">redmine</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-1702e0a177bcb438ed121b0f72f53789"></a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.6.1: <a href="#pg-e7f89e9f3ce58272813dcb7eb3618b40"></a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-5990d373ac824b52e97a76c2b3e2ff2c"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-c5846110725fe6073de26c491841db19">问题排查</a></li>



    
  
    
    
	

    <li><a href="#pg-aabda7bf6d1a96b643d9cd390156de59">常用命令</a></li>



    
  
    
    
	

    <li><a href="#pg-b92cf9231f6f9197252551c27d29cc5f">postfix</a></li>



    
  
    
    
	

    <li><a href="#pg-905550e769bb3ce68ebf7701485d4e9d">LVM (logical volume manager)</a></li>



    
  
    
    
	

    <li><a href="#pg-6ac20a0b99b404f8617a619f7cf7fc51">rsyslog</a></li>



    
  
    
    
	
<li>5.6: <a href="#pg-5e1eecb0ef0b07d2fc44652e2fc03e66">nginx</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-84a82bd7aae117864d19f5961c931ac6">安装nginx</a></li>



    
  
    
    
	

    <li><a href="#pg-2fb0f235e6fc12a93aed4b8df6d5a972">配置nginx</a></li>



    
  
    
    
	

    <li><a href="#pg-d0f39a2ca728b30b9d3532605c8e36a3">http服务器</a></li>



    
  
    
    
	

    <li><a href="#pg-bd8fa7533b3710dac09a20bf9487ec31">反向代理</a></li>



    
  
    
    
	

    <li><a href="#pg-bb64f1e09c3c57ef9271a135603f6231">location指令</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-c8a277e554b08c5c1a52fa904ed67ca0">ansible</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-73cbbd40bbb62c473e2785f489790835">Quitstart</a></li>



    
  
    
    
	
<li>5.7.2: <a href="#pg-00c869c8082cb1d3aca423fe64068b59"></a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-105501b93b0496b7fd5cf9a548940557"></a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-2315d804757b4b950277d941c6c9be8b"></a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1.1: <a href="#pg-2ac805f1e67dfbdedfce89008160b3b8">环境安装</a></li>


    
  
    
    
	
<li>6.1.2: <a href="#pg-f94ce343fdb329b17c4daf205f56cd67">常量和变量</a></li>


    
  
    
    
	
<li>6.1.3: <a href="#pg-d5a19957c069c59ca70f1703d5db4d3a">数据类型</a></li>


    
  
    
    
	
<li>6.1.4: <a href="#pg-5410e2027a7d9c13483e14a61fbf2c1c">运算符</a></li>


    
  
    
    
	
<li>6.1.5: <a href="#pg-ca426c14ccbdd2d3e8407c9338804473">流程控制语句</a></li>


    
  
    
    
	
<li>6.1.6: <a href="#pg-accc5d7079984749296c70694e1055a5">函数</a></li>


    
  
    
    
	
<li>6.1.7: <a href="#pg-2c3b8fa82fae8e2d552840ed6ce3d15f">结构体</a></li>


    
  
    
    
	
<li>6.1.8: <a href="#pg-bb18142a6ab4131e12e6a9adfd9a40ee">接口</a></li>


    
  
    
    
	
<li>6.1.9: <a href="#pg-20177545e90bb6e34794d53eb0978e4b"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1.9.1: <a href="#pg-56a7f342707b88eb73a4964718cb5654">包管理</a></li>


    
  
    
    
	
<li>6.1.9.2: <a href="#pg-134739c923dfae9273d77b5641e79497">fmt</a></li>


    
  
    
    
	
<li>6.1.9.3: <a href="#pg-ed4a7d377a0d2a0b80a970c4c56643fc">os</a></li>


    
  
    
    
	
<li>6.1.9.4: <a href="#pg-97e147d7d4a73fe0f945dd49a092141f">path</a></li>


    
  
    
    
	
<li>6.1.9.5: <a href="#pg-b4fb2930e691a0cf7acecfb40a183170">io</a></li>


    
  
    
    
	
<li>6.1.9.6: <a href="#pg-3f9604aad21461dcc082973b2b94800c">time</a></li>


    
  
    
    
	
<li>6.1.9.7: <a href="#pg-9d93ac71d7602c7057d3f99677327641">net/http</a></li>


    
  
    
    
	
<li>6.1.9.8: <a href="#pg-6f972b6ca95bc49c4edecab74e624c45">flag</a></li>


    
  
    
    
	
<li>6.1.9.9: <a href="#pg-fbbd2965d31e5953e03b5cdf97dc31b8">pflag</a></li>


    
  
    
    
	
<li>6.1.9.10: <a href="#pg-914a94e7f31499ccbe14f925549af3f1">cobra</a></li>


    
  
    
    
	
<li>6.1.9.11: <a href="#pg-6cd3c6e5efe79ba8f5f98419e7adb485">viper</a></li>


    
  
    
    
	
<li>6.1.9.12: <a href="#pg-7028525bb97786d501063441ca36ea7a">raft</a></li>


    
  
    
    
	
<li>6.1.9.13: <a href="#pg-f12bcddd2849f1b5eaf7e262b5308d7b">uuid</a></li>


    
  
    
    
	
<li>6.1.9.14: <a href="#pg-bb3cda9b54f328eabb3760d5f18c97b2">redis</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-0577191c256ef0a782b28becf1a500d7"></a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.2.1: <a href="#pg-af8116099787cbfdb086e33c1d1479f2"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.2.1.1: <a href="#pg-6e010b4e4ced28817e2d4a2b8fdfa68c">包管理</a></li>


    
  
    
    
	
<li>6.2.1.2: <a href="#pg-1868e7f697cc3be5aa5025000f20291f">kafka</a></li>


    
  
    
    
	
<li>6.2.1.3: <a href="#pg-da72bccd00d9cae50240b122f9fef791">kubernetes</a></li>


    
  
    
    
	
<li>6.2.1.4: <a href="#pg-a954c348f509983e05c14c4953dddd9c">kopf</a></li>


    
  

    </ul>
    
  

    </ul>
    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-593e803ca4275cbee5da083ad76cc9bc"></a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-daab71bd6c339cc69eec143a409d109c"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-ab65920c557ab2b33439fc56e73645b6">install mysql5.6</a></li>



    
  
    
    
	

    <li><a href="#pg-aa85c31520ed761c10303a065029e27b">install mysql5.7</a></li>



    
  
    
    
	

    <li><a href="#pg-c2bad65068c0dc6f4d1427dce06dd4fd">master_slave</a></li>



    
  
    
    
	

    <li><a href="#pg-0e11fa2ec489b8755847ce6778235e54">mha</a></li>



    
  
    
    
	

    <li><a href="#pg-b808a50b951bb2eae264b55dcb7e33fc">mgr</a></li>



    
  
    
    
	

    <li><a href="#pg-c8013d862a736f0c8b81cda693116416">mysqldump</a></li>



    
  
    
    
	

    <li><a href="#pg-ce9d44ed09004288aefaac879ed320af">xtrabackup</a></li>



    
  
    
    
	

    <li><a href="#pg-4bf71c58d88b7380dd55e728c09e47c2">config</a></li>



    
  
    
    
	

    <li><a href="#pg-a051ebfaac6fc3a51384fae8d41525a3">mysql数据库搬迁</a></li>



    
  

    </ul>
    
  
    
    
	
<li>7.2: <a href="#pg-600b4b95c21a8be4c420759c9c310fb0"></a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>7.3: <a href="#pg-c17b09cb9416e4f7264c73ad103ea272"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-e77814dc865bc892f94ffc02d54f2cfc">安装部署</a></li>



    
  
    
    
	

    <li><a href="#pg-c15fb40811dca9bb931163d78690c06b">redis-shake2.1.2</a></li>



    
  
    
    
	

    <li><a href="#pg-6ddb86c8e13cf6905967891813012ff5">redis-shake3.1.11</a></li>



    
  
    
    
	

    <li><a href="#pg-9171779f07ad97b25103d1ce9ca3b8a7">redis数据库搬迁方案2</a></li>



    
  
    
    
	

    <li><a href="#pg-a9beb947715b173b615f76eaebc63922">Redis8.4.0版本</a></li>



    
  

    </ul>
    
  
    
    
	
<li>7.4: <a href="#pg-c8553d33d8183ae3ce84731b8c2608db"></a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>7.5: <a href="#pg-13e8e3ce9786760d8157f34cd761bd21"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-67eb87020312586dadda63d97ee6dd73">pcta</a></li>



    
  
    
    
	

    <li><a href="#pg-6cd2fa811bb545211e56673b02260128">环境检查</a></li>



    
  
    
    
	

    <li><a href="#pg-c968788ec97c1b8ea0974bc58c38f16b">集群安装</a></li>



    
  
    
    
	

    <li><a href="#pg-187ec7198335d617c91d9604a38255b3">tiup工具</a></li>



    
  
    
    
	

    <li><a href="#pg-b6a1b6b4042adf75eca6f429ffbb92d1">checkssh</a></li>



    
  

    </ul>
    
  
    
    
	
<li>7.6: <a href="#pg-b7925a763a64b7d08f88e8b0539bd62d"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-3ae4dfccf1d4f425261aade622c853db">单机版本安装</a></li>



    
  
    
    
	

    <li><a href="#pg-2d9ddeb9ab30ddfb699011cd96663611">集群版本安装</a></li>



    
  
    
    
	

    <li><a href="#pg-0211872ddd3d7ac997b074513c5e8671">配置文件</a></li>



    
  
    
    
	

    <li><a href="#pg-2457b5f6d965f967eb0a2d2d273f1823">RestfullAPI</a></li>



    
  

    </ul>
    
  
    
    
	
<li>7.7: <a href="#pg-6be196ad1a32509a6c7bc2a224b2a9e3"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-4fd1811155c0b30c4801ab6b3f671eaf">部署zookeeper</a></li>



    
  
    
    
	

    <li><a href="#pg-a2ebb8369fef061edbf7f3c10100d052">部署kafka</a></li>



    
  
    
    
	

    <li><a href="#pg-dc4ad1ef352d1381b1276b6e775efacb">kafka核心概念和配置文件</a></li>



    
  
    
    
	

    <li><a href="#pg-4ca462b874e0f51208f6529a334ea449">Kafka认证和授权</a></li>



    
  
    
    
	

    <li><a href="#pg-5408ed3211021d47e8c86495e76d3ace">Kafka 如何进行复制</a></li>



    
  
    
    
	

    <li><a href="#pg-3f35b0366995d1b427499856875e611b">kafka_exporter</a></li>



    
  
    
    
	

    <li><a href="#pg-25e990c22a9d5ff7c6e251af66967092">kafka可视化管理工具</a></li>



    
  

    </ul>
    
  
    
    
	
<li>7.8: <a href="#pg-9faafc121020cd39ed50e11e26aaa6b3"></a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-c9fd25539bbddcf7221fed520f3d1a93">快速开始</a></li>



    
  

    </ul>
    
  
    
    
	
<li>7.9: <a href="#pg-fd72358146a710880fd761142ab540c9"></a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  

    </ul>


<div class="content">
      

<div class="alert alert-primary" role="alert">


    <p>山不却垒土之功，故能成其高；</p>
<p>海不避涓涓细流，故能成其大。</p>


</div>


</div>
</div>


  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-1910481f80a466f934fdc89c9141f0d1"></h1>
	<div class="lead">hugo 文档中心</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-09" class="text-body-secondary">Friday, May 09, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-d14a3b965d9b8088d7b0b18e93bd6282">1.1 - hugo 工具</h1>
    <div class="lead">使用hugo &amp; docsy 构建站点</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">内容概要</h4>

    <ul>
<li>安装、配置hugo&amp;docsy环境</li>
</ul>


</div>


  
  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>初始化站点</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="开发者工具" aria-controls="tabs-01-01" aria-selected="true">
        开发者工具
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="初始化站点" aria-controls="tabs-01-02" aria-selected="false">
        初始化站点
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <ol>
<li><code>go version 1.18+</code></li>
<li><code>nodejs 1.16+</code></li>
<li><code>hugo_extended  version 0.110.0+</code></li>
<li><code>git</code></li>
</ol>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>hugo new site my-new-site --format yaml
</span></span><span style="display:flex;"><span>cd  my-new-site
</span></span><span style="display:flex;"><span>git init
</span></span><span style="display:flex;"><span>hugo mod init github.com/me/my-new-site
</span></span><span style="display:flex;"><span>hugo mod get github.com/google/docsy@v0.11.0
</span></span><span style="display:flex;"><span>npm install -D autoprefixer postcss-cli postcss
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>hugo server
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt; hugo.yaml <span style="color:#e6db74">&lt;&lt;EOL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enableEmoji: true # 支持emoji
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">module:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  proxy: direct
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  hugoVersion:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    extended: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    min: 0.73.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  imports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - path: github.com/google/docsy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      disable: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">markup:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  goldmark:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    renderer:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      unsafe: true                  # 支持markdown 中html css的解析
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cjk:                            # 中文配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enable: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      eastAsianLineBreaks: true     # 按中文换行规则
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      escapedSpace: true            # 保留空格转义
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOL</span>
</span></span></code></pre></div>
    </div>
</div>

<h3 id="初始化顶级菜单">初始化顶级菜单</h3>
<p><code>hugo.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">menu</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">main</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">关于</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">url</span>: <span style="color:#e6db74">&#39;/about&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">pre</span>: <span style="color:#ae81ff">&lt;i class=&#34;fa-solid fa-house&#34;&gt;&lt;/i&gt;</span> <span style="color:#75715e"># 图标 https://fontawesome.com/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">文档</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">url</span>: <span style="color:#e6db74">&#39;/docs&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">pre</span>: <span style="color:#ae81ff">&lt;i class=&#34;fa-solid fa-book&#34;&gt;&lt;/i&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">博客</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">300</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">url</span>: <span style="color:#e6db74">&#39;/blog&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">pre</span>: <span style="color:#ae81ff">&lt;i class=&#34;fa-solid fa-blog&#34;&gt;&lt;/i&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">url</span>: <span style="color:#e6db74">&#39;https://github.com/google/docsy/&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">pre</span>: <span style="color:#ae81ff">&lt;i class=&#39;fa-brands fa-github&#39;&gt;&lt;/i&gt;</span>
</span></span></code></pre></div><h3 id="增加内容页面">增加内容页面</h3>
<p>网站content目录结构</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>content
</span></span><span style="display:flex;"><span>├─_index.md
</span></span><span style="display:flex;"><span>├─about.md
</span></span><span style="display:flex;"><span>├─blog
</span></span><span style="display:flex;"><span>|  |_ _index.md
</span></span><span style="display:flex;"><span>└─docs
</span></span><span style="display:flex;"><span>    |- _index.md
</span></span><span style="display:flex;"><span>    ├─golang
</span></span><span style="display:flex;"><span>    |  |- _index.md
</span></span><span style="display:flex;"><span>    |  |_ package
</span></span><span style="display:flex;"><span>    |       |_ _index.md
</span></span><span style="display:flex;"><span>    └─hugo
</span></span><span style="display:flex;"><span>       |_ _index.md
</span></span></code></pre></div><p><strong>_index.md</strong>文件至关重要，负责初始化目录结构。以下是相对于content目录下创建的_index.md文件内容:</p>

  
  
  

  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          aria-controls="tabs-02-00" aria-selected="false">
        <strong>索引文件配置</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="_index.md" aria-controls="tabs-02-01" aria-selected="true">
        _index.md
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-02" role="tab"
          data-td-tp-persist="docs/_index.md" aria-controls="tabs-02-02" aria-selected="false">
        docs/_index.md
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-03" role="tab"
          data-td-tp-persist="docs/hugo/_index.md" aria-controls="tabs-02-03" aria-selected="false">
        docs/hugo/_index.md
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-04" role="tab"
          data-td-tp-persist="docs/golang/_index.md" aria-controls="tabs-02-04" aria-selected="false">
        docs/golang/_index.md
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">title</span>: <span style="color:#e6db74">&#34;HOME&#34;</span>
</span></span><span style="display:flex;"><span>---
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-02" role="tabpanel" aria-labelled-by="tabs-02-02-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">title</span>: <span style="color:#e6db74">&#34;docs&#34;</span>
</span></span><span style="display:flex;"><span>---
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-03" role="tabpanel" aria-labelled-by="tabs-02-03-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">title</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">linkTitle</span>: <span style="color:#e6db74">&#34;hugo&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">date</span>: <span style="color:#e6db74">2025-05-09</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">simple_list</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">weight</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">description</span>: &gt;<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  hugo 文档中心</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">icon</span>: <span style="color:#ae81ff">fa-solid fa-screwdriver-wrench</span>
</span></span><span style="display:flex;"><span>---
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-04" role="tabpanel" aria-labelled-by="tabs-02-04-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">title</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">linkTitle</span>: <span style="color:#e6db74">&#34;golang&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">date</span>: <span style="color:#e6db74">2025-05-09</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">simple_list</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">weight</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">description</span>: &gt;<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  golang 文档中心</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">icon</span>: <span style="color:#ae81ff">fa-brands fa-golang</span>
</span></span><span style="display:flex;"><span>---
</span></span></code></pre></div>
    </div>
</div>

<p>新增加第一个页面 <code>content/docs/hugo/hugo.md</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>hugo new content docs/hugo/hugo.md -k blog
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">title</span>: <span style="color:#e6db74">&#34;建站&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">linkTitle</span>: <span style="color:#e6db74">&#34;建站&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">date</span>: <span style="color:#e6db74">2025-05-09</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">toc_hide</span>: <span style="color:#66d9ef">false</span>     <span style="color:#75715e">#隐藏左侧菜单</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">hide_summary</span>: <span style="color:#66d9ef">true</span>  <span style="color:#75715e">#隐藏描述，在内容页面的front matter中并没有看出来效果。_index.md 可以清楚的看到效果</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">weight</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">description</span>: &gt;<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  使用hugo &amp; docsy 构建站点</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">《请书写你的内容》</span>
</span></span></code></pre></div><p>在章节菜单中例如<em>content/docs</em> 下，默认会展开所有内容，通过以下参数对该区域进行控制:</p>
<p>hugo.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ui</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sidebar_menu_compact</span>: <span style="color:#66d9ef">true</span>  <span style="color:#75715e">#只展开当前章节，其他兄弟章节折叠</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ul_show</span>: <span style="color:#ae81ff">1</span>                  <span style="color:#75715e">#展开侧边栏中一级内容，嵌套更深的菜单项初始化处于折叠状态</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sidebar_menu_foldable</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e">#允许手动点击父菜单项实现展开/折叠</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sidebar_cache_limit</span>: <span style="color:#ae81ff">1000</span>   <span style="color:#75715e">#侧边栏生成时的缓存条目限制，加快渲染</span>
</span></span></code></pre></div><p>为了简化页面,可以禁用面包屑导航的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ui</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">breadcrumb_disable: true        #Docsy 主题默认会在页面顶部（位于标题下方）生成一个面包屑导航，显示当前页面的层级路径，例如</span>: <span style="color:#ae81ff">hugo/建站。此配置用于禁用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">taxonomy_breadcrumb_disable</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e">#例如 tags 或 categories 的列表页或详情页）默认也会显示面包屑导航. 此配置用于禁用</span>
</span></span></code></pre></div><p>页面设置，同样可以在页面 front matter 中设置页面的图标</p>
<blockquote>
<p>位置：_index.md 或 &lt;具体文档&gt;.md</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">icon</span>: <span style="color:#ae81ff">fa-solid fa-screwdriver-wrench </span> <span style="color:#75715e"># 图标 https://fontawesome.com/</span>
</span></span><span style="display:flex;"><span>---
</span></span></code></pre></div><h3 id="本地搜索">本地搜索</h3>
<p>hugo.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">offlineSearch</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">offlineSearchSummaryLength</span>: <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">offlineSearchMaxResults</span>: <span style="color:#ae81ff">25</span>
</span></span></code></pre></div><h3 id="mermaid-渲染">Mermaid 渲染</h3>
<p>hugo.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mermaid</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">10.9.0</span>
</span></span></code></pre></div><p>示例：</p>
<pre class="mermaid">sequenceDiagram
    autonumber
    Docsy user-&gt;&gt;Discussion board: Ask question
    Discussion board-&gt;&gt;Community member: read question
    loop Different strategies
    Community member-&gt;&gt;Test instance: Investigate issue raised
    end
    Note right of Community member: After hours of investigation:
    Test instance--&gt;&gt;Community member: Come up with solution
    Community member--&gt;&gt;Discussion board: Propose solution
    Discussion board--&gt;&gt;Docsy user: check proposed solution
    Docsy user-&gt;&gt;Discussion board: Mark question as resolved
    Docsy user-&gt;&gt;Docsy user: Being happy</pre>
<pre class="mermaid">flowchart TD
    B[&#34;fa:fa-twitter for peace&#34;]
    B--&gt;C[fa:fa-ban forbidden]
    B--&gt;D(fa:fa-spinner)
    B--&gt;E(A fa:fa-camera-retro perhaps?)</pre>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    由于hugo(hugo v0.146.7)版本问题，引入了try方法处理错误，原有的语法不在兼容，因此需要覆盖模版配置:

</div>

<p>layouts\partials\scripts\mermaid.html</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{ $version := .Site.Params.mermaid.version | default &#34;latest&#34; -}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{ $cdnurl := printf &#34;https://cdn.jsdelivr.net/npm/mermaid@%s/dist/mermaid.esm.min.mjs&#34; $version -}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{ with try (resources.GetRemote $cdnurl) }}
</span></span><span style="display:flex;"><span>  {{ with .Err -}}
</span></span><span style="display:flex;"><span>    {{ errorf &#34;Could not retrieve mermaid script from CDN. Reason: %s.&#34; . -}}
</span></span><span style="display:flex;"><span>  {{ end -}}
</span></span><span style="display:flex;"><span>{{ else -}}
</span></span><span style="display:flex;"><span>  {{ errorf &#34;Invalid Mermaid version %s, could not retrieve this version from CDN.&#34; $version -}}
</span></span><span style="display:flex;"><span>{{ end -}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module&#34;</span> <span style="color:#a6e22e">async</span>&gt;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">mermaid</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;{{ $cdnurl }}&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  (<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">$</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;.mermaid&#39;</span>).<span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mermaid</span>.<span style="color:#a6e22e">initialize</span>({ <span style="color:#a6e22e">startOnLoad</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span> });
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {{ <span style="color:#66d9ef">with</span> .<span style="color:#a6e22e">Site</span>.<span style="color:#a6e22e">Params</span>.<span style="color:#a6e22e">mermaid</span> }}{{ . <span style="color:#f92672">|</span> <span style="color:#a6e22e">jsonify</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">safeJS</span> }}{{ <span style="color:#66d9ef">else</span> }}{}{{<span style="color:#f92672">-</span> <span style="color:#a6e22e">end</span> }};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Site params are stored with lowercase keys; lookup correct casing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// from Mermaid default config.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">norm</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">defaultConfig</span>, <span style="color:#a6e22e">params</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">defaultConfig</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">keyLower</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">toLowerCase</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">defaultConfig</span>.<span style="color:#a6e22e">hasOwnProperty</span>(<span style="color:#a6e22e">key</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">hasOwnProperty</span>(<span style="color:#a6e22e">keyLower</span>)) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">defaultConfig</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;object&#34;</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">norm</span>(<span style="color:#a6e22e">defaultConfig</span>[<span style="color:#a6e22e">key</span>], <span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">keyLower</span>]);
</span></span><span style="display:flex;"><span>          } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">keyLower</span>];
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">settings</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">norm</span>(<span style="color:#a6e22e">mermaid</span>.<span style="color:#a6e22e">mermaidAPI</span>.<span style="color:#a6e22e">defaultConfig</span>, <span style="color:#a6e22e">params</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">settings</span>.<span style="color:#a6e22e">startOnLoad</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;html[data-bs-theme=&#34;dark&#34;]&#39;</span>).<span style="color:#a6e22e">length</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">settings</span>.<span style="color:#a6e22e">theme</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;dark&#39;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mermaid</span>.<span style="color:#a6e22e">initialize</span>(<span style="color:#a6e22e">settings</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Handle light/dark mode theme changes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lightDarkModeThemeChangeHandler</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">mutationsList</span>, <span style="color:#a6e22e">observer</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">mutation</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">mutationsList</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mutation</span>.<span style="color:#a6e22e">type</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;attributes&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">mutation</span>.<span style="color:#a6e22e">attributeName</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;data-bs-theme&#39;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// Mermaid doesn&#39;t currently support reinitialization, see
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#75715e">// https://github.com/mermaid-js/mermaid/issues/1945. Until then,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#75715e">// just reload the page.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">reload</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">observer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MutationObserver</span>(<span style="color:#a6e22e">lightDarkModeThemeChangeHandler</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">observer</span>.<span style="color:#a6e22e">observe</span>(document.<span style="color:#a6e22e">documentElement</span>, {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">attributes</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">attributeFilter</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;data-bs-theme&#39;</span>]
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// observer.disconnect();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  })(<span style="color:#a6e22e">jQuery</span>);
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><h3 id="外观设置">外观设置</h3>
<p><code>hugo.yaml</code>开启light/dark 模式的切换</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ui</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">showLightDarkModeMenu</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p><code>hugo.yaml</code>支持打印页面</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">outputs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">section</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">HTML</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">RSS</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">print</span>
</span></span></code></pre></div><h3 id="新标签页打开外部链接">新标签页打开外部链接</h3>
<p>位置：<code>layouts/_default/_markup/render-link.html</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{{ .Destination | safeURL }}&#34;</span><span style="color:#960050;background-color:#1e0010">{{</span> <span style="color:#a6e22e">with</span> <span style="color:#960050;background-color:#1e0010">.</span><span style="color:#a6e22e">Title</span><span style="color:#960050;background-color:#1e0010">}}</span> <span style="color:#a6e22e">title</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{{ . }}&#34;</span><span style="color:#960050;background-color:#1e0010">{{</span> <span style="color:#a6e22e">end</span> <span style="color:#960050;background-color:#1e0010">}}{{</span> <span style="color:#a6e22e">if</span> <span style="color:#a6e22e">strings</span><span style="color:#960050;background-color:#1e0010">.</span><span style="color:#a6e22e">HasPrefix</span> <span style="color:#960050;background-color:#1e0010">.</span><span style="color:#a6e22e">Destination</span> <span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#a6e22e">http</span><span style="color:#960050;background-color:#1e0010">&#34;</span> <span style="color:#960050;background-color:#1e0010">}}</span> <span style="color:#a6e22e">target</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;_blank&#34;</span><span style="color:#960050;background-color:#1e0010">{{</span> <span style="color:#a6e22e">end</span> <span style="color:#960050;background-color:#1e0010">}}</span>&gt;{{ .Text }}&lt;/<span style="color:#f92672">a</span>&gt;
</span></span></code></pre></div><h3 id="评论系统">评论系统</h3>
<p>评论系统：<a href="https://waline.js.org/" target="_blank">Waline | Waline</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f341a40c2b0c953031f7747d0ed7bccd">1.2 - shortcode</h1>
    <div class="lead">使用hugo &amp; docsy 构建站点</div>
	<p><code>shortcode</code>是hugo 内置的一种语法，通过在markdown 中嵌入html 标签，从而扩展markdown 的功能。</p>
<h3 id="警告标签">警告标签</h3>
<blockquote>
<p>color=&quot;&quot; 支持 primary、info、warning</p>
</blockquote>
<p>短代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span>{{% alert title=&#34;Info&#34; color=&#34;info&#34; %}}
</span></span><span style="display:flex;"><span>This is a info.
</span></span><span style="display:flex;"><span>{{% /alert %}}
</span></span></code></pre></div><p>渲染效果：


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    This is a info.

</div>
</p>
<p>短代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span>{{% alert title=&#34;Warning&#34; color=&#34;warning&#34; %}}
</span></span><span style="display:flex;"><span>This is a warning.
</span></span><span style="display:flex;"><span>{{% /alert %}}
</span></span></code></pre></div><p>渲染为：


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    This is a warning.

</div>
</p>
<hr>
<h3 id="选项卡式窗口">选项卡式窗口</h3>
<p>短代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span>{{&lt; tabpane text=true right=false &gt;}}
</span></span><span style="display:flex;"><span>  {{% tab header=&#34;**OS**:&#34; disabled=true /%}}
</span></span><span style="display:flex;"><span>  {{% tab header=&#34;windows&#34; lang=&#34;en&#34; %}}
</span></span><span style="display:flex;"><span>    可执行文件名*.exe
</span></span><span style="display:flex;"><span>  {{% /tab %}}
</span></span><span style="display:flex;"><span>  {{% tab header=&#34;linux&#34; lang=&#34;de&#34; %}}
</span></span><span style="display:flex;"><span>    一切皆文件
</span></span><span style="display:flex;"><span>  {{% /tab %}}
</span></span><span style="display:flex;"><span>{{&lt; /tabpane &gt;}}
</span></span></code></pre></div><p>渲染效果：

  
  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          aria-controls="tabs-02-00" aria-selected="false">
        <strong>OS</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="windows" aria-controls="tabs-02-01" aria-selected="true">
        windows
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-02" role="tab"
          data-td-tp-persist="linux" aria-controls="tabs-02-02" aria-selected="false">
        linux
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <pre><code>可执行文件名*.exe
</code></pre>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-02" role="tabpanel" aria-labelled-by="tabs-02-02-tab" tabindex="2">
        
    一切皆文件
  
    </div>
</div>
</p>
<hr>
<h3 id="折叠">折叠</h3>
<p>短代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span>{{&lt; details &gt;}}
</span></span><span style="display:flex;"><span>详细信息
</span></span><span style="display:flex;"><span>{{&lt; /details &gt;}}
</span></span></code></pre></div><p>渲染效果：

<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello world&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div></details>
</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fc299664a98179afc2f231a070879a49">1.3 - 时钟和天气</h1>
    <div class="lead"></div>
	

<div class="alert alert-primary" role="alert">


    <p>天气时钟看板 <code>https://github.com/teojs/clock-dashboard</code></p>
<pre tabindex="0"><code>  node v18.12.0
  pnpm 10.26.2 # corepack enable pnpm
  git clone https://gitee.com/mingtian66/clock-dashboard.git
  cd clock-dashboard/
  pnpm install
  pnpm run  build 
</code></pre>

</div>

<!-- 1. 放 iframe -->
<iframe id="haFrame"
        src="http://114.132.158.2/"
        width="100%"
        height="800"
        frameborder="0"
        allowfullscreen>   <!-- 关键属性 -->
</iframe>
<button onclick="fullScreen()">全屏</button>
<script>
function fullScreen() {
  const frame = document.getElementById('haFrame');
  // 兼容前缀
  const req = frame.requestFullscreen
             || frame.webkitRequestFullscreen
             || frame.mozRequestFullScreen
             || frame.msRequestFullscreen;
  req.call(frame);
}
</script>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5f5229a28caafe4fb0c5638f4bde7484">1.4 - 图床工具</h1>
    <div class="lead"></div>
	

<div class="alert alert-primary" role="alert">


    <p>图床工具 <code>https://github.com/chaos-zhu/easyimg</code></p>
<pre tabindex="0"><code>docker run -d --name easyimg -p 3000:3000 -v ./db:/app/db -v ./uploads:/app/uploads ghcr.io/chaos-zhu/easyimg:latest
</code></pre>

</div>


</div>



    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-11f98d6e9161e47829b0f9c66e7d3eab"></h1>
	<div class="lead">kubernetes 文档中心</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-09" class="text-body-secondary">Friday, May 09, 2025</time>
        
	</div>
	<h2 id="容器引擎-docker-vs-containerd">容器引擎 docker vs containerd</h2>
<h2 id="k8s-部署文档">k8s 部署文档</h2>
<h2 id="etcd">etcd</h2>
<h2 id="coredns">coredns</h2>
<h2 id="cni--flannel-cillum">cni  flannel cillum</h2>

</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-b21cef90d38e157d83247a3e5fbb37b1">环境搭建</h1>
	
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-c3188cc99ff9218efbcfa8aa68cadd56">kubeadm环境搭建</h1>
	<div class="lead">构建一套高可用、可扩展的kubernetes生态环境</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-21" class="text-body-secondary">Wednesday, May 21, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">


    <p>阅读该文档你将了解到：</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 从0到1搭建kubernetes环境</li>
<li><input checked="" disabled="" type="checkbox"> 基于kubernetes的可观测平台构建</li>
<li><input checked="" disabled="" type="checkbox"> CI/CD  环境与k8s的集成</li>
</ul>
<p>本示例完全实现下图架构,并试图对 <code>cni/可观测性/cicd</code> 能力进行扩展。力图构建一套生产环境可用的模型。</p>


</div>

<p>​</p>

  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="架构" aria-controls="tabs-01-00" aria-selected="true">
        架构
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="服务器列表" aria-controls="tabs-01-01" aria-selected="false">
        服务器列表
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <img src="https://kubernetes.io/zh-cn/docs/images/kubeadm-ha-topology-stacked-etcd.svg">

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <p><em>通过自建dns 或 <code>/etc/hosts</code> 文件实现对所有主机间的主机名解析</em></p>
<p><em>独立挂载<code>/var/lib/docker</code> 、<code>/var/lib/kubelet</code> 、<code>etcd</code>数据目录</em></p>
<table>
  <thead>
      <tr>
          <th>hostname</th>
          <th>os</th>
          <th>ipaddress</th>
          <th>roles</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>master01</td>
          <td>centos7.9</td>
          <td>192.168.0.108/24</td>
          <td>master、node、keepalived、nginx、nfs</td>
      </tr>
      <tr>
          <td>master02</td>
          <td>centos7.9</td>
          <td>192.168.0.140/24</td>
          <td>master、node、keepalived、nginx</td>
      </tr>
      <tr>
          <td>master03</td>
          <td>centos7.9</td>
          <td>192.168.0.162/24</td>
          <td>master、node、keepalived、nginx</td>
      </tr>
      <tr>
          <td>node01</td>
          <td>centos7.9</td>
          <td></td>
          <td>node</td>
      </tr>
      <tr>
          <td>node02</td>
          <td>centos7.9</td>
          <td></td>
          <td>node</td>
      </tr>
      <tr>
          <td>virtualhost</td>
          <td></td>
          <td>192.168.0.144/24</td>
          <td>vip</td>
      </tr>
  </tbody>
</table>

    </div>
</div>


  
  
  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          aria-controls="tabs-02-00" aria-selected="false">
        <strong>系统优化</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="系统初始化" aria-controls="tabs-02-01" aria-selected="true">
        系统初始化
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-02" role="tab"
          data-td-tp-persist="lb" aria-controls="tabs-02-02" aria-selected="false">
        LB
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-03" role="tab"
          data-td-tp-persist="keepalived" aria-controls="tabs-02-03" aria-selected="false">
        keepalived
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># author: 1209233066@qq.com</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># description:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#	init linux env for kuernetes v24-</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   function:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#           1. sethostname </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#           2. turn off swap</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#           3. turn off selinux</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#           4. turn off firewalld</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#           5. turn on kernel for netfilter/ip_nonlocal_bind</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#           6. turn on ipvs modle</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#           7. modify cgroup driver for docker</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#           8. allow bind nonlocal ip</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#           </span>
</span></span><span style="display:flex;"><span>LC_ALL<span style="color:#f92672">=</span>C
</span></span><span style="display:flex;"><span>SetEnv<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 设置主机名和时区</span>
</span></span><span style="display:flex;"><span>	hostnamectl set-hostname <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	timedatectl set-timezone Asia/Shanghai
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 关闭swap分区 </span>
</span></span><span style="display:flex;"><span>    swapoff -a 
</span></span><span style="display:flex;"><span>    sed -i <span style="color:#e6db74">&#39;/swap/s|^|#|g&#39;</span> /etc/fstab
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 关闭selinux </span>
</span></span><span style="display:flex;"><span>    setenforce <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    sed -i <span style="color:#e6db74">&#39;s|SELINUX=enforcing|SELINUX=disabled|g&#39;</span> /etc/selinux/config
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 关闭firewalld</span>
</span></span><span style="display:flex;"><span>    systemctl disable --now firewalld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 加载 br_netfilter 模块</span>
</span></span><span style="display:flex;"><span>    echo br_netfilter &gt;/etc/modules-load.d/br_netfilter.conf
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 加载ipvs 模块</span>
</span></span><span style="display:flex;"><span>    ls /usr/lib/modules/<span style="color:#66d9ef">$(</span>uname -r<span style="color:#66d9ef">)</span>/kernel/net/netfilter/ipvs |awk -F <span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#e6db74">&#39;{print $1}&#39;</span> &gt;/etc/modules-load.d/ipvs.conf
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 加载/etc/modules-load.d 下配置文件</span>
</span></span><span style="display:flex;"><span>    systemctl restart systemd-modules-load
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 开启 bridge-nf-call-iptables内核功能</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 开启 bridge-nf-call-ip6tables 内核功能</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 开启数据包内核转发功能</span>
</span></span><span style="display:flex;"><span>    sysctl -w net.bridge.bridge-nf-call-iptables<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    sysctl -w net.bridge.bridge-nf-call-ip6tables<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    sysctl -w net.ipv4.ip_forward<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    sysctl -w net.ipv4.ip_nonlocal_bind<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	echo -e <span style="color:#e6db74">&#34;net.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.ipv4.ip_forward = 1\nnet.ipv4.ip_nonlocal_bind = 1&#34;</span> &gt;/etc/sysctl.d/kubernetes.conf
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>	yum install ipvsadm -y
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>	curl https://get.docker.com|bash -s -- --mirror Aliyun --version 20.10.24 <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	mkdir /etc/docker <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	echo -e <span style="color:#e6db74">&#39;{\n\t&#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;]\n}&#39;</span> &gt;/etc/docker/daemon.json
</span></span><span style="display:flex;"><span>	systemctl daemon-reload
</span></span><span style="display:flex;"><span>	systemctl enable docker --now
</span></span><span style="display:flex;"><span>	systemctl status docker
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SetEnv
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-02" role="tabpanel" aria-labelled-by="tabs-02-02-tab" tabindex="2">
        <div class="alert alert-primary" role="alert">
<h4 class="alert-heading">L4负载均衡，在所有master节点执行</h4>
<pre><code>sysctl -w net.ipv4.ip_nonlocal_bind=1
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>user  nginx;
</span></span><span style="display:flex;"><span>worker_processes  1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>events <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    worker_connections  1024;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>stream <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        log_format main <span style="color:#e6db74">&#39;$remote_addr [$time_local] &#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;$protocol $status $bytes_sent $bytes_received &#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;$session_time &#34;$upstream_addr&#34; &#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;&#34;$upstream_bytes_sent&#34; &#34;$upstream_bytes_received&#34; &#34;$upstream_connect_time&#34;&#39;</span>;
</span></span><span style="display:flex;"><span>        upstream kube_apiserver <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                server 192.168.0.108:6443 weight<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> max_fails<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> fail_timeout<span style="color:#f92672">=</span>30s;
</span></span><span style="display:flex;"><span>                server 192.168.0.140:6443 weight<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> max_fails<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> fail_timeout<span style="color:#f92672">=</span>30s;
</span></span><span style="display:flex;"><span>                server 192.168.0.162:6443 weight<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> max_fails<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> fail_timeout<span style="color:#f92672">=</span>30s;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                listen 192.168.0.144:16443;
</span></span><span style="display:flex;"><span>                proxy_connect_timeout 2s;
</span></span><span style="display:flex;"><span>                proxy_timeout 900s;
</span></span><span style="display:flex;"><span>                proxy_pass kube_apiserver;
</span></span><span style="display:flex;"><span>                access_log  logs/kubeapiserver.log main;
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-03" role="tabpanel" aria-labelled-by="tabs-02-03-tab" tabindex="2">
        <p>三个节点使用相同的<code> BACKUP</code> 和 <code>priority 100</code> 初始化时拥有对等角色,vrrp初次选举时如果<code>priority </code> 相同则会选择ip较大的节点拥有vip，因此不用担心相同<code>priority</code> 脑裂问题。
而<code>state BACKUP</code> 是为了让非抢占参数<code>nopreempt</code> 能够生效</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">参数</th>
          <th style="text-align: left">赋值</th>
          <th style="text-align: left">作用说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">router_id</td>
          <td style="text-align: left">不同</td>
          <td style="text-align: left">标识本主机，便于日志区分</td>
      </tr>
      <tr>
          <td style="text-align: left">virtual_router_id</td>
          <td style="text-align: left">相同</td>
          <td style="text-align: left">VRRP组标识，主备必须一致</td>
      </tr>
      <tr>
          <td style="text-align: left">state BACKUP</td>
          <td style="text-align: left">相同</td>
          <td style="text-align: left">所有节点设置为BACKUP，目的是为了让非抢占参数<code>nopreempt</code> 能够生效</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/etc/keepalived/keepalived.conf<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">! Configuration File for keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">####################### main config ########################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global_defs {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   notification_email {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      810654947@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      1209233066@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   notification_email_from 810654947@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   smtp_server smtp.qq.com 587
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   smtp_connect_timeout 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # 标识本主机，便于日志区分。每个主机不同
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   router_id 1921680108
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   vrrp_garp_master_delay 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   script_user root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vrrp_script check_port {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   script &#34;/etc/keepalived/check_port.sh 16443&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   interval 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   weight -30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">################### Vrrp instance config ###################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vrrp_instance VI_1 { 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # MASTER|BACKUP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   state BACKUP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   priority 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   interface ens192
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   virtual_router_id 51
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   advert_int 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # 当初始化节点是MASTER时不生效
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   nopreempt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   authentication {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      auth_type PASS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      auth_pass 1111
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   virtual_ipaddress {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      192.168.0.144/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   track_script {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      check_port
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>健康检查脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/etc/keepalived/check_port.sh<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">count=$(ss -lntp|grep -c  &#34;$1&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ $count -ge 1 ] &amp;&amp; exit 0 || pkill keepalived; exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>chmod +x /etc/keepalived/check_port.sh
</span></span></code></pre></div><p>keepalived 启动脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/keepalived.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description = keepalived daemon 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After = network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=forking
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/local/sbin/keepalived --log-console -f /etc/keepalived/keepalived.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable --now keepalived
</span></span></code></pre></div>
    </div>
</div>

<h3 id="kubeadm-安装">kubeadm 安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y kubelet-1.23.17-0.x86_64 kubeadm-1.23.17-0.x86_64  kubectl-1.23.17-0.x86_64 
</span></span></code></pre></div><h4 id="初始化集群"><strong>初始化集群</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm init --control-plane-endpoint <span style="color:#e6db74">&#34;192.168.0.144:16443&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--image-repository k8s-gcr.m.daocloud.io <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubernetes-version 1.23.17 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--upload-certs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--pod-network-cidr <span style="color:#e6db74">&#34;10.244.0.0/16&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--service-cidr <span style="color:#e6db74">&#34;172.168.0.0/16&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v5
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl enable kubelet --now
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span></code></pre></div><p><strong>命令自动补全</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install bash-completion -y
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;source &lt;(kubectl completion bash)&#39;</span> &gt;&gt;~/.bashrc
</span></span><span style="display:flex;"><span>source ~/.bashrc
</span></span></code></pre></div><h4 id="安装基础cni插件flannel"><strong>安装基础cni插件flannel</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
</span></span></code></pre></div><h4 id="安装ingress-controller"><strong>安装ingress controller</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.0.4/deploy/static/provider/cloud/deploy.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1
</span></span><span style="display:flex;"><span>k8s.gcr.io/ingress-nginx/controller:v1.1.2  
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">externalIPs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">192.168.0.236</span>
</span></span></code></pre></div><h4 id="安装dashboard"><strong>安装dashboard</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span>kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.6.2/high-availability-1.21+.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/kubernetes/refs/tags/v1.23.2/cluster/addons/dashboard/dashboard.yaml
</span></span></code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">报错</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>x509: cannot validate certificate <span style="color:#66d9ef">for</span> 192.168.0.xxx because it doesn<span style="color:#960050;background-color:#1e0010">&#39;</span>t contain any IP SANs
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;Failed probe&#34;</span> probe<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;metric-storage-ready&#34;</span> err<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;no metrics to serve&#34;</span>
</span></span></code></pre></div><p>解决办法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>--kubelet-insecure-tls
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl genrsa -out dashboard.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl req -new -key dashboard.key -out ca.csr -subj <span style="color:#e6db74">&#34;/C=CN/ST=Gd/L=SZ/O=zero-dew.com/CN=dashboard.zero-dew.com&#34;</span>
</span></span><span style="display:flex;"><span>openssl x509 -req -in ca.csr -out dashboard.crt -signkey  dashboard.key -days <span style="color:#ae81ff">3650</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n kubernetes-dashboard create secret tls dashboard-tls --cert<span style="color:#f92672">=</span>dashboard.crt --key<span style="color:#f92672">=</span>dashboard.key
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; &#39;EOF&#39; |kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: networking.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Ingress
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: dashboard
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: kubernetes-dashboard
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    nginx.ingress.kubernetes.io/backend-protocol: &#34;HTTPS&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ingressClassName: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tls:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - hosts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - dashboard.zero-dew.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    secretName: dashboard-tls
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - host: dashboard.zero-dew.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    http:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - path: /
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pathType: Prefix
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        backend:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            name: kubernetes-dashboard
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            port:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              number: 443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>192.168.0.236 A dashboard.zero-dew.com
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>https://dashboard.zero-dew.com
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create sa dashboard-admin -n kubernetes-dashboard
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl create clusterrolebinding dashboard-admin --clusterrole<span style="color:#f92672">=</span>cluster-admin --serviceaccount<span style="color:#f92672">=</span>kubernetes-dashboard:dashboard-admin 
</span></span><span style="display:flex;"><span>kubectl describe secret dashboard-admin-token-vm6lm  -n kubernetes-dashboard
</span></span></code></pre></div><h4 id="安装nfs--storage-class"><strong>安装nfs  storage class</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://www.cnblogs.com/punchlinux/p/16552183.html</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-storage</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">nfs-storage</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;nodes&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;persistentvolumes&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;delete&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;persistentvolumeclaims&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;storage.k8s.io&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;storageclasses&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;events&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>, <span style="color:#e6db74">&#34;patch&#34;</span>]
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">nfs-storage</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">leader-locking-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">nfs-storage</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">update</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">patch</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">leader-locking-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">nfs-storage</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">leader-locking-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">nfs-storage</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">storage.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StorageClass</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">managed-nfs-storage</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageclass.kubernetes.io/is-default-class</span>: <span style="color:#e6db74">&#34;true&#34;</span>  <span style="color:#75715e"># 设置为默认sc</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">provisioner</span>: <span style="color:#ae81ff">k8s-sigs.io/nfs-subdir-external-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">allowVolumeExpansion</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e">#允许动态扩容，比如kubectl edit pvc</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">reclaimPolicy</span>: <span style="color:#ae81ff">Retain	</span> <span style="color:#75715e">#PV的删除策略默认为delete,删除后pv立即删除NFS server的数据</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mountOptions</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#- vers=4.1 #NFS版本，containerd有部分参数异常</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#- noresvport  #告知NFS客户端在重新建立网络连接时，使用新的传输控制协议端口</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">noatime </span> <span style="color:#75715e">#访问文件时不更新文件inode中的时间戳，高并发环境可提高性能</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">parameters</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#mountOptions: &#34;vers=4.1,noresvport,noatime&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">archiveOnDelete</span>: <span style="color:#e6db74">&#34;true&#34;</span>  <span style="color:#75715e">#删除pod时保留pod数据，默认为false时不保留数据</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">nfs-storage</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>: <span style="color:#75715e">#部署策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Recreate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">#image: k8s.gcr.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2 </span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.cn-hangzhou.aliyuncs.com/liangxiaohui/nfs-subdir-external-provisioner:v4.0.2</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-root</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/persistentvolumes</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">PROVISIONER_NAME</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#ae81ff">k8s-sigs.io/nfs-subdir-external-provisioner</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">NFS_SERVER</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#ae81ff">10.4.7.250</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">NFS_PATH</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#ae81ff">/data/volumes</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-root</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">nfs</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.0.108</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/data/volumes</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pvc-test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">nfs-storage</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">1Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">managed-nfs-storage</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">run</span>: <span style="color:#ae81ff">test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">nfs-storage</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">sleep</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;1000&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsPolicy</span>: <span style="color:#ae81ff">ClusterFirst</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Always</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dyncmic-pvc</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">pvc-test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># yum install rpcbind nfs-utils -y</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># systemctl enable rpcbind nfs --now </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># systemctl status  rpcbind nfs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># install -d /data/volumes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># echo &#34;/data/volumes  *(rw,sync,no_root_squash)&#34; &gt;/etc/exports</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># root@harbor:~# exportfs -r</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># showmount -e 192.168.0.108</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mount -t nfs 192.168.0.108:/data/volumes /mnt  </span>
</span></span></code></pre></div><h4 id="安装multus-cni插件--spiderpool"><strong>安装multus cni插件 + SpiderPool</strong></h4>
<p><img src="https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/18630fde0b43e38addb4a83c437c833c39854ffe/docs/images/multus-pod-image.svg" alt=""></p>
<p>安装多网卡cni <code>multus</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/deployments/multus-daemonset.yml
</span></span></code></pre></div><p>安装ipam  <code>SpiderPool</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add spiderpool https://spidernet-io.github.io/spiderpool
</span></span><span style="display:flex;"><span>helm fetch spiderpool/spiderpool
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm install spiderpool spiderpool/spiderpool <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set multus.enableMultusConfig<span style="color:#f92672">=</span>false <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set global.imageRegistryOverride<span style="color:#f92672">=</span>ghcr.m.daocloud.io <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--wait --namespace kube-system 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee <span style="color:#e6db74">&lt;&lt;EOF|kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: spiderpool.spidernet.io/v2beta1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: SpiderIPPool
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: macvlan-ipv4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  default: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  subnet: 192.168.0.0/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ips:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - &#34;192.168.0.213-192.168.0.216&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - &#34;192.168.0.174-192.168.0.209&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: &#34;k8s.cni.cncf.io/v1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: NetworkAttachmentDefinition
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: macvlan1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  config: &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;cniVersion&#34;: &#34;0.3.0&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;type&#34;: &#34;macvlan&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;master&#34;: &#34;ens192&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;mode&#34;: &#34;bridge&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      		&#34;ipam&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;type&#34;: &#34;spiderpool&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;promiscuous&#34;: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>测试mcvlan</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF|kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: DaemonSet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s.v1.cni.cncf.io/networks: macvlan
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      tolerations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - effect: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        key: &#34;node-role.kubernetes.io/master&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - name: test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        securityContext:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          privileged: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        image: quay.io/libpod/alpine:3.10.2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        command: [&#34;sleep&#34;,&#34;1000&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h4 id="prometheus监控告警">prometheus监控告警</h4>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">目标</h4>

    <ol>
<li>对基础组件的指标采集。<code>kube-apiserver</code>、<code>kube-scheduler</code>、<code>kube-controllermanager</code>、<code>kubelet</code>、<code>kubeproxy</code>、<code>etcd</code>、<code>coredns</code>、<code>cni</code>、<code>csi</code>、<code>cri</code>、<code>node</code></li>
<li>通过label 或annotation 通过kubernetes_sd_config 的对业务pod动态发现</li>
<li>完善一个kubernetes基础平台的dashbaord</li>
<li>完善一个kubernetes基础平台的alert 模版和告警规则</li>
</ol>


</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: DaemonSet
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: node-exporter
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: node-exporter
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: node-exporter
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      tolerations:
</span></span><span style="display:flex;"><span>      - key: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        operator: <span style="color:#e6db74">&#34;Exists&#34;</span>
</span></span><span style="display:flex;"><span>      volumes:
</span></span><span style="display:flex;"><span>      - name: root
</span></span><span style="display:flex;"><span>        hostPath:
</span></span><span style="display:flex;"><span>          path: /
</span></span><span style="display:flex;"><span>      hostNetwork: true
</span></span><span style="display:flex;"><span>      hostPID: true
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: node-exporter
</span></span><span style="display:flex;"><span>        image: quay.io/prometheus/node-exporter:v1.6.1
</span></span><span style="display:flex;"><span>        args:
</span></span><span style="display:flex;"><span>        - --path.rootfs<span style="color:#f92672">=</span>/host
</span></span><span style="display:flex;"><span>        volumeMounts:
</span></span><span style="display:flex;"><span>        - mountPath: /host
</span></span><span style="display:flex;"><span>          name: root
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://192.168.0.144:16443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 测试改成false也没问题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:9100&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;etcd&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/etcd/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/etcd/peer.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/etcd/peer.key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://192.168.0.144:16443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 测试改成false也没问题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_node_label_kubernetes_io_role]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;master&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:2379&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kube-apiserver</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">honor_timestamps</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">follow_redirects</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enable_http2</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://192.168.0.144:16443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 测试改成false也没问题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_node_label_kubernetes_io_role]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;master&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:6443&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kubelet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">honor_timestamps</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">follow_redirects</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enable_http2</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://192.168.0.144:16443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 测试改成false也没问题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:10250&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://192.168.0.144:16443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 测试改成false也没问题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#34;__meta_kubernetes_service_name&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;kube-state-metrics&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#34;__meta_kubernetes_service_label_prometheus_io_external&#34;</span>,<span style="color:#e6db74">&#34;__meta_kubernetes_service_label_prometheus_io_ports&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">([0-9\.]+);(\d+)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">$1:$2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div><h4 id="filebeat日志采集">filebeat日志采集</h4>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">目标</h4>

    <ol>
<li>采集基础组件：<code>kube-apiserver</code>、<code>kube-scheduler</code>、<code>kube-controllermanager</code>、<code>kubelet</code>、<code>kubeproxy</code>、<code>etcd</code>、<code>coredns</code>、<code>cni</code>、<code>csi</code>、<code>cri</code>、<code>node</code></li>
<li>通过label 或annotation 对业务pod动态发现</li>
</ol>


</div>

<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl annotation ns kube-system filebeat<span style="color:#f92672">=</span>true
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.autodiscover</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">providers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">kubernetes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">node</span>: <span style="color:#ae81ff">${NODE_NAME}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">templates</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">condition</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">or</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">equals</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">kubernetes.labels.filebeat</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">equals</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">kubernetes.namespace_labels.filebeat</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">filestream</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">id</span>: <span style="color:#ae81ff">container-${data.kubernetes.container.id}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">prospector.scanner.symlinks</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/var/log/containers/*-${data.kubernetes.container.id}.log</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">parsers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">container</span>: <span style="color:#ae81ff">~</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">multiline</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">type</span>: <span style="color:#ae81ff">pattern</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">pattern</span>: <span style="color:#e6db74">&#39;^\[&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">negate</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">match</span>: <span style="color:#ae81ff">after</span>
</span></span></code></pre></div></details>
<h4 id="skywalking">skywalking</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubeadm token create</span>
</span></span><span style="display:flex;"><span>43bjhh.j2l5jqrixcd022zc
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubeadm token list</span>
</span></span><span style="display:flex;"><span>TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
</span></span><span style="display:flex;"><span>43bjhh.j2l5jqrixcd022zc   23h         2025-11-28T12:14:03Z   authentication,signing   &lt;none&gt;                                                     system:bootstrappers:kubeadm:default-node-token
</span></span></code></pre></div><h4 id="继续添加master节点"><strong>继续添加master节点</strong></h4>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm init phase upload-certs --upload-certs
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubeadm token create --print-join-command</span>
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm join 192.168.0.144:16443 --token mhnut3.z7xz7l9xzoj8vorg <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--discovery-token-ca-cert-hash sha256:3e77b765acb011d12cfb2649040ba6b51dd07ac6ee1746ce540740fc9d31bea3 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--control-plane --certificate-key 33bdaf597978b2355117cb742562dbaf4b91a20abb8e3a9f145439122b4eae48 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v5
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl enable kubelet
</span></span></code></pre></div><h4 id="添加node节点"><strong>添加node节点</strong></h4>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubeadm token create --print-join-command</span>
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm join 192.168.0.144:16443 --token hmop0f.c82n8s9ns25thhqh --discovery-token-ca-cert-hash sha256:3e77b765acb011d12cfb2649040ba6b51dd07ac6ee1746ce540740fc9d31bea3 -v5
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl enable kubelet
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-eca395938eb773382579cec33e1f3ce5">kubeaz环境搭建</h1>
	<div class="lead">构建一套高可用、可扩展的kubernetes生态环境</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-21" class="text-body-secondary">Wednesday, May 21, 2025</time>
        
	</div>
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone  https://github.com/easzlab/kubeasz.git
</span></span></code></pre></div><p>环境</p>
<table>
  <thead>
      <tr>
          <th>主机</th>
          <th>ip</th>
          <th>资源</th>
          <th>kernel</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>master01</td>
          <td>192.168.0.243</td>
          <td>2c 4g 100GB</td>
          <td>centos7 3.10</td>
      </tr>
      <tr>
          <td>master02</td>
          <td>192.168.0.244</td>
          <td>2c 4g 100GB</td>
          <td>centos7 3.10</td>
      </tr>
      <tr>
          <td>master03</td>
          <td>192.168.0.245</td>
          <td>2c 4g 100GB</td>
          <td>centos7 3.10</td>
      </tr>
  </tbody>
</table>
<ol>
<li>
<p>时间同步</p>
<p><code>chrony</code> 是一个优秀的 <code>NTP</code> 实现，性能比ntp好，且配置管理方便；它既可作时间服务器服务端，也可作客户端。</p>
<p><strong>安装chronyd服务</strong>:	<code> yum install chrony</code></p>
<p><strong>配置时间服务器地址</strong>:</p>
<pre tabindex="0"><code># server &lt;时间服务器&gt;  &lt;客户端向服务端发起时间同步的最小间隔，示例中4 表示 2^4=64s&gt; &lt;客户端向服务端发起时间同步的最大间隔，示例中10表示 2^10=1024s&gt; 
server ntp.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp1.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp2.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp3.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp4.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp5.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp6.aliyun.com minpoll 4 maxpoll 10 iburst
server 192.168.0.251 minpoll 4 maxpoll 10 iburst
</code></pre><p><strong>作为服务端时，允许连接的客户端</strong>:</p>
<pre tabindex="0"><code>allow 192.168.0.0/16
</code></pre><p><strong>启动守护进程：</strong></p>
<blockquote>
<p>客户端监听本机的323/udp 端口，服务端监听 123/udp</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl enable chronyd --now
</span></span><span style="display:flex;"><span>systemctl status chronyd 
</span></span></code></pre></div><p><strong>chronyc 作为客户端命令 查看配置的时间服务器</strong></p>
<p><img src="https://img2024.cnblogs.com/blog/2108528/202502/2108528-20250213144507664-645070835.png" alt=""></p>
<p><strong>追踪查看时间同步的详细信息</strong></p>
<p><img src="https://img2024.cnblogs.com/blog/2108528/202502/2108528-20250213144524152-429284700.png" alt=""></p>
<p><strong>作为服务端，查看当前连接过来的客户端</strong></p>
<p><img src="https://img2024.cnblogs.com/blog/2108528/202502/2108528-20250213144538920-686752789.png" alt=""></p>
</li>
<li>
<p>关闭firewalld</p>
</li>
<li>
<p>关闭 selinux</p>
</li>
<li>
<p><a href="https://github.com/easzlab/kubeasz/blob/3.1.1/docs/setup/00-planning_and_overall_intro.md" target="_blank">使用kubeasz</a></p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>deploy ~<span style="color:#f92672">]</span><span style="color:#75715e"># yum install ansible -y</span>
</span></span><span style="display:flex;"><span>deploy ~<span style="color:#f92672">]</span><span style="color:#75715e"># ansible --version</span>
</span></span><span style="display:flex;"><span>ansible 2.9.27
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 秘钥认证</span>
</span></span><span style="display:flex;"><span>ssh-keygen -t rsa -P <span style="color:#e6db74">&#39;&#39;</span> -f /root/.ssh/id_rsa
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> host in 192.168.0.251 192.168.0.252 192.168.0.253;<span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>	sshpass -p pytc@2024 ssh-copy-id $host
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone  https://github.com/easzlab/kubeasz.git
</span></span><span style="display:flex;"><span>cd kubeasz/
</span></span><span style="display:flex;"><span>git checkout 3.6.5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/etc/kubeasz/ezctl new cluster01 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 是bash 脚本</span>
</span></span><span style="display:flex;"><span>wget https://github.com/easzlab/kubeasz/releases/download/3.1.1/ezdown
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 下载 kubeasz代码、二进制、离线镜像 到/etc/kubeasz</span>
</span></span><span style="display:flex;"><span>bash ezdown -D
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在/etc/kubeasz/clusters/k8s-01/ 下生成集群配置文件和ansible主机模板 k8s-01 是集群名称</span>
</span></span><span style="display:flex;"><span>cd /etc/kubeasz
</span></span><span style="display:flex;"><span>deploy kubeasz<span style="color:#f92672">]</span><span style="color:#75715e"># ./ezctl new k8s-01</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 集群名称 k8s-01 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 可以但组件安装./ezctl setup k8s-01 01</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 也可以 ./ezctl setup k8s-01 all  全部安装</span>
</span></span><span style="display:flex;"><span>deploy kubeasz<span style="color:#f92672">]</span><span style="color:#75715e"># ./ezctl setup k8s-01 all </span>
</span></span></code></pre></div><p>kubelete 无法启动，通过docker info 查看得知 kubelet 启动配置 和docker  的cgroup-driver 不一致。修改kubelete 的启动文件后正常</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  --cgroup-driver<span style="color:#f92672">=</span>cgroupfs
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@ceph-deploy kubeasz<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl version</span>
</span></span><span style="display:flex;"><span>Client Version: version.Info<span style="color:#f92672">{</span>Major:<span style="color:#e6db74">&#34;1&#34;</span>, Minor:<span style="color:#e6db74">&#34;21&#34;</span>, GitVersion:<span style="color:#e6db74">&#34;v1.21.0&#34;</span>, GitCommit:<span style="color:#e6db74">&#34;cb303e613a121a29364f75cc67d3d580833a7479&#34;</span>, GitTreeState:<span style="color:#e6db74">&#34;clean&#34;</span>, BuildDate:<span style="color:#e6db74">&#34;2021-04-08T16:31:21Z&#34;</span>, GoVersion:<span style="color:#e6db74">&#34;go1.16.1&#34;</span>, Compiler:<span style="color:#e6db74">&#34;gc&#34;</span>, Platform:<span style="color:#e6db74">&#34;linux/amd64&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Server Version: version.Info<span style="color:#f92672">{</span>Major:<span style="color:#e6db74">&#34;1&#34;</span>, Minor:<span style="color:#e6db74">&#34;21&#34;</span>, GitVersion:<span style="color:#e6db74">&#34;v1.21.0&#34;</span>, GitCommit:<span style="color:#e6db74">&#34;cb303e613a121a29364f75cc67d3d580833a7479&#34;</span>, GitTreeState:<span style="color:#e6db74">&#34;clean&#34;</span>, BuildDate:<span style="color:#e6db74">&#34;2021-04-08T16:25:06Z&#34;</span>, GoVersion:<span style="color:#e6db74">&#34;go1.16.1&#34;</span>, Compiler:<span style="color:#e6db74">&#34;gc&#34;</span>, Platform:<span style="color:#e6db74">&#34;linux/amd64&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>后面的增删该都是通过 <code>./ezctl </code></p>
<p>集群升级</p>
<ol>
<li>创建两套完整的集群。</li>
<li>一台一台先升级master，master 升级完。在升级node</li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-5c10bf9a703182f522d9ebb359005d06">kubeadm工具</h1>
	<div class="lead">介绍kubeadm工具的使用。搭建集群/节点扩容/版本升级</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-15" class="text-body-secondary">Tuesday, July 15, 2025</time>
        
	</div>
	<hr>
<p><strong>任务：</strong></p>
<ul>
<li><input disabled="" type="checkbox"> 什么是bootstraptoken,在kubernetes中的应用</li>
<li><input disabled="" type="checkbox"> kube-apiserver 的认证方式有哪些，输出最佳实践</li>
<li><input disabled="" type="checkbox"> kubeadm 配置文件结构体，支持哪些配置和字段</li>
</ul>
<p>authentication  认证</p>
<p>authorization   授权</p>
<hr>
<p>执行kubeadm init 阶段将<code>ClusterConfiguration</code> 配置上传到kube-system名称空间下<code>kubeadm-config</code> configmap中，</p>
<p>执行<code>kubeadm join</code>、<code>kubeadm reset</code>、 <code>kubeadm upgrade</code> 时读取该配置</p>
<p><code>kubeadm config migrate</code> 来转换旧配置文件</p>
<p><code>kubeadm config validate</code> 可用于验证配置文件</p>
<p><code>kubeadm config images list</code></p>
<p><code>kubeadm config images pull</code></p>
<p><code>kubeadm config print</code></p>
<p><code>kubeadm token create</code></p>
<p>配置文件包含5中类型：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>kind: InitConfiguration
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>kind: ClusterConfiguration
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>apiVersion: kubelet.config.k8s.io/v1beta1
</span></span><span style="display:flex;"><span>kind: KubeletConfiguration
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span style="display:flex;"><span>kind: KubeProxyConfiguration
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>kind: JoinConfiguration
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm config print init-defaults
</span></span><span style="display:flex;"><span>kubeadm config print join-defaults
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm config print init-defaults <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--component-configs KubeProxyConfiguration <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--component-configs KubeletConfiguration
</span></span></code></pre></div><p><code>kubeadm/app/apis/kubeadm/types.go</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">InitConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bootstrapTokens</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">system:bootstrappers:kubeadm:default-node-token</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">token</span>: <span style="color:#ae81ff">abcdef.0123456789abcdef</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ttl</span>: <span style="color:#ae81ff">24h0m0s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">usages</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">signing</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">authentication</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">localAPIEndpoint</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">advertiseAddress</span>: <span style="color:#ae81ff">192.168.0.161</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">bindPort</span>: <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeRegistration</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">criSocket</span>: <span style="color:#ae81ff">/var/run/dockershim.sock</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">seagullcore01-uat-s2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">taints</span>: <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dryRun</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">imageRepository</span>: <span style="color:#ae81ff">k8s-gcr.m.daocloud.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kubernetesVersion</span>: <span style="color:#ae81ff">1.23.17</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiServer</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">timeoutForControlPlane</span>: <span style="color:#ae81ff">4m0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">certificatesDir</span>: <span style="color:#ae81ff">/etc/kubernetes/pki</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterName</span>: <span style="color:#ae81ff">kubernetes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">controllerManager</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">dns</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">etcd</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dataDir</span>: <span style="color:#ae81ff">/var/lib/etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networking</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsDomain</span>: <span style="color:#ae81ff">cluster.local</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceSubnet</span>: <span style="color:#ae81ff">172.168.0.0</span><span style="color:#ae81ff">/16</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scheduler</span>: {}
</span></span></code></pre></div><p><code>kubeadm/app/apis/config/types.go</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeproxy.config.k8s.io/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeProxyConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bindAddress</span>: <span style="color:#ae81ff">0.0.0.0</span>            <span style="color:#75715e"># kube-proxy 监听的地址</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">healthzBindAddress</span>: <span style="color:#e6db74">&#34;&#34;</span>          <span style="color:#75715e"># /healthz 默认 0.0.0.0:10256</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metricsBindAddress</span>: <span style="color:#e6db74">&#34;&#34;</span>          <span style="color:#75715e"># /metrics 默认 0.0.0.0:10249</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">hostnameOverride</span>: <span style="color:#e6db74">&#34;&#34;</span>        <span style="color:#75715e"># kube-proxy 实例的名称，默认 `hostname`</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bindAddressHardFail</span>: <span style="color:#66d9ef">false</span>  <span style="color:#75715e"># 当为true,kube-proxy监听ip和端口失败，报致命错误并退出</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">enableProfiling</span>: <span style="color:#66d9ef">false</span>          <span style="color:#75715e"># 允许 /debug/pprof</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clientConnection</span>:                       <span style="color:#75715e"># 连接apiserver的配置</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kubeconfig</span>: <span style="color:#ae81ff">/var/lib/kube-proxy/kubeconfig.conf</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">acceptContentTypes</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">burst</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">contentType</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">qps</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#34;ipvs&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ipvs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scheduler</span>: <span style="color:#e6db74">&#34;rr&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterCIDR</span>: <span style="color:#e6db74">&#34;172.168.0.0/16&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">configSyncPeriod</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">oomScoreAdj</span>: -<span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">portRange</span>: <span style="color:#e6db74">&#34;20000-65535&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeproxy.config.k8s.io/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeProxyConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bindAddress</span>: <span style="color:#ae81ff">0.0.0.0</span>            <span style="color:#75715e"># kube-proxy 监听的地址</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">healthzBindAddress</span>: <span style="color:#e6db74">&#34;&#34;</span>          <span style="color:#75715e"># /healthz 默认 0.0.0.0:10256</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metricsBindAddress</span>: <span style="color:#e6db74">&#34;&#34;</span>          <span style="color:#75715e"># /metrics 默认 0.0.0.0:10249</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">hostnameOverride</span>: <span style="color:#e6db74">&#34;&#34;</span>        <span style="color:#75715e"># kube-proxy 实例的名称，默认 `hostname`</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bindAddressHardFail</span>: <span style="color:#66d9ef">false</span>  <span style="color:#75715e"># 当为true,kube-proxy监听ip和端口失败，报致命错误并退出</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">enableProfiling</span>: <span style="color:#66d9ef">false</span>          <span style="color:#75715e"># 允许 /debug/pprof</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clientConnection</span>:                       <span style="color:#75715e"># 连接apiserver的配置</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kubeconfig</span>: <span style="color:#ae81ff">/var/lib/kube-proxy/kubeconfig.conf</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">acceptContentTypes</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">burst</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">contentType</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">qps</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#34;ipvs&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ipvs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scheduler</span>: <span style="color:#e6db74">&#34;rr&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterCIDR</span>: <span style="color:#e6db74">&#34;172.168.0.0/16&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">configSyncPeriod</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">oomScoreAdj</span>: -<span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">portRange</span>: <span style="color:#e6db74">&#34;20000-65535&#34;</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubelet.config.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeletConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">authentication</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">anonymous</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">webhook</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cacheTTL</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">x509</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clientCAFile</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">Webhook</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">webhook</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cacheAuthorizedTTL</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cacheUnauthorizedTTL</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">cgroupDriver</span>: <span style="color:#ae81ff">cgroupfs</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterDNS</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#ae81ff">172.168.0.2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterDomain</span>: <span style="color:#ae81ff">cluster.local</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">cpuManagerReconcilePeriod</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">evictionPressureTransitionPeriod</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fileCheckFrequency</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">healthzBindAddress</span>: <span style="color:#ae81ff">0.0.0.0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">healthzPort</span>: <span style="color:#ae81ff">10248</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">httpCheckFrequency</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">imageMinimumGCAge</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">logging</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">flushFrequency</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">options</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">json</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">infoBufferSize</span>: <span style="color:#e6db74">&#34;0&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbosity</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">memorySwap</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeStatusReportFrequency</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeStatusUpdateFrequency</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rotateCertificates</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">runtimeRequestTimeout</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">shutdownGracePeriod</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">shutdownGracePeriodCriticalPods</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">staticPodPath</span>: <span style="color:#ae81ff">/etc/kubernetes/manifests</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">streamingConnectionIdleTimeout</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">syncFrequency</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumeStatsAggPeriod</span>: <span style="color:#ae81ff">0s</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm config print join-defaults
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">JoinConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">caCertPath</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">discovery</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">bootstrapToken</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiServerEndpoint</span>: <span style="color:#ae81ff">kube-apiserver:6443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">token</span>: <span style="color:#ae81ff">abcdef.0123456789abcdef</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">unsafeSkipCAVerification</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">5m0s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tlsBootstrapToken</span>: <span style="color:#ae81ff">abcdef.0123456789abcdef</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeRegistration</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">criSocket</span>: <span style="color:#ae81ff">/var/run/dockershim.sock</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">master01</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">taints</span>: <span style="color:#66d9ef">null</span>
</span></span></code></pre></div><p><a href="https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/" target="_blank">Kubeadm | Kubernetes</a></p>
<p><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/" target="_blank">使用 kubeadm 引导集群 | Kubernetes</a></p>
<p><a href="https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/" target="_blank">Kubeadm | Kubernetes</a></p>
<p><a href="https://kubernetes.io/zh-cn/docs/reference/config-api/kubeadm-config.v1beta3/" target="_blank">kubeadm 配置（v1beta3） | Kubernetes</a></p>
<p>控制平面与 kubelet 之间可以存在<strong>一个</strong>次要版本的偏差，但 kubelet 的版本不可以超过 API 服务器的版本。 例如，1.7.0 版本的 kubelet 可以完全兼容 1.8.0 版本的 API 服务器，反之则不可以。</p>
<p><a href="https://kubernetes.io/zh-cn/releases/version-skew-policy/" target="_blank">版本偏差策略 | Kubernetes</a></p>
<p><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#version-skew-policy" target="_blank">使用 kubeadm 创建集群 | Kubernetes</a></p>

</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-dd7941a6270f9943e10317dd4ce21b21">etcd</h1>
	
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-6757bf3544222965ccef5d381b5403b3">etcd</h1>
	<div class="lead">etcd|kubernetes</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h3 id="简介">简介</h3>
<p><a href="https://etcd.io/" target="_blank"><strong>etcd</strong></a> 是CoreOS团队2013年6月发起的分布式k-v 数据库。采用<a href="http://thesecretlivesofdata.com/raft/" target="_blank">raft</a>协议作为一致性算法。</p>
<p>由于 etcd 将数据写入磁盘，因此其性能很大程度上取决于磁盘性能。强烈建议使用ssd硬盘并做好性能测试<a href="https://github.com/axboe/fio" target="_blank">fio</a>。，etcd 默认将可配置的存储大小配额设置为 2GB，因此需留足RAM。对于生产环境建议最大不超过8GB，如果配置的值超过该值，etcd 在启动时发出警告。</p>
<p>硬件最小建议：</p>
<ul>
<li>8GB 内存</li>
<li>100GB 磁盘</li>
<li>4核 CPU</li>
</ul>
<h2 id="第一节集群安装">第一节集群安装</h2>
<table>
  <thead>
      <tr>
          <th>主机名</th>
          <th>主机ip</th>
          <th>etcd节点名称</th>
          <th>版本</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>etcd-1.k8s.com</td>
          <td>10.4.7.200/24</td>
          <td>etcd-1</td>
          <td><a href="https://github.com/etcd-io/etcd/releases/tag/v3.5.0" target="_blank">v.13.5.0</a></td>
      </tr>
      <tr>
          <td>etcd-2.k8s.com</td>
          <td>10.4.7.201/24</td>
          <td>etcd-2</td>
          <td><a href="https://github.com/etcd-io/etcd/releases/tag/v3.5.0" target="_blank">v.13.5.0</a></td>
      </tr>
      <tr>
          <td>etcd-3.k8s.com</td>
          <td>10.4.7.202/24</td>
          <td>etcd-3</td>
          <td><a href="https://github.com/etcd-io/etcd/releases/tag/v3.5.0" target="_blank">v.13.5.0</a></td>
      </tr>
  </tbody>
</table>
<p><strong>第一步生成证书</strong></p>
<p><em>请求文件</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat etcd.cnf 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>req<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>req_extensions <span style="color:#f92672">=</span> v3_req
</span></span><span style="display:flex;"><span>distinguished_name <span style="color:#f92672">=</span> req_distinguished_name
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> req_distinguished_name <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> v3_req <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>basicConstraints <span style="color:#f92672">=</span> CA:FALSE
</span></span><span style="display:flex;"><span>keyUsage <span style="color:#f92672">=</span> nonRepudiation,digitalSignature,keyEncipherment
</span></span><span style="display:flex;"><span>subjectAltName <span style="color:#f92672">=</span> @alt_names
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>alt_names<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>IP.1 <span style="color:#f92672">=</span> 10.4.7.200
</span></span><span style="display:flex;"><span>IP.2 <span style="color:#f92672">=</span> 10.4.7.201
</span></span><span style="display:flex;"><span>IP.3 <span style="color:#f92672">=</span> 10.4.7.202
</span></span></code></pre></div><p><em>ca证书</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl genrsa -out ca.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl req -new -key ca.key -out ca.csr -subj <span style="color:#e6db74">&#34;/CN=etcd&#34;</span>
</span></span><span style="display:flex;"><span>openssl x509 -req -in ca.csr -out ca.crt -signkey ca.key -days <span style="color:#ae81ff">365</span>
</span></span></code></pre></div><p><em>server证书</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl genrsa -out server.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl req -new -key server.key -out server.csr -subj <span style="color:#e6db74">&#34;/CN=etcd-server&#34;</span> -config etcd.cnf
</span></span><span style="display:flex;"><span>openssl x509 -req -in server.csr -out server.crt -signkey server.key -CA ca.crt -CAkey ca.key -CAcreateserial -days <span style="color:#ae81ff">365</span> -extensions v3_req -extfile etcd.cnf
</span></span></code></pre></div><p><em>peer证书</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl genrsa -out peer.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl req -new -key peer.key -out peer.csr -subj <span style="color:#e6db74">&#34;/CN=etcd-peer&#34;</span> -config etcd.cnf
</span></span><span style="display:flex;"><span>openssl x509 -req -in peer.csr -out peer.crt -signkey peer.key -CA ca.crt -CAkey ca.key -CAcreateserial -days <span style="color:#ae81ff">365</span> -extensions v3_req -extfile etcd.cnf
</span></span></code></pre></div><p><strong>第二步配置启动文件</strong></p>
<p><span id=config></span></p>
<blockquote>
<p><font color=EF5A04 size=5>注意</font></p>
<p>每个节点需要按需修改</p>
<p><code>--name </code>
<code>--listen-peer-urls</code>
<code>--initial-advertise-peer-urls</code>
<code>--listen-client-urls</code>
<code>--advertise-client-urls</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#75715e">#!/bin/bash</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># v3.4+ 可以不指定ETCDCTL_API </span>
</span></span><span style="display:flex;"><span> export ETCDCTL_API<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span> /opt/etcd/etcd <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --name etcd-3 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --listen-peer-urls <span style="color:#e6db74">&#39;https://10.4.7.202:2380&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --initial-advertise-peer-urls <span style="color:#e6db74">&#39;https://10.4.7.202:2380&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> <span style="color:#75715e"># etcd 服务监听的地址，用于客户端连接</span>
</span></span><span style="display:flex;"><span> --listen-client-urls <span style="color:#e6db74">&#39;https://10.4.7.202:2379,http://127.0.0.1:2379&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> <span style="color:#75715e"># etcd 对外广播的地址，用户客户端和其他etcd成员连接</span>
</span></span><span style="display:flex;"><span> --advertise-client-urls <span style="color:#e6db74">&#39;https://10.4.7.202:2379&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --initial-cluster-state <span style="color:#e6db74">&#39;new&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --initial-cluster-token <span style="color:#e6db74">&#39;etcd-cluster&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --initial-cluster <span style="color:#e6db74">&#39;etcd-1=https://10.4.7.200:2380,etcd-2=https://10.4.7.201:2380,etcd-3=https://10.4.7.202:2380&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --client-cert-auth --trusted-ca-file<span style="color:#f92672">=</span>./ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --cert-file<span style="color:#f92672">=</span>server.crt --key-file<span style="color:#f92672">=</span>server.key  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --peer-client-cert-auth --peer-trusted-ca-file<span style="color:#f92672">=</span>./ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --peer-cert-file<span style="color:#f92672">=</span>./peer.crt --peer-key-file<span style="color:#f92672">=</span>./peer.key
</span></span></code></pre></div><p><strong>第三步启动etcd并检查</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/etcd/etcdctl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--endpoints<span style="color:#f92672">=</span>https://10.4.7.200:2379,https://10.4.7.201:2379,https://10.4.7.202:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cacert<span style="color:#f92672">=</span>./ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert<span style="color:#f92672">=</span>peer.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key<span style="color:#f92672">=</span>peer.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>member list -w table
</span></span></code></pre></div><p><img src="https://img2022.cnblogs.com/blog/2108528/202211/2108528-20221113192958390-1282145596.png" alt=""></p>
<hr>
<h2 id="第二节集群备份和恢复">第二节集群备份和恢复</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>        restore Restores an etcd member snapshot to an etcd directory
</span></span><span style="display:flex;"><span>        save    Stores an etcd node backend snapshot to a given file
</span></span><span style="display:flex;"><span>        status  <span style="color:#f92672">[</span>deprecated<span style="color:#f92672">]</span> Gets backend snapshot status of a given file
</span></span></code></pre></div><p><strong>第一步生成测试内容</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/etcd/etcdctl --endpoints<span style="color:#f92672">=</span>https://10.4.7.200:2379 --cacert<span style="color:#f92672">=</span>./ca.crt --cert<span style="color:#f92672">=</span>peer.crt --key<span style="color:#f92672">=</span>peer.key put name 张三
</span></span></code></pre></div><p><strong>第二步备份数据</strong></p>
<blockquote>
<p>连接到集群任意节点</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/etcd/etcdctl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--endpoints<span style="color:#f92672">=</span>https://10.4.7.200:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cacert<span style="color:#f92672">=</span>./ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert<span style="color:#f92672">=</span>peer.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key<span style="color:#f92672">=</span>peer.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>snapshot save /data/backup/2022-11-13.db
</span></span></code></pre></div><p><em>查看备份文件状态</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/etcd/etcdctl snapshot status /data/backup/2022-11-13.db -w table
</span></span></code></pre></div><p><img src="https://img2022.cnblogs.com/blog/2108528/202211/2108528-20221113193027066-1955276160.png" alt=""></p>
<p><strong>第三步模拟破坏数据</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/etcd/etcdctl --endpoints<span style="color:#f92672">=</span>https://10.4.7.200:2379 --cacert<span style="color:#f92672">=</span>./ca.crt --cert<span style="color:#f92672">=</span>peer.crt --key<span style="color:#f92672">=</span>peer.key del name
</span></span></code></pre></div><p><strong>第四步恢复数据</strong></p>
<blockquote>
<p><font color=EF5A04 size=5>注意</font></p>
<ul>
<li>停止集群所有节点etcd进程，备份原数据文件</li>
<li>停止所有kube-apiserver</li>
<li>集群所有节点执行恢复动作，注意修改 <code>--name</code> <code>--initial-advertise-peer-urls</code> <code>--data-dir</code></li>
<li>执行启动命令</li>
</ul>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ETCDCTL_API<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> 
</span></span><span style="display:flex;"><span>/opt/etcd/etcdctl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>snapshot restore /data/backup/2022-11-13.db <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--name etcd-1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--initial-cluster <span style="color:#e6db74">&#34;etcd-1=https://10.4.7.200:2380,etcd-2=https://10.4.7.201:2380,etcd-3=https://10.4.7.202:2380&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--initial-cluster-token etcd-cluster <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--initial-advertise-peer-urls https://10.4.7.200:2380 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--data-dir<span style="color:#f92672">=</span>./etcd-1.etcd
</span></span></code></pre></div><p><strong>第五步启动集群</strong></p>
<p>参考集群安装中启动脚本<a href=#config>启动集群</a></p>
<p><em>验证恢复</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@radius-db03 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /opt/etcd/etcdctl --endpoints=https://10.4.7.200:2379 --cacert=./ca.crt --cert=peer.crt --key=peer.key get name</span>
</span></span><span style="display:flex;"><span>name
</span></span><span style="display:flex;"><span>张三
</span></span></code></pre></div><p><strong>备份脚本</strong></p>

<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#！/bin/bash</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># describe: this scribe to backup etcd </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create by 1209233066@qq.com</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># usage: </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># MAILTO=&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 59 23 * * * /bin/bash /scribe/etcd_backup.sh &gt;/dev/null 2&gt;&amp;1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 主机名</span>
</span></span><span style="display:flex;"><span>hostName<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>hostname<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IP</span>
</span></span><span style="display:flex;"><span>hostIp<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>hostname -i|awk <span style="color:#e6db74">&#39;{print $NF}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 备份路径</span>
</span></span><span style="display:flex;"><span>backupDir<span style="color:#f92672">=</span>/data/backup/etcd
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 证书文件</span>
</span></span><span style="display:flex;"><span>caCert<span style="color:#f92672">=</span>/etc/kubernetes/pki/etcd/ca.crt
</span></span><span style="display:flex;"><span>cert<span style="color:#f92672">=</span>/etc/kubernetes/pki/etcd/server.crt
</span></span><span style="display:flex;"><span>key<span style="color:#f92672">=</span>/etc/kubernetes/pki/etcd/server.key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 是否为leader</span>
</span></span><span style="display:flex;"><span>ETCDCTL_API<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>isLeader<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>/usr/bin/etcdctl --endpoints<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>hostIp<span style="color:#e6db74">}</span>:2379 endpoint status|awk -F <span style="color:#e6db74">&#34;,&#34;</span> <span style="color:#e6db74">&#39;{print $5}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 备份</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">${</span>isLeader<span style="color:#e6db74">}</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>   echo <span style="color:#e6db74">&#34;The </span><span style="color:#e6db74">${</span>hostName<span style="color:#e6db74">}</span><span style="color:#e6db74"> instance is the etcd leader,does not require backup&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>   /usr/bin/etcdctl --cacert<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>caCert<span style="color:#e6db74">}</span> --cert<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>cert<span style="color:#e6db74">}</span> --key<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>key<span style="color:#e6db74">}</span>  snapshot save <span style="color:#e6db74">${</span>backupDir<span style="color:#e6db74">}</span>/etcd-<span style="color:#e6db74">${</span>hostName<span style="color:#e6db74">}</span>-<span style="color:#e6db74">`</span>date+%Y%m%d<span style="color:#e6db74">`</span>.db
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 推送s3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 本地保留</span>
</span></span><span style="display:flex;"><span>find  <span style="color:#e6db74">${</span>backupDir<span style="color:#e6db74">}</span> -name *.db -mtime +30 |xargs rm -f
</span></span></code></pre></div></details>

<hr>
<h2 id="第三节下线节点">第三节下线节点</h2>
<p><strong>第一步获取节点id</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/etcd/etcdctl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--endpoints<span style="color:#f92672">=</span>https://10.4.7.200:2379,https://10.4.7.201:2379,https://10.4.7.202:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cacert<span style="color:#f92672">=</span>./ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert<span style="color:#f92672">=</span>peer.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key<span style="color:#f92672">=</span>peer.key  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>member list
</span></span></code></pre></div><p><strong>第二步下线节点</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/etcd/etcdctl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--endpoints<span style="color:#f92672">=</span>https://10.4.7.200:2379,https://10.4.7.201:2379,https://10.4.7.202:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cacert<span style="color:#f92672">=</span>./ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert<span style="color:#f92672">=</span>peer.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key<span style="color:#f92672">=</span>peer.key  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>member remove 19a4c376178d5b49
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Member 19a4c376178d5b49 removed from cluster d5f1887e154dc473
</span></span></code></pre></div><hr>
<h2 id="第四节集群扩容">第四节集群扩容</h2>
<p><strong>第一步集群中执行添加</strong></p>
<blockquote>
<p><font color=EF5A04 size=5>注意</font></p>
<p>示例中<code>10.4.7.202</code> 需要在签证书时已经存在在<code>etcd.cnf</code> 中</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/etcd/etcdctl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--endpoints<span style="color:#f92672">=</span>https://10.4.7.200:2379,https://10.4.7.201:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cacert<span style="color:#f92672">=</span>./ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert<span style="color:#f92672">=</span>peer.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key<span style="color:#f92672">=</span>peer.key  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>member add etcd-2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--peer-urls<span style="color:#f92672">=</span>https://10.4.7.202:2380
</span></span></code></pre></div><p><em>执行命令后返回值</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Member 8c993ee76df9da92 added to cluster d5f1887e154dc473
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ETCD_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;etcd-2&#34;</span>
</span></span><span style="display:flex;"><span>ETCD_INITIAL_CLUSTER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;etcd-1=https://10.4.7.200:2380,etcd-2=https://10.4.7.201:2380,etcd-2=https://10.4.7.202:2380&#34;</span>
</span></span><span style="display:flex;"><span>ETCD_INITIAL_ADVERTISE_PEER_URLS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://10.4.7.202:2380&#34;</span>
</span></span><span style="display:flex;"><span>ETCD_INITIAL_CLUSTER_STATE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;existing&#34;</span>
</span></span></code></pre></div><p><strong>第二步启动新加入节点</strong></p>
<p>参考集群安装中启动脚本<a href=#config>启动集群</a>，需要把<code>--initial-cluster-state 'new' </code> 修改为 <code>--initial-cluster-state 'existing' </code></p>
<hr>
<h2 id="第五节其他指令">第五节其他指令</h2>
<p>节点的健康状态 <em>endpoint health</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#f92672">=</span>10.4.7.250:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cacert<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/kubernetes/ssl/ca.pem&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/kubernetes/ssl/etcd.pem&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/kubernetes/ssl/etcd-key.pem&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>endpoint health --write-out<span style="color:#f92672">=</span>table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>+-----------------+--------+-------------+-------+
</span></span><span style="display:flex;"><span>|    ENDPOINT     | HEALTH |    TOOK     | ERROR |
</span></span><span style="display:flex;"><span>+-----------------+--------+-------------+-------+
</span></span><span style="display:flex;"><span>| 10.4.7.250:2379 |   true | 12.901855ms |       |
</span></span><span style="display:flex;"><span>+-----------------+--------+-------------+-------+
</span></span></code></pre></div><p>集群成员 <em>member list</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl member list --write-out<span style="color:#f92672">=</span>table
</span></span><span style="display:flex;"><span>+------------------+---------+-----------------+-------------------------+-------------------------+------------+
</span></span><span style="display:flex;"><span>|        ID        | STATUS  |      NAME       |       PEER ADDRS        |      CLIENT ADDRS       | IS LEARNER |
</span></span><span style="display:flex;"><span>+------------------+---------+-----------------+-------------------------+-------------------------+------------+
</span></span><span style="display:flex;"><span>| 5c3282345e325481 | started | etcd-10.4.7.250 | https://10.4.7.250:2380 | https://10.4.7.250:2379 |      false |
</span></span><span style="display:flex;"><span>+------------------+---------+-----------------+-------------------------+-------------------------+------------+
</span></span></code></pre></div><p>节点状态<em>endpoint status</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#f92672">=</span>10.4.7.250:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cacert<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/kubernetes/ssl/ca.pem&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/kubernetes/ssl/etcd.pem&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/kubernetes/ssl/etcd-key.pem&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>endpoint status --write-out<span style="color:#f92672">=</span>table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span><span style="display:flex;"><span>|    ENDPOINT     |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
</span></span><span style="display:flex;"><span>+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span><span style="display:flex;"><span>| 10.4.7.250:2379 | 5c3282345e325481 |   3.5.0 |  2.9 MB |      true |      false |         <span style="color:#ae81ff">2</span> |     <span style="color:#ae81ff">216020</span> |             <span style="color:#ae81ff">216020</span> |        |
</span></span><span style="display:flex;"><span>+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span></code></pre></div><p>性能测试<em>check perf</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@etcd-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># etcdctl check perf</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">60</span> / <span style="color:#ae81ff">60</span> Booooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo! 100.00% 1m0s
</span></span><span style="display:flex;"><span>PASS: Throughput is <span style="color:#ae81ff">150</span> writes/s
</span></span><span style="display:flex;"><span>PASS: Slowest request took 0.017941s
</span></span><span style="display:flex;"><span>PASS: Stddev is 0.000807s
</span></span><span style="display:flex;"><span>PASS
</span></span></code></pre></div><p><strong>查询</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>查询key
</span></span><span style="display:flex;"><span>1. 拿到所有key
</span></span><span style="display:flex;"><span>etcdctl get / --prefix --keys-only
</span></span><span style="display:flex;"><span>2. 查询指定key.值是被序列化过的，因此可能会乱码
</span></span><span style="display:flex;"><span>etcdctl get /registry/storageclasses/csi-rbd-sc
</span></span></code></pre></div><p><strong>增加</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl put /name wang
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div><p><strong>查询</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl get /name
</span></span><span style="display:flex;"><span>/name
</span></span><span style="display:flex;"><span>wang
</span></span><span style="display:flex;"><span><span style="color:#75715e"># watch 一直监听 /name 这个key的变动</span>
</span></span><span style="display:flex;"><span>etcdctl watch /name
</span></span></code></pre></div><p><strong>删除</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@ceph ~<span style="color:#f92672">]</span><span style="color:#75715e"># etcdctl del /name</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><h2 id="参考">参考</h2>
<p><a href="https://www.jdon.com/artichect/raft.html" target="_blank">raft</a>|<a href="https://raft.github.io/raft.pdf" target="_blank">raft</a></p>
<p><a href="https://www.cnblogs.com/iiiiher/p/7873737.html" target="_blank">https证书最佳实战目录 - _毛台 - 博客园 (cnblogs.com)</a></p>
<p><a href="https://www.cnblogs.com/hsyw/p/15652417.html" target="_blank">ETCD数据的备份与恢复 - taotaozh - 博客园 (cnblogs.com)</a></p>

</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-4ce3ee82b87425866c30064e2fe818d1">coredns</h1>
	
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-06-04" class="text-body-secondary">Wednesday, June 04, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-6f870bba994b1b821803cd715828f8ab">快速开始</h1>
	<div class="lead">coredns|kubernetes</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-30" class="text-body-secondary">Friday, May 30, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<p><a href="https://coredns.io/manual/toc/" target="_blank">CoreDNS</a>是由Go语言编写的<a href="https://www.apache.org/licenses/LICENSE-2.0.html" target="_blank">开源</a>DNS服务，通过大量插件实现了复杂的功能。因此在实现上不同于<a href="https://www.isc.org/bind/" target="_blank">BIND</a>，<a href="https://www.knot-dns.cz/" target="_blank">Knot</a>，<a href="https://www.powerdns.com/" target="_blank">PowerDNS</a>，<a href="https://www.unbound.net/" target="_blank">Unbound</a> 等dns软件</p>
<h3 id="基本概念">基本概念</h3>
<p><strong>A/AAAA 记录</strong></p>
<p><strong>SRV 记录</strong></p>
<p><strong>PTR 记录</strong>  是dns的反向解析，用于将ip地址解析为域名。例如存在一条A记录：  <code>172.168.0.1 kubernetes.default.svc.cluster.local</code>  使用PTR可以通过 172.168.0.1 找到对应的域名为<code>kubernetes.default.svc.in-addr.arpa</code> 域名。
PTR 记录存储在 DNS 的 <code>.arpa</code> 顶级域中，<code>.arpa</code> 是一个用于管理网络基础设施的域，是为互联网定义的<a href="https://tools.ietf.org/html/rfc881" target="_blank">第一个</a>顶级域名。（“arpa”这个名字可以追溯到互联网的早期：它的名字来源于高级研究计划署 (ARPA)，它创建了互联网的重要前身 ARPANET。）
二级域名 <code>.in-addr</code> 代表了ipv4，因此表示为 <code>.in-addr.arpa</code> 。对于ipv6 对应 <code>.ip6.arpa</code></p>
<h3 id="安装部署">安装部署</h3>


  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="容器" aria-controls="tabs-00-00" aria-selected="true">
        容器
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="二进制" aria-controls="tabs-00-01" aria-selected="false">
        二进制
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --name coredns -p53:53 coredns/coredns:latest
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <p>下载</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/coredns/coredns/releases/download/v1.10.0/coredns_1.10.0_linux_amd64.tgz
</span></span><span style="display:flex;"><span>tar xf coredns_1.10.0_linux_amd64.tgz -C /usr/bin/
</span></span></code></pre></div><p>启动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lavm-ioreaqndwv ~<span style="color:#f92672">]</span><span style="color:#75715e"># coredns -dns.port1053</span>
</span></span><span style="display:flex;"><span>.:1053
</span></span><span style="display:flex;"><span>CoreDNS-1.10.0
</span></span><span style="display:flex;"><span>linux/amd64, go1.19.1, 596a9f9
</span></span></code></pre></div>
    </div>
</div>

<h3 id="配置文件">配置文件</h3>


<div class="alert alert-primary" role="alert">


    <ul>
<li>
<p>启动时默认查找当前目录下的<code>Corefile</code>配置文件， 可通过 <code>coredns -conf /etc/Corefile</code> 指定自定义配置文件</p>
</li>
<li>
<p><code>#</code>开头视为注释</p>
</li>
<li>
<p><code>{$ENV_VAR}</code> 引用操作系统变量</p>
</li>
<li>
<p>支持片段定义和引用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 定义一个名为plg的片段</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>plg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    errors
</span></span><span style="display:flex;"><span>    forward . 8.8.8.8 223.5.5.5
</span></span><span style="display:flex;"><span>    reload
</span></span><span style="display:flex;"><span>    log
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 引用片段</span>
</span></span><span style="display:flex;"><span>    import plg
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>


</div>



<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">server 块的定义</h4>

    <p>定义一组dns服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&lt;zone&gt;<span style="color:#f92672">[</span>:&lt;port&gt;<span style="color:#f92672">]</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    &lt;plugin1&gt; <span style="color:#f92672">[</span>参数...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    &lt;plugin2&gt; <span style="color:#f92672">[</span>参数...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>. <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     &lt;plugin1&gt; <span style="color:#f92672">[</span>参数...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     &lt;plugin1&gt; <span style="color:#f92672">[</span>参数...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>coredns.io:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     &lt;plugin1&gt; <span style="color:#f92672">[</span>参数...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>配置示例：</strong> 配置了两个server,每个server有自己的插件链</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># server 定义语法 [zone] [port...] {...}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 对所有域名执行解析</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>plg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    errors
</span></span><span style="display:flex;"><span>    forward . 8.8.8.8 223.5.5.5
</span></span><span style="display:flex;"><span>    reload
</span></span><span style="display:flex;"><span>    log
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    prometheus :9153
</span></span><span style="display:flex;"><span>    hosts <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        1.2.3.4 zero-dew.cn
</span></span><span style="display:flex;"><span>        fallthrough
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    import plg
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 仅解析 .com</span>
</span></span><span style="display:flex;"><span>com.:54 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    prometheus :9154
</span></span><span style="display:flex;"><span>    hosts <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        1.2.3.4 zero-dew.cn
</span></span><span style="display:flex;"><span>        1.2.3.5 zero-dew.com
</span></span><span style="display:flex;"><span>        fallthrough
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    import plg
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-d11a373a06597e58266f084a9f1fdd5a">基础插件</h1>
	<div class="lead">plugin|kubernetes</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-31" class="text-body-secondary">Saturday, May 31, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<p>目前coredns1.12.1已集成了30+内置插件，同时也支持用户在编译时引入更多的外部插件(<em>类似nginx</em>)，插件在<code>corefile</code>中的位置不影响插件的执行顺序（<a href="https://github.com/coredns/coredns/blob/master/plugin.cfg" target="_blank"><code>plugin.cfg</code></a> 文件定义顺序决定）。<code>./coredns --plugins</code> 查看当前coredns支持哪些插件</p>
<h3 id="health">health</h3>
<blockquote>
<p><a href="https://coredns.io/plugins/health/" target="_blank">https://coredns.io/plugins/health/</a></p>
</blockquote>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">语法</h4>

    提供一个<code>http://0.0.0.0:8080/health</code> 的接口检查coredns是否就绪。主要关注coredns进程本身,通常使用在livenessProbe

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      health localhost:8080 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        lameduck 5s <span style="color:#75715e">#当CoreDNS收到终止信号（如 Pod 被删除或重启时），会先进入lameduck状态 5 秒，在这 5 秒内/health检查仍然会返回 200 OK， /ready 不会返回 OK。</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">#作用：给负载均衡器（如 kube-proxy、Service、Ingress）时间把流量切走，避免请求丢失。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="ready">ready</h3>
<blockquote>
<p><a href="https://coredns.io/plugins/ready/" target="_blank">https://coredns.io/plugins/ready/</a></p>
</blockquote>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">语法</h4>

    提供一个<code>http://0.0.0.0:8181/ready </code> 的接口,当所有plugins都就绪是返回200,如果某个plugin不可用时返回503。可以用于readinessProbe

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      health localhost:8080 <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            lameduck 5s 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      ready localhost:8181
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="reload">reload</h3>
<blockquote>
<p><a href="https://coredns.io/plugins/reload/" target="_blank">https://coredns.io/plugins/reload/</a></p>
</blockquote>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">语法</h4>

    <p>定期检查 Corefile 是否发生变化，通过读取并计算其 SHA512 校验和来实现自动重新加载</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># INTERVAL和JITTER是Go语言时间持续时间。默认的INTERVAL是30s，默认的JITTER是15s</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># INTERVAL 的最小值为2s， JITTER的最小值为 1s</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果 JITTER大于INTERVAL的一半，它将被设置为INTERVAL的一半。</span>
</span></span><span style="display:flex;"><span>reload <span style="color:#f92672">[</span>INTERVAL<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>JITTER<span style="color:#f92672">]</span>
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      health localhost:8080 <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            lameduck 5s 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      ready localhost:8181
</span></span><span style="display:flex;"><span>      reload
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="log">log</h3>
<blockquote>
<p><a href="https://coredns.io/plugins/log/" target="_blank">https://coredns.io/plugins/log/</a></p>
</blockquote>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">语法</h4>

    记录日志，支持对日志格式的定制

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      health localhost:8080 <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            lameduck 5s 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      ready localhost:8181
</span></span><span style="display:flex;"><span>      reload
</span></span><span style="display:flex;"><span>      log
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="errors">errors</h3>
<blockquote>
<p><a href="https://coredns.io/plugins/errors/" target="_blank">https://coredns.io/plugins/errors/</a></p>
</blockquote>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">语法</h4>

    查询处理过程中遇到的任何错误都会被打印到标准输出

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      health localhost:8080 <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            lameduck 5s 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      ready localhost:8181
</span></span><span style="display:flex;"><span>      reload
</span></span><span style="display:flex;"><span>      log
</span></span><span style="display:flex;"><span>      errors
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="prometheus">prometheus</h3>
<blockquote>
<p><a href="https://coredns.io/plugins/metrics/" target="_blank">https://coredns.io/plugins/metrics/</a></p>
</blockquote>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">语法</h4>

    暴露一组prometheus格式的指标

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      health localhost:8080 <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            lameduck 5s 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      ready localhost:8181
</span></span><span style="display:flex;"><span>      reload
</span></span><span style="display:flex;"><span>      log
</span></span><span style="display:flex;"><span>      errors
</span></span><span style="display:flex;"><span>      prometheus :9153
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>主要指标</strong></p>
<table>
  <thead>
      <tr>
          <th>指标解释</th>
          <th>指标</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>版本信息</td>
          <td><code>coredns_build_info{version, revision, goversion}</code></td>
          <td></td>
      </tr>
      <tr>
          <td>开启的插件</td>
          <td><code>coredns_plugin_enabled{server, zone, view, name}</code></td>
          <td></td>
      </tr>
      <tr>
          <td>99%查询响应时长</td>
          <td><code>histogram_quantile(0.99,coredns_dns_request_duration_seconds_bucket)</code></td>
          <td></td>
      </tr>
      <tr>
          <td>reload失败次数</td>
          <td><code>coredns_reload_failed_total</code></td>
          <td></td>
      </tr>
      <tr>
          <td>最后重启时间</td>
          <td><code>coredns_hosts_reload_timestamp_seconds </code></td>
          <td></td>
      </tr>
      <tr>
          <td>健康检查失败次数</td>
          <td><code>coredns_health_request_failures_total </code></td>
          <td></td>
      </tr>
      <tr>
          <td>缓存命中率</td>
          <td><code>coredns_cache_hits_total/coredns_dns_requests_total</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="trace">trace</h3>
<blockquote>
<p><a href="https://coredns.io/plugins/trace/" target="_blank">https://coredns.io/plugins/trace/</a></p>
</blockquote>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">语法</h4>

    链路追踪

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d -p 9411:9411 openzipkin/zipkin
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      health localhost:8080 <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            lameduck 5s 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      ready localhost:8181
</span></span><span style="display:flex;"><span>      reload
</span></span><span style="display:flex;"><span>      log
</span></span><span style="display:flex;"><span>      errors
</span></span><span style="display:flex;"><span>      prometheus :9153
</span></span><span style="display:flex;"><span>      trace zipkin
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="forward">forward</h3>
<blockquote>
<p><a href="https://coredns.io/plugins/forward/" target="_blank">https://coredns.io/plugins/forward/</a></p>
</blockquote>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">语法</h4>

    <p>转发dns查询到上游dns服务器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># FROM 定义要转发的域，TO可以是上游dnsip或/etc/resolv.conf文件</span>
</span></span><span style="display:flex;"><span>forward FROM TO... <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    except IGNORED_NAMES...
</span></span><span style="display:flex;"><span>    force_tcp
</span></span><span style="display:flex;"><span>    prefer_udp
</span></span><span style="display:flex;"><span>    expire DURATION
</span></span><span style="display:flex;"><span>    max_fails INTEGER
</span></span><span style="display:flex;"><span>    tls CERT KEY CA
</span></span><span style="display:flex;"><span>    tls_servername NAME
</span></span><span style="display:flex;"><span>    policy random|round_robin|sequential
</span></span><span style="display:flex;"><span>    health_check DURATION <span style="color:#f92672">[</span>no_rec<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>domain FQDN<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    max_concurrent MAX
</span></span><span style="display:flex;"><span>    next RCODE_1 <span style="color:#f92672">[</span>RCODE_2<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>RCODE_3...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      health localhost:8080 <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            lameduck 5s 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      ready localhost:8181
</span></span><span style="display:flex;"><span>      reload
</span></span><span style="display:flex;"><span>      log
</span></span><span style="display:flex;"><span>      errors
</span></span><span style="display:flex;"><span>      prometheus :9153
</span></span><span style="display:flex;"><span>      trace zipkin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      forward . 223.5.5.5 114.114.114.114 <span style="color:#f92672">{</span> expire 10s <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="cache">cache</h3>
<blockquote>
<p><a href="https://coredns.io/plugins/cache/" target="_blank">https://coredns.io/plugins/cache/</a></p>
</blockquote>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">语法</h4>

    <p>缓存从后端（上游、数据库等）获取到的数据，默认 3600s</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cache <span style="color:#f92672">[</span>TTL<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>ZONES...<span style="color:#f92672">]</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    success CAPACITY <span style="color:#f92672">[</span>TTL<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>MINTTL<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    denial CAPACITY <span style="color:#f92672">[</span>TTL<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>MINTTL<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    prefetch AMOUNT <span style="color:#f92672">[[</span>DURATION<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>PERCENTAGE%<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>    serve_stale <span style="color:#f92672">[</span>DURATION<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>REFRESH_MODE<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    servfail DURATION
</span></span><span style="display:flex;"><span>    disable success|denial <span style="color:#f92672">[</span>ZONES...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    keepttl
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      health localhost:8080 <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            lameduck 5s 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      ready localhost:8181
</span></span><span style="display:flex;"><span>      reload
</span></span><span style="display:flex;"><span>      log
</span></span><span style="display:flex;"><span>      errors
</span></span><span style="display:flex;"><span>      prometheus :9153
</span></span><span style="display:flex;"><span>      trace zipkin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      forward . 223.5.5.5 114.114.114.114 <span style="color:#f92672">{</span> expire 10s <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      cache <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="hosts">hosts</h3>
<blockquote>
<p><a href="https://coredns.io/plugins/hosts/" target="_blank">https://coredns.io/plugins/hosts/</a></p>
</blockquote>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">语法</h4>

    <p>提供自定义dns解析的能力，默认5s扫描一次文件的变动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>hosts <span style="color:#f92672">[</span>FILE <span style="color:#f92672">[</span>ZONES...<span style="color:#f92672">]]</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>INLINE<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    ttl SECONDS
</span></span><span style="display:flex;"><span>    no_reverse
</span></span><span style="display:flex;"><span>    reload DURATION
</span></span><span style="display:flex;"><span>    fallthrough <span style="color:#f92672">[</span>ZONES...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>

</div>


  

   

<ul class="nav nav-tabs" id="tabs-10" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-10-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-10-00" role="tab"
          data-td-tp-persist="样例1" aria-controls="tabs-10-00" aria-selected="true">
        样例1
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-10-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-10-01" role="tab"
          data-td-tp-persist="样例2" aria-controls="tabs-10-01" aria-selected="false">
        样例2
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-10-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-10-00" role="tabpanel" aria-labelled-by="tabs-10-00-tab" tabindex="10">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      health localhost:8080 <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            lameduck 5s 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      ready localhost:8181
</span></span><span style="display:flex;"><span>      reload
</span></span><span style="display:flex;"><span>      log
</span></span><span style="display:flex;"><span>      errors
</span></span><span style="display:flex;"><span>      prometheus :9153
</span></span><span style="display:flex;"><span>      trace zipkin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      forward . 223.5.5.5 114.114.114.114 <span style="color:#f92672">{</span> expire 10s <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      cache <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      hosts <span style="color:#f92672">{</span> 						<span style="color:#75715e"># 使用本机的/etc/hosts文件</span>
</span></span><span style="display:flex;"><span>          1.2.3.4 zero-dew.cn 		<span style="color:#75715e"># 扩展定义其他地址解析</span>
</span></span><span style="display:flex;"><span>          1.2.3.5 zero-dew.com
</span></span><span style="display:flex;"><span>          ttl <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>          reload 30s
</span></span><span style="display:flex;"><span>          fallthrough
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-10-01" role="tabpanel" aria-labelled-by="tabs-10-01-tab" tabindex="10">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      health localhost:8080 <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            lameduck 5s 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      ready localhost:8181
</span></span><span style="display:flex;"><span>      reload
</span></span><span style="display:flex;"><span>      log
</span></span><span style="display:flex;"><span>      errors
</span></span><span style="display:flex;"><span>      prometheus :9153
</span></span><span style="display:flex;"><span>      trace zipkin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      forward . 223.5.5.5 114.114.114.114 <span style="color:#f92672">{</span> expire 10s <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      cache <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      hosts /etc/test.host <span style="color:#f92672">{</span> 		<span style="color:#75715e"># 使用/etc/test.host 文件中定义的地址解析</span>
</span></span><span style="display:flex;"><span>          1.2.3.4 zero-dew.cn 		<span style="color:#75715e"># 扩展定义其他地址解析</span>
</span></span><span style="display:flex;"><span>          1.2.3.5 zero-dew.com
</span></span><span style="display:flex;"><span>          ttl <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>          reload 30s
</span></span><span style="display:flex;"><span>          fallthrough
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>
    </div>
</div>

<p>监控指标</p>
<ul>
<li><code>coredns_hosts_entries{}</code> DNS条目数量</li>
<li><code>coredns_hosts_reload_timestamp_seconds{}</code> 最近重载时间</li>
</ul>
<h3 id="kubernetes">kubernetes</h3>
<blockquote>
<p><a href="https://coredns.io/plugins/kubernetes/" target="_blank">https://coredns.io/plugins/kubernetes/</a></p>
</blockquote>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">语法</h4>

    <p>动态提供svc、pod 等dns解析能力</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubernetes <span style="color:#f92672">[</span>ZONES...<span style="color:#f92672">]</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    endpoint URL
</span></span><span style="display:flex;"><span>    tls CERT KEY CACERT
</span></span><span style="display:flex;"><span>    kubeconfig KUBECONFIG <span style="color:#f92672">[</span>CONTEXT<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    namespaces NAMESPACE...
</span></span><span style="display:flex;"><span>    labels EXPRESSION
</span></span><span style="display:flex;"><span>    pods POD-MODE
</span></span><span style="display:flex;"><span>    endpoint_pod_names
</span></span><span style="display:flex;"><span>    ttl TTL
</span></span><span style="display:flex;"><span>    noendpoints
</span></span><span style="display:flex;"><span>    fallthrough <span style="color:#f92672">[</span>ZONES...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    ignore empty_service
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      health localhost:8080 <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            lameduck 5s 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      ready localhost:8181
</span></span><span style="display:flex;"><span>      reload
</span></span><span style="display:flex;"><span>      log
</span></span><span style="display:flex;"><span>      errors
</span></span><span style="display:flex;"><span>      prometheus :9153
</span></span><span style="display:flex;"><span>      trace zipkin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      forward . 223.5.5.5 114.114.114.114 <span style="color:#f92672">{</span> expire 10s <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      cache <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      hosts <span style="color:#f92672">{</span> 						<span style="color:#75715e"># 使用本机的/etc/hosts文件</span>
</span></span><span style="display:flex;"><span>          1.2.3.4 zero-dew.cn 		<span style="color:#75715e"># 扩展定义其他地址解析</span>
</span></span><span style="display:flex;"><span>          1.2.3.5 zero-dew.com
</span></span><span style="display:flex;"><span>          ttl <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>          reload 30s
</span></span><span style="display:flex;"><span>          fallthrough
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      kubernetes cluster.local in-addr.arpa ip6.arpa <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          kubeconfig /root/.kube/kubeconfig <span style="color:#75715e"># coredns 运行在k8s外</span>
</span></span><span style="display:flex;"><span>          pods insecure
</span></span><span style="display:flex;"><span>          fallthrough in-addr.arpa ip6.arpa
</span></span><span style="display:flex;"><span>          ttl <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dig @192.168.0.106 -p <span style="color:#ae81ff">53</span> a kubernetes.default.svc.cluster.local +short
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 反向解析</span>
</span></span><span style="display:flex;"><span>dig @192.168.0.106 -p <span style="color:#ae81ff">53</span> -x 172.168.0.1
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-d6e10aa56c3961e7ad7d849aacfab3cd">示例</h1>
	<div class="lead">demo|kubernetes</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-31" class="text-body-secondary">Saturday, May 31, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>

  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="物理机环境下作为dns服务器" aria-controls="tabs-00-00" aria-selected="true">
        物理机环境下作为dns服务器
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="运行在k8s环境中" aria-controls="tabs-00-01" aria-selected="false">
        运行在k8s环境中
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      health localhost:8080 <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            lameduck 5s 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      ready localhost:8181
</span></span><span style="display:flex;"><span>      reload
</span></span><span style="display:flex;"><span>      log
</span></span><span style="display:flex;"><span>      errors
</span></span><span style="display:flex;"><span>      prometheus :9153
</span></span><span style="display:flex;"><span>      trace zipkin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      forward . 223.5.5.5 114.114.114.114 <span style="color:#f92672">{</span> expire 10s <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      cache <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      hosts <span style="color:#f92672">{</span> 						<span style="color:#75715e"># 使用本机的/etc/hosts文件</span>
</span></span><span style="display:flex;"><span>          1.2.3.4 zero-dew.cn 		<span style="color:#75715e"># 扩展定义其他地址解析</span>
</span></span><span style="display:flex;"><span>          1.2.3.5 zero-dew.com
</span></span><span style="display:flex;"><span>          ttl <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>          reload 30s
</span></span><span style="display:flex;"><span>          fallthrough
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tee /usr/lib/systemd/system/coredns.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=coredns service https://coredns.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/coredns -conf /etc/corefile -pidfile /var/run/coredns.pid 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl enable coredns --now
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    .:53 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        errors
</span></span><span style="display:flex;"><span>        health <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>           lameduck 5s
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        ready
</span></span><span style="display:flex;"><span>        kubernetes cluster.local in-addr.arpa ip6.arpa <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>           pods insecure
</span></span><span style="display:flex;"><span>           fallthrough in-addr.arpa ip6.arpa
</span></span><span style="display:flex;"><span>           ttl <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        prometheus :9153
</span></span><span style="display:flex;"><span>        forward . /etc/resolv.conf <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>           max_concurrent <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        hosts <span style="color:#f92672">{</span> 						      
</span></span><span style="display:flex;"><span>          1.2.3.4 zero-dew.cn
</span></span><span style="display:flex;"><span>          1.2.3.5 zero-dew.com
</span></span><span style="display:flex;"><span>          ttl <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>          reload 30s
</span></span><span style="display:flex;"><span>          fallthrough cluster.local in-addr.arpa ip6.arpa  <span style="color:#75715e"># hosts 执行在kubernetes之前</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        cache <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>        loop
</span></span><span style="display:flex;"><span>        reload
</span></span><span style="display:flex;"><span>        loadbalance
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div>
    </div>
</div>


</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-0e13b09fa49eb36f4aa92da86316e142">serviceless</h1>
	
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-08-05" class="text-body-secondary">Tuesday, August 05, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-f5cae64815306b93313fe5895c3a2356">appolo</h1>
	<div class="lead">微服务治理</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-05" class="text-body-secondary">Tuesday, August 05, 2025</time>
        
	</div>
	
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-1cdf62915ca26163127e89c641cd248c">nacos</h1>
	<div class="lead">微服务治理</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-05" class="text-body-secondary">Tuesday, August 05, 2025</time>
        
	</div>
	
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-06d2f0f41ee04d596dec7e89e00984b3">dubbo</h1>
	<div class="lead">微服务治理</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-05" class="text-body-secondary">Tuesday, August 05, 2025</time>
        
	</div>
	
</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-66884a4a655d39b27854970cab32611a">Ingress</h1>
	<div class="lead">ingress|k8s</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-21" class="text-body-secondary">Wednesday, May 21, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<p>按照uri 执行路由</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">flask</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">test.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">flask</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;/index&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">index</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><p>按照servicename执行路由</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beata1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">flask</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">test.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">flask</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">pro.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">index</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-2edba2c1f66b93237c4b506cd72afb66">Hpa</h1>
	<div class="lead">hpa|k8s</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-21" class="text-body-secondary">Wednesday, May 21, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<p>创建hpa配置文件</p>
<blockquote>
<p>kubectl autoscale deployment python &ndash;min=2 &ndash;max=5 &ndash;cpu-percent=80</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">autoscaling/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">HorizontalPodAutoscaler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">python</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">maxReplicas</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReplicas</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">targetCPUUtilizationPercentage</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scaleTargetRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">python</span>
</span></span></code></pre></div><p>deployment 示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alpine</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alpine</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alpine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeName</span>: <span style="color:#ae81ff">hdss7-21.host.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alpine</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">alpine</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;sleep&#34;</span>,<span style="color:#e6db74">&#34;10000&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">1000m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">1000Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">1000m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">1000Mi</span>
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-2e948d266023dafd4653deef64951b82">RBAC实践</h1>
	<div class="lead">k8s RBAC实践</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-14" class="text-body-secondary">Wednesday, May 14, 2025</time>
        
	</div>
	<p><strong>任务需求：</strong></p>
<p>为开发人员设置k8s集群权限</p>
<p><strong>设计思路：</strong></p>
<p>将开发人员按照产品线分成小组，授予小组对应权限，开发人员加入到对应组实现授权。</p>
<pre class="mermaid">graph TB
    dev01 -.-&gt; 开发组1
    dev02 -.-&gt; 开发组1
    开发组1 -.-&gt; |clusterrolebinding|clusterrole01
    subgraph 权限
    clusterrole01
    clusterrole02
    end
    
    subgraph 组
    开发组1
    开发组2
    end
    
    subgraph 用户
    dev01
    dev02
    end</pre>
<p><strong>功能实现：</strong></p>
<ol>
<li>允许同一用户加入多个组</li>
<li>用户权限回收</li>
<li>人员异动，权限调整</li>
<li>实现操作审计（k8s审计日志）</li>
</ol>
<p><strong>实施步骤：</strong></p>
<ol>
<li>设计<code>clusterrole</code> 权限</li>
<li>设计组，把<code>clusterrole</code> 绑定到组中</li>
<li>新增用户，并生成kubeconfig文件</li>
<li>用户权限的回收【停用】</li>
<li>人员异动权限调整【调整用户所属组，无法做到动态调整只能停用用户重新创建】</li>
</ol>
<p><strong>实践案例：</strong></p>
<blockquote>
<p>该案例用于理清思路，并不实用</p>
</blockquote>
<ol>
<li>
<p>设计<code>clusterrole</code> 权限</p>
<p><em>使用默认权限 <code>cluster:admin</code></em></p>
</li>
<li>
<p>设计组，把<code>clusterrole</code> 绑定到组中</p>
<p><em>使用默认组 <code>system:masters</code></em></p>
</li>
<li>
<p>新增用户，并生成<code>kubeconfig</code>文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl genrsa -out user01.key <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>openssl req -new -key user01.key -out user01.csr -subj /CN<span style="color:#f92672">=</span>user01/O<span style="color:#f92672">=</span>system:masters
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl x509 -req -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -in user01.csr -out user01.crt -days <span style="color:#ae81ff">3650</span> -CAcreateserial
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl x509 -in user01.crt -text
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 设置集群信息</span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span>https://10.4.7.10:6443 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span>user01.kubeconfig
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 设置用户信息</span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials user01 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-certificate<span style="color:#f92672">=</span>./user01.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-key<span style="color:#f92672">=</span>./user01.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span>user01.kubeconfig
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 把集权和用户信息绑定</span>
</span></span><span style="display:flex;"><span>kubectl config set-context user01@kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>user01 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span>user01.kubeconfig
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># current-context</span>
</span></span><span style="display:flex;"><span>kubectl config use-context user01@kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span>user01.kubeconfig
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@master01:~/user01# kubectl get nodes --kubeconfig<span style="color:#f92672">=</span>./user01.kubeconfig
</span></span><span style="display:flex;"><span>NAME       STATUS   ROLES           AGE   VERSION
</span></span><span style="display:flex;"><span>master01   Ready    control-plane   22d   v1.28.2
</span></span></code></pre></div><hr>
<p>以上已经完成了用户的新增及授权动作，为了便于理解我们再次新增用户user02</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl genrsa -out user02.key <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>openssl req -new -key user02.key -out user01.csr -subj /CN<span style="color:#f92672">=</span>user02/O<span style="color:#f92672">=</span>system:masters
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl x509 -req -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -in user01.csr -out user02.crt -days <span style="color:#ae81ff">3650</span> -CAcreateserial
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl x509 -in user02.crt -text
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 设置用户信息</span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials user02 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-certificate<span style="color:#f92672">=</span>./user02.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-key<span style="color:#f92672">=</span>./user02.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span>user01.kubeconfig
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 把集权和用户信息绑定</span>
</span></span><span style="display:flex;"><span>kubectl config set-context user02@kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>user02 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span>user01.kubeconfig
</span></span></code></pre></div><pre tabindex="0"><code>kubectl config use-context user02@kubernetes --kubeconfig=./user01.kubeconfig
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@master01:~/user01# kubectl get nodes --kubeconfig<span style="color:#f92672">=</span>./user01.kubeconfig
</span></span><span style="display:flex;"><span>NAME       STATUS   ROLES           AGE   VERSION
</span></span><span style="display:flex;"><span>master01   Ready    control-plane   22d   v1.28.2
</span></span></code></pre></div><hr>
<p>以上创建的过程比较复杂，kubectl的插件功能实现了功能的简化：</p>
<p>希望实现的调用方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl rbac --user<span style="color:#f92672">=</span>user01 --clusterrole<span style="color:#f92672">=</span>cluser-admin --kubeconfigfile<span style="color:#f92672">=</span>user01.kubeconfig
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /usr/local/bin/kubectl-rbac
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>createuser<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        openssl genrsa -out user01.key <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>        openssl req -new -key user01.key -out user01.csr -subj /CN<span style="color:#f92672">=</span>user02/O<span style="color:#f92672">=</span>system:masters
</span></span><span style="display:flex;"><span>        openssl x509 -req -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -in user01.csr -out user01.crt -days <span style="color:#ae81ff">3650</span> -CAcreateserial
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>createkubeconfig<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置集群信息</span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span>https://10.4.7.10:6443 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span>user01.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置用户信息</span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials user01 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-certificate<span style="color:#f92672">=</span>user01.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-key<span style="color:#f92672">=</span>user01.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span>user01.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 把集权和用户信息绑定</span>
</span></span><span style="display:flex;"><span>kubectl config set-context user01@kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>user01 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span>user01.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># current-context</span>
</span></span><span style="display:flex;"><span>kubectl config use-context user01@kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span>user01.kubeconfig
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>check<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>kubectl get nodes --kubeconfig<span style="color:#f92672">=</span>./user01.kubeconfig
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>createuser
</span></span><span style="display:flex;"><span>createkubeconfig
</span></span><span style="display:flex;"><span>check
</span></span></code></pre></div></li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-063e043514cff8f2d2dd97614abf8168">sriov</h1>
	<div class="lead"><em>通过qemu虚拟化工具模拟intel厂家sriov功能(sriov kernel和 sriov dpdk),并将该节点添加到kubernetes集群中</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-10-27" class="text-body-secondary">Monday, October 27, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">


    <p>操作系统： <code>Ubuntu 22.04.4 5.15.0-160-generic</code></p>
<p>cpu型号：<code>Intel(R) Xeon(R) CPU E5-2699 v3 @ 2.30GHz</code></p>
<p>python版本：<code>3.8+</code></p>
<p>qemu版本：<code>v8.2.10</code></p>
<p>qemu虚拟机操作系统: <code>https://mirror.lzu.edu.cn/debian-cd/13.1.0/amd64/iso-dvd/debian-13.1.0-amd64-DVD-1.iso</code></p>
<p><font color=red>问题： 如何监控vf的分配情况</font></p>
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="网络架构" aria-controls="tabs-00-00" aria-selected="true">
        网络架构
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="ubuntu 网络配置" aria-controls="tabs-00-01" aria-selected="false">
        ubuntu 网络配置
      </button>
    </li>
</ul>
<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>外部网络 <span style="color:#f92672">(</span>192.168.0.0/24<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    │
</span></span><span style="display:flex;"><span>    ├── ESXi 主机
</span></span><span style="display:flex;"><span>    │     │
</span></span><span style="display:flex;"><span>    │     └── Ubuntu VM
</span></span><span style="display:flex;"><span>    │           │
</span></span><span style="display:flex;"><span>    │           ├── br0 桥接 <span style="color:#f92672">(</span>192.168.0.116<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    │           │     ├── ens34 <span style="color:#f92672">(</span>物理接口<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    │           │     └── tap0 <span style="color:#f92672">(</span>QEMU 连接<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    │           │
</span></span><span style="display:flex;"><span>    │           └── Debian VM <span style="color:#f92672">(</span>QEMU<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    │                 └── 6个 VF <span style="color:#f92672">(</span>包括 enp1s0v6: 192.168.0.121<span style="color:#f92672">)</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@qemu-ubuntu:~# cat   /etc/netplan/00-installer-config.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This is the network config written by &#39;subiquity&#39;</span>
</span></span><span style="display:flex;"><span>network:
</span></span><span style="display:flex;"><span>  version: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  ethernets:
</span></span><span style="display:flex;"><span>    ens34: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>  bridges:
</span></span><span style="display:flex;"><span>    br0:
</span></span><span style="display:flex;"><span>      interfaces: <span style="color:#f92672">[</span>ens34<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      dhcp4: false
</span></span><span style="display:flex;"><span>      addresses: <span style="color:#f92672">[</span>192.168.0.116/24,<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      routes:
</span></span><span style="display:flex;"><span>      - to: default
</span></span><span style="display:flex;"><span>        via: 192.168.0.1
</span></span><span style="display:flex;"><span>        metric: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>        on-link: true
</span></span><span style="display:flex;"><span>      nameservers:
</span></span><span style="display:flex;"><span>        addresses: <span style="color:#f92672">[</span>192.168.0.1<span style="color:#f92672">]</span>
</span></span></code></pre></div>
    </div>
</div>


</div>

<h3 id="第一步">第一步</h3>
<p><em>安装qemu软件|<a href="https://github.com/knuto/qemu/wiki/Knut%27s-QEMU-patchwork" target="_blank">github中给出如何使用qemu模拟sriov网卡参数</a></em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install -y build-essential ninja-build pkg-config libglib2.0-dev libpixman-1-dev python3-pip python3-setuptools flex bison
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://gitlab.com/qemu-project/qemu.git
</span></span><span style="display:flex;"><span>git checkout remotes/origin/stable-8.2
</span></span><span style="display:flex;"><span>./configure 
</span></span><span style="display:flex;"><span>make -j <span style="color:#ae81ff">4</span>
</span></span></code></pre></div><h3 id="第二步">第二步</h3>
<p><em>准备虚拟机镜像</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./build/qemu-img create -f qcow2 /sriov.qcow2 100G
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关闭虚拟机调整磁盘空间</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#./build/qemu-img resize /sriov.qcow2 200G</span>
</span></span></code></pre></div><p><em>安装qemu虚拟机</em></p>

<details>
  <summary>Details</summary>
  <table>
  <thead>
      <tr>
          <th>参数</th>
          <th>功能</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>-m 1G</code></td>
          <td>指定虚拟机内存配额</td>
      </tr>
      <tr>
          <td><code>-smp 1</code></td>
          <td>指定虚拟机cpu配额</td>
      </tr>
      <tr>
          <td><code>-hda /disk.qcow2 </code></td>
          <td>指定磁盘</td>
      </tr>
      <tr>
          <td><code>-cdrom /tmp/alpine-extended-3.22.2-x86_64.iso </code></td>
          <td>加载镜像文件</td>
      </tr>
      <tr>
          <td><code>-boot d  </code></td>
          <td>从光驱引导启动</td>
      </tr>
      <tr>
          <td><code>-enable-kvm</code></td>
          <td>使用kvm虚拟化加速</td>
      </tr>
      <tr>
          <td><code>-netdev bridge,id=net1,br=br0</code></td>
          <td><code>-netdev</code>: 定义网络后端设备 <code>bridge</code>: 使用桥接模式 <code>id=net1</code>: 后端标识符（在 QEMU 内部使用） <code>br=br0</code>: 连接到宿主机的 br0 桥接</td>
      </tr>
      <tr>
          <td><code>-device igb,bus=pcie_port.2,netdev=net1</code></td>
          <td><code>-device igb</code>: 模拟 Intel IGB 网卡 <code>bus=pcie_root.2</code>: 连接到 PCIe 根端口 <code>netdev=net1</code>: 🔑 <strong>关键</strong> - 将 igb 设备连接到网络后端</td>
      </tr>
  </tbody>
</table>
</details>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./build/qemu-system-x86_64 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-m 8G <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-smp <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-hda /sriov.qcow2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-enable-kvm <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-cdrom /tmp/debian-13.1.0-amd64-DVD-1.iso <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-boot d <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-netdev bridge,id<span style="color:#f92672">=</span>net0,br<span style="color:#f92672">=</span>br0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-device virtio-net-pci,netdev<span style="color:#f92672">=</span>net0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-M q35 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-device pcie-root-port,slot<span style="color:#f92672">=</span>2,id<span style="color:#f92672">=</span>pcie_port.2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-device igb,bus<span style="color:#f92672">=</span>pcie_port.2,netdev<span style="color:#f92672">=</span>net1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-netdev bridge,id<span style="color:#f92672">=</span>net1,br<span style="color:#f92672">=</span>br0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-daemonize
</span></span></code></pre></div><h3 id="第三步">第三步</h3>

  
  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          aria-controls="tabs-02-00" aria-selected="false">
        <strong>验证sriov功能</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="*sriov(kernel)* " aria-controls="tabs-02-01" aria-selected="true">
        <em>Sriov(kernel)</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-02" role="tab"
          data-td-tp-persist="*sriov(dpdk)* " aria-controls="tabs-02-02" aria-selected="false">
        <em>Sriov(dpdk)</em>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <p><em>重启虚拟机取消从光盘引导系统</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./build/qemu-system-x86_64 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-m 8G <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-smp <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-hda /sriov.qcow2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-enable-kvm <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-netdev bridge,id<span style="color:#f92672">=</span>net0,br<span style="color:#f92672">=</span>br0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-device virtio-net-pci,netdev<span style="color:#f92672">=</span>net0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-M q35 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-device pcie-root-port,slot<span style="color:#f92672">=</span>2,id<span style="color:#f92672">=</span>pcie_port.2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-device igb,bus<span style="color:#f92672">=</span>pcie_port.2,netdev<span style="color:#f92672">=</span>net1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-netdev bridge,id<span style="color:#f92672">=</span>net1,br<span style="color:#f92672">=</span>br0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-daemonize
</span></span></code></pre></div><p><em>划分vf</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@localhost:~# lspci |grep <span style="color:#ae81ff">82576</span>
</span></span><span style="display:flex;"><span>01:00.0 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Gigabit Network Connection <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>root@localhost:~# lsmod |grep igb
</span></span><span style="display:flex;"><span>igb                   <span style="color:#ae81ff">315392</span>  <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>i2c_algo_bit           <span style="color:#ae81ff">16384</span>  <span style="color:#ae81ff">1</span> igb
</span></span><span style="display:flex;"><span>dca                    <span style="color:#ae81ff">16384</span>  <span style="color:#ae81ff">1</span> igb
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vf 数量不能动态调整，需要重置后再次分配。重置方式</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># echo 0 &gt; /sys/bus/pci/devices/0000:01:00.0/sriov_numvfs</span>
</span></span><span style="display:flex;"><span>root@localhost:~# echo <span style="color:#ae81ff">7</span> &gt; /sys/bus/pci/devices/0000:01:00.0/sriov_numvfs
</span></span><span style="display:flex;"><span>root@localhost:~# lspci |grep <span style="color:#ae81ff">82576</span>
</span></span><span style="display:flex;"><span>01:00.0 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Gigabit Network Connection <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:10.0 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:10.2 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:10.4 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:10.6 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:11.0 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:11.2 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:11.4 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span></code></pre></div><p><em>【实验一】通过linux自身能力配置网络</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ip netns a n1 
</span></span><span style="display:flex;"><span>ip link set enp1s0v6 netns n1 name eth0
</span></span><span style="display:flex;"><span>ip netns exec n1 ip link set eth0 up ;
</span></span><span style="display:flex;"><span>ip netns exec n1 ip a a 192.168.0.121/24 dev eth0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 二层互通</span>
</span></span><span style="display:flex;"><span>root@localhost:~# ip netns exec n1 ping 192.168.0.1 -c <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>PING 192.168.0.1 <span style="color:#f92672">(</span>192.168.0.1<span style="color:#f92672">)</span> 56<span style="color:#f92672">(</span>84<span style="color:#f92672">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 192.168.0.1: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>1.02 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 192.168.0.1: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>1.03 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- 192.168.0.1 ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> packets transmitted, <span style="color:#ae81ff">2</span> received, 0% packet loss, time 1002ms
</span></span><span style="display:flex;"><span>rtt min/avg/max/mdev <span style="color:#f92672">=</span> 1.023/1.027/1.031/0.004 ms
</span></span><span style="display:flex;"><span>root@localhost:~# 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pc@qemu-ubuntu:~$ ping 192.168.0.121 -c2
</span></span><span style="display:flex;"><span>PING 192.168.0.121 <span style="color:#f92672">(</span>192.168.0.121<span style="color:#f92672">)</span> 56<span style="color:#f92672">(</span>84<span style="color:#f92672">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 192.168.0.121: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.841 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 192.168.0.121: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.866 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- 192.168.0.121 ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> packets transmitted, <span style="color:#ae81ff">2</span> received, 0% packet loss, time 1001ms
</span></span><span style="display:flex;"><span>rtt min/avg/max/mdev <span style="color:#f92672">=</span> 0.841/0.853/0.866/0.012 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 三层互通</span>
</span></span><span style="display:flex;"><span>root@localhost:~# ip netns exec n1 ping 8.8.8.8 -c <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>ping: connect: Network is unreachable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@localhost:~# ip netns exec n1 ip r a default via 192.168.0.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@localhost:~# ip netns exec n1 ping 8.8.8.8 -c <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>PING 8.8.8.8 <span style="color:#f92672">(</span>8.8.8.8<span style="color:#f92672">)</span> 56<span style="color:#f92672">(</span>84<span style="color:#f92672">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 8.8.8.8: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">109</span> time<span style="color:#f92672">=</span><span style="color:#ae81ff">226</span> ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 8.8.8.8: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">109</span> time<span style="color:#f92672">=</span><span style="color:#ae81ff">225</span> ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- 8.8.8.8 ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> packets transmitted, <span style="color:#ae81ff">2</span> received, 0% packet loss, time 1001ms
</span></span><span style="display:flex;"><span>rtt min/avg/max/mdev <span style="color:#f92672">=</span> 225.498/225.794/226.090/0.296 ms
</span></span></code></pre></div><p><em>【实验二】使用sriov-cni配置网络</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 安装sriov-cni</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加cni配置文件/etc/cni/net.d/10-sriov.conf 【文件可以是任何位置任何命名】</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cniVersion&#34;</span>: <span style="color:#e6db74">&#34;0.3.1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;sriov-network&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;sriov&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;deviceID&#34;</span>: <span style="color:#e6db74">&#34;0000:01:10.4&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ipam&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;host-local&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;subnet&#34;</span>: <span style="color:#e6db74">&#34;192.168.0.0/24&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;rangeStart&#34;</span>: <span style="color:#e6db74">&#34;192.168.0.123&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;rangeEnd&#34;</span>: <span style="color:#e6db74">&#34;192.168.0.123&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;routes&#34;</span>: <span style="color:#f92672">[{</span><span style="color:#e6db74">&#34;dst&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0/0&#34;</span><span style="color:#f92672">}]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;gateway&#34;</span>: <span style="color:#e6db74">&#34;192.168.0.1&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 手动调用sriov-cni添加网卡到指定名称空间</span>
</span></span><span style="display:flex;"><span>ip netns a n1
</span></span><span style="display:flex;"><span>export CNI_COMMAND<span style="color:#f92672">=</span>ADD 
</span></span><span style="display:flex;"><span>export CNI_NETNS<span style="color:#f92672">=</span>/var/run/netns/n1
</span></span><span style="display:flex;"><span>export CNI_IFNAME<span style="color:#f92672">=</span>eth1 
</span></span><span style="display:flex;"><span>export CNI_PATH<span style="color:#f92672">=</span>/opt/cni/bin 
</span></span><span style="display:flex;"><span>export CNI_CONTAINERID<span style="color:#f92672">=</span><span style="color:#ae81ff">12345</span>
</span></span><span style="display:flex;"><span>/opt/cni/bin/sriov &lt;/etc/cni/net.d/10-sriov.conf 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查是否成功添加</span>
</span></span><span style="display:flex;"><span>root@localhost:~# ip netns exec  n1 ip a
</span></span><span style="display:flex;"><span>1: lo: &lt;LOOPBACK&gt; mtu <span style="color:#ae81ff">65536</span> qdisc noop state DOWN group default qlen <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span>9: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc fq_codel state UP group default qlen <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 56:0a:d8:24:8e:70 brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>    inet 192.168.0.122/24 brd 192.168.0.255 scope global eth1
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>    inet6 fe80::540a:d8ff:fe24:8e70/64 scope link proto kernel_ll 
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p><em>【实验三】使用multus + flannel + sriov-network-device-plugin + sriov-cni配置网络</em></p>
<blockquote>
<p><a href="https://github.com/k8snetworkplumbingwg" target="_blank">github</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;deb [trusted=yes] https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main&#34;</span> | tee /etc/apt/sources.list.d/kubernetes.list
</span></span><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install -y kubelet<span style="color:#f92672">=</span>1.23.17-* kubeadm<span style="color:#f92672">=</span>1.23.17-* kubectl<span style="color:#f92672">=</span>1.23.17-*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  kubeadm token create --print-join-command</span>
</span></span><span style="display:flex;"><span>kubeadm join 192.168.0.144:16443 --token kp3bem.7svhcpdjp70kj7wi --discovery-token-ca-cert-hash sha256:3e77b765acb011d12cfb2649040ba6b51dd07ac6ee1746ce540740fc9d31bea3
</span></span></code></pre></div></blockquote>
<hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 安装flannel 和 multus</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装sriov-cni 【 用于分配和实现sriov网卡通路】</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装sriov-network-device-plugin【 用于发现和公告节点sriov的能力】</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 参数：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   resourceName 暴露和公开的sriov名称，自定义</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   selectors 中的内容通过root@localhost:~/dpdk# ./usertools/dpdk-devbind.py --status</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   vendors 网卡厂商id</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   devices 具体网卡型号id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>git https://github.com/k8snetworkplumbingwg/sriov-network-device-plugin.git
</span></span><span style="display:flex;"><span>cd sriov/sriov-network-device-plugin/deployments
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF |kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ConfigMap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: sriovdp-config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">data:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  config.json: |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;resourceList&#34;: [{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;resourceName&#34;: &#34;intel_sriov&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;selectors&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;vendors&#34;: [&#34;8086&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;devices&#34;: [&#34;10ca&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;drivers&#34;: [&#34;igbvf&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;pfNames&#34;: [&#34;enp1s0&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl apply -f sriovdp-daemonset.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 通过multus-cni 定义一个NetworkAttachmentDefinition</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF|kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: &#34;k8s.cni.cncf.io/v1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: NetworkAttachmentDefinition
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: sriov-net1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  config: &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;type&#34;: &#34;sriov&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;resourceName&#34;: &#34;intel_sriov&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;deviceID&#34;: &#34;0000:01:10.2&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;ipam&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;type&#34;: &#34;host-local&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;subnet&#34;: &#34;192.168.0.0/24&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;rangeStart&#34;: &#34;192.168.0.123&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;rangeEnd&#34;: &#34;192.168.0.123&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;routes&#34;: [{&#34;dst&#34;: &#34;0.0.0.0/0&#34;}],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;gateway&#34;: &#34;192.168.0.1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 功能验证</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF|kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: DaemonSet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: test1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s.v1.cni.cncf.io/networks: sriov-net1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      tolerations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - effect: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        key: &#34;node-role.kubernetes.io/master&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - name: test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        securityContext:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          privileged: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        image: quay.io/libpod/alpine:3.10.2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        command: [&#34;sleep&#34;,&#34;1000&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            intel.com/intel_sriov: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-02" role="tabpanel" aria-labelled-by="tabs-02-02-tab" tabindex="2">
        <p><em>前面创建的sriov虚拟机是继续内核的技术实现，另一种更为高效的方式是将vf 绑定dpdk(Data Plane Development Kit) 从而提升网卡性能</em></p>
<p><strong>实施步骤：</strong></p>
<p>首先确保在ubuntu上开启硬件虚拟机化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lscpu | grep -E <span style="color:#e6db74">&#39;vmx|svm&#39;</span>
</span></span></code></pre></div><p>其次在ubuntu上引导文件中添加iommu的支持，此处为<code>intel cpu</code>其他cpu有所差异</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /etc/default/grub
</span></span><span style="display:flex;"><span>GRUB_CMDLINE_LINUX_DEFAULT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;quiet iommu=on intel_iommu=on&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>update-grub
</span></span><span style="display:flex;"><span>init <span style="color:#ae81ff">6</span>
</span></span></code></pre></div><p>再次在ubuntu上开启操作系统的大页内存</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#ae81ff">0</span> &gt; /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
</span></span><span style="display:flex;"><span>echo <span style="color:#ae81ff">4096</span> &gt; /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
</span></span><span style="display:flex;"><span>mkdir -p /dev/hugepages
</span></span><span style="display:flex;"><span>mount -t hugetlbfs hugetlbfs /dev/hugepages
</span></span></code></pre></div><p>最后修改启动文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./build/qemu-system-x86_64 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-m 8G <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-smp <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-hda /sriov.qcow2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-enable-kvm <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-netdev bridge,id<span style="color:#f92672">=</span>net0,br<span style="color:#f92672">=</span>br0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-device virtio-net-pci,netdev<span style="color:#f92672">=</span>net0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-M q35 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-device pcie-root-port,slot<span style="color:#f92672">=</span>2,id<span style="color:#f92672">=</span>pcie_port.2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-device igb,bus<span style="color:#f92672">=</span>pcie_port.2,netdev<span style="color:#f92672">=</span>net1,rombar<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-netdev bridge,id<span style="color:#f92672">=</span>net1,br<span style="color:#f92672">=</span>br0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-mem-prealloc -mem-path /dev/hugepages <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-device intel-iommu <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-daemonize
</span></span></code></pre></div><p>进入debain虚拟机执行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /etc/default/grub
</span></span><span style="display:flex;"><span>GRUB_CMDLINE_LINUX_DEFAULT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;quiet iommu=on intel_iommu=on&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>update-grub
</span></span><span style="display:flex;"><span>init <span style="color:#ae81ff">6</span>
</span></span></code></pre></div><p>分配vf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@localhost:~# modprobe vfio ;modprobe vfio-pci ;lsmod |grep vfio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vfio_pci               <span style="color:#ae81ff">16384</span>  <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>vfio_pci_core          <span style="color:#ae81ff">94208</span>  <span style="color:#ae81ff">1</span> vfio_pci
</span></span><span style="display:flex;"><span>irqbypass              <span style="color:#ae81ff">12288</span>  <span style="color:#ae81ff">1</span> vfio_pci_core
</span></span><span style="display:flex;"><span>vfio_iommu_type1       <span style="color:#ae81ff">45056</span>  <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>vfio                   <span style="color:#ae81ff">61440</span>  <span style="color:#ae81ff">3</span> vfio_pci_core,vfio_iommu_type1,vfio_pci
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@localhost:~# echo <span style="color:#ae81ff">7</span> &gt; /sys/bus/pci/devices/0000:01:00.0/sriov_numvfs
</span></span><span style="display:flex;"><span>root@localhost:~# lspci |grep <span style="color:#ae81ff">82576</span>
</span></span><span style="display:flex;"><span>01:00.0 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Gigabit Network Connection <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:10.0 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:10.2 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:10.4 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:10.6 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:11.0 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:11.2 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>01:11.4 Ethernet controller: Intel Corporation <span style="color:#ae81ff">82576</span> Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>可以看到<code>01:10.6 </code>vf 已经被绑定到了vfio-pci的驱动上</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@localhost:~/dpdk# git clone https://github.com/DPDK/dpdk.git
</span></span><span style="display:flex;"><span>root@localhost:~/dpdk# cd dpdk/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@localhost:~/dpdk# ./usertools/dpdk-devbind.py -b vfio-pci 0000:01:10.6
</span></span><span style="display:flex;"><span>root@localhost:~/dpdk# ./usertools/dpdk-devbind.py --status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Network devices using DPDK-compatible driver
</span></span><span style="display:flex;"><span><span style="color:#f92672">============================================</span>
</span></span><span style="display:flex;"><span>0000:01:10.6 <span style="color:#e6db74">&#39;82576 Virtual Function 10ca&#39;</span> drv<span style="color:#f92672">=</span>vfio-pci unused<span style="color:#f92672">=</span>igbvf
</span></span></code></pre></div><p><em>【实验一】通过linux自身能力配置网络</em></p>
<p><em>【实验二】使用sriov-cni配置网络</em></p>
<p><em>【实验三】使用multus + flannel + sriov-network-device-plugin + sriov-cni配置网络</em></p>

    </div>
</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c38bfc2197bb43631ae6342438e8e031">dashboard</h1>
	<div class="lead">dashboard|k8s</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-21" class="text-body-secondary">Wednesday, May 21, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h3 id="开源软件对比">开源软件对比</h3>
<table>
  <thead>
      <tr>
          <th>功能</th>
          <th>kuboard（v3.3.0）</th>
          <th>KubeSphere(v3.1.1)</th>
          <th>rancher(v2.5.10)</th>
          <th>dashboard(v2.0.1)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>k8s集群部署</td>
          <td>/</td>
          <td>支持</td>
          <td>支持</td>
          <td>不支持</td>
      </tr>
      <tr>
          <td>多集群管理</td>
          <td>支持</td>
          <td>支持</td>
          <td>支持</td>
          <td>不支持</td>
      </tr>
      <tr>
          <td>资源管理</td>
          <td>可以监视、管理和部署应用程序</td>
          <td>可以监视、管理和部署应用程序</td>
          <td>可以监视、管理和部署应用程序</td>
          <td>仅支持deploy,dasemonset,statefustset等内置资源管理</td>
      </tr>
      <tr>
          <td>集群证书有效期展示</td>
          <td>支持</td>
          <td>/</td>
          <td>/</td>
          <td>/</td>
      </tr>
      <tr>
          <td>认证和权限</td>
          <td>支持RBAC和AD/LDAP集成</td>
          <td>支持RBAC和AD/LDAP集成</td>
          <td>支持RBAC和AD/LDAP集成</td>
          <td>支持RBAC</td>
      </tr>
      <tr>
          <td>开源协议</td>
          <td>/</td>
          <td>Apache2.0</td>
          <td>Apache2.0</td>
          <td>Apache2.0</td>
      </tr>
      <tr>
          <td>主要维护者</td>
          <td>/</td>
          <td>青云</td>
          <td>SUSE</td>
          <td>属于kubernetes项目</td>
      </tr>
      <tr>
          <td>编程语言</td>
          <td>javascript</td>
          <td>go</td>
          <td>go</td>
          <td>go</td>
      </tr>
      <tr>
          <td>活跃度</td>
          <td>18.2k</td>
          <td>12.7k</td>
          <td>21.1k</td>
          <td>12.6k</td>
      </tr>
      <tr>
          <td>部署难度</td>
          <td>一般</td>
          <td>较复杂</td>
          <td>较复杂</td>
          <td>一般</td>
      </tr>
      <tr>
          <td>应用市场 (关联helm仓库快速部署服务)</td>
          <td>支持</td>
          <td>/</td>
          <td>支持</td>
          <td>/</td>
      </tr>
  </tbody>
</table>
<h3 id="介绍">介绍</h3>
<p>Rancher Server 由认证代理（Authentication Proxy）、Rancher API Server、集群控制器（Cluster Controller）、etcd 节点和集群 Agent（Cluster Agent） 组成。除了集群 Agent 以外，其他组件都运行在 Rancher Server 中。</p>
<p><strong>主要功能：</strong></p>
<ol>
<li>创建k8s集群（rancher成为RKE）</li>
<li>支持管理已有集群</li>
<li>可以集成elk，prometheus、alertmanager功能</li>
</ol>
<p><img src="https://docs.rancher.cn/assets/images/rancher-architecture-rancher-api-server-2743dae746c64cd2ad66711908be4108.svg" alt=""></p>
<h3 id="安装">安装</h3>
<h5 id="准备tls版本离线镜像">准备TLS版本离线镜像</h5>
<blockquote>
<p><code>docker run -d --restart=unless-stopped -p 80:80 -p 443:443 --privileged rancher/rancher:stable</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rancher/rancher-agent:v2.10.3
</span></span><span style="display:flex;"><span>rancher/rancher:v2.10.3
</span></span><span style="display:flex;"><span>rancher/rancher-webhook:v0.6.4
</span></span></code></pre></div></blockquote>
<table>
  <thead>
      <tr>
          <th>版本</th>
          <th>容器镜像</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><a href="https://github.com/rancher/rancher/releases/tag/v2.10.3" target="_blank">v2.10</a></td>
          <td><code>rancher/rancher:v2.10.3</code>    <code>rancher/rancher:stable</code></td>
      </tr>
      <tr>
          <td>v2.9</td>
          <td><code>rancher/rancher:v2.9.3</code></td>
      </tr>
      <tr>
          <td>v2.8</td>
          <td><code>rancher/rancher:v2.8.5</code></td>
      </tr>
  </tbody>
</table>
<p><em>离线镜像下载并推送到内网仓库</em></p>
<table>
  <thead>
      <tr>
          <th>Release 文件</th>
          <th>描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>rancher-images.txt</code></td>
          <td>此文件包含安装 Rancher、创建集群和运行 Rancher 工具所需的镜像列表。</td>
      </tr>
      <tr>
          <td><code>rancher-save-images.sh</code></td>
          <td>这个脚本会从 DockerHub 中拉取在文件<code>rancher-images.txt</code>中描述的所有镜像，并将它们保存为文件<code>rancher-images.tar.gz</code>。</td>
      </tr>
      <tr>
          <td><code>rancher-load-images.sh</code></td>
          <td>这个脚本会载入文件<code>rancher-images.tar.gz</code>中的镜像，并将它们推送到你自己的私有镜像库。</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/rancher/rancher/releases/download/v2.10.3/rancher-save-images.sh</span>
</span></span><span style="display:flex;"><span>chmod +x rancher-save-images.sh rancher-load-images.sh
</span></span><span style="display:flex;"><span>./rancher-save-images.sh --image-list ./rancher-images.txt 
</span></span><span style="display:flex;"><span>./rancher-load-images.sh --image-list ./rancher-images.txt --registry &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt;
</span></span></code></pre></div><h5 id="准备离线yaml">准备离线YAML</h5>
<ol>
<li>
<p>添加helm仓库</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
</span></span><span style="display:flex;"><span>helm repo update
</span></span></code></pre></div></li>
<li>
<p>获取对应版本</p>
<blockquote>
<p><code>rancher.zero-dew.com</code> rancher的访问域名</p>
<p><code>registry.zero-dew.com</code> 私有仓库地址</p>
<p><code>privateCA=true</code> 指明使用自签CA</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm template rancher rancher-stable/rancher <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--version 2.10.3 --output-dir ./ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--no-hooks <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace rancher <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set hostname<span style="color:#f92672">=</span>rancher.zero-dew.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set ingress.tls.source<span style="color:#f92672">=</span>secret <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set privateCA<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set rancherImage<span style="color:#f92672">=</span>registry.zero-dew.com/rancher <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set systemDefaultRegistry<span style="color:#f92672">=</span>registry.zero-dew.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set useBundledSystemChart<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kube-version 1.31.2 
</span></span></code></pre></div></li>
<li>
<p>自签https证书</p>
<p><em>生成 CA 证书</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl genrsa -out ca.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl req -x509 -new -nodes -key ca.key -sha256 -days <span style="color:#ae81ff">3650</span> -out ca.crt -subj <span style="color:#e6db74">&#34;/C=CN/ST=GD/L=SZ/O=zero-dew.com/CN=zero-dew.com&#34;</span>
</span></span></code></pre></div><p><em>创建 SAN 配置文件</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;san.cnf <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[req]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_bits = 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prompt = no
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_md = sha256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">req_extensions = req_ext
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">distinguished_name = dn
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[dn]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">C = CN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST = Gd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">L = SZ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">O = zero-dew.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CN = rancher.zero-dew.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[req_ext]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjectAltName = @alt_names
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[alt_names]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DNS.1 = rancher.zero-dew.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p><em>生成服务端私钥和 CSR</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl genrsa -out rancher.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl req -new -key rancher.key -out rancher.csr -config san.cnf
</span></span></code></pre></div><p><em>用 CA 签发服务端证书（带 SAN）</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl x509 -req -in rancher.csr -CA ca.crt -CAkey ca.key -CAcreateserial <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-out rancher.crt -days <span style="color:#ae81ff">3650</span> -sha256 -extensions req_ext -extfile san.cnf
</span></span></code></pre></div></li>
<li>
<p>部署</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create ns rancher
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ingress tls证书</span>
</span></span><span style="display:flex;"><span>kubectl -n rancher create secret tls tls-rancher-ingress --cert<span style="color:#f92672">=</span>./rancher.crt --key<span style="color:#f92672">=</span>./rancher.key
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 该ca会被传递到agent端用于访问https://rancher.zero-dew.com</span>
</span></span><span style="display:flex;"><span>kubectl -n rancher create secret generic  tls-ca --from-file<span style="color:#f92672">=</span>cacerts.pem<span style="color:#f92672">=</span>./ca.crt
</span></span><span style="display:flex;"><span>kubectl -n rancher apply -f rancher/templates
</span></span></code></pre></div></li>
</ol>
<h3 id="使用">使用</h3>
<p>登录和修改密码</p>
<p><img src="/docs/kubernetes/rancher01.png" alt=""></p>
<p>选择导入已有集群</p>
<p><img src="/docs/kubernetes/rancher05.png" alt=""></p>
<p><img src="/docs/kubernetes/rancher07.png" alt=""></p>
<h3 id="卸载">卸载</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n rancher delete -f rancher/templates
</span></span></code></pre></div>
</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8da20eaf4a37cf2e2b8da8804cb927e7">3 - </h1>
    <div class="lead">可观测性工具</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-7a3994c6b4d24a86bf72f3809febdaeb">3.1 - ELK</h1>
    
	<table>
  <thead>
      <tr>
          <th>服务</th>
          <th>建议节点数</th>
          <th>依赖</th>
          <th>端口</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>zookeeper</td>
          <td>3</td>
          <td>jdk</td>
          <td>2181/2888/3888</td>
      </tr>
      <tr>
          <td>kafka</td>
          <td>3</td>
          <td>jdk</td>
          <td>9092</td>
      </tr>
      <tr>
          <td>elasticsearch</td>
          <td>3</td>
          <td>jdk</td>
          <td>9200/9300</td>
      </tr>
      <tr>
          <td>filebeat</td>
          <td></td>
          <td>go语言开发，没有依赖</td>
          <td></td>
      </tr>
      <tr>
          <td><a href="https://www.elastic.co/guide/en/logstash/7.15/introduction.html" target="_blank">logstash</a></td>
          <td></td>
          <td>java</td>
          <td>9600</td>
      </tr>
      <tr>
          <td><a href="https://www.elastic.co/guide/en/kibana/7.15/introduction.html" target="_blank">Kibana</a></td>
          <td></td>
          <td>无</td>
          <td>5601</td>
      </tr>
  </tbody>
</table>
<pre class="mermaid">graph LR
    subgraph Prod
        Pod1[node] --&gt;|日志| FB1[Filebeat]
        Pod2[node] --&gt;|日志| FB2[Filebeat]

    end

    subgraph Test
        Pod3[node] --&gt;|日志| FB3[Filebeat]
        Pod4[node] --&gt;|日志| FB4[Filebeat]

    end
    
    FB1 --&gt;|topic: prod| Kafka
    FB2 --&gt;|topic: prod| Kafka
    FB3 --&gt;|topic: test| Kafka
    FB4 --&gt;|topic: test| Kafka
    Kafka --&gt;|topic: prod| Logstash
    Kafka --&gt;|topic: test| Logstash

    Logstash --&gt;|index| Elasticsearch

    Elasticsearch --&gt;|Index-pattern| Kibana</pre>

  

  
  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>demo</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="*目录结构*" aria-controls="tabs-00-01" aria-selected="true">
        <em>目录结构</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="*docker-compose.yml*" aria-controls="tabs-00-02" aria-selected="false">
        <em>docker-compose.yml</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="*conf/*" aria-controls="tabs-00-03" aria-selected="false">
        <em>conf/</em>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>├── build
</span></span><span style="display:flex;"><span>│   └── kafka.dockerfile
</span></span><span style="display:flex;"><span>├── conf
</span></span><span style="display:flex;"><span>│   ├── filebeat.yml
</span></span><span style="display:flex;"><span>│   ├── logstash.conf
</span></span><span style="display:flex;"><span>│   └── server.properties
</span></span><span style="display:flex;"><span>└── docker-compose.yml
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># build/kafka.dockerfile</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>FROM  openjdk:11<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> mainter<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1209233066@qq.com&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> version<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>.3.2<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> wget https://archive.apache.org/dist/kafka/<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>/kafka_2.13-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.tgz <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    tar xf kafka_2.13-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.tgz -C /opt <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    ln -sv  /opt/kafka_2.13-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span> /opt/kafka<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span> <span style="color:#e6db74">9092</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/server.properties<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># docker-compose.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">app-tier</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">driver</span>: <span style="color:#ae81ff">bridge</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">elasticsearch</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">docker.elastic.co/elasticsearch/elasticsearch:7.17.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">app-tier</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">discovery.type=single-node</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cpus</span>: <span style="color:#e6db74">&#34;2.00&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">4G</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kibana</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">docker.elastic.co/kibana/kibana:7.17.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">app-tier</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;ELASTICSEARCH_HOSTS=http://elasticsearch:9200&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;I18N_LOCALE=zh-CN&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;5601:5601&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">elasticsearch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cpus</span>: <span style="color:#e6db74">&#34;2.00&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">2G</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">filebeat</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">docker.elastic.co/beats/filebeat:7.17.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">app-tier</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#ae81ff">filebeat -e -c /usr/share/filebeat/filebeat.yml</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;./conf/filebeat.yml:/usr/share/filebeat/filebeat.yml&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">zookeeper</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">zookeeper:3.4.14</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">app-tier</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kafka</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./build</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dockerfile</span>: <span style="color:#ae81ff">kafka.dockerfile</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">app-tier</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#ae81ff">/opt/kafka/bin/kafka-server-start.sh /etc/kafka/server.properties</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;./conf/server.properties:/etc/kafka/server.properties&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">zookeeper</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">logstash</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">docker.elastic.co/logstash/logstash:7.17.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">app-tier</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;./conf/logstash.conf:/etc/logstash/logstash.conf&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#ae81ff">logstash -f /etc/logstash/logstash.conf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cpus</span>: <span style="color:#e6db74">&#34;1.00&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">1G</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># conf/server.properties</span>
</span></span><span style="display:flex;"><span>input <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  kafka <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    bootstrap_servers <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;kafka:9092&#34;</span>
</span></span><span style="display:flex;"><span>    topics <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;sys_log&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  elasticsearch <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    hosts <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;10.4.7.10:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    index <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;sys_log&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># conf/server.properties</span>
</span></span><span style="display:flex;"><span>broker.id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>listeners <span style="color:#f92672">=</span> PLAINTEXT://kafka:9092
</span></span><span style="display:flex;"><span>log.dirs<span style="color:#f92672">=</span>/tmp/kafka-logs
</span></span><span style="display:flex;"><span>offsets.topic.replication.factor<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>transaction.state.log.replication.factor<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>zookeeper.connect<span style="color:#f92672">=</span>zookeeper:2181
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># conf/filebeat.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/messages</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/*.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 用于output.kafka 动态选择topic</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_topic</span>: <span style="color:#ae81ff">sys_log</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/nginx/*.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_topic</span>: <span style="color:#ae81ff">nginx_log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.kafka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># initial brokers for reading cluster metadata</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: [<span style="color:#e6db74">&#34;kafka:9092&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># message topic selection + partitioning</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">topic</span>: <span style="color:#e6db74">&#39;%{[fields.log_topic]}&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">partition.round_robin</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">reachable_only</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">required_acks</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">compression</span>: <span style="color:#ae81ff">gzip</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 超过的日志流将会被丢失</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_message_bytes</span>: <span style="color:#ae81ff">1000000</span>
</span></span></code></pre></div>
    </div>
</div>


</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-2970ad726135b6520ed814ee01e5ce24">kibana</h1>
	<div class="lead">安装使用kibana</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-10" class="text-body-secondary">Wednesday, September 10, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">


    <h4 id="文档环境">文档环境</h4>
<p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.19</code></p>
<p>logstash版本：<code>7.15.0</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>
<p>kibana版本：<code>7.17.19 </code> 、<code>8.8.1</code></p>
<hr>
<p>在elasticsearch 8.8.1版本默认开启了用户认证，因此需要为kibana 服务创建用户并授予权限：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建用户</span>
</span></span><span style="display:flex;"><span>./elasticsearch-8.8.1/bin/elasticsearch-users useradd kibanauser
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 把 superuser,kibana_system,kibana_user 角色授权给kubanauser</span>
</span></span><span style="display:flex;"><span>./elasticsearch-8.8.1/bin/elasticsearch-users roles -a superuser,kibana_system,kibana_user kibanauser
</span></span></code></pre></div>

</div>

<h3 id="安装部署">安装部署</h3>
<ol>
<li>
<p>下载安装包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>version<span style="color:#f92672">=</span>7.17.19
</span></span><span style="display:flex;"><span><span style="color:#75715e">#wget https://repo.huaweicloud.com/kibana/${version}/kibana-${version}-linux-x86_64.tar.gz</span>
</span></span><span style="display:flex;"><span>wget https://artifacts.elastic.co/downloads/kibana/kibana-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf kibana-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-x86_64.tar.gz -C /data/elk/
</span></span><span style="display:flex;"><span>ln -svf /data/elk/<span style="color:#f92672">{</span>kibana-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-x86_64,kibana<span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>修改配置文件</p>

     
     
   <ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="**开启认证**" aria-controls="tabs-01-00" aria-selected="true">
        <strong>开启认证</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="**未开认证**" aria-controls="tabs-01-01" aria-selected="false">
        <strong>未开认证</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/elk/kibana/config/kibana.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server.port: 5601
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server.host: &#34;192.168.0.161&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">elasticsearch.hosts: [&#34;https://192.168.0.161:9200&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">elasticsearch.username: &#34;kibanauser&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">elasticsearch.password: &#34;kibana&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 取消自签证书的ca 验证
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">elasticsearch.ssl.verificationMode: &#34;none&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#i18n.locale: &#34;en&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">i18n.locale: &#34;zh-CN&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/elk/kibana/config/kibana.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server.port: 5601
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server.host: &#34;192.168.0.151&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">elasticsearch.hosts: [&#34;http://192.168.0.151:9200&#34;,&#34;http://192.168.0.152:9200&#34;,&#34;http://192.168.0.153:9200&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">i18n.locale: &#34;zh-CN&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>
    </div>
</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown -R elasticsearch:elasticsearch /data/elk/kibana*
</span></span></code></pre></div></li>
<li>
<p>创建systemd启动文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /etc/systemd/system/kibana.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description= kibana serveice
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WorkingDirectory=/data/elk/kibana
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/elk/kibana/bin/kibana
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=elasticsearch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable kibana --now
</span></span><span style="display:flex;"><span>systemctl status  kibana
</span></span></code></pre></div><p>检查kibana状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http://127.0.0.1:5601/status
</span></span></code></pre></div></li>
</ol>

</div>





    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f1b87c7ae6c9da4a7e1f6f0e6bd35a51">3.1.2 - filebeat</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-7f1952ab27641fd069c1c88a62d2ff1b">filebeat_install</h1>
	<div class="lead"><em>filebeat安装部署，配置详情请参阅其他文档</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-12" class="text-body-secondary">Thursday, June 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.29</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>


</div>

<table>
    <tr>
        <td><img src="https://www.elastic.co/docs/reference/beats/filebeat/images/filebeat.png" alt="架构"></td>
        <td>
            <a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/index.html" target="_blank">文档</a><br>
        </td>
        <td>
            <a href="https://mirrors.huaweicloud.com/filebeat/" target="_blank">下载</a><br>
        </td>
        <td>
            <a href="https://www.docker.elastic.co" target="_blank">docker镜像</a>
        </td>
    </tr>
</table>
<ol>
<li>
<p>下载安装包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>version<span style="color:#f92672">=</span>7.17.29
</span></span><span style="display:flex;"><span>wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#wget https://repo.huaweicloud.com/filebeat/${version}/filebeat-${version}-linux-x86_64.tar.gz</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf filebeat-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-x86_64.tar.gz -C /data/elk
</span></span><span style="display:flex;"><span>ln  -svf /data/elk/filebeat-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-x86_64  /data/elk/filebeat
</span></span></code></pre></div></li>
<li>
<p>修改配置文件


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">秘钥的保存和引用</h4>

    <p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.19/keystore.html" target="_blank">参考文档</a></p>
<p>通过 <code>filebeat keystore xxx</code> 创建和管理秘钥</p>


</div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/data/elk/filebeat/filebeat.yml<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filebeat.inputs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - type: log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    id: log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - /var/log/dmesg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - /var/log/messages
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - /var/log/secure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - /var/log/cron
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - /var/log/audit/audit.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - /var/log/yum.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output.elasticsearch:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  hosts: [&#34;192.168.0.114:9200&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  indices:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - index: &#34;warning-%{[agent.version]}-%{+yyyy.MM.dd}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      when:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        contains:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          message: &#34;WARN&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - index: &#34;error-%{[agent.version]}-%{+yyyy.MM.dd}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      when:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        contains:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          message: &#34;ERR&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - index: &#34;info-%{[agent.version]}-%{+yyyy.MM.dd}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      when:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        contains:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          message: &#34;INFO&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # 默认索引
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - index: &#34;default-%{[agent.version]}-%{+yyyy.MM.dd}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>创建systemd启动文件</p>
<table>
  <thead>
      <tr>
          <th>类型</th>
          <th>描述</th>
          <th>默认值</th>
          <th>配置参数</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>home</td>
          <td>Home of the Filebeat installation.</td>
          <td></td>
          <td><code>path.home</code></td>
      </tr>
      <tr>
          <td>bin</td>
          <td>The location for the binary files.</td>
          <td><code>{path.home}/bin</code></td>
          <td></td>
      </tr>
      <tr>
          <td>config</td>
          <td>The location for configuration files.</td>
          <td><code>{path.home}</code></td>
          <td><code>path.config</code></td>
      </tr>
      <tr>
          <td>data</td>
          <td>The location for persistent data files.</td>
          <td><code>{path.home}/data</code></td>
          <td><code>path.data</code></td>
      </tr>
      <tr>
          <td>logs</td>
          <td>The location for the logs created by Filebeat.</td>
          <td><code>{path.home}/logs</code></td>
          <td><code>path.logs</code></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /etc/systemd/system/filebeat.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Filebeat sends log files to Logstash or directly to Elasticsearch.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://www.elastic.co/products/beats/filebeat
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;BEAT_LOG_OPTS=&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;BEAT_CONFIG_OPTS=-c /data/elk/filebeat/filebeat.yml&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;BEAT_PATH_OPTS=--path.home /data/elk/filebeat --path.config /data/elk/filebeat --path.data /data/elk/filebeat/data --path.logs /data/elk/filebeat/logs&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/elk/filebeat/filebeat --environment systemd $BEAT_LOG_OPTS $BEAT_CONFIG_OPTS $BEAT_PATH_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable filebeat --now
</span></span><span style="display:flex;"><span>systemctl status filebeat
</span></span></code></pre></div></li>
</ol>

</div>





    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4a5a9fd6df7d5d4fb4e086d2cb64f014">3.1.2.2 - config</h1>
    
	<pre class="mermaid">graph LR

subgraph &#34;【主配置文件】&#34;
	A&gt;filebeat.yml]
end

subgraph filebeat
    B[filebeat] 
end

subgraph output
   C[output]
end

subgraph path
   D[path]
end

subgraph logging
   E[logging]
end

subgraph setup
   F[setup]
end

subgraph monitoring
   G[monitoring]
end

A -..-&gt;|&#34;所有输入、通用设置、全局处理器、模块等[&lt;font color=red&gt;必须&lt;/font&gt;]&#34;|B
A -..-&gt;|&#34;日志事件发送到的位置[&lt;font color=red&gt;必须&lt;/font&gt;]&#34;|C
A -..-&gt;|&#34;安装目录、数据目录、日志目录等路径 &#34;|D
A -..-&gt;|&#34;Filebeat 自身日志的级别、文件轮转、格式等&#34;|E
A -..-&gt;|&#34;在 ES 里创建索引模板、ILM 策略、Kibana 仪表板&#34;|F
A -..-&gt;|&#34; Filebeat 自身的指标送进 ES/Logstash，供 Stack Monitoring 查看&#34;|G</pre>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f2caea531a3ea24ebe8dbad2309c1375">3.1.2.2.1 - 通用配置</h1>
    <div class="lead">filebeat配置文件之通用配置</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.29</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>


</div>

<p>顶级配置段中支持的常用全部配置字段</p>
<pre class="mermaid">graph LR

subgraph &#34;【主配置文件】&#34;
	A&gt;filebeat.yml]
end

A --&gt; name
A --&gt; max_procs
A --&gt; tags
A --&gt; A1[&#34;fields|fields_under_root&#34;]
A --&gt; processors</pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;my-shipper&#34;</span>  <span style="color:#75715e"># 静态定义agent.name, 默认值为操作系统的hostname</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">max_procs</span>: <span style="color:#ae81ff">1</span>   <span style="color:#75715e"># 可用最大cpu，默认所有cpu</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">tags</span>:          
</span></span><span style="display:flex;"><span>- <span style="color:#e6db74">&#34;dev&#34;</span>
</span></span><span style="display:flex;"><span>- <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">center</span>: <span style="color:#ae81ff">BeiJing</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fields_under_root</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">processors</span>: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">udp</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_message_size</span>: <span style="color:#ae81ff">10MiB</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host</span>: <span style="color:#e6db74">&#34;0.0.0.0:9000&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rfc5424_parser.enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_topic</span>: <span style="color:#ae81ff">os</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.kafka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: [<span style="color:#e6db74">&#34;192.168.0.151:9092&#34;</span>,<span style="color:#e6db74">&#34;192.168.0.152:9092&#34;</span>,<span style="color:#e6db74">&#34;192.168.0.153:9092&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">topic</span>: <span style="color:#e6db74">&#39;%{[fields.log_topic]}&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">required_acks</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">compression</span>: <span style="color:#ae81ff">gzip</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_message_bytes</span>: <span style="color:#ae81ff">1000000</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a46b543e3d8a01cd19ad4825c7503d9c">3.1.2.2.2 - filebeat_inputs</h1>
    <div class="lead">filebeat配置文件之inputs</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.29</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>


</div>

<p>filebeat.inputs 定义了如何定义和处理日志事件，这里列出常用的input类型</p>
<pre class="mermaid">graph LR

subgraph &#34;【主配置文件】&#34;
	A&gt;filebeat.yml]
end

subgraph filebeat
    B[filebeat] 
end


subgraph inputs
    C[inputs]
end



A -..-&gt;|&#34;所有输入、通用设置、全局处理器、模块等[&lt;font color=red&gt;必须&lt;/font&gt;]&#34;|B


B --&gt; C
C--&gt; log/filestream/container
C--&gt; journald
C --&gt;syslog</pre>
<h3 id="logfilestreamcontainer"><a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-log.html" target="_blank">log</a>|<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-filestream.html" target="_blank">filestream|Container</a></h3>


<div class="alert alert-primary" role="alert">


    <p><del><strong>log</strong> plugin deprecated in 7.16.0</del> ,use <a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-filestream.html" target="_blank">filestream</a></p>
<p><strong>container</strong>可以看作是log的别名语法完全兼容</p>


</div>

<hr>
<p><font color=#008080><strong>paths</strong> </font>[必选参数，[]string]日志路径</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用该input，默认true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">my-filestream-id </span> <span style="color:#75715e"># 每一个input必须使用唯一的id，用于filebeat 追踪文件的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/messages</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/*.log</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><hr>
<p><font color=#008080><strong>encoding</strong> </font>[非必须，string]日志事件解码方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用该input</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">my-filestream-id </span> <span style="color:#75715e"># 每一个input必须使用唯一的id，用于filebeat 追踪文件的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/messages</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/*.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">encoding</span>: <span style="color:#ae81ff">utf8</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><hr>
<p><font color=#008080><strong>exclude_lines</strong> </font>[非必须，string]通过正则排除不需要采集的日志行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用该input</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">my-filestream-id </span> <span style="color:#75715e"># 每一个input必须使用唯一的id，用于filebeat 追踪文件的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/messages</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/*.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">encoding</span>: <span style="color:#ae81ff">utf8</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">exclude_lines</span>: <span style="color:#75715e"># 排除空行和以# 号开头的日志行</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^$&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^#.*&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><hr>
<p><font color=#008080><strong>include_lines</strong> </font>[非必须，string]采集符合正则规则的日志行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用该input</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">my-filestream-id </span> <span style="color:#75715e"># 每一个input必须使用唯一的id，用于filebeat 追踪文件的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/messages</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/*.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">encoding</span>: <span style="color:#ae81ff">utf8</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">exclude_lines</span>: <span style="color:#75715e"># 排除空行和以# 号开头的日志行</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^$&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^#.*&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">include_lines</span>: <span style="color:#75715e"># 仅仅采集错误日志</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;.*(ERR|err).*&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><hr>
<p><font color=#008080><strong>multiline</strong> </font>[非必须，map]多行匹配</p>
<p>日志格式：</p>
<pre tabindex="0"><code class="language-log" data-lang="log">cat &gt;&gt;/var/log/1.log&lt;&lt;&#39;EOF&#39;
[beat-logstash-some-name-832-2015.11.28] IndexNotFoundException[no such index]
    at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver$WildcardExpressionResolver.resolve(IndexNameExpressionResolver.java:566)
    at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver.concreteIndices(IndexNameExpressionResolver.java:133)
    at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver.concreteIndices(IndexNameExpressionResolver.java:77)
    at org.elasticsearch.action.admin.indices.delete.TransportDeleteIndexAction.checkBlock(TransportDeleteIndexAction.java:75)
EOF
</code></pre><p>如果input类型为log，则书写格式为：</p>

  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          data-td-tp-persist="**格式一**" aria-controls="tabs-02-00" aria-selected="true">
        <strong>格式一</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="**格式二**" aria-controls="tabs-02-01" aria-selected="false">
        <strong>格式二</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用该input</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">my-filestream-id </span> <span style="color:#75715e"># 每一个input必须使用唯一的id，用于filebeat 追踪文件的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/1.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">encoding</span>: <span style="color:#ae81ff">utf8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">multiline</span>: <span style="color:#75715e"># 示例中：把不是 [ 开头视为多行日志，并将不是[ 开头的行追加到前一行的后后面。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">pattern</span> <span style="color:#75715e"># 支持pattern 和 count</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pattern</span>: <span style="color:#e6db74">&#39;^\[&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">negate</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># true表示否定模式，即不与pattern 匹配的内容被视为多行，默认为false。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">match</span>: <span style="color:#ae81ff">after</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用该input</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">my-filestream-id </span> <span style="color:#75715e"># 每一个input必须使用唯一的id，用于filebeat 追踪文件的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/1.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">encoding</span>: <span style="color:#ae81ff">utf8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">multiline.type</span>: <span style="color:#ae81ff">pattern</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">multiline.pattern</span>: <span style="color:#e6db74">&#39;^\[&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">multiline.negate</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">multiline.match</span>: <span style="color:#ae81ff">after</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div>
    </div>
</div>

<p>如果input类型为filestream，则书写格式为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">filestream </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用该input</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">my-filestream-id </span> <span style="color:#75715e"># 每一个input必须使用唯一的id，用于filebeat 追踪文件的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/1.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">encoding</span>: <span style="color:#ae81ff">utf8</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">parsers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">multiline</span>: <span style="color:#75715e"># 示例中：把不是 [ 开头视为多行日志，并将不是[ 开头的行追加到前一行的后后面。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">pattern</span> <span style="color:#75715e"># 支持pattern 和 count</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">pattern</span>: <span style="color:#e6db74">&#39;^\[&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">negate</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># true表示否定模式，即不与pattern 匹配的内容被视为多行，默认为false。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">match</span>: <span style="color:#ae81ff">after</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><hr>
<p><font color=#008080><strong>json</strong> </font>[非必须，map]json格式的日志解析为json 键值对</p>

   

 
<ul class="nav nav-tabs" id="tabs-3" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-03-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-00" role="tab"
          data-td-tp-persist="**如果input类型为log，则书写格式为：**" aria-controls="tabs-03-00" aria-selected="true">
        <strong>如果input类型为log，则书写格式为：</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-03-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-01" role="tab"
          data-td-tp-persist="**如果input类型为filestream，则书写格式为：**" aria-controls="tabs-03-01" aria-selected="false">
        <strong>如果input类型为filestream，则书写格式为：</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-3-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-03-00" role="tabpanel" aria-labelled-by="tabs-03-00-tab" tabindex="3">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用该input</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">my-filestream-id </span> <span style="color:#75715e"># 每一个input必须使用唯一的id，用于filebeat 追踪文件的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/1.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">encoding</span>: <span style="color:#ae81ff">utf8</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">json.keys_under_root</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">json.message_key</span>: <span style="color:#ae81ff">message</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">multiline.type</span>: <span style="color:#ae81ff">pattern</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">multiline.pattern</span>: <span style="color:#e6db74">&#39;^\[&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">multiline.negate</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">multiline.match</span>: <span style="color:#ae81ff">after</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-03-01" role="tabpanel" aria-labelled-by="tabs-03-01-tab" tabindex="3">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">filestream </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用该input</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">my-filestream-id </span> <span style="color:#75715e"># 每一个input必须使用唯一的id，用于filebeat 追踪文件的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/1.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">encoding</span>: <span style="color:#ae81ff">utf8</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">parsers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">multiline</span>: <span style="color:#75715e"># 示例中：把不是 [ 开头视为多行日志，并将不是[ 开头的行追加到前一行的后后面。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">pattern</span> <span style="color:#75715e"># 支持pattern 和 count</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">pattern</span>: <span style="color:#e6db74">&#39;^\[&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">negate</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># true表示否定模式，即不与pattern 匹配的内容被视为多行，默认为false。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">match</span>: <span style="color:#ae81ff">after</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">ndjson</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">keys_under_root</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">message_key</span>: <span style="color:#ae81ff">message</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div>
    </div>
</div>

<hr>
<p><font color=#008080><strong>harvester_buffer_size</strong> </font>[非必须，int] 单个harvester 可以使用的最大buffer。单位bytes</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用该input</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">my-filestream-id </span> <span style="color:#75715e"># 每一个input必须使用唯一的id，用于filebeat 追踪文件的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/messages</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/*.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">encoding</span>: <span style="color:#ae81ff">utf8</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">exclude_lines</span>: <span style="color:#75715e"># 排除空行和以# 号开头的日志行</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^$&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^#.*&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">include_lines</span>: <span style="color:#75715e"># 仅仅采集错误日志</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;.*(ERR|err).*&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">harvester_buffer_size</span>: <span style="color:#ae81ff">16384</span> <span style="color:#75715e"># 默认值 16384 = 16k</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><hr>
<p><font color=#008080><strong>max_bytes</strong> </font>[非必须，int] 单条日志的最大bytes。 对于多行日志特别有用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用该input</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">my-filestream-id </span> <span style="color:#75715e"># 每一个input必须使用唯一的id，用于filebeat 追踪文件的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/messages</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/*.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">encoding</span>: <span style="color:#ae81ff">utf8</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">exclude_lines</span>: <span style="color:#75715e"># 排除空行和以# 号开头的日志行</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^$&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^#.*&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">include_lines</span>: <span style="color:#75715e"># 仅仅采集错误日志</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;.*(ERR|err).*&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">harvester_buffer_size</span>: <span style="color:#ae81ff">16384</span> <span style="color:#75715e"># 默认值 16384 = 16k</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_bytes</span>: <span style="color:#ae81ff">10485760</span> <span style="color:#75715e"># 默认值 10485760 = 10MB</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><hr>
<p><font color=#008080><strong>tags</strong> </font>[非必须，[]string] 为日志文件添加tag 便于kibana 和 logstash 等进行筛选</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用该input</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">my-filestream-id </span> <span style="color:#75715e"># 每一个input必须使用唯一的id，用于filebeat 追踪文件的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/messages</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/*.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">encoding</span>: <span style="color:#ae81ff">utf8</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">exclude_lines</span>: <span style="color:#75715e"># 排除空行和以# 号开头的日志行</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^$&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^#.*&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">include_lines</span>: <span style="color:#75715e"># 仅仅采集错误日志</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;.*(ERR|err).*&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">harvester_buffer_size</span>: <span style="color:#ae81ff">16384</span> <span style="color:#75715e"># 默认值 16384 = 16k</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_bytes</span>: <span style="color:#ae81ff">10485760</span> <span style="color:#75715e"># 默认值 10485760 = 10MB</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><hr>
<p><font color=#008080><strong>fields|fields_under_root</strong> </font>[非必须，map] 为日志文件添加自定义字段</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用该input</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">my-filestream-id </span> <span style="color:#75715e"># 每一个input必须使用唯一的id，用于filebeat 追踪文件的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/messages</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/*.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">encoding</span>: <span style="color:#ae81ff">utf8</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">exclude_lines</span>: <span style="color:#75715e"># 排除空行和以# 号开头的日志行</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^$&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^#.*&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">include_lines</span>: <span style="color:#75715e"># 仅仅采集错误日志</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;.*(ERR|err).*&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">harvester_buffer_size</span>: <span style="color:#ae81ff">16384</span> <span style="color:#75715e"># 默认值 16384 = 16k</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_bytes</span>: <span style="color:#ae81ff">10485760</span> <span style="color:#75715e"># 默认值 10485760 = 10MB</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fields</span>:  <span style="color:#75715e"># 为document信息添加额外的信息</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fields_under_root</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 把fields 中添加的信息至于document信息的顶级</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><h3 id="journald"><a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-journald.html" target="_blank">journald</a></h3>
<blockquote>
<p>该功能处于实验阶段，<a href="https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.17.29-linux-x86_64.tar.gz" target="_blank">7.17下载</a> 之后版本中支持</p>
</blockquote>
<p><font color=#008080><strong>include_matches</strong> </font>[非必须，[]map{}] 收集指定journald日志</p>
<p>收集服务日志</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">journald</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">consul.service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">include_matches</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">_SYSTEMD_UNIT=consul.service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">journald</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">filebeat.service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">include_matches</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">_SYSTEMD_UNIT=filebeat.service</span>
</span></span></code></pre></div><p>收集内核日志</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">journald</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">iptables</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">include_matches</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">_TRANSPORT=kernel</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">drop_event</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">when.not.regexp.message</span>: <span style="color:#e6db74">&#39;^iptables&#39;</span>
</span></span></code></pre></div><h3 id="syslog"><a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-syslog.html" target="_blank">Syslog</a></h3>
<blockquote>
<p>是一个轻量的syslog 服务，功能上与linux rsyslog 提供的tcp/udp 服务相同。常用于收集网络设备日志</p>
</blockquote>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0913be866ef74da65568b4fc853dba4f">3.1.2.2.3 - 扩展配置</h1>
    <div class="lead">filebeat配置文件之inputs扩展配置</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.29</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>


</div>

<pre class="mermaid">graph LR

subgraph &#34;【主配置文件】&#34;
	A&gt;filebeat.yml]
end

subgraph filebeat
    B[filebeat] 
end


subgraph 定义动态发现
    C[config.inputs]
end



A -..-&gt;|&#34;所有输入、通用设置、全局处理器、模块等[&lt;font color=red&gt;必须&lt;/font&gt;]&#34;|B


B --&gt; C</pre>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-configuration-reloading.html" target="_blank">加载扩展配置文件</a>。由于我更早使用过prometheus,该功能和prometheus中基于文件的自动发现极为相似，因此我将其称之为基于文件的自动发现。</p>
<p><code>filebeat.yml</code>主配置示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.config.inputs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/etc/beats/inputs.d/*.yml</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">reload.enabled</span>: <span style="color:#66d9ef">true</span>  <span style="color:#75715e"># 扩展配置文件变动时自动重载</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">reload.period</span>: <span style="color:#ae81ff">10s</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.kafka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: [<span style="color:#e6db74">&#34;192.168.0.151:9092&#34;</span>,<span style="color:#e6db74">&#34;192.168.0.152:9092&#34;</span>,<span style="color:#e6db74">&#34;192.168.0.153:9092&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">topic</span>: <span style="color:#e6db74">&#39;%{[fields.log_topic]}&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">required_acks</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">compression</span>: <span style="color:#ae81ff">gzip</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_message_bytes</span>: <span style="color:#ae81ff">1000000</span>
</span></span></code></pre></div><p>扩展文件支持<code>inputs</code>和<code>modules</code>相关配置。扩展配置文件示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># cat /etc/beats/inputs.d/1.yml</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">filestream</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">/var/log/messages</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scan_frequency</span>: <span style="color:#ae81ff">10s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_topic</span>: <span style="color:#ae81ff">default</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-227f470a0c5173ec7bf9f53ce8c25f13">filebeat_output</h1>
	<div class="lead">filebeat配置文件之output</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-12" class="text-body-secondary">Thursday, June 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.29</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>


</div>

<pre class="mermaid">graph LR

subgraph &#34;【主配置文件】&#34;
	A&gt;filebeat.yml]
end

subgraph output
    B[output] 
end


A -..-&gt;|&#34;日志事件发送到的位置[&lt;font color=red&gt;必须&lt;/font&gt;]&#34;|B

B --&gt; Elasticsearch
B --&gt; Kafka
B --&gt; Logstash</pre>
<h3 id="elasticsearch"><a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/elasticsearch-output.html" target="_blank">elasticsearch</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">output.elasticsearch</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: [<span style="color:#e6db74">&#34;192.168.0.161:9200&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">indices</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">index</span>: <span style="color:#e6db74">&#34;os-linux-warning-%{[agent.version]}-%{+yyyy.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">contains</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">message</span>: <span style="color:#e6db74">&#34;WARN&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">index</span>: <span style="color:#e6db74">&#34;os-linux-error-%{[agent.version]}-%{+yyyy.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">contains</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">message</span>: <span style="color:#e6db74">&#34;ERR&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">index</span>: <span style="color:#e6db74">&#34;os-linux-info-%{[agent.version]}-%{+yyyy.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">contains</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">message</span>: <span style="color:#e6db74">&#34;INFO&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># 默认索引</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">index</span>: <span style="color:#e6db74">&#34;os-linux-%{[agent.version]}-%{+yyyy.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 启用ssl 和密码认证后的语法</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#protocol: &#34;https&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#username: &#34;kibanauser&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#password: &#34;kibana&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#ssl.verification_mode: none</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 禁用索引生命周期管理，默认为true。在启用 setup.ilm.enabled 状态下setup.template 配置不会生效</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://www.elastic.co/guide/en/beats/filebeat/7.17/configuration-template.html</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.ilm.enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加载索引模版，默认为true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置索引模板的名称，默认值为 filebeat-%{[agent.version]}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.name</span>: <span style="color:#e6db74">&#34;os-linux&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置索引模板的匹配模式,默认值为 filebeat-%{[agent.version]}-*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.pattern</span>: <span style="color:#e6db74">&#34;os-linux-*&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 覆盖已有的索引模板，默认值为false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.overwrite</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置索引模板属性</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.settings</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 设置索引分片数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">index.number_of_shards</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 设置索引副本数量，要求小于集群的数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">index.number_of_replicas</span>: <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><h3 id="kafka"><a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/kafka-output.html" target="_blank">Kafka</a></h3>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">提醒</h4>

    <p>For Kafka version 0.10.0.0+ the message creation timestamp is set by beats and equals to the initial timestamp of the event. This affects the retention policy in Kafka: for example, if a beat event was created 2 weeks ago, the retention policy is set to 7 days and the message from beats arrives to Kafka today, it’s going to be immediately discarded since the timestamp value is before the last 7 days. It’s possible to change this behavior by setting timestamps on message arrival instead, so the message is not discarded but kept for 7 more days. To do that, please set <code>log.message.timestamp.type</code> to <code>LogAppendTime</code> (default <code>CreateTime</code>) in the Kafka configuration.</p>
<p><strong>Beats 等客户端带上了事件原始时间（CreateTime），而 Kafka 按这个时间做 retention，导致“老”事件一进来就被丢弃</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># kafka 修改配置</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.message.timestamp.type</span><span style="color:#f92672">=</span><span style="color:#e6db74">LogAppendTime</span>
</span></span></code></pre></div>

</div>


  
  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          aria-controls="tabs-02-00" aria-selected="false">
        <strong>输出到到kafka</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="格式样例一：" aria-controls="tabs-02-01" aria-selected="true">
        格式样例一：
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-02" role="tab"
          data-td-tp-persist="格式样例二：" aria-controls="tabs-02-02" aria-selected="false">
        格式样例二：
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">output.kafka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: [<span style="color:#e6db74">&#34;kafka1:9092&#34;</span>,<span style="color:#e6db74">&#34;kafka2:9092&#34;</span>,<span style="color:#e6db74">&#34;kafka3:9092&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#username:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#password:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">topic</span>: <span style="color:#e6db74">&#34;logs-%{[agent.version]}&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">topics</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">topic</span>: <span style="color:#e6db74">&#34;critical-%{[agent.version]}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when.contains</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">message</span>: <span style="color:#e6db74">&#34;CRITICAL&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">topic</span>: <span style="color:#e6db74">&#34;error-%{[agent.version]}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when.contains</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">message</span>: <span style="color:#e6db74">&#34;ERR&#34;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-02" role="tabpanel" aria-labelled-by="tabs-02-02-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">output.kafka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: [<span style="color:#e6db74">&#34;kafka1:9092&#34;</span>,<span style="color:#e6db74">&#34;kafka2:9092&#34;</span>,<span style="color:#e6db74">&#34;kafka3:9092&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#username:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#password:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">topic</span>: <span style="color:#e6db74">&#39;%{[fields.log_topic]}&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">required_acks</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">compression</span>: <span style="color:#ae81ff">gzip</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 1MB</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_message_bytes</span>: <span style="color:#ae81ff">1000000</span>
</span></span></code></pre></div>
    </div>
</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-351dbe8af926b8ca2d59ea7c4aa1f9e8">filebeat_processors</h1>
	<div class="lead"></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-12" class="text-body-secondary">Thursday, June 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.29</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>


</div>

<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/filtering-and-enhancing-data.html" target="_blank"><strong>processors</strong></a> 用于执行output前过滤和丰富日志流，多个processor 按照定义顺序执行。</p>
<pre class="mermaid">graph LR

subgraph &#34;【主配置文件】&#34;
	A&gt;filebeat.yml]
end

subgraph input
    B[input] 
end


A -..-&gt;B --&gt;B1[processors]
A -..-&gt;processors</pre>

  
  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>语法格式</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="格式1" aria-controls="tabs-01-01" aria-selected="true">
        格式1
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="格式2" aria-controls="tabs-01-02" aria-selected="false">
        格式2
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">&lt;processor_name&gt;</span>:  <span style="color:#75715e"># 指定由哪个processor执行动作</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">&lt;condition&gt;   </span> <span style="color:#75715e"># 定义条件</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">&lt;parameters&gt;    </span> <span style="color:#75715e"># 是要传递给processor的参数列表。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">&lt;processor_name&gt;</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">&lt;condition&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">&lt;parameters&gt;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">if</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">&lt;condition&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">then</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">&lt;processor_name&gt;</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">&lt;parameters&gt;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">&lt;processor_name&gt;</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">&lt;parameters&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">else</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">&lt;processor_name&gt;</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">&lt;parameters&gt;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">&lt;processor_name&gt;</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">&lt;parameters&gt;</span>
</span></span></code></pre></div>
    </div>
</div>

<hr>
<p><font color=#00868B><strong>参照语法格式，我将该配置的学习分为两个部分。即条件表达式 和 可执行动作</strong></font></p>
<h3 id="条件表达式condition">条件表达式（condition）</h3>
<ul>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/defining-processors.html#condition-equals" target="_blank"><code>equals</code></a></p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>filebeat.inputs:
</span></span><span style="display:flex;"><span>- type: filestream
</span></span><span style="display:flex;"><span>  enabled: true
</span></span><span style="display:flex;"><span>  paths:
</span></span><span style="display:flex;"><span>  - /var/log/*.log
</span></span><span style="display:flex;"><span>  processors:
</span></span><span style="display:flex;"><span>  - drop_event:
</span></span><span style="display:flex;"><span>      when:
</span></span><span style="display:flex;"><span>        equals:
</span></span><span style="display:flex;"><span>          status: <span style="color:#e6db74">&#34;firing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output.console:
</span></span><span style="display:flex;"><span>  pretty: true
</span></span></code></pre></div></li>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/defining-processors.html#condition-contains" target="_blank"><code>contains</code></a></p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">filestream</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/*.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">drop_event</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">contains</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">status</span>: <span style="color:#e6db74">&#34;firing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div></li>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/defining-processors.html#condition-regexp" target="_blank"><code>regexp</code></a></p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">filestream</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/var/log/*.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">drop_event</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regexp</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">status</span>: <span style="color:#e6db74">&#34;^firing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.console</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pretty</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div></li>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/defining-processors.html#condition-range" target="_blank"><code>range</code></a></p>
<blockquote>
<p>支持通过<code>lt</code>(小于)、 <code>gt</code>(大于)、 <code>lte</code>(小于等于)、 <code>gte</code>(大于等于)符号判断</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drop_event</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">range</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">http.response.code</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">lte</span>: <span style="color:#ae81ff">400</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 200&lt;= http.response.code &lt;=400</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drop_event</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">range</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">http.response.code.lte</span>: <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">http.response.code.gte</span>: <span style="color:#ae81ff">200</span>
</span></span></code></pre></div></li>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/defining-processors.html#condition-network" target="_blank"><code>network</code></a></p>
<blockquote>
<p>用于判断<em>ip</em>是否在指定的网络范围,有效取值包括：</p>
<ul>
<li><code>loopback</code> 代表回环地址127.0.0.0/8  、::1/128</li>
<li><code>private</code> ipv4定义的私有地址</li>
<li>使用 CIDR 表示法</li>
</ul>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drop_event</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">network</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">destination.ip</span>: [<span style="color:#e6db74">&#39;192.168.1.0/24&#39;</span>, <span style="color:#e6db74">&#39;10.0.0.0/8&#39;</span>, <span style="color:#ae81ff">loopback]</span>
</span></span></code></pre></div></li>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/defining-processors.html#condition-has_fields" target="_blank"><code>has_fields</code></a></p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drop_event</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">has_fields</span>: [<span style="color:#e6db74">&#34;kubernetes.labels.filebeat&#34;</span>]
</span></span></code></pre></div></li>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/defining-processors.html#condition-or" target="_blank"><code>or</code></a>  和 <a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/defining-processors.html#condition-and" target="_blank"><code>and</code></a></p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drop_event</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">or</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">has_fields</span>: [<span style="color:#e6db74">&#34;kubernetes.labels.filebeat&#34;</span>]
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">network</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">destination.ip</span>: [<span style="color:#e6db74">&#39;192.168.1.0/24&#39;</span>, <span style="color:#e6db74">&#39;10.0.0.0/8&#39;</span>, <span style="color:#ae81ff">loopback]</span>
</span></span></code></pre></div></li>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/defining-processors.html#condition-not" target="_blank"><code>not</code></a></p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drop_event</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">not</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">has_fields</span>: [<span style="color:#e6db74">&#34;kubernetes.labels.filebeat&#34;</span>]
</span></span></code></pre></div></li>
</ul>
<h3 id="可执行动作processor_name">可执行动作（processor_name）</h3>
<ul>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/drop-event.html" target="_blank"><strong><code>drop_event</code></strong></a>丢弃整个事件（通常与条件判断结合）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 丢弃开头为^DEBUG的日志</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drop_event</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regexp</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">message</span>: <span style="color:#e6db74">&#34;^DEBUG&#34;</span>
</span></span></code></pre></div></li>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/drop-fields.html" target="_blank"><code>drop_fields</code></a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 丢弃开头为^DEBUG的日志</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drop_event</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regexp</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">message</span>: <span style="color:#e6db74">&#34;^DEBUG&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drop_fields</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">has_fields</span>: [<span style="color:#e6db74">&#34;kubernetes.labels.filebeat&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ignore_missing</span>: <span style="color:#66d9ef">true</span>  <span style="color:#75715e"># 当缺失签时忽略错误</span>
</span></span></code></pre></div></li>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/rename-fields.html" target="_blank"><strong><code>rename</code></strong></a> 重命名字段</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 丢弃开头为^DEBUG的日志</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drop_event</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regexp</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">message</span>: <span style="color:#e6db74">&#34;^DEBUG&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drop_fields</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">has_fields</span>: [<span style="color:#e6db74">&#34;kubernetes.labels.filebeat&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ignore_missing</span>: <span style="color:#66d9ef">true</span>  <span style="color:#75715e"># 当缺失签时忽略错误</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">rename</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ignore_missing</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fail_on_error</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">from</span>: <span style="color:#e6db74">&#34;msg&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">to</span>: <span style="color:#e6db74">&#34;message&#34;</span> 
</span></span></code></pre></div></li>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/replace-fields.html" target="_blank"><code>replace</code></a></p>
<blockquote>
<p>替换值，例如把字段<code>message</code>的值改为<code>INFO</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>processors:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 丢弃开头为^DEBUG的日志</span>
</span></span><span style="display:flex;"><span>- drop_event:
</span></span><span style="display:flex;"><span>    when:
</span></span><span style="display:flex;"><span>      regexp:
</span></span><span style="display:flex;"><span>        message: <span style="color:#e6db74">&#34;^DEBUG&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- drop_fields:
</span></span><span style="display:flex;"><span>    when:
</span></span><span style="display:flex;"><span>      has_fields: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;kubernetes.labels.filebeat&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      ignore_missing: true  <span style="color:#75715e"># 当缺失签时忽略错误</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- rename:
</span></span><span style="display:flex;"><span>    ignore_missing: false
</span></span><span style="display:flex;"><span>    fail_on_error: true
</span></span><span style="display:flex;"><span>    fields:
</span></span><span style="display:flex;"><span>    - from: <span style="color:#e6db74">&#34;msg&#34;</span>
</span></span><span style="display:flex;"><span>      to: <span style="color:#e6db74">&#34;message&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- replace:
</span></span><span style="display:flex;"><span>      fields:
</span></span><span style="display:flex;"><span>        - field: <span style="color:#e6db74">&#34;message&#34;</span>
</span></span><span style="display:flex;"><span>          pattern: <span style="color:#e6db74">&#34;^(I|i|info|INFO)&#34;</span>
</span></span><span style="display:flex;"><span>          replacement: <span style="color:#e6db74">&#34;INFO&#34;</span>
</span></span><span style="display:flex;"><span>      ignore_missing: false
</span></span><span style="display:flex;"><span>      fail_on_error: true
</span></span></code></pre></div></li>
</ul>

  
  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          aria-controls="tabs-02-00" aria-selected="false">
        <strong><a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/add-labels.html" target="_blank">add_labels</a></strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="配置" aria-controls="tabs-02-01" aria-selected="true">
        配置
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-02" role="tab"
          data-td-tp-persist="日志效果" aria-controls="tabs-02-02" aria-selected="false">
        日志效果
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <pre tabindex="0"><code>processors:
- add_labels:
    labels:
      number: 1
      nested:
        with.dots: nested
      array:
      - do
      - re
      - with.fields: mi
</code></pre>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-02" role="tabpanel" aria-labelled-by="tabs-02-02-tab" tabindex="2">
        <pre tabindex="0"><code>    &#34;labels&#34;: {
      &#34;array.0&#34;: &#34;do&#34;,
      &#34;array.1&#34;: &#34;re&#34;,
      &#34;array.2.with.fields&#34;: &#34;mi&#34;,
      &#34;number&#34;: &#34;1&#34;,
      &#34;nested.with.dots&#34;: &#34;nested&#34;
    },
</code></pre>
    </div>
</div>


  
  
  
<ul class="nav nav-tabs" id="tabs-3" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-03-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-00" role="tab"
          aria-controls="tabs-03-00" aria-selected="false">
        <strong><a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/add-tags.html" target="_blank">add_tags</a></strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-03-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-01" role="tab"
          data-td-tp-persist="配置" aria-controls="tabs-03-01" aria-selected="true">
        配置
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-03-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-02" role="tab"
          data-td-tp-persist="日志效果" aria-controls="tabs-03-02" aria-selected="false">
        日志效果
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-3-content">
    <div class="tab-body tab-pane fade"
        id="tabs-03-00" role="tabpanel" aria-labelled-by="tabs-03-00-tab" tabindex="3">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-03-01" role="tabpanel" aria-labelled-by="tabs-03-01-tab" tabindex="3">
        <pre tabindex="0"><code>processors:
- add_tags:
    target: env  # 可选，如果以己经存在则覆盖
    tags: [web,pro]
</code></pre>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-03-02" role="tabpanel" aria-labelled-by="tabs-03-02-tab" tabindex="3">
        <pre tabindex="0"><code>    &#34;env&#34;: [
      &#34;web&#34;,
      &#34;pro&#34;
    ],
</code></pre>
    </div>
</div>


  
  
  
<ul class="nav nav-tabs" id="tabs-4" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-04-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-04-00" role="tab"
          aria-controls="tabs-04-00" aria-selected="false">
        <strong><a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/add-fields.html" target="_blank">add_fields</a></strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-04-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-04-01" role="tab"
          data-td-tp-persist="配置" aria-controls="tabs-04-01" aria-selected="true">
        配置
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-04-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-04-02" role="tab"
          data-td-tp-persist="日志效果" aria-controls="tabs-04-02" aria-selected="false">
        日志效果
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-4-content">
    <div class="tab-body tab-pane fade"
        id="tabs-04-00" role="tabpanel" aria-labelled-by="tabs-04-00-tab" tabindex="4">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-04-01" role="tabpanel" aria-labelled-by="tabs-04-01-tab" tabindex="4">
        <pre tabindex="0"><code>processors:
- add_fields:
    target: host_info # 可选，如果以己经存在则覆盖
    fields:
      zone: BeiJing
      center: BJ-1
</code></pre>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-04-02" role="tabpanel" aria-labelled-by="tabs-04-02-tab" tabindex="4">
        <pre tabindex="0"><code>    &#34;host_info&#34;: {
      &#34;center&#34;: &#34;BJ-1&#34;,
      &#34;zone&#34;: &#34;BeiJing&#34;
    },
</code></pre>
    </div>
</div>

<hr>

  
  
  
<ul class="nav nav-tabs" id="tabs-5" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-05-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-00" role="tab"
          aria-controls="tabs-05-00" aria-selected="false">
        <strong><a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/add-host-metadata.html" target="_blank">add_host_metadata</a></strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-05-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-01" role="tab"
          data-td-tp-persist="配置" aria-controls="tabs-05-01" aria-selected="true">
        配置
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-05-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-02" role="tab"
          data-td-tp-persist="日志效果" aria-controls="tabs-05-02" aria-selected="false">
        日志效果
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-5-content">
    <div class="tab-body tab-pane fade"
        id="tabs-05-00" role="tabpanel" aria-labelled-by="tabs-05-00-tab" tabindex="5">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-05-01" role="tabpanel" aria-labelled-by="tabs-05-01-tab" tabindex="5">
        <pre tabindex="0"><code>processors:
- add_host_metadata: 
    netinfo.enabled: false # 默认为true false不收集ip和mac
    
</code></pre>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-05-02" role="tabpanel" aria-labelled-by="tabs-05-02-tab" tabindex="5">
        <pre tabindex="0"><code>    &#34;host&#34;: {
      &#34;hostname&#34;: &#34;seagullcore01-uat-s2&#34;,
      &#34;os&#34;: {
        &#34;version&#34;: &#34;7 (Core)&#34;,
        &#34;family&#34;: &#34;redhat&#34;,
        &#34;codename&#34;: &#34;Core&#34;,
        &#34;type&#34;: &#34;linux&#34;,
        &#34;platform&#34;: &#34;centos&#34;,
        &#34;kernel&#34;: &#34;3.10.0-957.el7.x86_64&#34;,
        &#34;name&#34;: &#34;CentOS Linux&#34;
      },
      &#34;architecture&#34;: &#34;x86_64&#34;,
      &#34;containerized&#34;: false,
      &#34;name&#34;: &#34;seagullcore01-uat-s2&#34;,
      &#34;id&#34;: &#34;e81d9b925a3e41e7a01e9fe553b68d6c&#34;
    },
</code></pre>
    </div>
</div>

<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/add-kubernetes-metadata.html" target="_blank"><code>add_kubernetes_metadata</code></a></p>
<ul>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/decode-json-fields.html" target="_blank"><code>decode_json_fields</code></a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>processors:
</span></span><span style="display:flex;"><span>  - decode_json_fields:
</span></span><span style="display:flex;"><span>      fields: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;field1&#34;</span>, <span style="color:#e6db74">&#34;field2&#34;</span>, ...<span style="color:#f92672">]</span> <span style="color:#75715e"># 对那些字段执行解析</span>
</span></span><span style="display:flex;"><span>      process_array: false  <span style="color:#75715e">#是否对数组执行解析</span>
</span></span><span style="display:flex;"><span>      max_depth: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      target: <span style="color:#e6db74">&#34;&#34;</span>  <span style="color:#75715e">#解析后的结果在哪个字段下</span>
</span></span><span style="display:flex;"><span>      overwrite_keys: false
</span></span><span style="display:flex;"><span>      add_error_key: true  <span style="color:#75715e">#解析失败时将错误信息添加到解析结果中</span>
</span></span></code></pre></div></li>
<li>
<p><strong><code>dissect</code></strong> / <strong><code>grok</code></strong>: <strong>非常强大</strong>的处理器，用于<strong>解析</strong>非结构化的日志文本，并将其结构化为多个字段。</p>
<ul>
<li>
<p><strong>Dissect</strong>：使用简单的分隔符匹配，性能极高。</p>
<p>日志格式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 日志示例：2023-10-27 12:01:45 [ERROR] Service payment failed.</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">dissect</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tokenizer</span>: <span style="color:#e6db74">&#34;%{+YYYY-MM-dd} %{+HH:mm:ss} [%{log.level}] Service %{service.name} %{service.status}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">field</span>: <span style="color:#e6db74">&#34;message&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_prefix</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div></li>
<li>
<p><strong>Grok</strong>：使用复杂的正则表达式模式，功能更强大但更耗 CPU。</p>
</li>
</ul>
</li>
<li>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/8.18/processor-script.html" target="_blank"><code>script</code></a> 支持执行javascript 脚本，从而允许用户自定义处理动作</p>
</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-4f0c7d5f2d4d7c2f7a8f6d626bcc40a0">filebeat_autodiscover</h1>
	<div class="lead"></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-11-12" class="text-body-secondary">Wednesday, November 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.29</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>


</div>

<p>filebeat支持基于<em>docker</em>、<em>kubernetes</em>等自动发现，<em>kubernetes</em>的自动发现可以完成对node、pod、service日志的自动采集。</p>
<hr>
<p>阅读该文档你将学习到如何动态收集kubernetes中pod日志：</p>
<blockquote>
<p><font size=1px color= #00868B>示例假定每一个 <em>namespace</em>对应一个业务单元，为了实现业务日志的隔离将日志按照 <em>namespace</em> 分类保存在elasticsearch不同的index中</font></p>
</blockquote>
<ul>
<li><input checked="" disabled="" type="checkbox"> 采集指定 <em>namespace</em> 中所有pod日志、采集指定 <em>pod</em> 日志</li>
<li><input checked="" disabled="" type="checkbox"> 动态定制 <em>pod</em> 多行日志采集</li>
<li><input checked="" disabled="" type="checkbox"> json日志的格式化</li>
</ul>
<hr>
<h3 id="配置示例">配置示例</h3>

  
  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>filebeat.yml</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="运行在k8s外" aria-controls="tabs-01-01" aria-selected="true">
        运行在k8s外
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="运行在k8s内" aria-controls="tabs-01-02" aria-selected="false">
        运行在k8s内
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.autodiscover</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">providers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">kubernetes</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">node</span>: <span style="color:#ae81ff">seagullcore01-uat-s2 </span> <span style="color:#75715e"># 指定filebeat作用范围，防止无法自动检测的节点【可选】</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#namespace: default # 只收集default namespace下pod日志 【可选】</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resource</span>: <span style="color:#ae81ff">pod</span> <span style="color:#75715e"># 资源发现的对象，可选值 pod/node/service, 默认为pod 【可选】</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">scope</span>: <span style="color:#ae81ff">node</span> <span style="color:#75715e"># 资源发现作用域，可选值 node/cluster。service资源选择cluster 【可选】</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">add_resource_metadata</span>: <span style="color:#75715e"># 对namespace 和 node 元数据进行处理，默认收集所有labels, 忽略所有annotations 【可选】</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">namespace</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">include_labels</span>: [<span style="color:#e6db74">&#34;mylabel&#34;</span>]
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">include_annotations</span>: [<span style="color:#e6db74">&#34;co.elastic.logs/enabled&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">node</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">include_labels</span>: [<span style="color:#e6db74">&#34;block&#34;</span>,<span style="color:#e6db74">&#34;zone&#34;</span>]
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">include_annotations</span>: [<span style="color:#e6db74">&#34;myannotation&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">deployment</span>: <span style="color:#66d9ef">false</span>  <span style="color:#75715e"># 如果pod是deploy管理默认展示deploy名称，通过设置为false 关闭该元数据</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">kube_config</span>: <span style="color:#e6db74">&#34;/root/.kube/config&#34;</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hints.enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用hints 功能</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># false 表示禁用默认配置，filebeat仅自动发现注解包含&#34;co.elastic.logs/enabled&#34;: &#34;true&#34;的pod或namespace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># true 表示启用默认配置，filebeat会自动发现k8s所有pod</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hints.default_config.enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">templates</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">container </span> <span style="color:#75715e"># 使用filestream 可能无法读取符号连接，建议使用container</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">id</span>: <span style="color:#ae81ff">${data.kubernetes.container.id}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">/var/log/containers/*-${data.kubernetes.container.id}.log</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e"># 添加 multiline 配置，从 hints 中读取</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">multiline</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">pattern</span>: <span style="color:#ae81ff">${data.hints.logs.multiline.pattern}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">negate</span>: <span style="color:#ae81ff">${data.hints.logs.multiline.negate}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">match</span>: <span style="color:#ae81ff">${data.hints.logs.multiline.match}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.kafka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: [<span style="color:#e6db74">&#34;192.168.0.151:9092&#34;</span>,<span style="color:#e6db74">&#34;192.168.0.152:9092&#34;</span>,<span style="color:#e6db74">&#34;192.168.0.153:9092&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#topic: &#39;%{[fields.log_topic]}&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">topic</span>: <span style="color:#e6db74">&#39;%{[kubernetes.namespace]}&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">required_acks</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">compression</span>: <span style="color:#ae81ff">gzip</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_message_bytes</span>: <span style="color:#ae81ff">1000000</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">filebeat-config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">filebeat.yml</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    filebeat.autodiscover:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      providers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - type: kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          node: ${NODE_NAME}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          hints.enabled: true # 启用hints 功能
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          # false 表示禁用默认配置，filebeat仅自动发现注解包含&#34;co.elastic.logs/enabled&#34;: &#34;true&#34;的pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          # true 表示启用默认配置，filebeat会自动发现k8s所有pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          hints.default_config.enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          templates:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - type: container  # 使用filestream 可能无法读取符号连接，建议使用container
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              id: ${data.kubernetes.container.id}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              - /var/log/containers/*-${data.kubernetes.container.id}.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              # 添加 multiline 配置，从 hints 中读取
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              multiline:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                pattern: ${data.hints.logs.multiline.pattern}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                negate: ${data.hints.logs.multiline.negate}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                match: ${data.hints.logs.multiline.match}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    output.kafka:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      hosts: [&#34;192.168.0.151:9092&#34;,&#34;192.168.0.152:9092&#34;,&#34;192.168.0.153:9092&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # topic: &#39;%{[fields.log_topic]}&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      topic: &#39;%{[kubernetes.namespace]}&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      required_acks: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      compression: gzip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      max_message_bytes: 1000000</span>
</span></span></code></pre></div>
    </div>
</div>

<hr>
<p><font color=#00868B><strong>需求一:</strong></font> 采集指定 <em>namespace</em> 中pod日志、采集指定 <em>pod</em> 日志</p>
<p><font color=#008B45><strong>功能实现：</strong></font></p>
<p>第一步：<code>filebeat.yaml</code> 配置中启用<code>condition</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>          <span style="color:#f92672">hints.enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 启用hints 功能</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e"># false 表示禁用默认配置，filebeat仅自动发现注解包含&#34;co.elastic.logs/enabled&#34;: &#34;true&#34;的pod或namespace</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e"># true 表示启用默认配置，filebeat会自动发现k8s所有pod</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">hints.default_config.enabled</span>: <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p>第二步：对需要采集的<code>pod</code> 或 <code>namepsace</code>添加注解(该注解名称为自定义)</p>
<ul>
<li>
<p>收集指定名称空间下所有pod 日志,示例收集default名称空间下所有pod日志</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl annotate ns default co.elastic.logs/enabled<span style="color:#f92672">=</span>true
</span></span></code></pre></div></li>
<li>
<p>收集指定pod日志</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n kube-system annotate pod filebeat-99gsc co.elastic.logs/enabled<span style="color:#f92672">=</span>true
</span></span></code></pre></div></li>
</ul>
<hr>
<p><font color=#00868B><strong>需求二:</strong></font>  多行日志的采集，java报错堆栈处理</p>
<p><font color=#008B45><strong>功能实现：</strong></font></p>
<p>第一步：开启日志采集，参考 <strong>需求一</strong></p>
<p>第二步：通过注解添加多行日志规则，多行规则<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/multiline-examples.html" target="_blank">参考</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n kube-system annotate pod  filebeat-bklsz <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>co.elastic.logs/multiline.pattern<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;^[0-9]{4}-[0-9]{2}-[0-9]{2}&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>co.elastic.logs/multiline.negate<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>co.elastic.logs/multiline.match<span style="color:#f92672">=</span>after
</span></span></code></pre></div><hr>
<p><font color=#00868B><strong>需求三:</strong></font>  实现对指定pod 日志进行json格式化</p>
<p><font color=#008B45><strong>功能实现：</strong></font></p>
<p>第一步：开启日志采集，参考 <strong>需求一</strong></p>
<p>第二步：通过注解添加格式解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n kube-system annotate pod  filebeat-99gsc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>co.elastic.logs/json.keys_under_root<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>co.elastic.logs/json.message_key<span style="color:#f92672">=</span>message 
</span></span></code></pre></div><p><font color=#00868B><strong>需求四:</strong></font>  实现对pod日志的processor处理,丢弃info日志</p>
<p><font color=#008B45><strong>功能实现：</strong></font></p>
<p>第一步：开启日志采集，参考 <strong>需求一</strong></p>
<p>第二步：通过注解添加格式解析</p>
<p>第三步：通过注解添加processors</p>

  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          data-td-tp-persist="processors原始格式" aria-controls="tabs-02-00" aria-selected="true">
        processors原始格式
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="转成hints格式" aria-controls="tabs-02-01" aria-selected="false">
        转成hints格式
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drop_events</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regexp</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">log.level</span>: <span style="color:#e6db74">&#39;info|I|INFO&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n kube-system annotate pod filebeat-lxmnp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>co.elastic.logs/processors.drop_event.when.regexp.log.level<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;info|I|INFO&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>co.elastic.logs/json.keys_under_root<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>co.elastic.logs/json.message_key<span style="color:#f92672">=</span>message <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>co.elastic.logs/enabled<span style="color:#f92672">=</span>true --overwrite
</span></span></code></pre></div>
    </div>
</div>


</div>





    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f1ee3803d3307ddce7d45e950c702fe9">3.1.3 - logstash</h1>
    
	<p>Logstash事件处理流水线有三个阶段：输入→过滤器→ 输出</p>
<ul>
<li>
<p>inputs</p>
<p>file 从文件读取</p>
<p>syslog 充当syslog服务器</p>
<p>redis</p>
<p>kafka</p>
<p>beats 处理来自beats事件</p>
</li>
<li>
<p>filter</p>
<p>grok</p>
<p>mutate</p>
<p>drop</p>
<p>clone</p>
<p>geoip</p>
</li>
<li>
<p>output</p>
<p>elasticsearch</p>
<p>file</p>
<p>graphite</p>
<p>statsd</p>
</li>
<li>
<p>Codecs</p>
<p><strong>json</strong></p>
<p><strong>multiline</strong></p>
</li>
</ul>
<table>
  <thead>
      <tr>
          <th>排序</th>
          <th>代码</th>
          <th>仓位建议</th>
          <th>核心逻辑</th>
          <th>止损位</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>①</td>
          <td>603977 国泰集团</td>
          <td>30%</td>
          <td>稀有金属矿+民爆，2026订单刚性，PEG0.45，机构榜干净，再涨30%才触监管</td>
          <td>破5日线</td>
      </tr>
      <tr>
          <td>③</td>
          <td>601106 中国一重</td>
          <td>10%</td>
          <td>核电长逻辑，换手低，适合底仓配置，短线爆发力一般</td>
          <td>破20日线</td>
      </tr>
      <tr>
          <td>④</td>
          <td>002046 国机精工</td>
          <td>5%</td>
          <td>航天故事性感，但拉萨席位对倒严重，只能迷你仓博弈</td>
          <td>破首板低点</td>
      </tr>
  </tbody>
</table>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-1118f37e282b1f000d6ebbf259286d13">logstash_install</h1>
	<div class="lead">使用filebeat收集linux操作系统日志</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-12" class="text-body-secondary">Friday, September 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.19</code></p>
<p>logstash版本：<code>7.15.0</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>


</div>

<p>Logstash 使用jruby 语言开发，软件运行依赖jdk<a href="https://www.elastic.co/support/matrix#matrix_jvm" target="_blank">兼容矩阵</a>，如果无法确认该使用什么版本可以下载带有jdk环境的logstash安装包。</p>
<p><img src="https://www.elastic.co/guide/en/logstash/7.15/static/images/basic_logstash_pipeline.png" alt=""></p>
<p><em>安装java（非必须）</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://download.java.net/java/ga/jdk11/openjdk-11_linux-x64_bin.tar.gz
</span></span><span style="display:flex;"><span>tar xf openjdk-11_linux-x64_bin.tar.gz -C /opt
</span></span><span style="display:flex;"><span>ln -svf  /opt/<span style="color:#f92672">{</span>jdk-11,jdk<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat&gt;&gt;/etc/profile<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/opt/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_JRE=$JAVA_HOME/jre
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=$JAVA_HOME/lib:$JAVA_HOME/jre/lib
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=$JAVA_HOME/bin:$JAVA_JRE/bin:$PATH:.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>source /etc/profile
</span></span><span style="display:flex;"><span>java -version
</span></span></code></pre></div><p><em>安装logstash</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>version<span style="color:#f92672">=</span>7.15.0
</span></span><span style="display:flex;"><span>wget https://mirrors.huaweicloud.com/logstash/<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>/logstash-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf logstash-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-x86_64.tar.gz -C /data/elk
</span></span><span style="display:flex;"><span>ln  -svf /data/elk/logstash-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>  /data/elk/logstash
</span></span></code></pre></div><blockquote>
<p>测试运行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/data/elk/logstash/bin/logstash -e <span style="color:#e6db74">&#39;input { stdin {} } output { stdout { codec=&gt;rubydebug }}&#39;</span>
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/data/elk/logstash/config/logstash.conf<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Sample Logstash configuration for creating a simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Beats -&gt; Logstash -&gt; Elasticsearch pipeline.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">input {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  beats {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    port =&gt; 5044
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hosts =&gt; [&#34;http://192.168.0.114:9200&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    index =&gt; &#34;%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #user =&gt; &#34;elastic&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #password =&gt; &#34;changeme&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /etc/systemd/system/logstash.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description= logstash serveice
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WorkingDirectory=/data/elk/logstash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/elk/logstash/bin/logstash \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          -f /data/elk/logstash/config/logstash.conf \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          --config.reload.automatic
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload 
</span></span><span style="display:flex;"><span>systemctl enable logstash --now
</span></span><span style="display:flex;"><span>systemctl status logstash
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a1725c220824bf5195e849bc4136f881">logstash-input</h1>
	<div class="lead">logstash之input配置</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-12" class="text-body-secondary">Friday, September 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.19</code></p>
<p>logstash版本：<code>7.15.0</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>


</div>

<p><img src="https://www.elastic.co/guide/en/logstash/7.15/static/images/basic_logstash_pipeline.png" alt=""></p>
<h3 id="input-配置">INPUT 配置</h3>
<p><strong><a href="https://www.elastic.co/guide/en/logstash/7.15/plugins-inputs-redis.html#plugins-inputs-redis-key" target="_blank">redis</a></strong></p>
<ul>
<li>
<p><strong>data_type</strong>[必选参数，数据类型为字符串] 可选值 <code>list</code> <code>channel</code> <code>pattern_channel</code></p>
</li>
<li>
<p><strong>key</strong>[必选参数，数据类型为字符串] 日志记录在那个名字的list /channel中</p>
</li>
<li>
<p><strong>host</strong>[必选参数]  redis绑定的服务ip</p>
</li>
<li>
<p><strong>port</strong> redis绑定的服务端口，默认6379</p>
</li>
<li>
<p><strong>password</strong> redis服务密码</p>
</li>
<li>
<p><strong>threads</strong> [数据类型为整型]多线程消费redis数据，默认1</p>
</li>
<li>
<p><strong>tags</strong>[所有类型intput都支持，数据类型为列表] 添加tag</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>tags <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;linux&#34;</span>,<span style="color:#e6db74">&#34;dev&#34;</span><span style="color:#f92672">]</span>
</span></span></code></pre></div></li>
<li>
<p><strong>add_field</strong>[所有类型intput都支持，数据类型为hash]添加自定义字段</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>add_field <span style="color:#f92672">=&gt;</span> { 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;env&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;pro&#34;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;app&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;mobile&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div></li>
<li>
<p>示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/data/elk/logstash/config/logstash.conf<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">input {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  redis {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    data_type =&gt; &#34;list&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    key =&gt; &#34;logstash:beat:logstash&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    host =&gt; &#34;192.168.0.161&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    password =&gt; &#34;mypass&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    threads =&gt; 4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add_field =&gt; { 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;env&#34; =&gt; &#34;pro&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;app&#34; =&gt; &#34;mobile&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    tags =&gt; [&#34;linux&#34;,&#34;dev&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hosts =&gt; [&#34;http://192.168.0.114:9200&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    index =&gt; &#34;logstash-%{+YYYY.MM.dd}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #user =&gt; &#34;elastic&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #password =&gt; &#34;changeme&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
</ul>
<p><strong><a href="https://www.elastic.co/guide/en/logstash/7.15/plugins-inputs-file.html" target="_blank">file</a></strong></p>
<blockquote>
<p>将日志读取位置记录在<code>sincedb</code> 文件中，当重启logstash 后仍然可以继续读取。示例中记录在</p>
<p><code>/data/elk/logstash/data/plugins/inputs/file/.sincedb_452905a167cf4509fd08acb964fdb20c</code></p>
</blockquote>
<ul>
<li>
<p><strong>path</strong>[必选参数，数据类型为数组]</p>
</li>
<li>
<p><strong>start_position</strong>[数据类型字符串] logstash从哪里开始读取日志，可选参数<code>begining</code> <code>end</code> 默认为<code>end</code>。如果需要从头读取数据请设置为 <code>begining</code></p>
<p>该参数只作用在logstash 首次启动，也就是不存在<code>sincedb</code> 文件时</p>
</li>
<li>
<p><strong>exclude</strong>[数据类型为数组] 排除匹配的文件不跟踪</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>input {
</span></span><span style="display:flex;"><span>    file {
</span></span><span style="display:flex;"><span>        path <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/var/log/*&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        exclude <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;*.gz&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div></li>
<li>
<p><strong>tags</strong>[所有类型intput都支持，数据类型为列表] 添加tag</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>tags <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;linux&#34;</span>,<span style="color:#e6db74">&#34;dev&#34;</span><span style="color:#f92672">]</span>
</span></span></code></pre></div></li>
<li>
<p><strong>add_field</strong>[所有类型intput都支持，数据类型为hash]添加自定义字段</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>add_field <span style="color:#f92672">=&gt;</span> { 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;env&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;pro&#34;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;app&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;mobile&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div></li>
<li>
<p>示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/data/elk/logstash/config/logstash.conf<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">input {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    file {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        path =&gt; [&#34;/var/log/messages&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		start_position =&gt; &#34;beginning&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hosts =&gt; [&#34;http://192.168.0.114:9200&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    index =&gt; &#34;logstash-%{+YYYY.MM.dd}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #user =&gt; &#34;elastic&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #password =&gt; &#34;changeme&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
</ul>
<p><a href="https://www.elastic.co/guide/en/logstash/7.15/plugins-inputs-exec.html" target="_blank">exec</a> 周期调用系统命令，logstash收集命令输出</p>
<ul>
<li>
<p><strong>command</strong>[必选参数，数据类型为字符串]  要执行的命令</p>
</li>
<li>
<p><strong>interval</strong> 执行命令的间隔，单位s</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>input {
</span></span><span style="display:flex;"><span>  exec {
</span></span><span style="display:flex;"><span>    command <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;TERM=xterm /usr/bin/top -n 1 -b&#34;</span> 
</span></span><span style="display:flex;"><span>    interval <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>schedule</strong>按照crontab格式周期执行命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>input {
</span></span><span style="display:flex;"><span>  exec {
</span></span><span style="display:flex;"><span>    command <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;TERM=xterm /usr/bin/top -n 1 -b&#34;</span> 
</span></span><span style="display:flex;"><span>    schedule <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;*/1 * * * *&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>tags</strong>[所有类型intput都支持，数据类型为列表] 添加tag</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>tags <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;linux&#34;</span>,<span style="color:#e6db74">&#34;dev&#34;</span><span style="color:#f92672">]</span>
</span></span></code></pre></div></li>
<li>
<p><strong>add_field</strong>[所有类型intput都支持，数据类型为hash]添加自定义字段</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>add_field <span style="color:#f92672">=&gt;</span> { 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;env&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;pro&#34;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;app&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;mobile&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div></li>
<li>
<p>示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/data/elk/logstash/config/logstash.conf<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">input {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  exec {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    command =&gt; &#34;TERM=xterm /usr/bin/top -n 1 -b&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    interval =&gt; 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hosts =&gt; [&#34;http://192.168.0.114:9200&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    index =&gt; &#34;logstash-%{+YYYY.MM.dd}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #user =&gt; &#34;elastic&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #password =&gt; &#34;changeme&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
</ul>
<p><a href="https://www.elastic.co/guide/en/logstash/7.15/plugins-inputs-http.html" target="_blank">http</a> 用户 可以传递纯文本、JSON 或任何格式化数据</p>
<ul>
<li>
<p><strong>host</strong> 默认0.0.0.0</p>
</li>
<li>
<p><strong>port</strong> 默认8080</p>
</li>
<li>
<p><strong>threads</strong> 线程数默认 1</p>
</li>
<li>
<p><strong>user/password</strong> 开启用户名密码认证</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>cat <span style="color:#f92672">&gt;</span><span style="color:#e6db74">/data/e</span>lk<span style="color:#f92672">/</span>logstash<span style="color:#f92672">/</span>config<span style="color:#f92672">/</span>logstash<span style="color:#f92672">.</span>conf<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#39;EOF&#39;</span>
</span></span><span style="display:flex;"><span>input {
</span></span><span style="display:flex;"><span>  http {
</span></span><span style="display:flex;"><span>	host <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>
</span></span><span style="display:flex;"><span>	port <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;8080&#34;</span>
</span></span><span style="display:flex;"><span>	threads <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	password <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Q!123&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>output {
</span></span><span style="display:flex;"><span>  elasticsearch {
</span></span><span style="display:flex;"><span>    hosts <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;http://192.168.0.114:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    index <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;logstash-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#user =&gt; &#34;elastic&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#password =&gt; &#34;changeme&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -u <span style="color:#e6db74">&#39;log:Q!123&#39;</span>  -X POST --data <span style="color:#e6db74">&#39;{&#34;a&#34;:&#34;123&#34;}&#39;</span> 192.168.0.115:8080
</span></span></code></pre></div></li>
</ul>
<p><a href="https://www.elastic.co/guide/en/logstash/7.15/plugins-inputs-kafka.html" target="_blank">kafka</a> 从kafka消费信息</p>
<ul>
<li>
<p><strong>topics</strong>[数据类型数组] 默认值 <code>[&quot;logstash&quot;]</code></p>
</li>
<li>
<p><strong>topics_pattern</strong>[数据类型字符串] 正则模式匹配</p>
</li>
<li>
<p><strong>consumer_threads</strong> 默认值 <code>1</code></p>
</li>
<li>
<p>示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>cat <span style="color:#f92672">&gt;</span><span style="color:#e6db74">/data/e</span>lk<span style="color:#f92672">/</span>logstash<span style="color:#f92672">/</span>config<span style="color:#f92672">/</span>logstash<span style="color:#f92672">.</span>conf<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#39;EOF&#39;</span>
</span></span><span style="display:flex;"><span>input {
</span></span><span style="display:flex;"><span>  kafka {
</span></span><span style="display:flex;"><span>    bootstrap_servers <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;192.168.0.161:9092&#34;</span>   <span style="color:#75715e"># Kafka 集群地址，多个用逗号分隔</span>
</span></span><span style="display:flex;"><span>    topics            <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;app-log&#34;</span><span style="color:#f92672">]</span>            <span style="color:#75715e"># 消费的 topic</span>
</span></span><span style="display:flex;"><span>    group_id          <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;logstash-consumer&#34;</span>    <span style="color:#75715e"># 消费者组 ID</span>
</span></span><span style="display:flex;"><span>    auto_offset_reset <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;earliest&#34;</span>             <span style="color:#75715e"># 从头开始（第一次无 offset 时）</span>
</span></span><span style="display:flex;"><span>    codec             <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;json&#34;</span>                 <span style="color:#75715e"># 消息体是 JSON 就加，纯文本可删</span>
</span></span><span style="display:flex;"><span>    decorate_events   <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>                   <span style="color:#75715e"># 给事件加 @metadata[kafka] 字段（topic/partition/offset）</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>output {
</span></span><span style="display:flex;"><span>  elasticsearch {
</span></span><span style="display:flex;"><span>    hosts <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;http://192.168.0.114:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    index <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;logstash-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#user =&gt; &#34;elastic&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#password =&gt; &#34;changeme&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EOF</span>
</span></span></code></pre></div></li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-5f3628e70e31bf85b61b399a02603abb">logstash-output</h1>
	<div class="lead">logstash之output配置</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-12" class="text-body-secondary">Friday, September 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.19</code></p>
<p>logstash版本：<code>7.15.0</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>


</div>

<p><img src="https://www.elastic.co/guide/en/logstash/7.15/static/images/basic_logstash_pipeline.png" alt=""></p>
<h3 id="output配置">OUTPUT配置</h3>
<p><strong><a href="https://www.elastic.co/guide/en/logstash/7.15/plugins-outputs-elasticsearch.html" target="_blank">elasticsearch</a></strong></p>
<ul>
<li>
<p>hosts[非必须，数据类型数组] 默认值<code>http://127.0.0.1:9200</code></p>
</li>
<li>
<p>index[非必须] 默认值 <code>logstash-%{+YYYY.MM.dd}</code></p>
</li>
<li>
<p>user</p>
</li>
<li>
<p>password</p>
</li>
<li>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>cat <span style="color:#f92672">&gt;</span><span style="color:#e6db74">/data/e</span>lk<span style="color:#f92672">/</span>logstash<span style="color:#f92672">/</span>config<span style="color:#f92672">/</span>logstash<span style="color:#f92672">.</span>conf<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#39;EOF&#39;</span>
</span></span><span style="display:flex;"><span>input {
</span></span><span style="display:flex;"><span>  kafka {
</span></span><span style="display:flex;"><span>    bootstrap_servers <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;192.168.0.161:9092&#34;</span>   <span style="color:#75715e"># Kafka 集群地址，多个用逗号分隔</span>
</span></span><span style="display:flex;"><span>    topics            <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;app-log&#34;</span>,<span style="color:#e6db74">&#34;sys-log&#34;</span><span style="color:#f92672">]</span>  <span style="color:#75715e"># 消费的 topic</span>
</span></span><span style="display:flex;"><span>    group_id          <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;logstash-consumer&#34;</span>    <span style="color:#75715e"># 消费者组 ID</span>
</span></span><span style="display:flex;"><span>    auto_offset_reset <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;earliest&#34;</span>             <span style="color:#75715e"># 从头开始（第一次无 offset 时）</span>
</span></span><span style="display:flex;"><span>    codec             <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;json&#34;</span>                 <span style="color:#75715e"># 消息体是 JSON 就加，纯文本可删</span>
</span></span><span style="display:flex;"><span>    decorate_events   <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>                   <span style="color:#75715e"># 给事件加 @metadata[kafka] 字段（topic/partition/offset）</span>
</span></span><span style="display:flex;"><span>    consumer_threads <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">5</span>						<span style="color:#75715e"># 开启多线程消费kafka</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># --------- SASL/SCRAM 认证（与 Kafka 保持一致） ---------</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#security_protocol =&gt; &#34;SASL_PLAINTEXT&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#sasl_mechanism    =&gt; &#34;SCRAM-SHA-256&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#sasl_jaas_config  =&gt; &#39;org.apache.kafka.common.security.scram.ScramLoginModule required</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#                      username=&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#                      password=&#34;pytc@2026&#34;;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>output {
</span></span><span style="display:flex;"><span>  elasticsearch {
</span></span><span style="display:flex;"><span>    hosts <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;http://192.168.0.114:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    index <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;logstash-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#user =&gt; &#34;elastic&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#password =&gt; &#34;changeme&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EOF</span>
</span></span></code></pre></div><p>上面的示例中所有topic日志都收集到了同一个索引中，接下来我们将不同日志分流到不同的index</p>
<blockquote>
<p>都有哪些@metadata 元数据</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>cat <span style="color:#f92672">&gt;</span><span style="color:#e6db74">/data/e</span>lk<span style="color:#f92672">/</span>logstash<span style="color:#f92672">/</span>config<span style="color:#f92672">/</span>logstash<span style="color:#f92672">.</span>conf<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#39;EOF&#39;</span>
</span></span><span style="display:flex;"><span>input {
</span></span><span style="display:flex;"><span>  kafka {
</span></span><span style="display:flex;"><span>    bootstrap_servers <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;192.168.0.161:9092&#34;</span>   <span style="color:#75715e"># Kafka 集群地址，多个用逗号分隔</span>
</span></span><span style="display:flex;"><span>    topics            <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;app-log&#34;</span>,<span style="color:#e6db74">&#34;sys-log&#34;</span><span style="color:#f92672">]</span>  <span style="color:#75715e"># 消费的 topic</span>
</span></span><span style="display:flex;"><span>    group_id          <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;logstash-consumer&#34;</span>    <span style="color:#75715e"># 消费者组 ID</span>
</span></span><span style="display:flex;"><span>    auto_offset_reset <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;earliest&#34;</span>             <span style="color:#75715e"># 从头开始（第一次无 offset 时）</span>
</span></span><span style="display:flex;"><span>    codec             <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;json&#34;</span>                 <span style="color:#75715e"># 消息体是 JSON 就加，纯文本可删</span>
</span></span><span style="display:flex;"><span>    decorate_events   <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>                   <span style="color:#75715e"># 给事件加 @metadata[kafka] 字段（topic/partition/offset）</span>
</span></span><span style="display:flex;"><span>    consumer_threads <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">5</span>						<span style="color:#75715e"># 开启多线程消费kafka</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># --------- SASL/SCRAM 认证（与 Kafka 保持一致） ---------</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#security_protocol =&gt; &#34;SASL_PLAINTEXT&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#sasl_mechanism    =&gt; &#34;SCRAM-SHA-256&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#sasl_jaas_config  =&gt; &#39;org.apache.kafka.common.security.scram.ScramLoginModule required</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#                      username=&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#                      password=&#34;pytc@2026&#34;;&#39;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>output {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>@metadata<span style="color:#f92672">][</span>kafka<span style="color:#f92672">][</span>topic<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;app-log&#34;</span> {
</span></span><span style="display:flex;"><span>    elasticsearch {
</span></span><span style="display:flex;"><span>        hosts <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;http://192.168.0.114:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        index <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;app-log-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>@metadata<span style="color:#f92672">][</span>kafka<span style="color:#f92672">][</span>topic<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;sys-log&#34;</span> {
</span></span><span style="display:flex;"><span>    elasticsearch {
</span></span><span style="display:flex;"><span>        hosts <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;http://192.168.0.114:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        index <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;sys-log-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EOF</span>
</span></span></code></pre></div><p>通过自定义索引模版，并将<code>sys-log-*</code>和 <code>app-log-*</code> 索引关联该模版</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 如果 ES 7.x 也可用老接口 _template，这里用新版 _index_template</span>
</span></span><span style="display:flex;"><span>curl -X PUT localhost:9200/_index_template/host-logs-template <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -H <span style="color:#e6db74">&#39;Content-Type: application/json&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;template&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;settings&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;number_of_shards&#34;: 3,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;number_of_replicas&#34;: 0,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;refresh_interval&#34;: &#34;5s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;index_patterns&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;sys-log-*&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;app-log-*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/data/elk/logstash/config/logstash.conf<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">input {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  kafka {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    bootstrap_servers =&gt; &#34;192.168.0.161:9092&#34;   # Kafka 集群地址，多个用逗号分隔
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    topics            =&gt; [&#34;app-log&#34;,&#34;sys-log&#34;]  # 消费的 topic
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    group_id          =&gt; &#34;logstash-consumer&#34;    # 消费者组 ID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    auto_offset_reset =&gt; &#34;earliest&#34;             # 从头开始（第一次无 offset 时）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    codec             =&gt; &#34;json&#34;                 # 消息体是 JSON 就加，纯文本可删
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    decorate_events   =&gt; true                   # 给事件加 @metadata[kafka] 字段（topic/partition/offset）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    consumer_threads =&gt; 5						# 开启多线程消费kafka
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # --------- SASL/SCRAM 认证（与 Kafka 保持一致） ---------
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #security_protocol =&gt; &#34;SASL_PLAINTEXT&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #sasl_mechanism    =&gt; &#34;SCRAM-SHA-256&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #sasl_jaas_config  =&gt; &#39;org.apache.kafka.common.security.scram.ScramLoginModule required
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #                      username=&#34;test&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #                      password=&#34;pytc@2026&#34;;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  if [@metadata][kafka][topic] == &#34;app-log&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        hosts =&gt; [&#34;http://192.168.0.114:9200&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        index =&gt; &#34;app-log-%{+YYYY.MM.dd}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  if [@metadata][kafka][topic] == &#34;sys-log&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        hosts =&gt; [&#34;http://192.168.0.114:9200&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        index =&gt; &#34;sys-log-%{+YYYY.MM.dd}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-661fea39a83a2a82899e5e5ac2a6108c">logstash-filter</h1>
	<div class="lead">logstash之filter配置</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-10-10" class="text-body-secondary">Friday, October 10, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.19</code></p>
<p>logstash版本：<code>7.15.0</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>


</div>

<p><img src="https://www.elastic.co/guide/en/logstash/7.15/static/images/basic_logstash_pipeline.png" alt=""></p>
<h3 id="filter配置"><a href="https://www.elastic.co/docs/reference/logstash/versioned-plugins/filter-plugins" target="_blank">filter</a>配置</h3>
<p><strong><a href="https://www.elastic.co/docs/reference/logstash/versioned-plugins/v4-4-3-plugins-filters-grok" target="_blank">grok</a></strong> 将非结构化的日志格式化为结构化可查询的内容</p>
<p>apache 访问日志示例</p>
<pre tabindex="0"><code class="language-log" data-lang="log">39.156.66.10 - - [27/Jun/2023:20:04:38 +0800] &#34;GET /images/apache_pb.gif HTTP/1.1&#34; 200 2326 &#34;http://10.4.7.250/&#34; &#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36 Edg/113.0.1774.57&#34;
</code></pre><p>使用grok 对message执行解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>cat <span style="color:#f92672">&gt;</span><span style="color:#e6db74">/data/e</span>lk<span style="color:#f92672">/</span>logstash<span style="color:#f92672">/</span>config<span style="color:#f92672">/</span>logstash<span style="color:#f92672">.</span>conf<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#39;EOF&#39;</span>
</span></span><span style="display:flex;"><span>input {
</span></span><span style="display:flex;"><span>  kafka {
</span></span><span style="display:flex;"><span>    bootstrap_servers <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;192.168.0.161:9092&#34;</span>   <span style="color:#75715e"># Kafka 集群地址，多个用逗号分隔</span>
</span></span><span style="display:flex;"><span>    topics            <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;app-log&#34;</span>,<span style="color:#e6db74">&#34;sys-log&#34;</span><span style="color:#f92672">]</span>  <span style="color:#75715e"># 消费的 topic</span>
</span></span><span style="display:flex;"><span>    group_id          <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;logstash-consumer&#34;</span>    <span style="color:#75715e"># 消费者组 ID</span>
</span></span><span style="display:flex;"><span>    auto_offset_reset <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;earliest&#34;</span>             <span style="color:#75715e"># 从头开始（第一次无 offset 时）</span>
</span></span><span style="display:flex;"><span>    codec             <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;json&#34;</span>                 <span style="color:#75715e"># 消息体是 JSON 就加，纯文本可删</span>
</span></span><span style="display:flex;"><span>    decorate_events   <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>                   <span style="color:#75715e"># 给事件加 @metadata[kafka] 字段（topic/partition/offset）</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>filter {
</span></span><span style="display:flex;"><span>  grok {
</span></span><span style="display:flex;"><span>    match <span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;%{COMBINEDAPACHELOG}&#34;</span> }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  geoip {
</span></span><span style="display:flex;"><span>        source <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;clientip&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>@metadata<span style="color:#f92672">][</span>kafka<span style="color:#f92672">][</span>topic<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;app-log&#34;</span> {
</span></span><span style="display:flex;"><span>    elasticsearch {
</span></span><span style="display:flex;"><span>        hosts <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;http://192.168.0.114:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        index <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;app-log-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>@metadata<span style="color:#f92672">][</span>kafka<span style="color:#f92672">][</span>topic<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;sys-log&#34;</span> {
</span></span><span style="display:flex;"><span>    elasticsearch {
</span></span><span style="display:flex;"><span>        hosts <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;http://192.168.0.114:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        index <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;sys-log-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EOF</span>
</span></span></code></pre></div>
</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-b6ffb1adcf9657142fa7b1e7673d5360">收集nginx日志</h1>
	<div class="lead">使用filebeat收集nginx日志</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-12" class="text-body-secondary">Friday, September 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.29</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>


</div>

<pre class="mermaid">graph LR
A&gt;&#34;日志&#34;] 
A -.-&gt;|服务访问日志| B[&#34;/var/log/nginx/access.log&#34;]
A -.-&gt;|错误日志| c[&#34;/var/log/nginx/error.log&#34;]</pre>
<p><strong>配置nginx访问日志格式为json</strong></p>
<blockquote>
<p>位置 http</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span> <span style="color:#66d9ef">log_format</span> <span style="color:#e6db74">custom_json</span> <span style="color:#e6db74">escape=json</span> <span style="color:#e6db74">&#39;</span>{<span style="color:#f92672">&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#34;level&#34;:&#34;info&#34;,&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#34;ts&#34;:</span> <span style="color:#e6db74">&#34;</span>$time_iso8601&#34;,&#39;
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#34;message&#34;:</span> <span style="color:#e6db74">&#34;handled</span> <span style="color:#e6db74">request</span> $request_method $request_uri&#34;,&#39;
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#34;request&#34;:</span> {<span style="color:#f92672">&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;&#34;id&#34;:</span> <span style="color:#e6db74">&#34;</span>$http_x_request_id&#34;,&#39;
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;&#34;contry_code&#34;:</span> <span style="color:#e6db74">&#34;</span>$geoip_country_code&#34;,&#39;
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;&#34;remote_ip&#34;:</span> <span style="color:#e6db74">&#34;</span>$remote_addr&#34;,&#39;
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;&#34;remote_port&#34;:</span> <span style="color:#e6db74">&#34;</span>$remote_port&#34;,&#39;
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;&#34;protocol&#34;:</span> <span style="color:#e6db74">&#34;</span>$server_protocol&#34;,&#39;
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;&#34;method&#34;:</span> <span style="color:#e6db74">&#34;</span>$request_method&#34;,&#39;
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;&#34;host&#34;:</span> <span style="color:#e6db74">&#34;</span>$host&#34;,&#39;
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;&#34;uri&#34;:</span> <span style="color:#e6db74">&#34;</span>$request_uri&#34;,&#39;
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;&#34;headers&#34;:</span> {<span style="color:#f92672">&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;&#34;user-agent&#34;:</span> <span style="color:#e6db74">&#34;</span>$http_user_agent&#34;,&#39;
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;&#34;accept&#34;:</span> <span style="color:#e6db74">&#34;</span>$http_accept&#34;,&#39;
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;&#34;accept-encoding&#34;:</span> <span style="color:#e6db74">&#34;</span>$http_accept_encoding&#34;,&#39;
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;&#34;traceparent&#34;:</span> <span style="color:#e6db74">&#34;</span>$http_traceparent&#34;,&#39;
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;&#34;tracestate&#34;:</span> <span style="color:#e6db74">&#34;</span>$http_tracestate&#34;&#39;
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;</span><span style="color:#960050;background-color:#1e0010">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;</span><span style="color:#960050;background-color:#1e0010">}</span><span style="color:#e6db74">,&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#34;bytes_read&#34;:</span> $request_length,&#39;
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#34;duration_msecs&#34;:</span> $request_time,&#39;
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#34;size&#34;:</span> $bytes_sent,&#39;
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#34;status&#34;:</span> $status,&#39;
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#34;resp_headers&#34;:</span> {<span style="color:#f92672">&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#39;&#34;content_length&#34;:</span> <span style="color:#e6db74">&#34;</span>$sent_http_content_length&#34;,&#39;
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#39;&#34;content_type&#34;:</span> <span style="color:#e6db74">&#34;</span>$sent_http_content_type&#34;&#39;
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;</span><span style="color:#960050;background-color:#1e0010">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;</span><span style="color:#960050;background-color:#1e0010">}</span><span style="color:#e6db74">&#39;</span>; 
</span></span></code></pre></div>
  

  
  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>引用该格式日志</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="引用日志格式" aria-controls="tabs-01-01" aria-selected="true">
        引用日志格式
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="按照条件记录日志" aria-controls="tabs-01-02" aria-selected="false">
        按照条件记录日志
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="禁用日志" aria-controls="tabs-01-03" aria-selected="false">
        禁用日志
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">access_log</span>  <span style="color:#e6db74">/var/log/nginx/access.log</span>  <span style="color:#e6db74">custom_json</span>;
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <blockquote>
<p>语法 : <code>access_log /path/to/access.log custom_json if=&lt;condition&gt;;</code></p>
<p><code>loggable</code> 为true  是记录日志，2xx， 3xx 不记录日志</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">map</span> $status $loggable {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">~^[23]</span>  <span style="color:#ae81ff">0</span>;  <span style="color:#75715e"># Match 2xx and 3xx status codes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">default</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e"># Log everything else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">access_log</span> <span style="color:#e6db74">/var/log/nginx/access.log</span> <span style="color:#e6db74">combined</span> <span style="color:#e6db74">if=loggable</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">access_log</span> <span style="color:#66d9ef">off</span>;
</span></span></code></pre></div><p>或者</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">access_log</span> <span style="color:#e6db74">/dev/null</span>;
</span></span></code></pre></div>
    </div>
</div>

<p><strong>使用filbeat收集日志，关键参数 <code>json.keys_under_root: true</code></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">cat &gt;/data/elk/filebeat/filebeat.yml&lt;&lt;&#39;EOF&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">id</span>: <span style="color:#ae81ff">accesslog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">/var/log/nginx/access*</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;nginx-access&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 将message中json格式日志解析出来，如果没有改配置日志文件将以字符串格式保存在message中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># https://www.elastic.co/docs/reference/beats/filebeat/filebeat-input-log#filebeat-input-log-config-json</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">json.keys_under_root</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">id</span>: <span style="color:#ae81ff">errlog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">/var/log/nginx/error*</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include_lines</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;emerg&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;error&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;nginx-error&#34;</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.elasticsearch</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: [<span style="color:#e6db74">&#34;192.168.0.114:9200&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">indices</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">index</span>: <span style="color:#e6db74">&#34;nginx-access-%{+yyyy.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">contains</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tags</span>: <span style="color:#e6db74">&#34;nginx-access&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">index</span>: <span style="color:#e6db74">&#34;nginx-error-%{+yyyy.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">contains</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tags</span>: <span style="color:#e6db74">&#34;nginx-error&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 禁用索引生命周期管理，默认为true。在启用 setup.ilm.enabled 状态下setup.template 配置不会生效</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.ilm.enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加载索引模版，默认为true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置索引模板的名称，默认值为 filebeat-%{[agent.version]}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.name</span>: <span style="color:#e6db74">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置索引模板的匹配模式,默认值为 filebeat-%{[agent.version]}-*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.pattern</span>: <span style="color:#e6db74">&#34;nginx-*&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 覆盖已有的索引模板，默认值为false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.overwrite</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置索引模板属性</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.settings</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 设置索引分片数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">index.number_of_shards</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 设置索引副本数量，要求小于集群的数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">index.number_of_replicas</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">EOF</span>
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-756092d38de03bd5359baff0af077343">收集操作系统日志</h1>
	<div class="lead">使用filebeat收集linux操作系统日志</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-12" class="text-body-secondary">Friday, September 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>filebeat版本：<code>7.17.19</code></p>
<p>elasticsearch版本： <code>7.15.0</code></p>


</div>

<table>
  <thead>
      <tr>
          <th>日志</th>
          <th>路径</th>
          <th>日志格式</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>查看系统启动、硬件</td>
          <td><code>dmesg</code> 或 <code>/var/log/dmesg</code></td>
          <td></td>
      </tr>
      <tr>
          <td>系统日志，记录内核、服务、应用程序的非关键信息</td>
          <td><code>/var/log/messages</code></td>
          <td></td>
      </tr>
      <tr>
          <td>用户登录日志</td>
          <td><code>/var/log/secure</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>cron</code> 定时任务日志</td>
          <td><code>/var/log/cron</code></td>
          <td><code>Sep 17 15:58:01 mysql-uat02-s3 CROND[16632]: (root) CMD (/usr/bin/echo 1 &amp;&gt;/dev/null)</code></td>
      </tr>
      <tr>
          <td>审计日志</td>
          <td><code>/var/log/audit/audit.log</code></td>
          <td></td>
      </tr>
      <tr>
          <td>yum日志</td>
          <td><code>/var/log/yum.log</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>postfix</code> 或 <code>sendmail</code> 等邮件服务的日志</td>
          <td><code>/var/log/maillog</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>修改启动文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/data/elk/filebeat.sh<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export power_time=$(uptime -s)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export power_timestamp=$(date -d &#34;$power_time&#34; +%s)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/data/elk/filebeat/filebeat --environment systemd $@
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chmod +x /data/elk/filebeat.sh
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /etc/systemd/system/filebeat.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Filebeat sends log files to Logstash or directly to Elasticsearch.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://www.elastic.co/products/beats/filebeat
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;BEAT_LOG_OPTS=&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;BEAT_CONFIG_OPTS=-c /data/elk/filebeat/filebeat.yml&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;BEAT_PATH_OPTS=--path.home /data/elk/filebeat --path.config /data/elk/filebeat --path.data /data/elk/filebeat/data --path.logs /data/elk/filebeat/logs&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/elk/filebeat.sh $BEAT_LOG_OPTS $BEAT_CONFIG_OPTS $BEAT_PATH_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable filebeat --now
</span></span><span style="display:flex;"><span>systemctl status filebeat
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">cat &gt;/data/elk/filebeat/filebeat.yml &lt;&lt;&#39;EOF&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">filestream</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">osMessage</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;/var/log/messages&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>: [<span style="color:#e6db74">&#34;osMessage&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">exclude_lines</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^$&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">filestream</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">osDmesg</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;/var/log/dmesg&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>: [<span style="color:#e6db74">&#34;osDmesg&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">exclude_lines</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;^$&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">dissect</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tokenizer</span>: <span style="color:#e6db74">&#34;[%{dmesg_seconds}] %{msg}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_prefix</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">lang</span>: <span style="color:#ae81ff">javascript</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">id</span>: <span style="color:#ae81ff">dmesg_ts</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">power_timestamp</span>: <span style="color:#ae81ff">${power_timestamp}</span> <span style="color:#75715e"># 环境变量</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">source</span>: &gt;<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        var params = {};
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        function register(scriptParams) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          params = scriptParams;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        function process(event) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            // 操作系统启动时间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            var bootSec = parseFloat(event.Get(&#34;dmesg_seconds&#34;));
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            event.Put(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            	&#34;LOG_RECORD_TIME&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            	new Date(parseFloat(params.power_timestamp)*1000 + bootSec*1000).toISOString()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            	)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">rename</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">from</span>: <span style="color:#ae81ff">log.file.path</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">to</span>: <span style="color:#ae81ff">FILE_PATH</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">from</span>: <span style="color:#ae81ff">message</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">to</span>: <span style="color:#ae81ff">LOG</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.elasticsearch</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: [<span style="color:#e6db74">&#34;192.168.0.114:9200&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">indices</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">index</span>: <span style="color:#e6db74">&#34;zero-dew-linux-os-message-%{+yyyy.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">contains</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tags</span>: <span style="color:#e6db74">&#34;osMessage&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">index</span>: <span style="color:#e6db74">&#34;zero-dew-linux-os-dmesg-%{+yyyy.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">contains</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tags</span>: <span style="color:#e6db74">&#34;osDmesg&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.ilm.enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.name</span>: <span style="color:#e6db74">&#34;zero-dew&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.pattern</span>: <span style="color:#e6db74">&#34;zero-dew-*&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.overwrite</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.settings</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">index.number_of_shards</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">index.number_of_replicas</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">EOF</span>
</span></span></code></pre></div>
</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fdae7a6f05f611b1e476fea05daecc00">3.2 - grafana</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-ef8f9704dcbc2f6ec4e012b9ac9e891f">3.2.1 - quitstart</h1>
    <div class="lead">quitstart|grafana|prometheus</div>
	<h3 id="部署安装">部署安装</h3>


<div class="alert alert-primary" role="alert">


    验证通过版本7.5.17 、9.5.21、 10.4.14

</div>


  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="**docker方式安装grafanna**" aria-controls="tabs-01-00" aria-selected="true">
        <strong>docker方式安装grafanna</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="**rpm 包安装grafana**" aria-controls="tabs-01-01" aria-selected="false">
        <strong>rpm 包安装grafana</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker pull grafana/grafana:7.5.17
</span></span><span style="display:flex;"><span>docker pull grafana/grafana:9.5.21
</span></span><span style="display:flex;"><span>docker pull grafana/grafana:10.4.14
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker pull grafana/grafana-enterprise:7.5.17
</span></span><span style="display:flex;"><span>docker pull grafana/grafana-enterprise:9.5.21
</span></span><span style="display:flex;"><span>docker pull grafana/grafana-enterprise:10.4.14
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d -p 3000:3000 --name<span style="color:#f92672">=</span>grafana <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--volume /data/grafana:/var/lib/grafana <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>grafana/grafana-enterprise:10.4.14
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y https://dl.grafana.com/enterprise/release/grafana-enterprise-10.4.14-1.x86_64.rpm
</span></span><span style="display:flex;"><span>systemctl enable grafana-server.service --now
</span></span></code></pre></div>
    </div>
</div>

<h3 id="配置文件">配置文件</h3>


<div class="alert alert-primary" role="alert">


    可以通过修改配置文件<code>/etc/grafana/grafana.ini</code>或 环境变量的方式修改默认配置

</div>


<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75715e"># 运行在生产模式</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">app_mode</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">production</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 实例名</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">instance_name</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">${HOSTNAME}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[paths]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义存放临时文件、session、sqllit</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/var/lib/grafana</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 临时文件存放24h后删除</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">temp_data_lifetime</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">24h</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 日志文件</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">logs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/var/log/grafana</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 插件文件</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">plugins</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/var/lib/grafana/plugins</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  /usr/share/grafana/conf/provisioning 定义启动时加载配置，例如数据源、报表等</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">provisioning</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">conf/provisioning</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[server]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 支持（http, https, h2, socket)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">protocol</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 绑定的服务ip,默认所有</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">http_addr</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 绑定的服务port</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">http_port</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 服务绑定的域名</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">domain</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">localhost</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 当访问时与指定的域名不一致时，拒绝访问。默认关闭</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enforce_domain</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义服务的url</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">root_url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">%(protocol)s://%(domain)s:%(http_port)s/grafana</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从root_url 的配置路径中加载</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">serve_from_sub_path</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启gzip 用于节省带宽</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enable_gzip</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[database]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Either &#34;mysql&#34;, &#34;postgres&#34; or &#34;sqlite3&#34;, it&#39;s your choice</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">type</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">sqlite3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 数据库名</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">grafana</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 数据文件名称</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">path</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">grafana.db</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[security]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第一次启动时不创建用户</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">disable_initial_admin_creation</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 默认管理员用户</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">admin_user</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">admin</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 默认密码</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">admin_password</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">admin</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 默认邮件</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">admin_email</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">admin@localhost</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 签名秘钥，例如： 对密码 admin 字符串执行加盐后保存和验证，防止通过数据库看到原始密码</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">secret_key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">SW2YcwTIb9zpOOhoPsMm</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加密算法</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">encryption_provider</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">secretKey.v1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 允许将grafana报表嵌入到 &lt;frame&gt;, &lt;iframe&gt;, &lt;embed&gt; or &lt;object&gt; 等html中，默认不允许</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">allow_embedding</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[users]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">allow_sign_up</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 允许普通用户创建organizations</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">allow_org_create</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 自动为新用户分配一个组织</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto_assign_org</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 自动为新用户分配一个组织，该组织id为1，需要开启 auto_assign_org = true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto_assign_org_id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 自动为新用户分配一个角色</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto_assign_org_role</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">Viewer</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 不要求有邮箱认证</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">verify_email_enabled</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 默认主题为深色</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">default_theme</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">dark</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 默认语言改为简体中文</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">default_language</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">zh-Hans</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置首页</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">home_page</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 不允许 viewers 角色执行编辑动作</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viewers_can_edit</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 不允许 editors 角色执行管理动作</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">editors_can_admin</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[auth.anonymous]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启匿名访问,默认禁用</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enabled</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 匿名访问用户所属组织</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">org_name</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">Main Org.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 匿名用户拥有的角色</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">org_role</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">Viewer</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 对于为匿名用户隐藏版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">hide_version</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span></code></pre></div></details>

<h3 id="qa">QA</h3>
<p>&#x1f1f6;&#x1f1e6;<strong>如何让grafana默认中文显示</strong></p>
<p>修改配置文件<code>/etc/grafana/grafana.ini</code> 并重启grafana</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[users]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 默认语言改为简体中文</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">default_language</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">zh-Hans</span>
</span></span></code></pre></div><p>&#x1f1f6;&#x1f1e6;<strong>如何通过nginx代理访问grafana</strong></p>
  <table>
      <tr>
          <td>如图所示，是由于grafana跨域请求问题。可以在nginx代理中正确配置<td>
          <td><image src="/docs/prometheus/grafana/img/grafana.png"><td>
      </tr>
  </table>
<p>修改配置文件<code>/etc/grafana/grafana.ini</code> 并重启grafana</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[server]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 支持（http, https, h2, socket)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">protocol</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 绑定的服务ip,默认所有</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">http_addr</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 绑定的服务port</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">http_port</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 服务绑定的域名</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">domain</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">localhost</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 当访问时与指定的域名不一致时，拒绝访问。默认关闭</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enforce_domain</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义服务的url</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">root_url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">%(protocol)s://%(domain)s:%(http_port)s/grafana</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从root_url 的配置路径中加载</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">serve_from_sub_path</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启gzip 用于节省带宽</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enable_gzip</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span></code></pre></div><p>配置nginx代理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">root</span>         <span style="color:#e6db74">/usr/share/nginx/html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/grafana</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $remote_addr;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://172.16.0.3:3000</span>;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><p>&#x1f1f6;&#x1f1e6;<strong>如何将dashboard嵌入到html</strong></p>
<p>修改配置文件<code>/etc/grafana/grafana.ini</code> 并重启grafana</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[security]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 允许将grafana报表嵌入到 &lt;frame&gt;, &lt;iframe&gt;, &lt;embed&gt; or &lt;object&gt; 等html中，默认不允许</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">allow_embedding</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[auth.anonymous]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启匿名访问,默认禁用</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enabled</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 匿名访问用户所属组织</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">org_name</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">Main Org.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 匿名用户拥有的角色</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">org_role</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">Viewer</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 对于为匿名用户隐藏版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">hide_version</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span></code></pre></div><p>html嵌入验证</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- 单个图表嵌入语句--&gt;</span>
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://10.4.7.10:3000/d/a666a82f-47a1-4467-8e3f-c5d142f33927/new-dashboard?orgId=1&amp;viewPanel=1&#34;</span> <span style="color:#a6e22e">width</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;450&#34;</span> <span style="color:#a6e22e">height</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span> <span style="color:#a6e22e">frameborder</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- 整个Dashboard嵌入语句--&gt;</span>
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://10.4.7.10:3000/d/a666a82f-47a1-4467-8e3f-c5d142f33927/new-dashboard?orgId=1&#34;</span> <span style="color:#a6e22e">width</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100%&#34;</span> <span style="color:#a6e22e">height</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100%&#34;</span> <span style="color:#a6e22e">frameboader</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>&#x1f1f6;&#x1f1e6;<strong>如何在安装完毕grafana后配置好默认数据源</strong></p>
<p>修改配置文件<code>/etc/grafana/grafana.ini</code> 并重启grafana</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75715e"># 配置文件开启该配置</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[paths]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启该配置</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">provisioning</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">conf/provisioning</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75715e"># vi /usr/share/grafana/conf/provisioning/datasources/prometheus.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">apiVersion: 1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">datasources:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 第一个数据源</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">- name: prometheus01</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type: prometheus</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">access: proxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">url: http://localhost:9090/prom</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">editable: true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">isDefault: true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 第二个数据源 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">- name: prometheus02</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type: prometheus</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">access: proxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">url: http://127.0.0.1:9090/prom</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">editable: true</span>
</span></span></code></pre></div><p>&#x1f1f6;&#x1f1e6;<strong>如何在安装完毕grafana后配置好默认dashboard</strong></p>
<p>修改配置文件<code>/etc/grafana/grafana.ini</code> 并重启grafana</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75715e"># 配置文件开启该配置</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[paths]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启该配置</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">provisioning</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">conf/provisioning</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#  /usr/share/grafana/conf/provisioning/dashboards/dashboards.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>providers:
</span></span><span style="display:flex;"><span> - name: <span style="color:#e6db74">&#39;node-exporter&#39;</span>
</span></span><span style="display:flex;"><span>   orgId: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>   folder: <span style="color:#e6db74">&#39;k8s&#39;</span>
</span></span><span style="display:flex;"><span>   folderUid: <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>   type: file
</span></span><span style="display:flex;"><span>   options:
</span></span><span style="display:flex;"><span>     path: /var/lib/grafana/dashboards
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /var/lib/grafana/dashboards
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vi /var/lib/grafana/dashboards/node-exporter.json 文件格式为导出的报表格式</span>
</span></span></code></pre></div><p>&#x1f1f6;&#x1f1e6;<strong>如何将指定dashboard作为首页</strong></p>
<p>修改配置文件<code>/etc/grafana/grafana.ini</code> 并重启grafana</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[users]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置首页</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># http://prometheus.pytc.com:3000/grafana/d/rYdddlPWk/node-exporter-full?orgId=1&amp;refresh=1m</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">home_page</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/d/rYdddlPWk/node-exporter-full?orgId=1&amp;refresh=1m</span>
</span></span></code></pre></div><p>&#x1f1f6;&#x1f1e6;<strong>dashbaord 定义动态变量</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>label_values<span style="color:#f92672">(</span>promethues表达式,需要取值的label名称<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>举例：
</span></span><span style="display:flex;"><span>label_values<span style="color:#f92672">(</span>up<span style="color:#f92672">{</span>job<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;node-exporter&#34;</span><span style="color:#f92672">}</span>,instance<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>&#x1f1f6;&#x1f1e6;<strong>dashbaord 标签转换</strong></p>
<p>问题描述： 在标签中存在 <code>node01:9100</code> 的字样。而现在只需要保留 <code>node01</code></p>
<p>解决办法：Transform(转换) &ndash;&gt; <code>Rename by regex</code></p>
<p><strong>&#x1f1f6;&#x1f1e6;如何在grafana中安装插件</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 安装插件</span>
</span></span><span style="display:flex;"><span>grafana-cli plugins install agenty-flowcharting-panel
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看插件</span>
</span></span><span style="display:flex;"><span>grafana-cli plugins ls
</span></span></code></pre></div><p><a href="https://grafana.com/docs/grafana/latest/" target="_blank">Grafana OSS 和企业 |Grafana 文档</a></p>
<p><a href="https://grafana.com/grafana/download/9.0.0" target="_blank">Download </a></p>
<p><a href="https://grafana.com/docs/grafana/latest/cli/#plugins-commands" target="_blank">https://grafana.com/docs/grafana/latest/cli/#plugins-commands</a></p>
<p><a href="https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-http-basic-authentication/" target="_blank">Restricting Access with HTTP Basic Authentication | NGINX Documentation</a></p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cfdc302ad63fe20042c868c382ad0403">3.3 - prometheus</h1>
    
	<p>Prometheus是Go语言开发的开源监控和警报框架，遵循Apache 2.0许可协议。它起源于SoundCloud，并在2016年成为云原生计算基金会（CNCF）继Kubernetes之后的第二个项目。Prometheus不仅提供监控功能，还是一个时序<a href="https://db-engines.com/en/ranking" target="_blank">数据库</a>。</p>
<p>本示例架构图</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:9090</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/alert</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:9093</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/grafana</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:3000</span>;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><pre class="mermaid">flowchart LR
	A(nginx)
	B(prometheus)
	C(alertmanager)
	D(grafana)
	
	z&gt;浏览器] --&gt; A
	
	A -..-&gt;|/prom| B
	A -..-&gt;|/alert| C
	A -..-&gt;|/grafana| D
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style C fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style D fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5</pre>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-863efec26236baab21735f111ba52bf3">3.3.1 - install</h1>
    <div class="lead">安装|prometheus</div>
	<p><img src="https://prometheus.io/assets/architecture.png" alt="架构图"></p>
<h3 id="二进制安装">二进制安装</h3>
<ol>
<li>
<p>添加用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>useradd prometheus --system -s /sbin/nologin
</span></span></code></pre></div></li>
<li>
<p>挂载磁盘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建一个名为data的thinpool</span>
</span></span><span style="display:flex;"><span>vgName<span style="color:#f92672">=</span>centos
</span></span><span style="display:flex;"><span>lvcreate -L 100G --thinpool data <span style="color:#e6db74">${</span>vgName<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建名为prometheus的lv</span>
</span></span><span style="display:flex;"><span>lvcreate -n prometheus --virtualsize 500G --thinpool data <span style="color:#e6db74">${</span>vgName<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 格式化</span>
</span></span><span style="display:flex;"><span>mkfs.ext4 /dev/<span style="color:#e6db74">${</span>vgName<span style="color:#e6db74">}</span>/prometheus
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建prometheus目录</span>
</span></span><span style="display:flex;"><span>mkdir /data/prometheus -p
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开机自启动挂载</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>blkid /dev/mapper/<span style="color:#e6db74">${</span>vgName<span style="color:#e6db74">}</span>-prometheus|awk <span style="color:#e6db74">&#39;{print $2}&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74"> /data/prometheus ext4 defaults,noatime,nodelalloc 0 0&#34;</span>  &gt;&gt;/etc/fstab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 挂载验证</span>
</span></span><span style="display:flex;"><span>mount -a
</span></span><span style="display:flex;"><span>df -hT /data/prometheus/
</span></span></code></pre></div></li>
<li>
<p><a href="https://prometheus.io/docs/introduction/release-cycle/" target="_blank">下载长期支持版</a></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Release</th>
          <th style="text-align: left">Date</th>
          <th style="text-align: left">End of support</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Prometheus 2.37</td>
          <td style="text-align: left">2022-07-14</td>
          <td style="text-align: left">2023-07-31</td>
      </tr>
      <tr>
          <td style="text-align: left">Prometheus 2.45</td>
          <td style="text-align: left">2023-06-23</td>
          <td style="text-align: left">2024-07-31</td>
      </tr>
      <tr>
          <td style="text-align: left">Prometheus 2.53</td>
          <td style="text-align: left">2024-06-16</td>
          <td style="text-align: left">2025-07-31</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>version<span style="color:#f92672">=</span>2.53.0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/prometheus/prometheus/releases/download/v<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>/prometheus-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.linux-amd64.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf prometheus-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.linux-amd64.tar.gz -C /data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /data/prometheus/<span style="color:#f92672">{</span>bin,conf,conf/rules,data,log<span style="color:#f92672">}</span> -p
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cp /data/prometheus-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.linux-amd64/prometheus /data/prometheus/bin/
</span></span><span style="display:flex;"><span>cp /data/prometheus-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.linux-amd64/promtool /data/prometheus/bin/
</span></span><span style="display:flex;"><span>cp /data/prometheus-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.linux-amd64/prometheus.yml /data/prometheus/conf
</span></span><span style="display:flex;"><span>cp -a /data/prometheus-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.linux-amd64/console* /data/prometheus/conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown -R prometheus:prometheus /data/prometheus*
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/data/prometheus
</span></span><span style="display:flex;"><span>├── bin
</span></span><span style="display:flex;"><span>│   ├── prometheus
</span></span><span style="display:flex;"><span>│   └── promtool
</span></span><span style="display:flex;"><span>├── conf
</span></span><span style="display:flex;"><span>│   └── prometheus.yml
</span></span><span style="display:flex;"><span>├── data
</span></span><span style="display:flex;"><span>└── log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span> directories, <span style="color:#ae81ff">3</span> files
</span></span></code></pre></div></li>
<li>
<p>通过systemd管理服务</p>
<blockquote>
<p><sub><code>--storage.tsdb.retention.time 替代了--storage.tsdb.retention</code></sub></p>
<p><sub>提供远程写入到prometheus的功能:<br>老版本<code> --enable-feature=remote-write-receiver</code><br>新版本 <code>--web.enable-remote-write-receiver</code></sub></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/prometheus.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=promethues service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStartPre=/data/prometheus/bin/promtool check config /data/prometheus/conf/prometheus.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/prometheus/bin/prometheus \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=0.0.0.0:9090 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config.file=/data/prometheus/conf/prometheus.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.read-timeout=5m \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.max-connections=10 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--storage.tsdb.retention.time=15d \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--storage.tsdb.retention.size=100GB \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--storage.tsdb.path=/data/prometheus/data \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--query.max-concurrency=20 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--query.timeout=2m \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.console.templates=/data/prometheus/conf/consoles \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.console.libraries=/data/prometheus/conf/console_libraries \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.enable-lifecycle \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.enable-admin-api \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.external-url=/prom
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/usr/bin/curl -s -X POST 127.0.0.1:9090/-/reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable prometheus --now  
</span></span><span style="display:flex;"><span>systemctl status prometheus
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cbf04b1f9c33b34119d6b5481bfb28c0">3.3.2 - operator</h1>
    <div class="lead">安装|prometheus</div>
	<h3 id="基于prometheus-operator">基于<a href="https://github.com/prometheus-operator/prometheus-operator" target="_blank">prometheus-operator</a></h3>
<p>版本矩阵</p>
<table>
  <thead>
      <tr>
          <th>kube-prometheus stack</th>
          <th>Kubernetes 1.21</th>
          <th>Kubernetes 1.22</th>
          <th>Kubernetes 1.23</th>
          <th>Kubernetes 1.24</th>
          <th>Kubernetes 1.25</th>
          <th>Kubernetes 1.26</th>
          <th>Kubernetes 1.27</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.9" target="_blank"><code>release-0.9</code></a></td>
          <td>✔</td>
          <td>✔</td>
          <td>✗</td>
          <td>✗</td>
          <td>✗</td>
          <td>x</td>
          <td>x</td>
      </tr>
      <tr>
          <td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.10" target="_blank"><code>release-0.10</code></a></td>
          <td>✗</td>
          <td>✔</td>
          <td>✔</td>
          <td>✗</td>
          <td>✗</td>
          <td>x</td>
          <td>x</td>
      </tr>
      <tr>
          <td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.11" target="_blank"><code>release-0.11</code></a></td>
          <td>✗</td>
          <td>✗</td>
          <td>✔</td>
          <td>✔</td>
          <td>✗</td>
          <td>x</td>
          <td>x</td>
      </tr>
      <tr>
          <td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.12" target="_blank"><code>release-0.12</code></a></td>
          <td>✗</td>
          <td>✗</td>
          <td>✗</td>
          <td>✔</td>
          <td>✔</td>
          <td>x</td>
          <td>x</td>
      </tr>
      <tr>
          <td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/main" target="_blank"><code>main</code></a></td>
          <td>✗</td>
          <td>✗</td>
          <td>✗</td>
          <td>✗</td>
          <td>x</td>
          <td>✔</td>
          <td>✔</td>
      </tr>
  </tbody>
</table>
<ol>
<li>
<p>下载安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/prometheus-operator/kube-prometheus.git
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd kube-prometheus/
</span></span><span style="display:flex;"><span>git checkout -b release-0.10
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Create the namespace and CRDs, and then wait for them to be availble before creating the remaining resources</span>
</span></span><span style="display:flex;"><span>kubectl create -f manifests/setup
</span></span></code></pre></div><p>创建monitoring 名称空间，并创建以下crd</p>
<ul>
<li>
<p>alertmanagerconfigs.monitoring.coreos.com</p>
</li>
<li>
<p>alertmanagers.monitoring.coreos.com</p>
</li>
<li>
<p>podmonitors.monitoring.coreos.com</p>
</li>
<li>
<p>probes.monitoring.coreos.com</p>
</li>
<li>
<p>prometheuses.monitoring.coreos.com</p>
</li>
<li>
<p>prometheusagents.monitoring.coreos.com</p>
</li>
<li>
<p>prometheusrules.monitoring.coreos.com</p>
</li>
<li>
<p>scrapeconfigs.monitoring.coreos.com</p>
</li>
<li>
<p>servicemonitors.monitoring.coreos.com</p>
</li>
<li>
<p>thanosrulers.monitoring.coreos.com</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Wait until the &#34;servicemonitors&#34; CRD is created. The message &#34;No resources found&#34; means success in this context.until kubectl get servicemonitors --all-namespaces ; do date; sleep 1; echo &#34;&#34;; done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl create -f manifests/
</span></span></code></pre></div></li>
<li>
<p>验证</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl --namespace monitoring port-forward svc/prometheus-k8s <span style="color:#ae81ff">9090</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl --namespace monitoring port-forward svc/alertmanager-main <span style="color:#ae81ff">9093</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl --namespace monitoring port-forward svc/grafana <span style="color:#ae81ff">3000</span>
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8dd2a702f5ca9e0b663fa00c19f6ce84">3.3.3 - config</h1>
    <div class="lead">promethes.yaml|prometheus</div>
	<p>配置文件全景图</p>
<pre class="mermaid">  graph LR
  A&gt;prometheus.yml] ==&gt; |全局配置|B(&lt;a href=#global&gt;global&lt;/a&gt;)
  A ==&gt; |对接alert|C(&lt;a href=&#39;#alterings&#39;&gt;alterings&lt;/a&gt;)
  A ==&gt; |评估/告警规则|D(&lt;a href=&#39;#rule_files&#39;&gt;rule_files&lt;/a&gt;)
  A ==&gt; |指标抓取|E(&lt;a href=&#39;#scrape_configs&#39;&gt;scrape_configs&lt;/a&gt;)
  A ==&gt; |外部存储|F(remote_write/remote_read)
  E -..-&gt; |静态配置|E1(&lt;a href=#static_configs&gt;static_configs&lt;/a&gt;)
  E -..-&gt; |文件自动发现|E2(&lt;a href=#file_sd_configs&gt;file_sd_configs&lt;/a&gt;)
  E -..-&gt; |consul自动发现|E3(&lt;a href=#consul_sd_configs&gt;consul_sd_configs&lt;/a&gt;)
  E -..-&gt; |kubernetes自动发现|E4(&lt;a href=&#39;#kubernetes_sd_configs&#39;&gt;kubernetes_sd_configs&lt;/a&gt;)
  E -..-&gt; |dns自动发现|E5(&lt;a href=&#39;#dns_sd_configs&#39;&gt;dns_sd_configs&lt;/a&gt;)
  E -..-&gt; |基于单个job重新打标,在指标采集之前完成|E6(&lt;a href=&#39;#relabel_configs&#39;&gt;relabel_configs&lt;/a&gt;)
  E -..-&gt; |基于单个metrics重新打标,在指标采集之后数据存储之前完成|E7(metric_relabel_configs)
  E -..-&gt; |发送给alertmanger时重新打标|E8(alert_relabel_configs)
  E -..-&gt; |远程写入样本时重新打标|E9(write_relabel_configs)</pre>
<h3 id="global"><span id='global'><strong>global</strong></span></h3>
<p><em>配置示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1m 抓取一次target</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 10s 抓取不到超时</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">20s</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1m 评估一次rules</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">evaluation_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 全局标签(在每一个时间序列上添加zoon=shanghai 的标签)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">center</span>: <span style="color:#e6db74">&#34;shanghai&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#e6db74">&#34;staging&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 记录promql 的查询记录</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">query_log_file</span>: <span style="color:#e6db74">&#34;/data/prometheus/log/promql&#34;</span>
</span></span></code></pre></div><h3 id="alterings"><span id='alterings'><strong>alterings</strong></span></h3>
<p><em>配置示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1m 抓取一次target</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 10s 抓取不到超时</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">20s</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1m 评估一次rules</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">evaluation_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 全局标签(在每一个时间序列上添加zoon=shanghai 的标签)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">center</span>: <span style="color:#e6db74">&#34;shanghai&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#e6db74">&#34;staging&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 记录promql 的查询记录</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">query_log_file</span>: <span style="color:#e6db74">&#34;/data/prometheus/log/promql&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">alerting</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">alertmanagers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path_prefix</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targets</span>: <span style="color:#75715e"># 通常情况 这三个节点是一个集群</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;alert1:9093&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;alert2:9093&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;alert3:9093&#39;</span>
</span></span></code></pre></div><h3 id="rule_"><span id='rule_files'><strong>rule_files</strong></span></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1m 抓取一次target</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 10s 抓取不到超时</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">20s</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1m 评估一次rules</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">evaluation_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 全局标签(在每一个时间序列上添加zoon=shanghai 的标签)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">center</span>: <span style="color:#e6db74">&#34;shanghai&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#e6db74">&#34;staging&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 记录promql 的查询记录</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">query_log_file</span>: <span style="color:#e6db74">&#34;/data/prometheus/log/promql&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">alerting</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">alertmanagers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path_prefix</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targets</span>: <span style="color:#75715e"># 通常情况 这三个节点是一个集群</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;alert1:9093&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;alert2:9093&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;alert3:9093&#39;</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span><span style="color:#f92672">rule_files</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在prometheus.yml主配置文件加载 record规则 和 alert规则</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 相对于主配置文件</span>
</span></span><span style="display:flex;"><span>- <span style="color:#e6db74">&#34;./rules/*.yaml&#34;</span>
</span></span></code></pre></div>

  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="记录规则" aria-controls="tabs-00-00" aria-selected="true">
        记录规则
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="告警规则" aria-controls="tabs-00-01" aria-selected="false">
        告警规则
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <p><em>语法</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">30s        </span> <span style="color:#75715e"># 规则评估周期, 省略时使用全局配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limit</span>: <span style="color:#ae81ff">0</span>            <span style="color:#75715e"># 对时间序列的限制，0表示不做限制</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">query_offset</span>: <span style="color:#ae81ff">0</span>       <span style="color:#75715e"># 评估时的时间偏移量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:             <span style="color:#75715e"># 添加或修改标签</span>
</span></span><span style="display:flex;"><span>      -  <span style="color:#f92672">&lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;labelvalue&gt; </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">record</span>: <span style="color:#ae81ff">code:prometheus_http_requests_total:sum</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">sum by (code) (prometheus_http_requests_total)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:             <span style="color:#75715e"># 添加或修改标签</span>
</span></span><span style="display:flex;"><span>        -  <span style="color:#f92672">&lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;labelvalue&gt; </span>
</span></span></code></pre></div><p><em>示例</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">#./rules/record.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">node_cpu</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 命名规范 https://prometheus.io/docs/practices/rules/#recording-rules</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">record: instance:node_cpu_seconds:avg_rate5m  # record</span>: <span style="color:#ae81ff">level:metric:operation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">avg by (job,instance,mode) (rate(node_cpu_seconds_total[5m]))</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">record</span>: <span style="color:#ae81ff">instance:node_cpu_seconds:avg_rate5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">avg by (job,instance,mode) (rate(node_cpu_seconds_total[5m]))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">metric_type</span>: <span style="color:#e6db74">&#34;aggration&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/data/prometheus/bin/promtool check rules  ./rules/record.yaml
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="alert alert-primary" role="alert">
<pre><code>语法：相比record 规则，labels 支持&lt;strong&gt;字符串模版&lt;/strong&gt;
</code></pre>
</div>
<p><em>语法</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">30s        </span> <span style="color:#75715e"># 规则评估周期, 省略时使用全局配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limit</span>: <span style="color:#ae81ff">0</span>            <span style="color:#75715e"># 对时间序列的限制，0表示不做限制</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">query_offset</span>: <span style="color:#ae81ff">0</span>       <span style="color:#75715e"># 评估时的时间偏移量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:             <span style="color:#75715e"># 添加或修改标签</span>
</span></span><span style="display:flex;"><span>      -  <span style="color:#f92672">&lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;labelvalue&gt; </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">nodeCpuHight</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">100</span> * <span style="color:#ae81ff">(1 - avg(rate(node_cpu_seconds_total{mode=&#34;idle&#34;}[5m])) by(instance)) &gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">for</span>: <span style="color:#ae81ff">2m          </span> <span style="color:#75715e"># 达到expr 条件并持续2m,则告警从pending 转为firing</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">0s  </span> <span style="color:#75715e"># 不满足expr 条件后，告警继续保持的时长</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:           <span style="color:#75715e"># 添加或修改标签</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">&lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;tmpl_string&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">&lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;tmpl_string&gt; </span>
</span></span></code></pre></div><p><em>示例</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">#./rules/alert.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">node_cpu</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">nodeCpuHigh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">100</span> * <span style="color:#ae81ff">(1 - avg(rate(node_cpu_seconds_total{mode=&#34;idle&#34;}[5m])) by(instance)) &gt;85</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m </span> <span style="color:#75715e"># for 参数可省略。Alerting rules without the for clause will become active on the first evaluation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">WARNING</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机【Instance {{ $labels.instance }}】cpu 使用率高&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: {{<span style="color:#ae81ff">$labels.instance}} of job {{ $labels.job }} cpu 使用率超过85%,当前值{{ $value |printf &#34;%.1f&#34;}}%</span>
</span></span></code></pre></div>
    </div>
</div>

<h3 id="scrape_configs"><span id='scrape_configs'>scrape_configs</span></h3>

  

  

  

  



<ul class="nav nav-tabs justify-content-end" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="<span id='static_configs'>**static_configs**</span>" aria-controls="tabs-01-00" aria-selected="true">
        <span id='static_configs'><strong>static_configs</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="<span id='file_sd_configs'>**file_sd_configs**</span>" aria-controls="tabs-01-01" aria-selected="false">
        <span id='file_sd_configs'><strong>file_sd_configs</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="<span id='consul_sd_configs'>**consul_sd_configs**</span>" aria-controls="tabs-01-02" aria-selected="false">
        <span id='consul_sd_configs'><strong>consul_sd_configs</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="<span id='kubernetes_sd_configs'>**kubernetes_sd_configs**</span>" aria-controls="tabs-01-03" aria-selected="false">
        <span id='kubernetes_sd_configs'><strong>kubernetes_sd_configs</strong></span>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <p><em>示例</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">prometheus</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">10s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">targets</span>: [<span style="color:#e6db74">&#39;localhost:8080&#39;</span>,<span style="color:#e6db74">&#39;localhost:8081&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">env</span>: <span style="color:#e6db74">&#39;production&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;node&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">localhost:9100</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 只收集指定的指标</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">collect[]</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">cpu</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">meminfo</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">diskstats</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">netdev</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">filefd</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">filesystem</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">xfs</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">systemd</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># curl -g -X GET http://127.0.0.1:9100/metrcs?collect[]=cpu</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <p><em>示例</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">prometheus</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">10s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">file_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">files</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">file/*.yml</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">refresh_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span><span style="color:#75715e">#cat file/file_sd.yaml </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#ae81ff">172.29.1.11</span>:<span style="color:#ae81ff">9090</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">prometheus</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">job</span>: <span style="color:#ae81ff">primetheus</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <p><em>示例</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;node&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">consul_sd_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">server</span>: <span style="color:#e6db74">&#34;47.113.100.31:8500&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;nodes&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">refresh_interval</span>: <span style="color:#ae81ff">2m</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <p><em>示例</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kube-apiserver</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://127.0.0.1:6443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.pem</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/cert.pem</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/cert.key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">role</span>: <span style="color:#ae81ff">endpoints  </span> <span style="color:#75715e"># 如果prometheus部署在集群中，则使用endpoints,如果部署在集群外，则使用service或node</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">source_labels</span>:
</span></span><span style="display:flex;"><span>      [
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">__meta_kubernetes_namespace,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">__meta_kubernetes_service_name,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">__meta_kubernetes_endpoint_port_name,</span>
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">default;kubernetes;https</span>
</span></span></code></pre></div>
    </div>
</div>

<h3 id="relabel_"><span id='relabel_configs'><strong>relabel_configs</strong></span></h3>
<blockquote>
<p><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config" target="_blank">relabel_configs</a> 用于在指标抓取前对标签进行预处理。应用场景包括丢弃指定指标、替换抓取指标的端口、新增或修改label。</p>
</blockquote>
<p>语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#39; &lt;labelname&gt; [, ...] &#39;</span>]      	<span style="color:#75715e"># 定义预处理的标签列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">separator</span>: <span style="color:#ae81ff">&lt;string&gt; | default = ;       		# 定义source_labels 中的标签以哪个字符串作为分隔符</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">&lt;regex&gt; | default = (.*)         		# 对source_labels中的标签按照指定正则表达式匹配</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">&lt;relabel_action&gt; | default = replace  	# 正则匹配到的部分进行处理动作</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">&lt;labelname&gt;           			# 指明匹配到的标签计划被哪标签替换。对于replace来说标签是必须的 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">&lt;string&gt; | default = $1      		# relace中定义替换后 **值** 应该替换为什么，支持正则向后引用</span>
</span></span></code></pre></div><p><strong>source_labels 和 target_label</strong></p>
<blockquote>
<p>可以利用指标标签以及prometheus、consul、kubernetes等特有标签作为 <code>source_labels</code> 和 <code>target_labels</code></p>
</blockquote>
<p>例如prometheus 可以识别的标签:</p>
<table>
  <thead>
      <tr>
          <th>标签名</th>
          <th>标签值</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>__scheme__</code></td>
          <td>http 或 https</td>
      </tr>
      <tr>
          <td><code>__address__</code></td>
          <td>ip:port  instance标签会使用该值</td>
      </tr>
      <tr>
          <td><code>__metrics_path__</code></td>
          <td>默认为 /metrics</td>
      </tr>
      <tr>
          <td><code>__param__</code></td>
          <td>url 中传递过来的参数</td>
      </tr>
      <tr>
          <td><code>__scrape_interval__</code></td>
          <td>抓取周期</td>
      </tr>
      <tr>
          <td><code>__name__</code></td>
          <td>指标名称</td>
      </tr>
      <tr>
          <td><code>__tmp__</code></td>
          <td>在打标阶段需要存储临时标签</td>
      </tr>
  </tbody>
</table>
<p><strong>action</strong></p>
<blockquote>
<p>动作包括：replace、lowercase、uppercase、keep、drop、keepequal、dropequal、hashmod、labelmap、labeldrop、labelkeep</p>
</blockquote>
<p><strong>示例</strong>

  
  

  

  


  

  

  
<ul class="nav nav-tabs justify-content-end" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          aria-controls="tabs-02-00" aria-selected="false">
        <strong>action</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="<span id='static_configs'>**新增标签**</span>" aria-controls="tabs-02-01" aria-selected="true">
        <span id='static_configs'><strong>新增标签</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-02" role="tab"
          data-td-tp-persist="<span id='file_sd_configs'>**replace**</span>" aria-controls="tabs-02-02" aria-selected="false">
        <span id='file_sd_configs'><strong>replace</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-03" role="tab"
          data-td-tp-persist="<span id='consul_sd_configs'>**drop**</span>" aria-controls="tabs-02-03" aria-selected="false">
        <span id='consul_sd_configs'><strong>drop</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-04" role="tab"
          data-td-tp-persist="<span id='kubernetes_sd_configs'>**keep**</span>" aria-controls="tabs-02-04" aria-selected="false">
        <span id='kubernetes_sd_configs'><strong>keep</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-05-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-05" role="tab"
          data-td-tp-persist="<span id='dns_sd_configs'>**labeldrop**</span>" aria-controls="tabs-02-05" aria-selected="false">
        <span id='dns_sd_configs'><strong>labeldrop</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-06-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-06" role="tab"
          data-td-tp-persist="<span id='dns_sd_configs'>**labelkeep**</span>" aria-controls="tabs-02-06" aria-selected="false">
        <span id='dns_sd_configs'><strong>labelkeep</strong></span>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:  <span style="color:#75715e"># 添加固定标签,给当前job添加一个env=&#34;pro&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">pro</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">env</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-02" role="tabpanel" aria-labelled-by="tabs-02-02-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#34;__address__&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">separator</span>: <span style="color:#e6db74">&#34;;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;(^[0-9].*):[0-9]+&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1&#34;</span>   <span style="color:#75715e"># 新的标签值</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target_label</span>: <span style="color:#e6db74">&#34;IP&#34;</span>  <span style="color:#75715e"># 新的标签名称</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-03" role="tabpanel" aria-labelled-by="tabs-02-03-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#34;__name__&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">separator</span>: <span style="color:#e6db74">&#34;;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;go_gc_duration_seconds&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">drop </span> <span style="color:#75715e"># 删除匹配的metrics</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-04" role="tabpanel" aria-labelled-by="tabs-02-04-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:  
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#34;__name__&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">separator</span>: <span style="color:#e6db74">&#34;;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;^(node|pod|kube|mysql|redis|mongo)&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep </span> <span style="color:#75715e"># 保存匹配的metrics</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-05" role="tabpanel" aria-labelled-by="tabs-02-05-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;job&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labeldrop</span> <span style="color:#75715e"># 删除了job 标签</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-06" role="tabpanel" aria-labelled-by="tabs-02-06-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;.*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelkeep</span>
</span></span></code></pre></div>
    </div>
</div>
</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-05ff6cc9cc00a9f65de4bbb0f9434aeb">3.3.4 - kubernetes_sd_configs</h1>
    <div class="lead">kubernetes_sd_configs|prometheus</div>
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># A scrape configuration for running Prometheus on a Kubernetes cluster.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This uses separate scrape configs for cluster components (i.e. API server, node)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># and services to allow each to use different authentication configs.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kubernetes labels will be added as Prometheus labels on metrics via the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># `labelmap` relabeling action.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If you are using Kubernetes 1.7.2 or earlier, please take note of the comments</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for the kubernetes-cadvisor job; you will need to edit or remove this job.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Keep at most 100 sets of details of targets dropped by relabeling.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This information is used to display in the UI for troubleshooting.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">keep_dropped_targets</span>: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Scrape config for API servers.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kubernetes exposes API servers as endpoints to the default/kubernetes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># service so this uses `endpoints` role and uses relabelling to only keep</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># the endpoints associated with the default/kubernetes service using the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># default named port `https`. This works for single API server deployments as</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># well as HA API server deployments.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-apiservers&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Default to scraping over https. If required, just disable this or change to</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># `http`.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># This TLS &amp; authorization config is used to connect to the actual scrape</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># endpoints for cluster components. This is separate to discovery auth</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># configuration because discovery &amp; scraping are two separate concerns in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Prometheus. The discovery auth config is automatic if Prometheus runs inside</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># the cluster. Otherwise, more config options have to be provided within the</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># &lt;kubernetes_sd_config&gt;.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># If your node certificates are self-signed or use a different CA to the</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># master CA, then disable certificate verification below. Note that</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># certificate verification is an integral part of a secure infrastructure</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># so this should only be disabled in a controlled environment. You can</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># disable certificate verification by uncommenting the line below.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># insecure_skip_verify: true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">credentials_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Keep only the default/kubernetes service endpoints for the https port. This</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># will add targets for each API server which Kubernetes adds an endpoint to</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># the default/kubernetes service.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>:
</span></span><span style="display:flex;"><span>          [
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">__meta_kubernetes_namespace,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">__meta_kubernetes_service_name,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">__meta_kubernetes_endpoint_port_name,</span>
</span></span><span style="display:flex;"><span>          ]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">default;kubernetes;https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Scrape config for nodes (kubelet).</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-nodes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Default to scraping over https. If required, just disable this or change to</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># `http`.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># This TLS &amp; authorization config is used to connect to the actual scrape</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># endpoints for cluster components. This is separate to discovery auth</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># configuration because discovery &amp; scraping are two separate concerns in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Prometheus. The discovery auth config is automatic if Prometheus runs inside</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># the cluster. Otherwise, more config options have to be provided within the</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># &lt;kubernetes_sd_config&gt;.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># If your node certificates are self-signed or use a different CA to the</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># master CA, then disable certificate verification below. Note that</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># certificate verification is an integral part of a secure infrastructure</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># so this should only be disabled in a controlled environment. You can</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># disable certificate verification by uncommenting the line below.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># insecure_skip_verify: true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">credentials_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_node_label_(.+)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Scrape config for Kubelet cAdvisor.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># This is required for Kubernetes 1.7.3 and later, where cAdvisor metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># (those whose names begin with &#39;container_&#39;) have been removed from the</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Kubelet metrics endpoint.  This job scrapes the cAdvisor endpoint to</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># retrieve those metrics.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># In Kubernetes 1.7.0-1.7.2, these metrics are only exposed on the cAdvisor</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># HTTP endpoint; use the &#34;/metrics&#34; endpoint on the 4194 port of nodes. In</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># that case (and ensure cAdvisor&#39;s HTTP server hasn&#39;t been disabled with the</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># --cadvisor-port=0 Kubelet flag).</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># This job is not necessary and should be removed in Kubernetes 1.6 and</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># earlier versions, or it will cause the metrics to be scraped twice.</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-cadvisor&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Default to scraping over https. If required, just disable this or change to</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># `http`.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Starting Kubernetes 1.7.3 the cAdvisor metrics are under /metrics/cadvisor.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Kubernetes CIS Benchmark recommends against enabling the insecure HTTP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># servers of Kubernetes, therefore the cAdvisor metrics on the secure handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># are used.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics/cadvisor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># This TLS &amp; authorization config is used to connect to the actual scrape</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># endpoints for cluster components. This is separate to discovery auth</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># configuration because discovery &amp; scraping are two separate concerns in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Prometheus. The discovery auth config is automatic if Prometheus runs inside</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># the cluster. Otherwise, more config options have to be provided within the</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># &lt;kubernetes_sd_config&gt;.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># If your node certificates are self-signed or use a different CA to the</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># master CA, then disable certificate verification below. Note that</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># certificate verification is an integral part of a secure infrastructure</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># so this should only be disabled in a controlled environment. You can</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># disable certificate verification by uncommenting the line below.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># insecure_skip_verify: true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">credentials_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_node_label_(.+)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Example scrape config for service endpoints.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The relabeling allows the actual service scrape endpoint to be configured</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># for all or only some endpoints.</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-service-endpoints&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to scrape only endpoints that have</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># &#34;example.io/should_be_scraped = true&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_service_annotation_example_io_should_be_scraped]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: keep</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to customize metric path based on endpoints</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># &#34;example.io/metric_path = &lt;metric path&gt;&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_service_annotation_example_io_metric_path]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: replace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    target_label: __metrics_path__</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: (.+)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to scrape only single, desired port for the service based</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># on endpoints &#34;example.io/scrape_port = &lt;port&gt;&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__address__, __meta_kubernetes_service_annotation_example_io_scrape_port]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: replace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: ([^:]+)(?::\d+)?;(\d+)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    replacement: $1:$2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    target_label: __address__</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to configure scrape scheme for all service scrape targets</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># based on endpoints &#34;example.io/scrape_scheme = &lt;scheme&gt;&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_service_annotation_example_io_scrape_scheme]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: replace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    target_label: __scheme__</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: (https?)</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_service_label_(.+)</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_namespace]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">namespace</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_service_name]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Example scrape config for probing services via the Blackbox Exporter.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The relabeling allows the actual service scrape endpoint to be configured</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># for all or only some services.</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-services&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/probe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">module</span>: [<span style="color:#ae81ff">http_2xx]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to probe only some services that have &#34;example.io/should_be_probed = true&#34; annotation</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_service_annotation_example_io_should_be_probed]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: keep</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: true</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__param_target</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">blackbox-exporter.example.com:9115</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__param_target]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">instance</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_service_label_(.+)</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_namespace]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">namespace</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_service_name]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Example scrape config for probing ingresses via the Blackbox Exporter.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The relabeling allows the actual ingress scrape endpoint to be configured</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># for all or only some services.</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-ingresses&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/probe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">module</span>: [<span style="color:#ae81ff">http_2xx]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">ingress</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to probe only some ingresses that have &#34;example.io/should_be_probed = true&#34; annotation</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_ingress_annotation_example_io_should_be_probed]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: keep</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: true</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>:
</span></span><span style="display:flex;"><span>          [
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">__meta_kubernetes_ingress_scheme,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">__address__,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">__meta_kubernetes_ingress_path,</span>
</span></span><span style="display:flex;"><span>          ]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.+);(.+);(.+)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">${1}://${2}${3}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__param_target</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">blackbox-exporter.example.com:9115</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__param_target]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">instance</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_ingress_label_(.+)</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_namespace]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">namespace</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_ingress_name]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">ingress</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Example scrape config for pods</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The relabeling allows the actual pod scrape to be configured</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># for all the declared ports (or port-free target if none is declared)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># or only some ports.</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-pods&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">pod</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to scrape only pods that have</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># &#34;example.io/should_be_scraped = true&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_pod_annotation_example_io_should_be_scraped]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: keep</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to customize metric path based on pod</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># &#34;example.io/metric_path = &lt;metric path&gt;&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_pod_annotation_example_io_metric_path]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: replace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    target_label: __metrics_path__</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: (.+)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to scrape only single, desired port for the pod</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># based on pod &#34;example.io/scrape_port = &lt;port&gt;&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__address__, __meta_kubernetes_pod_annotation_example_io_scrape_port]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: replace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: ([^:]+)(?::\d+)?;(\d+)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    replacement: $1:$2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    target_label: __address__</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_pod_label_(.+)</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_namespace]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">namespace</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_pod_name]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">pod</span>
</span></span></code></pre></div><p><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config" target="_blank"><span id='kubernetes_sd_configs'><strong>kubernetes_sd_configs</strong></span></a></p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl --cacert /etc/kubernetes/pki/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert /etc/kubernetes/pki/apiserver-kubelet-client.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key /etc/kubernetes/pki/apiserver-kubelet-client.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>https://192.168.0.244:6443/api/v1/services?limit<span style="color:#f92672">=</span>100&amp;resourceVersion<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div></blockquote>
<p>node、service、pod、endpoints、endpointslice、ingress</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_node_name</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_node_label_&lt;labelname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernete_node_labelpressent_&lt;labelname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_node_annotation_&lt;annotationname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_node_annotationpresent_&lt;annotationname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_node_address_&lt;address_type&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">role</span>: <span style="color:#ae81ff">service</span> <span style="color:#75715e">#这通常对于服务的黑盒监视很有用</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_name</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_port_name</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_port_protocol</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_type</span> <span style="color:#75715e">#服务的类型</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_label_&lt;labelname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_labelpresent_&lt;labelname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_annotation_&lt;annotationname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_annotationpresent_&lt;annotationname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_cluster_ip </span> <span style="color:#75715e"># 服务的群集 IP 地址</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_external_name</span> <span style="color:#75715e">#服务的群集 IP 地址</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">role</span>: <span style="color:#ae81ff">pod</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_namespace：容器对象的命名空间。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_name：容器对象的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_ip：容器对象的容器 IP。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_label_&lt;labelname&gt;：容器对象中的每个标签。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_labelpresent_&lt;labelname&gt;：对于容器对象中的每个标签。true</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_annotation_&lt;annotationname&gt;：来自容器对象的每个注释。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_annotationpresent_&lt;annotationname&gt;：对于容器对象中的每个注释。true</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_container_init：如果容器是InitContainertrue</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_container_name：目标地址指向的容器的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_container_port_name：容器端口的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_container_port_number：容器端口的编号。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_container_port_protocol：容器端口的协议。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_ready：设置为或表示容器的就绪状态。truefalse</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_phase：在生命周期中设置为 、、 或 。PendingRunningSucceededFailedUnknown</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_node_name：调度 Pod 所到的节点的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_host_ip：容器对象的当前主机 IP。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_uid：容器对象的 UID。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_controller_kind：容器控制器的对象类型。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_controller_name：容器控制器的名称</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">role</span>: <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_namespace：终结点对象的命名空间。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoints_name：终结点对象的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">对于直接从终端节点列表中发现的所有目标（未从底层 Pod 额外推断出的目标），将附加以下标签：</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_hostname：终结点的主机名。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_node_name：承载终结点的节点的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_ready：设置为终结点的就绪状态或为其设置。truefalse</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_port_name：终结点端口的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_port_protocol：端点端口的协议。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_address_target_kind：终结点地址目标的类型。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_address_target_name：终结点地址目标的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">如果终结点属于某个服务，则会附加发现的所有标签。role</span>: <span style="color:#ae81ff">service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">对于容器支持的所有目标，将附加发现的所有标签。role</span>: <span style="color:#ae81ff">pod</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">role</span>: <span style="color:#ae81ff">ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">该角色为每个入口的每个路径发现一个目标。这通常对于入口的黑盒监视很有用。该地址将设置为入口规范中指定的主机。ingress</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">可用的元标签：</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_namespace：入口对象的命名空间。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_name：入口对象的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_label_&lt;labelname&gt;：入口对象中的每个标签。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_labelpresent_&lt;labelname&gt;：对于入口对象中的每个标签。true</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_annotation_&lt;annotationname&gt;：来自入口对象的每个批注。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_annotationpresent_&lt;annotationname&gt;：对于入口对象中的每个批注。true</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_class_name：入口规范中的类名（如果存在）。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_scheme：入口的协议方案（如果设置了 TLS 配置）。缺省值为 。httpshttp</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_path：入口规范的路径。缺省值为 。</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-882797a566a6d870802dfa95b7787f8a">3.3.5 - consul_sd_configs</h1>
    <div class="lead">kconsul_sd_configs|prometheus</div>
	<p><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#consul_sd_config" target="_blank"><span id='consul_sd_configs'><strong>consul_sd_configs</strong></span></a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 启动一个单实例的[consul](https://www.consul.io/downloads)</span>
</span></span><span style="display:flex;"><span>consul agent -bootstrap <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client<span style="color:#f92672">=</span>0.0.0.0  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-config-dir<span style="color:#f92672">=</span>/etc/conf.d <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-data-dir<span style="color:#f92672">=</span>/consul/data/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-enable-local-script-checks  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-ui
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在consul 中注册服务</span>
</span></span><span style="display:flex;"><span>vi /etc/conf.d/node.json
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;services&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;node_exporter-node01&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;node01&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;10.4.7.11&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;port&#34;</span>: 9100,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;tags&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;nodes&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;checks&#34;</span>: <span style="color:#f92672">[{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;http&#34;</span>: <span style="color:#e6db74">&#34;http://10.4.7.11:9100/metrics&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;interval&#34;</span>: <span style="color:#e6db74">&#34;5s&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;node_exporter-node02&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;node02&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;10.4.7.12&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;port&#34;</span>: 9100,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;tags&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;nodes&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;checks&#34;</span>: <span style="color:#f92672">[{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;http&#34;</span>: <span style="color:#e6db74">&#34;http://10.4.7.12:9100/metrics&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;interval&#34;</span>: <span style="color:#e6db74">&#34;5s&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加载配置文件/etc/conf.d/node.json</span>
</span></span><span style="display:flex;"><span>consul reload
</span></span><span style="display:flex;"><span>scrape_configs:
</span></span><span style="display:flex;"><span>- job_name: <span style="color:#e6db74">&#34;node&#34;</span>
</span></span><span style="display:flex;"><span>  consul_sd_configs:
</span></span><span style="display:flex;"><span>  - server: <span style="color:#e6db74">&#34;47.113.100.31:8500&#34;</span>
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;nodes&#34;</span>
</span></span><span style="display:flex;"><span>    refresh_interval: 2m
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 通过测试命令测试服务的注册发现</span>
</span></span><span style="display:flex;"><span>consul services register -id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;node_exporter-node02&#34;</span>
</span></span><span style="display:flex;"><span>consul services deregister -id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;node_exporter-node02&#34;</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-be6a851a8907242be24193da43e763a0">3.3.6 - PromeQL</h1>
    <div class="lead">PromeQL|prometheus</div>
	<p><a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank">promQL</a> 是prometheus时序数据库的查询语言，可以类比为关系数据库中的SQL。</p>
<h3 id="指标类型">指标类型</h3>
<hr>
<ul>
<li>
<p>gauge: 是一个状态的瞬时快照，值可增可减。配合 <code>changes</code> <code>delta</code> <code>predict_linear</code> <code>deriv</code></p>
</li>
<li>
<p>counter: 是一个累加的指标，自metrics启动以后该值一直累加。 配合 <code>rate</code> <code> irate</code> <code>increase</code></p>
</li>
<li>
<p>summary: 摘要可以展示数据分布 ,允许计算百分位数。 配合 <code>count</code> <code>sum</code> <code>quantitle</code></p>
</li>
<li>
<p>histogram: 直方图可以展示数据分布，按照桶把数据分布投递到不同桶中。直方图的数值是累计的，后一个包含前一个桶中的数据。配合 <code>histogram_quantile</code><br>
例如：<code>histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))</code></p>
</li>
</ul>
<h3 id="查询结果数据类型">查询结果数据类型</h3>
<hr>
<ul>
<li>
<p>即时矢量: 一组时间序列，其中包含每个时间序列的单个样本，所有时间序列共享相同的时间戳</p>
</li>
<li>
<p>范围向量: 一组时间序列，其中包含每个时间序列随时间变化的数据点范围.</p>
<p>例如：</p>
<p>[5m]表示的时间范围是5分钟。
s表示秒
m表示分钟
h表示小时
d表示天
w表示周</p>
</li>
<li>
<p>标量: 一个简单的数字浮点值</p>
</li>
<li>
<p>字符串: 一个简单的字符串值;</p>
</li>
</ul>
<h3 id="查询语句">查询语句</h3>
<hr>

  
  
  

  

  

<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>基本语法</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="示例格式一" aria-controls="tabs-00-01" aria-selected="true">
        示例格式一
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="示例格式二" aria-controls="tabs-00-02" aria-selected="false">
        示例格式二
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="示例格式三" aria-controls="tabs-00-03" aria-selected="false">
        示例格式三
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-04" role="tab"
          data-td-tp-persist="示例格式四" aria-controls="tabs-00-04" aria-selected="false">
        示例格式四
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span>,method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    	!<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                    	<span style="color:#f92672">=</span>~ 选择正则表达式与提供的字符串匹配的指标
</span></span><span style="display:flex;"><span>                    	!~ 选择正则表达式与提供的字符串不匹配的指标
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <p>通过label查询</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span>__name__<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http_requests_total&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>__name__<span style="color:#f92672">=</span>~<span style="color:#e6db74">&#34;.*total</span>$<span style="color:#e6db74">&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span>job<span style="color:#f92672">=</span>~<span style="color:#e6db74">&#34;.+&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>job<span style="color:#f92672">=</span>~<span style="color:#e6db74">&#34;.*&#34;</span>,method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span><span style="color:#f92672">}</span> 
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span>__name__<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http_requests_total&#34;</span><span style="color:#f92672">}[</span>1m<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                 				 ms
</span></span><span style="display:flex;"><span>                  				 s
</span></span><span style="display:flex;"><span>                  				 m
</span></span><span style="display:flex;"><span>                  				 h
</span></span><span style="display:flex;"><span>                  				 d
</span></span><span style="display:flex;"><span>                  				 w
</span></span><span style="display:flex;"><span>                  				 y
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-04" role="tabpanel" aria-labelled-by="tabs-00-04-tab" tabindex="0">
        <p>时间偏移量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http_requests_total @1609746000
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>http_requests_total<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">}</span> @1609746000<span style="color:#f92672">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http_requests_total offset 5m
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>http_requests_total<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">}</span> offset 5m<span style="color:#f92672">)</span>
</span></span></code></pre></div>
    </div>
</div>

<p><strong>标签表达式</strong></p>
<table>
  <thead>
      <tr>
          <th>表达式</th>
          <th>释义</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>=</strong></td>
          <td>精确匹配给定的值</td>
          <td></td>
      </tr>
      <tr>
          <td><strong>!=</strong></td>
          <td>精确不匹配给定的值</td>
          <td></td>
      </tr>
      <tr>
          <td><strong>=~</strong></td>
          <td>正则匹配给定的值</td>
          <td>`http_requests_total{environment=~&ldquo;staging</td>
      </tr>
      <tr>
          <td><strong>!~</strong></td>
          <td>正则不匹配给定的值</td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>运算符：</strong></p>

  
  
    
    

<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>运算符</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="算术运算" aria-controls="tabs-01-01" aria-selected="true">
        算术运算
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="比较运算符" aria-controls="tabs-01-02" aria-selected="false">
        比较运算符
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="逻辑运算符" aria-controls="tabs-01-03" aria-selected="false">
        逻辑运算符
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <ul>
<li>
<p>算术运算</p>
<p><sub>作用范围：（浮点数与浮点数  浮点数与瞬时向量    瞬时向量与瞬时向量），瞬时向量间标签k,v必须保持完全一致</sub></p>
<table>
  <thead>
      <tr>
          <th>运算符</th>
          <th>功能</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>+</td>
          <td>添加</td>
          <td></td>
      </tr>
      <tr>
          <td>-</td>
          <td>减法</td>
          <td></td>
      </tr>
      <tr>
          <td>*</td>
          <td>乘法</td>
          <td></td>
      </tr>
      <tr>
          <td>/</td>
          <td>取商</td>
          <td></td>
      </tr>
      <tr>
          <td>%</td>
          <td>取余数</td>
          <td></td>
      </tr>
      <tr>
          <td>^</td>
          <td>幂</td>
          <td></td>
      </tr>
  </tbody>
</table>
</li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <ul>
<li>
<p>比较运算符</p>
<p><sub>作用范围：（浮点数与浮点数  浮点数与瞬时向量    瞬时向量与瞬时向量）</sub></p>
<p>两个标量之间必须使用 <code>bool</code> 装饰器进行比较，返回0(flase) 或 1(true)</p>
<table>
  <thead>
      <tr>
          <th>运算符</th>
          <th>功能</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>==</td>
          <td>等于</td>
          <td></td>
      </tr>
      <tr>
          <td>!=</td>
          <td>不相等</td>
          <td></td>
      </tr>
      <tr>
          <td>&gt;</td>
          <td>大于</td>
          <td></td>
      </tr>
      <tr>
          <td>&lt;</td>
          <td>小于</td>
          <td></td>
      </tr>
      <tr>
          <td>&gt;=</td>
          <td>大于等于</td>
          <td></td>
      </tr>
      <tr>
          <td>&lt;=</td>
          <td>小于等于</td>
          <td></td>
      </tr>
  </tbody>
</table>
</li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <ul>
<li>
<p>逻辑运算符</p>
<blockquote>
<p><font color=red>逻辑运算两边的标签保持一致</font></p>
</blockquote>
<table>
  <thead>
      <tr>
          <th>运算符</th>
          <th>功能</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>and</td>
          <td>交集</td>
          <td></td>
      </tr>
      <tr>
          <td>or</td>
          <td>并集</td>
          <td></td>
      </tr>
      <tr>
          <td>unless</td>
          <td>补集,左侧有右侧没有的</td>
          <td></td>
      </tr>
  </tbody>
</table>
</li>
</ul>

    </div>
</div>

<p><strong>聚合操作：</strong></p>
<ol>
<li>基于标签聚合</li>
</ol>
<table>
  <thead>
      <tr>
          <th>分类</th>
          <th>运算符</th>
          <th>功能</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>聚合操作分组</td>
          <td>by</td>
          <td></td>
          <td><code>sum by(code) (method_code:http_errors:rate5m)</code></td>
      </tr>
      <tr>
          <td></td>
          <td>without</td>
          <td></td>
          <td><code>sum without(code) (method_code:http_errors:rate5m)</code></td>
      </tr>
      <tr>
          <td>聚合操作符</td>
          <td>sum</td>
          <td>求和</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>count</td>
          <td>计数</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>avg</td>
          <td>平均值</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>max</td>
          <td>最大值</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>min</td>
          <td>最小值</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>topk</td>
          <td>按样本值计算的最大 k 个元素</td>
          <td><code>topk(2,method_code:http_errors:rate5m)</code></td>
      </tr>
      <tr>
          <td></td>
          <td>bottomk</td>
          <td>按样本值排列的最小 k 个元素</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>quantile</td>
          <td>计算φ分位数（0 ≤ φ ≤ 1）的尺寸</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>count_values</td>
          <td>计算具有相同值的元素数</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>stddev</td>
          <td>标准偏差</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>stdvar</td>
          <td>标准与维度的方差</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>group</td>
          <td>结果向量中的所有值均为 1</td>
          <td></td>
      </tr>
  </tbody>
</table>
<ol start="2">
<li>
<p>基于时间聚合</p>
<p><code>_over_time</code> 可以做到保留标签</p>
</li>
</ol>
<p>向量匹配</p>
<ul>
<li>one-to-one</li>
<li>many-to-one and group_left</li>
<li>many-to-many</li>
</ul>
<p><span id='xiangliangpipei'><strong>向量匹配</strong></span></p>
<blockquote>
<p>必须具有相同的标签，如果一方标签过多可以使max by 保留指定标签</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>--collector.textfile --collector.textfile.directory<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.&#34;</span>
</span></span><span style="display:flex;"><span>vi httpcod.prom
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#输入示例：</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;404&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;put&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;501&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;404&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>method:http_requests:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>method:http_requests:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;del&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">34</span>
</span></span><span style="display:flex;"><span>method:http_requests:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">120</span>
</span></span></code></pre></div><p><strong>One-to-one:</strong> 两侧如果具有相同的标签和键  =&gt; 则匹配。<strong>on</strong> 在指定标签上进行匹配，<strong>ignoring</strong>则忽略指定标签</p>
<p>语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&lt;vector expr&gt; &lt;bin-op&gt; ignoring<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> &lt;vector expr&gt;
</span></span><span style="display:flex;"><span>&lt;vector expr&gt; &lt;bin-op&gt; on<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> &lt;vector expr&gt;
</span></span></code></pre></div><p>事例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># method_code:http_errors:rate5m{method=&#34;get&#34;, code=&#34;500&#34;}  24</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># method_code:http_errors:rate5m{method=&#34;post&#34;, code=&#34;500&#34;} 6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># method:http_requests:rate5m{method=&#34;get&#34;}  600</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># method:http_requests:rate5m{method=&#34;post&#34;} 120</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span> / ignoring<span style="color:#f92672">(</span>code<span style="color:#f92672">)</span> method:http_requests:rate5m
</span></span></code></pre></div><p>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span><span style="color:#f92672">}</span>  0.04            //  <span style="color:#ae81ff">24</span> / <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span><span style="color:#f92672">}</span> 0.05            //   <span style="color:#ae81ff">6</span> / <span style="color:#ae81ff">120</span>
</span></span></code></pre></div><p><strong>Many-to-one</strong> and <strong>one-to-many</strong> :  在向量的一侧可以找到多个与之对应的记录</p>
<p>少的一次都能在多的一侧找到对应的 指标。</p>
<p>使用 group_left 和 group_right 指定哪一侧位多的一侧</p>
<p>使用on 和 ignore 指定参照哪个标签进行运算</p>
<p>语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&lt;vector expr&gt; &lt;bin-op&gt; ignoring<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> group_left<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> &lt;vector expr&gt;
</span></span><span style="display:flex;"><span>&lt;vector expr&gt; &lt;bin-op&gt; ignoring<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> group_right<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> &lt;vector expr&gt;
</span></span><span style="display:flex;"><span>&lt;vector expr&gt; &lt;bin-op&gt; on<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> group_left<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> &lt;vector expr&gt;
</span></span><span style="display:flex;"><span>&lt;vector expr&gt; &lt;bin-op&gt; on<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> group_right<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> &lt;vector expr&gt;
</span></span></code></pre></div><p>事例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#group_left 和 group_right 参照 one-to-many 的many 一侧</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m / ignoring<span style="color:#f92672">(</span>code<span style="color:#f92672">)</span> group_left method:http_requests:rate5m
</span></span></code></pre></div><p>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span>  0.04            //  <span style="color:#ae81ff">24</span> / <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;404&#34;</span><span style="color:#f92672">}</span>  0.05            //  <span style="color:#ae81ff">30</span> / <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span> 0.05            //   <span style="color:#ae81ff">6</span> / <span style="color:#ae81ff">120</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;404&#34;</span><span style="color:#f92672">}</span> 0.175           //  <span style="color:#ae81ff">21</span> / <span style="color:#ae81ff">120</span>
</span></span></code></pre></div><h3 id="函数">函数</h3>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>up</td>
          <td>target是否存活</td>
          <td></td>
      </tr>
      <tr>
          <td>absent</td>
          <td>即时向量指标存在什么都不返回，不存在返回1</td>
          <td></td>
      </tr>
      <tr>
          <td>abs</td>
          <td>绝对值</td>
          <td></td>
      </tr>
      <tr>
          <td>absent_over_time</td>
          <td>用于判断范围向量<code>absent_over_time(up1[10m])</code></td>
          <td></td>
      </tr>
      <tr>
          <td>ceil</td>
          <td>四舍五入</td>
          <td></td>
      </tr>
      <tr>
          <td>floor</td>
          <td>舍小数取整</td>
          <td></td>
      </tr>
      <tr>
          <td>time</td>
          <td>返回时间戳</td>
          <td></td>
      </tr>
      <tr>
          <td>changes</td>
          <td>记录变化的次数，比如一个任务从up 变为down 后又变为up  此时应该返回2</td>
          <td><code>changes(up[5m])&gt;0</code></td>
      </tr>
      <tr>
          <td>increase<sub>【用于counter】</sub></td>
          <td>截取 counter 类型一个时间段的增量</td>
          <td><code>increase(node_cpu_secound_total[1m])</code></td>
      </tr>
      <tr>
          <td>irate <sub>【用于counter】</sub></td>
          <td>每秒变化量</td>
          <td></td>
      </tr>
      <tr>
          <td>rate <sub>【用于counter】</sub></td>
          <td>每秒变化量</td>
          <td></td>
      </tr>
      <tr>
          <td>sort</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>sort_desc</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>topk</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>bottomk</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>delta</td>
          <td>截取 counter 类型一个时间段的增量</td>
          <td><code>delta(node_cpu_seconds_total[10m])</code></td>
      </tr>
      <tr>
          <td>last_over_time</td>
          <td>获取指定时间范围内最后一个非空值</td>
          <td><code>last_over_time(stock_price_change[60m])</code></td>
      </tr>
  </tbody>
</table>
<ol>
<li>
<p>label_replace</p>
<blockquote>
<p>替换标签和内容</p>
</blockquote>
<p><strong>语法</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>label_replace<span style="color:#f92672">(</span>__input_vector__,<span style="color:#e6db74">&#34;__dst__&#34;</span>,<span style="color:#e6db74">&#34;__replacement__&#34;</span>,<span style="color:#e6db74">&#34;__src__&#34;</span>,<span style="color:#e6db74">&#34;__regex__&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p><strong>举例</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>label_replace<span style="color:#f92672">(</span>lv_pool_total,<span style="color:#e6db74">&#34;lv_name_new&#34;</span>,<span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#34;lv_name&#34;</span>,<span style="color:#e6db74">&#34;(.*)&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div></li>
<li>
<p>label_join</p>
<p><strong>语法</strong></p>
<p><strong>举例</strong></p>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f429588e5a52c95dd5bec002541ac0aa">3.3.7 - 夜莺·监控系统</h1>
    <div class="lead">夜莺·监控系统</div>
	<p>通过自行构建image，快速体验夜莺</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/ccfos/nightingale.git
</span></span></code></pre></div><blockquote>
<p>位置 nightingale/Dockerfile.nightingale</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">node:16-alpine</span> <span style="color:#66d9ef">AS</span> <span style="color:#e6db74">fe-builder</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk add git<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> git clone https://github.com/n9e/fe.git <span style="color:#f92672">&amp;&amp;</span> cd fe <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    git checkout <span style="color:#66d9ef">$(</span>git describe --tags --abbrev<span style="color:#f92672">=</span>0<span style="color:#66d9ef">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    npm config set registry https://registry.npmmirror.com <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    npm install <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    npm run build<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">golang:1.23.4-alpine3.20</span> <span style="color:#66d9ef">AS</span> <span style="color:#e6db74">builder</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>fe-builder /fe/pub /pub<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk add git<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> git clone https://github.com/ccfos/nightingale.git <span style="color:#f92672">&amp;&amp;</span> cd nightingale <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    git checkout <span style="color:#66d9ef">$(</span>git describe --tags --abbrev<span style="color:#f92672">=</span>0<span style="color:#66d9ef">)</span> <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    export GOPROXY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://goproxy.cn,direct&#34;</span> <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    go install github.com/rakyll/statik@latest <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    statik --src<span style="color:#f92672">=</span>/pub -dest<span style="color:#f92672">=</span>./front <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    go build -ldflags <span style="color:#e6db74">&#34;-w -s -X github.com/ccfos/nightingale/v6/pkg/version.Version=</span><span style="color:#66d9ef">$(</span>git describe --tags --abbrev<span style="color:#f92672">=</span>0<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -o /n9e ./cmd/center/main.go<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">python:3-slim</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span> <span style="color:#e6db74">/app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>builder /n9e /app/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> etc /app/etc/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> integrations /app/integrations/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install requests -i https://pypi.tuna.tsinghua.edu.cn/simple<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span> <span style="color:#e6db74">17000</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/app/n9e&#34;</span>, <span style="color:#e6db74">&#34;-h&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><blockquote>
<p>位置 nightingale/docker/compose-bridge/docker-compose.yaml</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span>networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  nightingale:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    driver: bridge<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>services:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  mysql:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    image: <span style="color:#e6db74">&#34;mysql:8&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    container_name: mysql<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    hostname: mysql<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    restart: always<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      TZ: Asia/Shanghai<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      MYSQL_ROOT_PASSWORD: <span style="color:#ae81ff">1234</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    volumes:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - ./data/mysqldata:/var/lib/mysql/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - ../initsql:/docker-entrypoint-initdb.d/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - ./etc-mysql/my.cnf:/etc/my.cnf<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    ports:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;3306:3306&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  redis:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    image: <span style="color:#e6db74">&#34;redis:6.2&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    container_name: redis<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    hostname: redis<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    restart: always<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      TZ: Asia/Shanghai<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    ports:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;6379:6379&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e"># prometheus:</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   image: prom/prometheus</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   container_name: prometheus</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   hostname: prometheus</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   restart: always</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   environment:</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     TZ: Asia/Shanghai</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   volumes:</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - ./etc-prometheus:/etc/prometheus</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   command:</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;--config.file=/etc/prometheus/prometheus.yml&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;--storage.tsdb.path=/prometheus&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;--web.console.libraries=/usr/share/prometheus/console_libraries&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;--web.console.templates=/usr/share/prometheus/consoles&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;--enable-feature=remote-write-receiver&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;--query.lookback-delta=2m&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   networks:</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - nightingale</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   ports:</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;9090:9090&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  victoriametrics:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    image: victoriametrics/victoria-metrics:v1.79.12<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    container_name: victoriametrics<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    hostname: victoriametrics<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    restart: always<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      TZ: Asia/Shanghai<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    ports:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;8428:8428&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    command:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;--loggerTimezone=Asia/Shanghai&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    volumes:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;./data/victoriametrics:/victoria-metrics-data&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  loki:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    image: grafana/loki:3.5.0<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    container_name: loki<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    hostname: loki<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    restart: always<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    user: root<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      TZ: Asia/Shanghai<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    ports:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;3100:3100&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    volumes:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - ./data/loki:/loki<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span> <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  nightingale:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    build:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      context: ../..<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      dockerfile: Dockerfile.nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    container_name: nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    hostname: nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    restart: always<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      GIN_MODE: release<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      TZ: Asia/Shanghai<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      WAIT_HOSTS: mysql:3306, redis:6379<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    volumes:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - ./etc-nightingale:/app/etc<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    ports:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;17000:17000&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;20090:20090&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    depends_on:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - mysql<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - redis<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - victoriametrics<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    command: &gt;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      sh -c <span style="color:#e6db74">&#34;/app/n9e&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  categraf:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    image: <span style="color:#e6db74">&#34;flashcatcloud/categraf:latest&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    container_name: <span style="color:#e6db74">&#34;categraf&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    hostname: <span style="color:#e6db74">&#34;categraf01&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    restart: always<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      TZ: Asia/Shanghai<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      HOST_PROC: /hostfs/proc<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      HOST_SYS: /hostfs/sys<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      HOST_MOUNT_PREFIX: /hostfs<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      WAIT_HOSTS: nightingale:17000, nightingale:20090<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    volumes:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - ./etc-categraf:/etc/categraf/conf<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - /:/hostfs<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    depends_on:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd nightingale/docker/compose-bridge/
</span></span><span style="display:flex;"><span>docker-compose up
</span></span><span style="display:flex;"><span><span style="color:#75715e"># root root.2020</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fc27d5a38407c7add3b1bb091b945197">3.3.8 - federation</h1>
    <div class="lead">federation|prometheus</div>
	<p>安装部署</p>
<blockquote>
<p>federation 可以实现全局视图。主节点不仅可以提取聚合指标，还可以为Grafana等工具暴露指标或者作为可视化的默认数据源</p>
</blockquote>

  
  

  




  

  

<ul class="nav nav-tabs justify-content-end" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>联邦配置</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="<span id='static_configs'>**节点1**</span>" aria-controls="tabs-00-01" aria-selected="true">
        <span id='static_configs'><strong>节点1</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="<span id='static_configs'>**节点2**</span>" aria-controls="tabs-00-02" aria-selected="false">
        <span id='static_configs'><strong>节点2</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="<span id='static_configs'>**节点3**</span>" aria-controls="tabs-00-03" aria-selected="false">
        <span id='static_configs'><strong>节点3</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-04" role="tab"
          data-td-tp-persist="<span id='dns_sd_configs'>**主节点**</span>" aria-controls="tabs-00-04" aria-selected="false">
        <span id='dns_sd_configs'><strong>主节点</strong></span>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">worker</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rule_files</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#e6db74">&#34;rules/node_rules.yml&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;node&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">file_sd_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">files</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">targets/nodes/*.json</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">refresh_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">modulus</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__tmp_hash</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">hashmod</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__tmp_hash]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">^0$</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">worker</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rule_files</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#e6db74">&#34;rules/node_rules.yml&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;node&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">file_sd_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">files</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">targets/nodes/*.json</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">refresh_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">modulus</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__tmp_hash</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">hashmod</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__tmp_hash]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">^1$</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">worker</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rule_files</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#e6db74">&#34;rules/node_rules.yml&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;node&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">file_sd_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">files</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">targets/nodes/*.json</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">refresh_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">modulus</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__tmp_hash</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">hashmod</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__tmp_hash]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">^2$</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-04" role="tabpanel" aria-labelled-by="tabs-00-04-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;federate&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">15s</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">honor_labels</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#e6db74">&#39;/federate&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#39;match[]&#39;</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#39;{job=&#34;prometheus&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#39;{__name__=~&#34;job:.*&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#39;source-prometheus-1:9090&#39;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#39;source-prometheus-2:9090&#39;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#39;source-prometheus-3:9090&#39;</span>
</span></span></code></pre></div>
    </div>
</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c6ca951d0441de2c3fbff37db4cd100a">3.3.9 - 附录</h1>
    <div class="lead">附录|prometheus</div>
	<h3 id="prometheus-兼容api">prometheus 兼容API</h3>
<hr>

  
  

  




     
    
     

   <ul class="nav nav-tabs justify-content-end" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>查询</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="<span id='static_configs'>**查询瞬时向量**</span>" aria-controls="tabs-00-01" aria-selected="true">
        <span id='static_configs'><strong>查询瞬时向量</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="<span id='static_configs'>**查询范围向量**</span>" aria-controls="tabs-00-02" aria-selected="false">
        <span id='static_configs'><strong>查询范围向量</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="<span id='static_configs'>**查询告警/记录规则**</span>" aria-controls="tabs-00-03" aria-selected="false">
        <span id='static_configs'><strong>查询告警/记录规则</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-04" role="tab"
          data-td-tp-persist="<span id='dns_sd_configs'>**查询活动的警报**</span>" aria-controls="tabs-00-04" aria-selected="false">
        <span id='dns_sd_configs'><strong>查询活动的警报</strong></span>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -s http://127.0.0.1:9090/api/v1/query?query<span style="color:#f92672">=</span>prometheus_build_info
</span></span><span style="display:flex;"><span>curl -X POST -d <span style="color:#e6db74">&#34;query=prometheus_build_info&#34;</span>  http://127.0.0.1:9090/api/v1/query
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>curl -s http://127.0.0.1:9090/api/v1/query?query<span style="color:#f92672">=</span>node_cpu|jq
</span></span><span style="display:flex;"><span>curl -s -g <span style="color:#e6db74">&#39;http://127.0.0.1:9090/api/v1/query?query=node_cpu{cpu=&#34;cpu0&#34;}&#39;</span> |jq <span style="color:#e6db74">&#39;.data.result[3].value&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -s -g <span style="color:#e6db74">&#39;http://127.0.0.1:9090/api/v1/query_range?query=rate(prometheus_tsdb_head_samples_appended_total[5m])&amp;start=1514764800&amp;end=1762830278&amp;step=60&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -XPOST -d <span style="color:#e6db74">&#39;query=rate(prometheus_tsdb_head_samples_appended_total[5m])&amp;start=1514764800&amp;end=1762830278&amp;step=60&#39;</span> http://127.0.0.1:9090/api/v1/query_range
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -s http://127.0.0.1:9090/api/v1/rules | jq
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-04" role="tabpanel" aria-labelled-by="tabs-00-04-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -s http://127.0.0.1:9090/api/v1/alerts | jq
</span></span></code></pre></div>
    </div>
</div>

<hr>
<h3 id="故障分析">故障分析</h3>
<p><strong>问题描述：</strong></p>
<ul>
<li>部分主机cpu使用率持续40分钟超94% 并，告警没有正常发出来。同一个告警下又有主机能够正常发出告警。</li>
</ul>
<p><strong>排查过程:</strong></p>
<pre class="mermaid">flowchart TB

 A[&#34;通过promQL 执行告警规则中的语句，确实达到了触发告警规则的基准&#34;]
 B[&#34;检查alertmanger,发现alertmanger并没有收到该告警&#34;]
 C[&#34;&lt;font color=red&gt;【隐蔽问题：重复第一步通过频繁查询发现有30%的概率查询不到符合告警规则的主机】&lt;/font&gt;&#34;]
 D[&#34;Prometheus开启了远程写入和查询，开始怀疑是不是远程查询导致的查询失败。
 通过promQL 执行其他查询语句，未发现上述【隐蔽问题】&#34;]
 E[&#34;尝试修改该告警规则中promQL 语句，意外发现上述隐蔽问题修复了!!&#34;]
 A -.-&gt;B-.-&gt;C-.-&gt;D-.-&gt;E</pre>


  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="修改前" aria-controls="tabs-01-00" aria-selected="true">
        修改前
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="修改后" aria-controls="tabs-01-01" aria-selected="false">
        修改后
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>label_replace<span style="color:#f92672">(</span>sum by<span style="color:#f92672">(</span>node<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>rate<span style="color:#f92672">(</span>container_cpu_usage_seconds_total<span style="color:#f92672">{</span>id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}[</span>2m<span style="color:#f92672">]))</span>,<span style="color:#e6db74">&#34;hostname&#34;</span>, <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;node&#34;</span>, <span style="color:#e6db74">&#34;(.*)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/ 
</span></span><span style="display:flex;"><span>label_replace<span style="color:#f92672">(</span>sum by<span style="color:#f92672">(</span>node<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>machine_cpu_cores<span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;hostname&#34;</span>, <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;node&#34;</span>, <span style="color:#e6db74">&#34;(.*)&#34;</span><span style="color:#f92672">)</span> * <span style="color:#ae81ff">100</span> &gt; <span style="color:#ae81ff">80</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>label_replace<span style="color:#f92672">(</span>sum by<span style="color:#f92672">(</span>node<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>rate<span style="color:#f92672">(</span>container_cpu_usage_seconds_total<span style="color:#f92672">{</span>id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}[</span>5m<span style="color:#f92672">]))</span>,<span style="color:#e6db74">&#34;hostname&#34;</span>, <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;node&#34;</span>, <span style="color:#e6db74">&#34;(.*)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/ 
</span></span><span style="display:flex;"><span>label_replace<span style="color:#f92672">(</span>sum by<span style="color:#f92672">(</span>node<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>machine_cpu_cores<span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;hostname&#34;</span>, <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;node&#34;</span>, <span style="color:#e6db74">&#34;(.*)&#34;</span><span style="color:#f92672">)</span> * <span style="color:#ae81ff">100</span> &gt; <span style="color:#ae81ff">80</span>
</span></span></code></pre></div>
    </div>
</div>

<p><strong>故障总结</strong></p>
<p>根本原因是<code>rate</code>计算速率的函数基于最后2个数据点执行计算，由于<code>rate()[2m]</code> 时间跨度刚好等于<code>scrape_interval</code> 因此存在一定概率2分钟内没有两个数据采集点位导致数据点缺失或时间对齐问题返回空值。</p>
<p>解决办法建议将范围扩大到 <code>scrape_interval</code>*4</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d5033e8c9a46dd0403d5bde3fa28069c">3.3.10 - exporter</h1>
    
	<table>
  <thead>
      <tr>
          <th style="text-align: left">范围</th>
          <th style="text-align: left">常用 Exporter</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">promethues组件</td>
          <td style="text-align: left">prometheus(9090)、pushgateway(9091)、alertmanager(9093)、grafana(3000)、consul(8500)</td>
      </tr>
      <tr>
          <td style="text-align: left">k8s组件</td>
          <td style="text-align: left">etcd(2379)、apiserver(6443)、scheduler、controllermanager、kubeproxy、kubelet、coredns(9153)、flanneld、traefik/nginx-ingress、cadvisor(8080)、kube_state_metrics</td>
      </tr>
      <tr>
          <td style="text-align: left">数据库</td>
          <td style="text-align: left">MySQL Exporter、Redis Exporter(9121)、MongoDB Exporter、MSSQL Exporter 等</td>
      </tr>
      <tr>
          <td style="text-align: left">硬件</td>
          <td style="text-align: left">Apcupsd Exporter、IoT Edison Exporter、IPMI Exporter、Node Exporter(9100) 等</td>
      </tr>
      <tr>
          <td style="text-align: left">消息队列</td>
          <td style="text-align: left">Zookeeper Exporter、Kafka Exporter、RabbitMQ Exporter、Beanstalkd Exporter 、NSQ Exporter等</td>
      </tr>
      <tr>
          <td style="text-align: left">存储</td>
          <td style="text-align: left">Minio、 Ceph Exporter、Gluster Exporter、HDFS Exporter、ScaleIO Exporter 等</td>
      </tr>
      <tr>
          <td style="text-align: left">HTTP服务</td>
          <td style="text-align: left">Apache Exporter、HAProxy Exporter、Nginx Exporter 等</td>
      </tr>
      <tr>
          <td style="text-align: left">API服务</td>
          <td style="text-align: left">AWS ECS Exporter、Docker Cloud Exporter、Docker Hub Exporter、GitHub Exporter 等</td>
      </tr>
      <tr>
          <td style="text-align: left">日志</td>
          <td style="text-align: left">Fluentd Exporter、Grok Exporter 等</td>
      </tr>
      <tr>
          <td style="text-align: left">监控系统</td>
          <td style="text-align: left">Collectd Exporter、Graphite Exporter、InfluxDB Exporter、Nagios Exporter、SNMP Exporter 等</td>
      </tr>
      <tr>
          <td style="text-align: left">java</td>
          <td style="text-align: left">jmx_exporter、tomcat</td>
      </tr>
      <tr>
          <td style="text-align: left">其它</td>
          <td style="text-align: left">Blockbox Exporter、JIRA Exporter、Jenkins Exporter、Confluence Exporter 等</td>
      </tr>
  </tbody>
</table>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-624d0b59238886cb73ea365101d34bb0">3.3.10.1 - node_exporter</h1>
    <div class="lead">node_exporter|exporter|prometheus</div>
	<p>提供操作系统级别的监控指标，<code>cpu</code> <code>memory</code> <code>disk space</code> <code>diskio</code> <code>network</code></p>

  
  
  

 <ul class="nav nav-tabs justify-content-end" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong><a href="https://prometheus.io/download/#node_exporter" target="_blank">部署安装</a></strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="二进制" aria-controls="tabs-00-01" aria-selected="true">
        二进制
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="kubernetes" aria-controls="tabs-00-02" aria-selected="false">
        kubernetes
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/prometheus/node_exporter/releases/download/v1.6.1/node_exporter-1.6.1.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf node_exporter-1.6.1.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>mv node_exporter-*.linux-amd64/node_exporter /usr/bin
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/node_exporter.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=node_exporter service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/node_exporter \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=:9100 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.telemetry-path=/metrics \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--collector.systemd \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--collector.systemd.unit-include=&#34;(sshd|docker|rsyslog|kubelet|kube-proxy).service&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--no-collector.arp \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log.format=json 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable node_exporter --now
</span></span><span style="display:flex;"><span>systemctl status node_exporter
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">app</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tolerations</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#e6db74">&#34;Exists&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">hostPID</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">image</span>: <span style="color:#ae81ff">quay.io/prometheus/node-exporter:v1.6.1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>            - --<span style="color:#ae81ff">path.rootfs=/host</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/host</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">root</span>
</span></span></code></pre></div>
    </div>
</div>

<p>​</p>

  
  





  

 <ul class="nav nav-tabs justify-content-end" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>添加prometheus配置</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="静态配置" aria-controls="tabs-01-01" aria-selected="true">
        静态配置
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="kuernetes_sd_configs" aria-controls="tabs-01-02" aria-selected="false">
        kuernetes_sd_configs
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">honor_timestamps</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">20s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">9100</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <blockquote>
<p><code>kubeconfig_file</code> 和 <code>api_server</code> 二选其一</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kubeconfig_file</span>: <span style="color:#ae81ff">/root/.kube/config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:9100&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">node-exporter-ca</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://192.168.0.244:6443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 测试改成false也没问题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:9100&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div>
    </div>
</div>

<p><em>由于node_export 返回大量指标，通过prometheus配置文件的collect 收集指定的指标</em></p>
<blockquote>
<p>curl -g -X GET 127.0.0.1:9100/metrics?collect[]=xfs
curl -g -X GET 127.0.0.1:9100/metrics?collect[]=cpu</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">prometheus</span>: <span style="color:#ae81ff">prom-xxx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">node_exporter</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">collect[]</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">cpu</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">meminfo</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">netstat</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">systemd</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">xfs</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">filefd</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">filesystem</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://127.0.0.1:6443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.pem</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/cert.pem</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/cert.key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 测试改成false也没问题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:9100&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div><ol start="2">
<li>
<p>常用指标</p>
<table>
  <thead>
      <tr>
          <th><strong>指标</strong></th>
          <th><strong>释义</strong></th>
          <th><strong>指标类型</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>irate(node_cpu_seconds_total{job=&quot;node_exporter&quot;,cpu=&quot;0&quot;}[5m])</code></td>
          <td>cpu0 每秒使用率</td>
          <td>counter</td>
      </tr>
      <tr>
          <td><code>avg(irate(node_cpu_seconds_total{job=&quot;node_exporter&quot;,cpu=&quot;0&quot;}[5m]))by(mode)</code></td>
          <td>cpu0 平均使用率</td>
          <td></td>
      </tr>
      <tr>
          <td><code>count(node_cpu_seconds_total{mode=&quot;idle&quot;})by(instance)</code></td>
          <td>查询有几个逻辑核心</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_memory_MemTotal_bytes</code></td>
          <td>内存总量</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_memory_Buffers_bytes</code></td>
          <td>buffer</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_memory_Cached_bytes</code></td>
          <td>cache</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_memory_MemFree_bytes</code></td>
          <td>free</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_memory_MemAvailable_bytes</code></td>
          <td>可用内存</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_memory_SUnreclaim_bytes</code></td>
          <td>不可回收slab</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_vmstat_pswpin</code></td>
          <td>磁盘加载到内存的字节数/s</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_vmstat_pswpout</code></td>
          <td>内存换出到磁盘的字节数/s</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_filesystem_size_bytes</code></td>
          <td>mount的文件系统大小</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_filesystem_free_bytes</code></td>
          <td>mount的文件系统空闲</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_systemd_unit_state</code></td>
          <td>systemd管理服务状态</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_uname_info</code></td>
          <td>主机名/os版本的信心</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_filesystem_readonly</code></td>
          <td>文件系统只读</td>
          <td></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>node_netstat_Tcp_CurrEstab  tcp连接数
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 入栈流量</span>
</span></span><span style="display:flex;"><span>rate<span style="color:#f92672">(</span>node_network_receive_bytes_total<span style="color:#f92672">{</span>device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;eth0&#34;</span><span style="color:#f92672">}[</span>5m<span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 出栈流量</span>
</span></span><span style="display:flex;"><span>rate<span style="color:#f92672">(</span>node_network_transmit_bytes_total<span style="color:#f92672">{</span>device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;eth0&#34;</span><span style="color:#f92672">}[</span>5m<span style="color:#f92672">])</span>
</span></span></code></pre></div></li>
<li>
<p>告警规则</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 1. 运行时间</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. cpu</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 内存</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. 磁盘</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. tcp 连接</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6. 网络流量</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 机器宕机告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeDown</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">up{job=~&#34;node(_|-|)exporter&#34;} == 0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机宕机 ({{ $labels.instance }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 已宕机超过5分钟 (Job: {{ $labels.job }})&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 文件系统只读告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">FilesystemReadOnly</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">node_filesystem_readonly{mountpoint=&#34;/&#34;} == 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机 ({{ $labels.instance }})挂载点 {{ $labels.mountpoint }} 只读&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 挂载点 {{ $labels.mountpoint }} 变为只读超过5分钟 (Job: {{ $labels.job }})&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># CPU使用率告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeCpuUsageHigh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      100 - (
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        avg by(instance) (
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          rate(node_cpu_seconds_total{mode=&#34;idle&#34;}[5m])
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ) * 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ) &gt; 85</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">warning</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机CPU使用率过高 ({{ $labels.instance }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} CPU使用率持续5分钟超过85%（当前值：{{ $value | printf \&#34;%.2f\&#34;}}%）&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 系统负载告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeLoad1High</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_load1 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &gt; on(instance) 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      count by(instance) (node_cpu_seconds_total{mode=&#34;idle&#34;}) * 2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">warning</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机1分钟负载过高 ({{ $labels.instance }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 1分钟负载超过CPU核心数2倍（当前值：{{ $value | printf \&#34;%.2f\&#34;}}）&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeLoad15High</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_load15 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &gt; on(instance) 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      count by(instance) (node_cpu_seconds_total{mode=&#34;idle&#34;}) * 2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机15分钟负载过高 ({{ $labels.instance }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 15分钟负载持续超过CPU核心数2倍（当前值：{{ $value | printf \&#34;%.2f\&#34;}}）&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 内存使用率告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeMemoryUsageHigh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      (1 - 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        node_memory_MemAvailable_bytes{job=~&#34;node.*exporter&#34;} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        / 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        node_memory_MemTotal_bytes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ) * 100 &gt; 90</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机内存使用率过高 ({{ $labels.instance }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 内存使用率持续5分钟超过90%（当前值：{{ $value | printf \&#34;%.2f\&#34;}}%）&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 磁盘使用率告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeDiskUsageHigh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      (1 - 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        node_filesystem_free_bytes{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          fstype!~&#34;^(tmpfs|rootfs|autofs|devpts|devtmpfs|overlay)$&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          mountpoint!~&#34;^/(boot|run|var/lib/docker).*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        } 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        / 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        node_filesystem_size_bytes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ) * 100 &gt; 85</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">warning</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机磁盘使用率过高 ({{ $labels.instance }}:{{ $labels.mountpoint }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 挂载点 {{ $labels.mountpoint }} 使用率超过85%（当前值：{{ $value | printf \&#34;%.2f\&#34;}}%）&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 磁盘空间预测告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeDiskWillFillIn8H</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      predict_linear(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        node_filesystem_free_bytes{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          fstype!~&#34;^(tmpfs|rootfs|autofs|devpts|devtmpfs|overlay)$&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          mountpoint!~&#34;^/(boot|run|var/lib/docker).*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }[6h],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        8*3600
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ) &lt; 0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">warning</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机磁盘空间即将耗尽 ({{ $labels.instance }}:{{ $labels.mountpoint }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 挂载点 {{ $labels.mountpoint }} 预计8小时内空间将耗尽（当前预测值：{{ $value | printf \&#34;%.2f\&#34;}}）&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 网络流量</span>
</span></span></code></pre></div><ul>
<li>
<p>cpu饱和度</p>
<p>通过1分钟 5分钟 15 分钟的负载展示。一般负载小于cpu 核心数1.5倍</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>node_load1 &gt;on <span style="color:#f92672">(</span>instance<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>count by<span style="color:#f92672">(</span>instance<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>node_cpu_seconds_total<span style="color:#f92672">{</span>mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;idle&#34;</span><span style="color:#f92672">})</span>*1
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>node_load5
</span></span><span style="display:flex;"><span>node_load15
</span></span></code></pre></div></li>
<li>
<p>内存使用率</p>
<blockquote>
<p><font color="#b2b503">[<strong>INFO</strong>]</font></p>
<p>node_memmory_MemeTotal_bytes
node_memmory_MemFress_bytes
node_memmory_Buffers_bytes
node_memmory_Cached_bytes</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>1-<span style="color:#f92672">(</span>node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes<span style="color:#f92672">)</span> &gt;0.85
</span></span></code></pre></div></li>
<li>
<p>内存饱和度,判断内存的繁忙程度</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>磁盘到到内存的  字节数/s
</span></span><span style="display:flex;"><span>node_vmstat_pswpin
</span></span><span style="display:flex;"><span>内存到到磁盘的 字节数/s
</span></span><span style="display:flex;"><span>node_vmstat_pswpout
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rate<span style="color:#f92672">(</span>node_vmstat_pswpout<span style="color:#f92672">[</span>1m<span style="color:#f92672">])</span>+rate<span style="color:#f92672">(</span>node_vmstat_pswpin<span style="color:#f92672">[</span>1m<span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>rate<span style="color:#f92672">(</span>node_vmstat_pswpout<span style="color:#f92672">[</span>1m<span style="color:#f92672">])</span>+rate<span style="color:#f92672">(</span>node_vmstat_pswpin<span style="color:#f92672">[</span>1m<span style="color:#f92672">]))</span>by<span style="color:#f92672">(</span>instance<span style="color:#f92672">)</span> *1024
</span></span></code></pre></div></li>
<li>
<p>磁盘使用率</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>node_filesystem_size_bytes<span style="color:#f92672">{</span>mountpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}</span> <span style="color:#75715e"># 总大小</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>node_filesystem_free_bytes<span style="color:#f92672">{</span>mountpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}</span> <span style="color:#75715e"># 空闲大小</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#使用比例</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>1-<span style="color:#f92672">(</span>node_filesystem_free_bytes<span style="color:#f92672">{</span>mountpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}</span>/node_filesystem_size_bytes<span style="color:#f92672">{</span>mountpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}))</span>&gt;0.85
</span></span></code></pre></div><p>使用predict_linear线性函数预测未来4个小时中磁盘的剩余空间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>predict_linear<span style="color:#f92672">(</span>node_filesystem_free_bytes<span style="color:#f92672">{</span>mountpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}[</span>1h<span style="color:#f92672">]</span>,4*3600<span style="color:#f92672">)</span>&lt;<span style="color:#ae81ff">0</span>
</span></span></code></pre></div></li>
<li>
<p>入栈流量速率</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>irate<span style="color:#f92672">(</span>node_network_receive_bytes_total<span style="color:#f92672">{</span>device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;eth0&#34;</span><span style="color:#f92672">}[</span>5m<span style="color:#f92672">])</span>
</span></span></code></pre></div></li>
<li>
<p>出栈网络速率</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>irate<span style="color:#f92672">(</span>node_network_transmit_bytes_total<span style="color:#f92672">{</span>device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;eth0&#34;</span><span style="color:#f92672">}[</span>5m<span style="color:#f92672">])</span>
</span></span></code></pre></div></li>
<li>
<p>服务异常</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>node_systemd_unit_state<span style="color:#f92672">{</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;docker.service&#34;</span><span style="color:#f92672">}</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div></li>
<li>
<p>bond 文件描述符 sr-iov 监控 tcp</p>
</li>
</ul>
</li>
<li>
<p>附录： 自定义指标</p>
<p>node_exporter 允许用户自定义监控指标，具体方法如下：</p>
<ol>
<li>
<p>修改node_exportrer启动文件,添加如下选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>--collector.textfile <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--collector.textfile.directory<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>在 <code>--collector.textfile.directory=</code> 定义的目录下写入要提供的指标内容，文件以<code>.prom</code> 结尾</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi httpcod.prom
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#输入示例：</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;404&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;put&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;501&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;404&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>method:http_requests:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>method:http_requests:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;del&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">34</span>
</span></span><span style="display:flex;"><span>method:http_requests:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">120</span>
</span></span></code></pre></div></li>
<li>
<p>重启node_exporter</p>
</li>
</ol>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d2d65a85ce96b5d2e1c53c6332d4b35d">3.3.10.2 - blackbox</h1>
    <div class="lead">blackbox|exporter|prometheus</div>
	<p>blackbox是一个黑盒监控的代表，他通过各种模块来探测监控对象，并将结果返回给prometheus</p>
<ol>
<li>
<p>部署安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.24.0/blackbox_exporter-0.24.0.linux-amd64.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf blackbox_exporter-0.24.0.linux-amd64.tar.gz 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /data/blackbox_exporter/<span style="color:#f92672">{</span>bin,conf<span style="color:#f92672">}</span> -p
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mv blackbox_exporter-*linux-amd64/blackbox_exporter /data/blackbox_exporter/bin/
</span></span><span style="display:flex;"><span>mv blackbox_exporter-*linux-amd64/blackbox.yml /data/blackbox_exporter/conf/
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/blackbox_exporter.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=blackbox_exporter service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/blackbox_exporter/bin/blackbox_exporter \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=:9115 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config.file=/data/blackbox_exporter/conf/blackbox.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>启动blackbox</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable blackbox_exporter --now
</span></span><span style="display:flex;"><span>systemctl status blackbox_exporter 	
</span></span></code></pre></div><p><a href="https://github.com/prometheus/blackbox_exporter/blob/master/example.yml" target="_blank">默认配置</a></p>
<p>功能验证,<code>probe_success  1</code>表示探测成功</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -s  <span style="color:#e6db74">&#34;http://127.0.0.1:9115/probe?module=http_2xx&amp;target=www.baidu.com&#34;</span>|grep probe_success
</span></span><span style="display:flex;"><span><span style="color:#75715e"># probe_success 1</span>
</span></span></code></pre></div></li>
<li>
<p>添加prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;blackbox-http&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/probe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">module</span>: [<span style="color:#ae81ff">http_2xx] </span> <span style="color:#75715e"># 指定模块</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">http://192.168.0.172:9999/magic/web/index.html </span> <span style="color:#75715e"># Target to probe with http.</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">https://sg-web-bjuat.pytech.cn/qc/dash  </span> <span style="color:#75715e"># Target to probe with https.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__param_target</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__param_target]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">instance</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">9115</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;blackbox-icmp&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/probe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">module</span>: [<span style="color:#ae81ff">icmp] </span> <span style="color:#75715e"># 指定模块</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">192.168.0.172</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__param_target</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__param_target]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">instance</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">9115</span>
</span></span></code></pre></div></li>
<li>
<p>常用指标</p>
<table>
  <thead>
      <tr>
          <th>主要指标</th>
          <th>解释</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>probe_dns_lookup_time_seconds </code></td>
          <td>dns解析耗时</td>
          <td></td>
      </tr>
      <tr>
          <td><code>probe_duration_seconds</code></td>
          <td>探测耗时</td>
          <td></td>
      </tr>
      <tr>
          <td><code>probe_http_status_code </code></td>
          <td>解析状态码</td>
          <td>200</td>
      </tr>
      <tr>
          <td><code>probe_success </code></td>
          <td>探测是否成功1成功</td>
          <td></td>
      </tr>
  </tbody>
</table>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f2088b66d721f30cecd45b9172151883">3.3.10.3 - jmx_exporter</h1>
    <div class="lead">jmx_exporter|exporter|prometheus</div>
	<ol>
<li>
<p><a href="https://github.com/prometheus/jmx_exporter" target="_blank">部署安装</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 下载地址1： https://github.com/prometheus/jmx_exporter/tree/release-0.20.0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 下载地址2： https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/1.0.1/jmx_prometheus_javaagent-1.0.1.jar
</span></span></code></pre></div><p>配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee javaagent.yaml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- pattern: &#34;.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>以javaagent方式启动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>java -jar -Duser.timezone<span style="color:#f92672">=</span>Asia/Shanghai <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-javaagent:jmx_prometheus_javaagent-1.0.1.jar<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>hostname -i<span style="color:#66d9ef">)</span>:<span style="color:#e6db74">${</span>M_PORT<span style="color:#66d9ef">:-</span><span style="color:#e6db74">&#34;12345&#34;</span><span style="color:#e6db74">}</span>:javaagent.yaml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>&lt;yourjar&gt;
</span></span></code></pre></div></li>
<li>
<p>添加prometheus配置</p>
</li>
<li>
<p>常用指标</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 堆内存使用量</span>
</span></span><span style="display:flex;"><span>jvm_memory_used_bytes<span style="color:#f92672">{</span>area<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;heap&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 堆内存提交量</span>
</span></span><span style="display:flex;"><span>jvm_memory_committed_bytes<span style="color:#f92672">{</span>area<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;heap&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 堆内存最大可用量</span>
</span></span><span style="display:flex;"><span>jvm_memory_max_bytes<span style="color:#f92672">{</span>area<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;heap&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Young GC 触发次数</span>
</span></span><span style="display:flex;"><span>jvm_gc_collection_seconds_count<span style="color:#f92672">{</span>gc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;G1 Young Generation&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  Old GC 总耗时</span>
</span></span><span style="display:flex;"><span>jvm_gc_collection_seconds_sum<span style="color:#f92672">{</span>gc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;G1 Old Generation&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 当前活动线程数</span>
</span></span><span style="display:flex;"><span>jvm_threads_current
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 守护线程数</span>
</span></span><span style="display:flex;"><span>jvm_threads_daemon
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  峰值线程数</span>
</span></span><span style="display:flex;"><span>jvm_threads_peak
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 总加载的类数量</span>
</span></span><span style="display:flex;"><span>jvm_classes_loaded_total
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 总卸载类数量</span>
</span></span><span style="display:flex;"><span>jvm_classes_unloaded_total
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 当前加载类数量</span>
</span></span><span style="display:flex;"><span>jvm_classes_currently_loaded
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5d8b8cd5776ff486cdacaf0443afe506">3.3.10.4 - nginx-exporter</h1>
    <div class="lead">nginx-exporter|exporter|prometheus</div>
	<p><a href="https://github.com/nginx/nginx-prometheus-exporter" target="_blank">nginx-exporter</a> 支持对nginx 、nginx plugin(nginx的企业版)、nginx-ingress 暴露符合prometheus格式的指标。该文档只讨论开源版本的nginx的实施方案。</p>
<p>前提条件nginx 需要开启<code>stub_status</code> 指令,样例格式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span> 127.0.0.1:<span style="color:#ae81ff">8080</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/stub_status</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">stub_status</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">access_log</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">allow</span> 127.0.0.1;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>部署安装</strong></p>
<blockquote>
<p>docker 镜像：<code>nginx/nginx-prometheus-exporter:1.4.0</code></p>
<p>二进制文件： <code> https://github.com/nginx/nginx-prometheus-exporter/releases/download/v1.4.0/nginx-prometheus-exporter_1.4.0_linux_amd64.tar.gz</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--net<span style="color:#f92672">=</span>host <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>nginx/nginx-prometheus-exporter:1.4.0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--nginx.scrape-uri<span style="color:#f92672">=</span>http://127.0.0.1:8080/stub_status
</span></span></code></pre></div><p><strong>添加prometheus配置</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">9113</span>
</span></span></code></pre></div><p><strong>常用指标</strong></p>
<table>
  <thead>
      <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Labels</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>nginx_up</code></td>
          <td>Gauge</td>
          <td>Shows the status of the last metric scrape: <code>1</code> for a successful scrape and <code>0</code> for a failed one</td>
          <td>[]</td>
      </tr>
  </tbody>
</table>
<p><a href="https://nginx.org/en/docs/http/ngx_http_stub_status_module.html" target="_blank">Stub status metrics</a></p>
<table>
  <thead>
      <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Labels</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>nginx_connections_accepted</code></td>
          <td>Counter</td>
          <td>接受的客户端连接总数</td>
          <td>[]</td>
      </tr>
      <tr>
          <td><code>nginx_connections_active</code></td>
          <td>Gauge</td>
          <td>活跃的连接数，包括处于等待状态的连接</td>
          <td>[]</td>
      </tr>
      <tr>
          <td><code>nginx_connections_handled</code></td>
          <td>Counter</td>
          <td>Handled client connections.</td>
          <td>[</td>
      </tr>
      <tr>
          <td><code>nginx_connections_reading</code></td>
          <td>Gauge</td>
          <td>nginx 读取的客户端请求头</td>
          <td>[]</td>
      </tr>
      <tr>
          <td><code>nginx_connections_waiting</code></td>
          <td>Gauge</td>
          <td>空闲的连接数</td>
          <td>[]</td>
      </tr>
      <tr>
          <td><code>nginx_connections_writing</code></td>
          <td>Gauge</td>
          <td>nginx 返回给客户端的响应.</td>
          <td>[]</td>
      </tr>
      <tr>
          <td><code>nginx_http_requests_total</code></td>
          <td>Counter</td>
          <td>客户端请求总数</td>
          <td>[]</td>
      </tr>
  </tbody>
</table>
<p>其他第三方方案</p>
<p><a href="https://github.com/knyar/nginx-lua-prometheus" target="_blank">nginx-lua-prometheus</a></p>
<p><a href="https://github.com/vozlt/nginx-module-vts" target="_blank">nginx-module-vts</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y GeoIP-devel.x86_64 pcre-devel openssl-devel 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget http://nginx.org/download/nginx-1.22.1.tar.gz
</span></span><span style="display:flex;"><span>tar xf nginx-1.22.1.tar.gz <span style="color:#f92672">&amp;&amp;</span> cd nginx-1.22.1
</span></span><span style="display:flex;"><span>git clone git://github.com/vozlt/nginx-module-vts.git
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./configure <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--prefix<span style="color:#f92672">=</span>/opt/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_geoip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_stub_status_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream<span style="color:#f92672">=</span>dynamic <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_geoip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--add-module<span style="color:#f92672">=</span>./nginx-module-vts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>make -j <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> make install
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./configure <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--prefix<span style="color:#f92672">=</span>/opt/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_geoip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_stub_status_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_geoip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--add-module<span style="color:#f92672">=</span>./nginx-module-vts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>make -j <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> make install
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./configure <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--prefix<span style="color:#f92672">=</span>/opt/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--sbin-path<span style="color:#f92672">=</span>/usr/bin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--conf-path<span style="color:#f92672">=</span>/etc/nginx/nginx.conf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_geoip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_stub_status_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_geoip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--add-module<span style="color:#f92672">=</span>./nginx-module-vts
</span></span></code></pre></div><p>基本的指标样例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">vhost_traffic_status_zone</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">server</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">location</span> <span style="color:#e6db74">/status</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">vhost_traffic_status_display</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">vhost_traffic_status_display_format</span> <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">access_log</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>统计客户端ip国家信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">geoip_country</span> <span style="color:#e6db74">/usr/share/GeoIP/GeoIP.dat</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">vhost_traffic_status_zone</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">vhost_traffic_status_filter_by_set_key</span> $geoip_country_code <span style="color:#e6db74">country::*</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">server</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">vhost_traffic_status_filter_by_set_key</span> $geoip_country_code <span style="color:#e6db74">country::</span>$server_name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/status</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">vhost_traffic_status_display</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">vhost_traffic_status_display_format</span> <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">nginx-module-vts</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/status/format/prometheus</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">127.0.0.1</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a91649f35c1611e400ba18dd4dfe3c9a">3.3.10.5 - minio</h1>
    <div class="lead">minio|exporter|prometheus</div>
	<ol>
<li>
<p>部署安装</p>
<blockquote>
<p>minio自身暴露了prometheus 兼容指标。我们只需要在启动前添加环境变量: <code>MINIO_PROMETHEUS_AUTH_TYPE=&quot;public&quot;</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://dl.min.io/server/minio/release/linux-amd64/minio
</span></span><span style="display:flex;"><span>chmod +x minio
</span></span><span style="display:flex;"><span>sudo mv minio /usr/local/bin/
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee  /etc/systemd/system/minio.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=minio serveice test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/data/minio/conf/minio.env
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/minio/bin/minio server \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/data/minio/data \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--address :9000 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--console-address :9001
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/minio/conf/minio.env<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MINIO_ROOT_USER=admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MINIO_ROOT_PASSWORD=admin12345
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MINIO_PROMETHEUS_AUTH_TYPE=&#34;public&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>添加prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>- job_name: minio
</span></span><span style="display:flex;"><span>  honor_timestamps: true
</span></span><span style="display:flex;"><span>  metrics_path: /minio/v2/metrics/cluster
</span></span><span style="display:flex;"><span>  follow_redirects: true
</span></span><span style="display:flex;"><span>  static_configs:
</span></span><span style="display:flex;"><span>  - targets:
</span></span><span style="display:flex;"><span>    - 10.4.7.251:9000
</span></span></code></pre></div></li>
<li>
<p>常用指标</p>
<p>minio 挂载磁盘的总大小，就是例子中 <code>/data/minio/data</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minio_node_disk_total_bytes
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minio_node_disk_free_bytes
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minio_node_disk_used_bytes
</span></span></code></pre></div><p>查看特定bucket池子的使用量 (gauge)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minio_bucket_usage_total_bytes<span style="color:#f92672">{</span>bucket<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;loki&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minio_bucket_usage_object_total<span style="color:#f92672">{</span>bucket<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;loki&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>对象存储大小分布 (gauge)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minio_bucket_objects_size_distribution
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ab1b654ca9a964046d54e4a76701e2bc">3.3.10.6 - redis-exporter</h1>
    <div class="lead">redis-exporter用于导出兼容redis协议的数据库指标给prometheus，例如Valkey和redis</div>
	

<div class="alert alert-warning" role="alert">


    redis-exporter(1.74.0版本) 支持redis 2.x-7.x

</div>

<ol>
<li>
<p><strong><a href="https://github.com/oliver006/redis_exporter" target="_blank">部署安装</a></strong></p>
<blockquote>
<p>容器镜像 <code>quay.io/oliver006/redis_exporter</code></p>
</blockquote>
<p><em>安装exporter</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/oliver006/redis_exporter/releases/download/v1.74.0/redis_exporter-v1.74.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>tar xf redis_exporter-v1.74.0.linux-amd64.tar.gz 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>mv redis_exporter-v1.74.0.linux-amd64/redis_exporter /usr/bin/
</span></span><span style="display:flex;"><span>rm -fr redis_exporter*
</span></span></code></pre></div><p><em>启动服务</em></p>
<blockquote>
<p><code>-is-cluster</code> 监控集群启动参数添加该选项</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/usr/lib/systemd/system/redis_exporter_redis01_6379.service<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description = redis-exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation = https://github.com/oliver006/redis_exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After = network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=Simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/redis_exporter \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-redis.password YSxeEr3e4ZdF \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-redis.addr 10.128.111.66:6379 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-export-client-list \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-include-system-metrics \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-connection-timeout 60s \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-web.listen-address :9121 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-config-command config \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-set-client-name redis_exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Group=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CPUQuota=20%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MemoryLimit=128m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable redis_exporter_redis01_6379 --now 
</span></span><span style="display:flex;"><span>systemctl status redis_exporter_redis01_6379
</span></span></code></pre></div></li>
<li>
<p><strong>添加prometheus配置</strong></p>
<p>指标接口： <code>http://127.0.0.1:9121/metrics</code></p>
<p>类似于blackbox,可以采集其他redis: <code>http://127.0.0.1:9121/scrape?127.0.0.1:6379</code></p>
</li>
<li>
<p><strong>dashboar和告警</strong></p>
<p><strong>进程相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th>判断依据</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_up</code></td>
          <td>进程状态1表示正常</td>
      </tr>
      <tr>
          <td><code>redis_uptime_in_seconds</code></td>
          <td>启动时长</td>
      </tr>
      <tr>
          <td><code>redis_instance_info</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>内存相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_memory_used_bytes</code></td>
          <td>内存使用量</td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_peak_bytes</code></td>
          <td>内存使用峰值</td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_rss_bytes</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_max_bytes</code></td>
          <td>maxmemory</td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_config_maxmemory</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_dataset_bytes</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_lua_bytes</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_scripts_bytes</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_startup_bytes</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_overhead_bytes</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_allocator_rss_bytes</code></td>
          <td>分配出常驻内存</td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_active_defrag_running </code></td>
          <td>内存碎片整理</td>
          <td>表示没有活动的defrag任务正在运行，1表示有活动的defrag任务正在运行</td>
      </tr>
      <tr>
          <td><code>redis_allocator_frag_ratio</code></td>
          <td>内存碎片比</td>
          <td>used_memory_rss和used_memory之间的比率，小于1表示使用了swap，大于1表示碎片比较多</td>
      </tr>
  </tbody>
</table>
<p><strong>网络流量相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_net_input_bytes_total</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_net_output_bytes_total</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>持久化相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_aof_enabled </code></td>
          <td>是否开启aof持久化</td>
      </tr>
      <tr>
          <td><code>redis_aof_last_cow_size_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_aof_last_rewite_duration_sec</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_aof_last_write_status</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_aof_last_bgrewrite_status</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_aof_rewite_in_progress</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_aof_rewite_shceduled</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_aof_current_rewrite_duration_sec </code></td>
          <td>aof rewrite耗时</td>
      </tr>
  </tbody>
</table>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_rdb_bgsave_in_progress</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rdb_changes_since_last_save</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rdb_current_bgsave_duration_sec</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rdb_last_bgsave_duration_sec</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rdb_last_bgsave_status</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rdb_last_cow_size_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rdb_last_save_timestamp_seconds</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>key相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_db_keys</code></td>
          <td>实例keys数量</td>
      </tr>
      <tr>
          <td><code>redis_db_avg_ttl_seconds</code></td>
          <td>平均过期时长</td>
      </tr>
      <tr>
          <td><code>redis_db_keys_expiring</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_expired_keys_total</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_expired_stale_percentage</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_evicted_keys_total</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_keyspace_hits_total </code></td>
          <td>缓存命中量</td>
      </tr>
      <tr>
          <td><code>redis_keyspace_misses_total </code></td>
          <td>未命中缓存量</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>redis_keyspace_hits_total<span style="color:#f92672">{</span>cluster_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;123&#34;</span><span style="color:#f92672">})</span>/sum<span style="color:#f92672">(</span>redis_keyspace_hits_total<span style="color:#f92672">{</span>cluster_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;123&#34;</span><span style="color:#f92672">})</span>+sum<span style="color:#f92672">(</span>redis_keyspace_misses_total<span style="color:#f92672">{</span>cluster_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;123&#34;</span><span style="color:#f92672">})</span>
</span></span></code></pre></div><p><strong>客户端连接相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_connected_clients</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_connected_slaves</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_config_maxclients</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rejected_connections_total</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_connections_received_total</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_blocked_clients</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_client_recent_max_input_buffer_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_client_recent_max_output_buffer_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_config_client_output_buffer_limit_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_config_client_output_buffer_limit_overcome_seconds</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>慢日志</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_slowlog_last_id</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_slowlog_length</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>性能</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_last_slow_execution_duration_seconds</code></td>
          <td>最慢的执行耗时</td>
      </tr>
      <tr>
          <td><code>redis_commands_duration_seconds_total</code></td>
          <td>命令出来耗时</td>
      </tr>
      <tr>
          <td><code>redis_commands_processed_total</code></td>
          <td>已处理命令的数量</td>
      </tr>
      <tr>
          <td><code>redis_commands_total</code></td>
          <td>每一个命令调用的次数</td>
      </tr>
  </tbody>
</table>
<p>tps</p>
<p>QPS</p>
<p><strong>主从复制相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_connected_slaves</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_mem_clients_slaves</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_repl_backlog_first_byte_offset</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_repl_backlog_history_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_repl_backlog_is_active</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_replication_backlog_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_replica_partial_resync_accepted</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_replica_partial_resync_denied</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_replica_resyncs_full</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_master_repl_offset</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_second_repl_offset</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>startMasterSlave<span style="color:#f92672">()</span> <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>docker run -d --net<span style="color:#f92672">=</span>host --name<span style="color:#f92672">=</span>redis6379 redis:6.0.20 redis-server --bind 10.4.7.10 --port <span style="color:#ae81ff">6379</span> --daemonize no
</span></span><span style="display:flex;"><span>docker run -d --net<span style="color:#f92672">=</span>host --name<span style="color:#f92672">=</span>redis6380 redis:6.0.20 redis-server --bind 10.4.7.10 --port <span style="color:#ae81ff">6380</span> --daemonize no  --SLAVEOF 10.4.7.10 <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>docker run -d --net<span style="color:#f92672">=</span>host --name<span style="color:#f92672">=</span>redis6381 redis:6.0.20 redis-server --bind 10.4.7.10 --port <span style="color:#ae81ff">6381</span> --daemonize no  --SLAVEOF 10.4.7.10 <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>startSentinel<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> port in <span style="color:#ae81ff">26379</span> <span style="color:#ae81ff">26380</span> 26381;<span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run -d --net<span style="color:#f92672">=</span>host --name<span style="color:#f92672">=</span>sentinel<span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span> redis:6.0.20 sh -c <span style="color:#e6db74">&#34;echo &#39;sentinel monitor mymaster 10.4.7.10 6379 2\n&#39; &gt;/etc/redis-sentinel.conf;echo &#39;sentinel down-after-milliseconds mymaster 30000\n&#39; &gt;&gt;/etc/redis-sentinel.conf;echo &#39;sentinel parallel-syncs mymaster 1\n&#39; &gt;&gt;/etc/redis-sentinel.conf;echo &#39;sentinel failover-timeout mymaster 180000\n&#39; &gt;&gt;/etc/redis-sentinel.conf; redis-server /etc/redis-sentinel.conf --sentinel --bind 10.4.7.10 --port </span><span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74"> --daemonize no&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stop<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>docker rm -f sentinel26379
</span></span><span style="display:flex;"><span>docker rm -f sentinel26380
</span></span><span style="display:flex;"><span>docker rm -f sentinel26381
</span></span><span style="display:flex;"><span>docker rm -f redis6379
</span></span><span style="display:flex;"><span>docker rm -f redis6380
</span></span><span style="display:flex;"><span>docker rm -f redis6381
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>stop
</span></span><span style="display:flex;"><span>startMasterSlave
</span></span><span style="display:flex;"><span>startSentinel
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@master01:~# docker exec -it sentinel26379 redis-cli -p <span style="color:#ae81ff">26379</span> -h 10.4.7.10 info sentinel
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sentinel</span>
</span></span><span style="display:flex;"><span>sentinel_masters:1
</span></span><span style="display:flex;"><span>sentinel_tilt:0
</span></span><span style="display:flex;"><span>sentinel_running_scripts:0
</span></span><span style="display:flex;"><span>sentinel_scripts_queue_length:0
</span></span><span style="display:flex;"><span>sentinel_simulate_failure_flags:0
</span></span><span style="display:flex;"><span>master0:name<span style="color:#f92672">=</span>mymaster,status<span style="color:#f92672">=</span>ok,address<span style="color:#f92672">=</span>10.4.7.10:6379,slaves<span style="color:#f92672">=</span>2,sentinels<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis_sentinel_master_ckquorum_status
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-31569474fbadc76b9e8fdcd9f370ea84">3.3.10.7 - mysql-exporter</h1>
    <div class="lead">mysql-exporter|exporter|prometheus</div>
	

<div class="alert alert-warning" role="alert">


    mysql-exporter(0.17.2版本) 支持mysql&gt;=5.6 、MariaDB &gt;= 10.3

</div>

<ol>
<li>
<p><strong><a href="https://github.com/prometheus/mysqld_exporter" target="_blank">部署安装</a></strong></p>
<blockquote>
<p>容器镜像 <code>prom/mysqld-exporter</code></p>
</blockquote>
<p><em>安装exporter</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.17.2/mysqld_exporter-0.17.2.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>tar xf mysqld_exporter-0.17.2.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>mv mysqld_exporter-0.17.2.linux-amd64/mysqld_exporter /usr/bin/
</span></span><span style="display:flex;"><span>rm -fr mysqld_exporter*
</span></span></code></pre></div><p><em>添加监控用户</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>CREATE USER <span style="color:#e6db74">&#39;exporter&#39;</span>@<span style="color:#e6db74">&#39;%&#39;</span> IDENTIFIED BY <span style="color:#e6db74">&#39;GlKUhymaO76zY&#39;</span> WITH MAX_USER_CONNECTIONS 3;
</span></span><span style="display:flex;"><span>GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO <span style="color:#e6db74">&#39;exporter&#39;</span>@<span style="color:#e6db74">&#39;%&#39;</span>;
</span></span></code></pre></div><p><em>启动服务</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/usr/lib/systemd/system/mysql_exporter_mysql01_3306.service<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description = mysql-exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation = https://github.com/prometheus/mysqld_exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After = network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=Simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;MYSQLD_EXPORTER_PASSWORD=GlKUhymaO76zY&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/mysqld_exporter \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--mysqld.address 10.128.99.158:6301 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--mysqld.username exporter 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Group=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CPUQuota=20%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MemoryLimit=128m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable mysql_exporter_mysql01_3306 --now 
</span></span><span style="display:flex;"><span>systemctl status mysql_exporter_mysql01_3306
</span></span></code></pre></div></li>
<li>
<p><strong>添加prometheus配置</strong></p>
<p>指标接口： <code>http://127.0.0.1:9104/metrics</code></p>
<p>类似于blackbox,可以采集其他redis: <code>http://127.0.0.1:9104/probe?127.0.0.1:3306</code></p>
</li>
<li>
<p><strong>dashboar和告警</strong></p>
<p><strong>进程相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th>判断依据</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>mysql_up</code></td>
          <td>进程状态1表示正常</td>
      </tr>
      <tr>
          <td><code>mysql_uptime_in_seconds</code></td>
          <td>启动时长</td>
      </tr>
      <tr>
          <td><code>mysql_instance_info</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>内存相关</strong></p>
<p><strong>网络流量相关</strong></p>
<p><strong>持久化相关</strong></p>
<p><strong>客户端连接相关</strong></p>
<p><strong>慢日志</strong></p>
<p><strong>性能</strong></p>
<p>tps</p>
<p>QPS</p>
<p><strong>主从复制相关</strong></p>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b668d0cb90e19dfdc045d5bb7bc1a106">3.3.10.8 - mongo-exporter</h1>
    <div class="lead">mongo-exporter|exporter|prometheus</div>
	

<div class="alert alert-warning" role="alert">


    mysql-exporter(0.40版本) 支持mongodb&gt;=4.4

</div>

<ol>
<li>
<p><strong><a href="https://github.com/percona/mongodb_exporter" target="_blank">部署安装</a></strong></p>
<blockquote>
<p>容器镜像 <code>percona/mongodb_exporter:0.40</code></p>
</blockquote>
<p><em>安装exporter</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"></code></pre></div><p><em>添加监控用户</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"></code></pre></div><p><em>启动服务</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/usr/lib/systemd/system/mysql_exporter_mysql01_3306.service<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description = mysql-exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation = https://github.com/prometheus/mysqld_exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After = network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=Simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;MYSQLD_EXPORTER_PASSWORD=GlKUhymaO76zY&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/mysqld_exporter \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--mysqld.address 10.128.99.158:6301 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--mysqld.username exporter 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Group=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CPUQuota=20%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MemoryLimit=128m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable mysql_exporter_mysql01_3306 --now 
</span></span><span style="display:flex;"><span>systemctl status mysql_exporter_mysql01_3306
</span></span></code></pre></div></li>
<li>
<p><strong>添加prometheus配置</strong></p>
<p>指标接口： <code>http://127.0.0.1:9104/metrics</code></p>
<p>类似于blackbox,可以采集其他redis: <code>http://127.0.0.1:9104/probe?127.0.0.1:3306</code></p>
</li>
<li>
<p><strong>dashboar和告警</strong></p>
<p><strong>进程相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th>判断依据</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>mysql_up</code></td>
          <td>进程状态1表示正常</td>
      </tr>
      <tr>
          <td><code>mysql_uptime_in_seconds</code></td>
          <td>启动时长</td>
      </tr>
      <tr>
          <td><code>mysql_instance_info</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>内存相关</strong></p>
<p><strong>网络流量相关</strong></p>
<p><strong>持久化相关</strong></p>
<p><strong>客户端连接相关</strong></p>
<p><strong>慢日志</strong></p>
<p><strong>性能</strong></p>
<p>tps</p>
<p>QPS</p>
<p><strong>主从复制相关</strong></p>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-12149c930cfe1dac8487f4da8d8be7d2">3.3.10.9 - prometheus-sdk</h1>
    <div class="lead">prometheus-sdk|exporter|prometheus</div>
	<p>promethues 为用户提供了自定义开发exporter的<a href="https://prometheus.io/docs/instrumenting/clientlibs/" target="_blank">sdk</a>, 支持大多数常见语言。</p>

  
  

<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>sdk</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="python" aria-controls="tabs-00-01" aria-selected="true">
        python
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="golang" aria-controls="tabs-00-02" aria-selected="false">
        golang
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> http.server
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> prometheus_client <span style="color:#f92672">import</span> start_http_server
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> prometheus_client <span style="color:#f92672">import</span> Counter  <span style="color:#75715e">#从prometheus_client 库导入 Counter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>REQUESTS <span style="color:#f92672">=</span> Counter(<span style="color:#e6db74">&#39;hello_worlds_total&#39;</span>,<span style="color:#e6db74">&#39;Hello Worlds requested.&#39;</span>) <span style="color:#75715e"># 定义`hello_worlds_total` 指标，帮助信息为&#39;Hello Worlds requested.&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyHandler</span>(http<span style="color:#f92672">.</span>server<span style="color:#f92672">.</span>BaseHTTPRequestHandler):
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_GET</span>(self):
</span></span><span style="display:flex;"><span>         REQUESTS<span style="color:#f92672">.</span>inc()  <span style="color:#75715e"># 请求后自动+1</span>
</span></span><span style="display:flex;"><span>         self<span style="color:#f92672">.</span>send_response(<span style="color:#ae81ff">200</span>)
</span></span><span style="display:flex;"><span>         self<span style="color:#f92672">.</span>end_headers()
</span></span><span style="display:flex;"><span>         self<span style="color:#f92672">.</span>wfile<span style="color:#f92672">.</span>write(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello World&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>   start_http_server(<span style="color:#ae81ff">8000</span>)
</span></span><span style="display:flex;"><span>   server <span style="color:#f92672">=</span> http<span style="color:#f92672">.</span>server<span style="color:#f92672">.</span>HTTPServer((<span style="color:#e6db74">&#39;localhost&#39;</span>, <span style="color:#ae81ff">8001</span>), MyHandler)
</span></span><span style="display:flex;"><span>   server<span style="color:#f92672">.</span>serve_forever()
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/prometheus/client_golang/prometheus&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/prometheus/client_golang/prometheus/promhttp&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;app&#34;</span>: <span style="color:#e6db74">&#34;ping&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;env&#34;</span>: <span style="color:#e6db74">&#34;pro&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pingCounter</span> = <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">NewCounter</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">CounterOpts</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Namespace</span>:   <span style="color:#e6db74">&#34;pay&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Subsystem</span>:   <span style="color:#e6db74">&#34;wechart&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Name</span>:        <span style="color:#e6db74">&#34;ping_request_count&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Help</span>:        <span style="color:#e6db74">&#34;No of request handled by Ping handler&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ConstLabels</span>: <span style="color:#a6e22e">l</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pingGuage</span> = <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">NewGauge</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">GaugeOpts</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Namespace</span>:   <span style="color:#e6db74">&#34;pay&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Subsystem</span>:   <span style="color:#e6db74">&#34;wechart&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Name</span>:        <span style="color:#e6db74">&#34;ping_request_gauge&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Help</span>:        <span style="color:#e6db74">&#34;No of request handled by Ping handler&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ConstLabels</span>: <span style="color:#a6e22e">l</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//http.HandleFunc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/ping&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">pingCounter</span>.<span style="color:#a6e22e">Inc</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">pingGuage</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#ae81ff">2.2</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprint</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;pong&#34;</span>)
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 注册metrics</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">MustRegister</span>(<span style="color:#a6e22e">pingCounter</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">MustRegister</span>(<span style="color:#a6e22e">pingGuage</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#e6db74">&#34;/metrics&#34;</span>, <span style="color:#a6e22e">promhttp</span>.<span style="color:#a6e22e">Handler</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//启动服务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:9998&#34;</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
</div>


</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b0b1ba15faa9a6ebeb9137c6c9e73f6a">3.3.11 - alertmanager</h1>
    
	<h3 id="告警规划">告警规划</h3>
<blockquote>
<p>要求：准确，及时，告警信息明确, 告警频率合理</p>
</blockquote>
<ul>
<li>
<p>漏报误报 ==》</p>
<ol>
<li>promethues 告警规则和评估周期</li>
</ol>
</li>
<li>
<p>针对通知信息不足，接收告警人员无法通过告警信息判断出当前出现的问题</p>
<ol>
<li>
<p>调整告警模版</p>
</li>
<li>
<p>通过开发脚本程序拦截告警添加更多标签，告警中新增富文本例如走势图</p>
</li>
</ol>
</li>
<li>
<p>告警滋扰 ==》</p>
<ol>
<li>通过分组，让同类告警分批次发出</li>
<li>路由，按照需要接收告警的人收告警
<ul>
<li>按照业务</li>
<li>按照故障等级</li>
</ul>
</li>
<li>抑制手段</li>
</ol>
</li>
</ul>
<p>alertmanger 负责管理告警的静默、抑制、聚合和发送告警，常见告警等级和处理时效。</p>
<table>
  <thead>
      <tr>
          <th>等级</th>
          <th>阿里</th>
          <th>腾讯</th>
          <th>先知</th>
          <th>海鸥</th>
          <th>定义方式</th>
          <th>认领（接手）时间</th>
          <th>解决（关闭）时间</th>
          <th>通知渠道</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>P1</td>
          <td>严重</td>
          <td>致命</td>
          <td>事故</td>
          <td>致命</td>
          <td>需要立即联系管理团队的关键性问题</td>
          <td>1min</td>
          <td>10min</td>
          <td>电话+短信+IM通知（钉钉等）配合升级策略确保问题在规定时间内处理</td>
      </tr>
      <tr>
          <td>P2</td>
          <td>警告</td>
          <td>严重</td>
          <td>故障</td>
          <td>严重</td>
          <td>严重影响许多客户使用产品的能力的关键性系统问题</td>
          <td>10min</td>
          <td>1h</td>
          <td>短信+IM通知（钉钉等）配合升级策略确保问题在规定时间内处理</td>
      </tr>
      <tr>
          <td>P3</td>
          <td>优化</td>
          <td>警告</td>
          <td>告警</td>
          <td>警告</td>
          <td>需要运维人员立即关注的稳定性问题或影响客户的小问题</td>
          <td>1h</td>
          <td>24h</td>
          <td>短信+IM通知（钉钉等）</td>
      </tr>
      <tr>
          <td>P4</td>
          <td>通知</td>
          <td>提示</td>
          <td>信息</td>
          <td>通知</td>
          <td>需要采取行动的小问题，但不影响客户使用产品</td>
          <td>24h</td>
          <td>7Day</td>
          <td>IM通知（钉钉等）</td>
      </tr>
  </tbody>
</table>
<h3 id="架构图">架构图</h3>
<p><img src="/docs/prometheus/alertmanager/img/%E5%91%8A%E8%AD%A6.png" alt="告警"></p>
<p><a href="https://www.cnblogs.com/fan-gx/p/12321351.html" target="_blank">curl</a></p>
<p><a href="https://blog.csdn.net/qq_43684922/article/details/126803822" target="_blank">【博客484】alertmanager&mdash;&ndash;告警处理源码剖析_alertmanager 重复告警_lulu的云原生笔记的博客-CSDN博客</a></p>
<p><a href="https://blog.51cto.com/starsliao/5763175" target="_blank">Alertmanager—配置详解(记得看完)_StarsL的技术博客_51CTO博客</a></p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cdd3077d065775a419d9597d5a6c38ba">3.3.11.1 - 部署alertmanager</h1>
    <div class="lead">install|alertmanager|prometheus</div>
	<h3 id="二进制安装">二进制安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /data/alertmanager/<span style="color:#f92672">{</span>bin,conf/templates,data<span style="color:#f92672">}</span> -p
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf alertmanager-0.26.0.linux-amd64.tar.gz 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mv alertmanager-*.linux-amd64/alertmanager /data/alertmanager/bin/
</span></span><span style="display:flex;"><span>mv alertmanager-*.linux-amd64/amtool /data/alertmanager/bin/
</span></span><span style="display:flex;"><span>mv alertmanager-*.linux-amd64/alertmanager.yml /data/alertmanager/conf/
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown -R prometheus:prometheus /data/alertmanager
</span></span></code></pre></div><blockquote>
<p>如果需要使用反向代理时启动参数新增： <code>--web.external-url=&quot;http://127.0.0.1:9003/alert&quot;</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/alertmanager.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=alertmanager service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStartPre=/data/alertmanager/bin/amtool check-config /data/alertmanager/conf/alertmanager.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/alertmanager/bin/alertmanager \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --config.file=/data/alertmanager/conf/alertmanager.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --storage.path=/data/alertmanager/data \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --data.retention=120h \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --web.external-url=http://prometheus.pytc.com/alert
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable alertmanager --now
</span></span><span style="display:flex;"><span>systemctl status alertmanager
</span></span></code></pre></div><p>prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">alerting</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">alertmanagers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">9093</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path_prefix</span>: <span style="color:#ae81ff">/alert</span>
</span></span></code></pre></div><h4 id="告警接收器"><a href="https://prometheus.io/docs/alerting/latest/configuration/#receiver" target="_blank">告警接收器</a></h4>
<ul>
<li>
<p><input checked="" disabled="" type="checkbox"> webhook</p>
<blockquote>
<p>通过webhook 接收后可以放入数据库、消息队列等.</p>
</blockquote>
<ol>
<li>
<p>创建alertmanager配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee  /data/alertmanager/conf/alertmanager.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">route:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  receiver: &#39;webhook&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_by: [&#39;alertname&#39;,&#39;cluster&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_wait: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_interval: 5m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">receivers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;webhook&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - url: &#39;http://127.0.0.1:5001/&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>编写一个webhook接收告警

    
    
    
  <ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>webhook</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="python" aria-controls="tabs-00-01" aria-selected="true">
        python
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="golang" aria-controls="tabs-00-02" aria-selected="false">
        golang
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <pre><code>tee app.py&lt;&lt;EOF

import json
 
from flask import Flask, request, jsonify
# import smtplib 
 
app = Flask(__name__)
 
@app.route('/', methods=['POST'])
def alert_webhook():
    # 获取post 请求传递是所有信息
    data=request.get_data()
    print(json.loads(data))
    return jsonify({'status': 'ok'})
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5001, debug=True)
EOF

python3 app.py
</code></pre>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <pre><code>  package main

  import (
    &quot;fmt&quot;
    &quot;io&quot;
    &quot;net/http&quot;
  )

  func handlePostRequest(w http.ResponseWriter, r *http.Request) {

    body, _ := io.ReadAll(r.Body)
    defer r.Body.Close()

    fmt.Println(string(body))
    //fmt.Fprint(w, &quot;POST request received&quot;)
  }

  func main() {
    http.HandleFunc(&quot;/&quot;, handlePostRequest)
    http.ListenAndServe(&quot;:5001&quot;, nil)
  }
</code></pre>

    </div>
</div>
</p>
</li>
<li>
<p>触发一条告警</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;[
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;labels&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;alertname&#34;: &#34;cpuHigh&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;instance&#34;: &#34;node01:9100&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;job&#34;: &#34;node_exporter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;severity&#34;: &#34;warning&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;annotations&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;description&#34;: &#34;node01:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 89.99%)&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;summary&#34;: &#34;Instance node01:9100 cpu usage more than 85%&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;generatorURL&#34;: &#34;http://prometheus.pytc.com/prom&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]&#39;</span> <span style="color:#e6db74">&#34;http://127.0.0.1:9093/alert/api/v2/alerts&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>alertmanager 接收到了一条告警信息</p>
<p><img src="/docs/prometheus/alertmanager/img/alertmanager01.png" alt="alertmanager01.png"></p>
</li>
<li>
<p>webhook接收到告警信息</p>
<blockquote>
<p><font color=#faf>[Warning]</font></p>
<p>细心的朋友发现<code>generatorurl</code> 和 <code>externalurl</code> 显示异常，可以通过修改启动命令调整。对于运行在容器中尤为有用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./prometheus --config.file<span style="color:#f92672">=</span>prometheus.yml --web.external-url<span style="color:#f92672">=</span>http://x.x.x.x:9090
</span></span><span style="display:flex;"><span>./alertmanager --config.file<span style="color:#f92672">=</span>alertmanager.yml --web.external-url<span style="color:#f92672">=</span>http://x.x.x.x:9093
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;receiver&#34;</span>: <span style="color:#e6db74">&#34;webhook&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;firing&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;alerts&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;firing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;labels&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;alertname&#34;</span>: <span style="color:#e6db74">&#34;cpuHigh&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;instance&#34;</span>: <span style="color:#e6db74">&#34;node01:9100&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;job&#34;</span>: <span style="color:#e6db74">&#34;node_exporter&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;severity&#34;</span>: <span style="color:#e6db74">&#34;warning&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;annotations&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;node01:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 89.99%)&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;summary&#34;</span>: <span style="color:#e6db74">&#34;Instance node01:9100 cpu usage more than 85%&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;startsAt&#34;</span>: <span style="color:#e6db74">&#34;2025-01-12T16:04:33.208058295+08:00&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;endsAt&#34;</span>: <span style="color:#e6db74">&#34;0001-01-01T00:00:00Z&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;generatorURL&#34;</span>: <span style="color:#e6db74">&#34;http://127.0.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;fingerprint&#34;</span>: <span style="color:#e6db74">&#34;d2a2fb28d1488138&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;groupLabels&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;alertname&#34;</span>: <span style="color:#e6db74">&#34;cpuHigh&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;commonLabels&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;alertname&#34;</span>: <span style="color:#e6db74">&#34;cpuHigh&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;instance&#34;</span>: <span style="color:#e6db74">&#34;node01:9100&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;job&#34;</span>: <span style="color:#e6db74">&#34;node_exporter&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;severity&#34;</span>: <span style="color:#e6db74">&#34;warning&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;commonAnnotations&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;node01:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 89.99%)&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;summary&#34;</span>: <span style="color:#e6db74">&#34;Instance node01:9100 cpu usage more than 85%&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;externalURL&#34;</span>: <span style="color:#e6db74">&#34;http://:9093/alert&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#e6db74">&#34;4&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;groupKey&#34;</span>: <span style="color:#e6db74">&#34;{}:{alertname=\&#34;cpuHigh\&#34;}&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;truncatedAlerts&#34;</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
</li>
<li>
<p><input checked="" disabled="" type="checkbox"> <a href="https://prometheus.io/docs/alerting/latest/configuration/#email_config" target="_blank">email</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/alertmanager/conf/alertmanager.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 全局定义
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # The smarthost 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_smarthost: &#39;smtp.qq.com:465&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # from who send email
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_from: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_auth_username: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_auth_password: &#39;kqaexaxpbrbdbajd&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  #
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_require_tls: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 告警媒介  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">receivers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;email&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  email_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - to: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    send_resolved: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;webhook&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - url: &#39;http://192.168.0.20:5001/&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 告警路由  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">route:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 根路由，任何子路由不能匹配的路由都会发送到根路由
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  receiver: &#39;email&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_by: [&#39;alertname&#39;,&#39;cluster&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_wait: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_interval: 5m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  routes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - receiver: &#39;webhook&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - alertname=~&#34;disk*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 告警模版 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">templates:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- &#39;/data/alertmanager/conf/templates/*.tmpl&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>告警模版支持html格式的渲染</p>
<ul>
<li>
<p>格式示例一：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/alertmanager/conf/templates/email.tmpl <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ define &#34;email.default.html&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ range .Alerts }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ if  eq .Status &#34;firing&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;span style=&#34;background-color:red&#34;&gt;[{{.Status}}]&lt;/span&gt;| {{ .Annotations.summary }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警级别: {{ .Labels.severity }} 级&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警名称: {{ .Labels.alertname }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警主机: {{ .Labels.instance }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警详情: {{ .Annotations.description }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        触发时间: {{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ else if eq .Status &#34;resolved&#34;  }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;span style=&#34;background-color:green&#34;&gt;[{{.Status}}]&lt;/span&gt;  {{ .Annotations.summary }} 已恢复正常&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警级别: {{ .Labels.severity }} 级&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警名称: {{ .Labels.alertname }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警主机: {{ .Labels.instance }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警详情: {{ .Annotations.description }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        恢复时间: {{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>模版效果</p>
<p><img src="/docs/prometheus/alertmanager/img/email01.png" alt="email01.png"></p>
<p><img src="/docs/prometheus/alertmanager/img/email02.png" alt="email02.png"></p>
</li>
<li>
<p>格式示例二：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/alertmanager/conf/templates/email.tmpl <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ define &#34;email.default.html&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;table border=1&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;告警来源&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;告警级别&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;告警名称&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;告警主机&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;告警主题&lt;/th&gt;   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;告警详情&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;触发时间&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ range .Alerts }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;tr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;prometheus_alert&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;{{ .Labels.severity }}&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;{{ .Labels.alertname }} &lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;{{ .Labels.instance }}&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;{{ .Annotations.summary }}&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;{{ .Annotations.description }}&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;{{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }}&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;/tr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/table&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>模版效果</p>
<p><img src="/docs/prometheus/alertmanager/img/email03.png" alt="email03"></p>
<p><img src="/docs/prometheus/alertmanager/img/email04.png" alt="email04.png"></p>
</li>
</ul>
</li>
<li>
<p><input checked="" disabled="" type="checkbox"> <a href="https://prometheus.io/docs/alerting/latest/configuration/#wechat_config" target="_blank">wechart</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/alertmanager/conf/alertmanager.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # The smarthost 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_smarthost: &#39;smtp.qq.com:465&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # from who send email
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_from: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_auth_username: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_auth_password: &#39;kqaexaxpbrbdbajd&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  #
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_require_tls: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">route:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  receiver: &#39;wechat&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_by: [&#39;alertname&#39;,&#39;cluster&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_wait: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_interval: 5m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">receivers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;email&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  email_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - to: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    send_resolved: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;wechat&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  wechat_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 企业ID。我的企业--企业信息中查看
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - corp_id: &#39;wwa5d04854e39e7784&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 应用ID。应用管理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    agent_id: &#39;1000002&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 应用secret。应用管理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    api_secret: &#39;Rc8nQbF8EiCvO1JP19S9vceTI4LJaNt-j-H1pCBba2U&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 发送给谁
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    to_user: &#34;@all&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 发送给哪个部门。部门ID， 在通讯录中查看
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    to_party: &#39;2&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">templates:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- &#39;/data/alertmanager/conf/templates/*.tmpl&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/alertmanager/conf/templates/wechat.tmpl <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ define &#34;wechat.default.message&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">状态: {{ .Status }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ range .Alerts }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">==============监控报警==============
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警程序: prometheus_alert
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警级别: {{ .Labels.severity }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警名称: {{ .Labels.alertname }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警主机: {{ .Labels.instance }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警主题: {{ .Annotations.summary }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警详情: {{ .Annotations.description }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">触发事件: {{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p><input checked="" disabled="" type="checkbox"> dingtalk</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/alertmanager/conf/alertmanager.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # The smarthost 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_smarthost: &#39;smtp.qq.com:465&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # from who send email
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_from: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_auth_username: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_auth_password: &#39;kqaexaxpbrbdbajd&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  #
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_require_tls: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">route:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  receiver: &#39;dingtalk&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_by: [&#39;alertname&#39;,&#39;cluster&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_wait: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_interval: 5m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">receivers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;email&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  email_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - to: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    send_resolved: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;wechat&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  wechat_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 企业ID。我的企业--企业信息中查看
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - corp_id: &#39;wwa5d04854e39e7784&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 应用ID。应用管理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    agent_id: &#39;1000002&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 应用secret。应用管理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    api_secret: &#39;Rc8nQbF8EiCvO1JP19S9vceTI4LJaNt-j-H1pCBba2U&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 发送给谁
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    to_user: &#34;@all&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 发送给哪个部门。部门ID， 在通讯录中查看
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    to_party: &#39;2&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;dingtalk&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - url: &#39;http://127.0.0.1:8060/dingtalk/webhook1/send&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">templates:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- &#39;/data/alertmanager/conf/templates/*.tmpl&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>安装钉钉webhook</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/timonwong/prometheus-webhook-dingtalk/main/web/ui/react-app/src/pages/PlaygroundDemoAlert.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 测试prometheus-webhook-dingtalk 是否可以使用</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master prometheus<span style="color:#f92672">]</span><span style="color:#75715e"># curl -X POST -d&#39;@PlaygroundDemoAlert.json&#39; http://10.4.7.10:8060/dingtalk/webhook1/send </span>
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /data/dingtalk/<span style="color:#f92672">{</span>bin,conf,conf/templates<span style="color:#f92672">}</span> -p
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/dingtalk/conf/config.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">templates:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- &#34;/prometheus-webhook-dingtalk/templates/*.tmpl&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targets:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook1:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url: https://oapi.dingtalk.com/robot/send?access_token=2a8703f74d0960dd8effc6b846c7473520363e4c171fbdfa044b586df3e29be0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # secret for signature
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    secret: SEC2475a4ecdfae996614c6310b18bf948ce95b4c5df306cf75b2842b7a061bba43
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    message:  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      text: &#39;{{ template &#34;ding.link.content&#34; . }}&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/dingtalk/bin/start.sh <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker rm -f dingtalk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker run --name dingtalk -d \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--restart=always \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-p8060:8060 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-v /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-v /data/dingtalk/conf/config.yml:/prometheus-webhook-dingtalk/config.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-v /data/dingtalk/conf/templates:/prometheus-webhook-dingtalk/templates \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">timonwong/prometheus-webhook-dingtalk:v2.0.0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config.file=/prometheus-webhook-dingtalk/config.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.enable-ui \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.enable-lifecycle \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log.level=debug
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http://192.168.0.161:8060/ui
</span></span></code></pre></div><p>格式示例一：</p>
<blockquote>
<p>修改后重启webhook</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/dingtalk/conf/templates/dingtalk.tmpl <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ define &#34;ding.link.content&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">状态: {{ .Status }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ range .Alerts }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">==============监控报警==============
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警程序: prometheus_alert
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警级别: {{ .Labels.severity }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警名称: {{ .Labels.alertname }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警主机: {{ .Labels.instance }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警主题: {{ .Annotations.summary }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警详情: {{ .Annotations.description }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">触发事件: {{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>格式示例二：</p>
<blockquote>
<p>修改后重启webhook</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/dingtalk/conf/templates/dingtalk.tmpl <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ define &#34;ding.link.content&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">状态: {{ .Status }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ range .Alerts }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">==============监控报警==============
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  | 告警程序         | 告警级别               | 告警名称                | 告警主机               | 告警主题                   | 告警详情                       | 告警时间                                     |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  | ---------------- | ---------------------- | ----------------------- | ---------------------- | -------------------------- | ------------------------------ | -------------------------------------------- |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  | prometheus_alert | {{ .Labels.severity }} | {{ .Labels.alertname }} | {{ .Labels.instance }} | {{ .Annotations.summary }} | {{ .Annotations.description }} | {{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }} |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>格式示例三：</p>
<blockquote>
<p>修改后重启webhook</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/dingtalk/conf/templates/dingtalk.tmpl <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ define &#34;ding.link.content&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">![](https://img1.baidu.com/it/u=1546227440,2897989905&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=889&amp;h=500)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ range .Alerts }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 【{{ .Status }}】
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&gt;【告警主题】&lt;br&gt; {{ .Annotations.summary }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&gt;【告警描述】&lt;br&gt; {{ .Annotations.description }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&gt;【触发时间】{{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[查看详情](http://baidu.com)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p><img src="/docs/prometheus/alertmanager/img/dingtalk.png" alt="dingtalk"></p>
</li>
<li>
<p><input disabled="" type="checkbox"> message</p>
</li>
</ul>
<h3 id="高可用">高可用</h3>
<blockquote>
<p>集群间通过 gossip协议 管理成员和检测成员故障，集群成员默认通过<code>9094</code> 通讯，客户端通过<code>9093</code> 与alertmanager 通讯。</p>
<p>集群成员间并不存在主节点，所有节点对等，<code>alertmanager.yml</code> 配置文件内容相同，即使是3个节点的集群中2个成员都宕机也不影响功能</p>
</blockquote>
<p><strong>节点1：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/alertmanager.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=alertmanager service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStartPre=/data/alertmanager/bin/amtool check-config /data/alertmanager/conf/alertmanager.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/alertmanager/bin/alertmanager \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config.file=/data/alertmanager/conf/alertmanager.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--storage.path=&#34;/data/alertmanager/data&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--data.retention=120h \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=&#34;:9093&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.listen-address=&#34;0.0.0.0:9094&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.251:9094 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.252:9094 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.253:9094
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p><strong>节点2：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/alertmanager.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=alertmanager service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStartPre=/data/alertmanager/bin/amtool check-config /data/alertmanager/conf/alertmanager.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/alertmanager/bin/alertmanager \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config.file=/data/alertmanager/conf/alertmanager.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--storage.path=&#34;/data/alertmanager/data&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--data.retention=120h \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=&#34;:9093&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.listen-address=&#34;0.0.0.0:9094&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.251:9094 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.252:9094 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.253:9094
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p><strong>节点3：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/alertmanager.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=alertmanager service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStartPre=/data/alertmanager/bin/amtool check-config /data/alertmanager/conf/alertmanager.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/alertmanager/bin/alertmanager \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config.file=/data/alertmanager/conf/alertmanager.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--storage.path=&#34;/data/alertmanager/data&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--data.retention=120h \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=&#34;:9093&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.listen-address=&#34;0.0.0.0:9094&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.251:9094 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.252:9094 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.253:9094
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h3 id="部署在k8s环境">部署在k8s环境</h3>
<blockquote>
<p><a href="https://github.com/turnbullpress/prometheusbook-code/blob/master/12-13/alertmanager.yml" target="_blank">https://github.com/turnbullpress/prometheusbook-code/blob/master/12-13/alertmanager.yml</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager-webui</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">monitoring</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/scrape</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/port</span>: <span style="color:#e6db74">&#34;9093&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">external-dns.alpha.kubernetes.io/hostname</span>: <span style="color:#ae81ff">alertmanager.quicknuke.com.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9093</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">monitoring</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9093</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">monitoring</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">quay.io/prometheus/alertmanager:master</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#34;sh&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#34;-c&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/bin/alertmanager</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">config.file=/etc/alertmanager/config.yml</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">web.listen-address=0.0.0.0:9093</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">cluster.listen-address=0.0.0.0:8001</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">storage.path=/alertmanager</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">cluster.peer=&#34;alertmanager-0.alertmanager.monitoring.svc:8001&#34;</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">cluster.peer=&#34;alertmanager-1.alertmanager.monitoring.svc:8001&#34;</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">cluster.peer=&#34;alertmanager-2.alertmanager.monitoring.svc:8001&#34;</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">log.level=debug</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">9093</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">web</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8001</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/api/v1/status</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">web</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/api/v1/status</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">web</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager-config-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/alertmanager/</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager-data-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/alertmanager/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager-config-volume</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMap</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager-server-conf</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager-data-volume</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">emptyDir</span>: {}
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-24c9374cc0495f3c971a09cf688a7112">3.3.11.2 - 配置alertmanager</h1>
    <div class="lead">config|alertmanager|prometheus</div>
	<h3 id="配置文件">配置文件</h3>
<p>alertmanager配置文件默认为 alertmanger.yaml主要包含5个顶级字段</p>
<pre class="mermaid">graph LR
A[alertmanager.yml]
B[&lt;a href=#global&gt;global&lt;/a&gt;]
C[&lt;a href=#route&gt;route&lt;/a&gt;]
D[&lt;a href=#receivers&gt;receivers&lt;/a&gt;]
E[&lt;a href=#template&gt;template&lt;/a&gt;]
F[&lt;a href=#inhibit_rules&gt;inhibit_rules&lt;/a&gt;]
A --&gt; B
A --&gt; C
A --&gt; D
A --&gt; E
A --&gt; F</pre>
<p><span id="global"><strong>global</strong></span></p>
<p>我们可以像这样什么都不定义</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The smarthost </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">smtp_smarthost</span>: <span style="color:#e6db74">&#39;smtp.qq.com:465&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># from who send email</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">smtp_from</span>: <span style="color:#e6db74">&#39;810654947@qq.com&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">smtp_auth_username</span>: <span style="color:#e6db74">&#39;810654947@qq.com&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">smtp_auth_password</span>: <span style="color:#e6db74">&#39;kqaexaxpbrbdbajd&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">smtp_require_tls</span>: <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p><span id="route"><a href="https://prometheus.io/docs/alerting/latest/configuration/#route" target="_blank"><strong>route</strong></a></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">route</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">receiver</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 通过报警规则中的label 来聚合报警</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group_by</span>: [<span style="color:#e6db74">&#39;alertname&#39;</span>,<span style="color:#e6db74">&#39;cluster&#39;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># When a new group of alerts is created, wait at</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># least &#39;group_wait&#39; to send the initial notification.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group_wait</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 在同一个分组中。第一个报警发出后,等待`group_interval`才会发下一个警报</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># If an alert has successfully been sent, wait &#39;repeat_interval&#39; to</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># resend them</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">repeat_interval</span>: <span style="color:#ae81ff">3h</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># match 和 match_re 在v1.0版本已经弃用</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">match</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[ &lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;labelvalue&gt;, ... ]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 使用正则匹配标签</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">match_re</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[ &lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;regex&gt;, ... ]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 子路由模块，拥有更高优先级</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">receiver</span>: <span style="color:#e6db74">&#39;database-pager&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group_wait</span>: <span style="color:#ae81ff">10s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">service=~&#34;mysql|cassandra&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">receiver</span>: <span style="color:#e6db74">&#39;frontend-pager&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group_by</span>: [<span style="color:#ae81ff">product, environment]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">team=&#34;frontend&#34;</span>
</span></span></code></pre></div><p><span id="receivers"><strong>receivers</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">receivers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">email_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">to</span>: <span style="color:#e6db74">&#39;xxxxx@.com&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">send_resolved</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p><span id="template"><strong>template</strong></span></p>
<p><span id="inhibit_rules"><a href="https://prometheus.io/docs/alerting/latest/configuration/#inhibit_rule" target="_blank"><strong>inhibit_rules</strong></a></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Inhibition rules allow to mute(静音) a alert according to another alert</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">route</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">inhibit_rules</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 同一alertname的警报，如果存在 `critical` 级别的报警，则抑制 `warning` 级别的警报</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_matchers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">severity=&#34;critical&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">target_matchers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">severity=&#34;warning&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># alertname 相等</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">equal</span>: [<span style="color:#e6db74">&#39;alertname&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># DEPRECATED: Use target_matchers below.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Matchers that have to be fulfilled in the alerts to be muted.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">target_match</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[ &lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;labelvalue&gt;, ... ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DEPRECATED: Use target_matchers below.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">target_match_re</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[ &lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;regex&gt;, ... ]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># A list of matchers that have to be fulfilled by the target </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># alerts to be muted.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">target_matchers</span>:
</span></span><span style="display:flex;"><span>  [ - <span style="color:#ae81ff">&lt;matcher&gt; ... ]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DEPRECATED: Use source_matchers below.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Matchers for which one or more alerts have to exist for the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># inhibition to take effect.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">source_match</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[ &lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;labelvalue&gt;, ... ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DEPRECATED: Use source_matchers below.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">source_match_re</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[ &lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;regex&gt;, ... ]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># A list of matchers for which one or more alerts have </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># to exist for the inhibition to take effect.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">source_matchers</span>:
</span></span><span style="display:flex;"><span>  [ - <span style="color:#ae81ff">&lt;matcher&gt; ... ]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Labels that must have an equal value in the source and target</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># alert for the inhibition to take effect.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[ equal</span>: <span style="color:#e6db74">&#39;[&#39;</span> <span style="color:#ae81ff">&lt;labelname&gt;, ... &#39;]&#39; ]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master prometheus<span style="color:#f92672">]</span><span style="color:#75715e"># curl http://10.4.7.10:9093/-/healthy </span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master prometheus<span style="color:#f92672">]</span><span style="color:#75715e"># curl http://10.4.7.10:9093/-/ready</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master prometheus<span style="color:#f92672">]</span><span style="color:#75715e"># curl -X POST http://10.4.7.10:9093/-/reload</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c5c6014e5263533687c85e13e12dcd41">3.3.11.3 - amtool</h1>
    <div class="lead">amtool|alertmanager|prometheus</div>
	<h3 id="amtool">amtool</h3>
<p><code>amtool</code> is a cli tool for interacting with the Alertmanager API.</p>
<p>go get github.com/prometheus/alertmanager/cmd/amtool</p>
<p>配置文件</p>
<blockquote>
<p>需要配置到<code>/etc/amtool/config.yml</code></p>
<p>或<code>$HOME/.confg/amtool/config.yml</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /etc/amtool/config.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alertmanager.url: http://127.0.0.1:9093
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">author: &#34;1209233066@qq.com&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">require-comment: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output: josn
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">date.format: &#34;2006-01-02 15:04:05 MST&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>命令</th>
          <th>子命令</th>
          <th>举例</th>
          <th>举例解释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>alert</td>
          <td></td>
          <td><font color=#78bd5b80>amtool alert</font></td>
          <td>查看所有告警</td>
      </tr>
      <tr>
          <td></td>
          <td>add</td>
          <td><font color=#6ed6c680>amtool alert add alertname=test labe-a=value-b </font></td>
          <td>添加一个名称为<code>test</code>的带有标签为：<code>labe-a=value-b</code>的告警</td>
      </tr>
      <tr>
          <td></td>
          <td>query</td>
          <td><font color=#bda85b80>amtool alert query alertname=test labe-a=value-b</font></td>
          <td>查看指定标签的告警</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td><font color=#bda85b80>amtool alert query alertname=test labe-a=value-b -o json</font></td>
          <td>json 格式展示告警详细信息</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td><font color=#bda85b80>amtool alert query alertname=test labe-a=value-b -o extended</font></td>
          <td>扩展格式显示告警</td>
      </tr>
      <tr>
          <td>silence</td>
          <td></td>
          <td><font color=#78bd5b80>amtool silence </font></td>
          <td>查看所有维护期的告警</td>
      </tr>
      <tr>
          <td></td>
          <td>add</td>
          <td><font color=#6ed6c680>amtool silence add alertname=test labe-a=value-b  &ndash;commen “this is test”</font></td>
          <td>添加一个名称为<code>test</code>的带有标签为：<code>labe-a=value-b</code>的维护期，默认1h</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td><font color=#6ed6c680>amtool silence add alertname=test labe-a=value-b  &ndash;commen “this is test” &ndash;duration=&ldquo;2h&rdquo;</font></td>
          <td>设置2h维护期</td>
      </tr>
      <tr>
          <td></td>
          <td>query</td>
          <td><font color=#bda85b80>amtool silence query alertname=test labe-a=value-b -o extended</font></td>
          <td>查看指定标签的维护期</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td><font color=#bda85b80>amtool silence query alertname=test labe-a=value-b -o json</font></td>
          <td>json 格式展示维护期的详细信息</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td><font color=#bda85b80>amtool silence query alertname=test labe-a=value-b -o extended</font></td>
          <td>扩展格式显示维护期</td>
      </tr>
      <tr>
          <td></td>
          <td>expire</td>
          <td><font color=#f63bce80>amtool silence expire 223eb624-f49d-498d-ac7d-34bb7570adea</font></td>
          <td>提前取消维护期(id 通过 amtool silence 查询)</td>
      </tr>
      <tr>
          <td>config</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>template</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>check-config</td>
          <td></td>
          <td>amtool check-config alertmanager.yml</td>
          <td></td>
      </tr>
  </tbody>
</table>

</div>



    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-1ecaff05acb725a9eaabec72c0c0fa35">告警收敛</h1>
	<div class="lead">告警收敛,减少告警噪音</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-26" class="text-body-secondary">Thursday, June 26, 2025</time>
        
	</div>
	<p>需求：
1.按照故障等级，故障名称进行告警收敛
顶级路由<code>group_wait</code> 和 <code>repeat_interval</code> 验证步骤：</p>
<ol>
<li>发送告警示例1，预期30s后收到告警</li>
<li>等待步骤1完成后，再次发送告警示例1，预期10m + 30s 后收到告警
顶级路由<code>group_interval</code>  验证步骤：</li>
<li>发送告警示例1，在过20s后发送告警示例2，预期在告警2发送后20s收到告警</li>
</ol>
<p>子路由 <code>group_wait</code> 和 <code>repeat_interval</code> 验证步骤：</p>
<ol>
<li>发送告警示例3，预期10m后收到告警</li>
<li>等待步骤1完成后，再次发送告警示例3，预期1h后收到告警</li>
</ol>
<p>子路由 <code>group_interval</code>  验证步骤：</p>
<ol>
<li>发送告警示例3，在过5m后发送告警示例4，预期在告警4发送后10m收到告警</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resolve_timeout</span>: <span style="color:#ae81ff">30m</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">route</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">receiver</span>: <span style="color:#e6db74">&#39;webhook&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group_by</span>: [<span style="color:#e6db74">&#39;alertname&#39;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group_wait</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">repeat_interval</span>: <span style="color:#ae81ff">10m</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">receiver</span>: <span style="color:#e6db74">&#39;webhook&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group_by</span>: [<span style="color:#e6db74">&#39;alertname&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group_wait</span>: <span style="color:#ae81ff">10m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group_interval</span>: <span style="color:#ae81ff">20m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">repeat_interval</span>: <span style="color:#ae81ff">1h</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">alertname=~&#34;database|web&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">severity=&#34;E4&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">receivers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;webhook&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">webhook_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">url</span>: <span style="color:#e6db74">&#39;http://127.0.0.1:5001&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">send_resolved</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div>
  
  
  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="告警示例1" aria-controls="tabs-00-00" aria-selected="true">
        告警示例1
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="告警示例2" aria-controls="tabs-00-01" aria-selected="false">
        告警示例2
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="告警示例3" aria-controls="tabs-00-02" aria-selected="false">
        告警示例3
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="告警示例4" aria-controls="tabs-00-03" aria-selected="false">
        告警示例4
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;[
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;labels&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;alertname&#34;: &#34;cpuHigh&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;instance&#34;: &#34;node01:9100&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;job&#34;: &#34;node_exporter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;severity&#34;: &#34;E3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;annotations&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;description&#34;: &#34;node01:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 89.99%)&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;summary&#34;: &#34;Instance node01:9100 cpu usage more than 85%&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;generatorURL&#34;: &#34;http://prometheus.pytc.com/prom&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]&#39;</span> <span style="color:#e6db74">&#34;http://127.0.0.1:9093/alert/api/v2/alerts&#34;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;[
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;labels&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;alertname&#34;: &#34;cpuHigh&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;instance&#34;: &#34;node02:9100&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;job&#34;: &#34;node_exporter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;severity&#34;: &#34;E3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;annotations&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;description&#34;: &#34;node02:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 99.99%)&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;summary&#34;: &#34;Instance node02:9100 cpu usage more than 85%&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;generatorURL&#34;: &#34;http://prometheus.pytc.com/prom&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]&#39;</span> <span style="color:#e6db74">&#34;http://127.0.0.1:9093/alert/api/v2/alerts&#34;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;[
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;labels&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;alertname&#34;: &#34;database&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;instance&#34;: &#34;node01:9100&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;job&#34;: &#34;node_exporter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;severity&#34;: &#34;E3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;annotations&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;description&#34;: &#34;node01:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 89.99%)&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;summary&#34;: &#34;Instance node01:9100 cpu usage more than 85%&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;generatorURL&#34;: &#34;http://prometheus.pytc.com/prom&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]&#39;</span> <span style="color:#e6db74">&#34;http://127.0.0.1:9093/alert/api/v2/alerts&#34;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;[
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;labels&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;alertname&#34;: &#34;database&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;instance&#34;: &#34;node01:9100&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;job&#34;: &#34;node_exporter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;severity&#34;: &#34;E4&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;annotations&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;description&#34;: &#34;node01:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 89.99%)&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;summary&#34;: &#34;Instance node01:9100 cpu usage more than 85%&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;generatorURL&#34;: &#34;http://prometheus.pytc.com/prom&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]&#39;</span> <span style="color:#e6db74">&#34;http://127.0.0.1:9093/alert/api/v2/alerts&#34;</span>
</span></span></code></pre></div>
    </div>
</div>


</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3c434868253797ecc1f1e40600c22b80">3.3.12 - monitor</h1>
    <div class="lead">exporter|prometheus</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-8d14d03086c49edb38caab12c6d62a82">3.3.12.1 - prometheus</h1>
    
	<ol>
<li>
<p>部署安装</p>
<p>参见部署<a href="zh-cn/%e5%ae%89%e8%a3%85promethues">prometheus</a></p>
</li>
<li>
<p>添加prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">prometheus</span>: <span style="color:#ae81ff">prom-xxx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">prometheus</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">5s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;localhost:9090&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>常用指标</p>
<table>
  <thead>
      <tr>
          <th>指标</th>
          <th>释义</th>
          <th>指标类型</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>prometheus_config_last_reload_successful</code></td>
          <td>最后重启是否成功 1 表示成功 0表示失败</td>
          <td></td>
      </tr>
      <tr>
          <td><code>ceil(time()-prometheus_config_last_reload_success_timestamp_seconds)</code></td>
          <td>最后成功重启的距离现在过去了多少秒</td>
          <td></td>
      </tr>
      <tr>
          <td><code>prometheus_notifications_alertmanagers_discovered</code></td>
          <td>发现alertmanager并处于活跃状态</td>
          <td></td>
      </tr>
      <tr>
          <td><code>delta(prometheus_notifications_dropped_total[1h])</code></td>
          <td>由于发生错误而导致发送到alert 失败的告警数量</td>
          <td></td>
      </tr>
      <tr>
          <td><code>prometheus_notifications_sent_total</code></td>
          <td>自最后一次启动发送了多少条告警通知</td>
          <td></td>
      </tr>
      <tr>
          <td><code>prometheus_notifications_queue_capacity</code></td>
          <td>prometheus 处理告警队列的配额</td>
          <td></td>
      </tr>
      <tr>
          <td><code>prometheus_notifications_queue_length</code></td>
          <td>有多少条告警位于当前队列中</td>
          <td></td>
      </tr>
      <tr>
          <td><code>irate(process_cpu_seconds_total{ job=&quot;prometheus&quot;}[15m])</code></td>
          <td>cpu 使用时长</td>
          <td></td>
      </tr>
      <tr>
          <td><code>process_open_fds{ job=&quot;prometheus&quot;}</code></td>
          <td>已打开文件描述符数量</td>
          <td></td>
      </tr>
      <tr>
          <td><code>prometheus_engine_query_duration_seconds</code></td>
          <td>prometheus 引擎查询响应时长</td>
          <td>summary</td>
      </tr>
      <tr>
          <td><code>sum(rate(prometheus_tsdb_head_samples_appended_total[15m]))</code></td>
          <td>指标采集率</td>
          <td></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>evaluation_intervalrule_group_iterations_missed_total
</span></span></code></pre></div><p>空间预估</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 预估磁盘大小</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># needed_disk_space = retention_time_seconds * ingested_samples_per_second * bytes_per_sample</span>
</span></span><span style="display:flex;"><span>						86400（1天）		   *  10000/s  					 * 2byte
</span></span></code></pre></div></li>
<li>
<p>告警</p>
<ol>
<li>服务不可用 [严重]</li>
<li>查询响应高[警告]</li>
<li>存在告警发出失败[警告]</li>
</ol>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5605bee91439f7db78272ae6244fd177">3.3.12.2 - alertmanager</h1>
    
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_path</span>: <span style="color:#e6db74">&#34;/alert/metrics&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">9093</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8fb98d401496b16c1a7d7ad67b7b3bb1">3.3.12.3 - pushgateway</h1>
    
	<blockquote>
<p>pushgateway 用于将瞬时指标推送到prometheus，更倾向于解决服务级别的指标暴露，对于主机级别的瞬时指标可以使用<a href="https://github.com/prometheus/node_exporter/blob/master/README.md#textfile-collector" target="_blank">textfile</a></p>
</blockquote>
<p><font color=#102b6a><strong>安装部署</strong></font></p>

<details>
  <summary>Details</summary>
  <blockquote>
<p><code>docker run -d -p 9091:9091 prom/pushgateway</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">externalIPs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">10.4.7.10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9091</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">9091</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">prom/pushgateway:v1.5.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">9091</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">web.enable-admin-api</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">500m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">1024Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">200m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">512Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>: 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9091</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/-/ready</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>: 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9091</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/-/healthy</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>
</span></span></code></pre></div></details>

<p><font color=#102b6a><strong>指标推送</strong></font></p>
<ul>
<li>推送指标 <code>metrics_01{job=&quot;my_job&quot;} 1.0</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># metrics_01 和metrics_02 为自定义指标名称</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># job=&#34;my_job&#34;  为job名称</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;metrics_01 1.0&#34;</span> | curl --data-binary @-  http://127.0.0.1:9091/metrics/job/my_job
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;metrics_02 2.0&#34;</span> | curl --data-binary @- http://127.0.0.1:9091/metrics/job/my_job
</span></span></code></pre></div><ul>
<li>推送指标 <code>metrics_01{job=&quot;my_job&quot;,instance=&quot;host01&quot;,env=&quot;test&quot;} 1.0</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># /metrics/job/&lt;JOB_NAME&gt;{/&lt;LABEL_NAME&gt;/&lt;LABEL_VALUE&gt;}</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;metrics_01 1.0&#34;</span> | curl --data-binary @- http://127.0.0.1:9091/metrics/job/my_job/instance/host01/env/test
</span></span></code></pre></div><ul>
<li>删除指标</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#75715e"># 删除分组为job=&#34;my_job&#34;的指标</span>
</span></span><span style="display:flex;"><span> curl -X DELETE http://127.0.0.1:9091/metrics/job/my_job
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># 删除分组为job=&#34;my_job&#34; ,instance=&#34;host01&#34; 的指标</span>
</span></span><span style="display:flex;"><span>curl -X DELETE http://127.0.0.1:9091/metrics/job/my_job/instance/host01
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除所有分组指标，启动时需要开启--web.enable-admin-api</span>
</span></span><span style="display:flex;"><span>curl -X PUT http://127.0.0.1:9091/api/v1/admin/wipe
</span></span></code></pre></div><p><font color=#102b6a><strong>对接到promethues</strong></font></p>


<div class="alert alert-primary" role="alert">


    <code>honor_labels: true</code>,否则后面设置的job，instance等标签将会被舍弃

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus</span>: <span style="color:#ae81ff">prom-xxx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">honor_labels</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;localhost:9091&#34;</span>
</span></span></code></pre></div><p><font color=#102b6a><strong>pushgatway开启认证</strong></font></p>
<p><em>使用httpd:2-aplines镜像生成bcrypt类型密码，使用格式如下：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it httpd:2-alpine htpasswd -nBC <span style="color:#ae81ff">12</span> admin
</span></span></code></pre></div><p><em>生成认证配置文件</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 加密密码123</span>
</span></span><span style="display:flex;"><span>cat &gt;auth.yaml<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basic_auth_users:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  admin: &#34;$2y$12$jmxtk0MBfUe6AsW5cWKhU.vsYLkaVkTfWgu3JKWxFcdwGzNpfGYKW&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p><em>启动带认证的pushgatway</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pushgateway  --web.config.file<span style="color:#f92672">=</span>auth.yaml
</span></span></code></pre></div><p><em>功能验证</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;metrics_01 1.0&#34;</span> | curl -u admin:123  --data-binary @-  http://127.0.0.1:9091/metrics/job/my_job
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> prometheus_client <span style="color:#f92672">import</span> CollectorRegistry, Gauge, push_to_gateway
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> prometheus_client.exposition <span style="color:#f92672">import</span> basic_auth_handler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">my_auth_handler</span>(url, method, timeout, headers, data):
</span></span><span style="display:flex;"><span>    username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;admin&#39;</span>
</span></span><span style="display:flex;"><span>    password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;123&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> basic_auth_handler(url, method, timeout, headers, data, username, password)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>registry <span style="color:#f92672">=</span> CollectorRegistry()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>g <span style="color:#f92672">=</span> Gauge(<span style="color:#e6db74">&#39;job_last_success_unixtime&#39;</span>, <span style="color:#e6db74">&#39;Last time a batch job successfully finished&#39;</span>, registry<span style="color:#f92672">=</span>registry)
</span></span><span style="display:flex;"><span>g<span style="color:#f92672">.</span>set_to_current_time()
</span></span><span style="display:flex;"><span>push_to_gateway(<span style="color:#e6db74">&#39;localhost:9091&#39;</span>, job<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;batchA&#39;</span>, registry<span style="color:#f92672">=</span>registry, handler<span style="color:#f92672">=</span>my_auth_handler)
</span></span></code></pre></div><p>参考:</p>
<p><a href="https://github.com/prometheus/client_python" target="_blank">client_python</a>|<a href="https://prometheus.github.io/client_python/" target="_blank">doc</a></p>
<p><a href="https://github.com/prometheus/client_golang" target="_blank">client_golang</a></p>
<p><a href="http://peter.bourgon.org/go-in-production/#formatting-and-style" target="_blank">Peter Bourgon · Go: Best Practices for Production Environments</a></p>
<p><a href="https://prometheus.io/docs/practices/pushing/" target="_blank">When to use the Pushgateway | Prometheus</a></p>

</div>



    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-09903d68b7f1b7714677112922b831b4">victorametrics</h1>
	<div class="lead">victorametrics|prometheus</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-12" class="text-body-secondary">Monday, May 12, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-8c8d43a049d000cfadffd58670f39f1e">3.3.13.1 - victoriaMetrics</h1>
    <div class="lead">victoriaMetrics|prometheus</div>
	<p><a href="https://docs.victoriametrics.com/" target="_blank">doc</a></p>
<h2 id="victoriametrics">VictoriaMetrics</h2>
<p>系统选型，硬件规划，容量规划（磁盘、内存、带宽）</p>
<p><strong>文件系统： 建议选择ext4</strong></p>
<blockquote>
<p>如果您计划在 ext4 分区上存储超过 1TB 的数据或计划将其扩展到 16TB 以上，则建议将以下选项传</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># -O 64bit：启用64位文件系统特性，这允许文件系统支持大于2TB的文件和大于1EB的文件系统。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -O huge_file：启用大文件特性，这允许文件系统支持大于2TB的文件。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -O extent：启用扩展分配特性，这可以提高文件系统的效率，特别是在处理大文件时</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -T huge 选项指定了文件系统的类型</span>
</span></span><span style="display:flex;"><span>mkfs.ext4 ... -O 64bit,huge_file,extent -T huge
</span></span></code></pre></div></blockquote>
<h3 id="简介">简介</h3>
<p><code>VictoriaMetrics</code>是一个兼容<em>prometheus</em>的监控解决方案和分布式时序数据库。相比于<em>prometheus</em>、<em>thanos</em>具有<em>速度快</em>、<em>资源占用量低</em>、<em>可扩展</em>等特征。</p>
<p><strong>版本：</strong></p>
<ul>
<li>
<p>分为企业版和社区版。企业版支持<a href="https://docs.victoriametrics.com/lts-releases/" target="_blank">TLS</a>版本，社区版建议升级到最新版本。</p>
<table>
    <tr>
        <th>版本</th>
        <th>链接</th>
   </tr>
    <tr>
        <td>1.110.x</td>
        <td> https://github.com/VictoriaMetrics/VictoriaMetrics/releases/tag/v1.110.7</td>
    </tr>
    <tr>
        <td>1.102.x</td>
        <td>https://github.com/VictoriaMetrics/VictoriaMetrics/releases/tag/v1.102.20</td>
    </tr>
</table>
</li>
</ul>
<p><strong>主要功能:</strong></p>
<ul>
<li>时序数据库。长期存储prometheus 指标，直接对接grafana。</li>
<li>统一视图。支持多个promethues 对接到victorametrics中统一查询。</li>
<li>简单易用
<ol>
<li>启动文件是一个没有任何依赖的go编译文件</li>
<li>配置完全支持命令行参数</li>
<li>支持兼容promQL 的的查询语言</li>
</ol>
</li>
<li>易扩展。微服务开发，集群化部署。支持对单个/多个组件水平扩展。</li>
<li>支持多种方式数据抓取、采集和回填方式：
<ol>
<li>兼容<code>promethues exporter</code> 格式指标，<a href="https://docs.victoriametrics.com/#how-to-scrape-prometheus-exporters-such-as-node-exporter" target="_blank">exporter可以直接对接victoria</a></li>
<li><a href="https://docs.victoriametrics.com/#prometheus-setup" target="_blank">支持prometheus 远程写入</a></li>
<li>兼容prometheus 格式的数据导入<a href="https://docs.victoriametrics.com/#how-to-import-data-in-prometheus-exposition-format" target="_blank">doc</a></li>
</ol>
</li>
<li>支持标签<a href="https://docs.victoriametrics.com/#relabeling" target="_blank">relabeling</a></li>
</ul>
<p><strong>优势：</strong></p>
<ol>
<li>
<p>内存占用更小</p>
<p>It <a href="https://medium.com/@valyala/insert-benchmarks-with-inch-influxdb-vs-victoriametrics-e31a41ae2893" target="_blank">uses 10x less RAM than InfluxDB</a> and <a href="https://valyala.medium.com/prometheus-vs-victoriametrics-benchmark-on-node-exporter-metrics-4ca29c75590f" target="_blank">up to 7x less RAM than Prometheus, Thanos or Cortex</a> when dealing with millions of unique time series (aka <a href="https://docs.victoriametrics.com/FAQ.html#what-is-high-cardinality" target="_blank">high cardinality</a>).</p>
</li>
<li>
<p>更高的数据压缩比</p>
<p>It provides high data compression, so up to 70x more data points may be stored into limited storage comparing to TimescaleDB according to <a href="https://medium.com/@valyala/when-size-matters-benchmarking-victoriametrics-vs-timescale-and-influxdb-6035811952d4" target="_blank">these benchmarks</a> and up to 7x less storage space is required compared to Prometheus, Thanos or Cortex according to <a href="https://valyala.medium.com/prometheus-vs-victoriametrics-benchmark-on-node-exporter-metrics-4ca29c75590f" target="_blank">this benchmark</a>.</p>
</li>
</ol>
<p><strong>组件：</strong></p>
<p>在VictoriaMetrics 生态中包括以下成员：</p>
<ul>
<li>victoria-metrics : victorias的时序数据库</li>
<li><a href="https://docs.victoriametrics.com/vmagent/" target="_blank">vmagent</a>：服务发现、指标采集服务</li>
<li><a href="https://docs.victoriametrics.com/vmalert/" target="_blank">vmalert</a> ：告警和规则评估服务</li>
<li><a href="https://docs.victoriametrics.com/vmalert-tool/" target="_blank">vmalert-tool</a>: 校验告警和规则语法的工具</li>
<li><a href="https://docs.victoriametrics.com/vmauth/" target="_blank">vmauth</a>：是一个http代理。提供认证、路由、负载均衡的功能</li>
<li><a href="https://docs.victoriametrics.com/vmgateway/" target="_blank">vmgateway</a>：多租户下提供租户限速服务</li>
<li><a href="https://docs.victoriametrics.com/vmctl/" target="_blank">vmctl</a> ：数据迁移和合并工具</li>
<li><a href="https://docs.victoriametrics.com/vmbackup/" target="_blank">vmbackup</a>, <a href="https://docs.victoriametrics.com/vmrestore/" target="_blank">vmrestore</a> and <a href="https://docs.victoriametrics.com/vmbackupmanager/" target="_blank">vmbackupmanager</a> ：数据备份和还原工具</li>
</ul>
<h3 id="快速开始">快速开始</h3>
<ul>
<li>
<p><strong>部署<a href="https://docs.victoriametrics.com/Quick-Start.html" target="_blank">victoriaMetrics</a></strong></p>
<blockquote>
<p>功能实现： 启动单实例victoriaMetrics, 并将node-exporter中指标存储到victoria中</p>
<p>监听端口 8428</p>
<p>参数解释：</p>
<ul>
<li><code>-storageDataPath</code>数据文件默认存储在当前工作目录中<code>./victoria-metrics-data</code></li>
<li><code>-retentionPeriod</code>数据保存周期默认30d</li>
<li><code>-promscrape.config.strictParse</code> 必须严格遵守promethues.yaml 规则，主要用于校验<code>-promscrape.config</code> 参数指定的配置文件。默认为true</li>
<li><code>-promscrape.config</code> 指定抓取exporter的配置文件</li>
</ul>
</blockquote>
<p><strong>二进制方式</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.79.13/victoria-metrics-linux-amd64-v1.79.13.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf victoria-metrics-linux-amd64-v1.79.13.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /opt/victoria-metrics/<span style="color:#f92672">{</span>bin,conf,data<span style="color:#f92672">}</span> -p
</span></span><span style="display:flex;"><span>useradd victoria -s /usr/sbin/nologin
</span></span><span style="display:flex;"><span>cp victoria-metrics-prod  /opt/victoria-metrics/bin/
</span></span><span style="display:flex;"><span>chown -R victoria:victoria  /opt/victoria-metrics
</span></span></code></pre></div><blockquote>
<p><code>-storageDataPath=/opt/victoria-metrics/data </code> 数据存储目录</p>
<p><code>-retentionPeriod=1d </code> 保留存储的数据。默认31d, 最短1d</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/victoria.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=victoria service https://victoriametrics.com/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/victoria-metrics/bin/victoria-metrics-prod \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-storageDataPath=/opt/victoria-metrics/data \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-retentionPeriod=1d \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-promscrape.config.strictParse=false \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-promscrape.config=/etc/victoria-metrics/scrape.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=victoria
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>采集<em>node-exporter</em>指标</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /etc/victoria-metrics/scrape.yml&lt;&lt;EOF
</span></span><span style="display:flex;"><span>scrape_configs:
</span></span><span style="display:flex;"><span>- job_name: pcloudcore
</span></span><span style="display:flex;"><span>  honor_labels: true
</span></span><span style="display:flex;"><span>  honor_timestamps: true
</span></span><span style="display:flex;"><span>  scrape_interval: 30s
</span></span><span style="display:flex;"><span>  scrape_timeout: 10s
</span></span><span style="display:flex;"><span>  metrics_path: /metrics
</span></span><span style="display:flex;"><span>  scheme: http
</span></span><span style="display:flex;"><span>  follow_redirects: true
</span></span><span style="display:flex;"><span>  enable_http2: true
</span></span><span style="display:flex;"><span>  static_configs:
</span></span><span style="display:flex;"><span>  - targets:
</span></span><span style="display:flex;"><span>    - 127.0.0.1:9100
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable victoria --now
</span></span></code></pre></div><p><span style="color:red">截止到这里victoriaMetrics 已经可以正常工作了，访问http://xxxx:8428验证功能</span></p>
</li>
<li>
<p><strong>对接prometheus</strong> <sub>prometheus版本 v2.12.0+</sub></p>
<blockquote>
<p><font color=orange size=5px>[info]</font></p>
<ol>
<li>
<p>promethues远程写入会导致promethues内存使用 上浮25%左右</p>
</li>
<li>
<p>对于高负载的 Prometheus 实例（每秒 200k+ 个样本），可以应用以下调整：</p>
<p><sub><code>queue_config</code> 字段，用于配置 <code>remote_write</code> 的发送队列:<br><br><code>max_samples_per_send</code>: 一个 HTTP 请求中包含的最大样本数，默认值为 <code>0</code>，表示没有限制。如果远程写入端点要求HTTP请求能够包含有限数量的样本，则可以设置此项。当超过指定数量时，Prometheus 会自动将队列中的数据拆分成多个请求来发送。<br><br><code>capacity</code>: 发送队列的最大缓存容量。当队列中的样本数量超过此值时，Prometheus 将会阻塞新的写入操作，直到队列中的样本数量下降到可接受的范围内。注意，队列满了时不会丢弃数据，而是会将新写入的数据缓存起来，等待队列有足够容量之后再进行发送。<br><br><code>max_shards</code>: 配置发送队列线程池中最大的线程数，默认值为 <code>1</code>。当 <code>remote_write</code> 并发写入的数量较大时，可以将此值调大，以便更快地处理写入请求。</sub></p>
<p>需要注意的是，队列中的数据可能会占用的内存较大，因此需要根据实际情况仔细考虑合理的配置。在实际使用时，应根据数据规模、写入速度、服务器资源等因素逐步调整参数，以平衡发送队列的性能和稳定性。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">remote_write</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">url</span>: <span style="color:#ae81ff">http://&lt;victoriametrics-addr&gt;:8428/api/v1/write</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">queue_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max_samples_per_send</span>: <span style="color:#ae81ff">10000</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">capacity</span>: <span style="color:#ae81ff">20000</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max_shards</span>: <span style="color:#ae81ff">30</span>
</span></span></code></pre></div></li>
</ol>
</blockquote>
<ol>
<li>
<p>为promethues添加全局标签（多个prometheus向同一victorametrics远程写入数据时）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">datacenter</span>: <span style="color:#ae81ff">dc-123</span>
</span></span></code></pre></div></li>
<li>
<p>增加远程写入</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># promethues.yml 中开启远程写入</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">remote_write</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">url</span>: <span style="color:#ae81ff">http://&lt;victoriametrics-addr&gt;:8428/api/v1/write</span>
</span></span></code></pre></div></li>
</ol>
</li>
<li>
<p><strong>对接grafana</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 数据源选择prometheus，地址填写</span>
</span></span><span style="display:flex;"><span>http://&lt;victoriametrics-addr&gt;:8428
</span></span></code></pre></div></li>
</ul>
<h3 id="集群架构"><a href="https://docs.victoriametrics.com/Cluster-VictoriaMetrics.html" target="_blank">集群架构</a></h3>
<p>集群模式支持单体架构的所有功能，同时<strong>支持多租户</strong>的功能。考虑到架构复杂度，官方建议指标采集率在 100w/s 时，可以使用单体架构。</p>
<h4 id="架构图">架构图</h4>
<p>VictoriaMetrics 集群由以下服务组成：</p>
<ul>
<li><code>vmstorage</code>- 存储原始数据，并返回给定标签过滤器在给定时间范围内查询的数据</li>
<li><code>vminsert</code>- 接受摄取的数据，并根据指标名称及其所有标签的一致哈希值将其分布在节点之间<code>vmstorage</code></li>
<li><code>vmselect</code>- 通过从所有配置的节点获取所需的数据来执行传入查询<code>vmstorage</code></li>
</ul>
<p><img src="https://docs.victoriametrics.com/victoriametrics/Cluster-VictoriaMetrics_cluster-scheme.webp" alt="img"></p>
<h4 id="安装部署">安装部署</h4>
<blockquote>
<p><font color=orange size=5px>[info]</font></p>
<p><sub>victoraMetrics 属于io密集型应用，<a href="https://docs.victoriametrics.com/BestPractices.html" target="_blank">官方建议使用ext4 文件系统</a>,如果计划存储超过1TB 文件系统格式化时添加一下参数：</sub></p>
<p><sub><code>mkfs.ext4 ... -O 64bit,huge_file,extent -T huge</code><br>例如：<br>
<code>lvcreate -n test -L 1g data</code><br>
<code>mkfs.ext4 /dev/data/test -O 64bit,huge_file,extent -T huge</code></sub></p>
</blockquote>
<table>
  <thead>
      <tr>
          <th>主机名</th>
          <th>ip</th>
          <th>服务(端口)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>victora-dev01-s2</td>
          <td>192.168.0.226</td>
          <td>|vmstorage(8400 8401 8482)|vminsert(8480) |vmselect(8481)</td>
      </tr>
      <tr>
          <td>victora-dev02-s2</td>
          <td>192.168.0.227</td>
          <td>|vmstorage(8400 8401 8482)|vminsert(8480) |vmselect(8481)</td>
      </tr>
      <tr>
          <td>victora-dev03-s2</td>
          <td>192.168.0.228</td>
          <td>|vmstorage(8400 8401 8482)|vminsert(8480) |vmselect(8481)</td>
      </tr>
  </tbody>
</table>
<ol>
<li>
<p><strong>软件下载</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pvcreate /dev/sdb
</span></span><span style="display:flex;"><span>vgcreate victora /dev/sdb
</span></span><span style="display:flex;"><span>lvcreate -L 49GB victora -n data
</span></span><span style="display:flex;"><span>mkfs.ext4 /dev/mapper/victora-data 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>base_dir<span style="color:#f92672">=</span>/data/victoriaMetrics
</span></span><span style="display:flex;"><span>mkdir $base_dir -p
</span></span><span style="display:flex;"><span>echo /dev/mapper/victora-data  $base_dir ext4 defaults <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>  &gt;&gt;/etc/fstab
</span></span><span style="display:flex;"><span>mount -a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df -hT <span style="color:#e6db74">${</span>base_dir<span style="color:#e6db74">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>version<span style="color:#f92672">=</span>v1.93.16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>/victoria-metrics-linux-amd64-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-cluster.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir <span style="color:#e6db74">${</span>base_dir<span style="color:#e6db74">}</span>/<span style="color:#f92672">{</span>bin,conf,data,log<span style="color:#f92672">}</span> -p
</span></span><span style="display:flex;"><span>tar xf victoria-metrics-linux-amd64-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-cluster.tar.gz -C <span style="color:#e6db74">${</span>base_dir<span style="color:#e6db74">}</span>/bin
</span></span></code></pre></div></li>
<li>
<p><strong>安装vmstorage</strong></p>
<blockquote>
<p>vmstorage 同时监听 8400 8401 8482</p>
<p>8400 接受 vminsert 的写入</p>
<p>8401 接受 vmselect 的查询</p>
<p>8482 对接文件存储</p>
</blockquote>
<p>节点1：</p>
<blockquote>
<p><code>-retentionPeriod</code> 默认保留期为 1 个月。最短保留期为 24 小时或 1 天</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ipaddr<span style="color:#f92672">=</span>192.168.0.228
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tee /etc/systemd/system/vmstorage.service<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=victoriaMetrics vmstorage serveice
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=${base_dir}/bin/vmstorage-prod \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-storageDataPath ${base_dir}/data \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-retentionPeriod 10d \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-httpListenAddr ${ipaddr}:8482 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-vminsertAddr ${ipaddr}:8400 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-vmselectAddr ${ipaddr}:8401 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p><strong>安装vminsert</strong></p>
<blockquote>
<p>监听8480</p>
<p><code>-storageNode</code> 支持多个，用逗号分隔</p>
</blockquote>
<p>节点1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ipaddr<span style="color:#f92672">=</span>192.168.0.226
</span></span><span style="display:flex;"><span>storageNodeInsert<span style="color:#f92672">=</span>192.168.0.226:8400,192.168.0.227:8400,192.168.0.228:8400
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tee /etc/systemd/system/vminsert.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=victoriaMetrics vminsert serveice
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=${base_dir}/bin/vminsert-prod \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-storageNode=${storageNodeInsert} \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-httpListenAddr ${ipaddr}:8480
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p><strong>安装vmselect</strong></p>
<blockquote>
<p>监听8481</p>
<p><code>-storageNode</code> 支持多个，用逗号分隔</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ipaddr<span style="color:#f92672">=</span>192.168.0.227
</span></span><span style="display:flex;"><span>storageNodeSelect<span style="color:#f92672">=</span>192.168.0.226:8401,192.168.0.227:8401,192.168.0.228:8401
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tee /etc/systemd/system/vmselect.service<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=victoriaMetrics vmselect serveice
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=${base_dir}/bin/vmselect-prod \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-storageNode=${storageNodeSelect} \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-httpListenAddr ${ipaddr}:8481
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p><strong>启动服务</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl enable vminsert --now <span style="color:#f92672">&amp;&amp;</span> systemctl status vminsert 
</span></span><span style="display:flex;"><span>systemctl enable vmselect --now <span style="color:#f92672">&amp;&amp;</span> systemctl status vmselect 
</span></span><span style="display:flex;"><span>systemctl enable vmstorage --now <span style="color:#f92672">&amp;&amp;</span> systemctl status vmstorage
</span></span></code></pre></div></li>
<li>
<p><strong>读写验证</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 写入测试</span>
</span></span><span style="display:flex;"><span>curl -d <span style="color:#e6db74">&#39;metric_name{foo=&#34;bar&#34;} 123&#39;</span> -X POST http://192.168.0.226:8480/insert/1/prometheus/api/v1/import/prometheus
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询测试</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.226:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除测试</span>
</span></span><span style="display:flex;"><span>curl -v http://192.168.0.226:8481/delete/1/prometheus/api/v1/admin/tsdb/delete_series -d <span style="color:#e6db74">&#39;match[]=metric_name&#39;</span>
</span></span></code></pre></div></li>
<li>
<p><strong>修改prometheus配置</strong></p>
<blockquote>
<p>对于高负载的 Prometheus 实例（每秒 200k+ 个样本），可以应用以下调整：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>remote_write:
</span></span><span style="display:flex;"><span>  - url: http://&lt;victoriametrics-addr&gt;:8480/insert/0/prometheus
</span></span><span style="display:flex;"><span>    queue_config:
</span></span><span style="display:flex;"><span>      max_samples_per_send: <span style="color:#ae81ff">10000</span>
</span></span><span style="display:flex;"><span>      capacity: <span style="color:#ae81ff">20000</span>
</span></span><span style="display:flex;"><span>      max_shards: <span style="color:#ae81ff">30</span>
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>remote_write:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#- url: http://&lt;victoriametrics-host&gt;:8480/insert/&lt;tenantId&gt;/&lt;suffix&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># prometheus and - for ingesting data with Prometheus remote write API.prometheus/api/v1/write</span>
</span></span><span style="display:flex;"><span>  - url: http://10.4.7.250:8480/insert/0/prometheus
</span></span><span style="display:flex;"><span>  - url: http://10.4.7.251:8480/insert/0/prometheus
</span></span></code></pre></div></li>
<li>
<p><strong>配置grafana数据源</strong></p>
<blockquote>
<p>victoraMetrics 与 grafana 存在兼容性问题：</p>
<ol>
<li>VictoriaMetrics v1.44 - v1.58.x 与 Grafana 5.0 - 7.5.x 兼容。</li>
<li>VictoriaMetrics v1.59.x - v1.65.x 与 Grafana 5.3 - 8.1.x 兼容（需要输入默认的 Prometheus 插件 URL）。</li>
</ol>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#http://&lt;victoriametrics-host&gt;:8480/insert/&lt;tenantId&gt;/&lt;suffix&gt;</span>
</span></span><span style="display:flex;"><span>http://10.4.7.250:8481/select/0/prometheus
</span></span></code></pre></div></li>
<li>
<p><strong>victoraMetrics ui</strong>【非必须】</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http://10.4.7.250:8481/select/0/vmui/
</span></span></code></pre></div></li>
<li>
<p><strong>组件暴露的监控指标</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>10.4.7.250:8480/metrics
</span></span><span style="display:flex;"><span>10.4.7.250:8481/metrics
</span></span><span style="display:flex;"><span>10.4.7.250:8482/metrics
</span></span></code></pre></div></li>
</ol>
<h4 id="vmauth"><strong>vmauth</strong></h4>
<p>vmauth 提供http的反向代理和用户鉴权认证</p>
<blockquote>
<p>8427</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>version<span style="color:#f92672">=</span>v1.93.16
</span></span><span style="display:flex;"><span>wget https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>/vmutils-linux-amd64-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf vmutils-linux-amd64-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.tar.gz -C  <span style="color:#e6db74">${</span>base_dir<span style="color:#e6db74">}</span>/bin
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">tee ${base_dir}/conf/vmauth.yml &lt;&lt;EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">unauthorized_user</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">url_map</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">src_paths</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;/insert/.*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url_prefix</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;http://192.168.0.226:8480/&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;http://192.168.0.227:8480/&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;http://192.168.0.228:8480/&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">src_paths</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;/select/.*&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;/delete/.*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url_prefix</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;http://192.168.0.226:8481&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;http://192.168.0.227:8481&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;http://192.168.0.228:8481&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ipaddr<span style="color:#f92672">=</span>192.168.0.226
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tee /etc/systemd/system/vmauth.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=victoriaMetrics vmauth serveice
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=${base_dir}/bin/vmauth-prod -auth.config ${base_dir}/conf/vmauth.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-configCheckInterval 20s \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-httpListenAddr &#34;:8427&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl enable vmauth --now <span style="color:#f92672">&amp;&amp;</span> systemctl status vmauth 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 写入测试</span>
</span></span><span style="display:flex;"><span>curl -d <span style="color:#e6db74">&#39;metric_name{foo=&#34;bar&#34;} 456&#39;</span> -X POST http://192.168.0.226:8427/insert/1/prometheus/api/v1/import/prometheus
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询测试</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.226:8427/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.226:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.227:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.228:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除测试</span>
</span></span><span style="display:flex;"><span>curl -v http://192.168.0.226:8427/delete/1/prometheus/api/v1/admin/tsdb/delete_series -d <span style="color:#e6db74">&#39;match[]=metric_name&#39;</span>
</span></span></code></pre></div><p><strong>添加认证： 用户名和密码</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee <span style="color:#e6db74">${</span>base_dir<span style="color:#e6db74">}</span>/conf/vmauth.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">users:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- username: foo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  password: bar
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  url_map:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - src_paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;/insert/.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url_prefix:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.226:8480/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.227:8480/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.228:8480/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - src_paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;/select/.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;/delete/.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url_prefix:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.226:8481&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.227:8481&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.228:8481&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 写入测试</span>
</span></span><span style="display:flex;"><span>curl -ufoo:bar -d <span style="color:#e6db74">&#39;metric_name{foo=&#34;bar&#34;} 456&#39;</span> -X POST http://192.168.0.226:8427/insert/1/prometheus/api/v1/import/prometheus
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询测试</span>
</span></span><span style="display:flex;"><span>curl -ufoo:bar http://192.168.0.226:8427/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.226:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.227:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.228:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除测试</span>
</span></span><span style="display:flex;"><span>curl -ufoo:bar -v http://192.168.0.226:8427/delete/1/prometheus/api/v1/admin/tsdb/delete_series -d <span style="color:#e6db74">&#39;match[]=metric_name&#39;</span>
</span></span></code></pre></div><p><strong>添加认证：token认证</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee <span style="color:#e6db74">${</span>base_dir<span style="color:#e6db74">}</span>/conf/vmauth.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">users:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- bearer_token: ABCDEF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  url_map:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - src_paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;/insert/.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url_prefix:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.226:8480/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.227:8480/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.228:8480/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - src_paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;/select/.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;/delete/.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url_prefix:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.226:8481&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.227:8481&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.228:8481&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl  -H <span style="color:#e6db74">&#34;Authorization: Bearer ABCDEF&#34;</span> -d <span style="color:#e6db74">&#39;metric_name{foo=&#34;bar&#34;} 789&#39;</span> -X POST http://192.168.0.226:8427/insert/1/prometheus/api/v1/import/prometheus
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl  -H <span style="color:#e6db74">&#34;Authorization: Bearer ABCDEF&#34;</span>  http://192.168.0.226:8427/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl  -H <span style="color:#e6db74">&#34;Authorization: Bearer ABCDEF&#34;</span>   http://192.168.0.226:8427/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span></code></pre></div><h4 id="集群环境数据高可用">集群环境数据高可用</h4>
<p>默认数据是hash 后分片存储的，可以在vminsert 中修改参数，设置数据的高可用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./vminsert-prod --help|gep repli
</span></span><span style="display:flex;"><span>-replicationFactor int
</span></span><span style="display:flex;"><span>        Replication factor <span style="color:#66d9ef">for</span> the ingested data, i.e. how many copies to make among distinct -storageNode instances. Note that vmselect must run with -dedup.minScrapeInterval<span style="color:#f92672">=</span>1ms <span style="color:#66d9ef">for</span> data de-duplication when replicationFactor is greater than 1. Higher values <span style="color:#66d9ef">for</span> -dedup.minScrapeInterval at vmselect is OK <span style="color:#f92672">(</span>default 1<span style="color:#f92672">)</span>
</span></span></code></pre></div><h3 id="监控">监控</h3>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bfa75dc49b199dd86701654b7a8dd70f">3.3.14 - kubernetes</h1>
    <div class="lead">exporter|prometheus</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-25b4a44cfb54668617235e697b78af35">3.3.14.1 - kube-apiserver</h1>
    <div class="lead">exporter|prometheus</div>
	<ol>
<li>
<p>部署安装</p>
</li>
<li>
<p>添加prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kube-apiserver</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">honor_timestamps</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">follow_redirects</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enable_http2</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">192.168.0.244</span>:<span style="color:#ae81ff">6443</span>
</span></span></code></pre></div></li>
<li>
<p>常用指标</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cacert /etc/kubernetes/ssl/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert /etc/kubernetes/ssl/apiserver-kubelet-client.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key /etc/kubernetes/ssl/apiserver-kubelet-client.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>https://10.4.7.12:6443/metrics
</span></span></code></pre></div></blockquote>
<ul>
<li>
<p>apiserver 进程是否正常</p>
<pre tabindex="0"><code>up{job=&#34;kube-apiserver&#34;}
</code></pre></li>
<li>
<p>每秒QPS</p>
</li>
<li>
<p>API调用延时</p>
</li>
<li>
<p>ETCD调用延时</p>
</li>
</ul>
</li>
</ol>
<table>
  <thead>
      <tr>
          <th>指标名</th>
          <th>含义</th>
          <th>类型</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>apiserver_request_total</td>
          <td>请求总数</td>
          <td>counter</td>
      </tr>
      <tr>
          <td>apiserver_audit_event_total</td>
          <td>包含所有暴露的审计事件数量的指标。</td>
          <td>counter</td>
      </tr>
      <tr>
          <td>apiserver_audit_error_total</td>
          <td>在暴露时由于发生错误而被丢弃的事件的数量</td>
          <td>counter</td>
      </tr>
      <tr>
          <td>apiserver_request_duration_seconds_sum</td>
          <td>请求耗时</td>
          <td>gauge</td>
      </tr>
      <tr>
          <td>apiserver_request_duration_seconds_count</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>authentication_attempts</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>apiserver_tls_handshake_errors_total</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>apiserver_client_certificate_expiration_seconds_sum</td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><a href="https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/monitor-kube-apiserver" target="_blank">kube-apiserver组件监控介绍和常见异常指标_容器服务Kubernetes版(ACK)-阿里云帮助中心 (aliyun.com)</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7bb3b9db4f2ef41eaaf1bbd09fa2e996">3.3.14.2 - kube-controller</h1>
    <div class="lead">exporter|prometheus</div>
	
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e3a8bfe7e2de471dc46cdfcd846b0686">3.3.14.3 - kube-controller</h1>
    <div class="lead">exporter|prometheus</div>
	
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b2a97e471d481fe1bb9c8b592ca62eab">3.3.14.4 - kube-proxy</h1>
    <div class="lead">exporter|prometheus</div>
	<p>kube-proxy 监听在   http://127.0.0.1:10249/metrics</p>
<p>scheduler 监听在 https://127.0.0.1:10259/metrics</p>
<p>controller-manager监听在 https://127.0.0.1:10257/metrics</p>
<p>coredns http://172.168.0.10:9153/metric</p>
<p>收集k8s事件到mongodb  <a href="https://github.com/AliyunContainerService/kube-eventer" target="_blank">GitHub - AliyunContainerService/kube-eventer: kube-eventer emit kubernetes events to sinks</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>我来解释如何在 Kubernetes 中持久化事件（Events）。
</span></span><span style="display:flex;"><span>Kubernetes 事件默认只保留1小时，如果要持久化存储事件，有以下几种主要方案：
</span></span><span style="display:flex;"><span>使用 Event Exporter
</span></span><span style="display:flex;"><span>这是一个比较常用的方案，可以将 k8s 事件导出到外部存储系统。例如使用官方的 event-exporter：
</span></span><span style="display:flex;"><span>使用 Event Logger
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: event-exporter
</span></span><span style="display:flex;"><span>  namespace: monitoring
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: event-exporter
</span></span><span style="display:flex;"><span>        image: gcr.io/google-containers/event-exporter:v0.3.1
</span></span><span style="display:flex;"><span>        command:
</span></span><span style="display:flex;"><span>        - /event-exporter
</span></span><span style="display:flex;"><span>        - --sink-opts<span style="color:#f92672">=</span>elasticsearch?hosts<span style="color:#f92672">=</span>http://elasticsearch:9200
</span></span><span style="display:flex;"><span>可以部署一个自定义的 event logger，监听集群事件并写入到持久化存储中：
</span></span><span style="display:flex;"><span>修改 kube-apiserver 配置
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: event-logger
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: event-logger
</span></span><span style="display:flex;"><span>        image: k8s-event-logger
</span></span><span style="display:flex;"><span>        env:
</span></span><span style="display:flex;"><span>        - name: STORAGE_TYPE
</span></span><span style="display:flex;"><span>          value: <span style="color:#e6db74">&#34;elasticsearch&#34;</span>
</span></span><span style="display:flex;"><span>        - name: ES_HOST
</span></span><span style="display:flex;"><span>          value: <span style="color:#e6db74">&#34;elasticsearch-service:9200&#34;</span>
</span></span><span style="display:flex;"><span>可以通过修改 kube-apiserver 的配置来延长事件保留时间：
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: kube-apiserver
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - command:
</span></span><span style="display:flex;"><span>    - kube-apiserver
</span></span><span style="display:flex;"><span>    - --event-ttl<span style="color:#f92672">=</span>168h <span style="color:#75715e"># 保留7天</span>
</span></span><span style="display:flex;"><span>常见的事件持久化存储后端包括：
</span></span><span style="display:flex;"><span>Elasticsearch
</span></span><span style="display:flex;"><span>InfluxDB
</span></span><span style="display:flex;"><span>MongoDB
</span></span><span style="display:flex;"><span>MySQL/PostgreSQL
</span></span><span style="display:flex;"><span>建议：
</span></span><span style="display:flex;"><span>根据实际需求选择合适的存储后端
</span></span><span style="display:flex;"><span>注意设置合理的数据保留策略，避免存储空间耗尽
</span></span><span style="display:flex;"><span>考虑事件过滤，只存储重要事件
</span></span><span style="display:flex;"><span>建立监控告警，及时发现异常事件
</span></span><span style="display:flex;"><span>如果你需要具体某个存储方案的详细配置，我可以为你展开说明。
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-92571de61259ce57bcb0c1a9e852b932">3.3.14.5 - kubelet</h1>
    <div class="lead">exporter|prometheus</div>
	<p>kubelet 还会在 <code>/metrics/cadvisor</code>， <code>/metrics/resource</code> 和 <code>/metrics/probes</code> 端点中公开度量值</p>
<p>curl 127.0.0.1:10248/healthz</p>
<p>curl 127.0.0.1:10250/healthz</p>
<ol>
<li>
<p>部署安装</p>
<p>参见部署k8s</p>
</li>
<li>
<p>添加prometheus配置</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> prometheus 部署在k8s 内，需要提前rbac授权</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bearer_tonken_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/token  </span>
</span></span></code></pre></div><ul>
<li>
<p><input checked="" disabled="" type="checkbox"> prometheus 部署在k8s 外</p>
<blockquote>
<p>kubernetes_sd_configs 支持通过 api_server 或 kubeconfig_file 方式，二选一</p>
</blockquote>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cacert /etc/kubernetes/pki/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert /etc/kubernetes/pki/apiserver-kubelet-client.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key /etc/kubernetes/pki/apiserver-kubelet-client.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>https://192.168.0.243:10250/metrics
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kubelet</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kubeconfig_file</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:10250&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div><blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -k  -H <span style="color:#e6db74">&#34;Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Ik5jb3R0bGdBVmwtalBuVW9JR0h3VG5nblRkMmVJZUFMdDRVaDd6U1ZNMDQifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImFkbWluLXRva2VuLTduejlwIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiYzEyNjYyNDktMWFkNS00ZjA1LTljZDUtYjhjNTdjYWU2NDkzIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6YWRtaW4ifQ.TXZNfk12OsTh5Z_dkOJOHmIGxV_YNS6QEB-ItgddleoQrlz85S43OMED7mPfnxt9CTuDuuTjRRThXwiw1CF4cdtmwj789IU0z67LyDbkdHC4uUwMnqnQrw3aeSv_dgEHlCJr1btqIImRlxHzxvRsP3Yeqb95hjOqDIMVN_HgfYdk835foAHawrOksHdneMwtoOlpiqjVm9bzjIjEF5ckdVX86hwBu3xB1Ml4R4xZwGIecs06nQoBEKO6MlSARgq8e5VQqdRVip7WJuoAlyq80AYW1gAR7I6RvXJVWECu2NpXzQoTROZ132VyCLAhVQVqf_yLrpnQTTxdOKgvS1tskA&#34;</span> https://192.168.0.243:10250/metrics
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kubelet</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Bearer</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">#提前创建RBAC ,提取sa的secret 中token并保存到文件中 </span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">#kubectl create clusterrolebinding admin --clusterrole=cluster-admin --serviceaccount=default:admin</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">credentials_file</span>: <span style="color:#ae81ff">token</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kubeconfig_file</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:10250&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div></li>
<li>
<p><input checked="" disabled="" type="checkbox"> 通过api_server 执行动态发现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kubelet</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Bearer</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">#提前创建RBAC ,提取sa的secret 中token并保存到文件中 </span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">#kubectl create clusterrolebinding admin --clusterrole=cluster-admin --serviceaccount=default:admin</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">credentials_file</span>: <span style="color:#ae81ff">token</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://127.0.0.1:6443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.pem</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/cert.pem</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/cert.key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:10250&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>常用指标</p>
<p>各节点running容器数量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubelet_running_containers<span style="color:#f92672">{</span>container_state<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;running&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>各个节点运行pod数量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubelet_running_pods
</span></span></code></pre></div><p>各个节点运行ds数量</p>
<p>各个节点运行sts数量</p>
<p>各个节点运行job数量</p>
<p>各个节点运行cronjob数量</p>
<p>各个节点运行pvc数量</p>
<p>各个节点运行pv数量</p>
<p>各个节点容器日志占用量</p>
<p>kubelet 内存使用量</p>
<p>kubelet cpu使用量</p>
<p>节点是否ready</p>
<p>告警</p>
<p>kubelet 进程异常告警</p>
<p>有pod 被驱逐时告警</p>
<p>pod 、cpu 、memory数量即将超过限额告警</p>
<p>Kubelet是Kubernetes集群中的一个核心组件，用于管理和监控运行在节点上的容器。Kubelet会通过暴露一些监控指标来提供关于其自身和节点的健康状况、资源使用情况和性能数据。以下是一些kubelet暴露的常见监控指标：</p>
<ol>
<li>
<p>kubelet_runtime_operations_errors_total：Kubelet在容器运行时处理期间遇到的错误数。</p>
</li>
<li>
<p>kubelet_runtime_operations_latency_seconds：Kubelet处理容器运行时操作的延迟时间。</p>
</li>
<li>
<p>kubelet_volume_stats_available_bytes：节点上可用的存储卷容量。</p>
</li>
<li>
<p>kubelet_volume_stats_capacity_bytes：存储卷的总容量。</p>
</li>
<li>
<p>kubelet_volume_stats_used_bytes：已使用的存储卷容量。</p>
</li>
<li>
<p>kubelet_node_status_capacity_cpu_cores：节点上可用的CPU核心数量。</p>
</li>
<li>
<p>kubelet_node_status_capacity_memory_bytes：节点上可用的内存容量。</p>
</li>
<li>
<p>kubelet_node_status_allocatable_cpu_cores：节点上分配给Pod的可用CPU核心数量。</p>
</li>
<li>
<p>kubelet_node_status_allocatable_memory_bytes：节点上分配给Pod的可用内存容量。</p>
</li>
<li>
<p>kubelet_node_status_kubelet_version：Kubelet的版本信息。</p>
</li>
<li>
<p>kubelet_node_status_machine_id：节点的机器ID。</p>
</li>
<li>
<p>kubelet_node_status_system_uptime：节点的系统运行时间。</p>
</li>
<li>
<p>kubelet_volume_stats_inodes：存储卷的Inode使用情况。</p>
</li>
</ol>
<p>这些指标可以通过Prometheus等监控系统进行收集和分析，以监控和调优Kubernetes集群中的节点和容器的运行情况。</p>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-31806350774a7c031b15b5c616430c3e">3.3.14.6 - etcd</h1>
    <div class="lead">exporter|prometheus</div>
	<ol>
<li>
<p>部署安装</p>
<p>参见部署k8s</p>
<blockquote>
<p><sub>【参数说明】</sub></p>
<p><sub>snapshot-count  每50000次修改执行一次snapshot</sub></p>
<p><sub>auto-compaction-retention  自动压缩，默认为 0 不开启</sub></p>
<p><sub>max-request-bytes 单个请求最大字节，默认1.5MB</sub></p>
<p><sub>quota-backend-bytes  指定数据库在磁盘上的配额大小，默认2GB</sub></p>
<p><sub>heartbeat-interval leader向leaner发送心跳周期，默认 100ms</sub></p>
<p><sub>election-timeout  选举超时,默认1s</sub></p>
<p><sub>max-snapshots 最大保留快照数，默认 5 个</sub></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/opt/kube/bin/etcd <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --name<span style="color:#f92672">=</span>master3 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --cert-file<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --key-file<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --peer-cert-file<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --peer-key-file<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --trusted-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --peer-trusted-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --initial-advertise-peer-urls<span style="color:#f92672">=</span>https://10.4.7.12:2380 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --listen-peer-urls<span style="color:#f92672">=</span>https://10.4.7.12:2380 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --listen-client-urls<span style="color:#f92672">=</span>https://10.4.7.12:2379,http://127.0.0.1:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --advertise-client-urls<span style="color:#f92672">=</span>https://10.4.7.12:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --initial-cluster-token<span style="color:#f92672">=</span>etcd-cluster-0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --initial-cluster<span style="color:#f92672">=</span>master1<span style="color:#f92672">=</span>https://10.4.7.22:2380,master2<span style="color:#f92672">=</span>https://10.4.7.21:2380,master3<span style="color:#f92672">=</span>https://10.4.7.12:2380 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --initial-cluster-state<span style="color:#f92672">=</span>new <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --data-dir<span style="color:#f92672">=</span>/var/lib/etcd/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --snapshot-count<span style="color:#f92672">=</span><span style="color:#ae81ff">50000</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --auto-compaction-retention<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --max-request-bytes<span style="color:#f92672">=</span><span style="color:#ae81ff">10485760</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --enable-v2<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --quota-backend-bytes<span style="color:#f92672">=</span><span style="color:#ae81ff">8589934592</span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>always
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>LimitNOFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>OOMScoreAdjust<span style="color:#f92672">=</span>-999
</span></span></code></pre></div></li>
<li>
<p>添加prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;etcd&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/etcd/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/etcd/peer.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/etcd/peer.key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;192.168.0.244:2379&#39;</span>
</span></span></code></pre></div></li>
<li>
<p><a href="https://etcd.io/docs/v3.6/metrics/" target="_blank">监控指标</a></p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cacert /etc/kubernetes/pki/etcd/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert /etc/kubernetes/pki/etcd/peer.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key /etc/kubernetes/pki/etcd/peer.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>https://10.4.7.12:2379/metrics
</span></span></code></pre></div></blockquote>
<p>指标主要包含 ：</p>
<ul>
<li><strong>Server</strong>相关，所有指标以<code>etcd_server</code> 开头。</li>
<li><strong>Disk</strong>相关，所有指标以`etcd_disk 开头</li>
<li><strong>Network</strong>相关，所有指标以<code>etcd_network</code> 开头</li>
<li><strong>mvcc</strong>相关 ，所有指标以<code>etcd_mvcc</code> 开头</li>
<li><strong>snap</strong>相关，所有指标以<code>etcd_snap</code> 开头</li>
<li><strong>degugging</strong>相关，所有指标以<code>etcd_degugging</code> 开头</li>
</ul>
<p><strong>Server</strong>相关，所有指标以<code>etcd_server</code> 开头</p>
<table>
  <thead>
      <tr>
          <th>名称</th>
          <th>描述</th>
          <th>类型</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>etcd_server_has_leader</code></td>
          <td>是否存在leader。1表示存在，0表示不存在</td>
          <td>Gauge</td>
      </tr>
      <tr>
          <td><code>etcd_server_leader_changes_seen_total</code></td>
          <td>主从切换的总次数</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td><code>etcd_server_proposals_committed_total</code></td>
          <td>协商一致提交的请求</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td><code>etcd_server_proposals_applied_total</code></td>
          <td>协商一致处理的请求</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td><code>etcd_server_proposals_pending</code></td>
          <td>排队等待提交的提案数量</td>
          <td>Gauge</td>
      </tr>
      <tr>
          <td><code>etcd_server_proposals_failed_total</code></td>
          <td>失败的提案</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td><code>etcd_server_quota_backend_bytes</code></td>
          <td>数据库配额（磁盘）</td>
          <td>Gauge</td>
      </tr>
  </tbody>
</table>
<p><strong>Disk</strong>相关，所有指标以`etcd_disk 开头</p>
<table>
  <thead>
      <tr>
          <th>名称</th>
          <th>描述</th>
          <th>类型</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>etcd_disk_wal_fsync_duration_seconds</code></td>
          <td>wal 写入磁盘延迟时长</td>
          <td>Histogram</td>
      </tr>
      <tr>
          <td>etcd_disk_<code>backend_commit_duration_seconds</code></td>
          <td>增量快照写入磁盘延迟时长</td>
          <td>Histogram</td>
      </tr>
  </tbody>
</table>
<table>
  <thead>
      <tr>
          <th>名称</th>
          <th>描述</th>
          <th>类型</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>etcd_debugging_mvcc_keys_total</code></td>
          <td>key数量</td>
          <td>Gauge</td>
      </tr>
      <tr>
          <td>etcd_debugging_mvcc_db_total_size_in_bytes</td>
          <td>数据库大小</td>
          <td>Gauge</td>
      </tr>
  </tbody>
</table>
<p><strong>Network</strong>相关，所有指标以<code>etcd_network</code> 开头</p>
<table>
  <thead>
      <tr>
          <th>名称</th>
          <th>描述</th>
          <th>类型</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>peer_sent_bytes_total</td>
          <td>The total number of bytes sent to the peer with ID <code>To</code>.</td>
          <td>Counter(To)</td>
      </tr>
      <tr>
          <td>peer_received_bytes_total</td>
          <td>The total number of bytes received from the peer with ID <code>From</code>.</td>
          <td>Counter(From)</td>
      </tr>
      <tr>
          <td>peer_sent_failures_total</td>
          <td>The total number of send failures from the peer with ID <code>To</code>.</td>
          <td>Counter(To)</td>
      </tr>
      <tr>
          <td>peer_received_failures_total</td>
          <td>The total number of receive failures from the peer with ID <code>From</code>.</td>
          <td>Counter(From)</td>
      </tr>
      <tr>
          <td>peer_round_trip_time_seconds</td>
          <td>Round-Trip-Time histogram between peers.</td>
          <td>Histogram(To)</td>
      </tr>
      <tr>
          <td>client_grpc_sent_bytes_total</td>
          <td>The total number of bytes sent to grpc clients.</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td>client_grpc_received_bytes_total</td>
          <td>The total number of bytes received to grpc clients.</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td>process_open_fds</td>
          <td>Number of open file descriptors.</td>
          <td>Gauge</td>
      </tr>
      <tr>
          <td>process_max_fds</td>
          <td>Maximum number of open file descriptors.</td>
          <td>Gauge</td>
      </tr>
      <tr>
          <td>etcd_server_proposals_applied_total</td>
          <td>接收到的客户端请求</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td>etcd_server_etcd_network_peer_sent_bytes_total</td>
          <td>etcd 成员之间发送的请求</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td>etcd_server_etcd_network_peer_latency_seconds</td>
          <td>etcd 成员之间网络延迟</td>
          <td>Gauge</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>告警规则</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Etcd&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 主从切换</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#e6db74">&#34;EtcdLeaderSwitch&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">etcd_server_is_leader != etcd_server_is_leader offset 10m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#e6db74">&#34;5m&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">etcd</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#e6db74">&#34;warnning&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;Etcd Role changes&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.instace }}&#39;s Role changes before 10 minute,now is {{ $value }}.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 宕机    </span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#e6db74">&#34;EtcdDown&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">up{job=~&#34;.*etcd.*&#34;} == 0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#e6db74">&#34;5m&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">etcd</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#e6db74">&#34;critical&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;Etcd is down &#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.instace }} is down for more than 5 minute.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 缺少leader    </span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#e6db74">&#34;EtcdNoLeader&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">etcd_server_has_leader == 0 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#e6db74">&#34;5m&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">etcd</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#e6db74">&#34;critical&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;Etcd no leader&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.instace }} no leader for more than 5 minute.&#34;</span>
</span></span></code></pre></div></li>
</ol>
<p><a href="https://zhuanlan.zhihu.com/p/466274302" target="_blank">etcd 问题、调优、监控 - 知乎 (zhihu.com)</a></p>
<p><a href="http://www.xuyasong.com/?p=1706" target="_blank">etcd 原理解析：读《etcd 技术内幕》 | Vermouth | 博客 | docker | k8s | python | go | 开发 (xuyasong.com)</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5cb338fcb7d2487aba8e3851f63fe4e9">3.3.14.7 - coredns</h1>
    <div class="lead">exporter|prometheus</div>
	
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8e244531e3aa17ff54cd0173cf6f4016">3.3.14.8 - cadvisor</h1>
    <div class="lead">exporter|prometheus</div>
	<ol>
<li>
<p><a href="https://github.com/google/cadvisor" target="_blank">部署安装</a> cadvisor提供容器资源cpu，内存、网络、文件系统等方面的信息，在k8s环境中通过daemonset 资源来部署相关资源</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>VERSION<span style="color:#f92672">=</span>v0.36.0 <span style="color:#75715e"># use the latest release version from https://github.com/google/cadvisor/releases</span>
</span></span><span style="display:flex;"><span>sudo docker run <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume<span style="color:#f92672">=</span>/:/rootfs:ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume<span style="color:#f92672">=</span>/var/run:/var/run:ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume<span style="color:#f92672">=</span>/sys:/sys:ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume<span style="color:#f92672">=</span>/var/lib/docker/:/var/lib/docker:ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume<span style="color:#f92672">=</span>/dev/disk/:/dev/disk:ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --publish<span style="color:#f92672">=</span>8080:8080 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --detach<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --name<span style="color:#f92672">=</span>cadvisor <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --privileged <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --device<span style="color:#f92672">=</span>/dev/kmsg <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcr.io/cadvisor/cadvisor:$VERSION
</span></span></code></pre></div></li>
<li>
<p>添加prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>- job_name: cadvisor
</span></span><span style="display:flex;"><span>  static_configs:
</span></span><span style="display:flex;"><span>  - targets:
</span></span><span style="display:flex;"><span>    - 10.4.7.251:8080
</span></span></code></pre></div></li>
<li>
<p>常用指标</p>
<table>
  <thead>
      <tr>
          <th>指标</th>
          <th>注释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>rate(container_cpu_usage_seconds_total{name=&quot;cadvisor&quot;}[1m])</code></td>
          <td>cup负载</td>
      </tr>
      <tr>
          <td><code>container_memory_usage_bytes{name=&quot;cadvisor&quot;}</code></td>
          <td>内存使用率</td>
      </tr>
      <tr>
          <td><code>rate(container_network_transmit_bytes_total{name=&quot;cadvisor&quot;}[1m])</code></td>
          <td>网络发送</td>
      </tr>
      <tr>
          <td><code>rate(container_network_receive_bytes_total{name=&quot;cadvisor&quot;}[1m])</code></td>
          <td>网络接收</td>
      </tr>
  </tbody>
</table>
</li>
</ol>
<p>应用自身指标暴露</p>
<pre tabindex="0"><code>annotations:
  prometheus.io/port: &#34;9153&#34;
  prometheus.io/scrape: &#34;true&#34;
</code></pre><p>github 和招商银行内部使用了内嵌入的cadvisor 配置方式</p>
<ul>
<li>
<p><input checked="" disabled="" type="checkbox"> 通过apiserver</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kubernetes-cadvisor</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">10s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">api_server</span>: <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespaces</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">names</span>: []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">bearer_token_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/token</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">separator</span>: <span style="color:#ae81ff">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_node_label_(.+)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">$1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">separator</span>: <span style="color:#ae81ff">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">kubernetes.default.svc:443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_node_name]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">separator</span>: <span style="color:#ae81ff">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.+)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__metrics_path__</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">/api/v1/nodes/${1}/proxy/metrics/cadvisor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span></code></pre></div></li>
<li>
<p><input checked="" disabled="" type="checkbox"> cadvisor 内嵌在kubelet 中</p>
<blockquote>
<p><em>prometheus运行在k8s外部</em></p>
<p>kubernetes_sd_configs:</p>
<p>​	<code>kubeconfig_file</code> 和 <code>api_server</code> 二选其一</p>
<p>https 可以通过证书方式认证或通过token 方法是认证</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">cadvisor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics/cadvisor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#authorization:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  type: Bearer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  credentials_file: token</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kubeconfig_file</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:10250&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">cadvisor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics/cadvisor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  cert_file: /etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  key_file: /etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Bearer</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">credentials_file</span>: <span style="color:#ae81ff">token</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://192.168.0.244:6443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:10250&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0f8ec29a41b1721d7cd9fe76cf6dc070">3.3.14.9 - kube-state-metrics</h1>
    <div class="lead">exporter|prometheus</div>
	<p><a href="https://github.com/kubernetes/kube-state-metrics" target="_blank">kube-state-metrics</a> 通过监听kube-apiserver生成资源状态指标。包括node、pod、container、deplpyment、statefulset、job、pv、pvc 等。</p>
<p>kube-state-metrics 使用client-go与kubernetes集成，因此在安装时需要选择对应的kubernetes版本。</p>
<blockquote>
<ul>
<li><code>✓</code>完全支持的版本范围。</li>
<li><code>-</code>Kubernetes 集群具有 client-go 库无法使用的功能（额外的 API 对象、已弃用的 API 等）。</li>
</ul>
</blockquote>
<table>
  <thead>
      <tr>
          <th>kube-state-metrics 指标</th>
          <th><strong>Kubernetes 1.20 版本</strong></th>
          <th><strong>Kubernetes 1.21 版本</strong></th>
          <th><strong>Kubernetes 1.22 版本</strong></th>
          <th><strong>Kubernetes 1.23 版本</strong></th>
          <th><strong>Kubernetes 1.24 版本</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>2.3.0 版</strong></td>
          <td>✓</td>
          <td>✓</td>
          <td>✓</td>
          <td>✓</td>
          <td>-</td>
      </tr>
      <tr>
          <td><strong>2.4.2 版</strong></td>
          <td>-/✓</td>
          <td>-/✓</td>
          <td>✓</td>
          <td>✓</td>
          <td>-</td>
      </tr>
      <tr>
          <td><strong>2.5.0 版</strong></td>
          <td>-/✓</td>
          <td>-/✓</td>
          <td>✓</td>
          <td>✓</td>
          <td>✓</td>
      </tr>
      <tr>
          <td><strong>2.6.0 版</strong></td>
          <td>-/✓</td>
          <td>-/✓</td>
          <td>✓</td>
          <td>✓</td>
          <td>✓</td>
      </tr>
  </tbody>
</table>
<hr>
<p>本示例kubernetes 版本 v1.23，kube-state-metrics版本2.6.0</p>
<blockquote>
<p>资源清单位置：kube-state-metrics/examples/standard</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">2.6.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">2.6.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">configmaps</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">secrets</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">nodes</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">pods</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">services</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">serviceaccounts</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">resourcequotas</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">replicationcontrollers</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">limitranges</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">persistentvolumeclaims</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">persistentvolumes</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">namespaces</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">apps</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">statefulsets</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">daemonsets</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">deployments</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">replicasets</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">batch</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">cronjobs</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">jobs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">autoscaling</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">horizontalpodautoscalers</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">authentication.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">tokenreviews</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">subjectaccessreviews</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">policy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">poddisruptionbudgets</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">certificates.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">certificatesigningrequests</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">storage.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">storageclasses</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">volumeattachments</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">admissionregistration.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">mutatingwebhookconfigurations</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">validatingwebhookconfigurations</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">networking.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">networkpolicies</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ingresses</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">coordination.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">leases</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">clusterrolebindings</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">clusterroles</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">rolebindings</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">roles</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">2.6.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">2.6.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">exporter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">2.6.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.6.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/healthz</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http-metrics</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">telemetry</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">capabilities</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">drop</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">ALL</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">readOnlyRootFilesystem</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">65534</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">kubernetes.io/os</span>: <span style="color:#ae81ff">linux</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">2.6.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/external</span>: <span style="color:#ae81ff">192.168.0.243</span> <span style="color:#75715e"># 为项目改造</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/ports</span>: <span style="color:#e6db74">&#34;32080&#34;</span> <span style="color:#75715e"># 为项目改造</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">32080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">http-metrics</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">telemetry</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">telemetry</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span></code></pre></div><ol>
<li>
<p>部署安装</p>
<blockquote>
<p>8080 端口提供k8s 指标</p>
<p>8081 端口提供kube_state_metrics 自身指标</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f kube-state-metrics.yml
</span></span></code></pre></div></li>
<li>
<p>添加prometheus配置</p>
<p>静态配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kube-state-metrics&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;192.168.0.244:8080&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 添加所属环境</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">environment</span>
</span></span></code></pre></div><p>基于k8s动态发现</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl --cacert /etc/kubernetes/pki/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	 --cert /etc/kubernetes/pki/apiserver-kubelet-client.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	 --key /etc/kubernetes/pki/apiserver-kubelet-client.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	 https://192.168.0.244:6443/api/v1/services?limit<span style="color:#f92672">=</span>100&amp;resourceVersion<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p><code>kubeconfig_file</code>和 <code>api_server</code> 二者选一</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://192.168.0.244:6443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 测试改成false也没问题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#34;__meta_kubernetes_service_name&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;kube-state-metrics&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#34;__meta_kubernetes_service_label_prometheus_io_external&#34;</span>,<span style="color:#e6db74">&#34;__meta_kubernetes_service_label_prometheus_io_ports&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">([0-9\.]+);(\d+)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">$1:$2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div><pre tabindex="0"><code>  - job_name: kube-state-metrics
    kubernetes_sd_configs:
    - kubeconfig_file: config
      role: service
    relabel_configs:
    - source_labels: [&#34;__meta_kubernetes_service_name&#34;]
      action: keep
      regex: &#34;kube-state-metrics&#34;
    - source_labels: [&#34;__meta_kubernetes_service_label_prometheus_io_external&#34;,&#34;__meta_kubernetes_service_label_prometheus_io_ports&#34;]
      regex: ([0-9\.]+);(\d+)
      replacement: $1:$2
      action: replace
      target_label: __address__
</code></pre></li>
<li>
<p>常用指标
集群状态指标是哪个
svc 状态（缺少endpoint）</p>
<ul>
<li>
<p>node</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#节点 数量</span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>kube_node_info<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#不可调度的节点数量</span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>kube_node_spec_unschedulable<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 集群cpu 数量</span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>kube_node_status_capacity<span style="color:#f92672">{</span>resource<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cpu&#34;</span><span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 集群内存 数量</span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>kube_node_status_capacity<span style="color:#f92672">{</span>resource<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;memory&#34;</span><span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 磁盘存在压力的节点</span>
</span></span><span style="display:flex;"><span>kube_node_status_condition<span style="color:#f92672">{</span>condition<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;DiskPressure&#34;</span>,status<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 内存存在压力的节点</span>
</span></span><span style="display:flex;"><span>kube_node_status_condition<span style="color:#f92672">{</span>condition<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;MemoryPressure&#34;</span>,status<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pid存在压力的节点</span>
</span></span><span style="display:flex;"><span>kube_node_status_condition<span style="color:#f92672">{</span>condition<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;PIDPressure&#34;</span>,status<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 存在网络不可达节点</span>
</span></span><span style="display:flex;"><span>kube_node_status_condition<span style="color:#f92672">{</span>condition<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;NetworkUnavailable&#34;</span>,status<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>namespace</p>
</li>
<li>
<p>pod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kube_pod_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Failed&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Pending&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Running&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Succeeded&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Unknown&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>container</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 容器状态</span>
</span></span><span style="display:flex;"><span>kube_pod_container_status_running
</span></span><span style="display:flex;"><span>kube_pod_container_status_waiting
</span></span><span style="display:flex;"><span>kube_pod_container_status_ready
</span></span><span style="display:flex;"><span>kube_pod_container_status_terminated
</span></span><span style="display:flex;"><span>kube_pod_container_status_terminated_reason
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 30分钟内重启过的pod</span>
</span></span><span style="display:flex;"><span>changes<span style="color:#f92672">(</span>kube_pod_container_status_restarts_total<span style="color:#f92672">[</span>30m<span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 容器资源配额</span>
</span></span><span style="display:flex;"><span>kube_pod_container_resource_requests<span style="color:#f92672">{</span>resource<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cpu&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_container_resource_limits<span style="color:#f92672">{</span>resource<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cpu&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_container_resource_requests<span style="color:#f92672">{</span>resource<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;memory&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_container_resource_limits<span style="color:#f92672">{</span>resource<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;memory&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>replicaset</p>
</li>
<li>
<p>deploy</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#各个deployment的副本数量</span>
</span></span><span style="display:flex;"><span>kube_deployment_status_replicas
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#各个deployment不可用的副本数量</span>
</span></span><span style="display:flex;"><span>kube_deployment_status_replicas_unavailable
</span></span></code></pre></div></li>
<li>
<p>daemonset</p>
</li>
<li>
<p>sts</p>
</li>
<li>
<p>job</p>
</li>
<li>
<p>cronjob</p>
</li>
<li>
<p>service</p>
</li>
<li>
<p>endpoint</p>
</li>
<li>
<p>ingress</p>
</li>
<li>
<p>storageclass</p>
</li>
<li>
<p>persistentvolume</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kube_persistentvolume_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Available&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_persistentvolume_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Bound&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_persistentvolume_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Failed&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_persistentvolume_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Pending&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_persistentvolume_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Released&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>persistentvolumeclaim</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kube_persistentvolumeclaim_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Bound&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_persistentvolumeclaim_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Lost&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_persistentvolumeclaim_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Pending&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>configmap</p>
</li>
<li>
<p>secret</p>
</li>
<li>
<p>poddisruptionbudget</p>
</li>
<li>
<p>horizontalpodautoscaler</p>
</li>
<li>
<p>networkpolicy</p>
</li>
<li>
<p>lease</p>
</li>
<li>
<p>limitrange</p>
</li>
<li>
<p>mutatingwebhookconfiguration</p>
</li>
<li>
<p>validatingwebhookconfiguration</p>
</li>
<li>
<p>volumeattachment</p>
</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">KubeStateMetricsListErrors</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#ae81ff">kube-state-metrics is experiencing errors at an elevated rate in list operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#ae81ff">kube-state-metrics is experiencing errors in list operations.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      (sum(rate(kube_state_metrics_list_total{job=&#34;kube-state-metrics&#34;,result=&#34;error&#34;}[5m]))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        /
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      sum(rate(kube_state_metrics_list_total{job=&#34;kube-state-metrics&#34;}[5m])))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &gt; 0.01</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">15m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">KubeStateMetricsWatchErrors</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#ae81ff">kube-state-metrics is experiencing errors at an elevated rate in watch operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#ae81ff">kube-state-metrics is experiencing errors in watch operations.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      (sum(rate(kube_state_metrics_watch_total{job=&#34;kube-state-metrics&#34;,result=&#34;error&#34;}[5m]))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        /
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      sum(rate(kube_state_metrics_watch_total{job=&#34;kube-state-metrics&#34;}[5m])))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &gt; 0.01</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">15m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">KubeStateMetricsShardingMismatch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#ae81ff">kube-state-metrics pods are running with different --total-shards configuration, some Kubernetes objects may be exposed multiple times or not exposed at all.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#ae81ff">kube-state-metrics sharding is misconfigured.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      stdvar (kube_state_metrics_total_shards{job=&#34;kube-state-metrics&#34;}) != 0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">15m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">KubeStateMetricsShardsMissing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#ae81ff">kube-state-metrics shards are missing, some Kubernetes objects are not being exposed.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#ae81ff">kube-state-metrics shards are missing.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      2^max(kube_state_metrics_total_shards{job=&#34;kube-state-metrics&#34;}) - 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      sum( 2 ^ max by (shard_ordinal) (kube_state_metrics_shard_ordinal{job=&#34;kube-state-metrics&#34;}) )
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      != 0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">15m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span></code></pre></div>
</div>



    
	
  

    
	
  

    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-85678841c2799ee0263a00ba7f20650b"></h1>
	<div class="lead">devops 文档中心</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-652da66038de8db9de90975a7d28f264">ArgoCD</h1>
	<div class="lead">k8s argoCD</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-14" class="text-body-secondary">Wednesday, May 14, 2025</time>
        
	</div>
	<p>argo CD <sub>v2.13.3</sub> 是一个遵循gitops 理念的持续交付工具,支持对多k8s集群执行部署</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create namespace argocd
</span></span><span style="display:flex;"><span>kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n argocd </span>
</span></span><span style="display:flex;"><span>NAME                                                READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>argocd-application-controller-0                     1/1     Running   <span style="color:#ae81ff">0</span>          5m14s
</span></span><span style="display:flex;"><span>argocd-applicationset-controller-7dd8f694d4-zmfbt   1/1     Running   <span style="color:#ae81ff">0</span>          5m14s
</span></span><span style="display:flex;"><span>argocd-dex-server-b5885bb5d-cbw4p                   1/1     Running   <span style="color:#ae81ff">0</span>          5m14s
</span></span><span style="display:flex;"><span>argocd-notifications-controller-564cb78f6f-8qrj9    1/1     Running   <span style="color:#ae81ff">0</span>          5m14s
</span></span><span style="display:flex;"><span>argocd-redis-7857fdd468-b2g8m                       1/1     Running   <span style="color:#ae81ff">0</span>          5m14s
</span></span><span style="display:flex;"><span>argocd-repo-server-5566c77dd9-k55l9                 1/1     Running   <span style="color:#ae81ff">0</span>          5m14s
</span></span><span style="display:flex;"><span>argocd-server-6c44fb8d8-zvpnn                       1/1     Running   <span style="color:#ae81ff">0</span>          5m14s
</span></span></code></pre></div><p>查看初始化密码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n argocd get secret  argocd-initial-admin-secret -ojsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.data.password}&#39;</span>|base64 -d
</span></span></code></pre></div><p><strong>支持通过ui 界面和argocd 命令操作</strong></p>
<ul>
<li>
<p><strong>通过argocd 命令操作</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/argoproj/argo-cd/releases/download/v2.13.3/argocd-linux-amd64 -O /usr/bin/argocd
</span></span><span style="display:flex;"><span>chmod +x /usr/bin/argocd
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl get svc -n argocd argocd-server </span>
</span></span><span style="display:flex;"><span>NAME            TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>                      AGE
</span></span><span style="display:flex;"><span>argocd-server   NodePort   172.168.227.98   &lt;none&gt;        80:32322/TCP,443:30534/TCP   71m
</span></span></code></pre></div><p>登录argocd</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># argocd login argocd-server</span>
</span></span><span style="display:flex;"><span>FATA<span style="color:#f92672">[</span>0000<span style="color:#f92672">]</span> dial tcp: lookup argocd-server on 192.168.0.1:53: no such host 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># argocd login  172.168.227.98</span>
</span></span><span style="display:flex;"><span>WARNING: server certificate had error: tls: failed to verify certificate: x509: cannot validate certificate <span style="color:#66d9ef">for</span> 172.168.227.98 because it doesn<span style="color:#e6db74">&#39;t contain any IP SANs. Proceed insecurely (y/n)? y
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Username: admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Password: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>admin:login<span style="color:#e6db74">&#39; logged in successfully
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Context &#39;</span>172.168.227.98<span style="color:#960050;background-color:#1e0010">&#39;</span> updated
</span></span></code></pre></div><p>更新密码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>argocd account update-password
</span></span></code></pre></div></li>
</ul>
<p>部署一个demo</p>
<ol>
<li>
<p>将名称空间从default 切换到 argocd</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl config set-context --current --namespace<span style="color:#f92672">=</span>argocd
</span></span></code></pre></div></li>
<li>
<p>部署应用</p>
<blockquote>
<p><a href="https://github.com/argoproj/argocd-example-apps.git" target="_blank">https://github.com/argoproj/argocd-example-apps.git</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>argocd app create guestbook <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--repo https://gitee.com/mingtian66/argocd-example-apps.git   <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--path guestbook <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--dest-server https://kubernetes.default.svc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--dest-namespace test
</span></span></code></pre></div></li>
<li>
<p>查看app 状态，当前应用并未部署。处于OutOfSync 状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>argocd app get  guestbook 
</span></span></code></pre></div></li>
<li>
<p>执行部署,该命令从git 仓库获取清单并执行<code>kubectl apply</code> 动作</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>argocd app sync guestbook
</span></span></code></pre></div></li>
<li>
<p>销毁app</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>argocd app delete guestbook
</span></span></code></pre></div></li>
</ol>
<p>通过ui界面操作</p>
<p><img src="https://img2024.cnblogs.com/blog/2108528/202501/2108528-20250126145019694-573427502.png" alt=""></p>
<h3 id="参考">参考</h3>
<p><a href="https://argo-cd.readthedocs.io/" target="_blank">docs</a>|<a href="https://github.com/argoproj/argo-cd/releases/tag/v2.13.3" target="_blank">Release</a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-57d91b933c05dbf4df1f70a14c3ca6cf"></h1>
	<div class="lead">jenkins 文档中心</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-397d2bc7c55645a7a639502d8299f63e">jenkins</h1>
	<div class="lead">jenkins|devops</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h3 id="服务部署">服务部署</h3>
<blockquote>
<p>端口 8080  5000</p>
</blockquote>
<hr>
<p><strong>数据目录</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /jenkins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pvcreate /dev/sdb
</span></span><span style="display:flex;"><span>vgextend centos /dev/sdb
</span></span><span style="display:flex;"><span>lvcreate --name jenkins --size 99G  centos
</span></span><span style="display:flex;"><span>mkfs.ext4 /dev/mapper/centos-jenkins
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;/dev/mapper/centos-jenkins /jenkins        ext4     defaults,noatime        0 0&#39;</span> &gt;&gt;/etc/fstab
</span></span><span style="display:flex;"><span>mount -a
</span></span></code></pre></div><p><strong>安装jenkins</strong>

  
  
  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>安装方式</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="yum 方式启动" aria-controls="tabs-00-01" aria-selected="true">
        yum 方式启动
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="docker 方式启动" aria-controls="tabs-00-02" aria-selected="false">
        Docker 方式启动
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="tomcat 方式启动" aria-controls="tabs-00-03" aria-selected="false">
        tomcat 方式启动
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget --no-check-certificate -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /usr/share/java/jenkins.war 升级时替换该文件</span>
</span></span><span style="display:flex;"><span>yum install -y java-11-openjdk.x86_64  jenkins
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;JENKINS_HOME=/jenkins&#39;</span> &gt;/etc/jenkins.env
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>EnvironmentFile<span style="color:#f92672">=</span>/etc/jenkins.env
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USER<span style="color:#f92672">=</span>root
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload 
</span></span><span style="display:flex;"><span>systemctl restart jenkins
</span></span><span style="display:flex;"><span>systemctl enable jenkins --now
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --name jenkins <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--restart<span style="color:#f92672">=</span>always <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--ip<span style="color:#f92672">=</span>192.168.31.241 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--network macvlan31 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v /jenkins:/var/jenkins_home <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v /usr/local/jdk:/usr/local/jdk <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v /usr/local/maven:/usr/local/maven <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e JENKINS_Uc<span style="color:#f92672">=</span>https://mirrors.cloud.tencent.com/ienkins/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e JENKINS_UC DOWNLOAD<span style="color:#f92672">=</span>https://mirrors.cloud.tencent.com/jenkins <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d jenkins/jenkins:lts
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>JENKINS_HOME<span style="color:#f92672">=</span>/jenkins
</span></span><span style="display:flex;"><span>prerun<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    yum install fontconfig freetype -y
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>download<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    wget https://download.java.net/java/ga/jdk11/openjdk-11_linux-x64_bin.tar.gz
</span></span><span style="display:flex;"><span>    wget https://mirrors.tuna.tsinghua.edu.cn/jenkins/war-stable/2.452.1/jenkins.war
</span></span><span style="display:flex;"><span>    wget https://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.100/bin/apache-tomcat-8.5.100.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jdk<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    tar xf openjdk-11_linux-x64_bin.tar.gz -C /opt
</span></span><span style="display:flex;"><span>    ln -svf  /opt/<span style="color:#f92672">{</span>jdk-11,jdk<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat&gt;&gt;/etc/profile<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/opt/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_JRE=\$JAVA_HOME/jre
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=\$JAVA_HOME/lib:\$JAVA_HOME/jre/lib
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=\$JAVA_HOME/bin:\$JAVA_JRE/bin:$PATH:.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    source /etc/profile
</span></span><span style="display:flex;"><span>    java -version
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>start<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;export JENKINS_HOME=</span><span style="color:#e6db74">${</span>JENKINS_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> /etc/profile
</span></span><span style="display:flex;"><span>    source /etc/profile
</span></span><span style="display:flex;"><span>    tar xf apache-tomcat-8.5.100.tar.gz -C /opt
</span></span><span style="display:flex;"><span>    ln -svf /opt/apache-tomcat-8.5.100/ /opt/tomcat
</span></span><span style="display:flex;"><span>    cp  jenkins.war /opt/tomcat/webapps/
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 前台启动tomcat /opt/tomcat/bin/catalina.sh run </span>
</span></span><span style="display:flex;"><span>    /opt/tomcat/bin/catalina.sh start 
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    prerun
</span></span><span style="display:flex;"><span>    download
</span></span><span style="display:flex;"><span>    jdk
</span></span><span style="display:flex;"><span>    start
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>main
</span></span></code></pre></div>
    </div>
</div>
</p>
<h4 id="安装插件">安装插件</h4>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Info</h4>

    <p>修改jenkins插件仓库地址</p>
<blockquote>
<p>ui操作路径： Dashboard&gt;Manager Jenkins&gt;Plugins&gt;Advanced setting</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>https://updates.jenkins.io/update-center.json
</span></span><span style="display:flex;"><span>https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json
</span></span></code></pre></div>

</div>

<blockquote>
<p>插件安装命令： <code>jenkins-plugin-cli --plugins uno-choice:2.8.3</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>跳过证书认证【 skip-certificate-check 】
</span></span><span style="display:flex;"><span>中文插件 chinese 【 Localization: Chinese <span style="color:#f92672">(</span>Simplified<span style="color:#f92672">)</span> 】
</span></span><span style="display:flex;"><span>基于RBAC的权限管理 【 Role-based Authorization Strategy 】
</span></span><span style="display:flex;"><span>参数化构建支持复选框【 uno-choice 】
</span></span><span style="display:flex;"><span>pipeline流水线插件【 Pipeline 】
</span></span><span style="display:flex;"><span>pipline可视化插件 【 Pipeline: Stage View】
</span></span><span style="display:flex;"><span>Blue Ocean插件 【 Blue Ocean 】
</span></span><span style="display:flex;"><span>聚合git命令【 Git 】
</span></span><span style="display:flex;"><span>支持参数化构建和jsonpath解析的webhook触发器 【 Generic Webhook Trigger 】
</span></span><span style="display:flex;"><span>邮件扩展插件 【 Email Extension 】
</span></span><span style="display:flex;"><span>集成sonarqube扫描插件【 SonarQube Scanner 】
</span></span><span style="display:flex;"><span>-------------------------
</span></span><span style="display:flex;"><span>在consol的输出中添加时间戳 【 Build Timestamp 】
</span></span><span style="display:flex;"><span>清理流水线中产生的历史文件 【 Workspace Cleanup 】
</span></span><span style="display:flex;"><span>备份全局配置和job配置【 ThinBackup 】 
</span></span><span style="display:flex;"><span>支持从git中选择分支、版本、tag 的功能【 git parameter 】
</span></span><span style="display:flex;"><span>Blue Ocean插件 【 BlueOcean Aggregator】
</span></span><span style="display:flex;"><span>流水线Pipeline插件 【 workflow-aggregator 】
</span></span><span style="display:flex;"><span>ssh连接到部署主机插件 【 Publish Over SSH 】
</span></span><span style="display:flex;"><span>把docker作为agent使用【 Docker Slaves 】
</span></span><span style="display:flex;"><span>构建maven项目【 Maven Integration 】
</span></span><span style="display:flex;"><span>在gitlab 使用触发器构建时可以匿名触发构建【 Build Authorization Token Root 】
</span></span><span style="display:flex;"><span>集成ldap认证登录 【 ldap 】
</span></span></code></pre></div><hr>
<h4 id="通用环境">通用环境</h4>
<ul>
<li>git</li>
<li>ssh-key认证</li>
<li>docker</li>
<li>ansible</li>
<li>kubectl</li>
</ul>
<h4 id="项目编译环境">项目编译环境</h4>

  
  
  

  
  
  
  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          aria-controls="tabs-02-00" aria-selected="false">
        <strong>构建环境</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="maven 编译环境" aria-controls="tabs-02-01" aria-selected="true">
        maven 编译环境
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-02" role="tab"
          data-td-tp-persist="gradle 编译环境" aria-controls="tabs-02-02" aria-selected="false">
        Gradle 编译环境
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-03" role="tab"
          data-td-tp-persist="golang 编译环境" aria-controls="tabs-02-03" aria-selected="false">
        golang 编译环境
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-04" role="tab"
          data-td-tp-persist="nodejs编译环境npm" aria-controls="tabs-02-04" aria-selected="false">
        nodejs编译环境npm
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-05-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-05" role="tab"
          data-td-tp-persist="nodejs编译环境yarn" aria-controls="tabs-02-05" aria-selected="false">
        nodejs编译环境yarn
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-06-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-06" role="tab"
          data-td-tp-persist="php编译环境" aria-controls="tabs-02-06" aria-selected="false">
        php编译环境
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-07-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-07" role="tab"
          data-td-tp-persist="python编译环境" aria-controls="tabs-02-07" aria-selected="false">
        python编译环境
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <ul>
<li>
<p>jdk 环境</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://download.java.net/java/ga/jdk11/openjdk-11_linux-x64_bin.tar.gz
</span></span><span style="display:flex;"><span>tar xf openjdk-11_linux-x64_bin.tar.gz -C /opt
</span></span><span style="display:flex;"><span>ln -svf  /opt/<span style="color:#f92672">{</span>jdk-11,jdk<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat&gt;&gt;/etc/profile<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/opt/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_JRE=\$JAVA_HOME/jre
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=\$JAVA_HOME/lib:\$JAVA_HOME/jre/lib
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=\$JAVA_HOME/bin:\$JAVA_JRE/bin:$PATH:.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>source /etc/profile
</span></span><span style="display:flex;"><span>java -version
</span></span></code></pre></div></li>
<li>
<p>maven 环境</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://mirrors.aliyun.com/apache/maven/maven-3/3.8.8/binaries/apache-maven-3.8.8-bin.tar.gz
</span></span><span style="display:flex;"><span>tar xf apache-maven-3.8.8-bin.tar.gz -C /opt
</span></span><span style="display:flex;"><span>ln -svf /opt/apache-maven-*  /opt/maven
</span></span><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PATH<span style="color:#e6db74">}</span>:/opt/maven/bin
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 设置国内镜像地址</span>
</span></span><span style="display:flex;"><span>sed -i /<span style="color:#ae81ff">\&lt;</span>mirrors<span style="color:#ae81ff">\&gt;</span>/<span style="color:#ae81ff">\a</span><span style="color:#e6db74">&#34;&lt;mirror&gt;\n  &lt;id&gt;aliyunmaven&lt;/id&gt;\n  &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;\n  &lt;name&gt;阿里云公共仓库&lt;/name&gt;\n  &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt;\n&lt;/mirror&gt;&#34;</span> /opt/maven/conf/settings.xml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mvn clean package -DskipTests<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>mvn clean package
</span></span><span style="display:flex;"><span>mvn test
</span></span></code></pre></div></li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-02" role="tabpanel" aria-labelled-by="tabs-02-02-tab" tabindex="2">
        <ul>
<li>
<p>jdk 环境</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://download.java.net/java/ga/jdk11/openjdk-11_linux-x64_bin.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#75715e">#https://download.java.net/openjdk/jdk17.0.0.1/ri/openjdk-17.0.0.1+2_linux-x64_bin.tar.gz</span>
</span></span><span style="display:flex;"><span>tar xf openjdk-11_linux-x64_bin.tar.gz -C /opt
</span></span><span style="display:flex;"><span>ln -svf  /opt/<span style="color:#f92672">{</span>jdk-11,jdk<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat&gt;&gt;/etc/profile<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/opt/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_JRE=\$JAVA_HOME/jre
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=\$JAVA_HOME/lib:\$JAVA_HOME/jre/lib
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=\$JAVA_HOME/bin:\$JAVA_JRE/bin:$PATH:.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>source /etc/profile
</span></span><span style="display:flex;"><span>java -version
</span></span></code></pre></div></li>
<li>
<p>gradle 环境</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 打包并跳过测试</span>
</span></span><span style="display:flex;"><span>gradle build -x test
</span></span></code></pre></div></li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-03" role="tabpanel" aria-labelled-by="tabs-02-03-tab" tabindex="2">
        <ul>
<li>
<p>golang 1.20.6</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># wget https://golang.google.cn/dl/go1.23.1.linux-amd64.tar.gz</span>
</span></span><span style="display:flex;"><span>wget https://golang.google.cn/dl/go1.20.6.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar xf go1.20.6.linux-amd64.tar.gz -C /opt/
</span></span><span style="display:flex;"><span>cat &gt;&gt;/etc/profile <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export GOROOT=/opt/go
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export GOPATH=/opt/gopath
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=\$GOPATH/bin:\$GOROOT/bin:$PATH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export GO111MODULE=&#34;on&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export GOPROXY=&#34;https://goproxy.cn,direct&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>source /etc/profile
</span></span><span style="display:flex;"><span>go version
</span></span><span style="display:flex;"><span>go env
</span></span></code></pre></div></li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-04" role="tabpanel" aria-labelled-by="tabs-02-04-tab" tabindex="2">
        <ul>
<li>
<p>v16.x</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://nodejs.org/dist/v14.21.3/node-v14.21.3-linux-x64.tar.gz
</span></span><span style="display:flex;"><span>tar xf node-v14.21.3-linux-x64.tar.gz -C /opt
</span></span><span style="display:flex;"><span>ln -svf /opt/node-v14.21.3-linux-x64/ /opt/node
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;export PATH=/opt/node/bin:</span>$PATH<span style="color:#e6db74">&#34;</span> &gt;&gt;/etc/profile
</span></span><span style="display:flex;"><span>source /etc/profile
</span></span><span style="display:flex;"><span>npm config set registry https://registry.npmmirror.com
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># https://nodejs.org/zh-cn/download/prebuilt-binaries</span>
</span></span><span style="display:flex;"><span>wget https://nodejs.org/dist/v16.20.2/node-v16.20.2-linux-x64.tar.xz
</span></span><span style="display:flex;"><span>tar xf node-v16.20.2-linux-x64.tar.xz -C /opt
</span></span><span style="display:flex;"><span>ln -svf /opt/node-v16.20.2-linux-x64/ /opt/node
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;export PATH=/opt/node/bin:</span>$PATH<span style="color:#e6db74">&#34;</span> &gt;&gt;/etc/profile
</span></span><span style="display:flex;"><span>source /etc/profile
</span></span><span style="display:flex;"><span>npm config set registry https://registry.npmmirror.com
</span></span></code></pre></div><p>验证</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>node -v
</span></span><span style="display:flex;"><span><span style="color:#75715e"># v16.20.2</span>
</span></span><span style="display:flex;"><span>npm -v
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 8.19.4</span>
</span></span></code></pre></div><p>构建命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install --force <span style="color:#f92672">&amp;&amp;</span> npm run build
</span></span></code></pre></div><p>创建一个vue项目</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 安装vue-cli 工具</span>
</span></span><span style="display:flex;"><span>npm install vue-cli -g 
</span></span><span style="display:flex;"><span>ls /opt/node/bin/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化项目</span>
</span></span><span style="display:flex;"><span>vue-init webpack demo
</span></span><span style="display:flex;"><span>cd demo/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 运行项目</span>
</span></span><span style="display:flex;"><span>npm  run dev
</span></span></code></pre></div></li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-05" role="tabpanel" aria-labelled-by="tabs-02-05-tab" tabindex="2">
        <ul>
<li>
<p>v16.x</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># https://nodejs.org/zh-cn/download/prebuilt-binaries</span>
</span></span><span style="display:flex;"><span>wget https://nodejs.org/dist/v16.20.2/node-v16.20.2-linux-x64.tar.xz
</span></span><span style="display:flex;"><span>tar xf node-v16.20.2-linux-x64.tar.xz -C /opt
</span></span><span style="display:flex;"><span>ln -svf /opt/node-v16.20.2-linux-x64/ /opt/node
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;export PATH=/opt/node/bin:</span>$PATH<span style="color:#e6db74">&#34;</span> &gt;&gt;/etc/profile
</span></span><span style="display:flex;"><span>source /etc/profile
</span></span><span style="display:flex;"><span>npm config set registry https://registry.npmmirror.com
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>node -v
</span></span><span style="display:flex;"><span><span style="color:#75715e"># v16.20.2</span>
</span></span><span style="display:flex;"><span>npm -v
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 8.19.4</span>
</span></span><span style="display:flex;"><span>npm install yarn -g 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lavm-ioreaqndwv demo<span style="color:#f92672">]</span><span style="color:#75715e"># ls /opt/node/bin/</span>
</span></span><span style="display:flex;"><span>corepack  node  npm  npx  vue  vue-init  vue-list  yarn  yarnpkg
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lavm-ioreaqndwv demo<span style="color:#f92672">]</span><span style="color:#75715e"># yarn config set registry https://registry.npmmirror.com</span>
</span></span><span style="display:flex;"><span>yarn config v1.22.22
</span></span><span style="display:flex;"><span>success Set <span style="color:#e6db74">&#34;registry&#34;</span> to <span style="color:#e6db74">&#34;https://registry.npmmirror.com&#34;</span>.
</span></span><span style="display:flex;"><span>Done in 0.05s.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 编译命令</span>
</span></span><span style="display:flex;"><span>yarn install
</span></span><span style="display:flex;"><span>yarn build
</span></span></code></pre></div></li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-06" role="tabpanel" aria-labelled-by="tabs-02-06-tab" tabindex="2">
        <p>待补充</p>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-07" role="tabpanel" aria-labelled-by="tabs-02-07-tab" tabindex="2">
        <p>待补充</p>

    </div>
</div>

<hr>
<h4 id="安装node节点">安装node节点</h4>
<p>jenkins 支持分布式构建，按照角色可以分为master 和 node 节点。master 负责调度和控制，node节点负责执行调度来的流水线任务。按照一下步骤配置node节点：</p>
<p>master 开启端口监听</p>
<blockquote>
<p>配置方式： Dashboard &gt; Manage Jenkins &gt; Security</p>
</blockquote>
<ol>
<li>
<p>在jenkins master 端开启用于agent连接的端口,默认是5000
<img src="/docs/devops/jenkins/img/image-12.png" alt="alt text"></p>
</li>
<li>
<p>新增一个node 节点</p>
<blockquote>
<p>配置方式： Dashboard &gt; Manage Jenkins &gt; Nodes
新增node节点配置
<img src="/docs/devops/jenkins/img/image-13-0.png" alt="image-20241227220332459"></p>
</blockquote>
<p><img src="/docs/devops/jenkins/img/image-13.png" alt="alt text"></p>
<ol>
<li>
<p>node节点与master时钟同步</p>
</li>
<li>
<p>node 节点安装java环境</p>
</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -sO http://175.178.65.213:8080/jnlpJars/agent.jar
</span></span><span style="display:flex;"><span>java -jar agent.jar -url http://175.178.65.213:8080/ -secret 689e3241630eb34c444894f78caed7eec4c6d83f2b555bd917e8be369f70a59e -name <span style="color:#e6db74">&#34;seagull-build01&#34;</span> -workDir <span style="color:#e6db74">&#34;/jenkins&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/jenkins-agent.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=jenkins-agent service https://jenkins.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/jdk/bin/java -jar /opt/agent.jar -url http://175.178.65.213:8080/ -secret 689e3241630eb34c444894f78caed7eec4c6d83f2b555bd917e8be369f70a59e -name &#34;seagull-build01&#34; -workDir &#34;/jenkins&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable jenkins --now
</span></span><span style="display:flex;"><span>systemctl status jenkins
</span></span></code></pre></div></li>
<li>
<p>调度任务测试</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  agent <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    label <span style="color:#e6db74">&#39;seagull&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;test&#39;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>      steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#39;test&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
</li>
</ol>
<h3 id="流水线">流水线</h3>
<h4 id="自由风格流水线">自由风格流水线</h4>
<p>选择freestyle 模式构建，下面是一个简单ci实例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 构建命令</span>
</span></span><span style="display:flex;"><span>sh -c <span style="color:#e6db74">&#34;git clone https://gitee.com/mingtian66/magic-api.git &amp;&amp; cd magic-api &amp;&amp; git checkout master &amp;&amp; cd magic-api &amp;&amp; JAVA_HOME=/opt/jdk-17.0.11;PATH=</span>$JAVA_HOME<span style="color:#e6db74">/bin:</span>$PATH<span style="color:#e6db74">; mvn clean package &#34;</span>
</span></span></code></pre></div><p>构建后清理workspace,依赖插件【Workspace Cleanup】</p>
<h4 id="触发构建">触发构建</h4>
<ul>
<li>
<p><strong>Trigger builds remotely (e.g., from scripts) 【webhook构建】</strong></p>
<p><img src="/docs/devops/jenkins/img/image-1.png" alt="alt text">
配置后打开浏览器在地址栏输入一下内容并回车，会发现magic_api项目被触发了一次构建。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http://10.4.7.250:8080/jenkins/job/magic_api/build?token<span style="color:#f92672">=</span>54fb6627dbaa37721048e4549db3224d
</span></span></code></pre></div><p>携带用户名和密码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -uadmin:admin http://10.4.7.250:8080/jenkins/job/magic_api/build?token<span style="color:#f92672">=</span>54fb6627dbaa37721048e4549db3224d
</span></span></code></pre></div><p>参数化构建</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -uadmin:admin <span style="color:#e6db74">&#34;http://10.4.7.250:8080/jenkins/job/magic_api/buildWithParameters?token=54fb6627dbaa37721048e4549db3224d&amp;VERSION=4.4.4&#34;</span>
</span></span></code></pre></div><p>上面这种方式未登录用户无法触发，如果要绕过这个问题需要安装插件【Build Authorization Token Root】实现匿名构建
调用方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http://10.4.7.250:8080/jenkins/buildByToken/build?job<span style="color:#f92672">=</span>magic_api&amp;token<span style="color:#f92672">=</span>54fb6627dbaa37721048e4549db3224d
</span></span></code></pre></div></li>
<li>
<p><strong>Build after other projects are built 【其他job触发构建】</strong></p>
</li>
<li>
<p><strong>Build periodically 【周期构建】</strong></p>
<p>H 表示hash 取随机数字，防止多个job同时构建</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>* * * * *  每分钟构建一次
</span></span><span style="display:flex;"><span>H * * * *  使用 H 代替随机数作为起始时间，每分钟构建一次。这个随机数是有job名称hash后得到的，用于避免多个job同时构建
</span></span><span style="display:flex;"><span>H/15 * * * *  使用 H 代替随机数作为起始时间，每间隔15分钟构建一次
</span></span><span style="display:flex;"><span>H<span style="color:#f92672">(</span>0-10<span style="color:#f92672">)</span> * * * *  在0-10分钟内取一个随机值作为起始时间，每间隔15分钟构建一次
</span></span></code></pre></div><p><img src="/docs/devops/jenkins/img/image.png" alt="alt text"></p>
</li>
<li>
<p><strong>Poll SCM 【jenkins主动周期性发起检查代码变动，则构建】</strong></p>
</li>
</ul>
<h4 id="pipline-流水线">pipline 流水线</h4>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Info</h4>

    <p><sub>需要安装 【 Pipeline 】 插件</sub></p>
<p>优势：灵活性高，代码即服务</p>
<p>语法：1. 声明式语法 2.脚本式语法 。两者可以结合使用,通过在steps{ } 中嵌入 scripts{} 书写groovy脚本。</p>


</div>

<h4 id="pipline-声明式语法">pipline 声明式语法</h4>
<blockquote>
<p>Jenkins Pipeline 的定义被写入一个文本文件（称为Jenkinsfile）</p>
</blockquote>
<pre class="mermaid">graph LR
A[[pipeline]]
B[agent]
C[environment]
D[options]
H[triggers]
E[parameters]
F[stages]
G[post]
F1[stage]
F12[input]
F13[when]
F14[parallel]
F11[steps]
F111[script]

A -.-&gt;|定义流水线任务运行的node| B
A -.-&gt; C
A -.-&gt; D
A -.-&gt; E
A -.-&gt; F
A -.-&gt; G
A -.-&gt; H
F -.-&gt; agent
F -.-&gt; environment



F -.-&gt; F1 -.-&gt; F11
F1 -.-&gt; F12
F1 -.-&gt; F13
F11 -.-&gt; F111
F1 -.-&gt; F14


subgraph 全局配置  
    B
    C
    D
    H
    E
    F
    G
    
end 

subgraph stages
	agent
    F1
    environment
    
end

subgraph stage
    F11
    F12
    F13
    F14
end 

subgraph steps
    F111
end </pre>
<p>在jenkins中提供了声明式语法生成器，以下是打开这个生成器的方法：</p>
<p><img src="/docs/devops/jenkins/img/image-3.png" alt="alt text">
<img src="/docs/devops/jenkins/img/image-4.png" alt="alt text"></p>
<ul>
<li>
<p><strong>agent</strong> 指定了流水线在那个节点运行</p>
<blockquote>
<p>位置：全局、stages</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">// 在任意节点运行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>agent any
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">// 在存在标签为 &#39;nodejs&#39;的节点运行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>agent <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  label <span style="color:#e6db74">&#39;nodejs&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>agent <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  label <span style="color:#e6db74">&#39;my-label1 &amp;&amp; my-label2&#39;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>agent <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   label <span style="color:#e6db74">&#39;my-label1 || my-label2&#39;</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">// 没有节点运行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>agent none
</span></span></code></pre></div><ul>
<li>
<p><strong>动态agent</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>待补充
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p><strong>environment</strong> 指定变量</p>
<blockquote>
<p>位置：全局、stages</p>
</blockquote>
<p>environment用于定义环境变量，在jenkins中已经包含了一些内置变量，例如：<code>${JOB_NAME}、${BUILD_NUMBER} </code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent any
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    println <span style="color:#e6db74">&#34;构建ID在 jenkins1.597+ 版本后与BUILD_NUMBER 功能一样 ： </span><span style="color:#e6db74">${</span>BUILD_ID<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                    println <span style="color:#e6db74">&#34;构建NUMBER ： </span><span style="color:#e6db74">${</span>BUILD_NUMBER<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                    // 拼接了jenkins-<span style="color:#e6db74">${</span>JOB_NAME<span style="color:#e6db74">}</span>-<span style="color:#e6db74">${</span>BUILD_NUMBER<span style="color:#e6db74">}</span> 
</span></span><span style="display:flex;"><span>                    println <span style="color:#e6db74">&#34;jenkins-JOB_NAME-BUILD_NUMBER: </span><span style="color:#e6db74">${</span>BUILD_TAG<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                    println BUILD_URL
</span></span><span style="display:flex;"><span>                    // println JAVA_HOME
</span></span><span style="display:flex;"><span>                    println JENKINS_URL
</span></span><span style="display:flex;"><span>                    println JOB_NAME 
</span></span><span style="display:flex;"><span>                    println NODE_NAME
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>自定义环境变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  JAVA_HOME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/opt/jdk&#34;</span>
</span></span><span style="display:flex;"><span>  JAVA_JRE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$JAVA_HOME/jre&#34;</span>
</span></span><span style="display:flex;"><span>  CLASSPATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$JAVA_HOME/lib:$JAVA_HOME/jre/lib&#34;</span>
</span></span><span style="display:flex;"><span>  PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$JAVA_HOME/bin:$JAVA_JRE/bin:$PATH:.&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>动态接收环境变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Using returnStdout
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  CC <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;${sh(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            returnStdout: true,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            script: &#39;hostname&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        )}&#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Using returnStatus
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    EXIT_STATUS <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;${sh(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            returnStatus: true,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            script: &#39;python3&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        )}&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p><strong>options</strong> 指定流水线选项</p>
<blockquote>
<p>位置：全局</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">指定历史构建</span>
</span></span><span style="display:flex;"><span>options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  buildDiscarder <span style="color:#a6e22e">logRotator</span><span style="color:#f92672">(</span>artifactDaysToKeepStr: <span style="color:#e6db74">&#39;1&#39;</span><span style="color:#f92672">,</span> artifactNumToKeepStr: <span style="color:#e6db74">&#39;5&#39;</span><span style="color:#f92672">,</span> daysToKeepStr: <span style="color:#e6db74">&#39;1&#39;</span><span style="color:#f92672">,</span> numToKeepStr: <span style="color:#e6db74">&#39;5&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p><strong>parameters</strong> 指定参数</p>
<blockquote>
<p>位置：全局</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>parameters <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  activeChoice choiceType: <span style="color:#e6db74">&#39;PT_SINGLE_SELECT&#39;</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;选择发布到哪个环境&#39;</span><span style="color:#f92672">,</span> filterLength: <span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> filterable: <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> name: <span style="color:#e6db74">&#39;envirment&#39;</span><span style="color:#f92672">,</span> randomName: <span style="color:#e6db74">&#39;choice-parameter-26043236877113&#39;</span><span style="color:#f92672">,</span> script: groovyScript<span style="color:#f92672">(</span>fallbackScript: <span style="color:#f92672">[</span>classpath: <span style="color:#f92672">[],</span> oldScript: <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">,</span> sandbox: <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> script: <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">],</span> script: <span style="color:#f92672">[</span>classpath: <span style="color:#f92672">[],</span> oldScript: <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">,</span> sandbox: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> script: <span style="color:#e6db74">&#39;&#39;&#39;return [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    \&#39;dev\&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    \&#39;uat\&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]&#39;&#39;&#39;</span><span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>    reactiveChoice choiceType: <span style="color:#e6db74">&#39;PT_CHECKBOX&#39;</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;选择发布到哪台机器&#39;</span><span style="color:#f92672">,</span> filterLength: <span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> filterable: <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> name: <span style="color:#e6db74">&#39;hosts&#39;</span><span style="color:#f92672">,</span> randomName: <span style="color:#e6db74">&#39;choice-parameter-26043242534733&#39;</span><span style="color:#f92672">,</span> referencedParameters: <span style="color:#e6db74">&#39;envirment&#39;</span><span style="color:#f92672">,</span> script: groovyScript<span style="color:#f92672">(</span>fallbackScript: <span style="color:#f92672">[</span>classpath: <span style="color:#f92672">[],</span> oldScript: <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">,</span> sandbox: <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> script: <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">],</span> script: <span style="color:#f92672">[</span>classpath: <span style="color:#f92672">[],</span> oldScript: <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">,</span> sandbox: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> script: <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if (envirment== &#34;dev&#34;) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  return [&#34;db2-dev02-s1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;db2-dev03-s1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;mongodb-dev01-s1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;mongodb-dev02-s1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;mongodb-dev03-s1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;mongodb-dev04-s1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;mongodb-dev05-s1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;mongodb-dev06-s1&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">} else if (envirment== &#34;uat&#34;) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  return [&#34;db2-uat01-s1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;db2-uat02-s1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;db2-uat03-s1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;db2-uat04-s1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;seagullvictora01-uat-s2&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">} else {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  return [&#34;请选择环境&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;&#39;&#39;</span><span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p><strong>triggers</strong></p>
<blockquote>
<p>位置：全局</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>triggers <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  pollSCM ignorePostCommitHooks: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> scmpoll_spec: <span style="color:#e6db74">&#39;H 9-18/2 * * 1-5&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p><strong>input</strong></p>
<blockquote>
<p>位置：stages</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>input <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  message <span style="color:#e6db74">&#39;确认要部署么&#39;</span>
</span></span><span style="display:flex;"><span>  ok <span style="color:#e6db74">&#39;执行&#39;</span>
</span></span><span style="display:flex;"><span>  parameters <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    choice choices: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;rollback&#39;</span><span style="color:#f92672">],</span> name: <span style="color:#e6db74">&#39;action&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p><strong>when</strong></p>
<blockquote>
<p>位置：stages</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>input <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  message <span style="color:#e6db74">&#39;确认要部署么&#39;</span>
</span></span><span style="display:flex;"><span>  ok <span style="color:#e6db74">&#39;执行&#39;</span>
</span></span><span style="display:flex;"><span>  parameters <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    choice choices: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;rollback&#39;</span><span style="color:#f92672">],</span> name: <span style="color:#e6db74">&#39;action&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  environment name: <span style="color:#e6db74">&#39;action&#39;</span><span style="color:#f92672">,</span> value: <span style="color:#e6db74">&#39;deploy&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p><strong>parallel</strong> 并行构建多阶段</p>
<blockquote>
<p>位置：stages</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;parallel&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 当第一个stage 失败时让整个并行阶段快速失败
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      failFast <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      parallel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;parallel01&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>              steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                  echo <span style="color:#e6db74">&#34;123&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>          stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;parallel02&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>              steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                  echo <span style="color:#e6db74">&#34;456&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p><strong>post</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  always <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// One or more steps need to be included within each condition&#39;s block.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  success <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// One or more steps need to be included within each condition&#39;s block.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// One or more steps need to be included within each condition&#39;s block.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-e70e4767203973da4f764db10a25a174">Groovy</h1>
	<div class="lead">groovy|jenkins</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h4 id="groovy-语法">groovy 语法</h4>
<h5 id="注释">注释</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">// 单行注释
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">多行注释
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 文档注释
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 这个函数的使用方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h5 id="变量">变量</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">// 变量定义
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hello world!&#34;</span>
</span></span></code></pre></div><p>字符串</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>str<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;中国&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">// 字符串拼接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>str<span style="color:#f92672">=</span>str <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;-beijing&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 字符串分割 split() ,分割后生成数组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;我来自%s&#34;</span><span style="color:#f92672">,</span>str<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;-&#34;</span><span style="color:#f92672">)[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  首字符大写 capitalize()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;我来自%s&#34;</span><span style="color:#f92672">,</span>str<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;-&#34;</span><span style="color:#f92672">)[</span><span style="color:#ae81ff">1</span><span style="color:#f92672">].</span><span style="color:#a6e22e">capitalize</span><span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 大写 toUpperCase()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;我来自%s&#34;</span><span style="color:#f92672">,</span>str<span style="color:#f92672">.</span><span style="color:#a6e22e">toUpperCase</span><span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 大写 toLowerCase()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;我来自%s&#34;</span><span style="color:#f92672">,</span>str<span style="color:#f92672">.</span><span style="color:#a6e22e">toLowerCase</span><span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 字符串长度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>str<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span>
</span></span></code></pre></div><p>数字</p>
<p>数组</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">//  数组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>a_list<span style="color:#f92672">=[</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span><span style="color:#ae81ff">2</span><span style="color:#f92672">,</span><span style="color:#ae81ff">3</span><span style="color:#f92672">,</span><span style="color:#ae81ff">4</span><span style="color:#f92672">,</span><span style="color:#ae81ff">5</span><span style="color:#f92672">,</span><span style="color:#ae81ff">6</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>println a_list<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#75715e">// 数据类型 java.util.ArrayList
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span><span style="color:#f92672">(</span>i <span style="color:#66d9ef">in</span> a_list<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    println i
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 数据嵌套
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>b_list<span style="color:#f92672">=[</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span><span style="color:#ae81ff">2</span><span style="color:#f92672">,</span><span style="color:#ae81ff">3</span><span style="color:#f92672">,</span><span style="color:#ae81ff">4</span><span style="color:#f92672">,</span><span style="color:#ae81ff">5</span><span style="color:#f92672">,</span><span style="color:#ae81ff">6</span><span style="color:#f92672">,[</span><span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;b&#34;</span><span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 数组新增元素
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>b_list<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;新成员&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>b_list<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;在索引为2 的位置插入&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>println b_list  <span style="color:#75715e">//[1, 2, 在索引为2 的位置插入, 3, 4, 5, 6, [a, b], 新成员]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 通过语法糖 追加元素
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>b_list <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;hello world&#34;</span>
</span></span><span style="display:flex;"><span>println b_list  <span style="color:#75715e">//[1, 2, 在索引为2 的位置插入, 3, 4, 5, 6, [a, b], 新成员, hello world]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 除了for之外遍历元素的方法，${it} 为内置变量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>b_list<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span><span style="color:#f92672">{</span>println <span style="color:#e6db74">&#34;成员：${it}&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>map</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>// map
</span></span><span style="display:flex;"><span>a_map<span style="color:#f92672">=[</span>name:<span style="color:#e6db74">&#34;张三&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>println
</span></span><span style="display:flex;"><span>a_map.getClass<span style="color:#f92672">()</span>.getName<span style="color:#f92672">()</span>  // java.util.LinkedHashMap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// 调用方法和python 很类似
</span></span><span style="display:flex;"><span>a_map.name
</span></span><span style="display:flex;"><span>a_map<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>a_map.get<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// 添加元素
</span></span><span style="display:flex;"><span>a_map<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;age&#34;</span><span style="color:#f92672">]=</span><span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// 遍历元素
</span></span><span style="display:flex;"><span>a_map.each<span style="color:#f92672">{</span>println<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>it<span style="color:#e6db74">}</span><span style="color:#e6db74">,分别获取可以和value: </span><span style="color:#e6db74">${</span>it.key<span style="color:#e6db74">}</span><span style="color:#e6db74">--</span><span style="color:#e6db74">${</span>it.value<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="运算符">运算符</h5>
<p>赋值运算符： <code>= += -= /= %=</code></p>
<p>算数运算符： <code>+ - * / % ++ --</code></p>
<p>关系运算符： <code>== != &gt; &lt; &gt;= &lt;=</code></p>
<p>逻辑运算符： <code>&amp;&amp; || !</code></p>
<p>位运算符： <code>&amp; | ^ ~</code></p>
<p>范围运算符：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>def a<span style="color:#f92672">=</span>1..5
</span></span><span style="display:flex;"><span>a.getClass<span style="color:#f92672">()</span>.getName<span style="color:#f92672">()</span> //类型: groovy.lang.IntRange
</span></span><span style="display:flex;"><span>a.get<span style="color:#f92672">(</span>1<span style="color:#f92672">)</span> // 按照索引取值
</span></span></code></pre></div><h5 id="for-while-if-switch">for while if switch</h5>
<p><strong>for</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">for</span><span style="color:#f92672">(</span><span style="color:#66d9ef">def</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">5</span><span style="color:#f92672">;</span>i<span style="color:#f92672">++){</span>
</span></span><span style="display:flex;"><span>    println i
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>for in</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> a<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;123&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// a 是一个可迭代对象，和python类似
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span><span style="color:#f92672">(</span>i <span style="color:#66d9ef">in</span> a<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    println i
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>times</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">// 循环0 到9 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">10</span><span style="color:#f92672">.</span><span style="color:#a6e22e">times</span><span style="color:#f92672">{</span> i <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    println i
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>info <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;张三&#34;</span><span style="color:#f92672">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;李四&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 格式1：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>i <span style="color:#66d9ef">in</span> info<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    println i<span style="color:#f92672">.</span><span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>newinfo<span style="color:#f92672">=[]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>i <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    newinfo <span style="color:#f92672">&lt;&lt;</span> info<span style="color:#f92672">[</span>i<span style="color:#f92672">].</span><span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 格式2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span><span style="color:#f92672">(</span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>i<span style="color:#f92672">++){</span>
</span></span><span style="display:flex;"><span>    println info<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>while</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> conut<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>conut <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">5</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    println <span style="color:#e6db74">&#34;${conut}&#34;</span>
</span></span><span style="display:flex;"><span>    conut<span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>if</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> score<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>score<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">60</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    println <span style="color:#e6db74">&#34;再接再厉&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    print  <span style="color:#e6db74">&#34;恭喜你&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>def score<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>score&lt;60<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    println <span style="color:#e6db74">&#34;再接再厉&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>score<span style="color:#f92672">==</span>60<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>	println <span style="color:#e6db74">&#34;运气不错&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>score&gt;60 <span style="color:#f92672">&amp;&amp;</span> score&lt;<span style="color:#f92672">=</span>100<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>	println <span style="color:#e6db74">&#34;你太厉害了&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>switch</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linux&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">switch</span><span style="color:#f92672">(</span>type<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;linux&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        println <span style="color:#e6db74">&#34;操作系统为linux&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;windows&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        println <span style="color:#e6db74">&#34;操作系统为windows&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        println <span style="color:#e6db74">&#34;其他操作系统&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="函数">函数</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sum</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    println <span style="color:#e6db74">&#34;不带参数的函数&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sum</span><span style="color:#f92672">(</span>num1<span style="color:#f92672">,</span>num2<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    println <span style="color:#e6db74">&#34;带参数的函数\n &#34;</span>
</span></span><span style="display:flex;"><span>    println num1 <span style="color:#f92672">+</span> num2
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span><span style="color:#ae81ff">2</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sum</span><span style="color:#f92672">(</span>num1<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span>num2<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    println <span style="color:#e6db74">&#34;带参数的函数,设置了默认值\n &#34;</span>
</span></span><span style="display:flex;"><span>    println num1 <span style="color:#f92672">+</span> num2
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>def sum<span style="color:#f92672">(</span>num1<span style="color:#f92672">=</span>1,num2<span style="color:#f92672">=</span>2<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    println <span style="color:#e6db74">&#34;带参数的函数,设置了默认值和返回值\n &#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> num1 + num2
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>a<span style="color:#f92672">=</span>sum<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>println a
</span></span></code></pre></div><h5 id="异常处理">异常处理</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">// 异常处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// try catch finally
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    println  name
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>Exception e<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    println e
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span><span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    println <span style="color:#e6db74">&#34;always&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-277dce042328e5428c35cce84a8879d0">最佳实践</h1>
	<div class="lead">最佳实践|jenkins</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h3 id="pipeline-最佳实践">pipeline 最佳实践</h3>
<ul>
<li>
<p>处理逻辑抽离成函数，通过<a href="https://www.jenkins.io/doc/book/pipeline/shared-libraries/" target="_blank">共享库</a>的方式调用。</p>
</li>
<li>
<p>Jenkinsfile 通过代码仓库管理</p>
</li>
</ul>
<p><strong>共享库实践</strong></p>
<ol>
<li>
<p>配置jenkins 共享库</p>
<blockquote>
<p>​	路径： Dashboard &gt; 系统管理 &gt; System &gt;  Global Trusted Pipeline Libraries</p>
</blockquote>
<p><img src="/docs/devops/jenkins/img/image-14.png" alt="alt text">
<img src="/docs/devops/jenkins/img/image-15.png" alt="alt text">
<img src="/docs/devops/jenkins/img/image-16.png" alt="alt text"></p>
</li>
<li>
<p>编写共享库文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 目录结构</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># src 下放置 具体实现逻辑函数</span>
</span></span><span style="display:flex;"><span>mylib
</span></span><span style="display:flex;"><span>    ├─resources
</span></span><span style="display:flex;"><span>    │  └─config
</span></span><span style="display:flex;"><span>    ├─src
</span></span><span style="display:flex;"><span>    │  └─org
</span></span><span style="display:flex;"><span>    │      └─jenkins
</span></span><span style="display:flex;"><span>    |            └─ hello.groovy
</span></span><span style="display:flex;"><span>    └─vars
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> org<span style="color:#f92672">.</span><span style="color:#a6e22e">jenkins</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hi</span><span style="color:#f92672">(</span>data<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%s&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;来自共享库函数&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> data
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>在Jenkinsfile中调用共享库</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">/* @Library 为固定语法声明加载共享库
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    jenkinslib 为jenkins 全局配置中配置的共享库的名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    _ 加载共享库
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Library</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;jenkinslib&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 实例化 org.jenkins 包下 hello.groovy 文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> tools<span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> org<span style="color:#f92672">.</span><span style="color:#a6e22e">jenkins</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hello</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent any
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;run&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 调用共享库中的hi 函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    tools<span style="color:#f92672">.</span><span style="color:#a6e22e">hi</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;123&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 调用共享库中的配置文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">def</span> data<span style="color:#f92672">=</span>libraryResource <span style="color:#e6db74">&#39;config/config.json&#39;</span>
</span></span><span style="display:flex;"><span>                    result<span style="color:#f92672">=</span>tools<span style="color:#f92672">.</span><span style="color:#a6e22e">hi</span><span style="color:#f92672">(</span>data<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    println result
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
<h4 id="gitlab-代码提交触发流水线">gitlab 代码提交触发流水线</h4>
<p>安装插件 【 Generic Webhook Trigger 】
支持jsonpath 语法解析 【 Pipeline Utility Steps 】</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent any
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Parse JSON&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    // JSON 字符串
</span></span><span style="display:flex;"><span>                    def jsonString <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{&#34;name&#34;: &#34;John&#34;, &#34;age&#34;: 30, &#34;city&#34;: &#34;New York&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    // 解析 JSON 字符串
</span></span><span style="display:flex;"><span>                    def jsonObj <span style="color:#f92672">=</span> readJSON text: jsonString
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    // 访问 JSON 对象中的属性
</span></span><span style="display:flex;"><span>                    def name <span style="color:#f92672">=</span> jsonObj.name
</span></span><span style="display:flex;"><span>                    def age <span style="color:#f92672">=</span> jsonObj.age
</span></span><span style="display:flex;"><span>                    def city <span style="color:#f92672">=</span> jsonObj.city
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    // 打印 JSON 数据
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;Name: </span><span style="color:#e6db74">${</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;Age: </span><span style="color:#e6db74">${</span>age<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;City: </span><span style="color:#e6db74">${</span>city<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><img src="/docs/devops/jenkins/img/image-17.png" alt="alt text"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http://175.178.65.213:18080/generic-webhook-trigger/invoke?token<span style="color:#f92672">=</span>qGv2J.wXhNnzg
</span></span></code></pre></div><ol>
<li>分支名称</li>
<li>commit_id</li>
</ol>
<h3 id="运维管理">运维管理</h3>
<h4 id="备份jenkins">备份jenkins</h4>
<ul>
<li>停止进程</li>
<li>打包 <code>JENKINS_HOME</code> 目录
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /root
</span></span><span style="display:flex;"><span>tar --exclude .jenkins/workspace  -cvzf  jenkins.tar.gz .jenkins
</span></span></code></pre></div></li>
<li>恢复方式： 解压打包文件到当前环境 <code>JENKINS_HOME</code> 目录</li>
</ul>
<h4 id="用户和权限管理">用户和权限管理</h4>
<p><a href="https://mp.weixin.qq.com/s/_DIWInIddfcsdggDCGOCyA" target="_blank">https://mp.weixin.qq.com/s/_DIWInIddfcsdggDCGOCyA</a></p>
<p>jenkins使用基于RBAC(role base access contoller)进项授权控制，要使用该功能需要安装对应插件【 Role-based Authorization Strategy 】</p>
<ol>
<li>
<p>添加用户</p>
<blockquote>
<p>Dashboard &gt; Manage Jenkins &gt; Jenkins’ own user database
<img src="/docs/devops/jenkins/img/image-5.png" alt="alt text"></p>
</blockquote>
</li>
<li>
<p>修改授权策略</p>
<p>修改jenkins授权策略。修改为 <code>Role-Based Strategy</code></p>
<blockquote>
<p>修改方式： Dashboard &gt; Manage Jenkins &gt; Security</p>
</blockquote>
<p><img src="/docs/devops/jenkins/img/image-6.png" alt="alt text"></p>
</li>
<li>
<p>添加权限</p>
<blockquote>
<p>示例中实现目标： 开发人员dev01 只拥有自己项目 <code>seagull</code> 流水线的构建权限</p>
</blockquote>
<p>修改/新增jenkins角色权限</p>
<blockquote>
<p>修改方式：Dashboard &gt; Manage Jenkins &gt; Manage and Assign Roles</p>
</blockquote>
<p><img src="/docs/devops/jenkins/img/image-8.png" alt="alt text"></p>
<p>新增权限</p>
<blockquote>
<p>[Warning]</p>
<p>确保 <code>Item roles</code> 中已经存在的不可以在 <code>Global roles</code> 中配置，否则<code>Global roles</code>中权限会覆盖掉 <code>Item roles</code> 中配置</p>
</blockquote>
<p><img src="/docs/devops/jenkins/img/image-9.png" alt="alt text"></p>
</li>
<li>
<p>授权给用户</p>
<blockquote>
<p>[Warning]</p>
<p>需要双重授权</p>
</blockquote>
<p><img src="/docs/devops/jenkins/img/image-10.png" alt="alt text"></p>
<p>使用dev01 用户登录检查权限
<img src="/docs/devops/jenkins/img/image-11.png" alt="alt text"></p>
</li>
</ol>
<h4 id="邮件钉钉通知">邮件、钉钉通知</h4>
<p><strong>邮件通知</strong>
安装邮件插件 【 Email Extension 】</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>smtp_address <span style="color:#f92672">=</span> smtp.qq.com
</span></span><span style="display:flex;"><span>smtp_port <span style="color:#f92672">=</span> <span style="color:#ae81ff">465</span>
</span></span><span style="display:flex;"><span>smtp_user_name <span style="color:#f92672">=</span> 810654947@qq.com
</span></span><span style="display:flex;"><span>smtp_password <span style="color:#f92672">=</span> kqaexaxpbrbdbajd
</span></span><span style="display:flex;"><span>smtp_domain <span style="color:#f92672">=</span> smtp.qq.com
</span></span><span style="display:flex;"><span>smtp_tls <span style="color:#f92672">=</span> true
</span></span></code></pre></div><p>添加凭据
<img src="/docs/devops/jenkins/img/image-18.png" alt="alt text">
设置管理员邮箱
<img src="/docs/devops/jenkins/img/image-20.png" alt="alt text">
<img src="/docs/devops/jenkins/img/image-21.png" alt="alt text"></p>
<p><img src="/docs/devops/jenkins/img/image-19.png" alt="alt text"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent any
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Hello&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                emailext to: <span style="color:#e6db74">&#39;1209233066@qq.com&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    mimeType: <span style="color:#e6db74">&#34;text/html&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    subject: <span style="color:#e6db74">&#34;流水线&#39;${JOB_NAME}&#39; (${BUILD_NUMBER})构建通知&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    body: <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    项目名称: ${PROJECT_NAME } &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    构建详情：&lt;a href=${BUILD_URL}console&gt;查看详情&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> now <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent any
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Hello&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                emailext to: <span style="color:#e6db74">&#39;1209233066@qq.com&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    mimeType: <span style="color:#e6db74">&#34;text/html&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    subject: <span style="color:#e6db74">&#34;流水线&#39;${JOB_NAME}&#39; (${BUILD_NUMBER}) ${currentBuild.currentResult}构建通知&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    body: <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &lt;table border=1&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &lt;th&gt;项目名称&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &lt;th&gt;构建id&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &lt;th&gt;构建状态&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &lt;th&gt;构建日志&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &lt;th&gt;邮件发送时间&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &lt;tr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &lt;td&gt; ${JOB_NAME} &lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &lt;td&gt; ${BUILD_NUMBER} &lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &lt;td&gt; ${currentBuild.currentResult} &lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &lt;td&gt;&lt;a href=${BUILD_URL}console&gt;查看详情&lt;/a&gt;&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &lt;td&gt;${now.format(&#39;yyyy-MM-dd HH:mm:ss&#39;)}&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &lt;/tr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &lt;/table&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="代码扫描">代码扫描</h3>
<p>jenkins 集成sonarqube</p>
<ol>
<li>创建凭据
<img src="/docs/devops/jenkins/img/image-22.png" alt="alt text"></li>
<li>在clone后 添加扫描阶段（golang）
<img src="/docs/devops/jenkins/img/image-23.png" alt="alt text">
<img src="/docs/devops/jenkins/img/image-24.png" alt="alt text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>      stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;sonarqube&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>              SONAR_SCANNER_HOME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/opt/sonar-scanner&#34;</span>
</span></span><span style="display:flex;"><span>              PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${SONAR_SCANNER_HOME}/bin:$PATH&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>              withCredentials<span style="color:#f92672">([</span>usernamePassword<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                credentialsId: <span style="color:#e6db74">&#39;sonarQube&#39;</span><span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span>                passwordVariable: <span style="color:#e6db74">&#39;password&#39;</span><span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span>                usernameVariable: <span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">)])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                  script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                      sh <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      sonar-scanner \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.host.url=http://175.178.65.213:9000 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.projectKey=seagull-agent \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.projectName=seagull-agent \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.projectVersion=1.1 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.login=&#34;${username}&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.password=&#34;${password}&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.ws.timeout=30 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.projectDescription=&#39;seagull-agent&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.links.homepage=https://e.gitee.com/bj-pytc/repos/bj-pytc/pcloud-agent/sources \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.links.ci=http://175.178.65.213:18080/job/seagull-agent/job/seagull-agent/ \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.sourceEncoding=UTF-8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
<p>通过安装插件执行代码扫描【 SonarQube Scanner 】</p>
<ol>
<li>
<p>sonarQube 中生成token
<img src="/docs/devops/jenkins/img/image-25.png" alt="alt text">
<code>sqa_718d7307c781818bbecdd30871d28061280a7a26</code>
<img src="image-26.png" alt="alt text"></p>
</li>
<li>
<p>将token 转换为jenkins的 credentials
<img src="/docs/devops/jenkins/img/image-27.png" alt="alt text"></p>
</li>
<li>
<p>添加扫描阶段
<img src="/docs/devops/jenkins/img/image-28.png" alt="alt text">
<img src="/docs/devops/jenkins/img/image-29.png" alt="alt text"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>      stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;sonarqube&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>              SONAR_SCANNER_HOME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/opt/sonar-scanner&#34;</span>
</span></span><span style="display:flex;"><span>              PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${SONAR_SCANNER_HOME}/bin:$PATH&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#75715e">// installationName 是第三步创建的名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>              <span style="color:#75715e">// credentialsId 为 第二步中创建的credentials
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>              withSonarQubeEnv<span style="color:#f92672">(</span>installationName: <span style="color:#e6db74">&#39;sonarQube&#39;</span><span style="color:#f92672">,</span>credentialsId: <span style="color:#e6db74">&#39;sonarQubetoken&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                  script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                      sh <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      sonar-scanner \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.host.url=http://175.178.65.213:9000 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.projectKey=seagull-agent \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.projectName=seagull-agent \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.projectVersion=1.1 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.login=&#34;${SONAR_AUTH_TOKEN}&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.ws.timeout=30 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.projectDescription=&#39;seagull-agent&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.links.homepage=https://e.gitee.com/bj-pytc/repos/bj-pytc/pcloud-agent/sources \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.links.ci=http://175.178.65.213:18080/job/seagull-agent/job/seagull-agent/ \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      -Dsonar.sourceEncoding=UTF-8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>执行結果，此时多个一个sonarQube的扫描结构连接
<img src="/docs/devops/jenkins/img/image-30.png" alt="alt text"></p>
</li>
</ol>
<h3 id="创建凭证拉取代码">创建凭证拉取代码</h3>
<p>jienkins 提供了凭据管理，避免将密码或token 暴露在流水线中。需要插件 【 Credentials 】</p>
<blockquote>
<p>配置方式： Dashboard &gt; Manage Jenkins &gt; Credentials</p>
</blockquote>
<ol>
<li>
<p>添加全局作用域的credentials
<img src="/docs/devops/jenkins/img/image-2.png" alt="alt text"></p>
<p>创建一个全局的，基于用户名和密码的credentials,该credentials会在后面流水线中引用。</p>
<blockquote>
<p>引用时使用 <code>Description </code> 作为标识引用该credentials
<img src="/docs/devops/jenkins/img/image-7.png" alt="alt text"></p>
</blockquote>
</li>
</ol>
<h3 id="fqa">FQA</h3>
<h4 id="任务无法停止">任务无法停止</h4>
<p><strong>问题描述：</strong></p>
<p>在构建一个nodejs项目时，一个构建任务运行了3天5小时。这时通过jenkins 页面取消该任务时没有响应，重启jenkins进程后jenkins会把未完成的任务直接拉起继续运行。</p>
<p><img src="https://img2024.cnblogs.com/blog/2108528/202410/2108528-20241029092021368-6290231.png" alt="jenkins单个任务运行了3天，一直卡着"></p>
<p><strong>解决办法</strong></p>
<ol>
<li>
<p>强制取消任务</p>
<blockquote>
<p>【系统管理】&gt; 【节点和运管理】&gt;【master】&gt;【脚本命令行】</p>
<p>master 表示当前任务运行的节点</p>
<p>seagull-app 表示当前的job 名称</p>
<p>2 表示需要取消的构建号</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>Jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">instance</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getItemByFullName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;seagull-app&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">.</span><span style="color:#a6e22e">getBuildByNumber</span><span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">.</span><span style="color:#a6e22e">finish</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>		hudson<span style="color:#f92672">.</span><span style="color:#a6e22e">model</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Result</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ABORTED</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>    	<span style="color:#66d9ef">new</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">io</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IOException</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Aborting build&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">);</span>
</span></span></code></pre></div></li>
<li>
<p>为流水线设置超时时间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      timeout<span style="color:#f92672">(</span>time:3,unit: <span style="color:#e6db74">&#39;HOURS&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
<p>参考</p>
<p><a href="https://blog.csdn.net/wxw4814/article/details/124904402" target="_blank">Jenkins 强制停止 job 执行_jenkins强制停止任务-CSDN博客</a></p>
<p><a href="https://blog.csdn.net/weixin_43277055/article/details/130380924" target="_blank">【Jenkins】Pipeline - 设置超时时间_jenkins设置超时时间-CSDN博客</a></p>
<p><a href="https://www.groovy-lang.org/documentation.html" target="_blank">groovy</a></p>
<p><a href="https://mp.weixin.qq.com/s/TqFCyCmLHEtWoVJNq6_0cw" target="_blank">https://mp.weixin.qq.com/s/TqFCyCmLHEtWoVJNq6_0cw</a></p>

</div>





    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c5f5608a160b96f6156ab9b2314910a0">4.2.4 - </h1>
    
	<p>共享库目录结构</p>
<pre tabindex="0"><code>jenkinslib
    ├─resources
    │  └─config
    ├─src
    │  └─org
    │      └─jenkins
    └─vars
</code></pre><p>在Jenkinsfile 中加载共享库
/* @Library 为固定语法声明加载共享库
jenkinslib 为jenkins 全局配置中配置的共享库的名称
_ 加载共享库
*/
@Library(&lsquo;jenkinslib&rsquo;) _</p>

</div>



    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-7ce15bd88923cb2e5537446987acf846"></h1>
	<div class="lead">sonar 文档中心</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-4f10deba18f8d41941436cd61400206f">sonarqube</h1>
	<div class="lead">sonarqube|devops</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<p><a href="https://docs.sonarsource.com/sonarqube/9.9/" target="_blank">doc</a>|<a href="https://www.sonarplugins.com/" target="_blank">plugin</a></p>
<h3 id="安装sonarqube服务端">安装sonarQube[服务端]</h3>
<table>
  <thead>
      <tr>
          <th>端口</th>
          <th>jdk</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>9000</td>
          <td>17</td>
      </tr>
  </tbody>
</table>
<p><strong>安装jdk</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://download.oracle.com/java/17/archive/jdk-17.0.10_linux-x64_bin.tar.gz
</span></span><span style="display:flex;"><span>tar xf jdk-17.0.10_linux-x64_bin.tar.gz -C /opt
</span></span></code></pre></div><p><strong>安装sonar</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#https://www.sonarsource.com/products/sonarqube/downloads/</span>
</span></span><span style="display:flex;"><span>wget https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-9.9.6.92038.zip
</span></span></code></pre></div><pre tabindex="0"><code>unzip sonarqube-9.9.6.92038.zip -d /opt
ln -svf /opt/{sonarqube-9.9.6.92038,sonarqube}
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>useradd sonar
</span></span><span style="display:flex;"><span>chown -R sonar.sonar /opt/sonarqube*
</span></span></code></pre></div><p><strong>启动服务</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>su - sonar
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JAVA_HOME<span style="color:#f92672">=</span>/opt/jdk-17.0.10
</span></span><span style="display:flex;"><span>JAVA_JRE<span style="color:#f92672">=</span>$JAVA_HOME/jre
</span></span><span style="display:flex;"><span>CLASSPATH<span style="color:#f92672">=</span>$JAVA_HOME/lib:$JAVA_HOME/jre/lib
</span></span><span style="display:flex;"><span>PATH<span style="color:#f92672">=</span>$JAVA_HOME/bin:$JAVA_JRE/bin:$PATH:.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/opt/sonarqube/bin/linux-x86-64/sonar.sh start
</span></span></code></pre></div><p><strong>登录</strong></p>
<pre tabindex="0"><code>http://127.0.0.1:9000
登录：admin
密码：admin
</code></pre><h4 id="插件安装">插件安装</h4>
<p><img src="image-1.png" alt="alt text"></p>
<p><img src="image-2.png" alt="alt text">
重启服务后界面展示为中文简体
<img src="image-3.png" alt="alt text">
离线安装插件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /opt/sonarqube/extensions/downloads/
</span></span><span style="display:flex;"><span>wget https://github.com/xuhuisheng/sonar-l10n-zh/releases/download/sonar-l10n-zh-plugin-9.9/sonar-l10n-zh-plugin-9.9.jar
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启服务后，downloads/ 下的jar 包会被加载到 plugins/</span>
</span></span><span style="display:flex;"><span>ls /opt/sonarqube/extensions/downloads/
</span></span><span style="display:flex;"><span>ls /opt/sonarqube/extensions/plugins/
</span></span></code></pre></div><h3 id="安装sonarscaner客户端">安装sonarscaner[客户端]</h3>
<p>内置了jre
<a href="https://docs.sonarsource.com/sonarqube/9.9/analyzing-source-code/scanners/sonarscanner/" target="_blank">https://docs.sonarsource.com/sonarqube/9.9/analyzing-source-code/scanners/sonarscanner/</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-6.1.0.4477-linux-x64.zip
</span></span><span style="display:flex;"><span>unzip sonar-scanner-cli-6.1.0.4477-linux-x64.zip -d /opt
</span></span><span style="display:flex;"><span>ln -svf /opt/<span style="color:#f92672">{</span>sonar-scanner-6.1.0.4477-linux-x64,sonar-scanner<span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export SONAR_SCANNER_HOME<span style="color:#f92672">=</span>/opt/sonar-scanner
</span></span><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>SONAR_SCANNER_HOME<span style="color:#e6db74">}</span>/bin:$PATH
</span></span><span style="display:flex;"><span>export SONAR_SCANNER_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-Xmx512m&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@192 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sonar-scanner -v</span>
</span></span><span style="display:flex;"><span>21:37:07.202 INFO  Scanner configuration file: /opt/sonar-scanner-6.1.0.4477-linux-x64/conf/sonar-scanner.properties
</span></span><span style="display:flex;"><span>21:37:07.209 INFO  Project root configuration file: NONE
</span></span><span style="display:flex;"><span>21:37:07.244 INFO  SonarScanner CLI 6.1.0.4477
</span></span><span style="display:flex;"><span>21:37:07.248 INFO  Java 17.0.11 Eclipse Adoptium <span style="color:#f92672">(</span>64-bit<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>21:37:07.250 INFO  Linux 3.10.0-957.el7.x86_64 amd64
</span></span></code></pre></div><h3 id="执行代码扫描">执行代码扫描</h3>
<table>
  <thead>
      <tr>
          <th>参数</th>
          <th>解释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>sonar.host.url</td>
          <td>sonarQube的服务器地址</td>
      </tr>
      <tr>
          <td>sonar.projectKey</td>
          <td></td>
      </tr>
      <tr>
          <td>sonar.projectName</td>
          <td>项目名称</td>
      </tr>
      <tr>
          <td>sonar.projectVersion</td>
          <td>项目版本</td>
      </tr>
      <tr>
          <td>sonar.login</td>
          <td>sonarQube用户名</td>
      </tr>
      <tr>
          <td>sonar.password</td>
          <td>sonarQube密码</td>
      </tr>
      <tr>
          <td>sonar.ws.timeout</td>
          <td>超时时间</td>
      </tr>
      <tr>
          <td>sonar.projectDescription</td>
          <td>项目描述</td>
      </tr>
      <tr>
          <td>sonar.links.homepage</td>
          <td>超级链接（gitlab）</td>
      </tr>
      <tr>
          <td>sonar.links.ci</td>
          <td>超级链接（jenkins）</td>
      </tr>
      <tr>
          <td>sonar.sources</td>
          <td>代码目录</td>
      </tr>
      <tr>
          <td>sonar.sourceEncoding</td>
          <td>字符编码</td>
      </tr>
      <tr>
          <td>sonar.java.binaries</td>
          <td>java代码编译后的文件目录</td>
      </tr>
  </tbody>
</table>
<h4 id="通过命令行扫描">通过命令行扫描</h4>
<p><strong>扫描 java 代码</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sonar-scanner <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.host.url<span style="color:#f92672">=</span>http://192.168.0.246:9000 <span style="color:#ae81ff">\ </span> 
</span></span><span style="display:flex;"><span>-Dsonar.projectKey<span style="color:#f92672">=</span>seagull-api <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectName<span style="color:#f92672">=</span>seagull-api <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectVersion<span style="color:#f92672">=</span>1.1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.login<span style="color:#f92672">=</span>admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.password<span style="color:#f92672">=</span>pytc@2024 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.ws.timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectDescription<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;my first project!&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.links.homepage<span style="color:#f92672">=</span>http://192.168.0.246:8076/devops/seagull-core <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.links.ci<span style="color:#f92672">=</span>http://192.168.1.200:8080/job/demo-pipeline-service/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.sources<span style="color:#f92672">=</span>src <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.sourceEncoding<span style="color:#f92672">=</span>UTF-8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar,java.binaries<span style="color:#f92672">=</span>target/classes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.java.test.binaries<span style="color:#f92672">=</span>target/test-classes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.java.surefire.report<span style="color:#f92672">=</span>target/surefire-reports 
</span></span></code></pre></div><p><strong>扫描 js 代码</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sonar-scanner <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.host.url<span style="color:#f92672">=</span>http://192.168.0.246:9000 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectKey<span style="color:#f92672">=</span>seagull-webui <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectName<span style="color:#f92672">=</span>seagull-webui <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectVersion<span style="color:#f92672">=</span>1.1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.login<span style="color:#f92672">=</span>admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.password<span style="color:#f92672">=</span>pytc@2024 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.ws.timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectDescription<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;seagull-webui&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.links.homepage<span style="color:#f92672">=</span>https://e.gitee.com/bj-pytc/repos/bj-pytc/pcloud-webui/sources <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.links.ci<span style="color:#f92672">=</span>http://175.178.65.213:18080/job/seagull-ui/job/seagull-ui/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.sources<span style="color:#f92672">=</span>src <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.sourceEncoding<span style="color:#f92672">=</span>UTF-8
</span></span></code></pre></div><p><strong>扫描 golang 代码</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sonar-scanner <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.host.url<span style="color:#f92672">=</span>http://192.168.0.246:9000 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectKey<span style="color:#f92672">=</span>seagull-core <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectName<span style="color:#f92672">=</span>seagull-core <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectVersion<span style="color:#f92672">=</span>1.1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.login<span style="color:#f92672">=</span>admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.password<span style="color:#f92672">=</span>pytc@2024 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.ws.timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectDescription<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;seagull-core&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.links.homepage<span style="color:#f92672">=</span>https://e.gitee.com/bj-pytc/repos/bj-pytc/pcloud-core/sources <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.links.ci<span style="color:#f92672">=</span>http://175.178.65.213:18080/job/seagull-core/job/seagull-core-test/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.sourceEncoding<span style="color:#f92672">=</span>UTF-8
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sonar-scanner <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.host.url<span style="color:#f92672">=</span>http://192.168.0.246:9000 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectKey<span style="color:#f92672">=</span>seagull-agent <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectName<span style="color:#f92672">=</span>seagull-agent <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectVersion<span style="color:#f92672">=</span>1.1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.login<span style="color:#f92672">=</span>admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.password<span style="color:#f92672">=</span>pytc@2024 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.ws.timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectDescription<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;seagull-agent&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.links.homepage<span style="color:#f92672">=</span>https://e.gitee.com/bj-pytc/repos/bj-pytc/pcloud-agent/sources <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.links.ci<span style="color:#f92672">=</span>http://175.178.65.213:18080/job/seagull-agent/job/seagull-agent/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.sourceEncoding<span style="color:#f92672">=</span>UTF-8
</span></span></code></pre></div><h4 id="通过配置文件扫描">通过配置文件扫描</h4>
<blockquote>
<p>文件命名为<code>sonar-project.properties</code>, 并把该文件放置在git代码根目录下，此时只需要执行 <strong>sonar-scanner</strong> 命令即会加载该配置文件执行扫描</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;sonar-project.properties <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.host.url=http://192.168.0.246:9000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.projectKey=seagullagent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.projectName=seagull-agent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.projectVersion=1.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.login=admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.password=pytc@2024
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.ws.timeout=30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.projectDescription=&#39;seagull-agent&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.links.homepage=https://e.gitee.com/bj-pytc/repos/bj-pytc/pcloud-agent/sources
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.links.ci=http://175.178.65.213:18080/job/seagull-agent/job/seagull-agent/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.sourceEncoding=UTF-8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h4 id="多分支扫描插件">多分支扫描插件</h4>
<blockquote>
<p>社区版本默认无法支持多分支扫描</p>
</blockquote>
<h5 id="sonarqube配置">Sonarqube配置</h5>
<ol>
<li>
<p>下载扫描插件到 <code>/opt/sonarqube/extensions/plugins/</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/mc1arke/sonarqube-community-branch-plugin/releases/download/1.14.0/sonarqube-community-branch-plugin-1.14.0.jar -P /opt/sonarqube/extensions/plugins/
</span></span></code></pre></div></li>
<li>
<p>配置sonarqube配置文件：<code>/opt/sonarqube/conf/sonar.properties</code> 添加以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sonar.web.javaAdditionalOpts<span style="color:#f92672">=</span>-javaagent:./extensions/plugins/sonarqube-community-branch-plugin-1.14.0.jar<span style="color:#f92672">=</span>web
</span></span><span style="display:flex;"><span>sonar.ce.javaAdditionalOpts<span style="color:#f92672">=</span>-javaagent:./extensions/plugins/sonarqube-community-branch-plugin-1.14.0.jar<span style="color:#f92672">=</span>ce
</span></span></code></pre></div></li>
<li>
<p>重启soanrqube,看到如下信息表示成功
<img src="image-4.png" alt="alt text"></p>
</li>
</ol>
<h5 id="sonar-scanner配置">sonar-scanner配置</h5>
<p>新增扫描配置 <code>-Dsonar.branch.name=dev</code></p>
<pre tabindex="0"><code>export SONAR_SCANNER_HOME=/opt/sonar-scanner
export PATH=${SONAR_SCANNER_HOME}/bin:$PATH
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sonar-scanner <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.host.url<span style="color:#f92672">=</span>http://192.168.0.246:9000 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectKey<span style="color:#f92672">=</span>seagull-agent <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectName<span style="color:#f92672">=</span>seagull-agent <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectVersion<span style="color:#f92672">=</span>1.1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.login<span style="color:#f92672">=</span>admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.password<span style="color:#f92672">=</span>pytc@2024 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.ws.timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.projectDescription<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;seagull-agent&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.links.homepage<span style="color:#f92672">=</span>https://e.gitee.com/bj-pytc/repos/bj-pytc/pcloud-agent/sources <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.links.ci<span style="color:#f92672">=</span>http://175.178.65.213:18080/job/seagull-agent/job/seagull-agent/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.sourceEncoding<span style="color:#f92672">=</span>UTF-8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-Dsonar.branch.name<span style="color:#f92672">=</span>dev
</span></span></code></pre></div><p>扫描结果可以看到具体的分支信息
<img src="image-5.png" alt="alt text"></p>
<h4 id="依赖插件安全扫描">依赖插件安全扫描</h4>
<p><a href="https://github.com/jeremylong/DependencyCheck/tree/main" target="_blank">jeremylong/DependencyCheck: OWASP dependency-check is a software composition analysis utility that detects publicly disclosed vulnerabilities in application dependencies. (github.com)</a></p>
<p><a href="https://github.com/dependency-check/dependency-check-sonar-plugin" target="_blank">dependency-check/dependency-check-sonar-plugin：将 Dependency-Check 报告集成到 SonarQube 中 (github.com)</a></p>
<p><a href="https://bloodzer0.github.io/ossa/other-security-branch/devsecops/sdc/" target="_blank">SonarQube集成DependencyCheck - Open-Source Security Architecture (bloodzer0.github.io)</a></p>
<p><a href="https://jeremylong.github.io/DependencyCheck/data/index.html" target="_blank">dependency-check – Internet Access Required (jeremylong.github.io)</a></p>
<h3 id="附件">附件</h3>
<h4 id="docker-启动">docker 启动</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sonarqube_data: 包含数据文件，例如嵌入式 H2 数据库和 Elasticsearch 索引
</span></span><span style="display:flex;"><span>sonarqube_logs: 包含有关访问、Web 进程、CE 进程和 Elasticsearch 的 SonarQube 日志
</span></span><span style="display:flex;"><span>sonarqube_extensions: 将包含您安装的所有插件和 Oracle JDBC 驱动程序（如有必要）
</span></span><span style="display:flex;"><span>docker run --rm -p 9000:9000 sonarqube:lts-community
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-p 9000:9000 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e JDBC_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;jdbc:postgresql://127.0.0.1:5432/sonarqube&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v sonarqube_conf:/opt/sonarqube/conf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v sonarqube_logs:/opt/sonarqube/logs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v sonarqube_data:/opt/sonarqube/data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v sonarqube_extensions:/opt/sonarqube/extensions <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> sonarqube:8.9.2-community
</span></span></code></pre></div><h4 id="sonarqube-api"><a href="http://175.178.65.213:9000/web_api" target="_blank">sonarQube api</a></h4>
<table>
  <thead>
      <tr>
          <th>用途</th>
          <th>api</th>
          <th>版本</th>
          <th>方法</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>prometheus格式监控</td>
          <td>api/monitoring/metrics</td>
          <td>&gt;=9.3</td>
          <td>GET</td>
      </tr>
      <tr>
          <td>查找项目</td>
          <td>api/projects/search?projects=seagull-agent</td>
          <td>&gt;=6.3</td>
          <td>GET</td>
      </tr>
      <tr>
          <td>创建项目</td>
          <td>api/projects/create?project=seagull-api&amp;name=seagull-api</td>
          <td>&gt;=4.0</td>
          <td>POST</td>
      </tr>
      <tr>
          <td>删除项目</td>
          <td>api/projects/delete?project=seagull-agent</td>
          <td>&gt;=5.2</td>
          <td>POST</td>
      </tr>
  </tbody>
</table>

</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-17d758a8d89013ee2076a8dd028cf84b"></h1>
	<div class="lead">gitlab 文档中心</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-8e6de4f3d030c0a6cc8e5398fdcee5f6">gitlab</h1>
	<div class="lead">gitlab||devops</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	<p><em>基于Ruby 的 rails框架开发，主要组件：nginx postgreSQL redis sidekiq</em></p>
<p>版本： gitlab-ee（企业版） gitlab-ce（社区版） 极狐（面向中国的版本）</p>
<p>8c 16G centons7</p>
<p><a href="https://docs.gitlab.com/" target="_blank">https://docs.gitlab.com/</a></p>
<p><a href="https://www.kancloud.cn/apachecn/gitlab-doc-zh/1948588" target="_blank">https://www.kancloud.cn/apachecn/gitlab-doc-zh/1948588</a></p>
<h3 id="安装部署">安装部署</h3>
<p>使用docker安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export GITLAB_HOME<span style="color:#f92672">=</span>/home/gitlab
</span></span><span style="display:flex;"><span>sudo docker run --detach <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --hostname gitlab.example.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --publish 443:443 --publish 80:80 --publish 122:22 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --name gitlab <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --restart always <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume $GITLAB_HOME/config:/etc/gitlab <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume $GITLAB_HOME/logs:/var/log/gitlab <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume $GITLAB_HOME/data:/var/opt/gitlab <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --shm-size 256m <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -m 4g<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gitlab-jh.tencentcloudcr.com/omnibus/gitlab-jh:latest
</span></span></code></pre></div><ol>
<li>
<p>创建数据目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pvcreate /dev/sdb 
</span></span><span style="display:flex;"><span>vgextend centos /dev/sdb
</span></span><span style="display:flex;"><span>lvcreate -L +199G -n gitlab centos
</span></span><span style="display:flex;"><span>mkfs.ext4 /dev/mapper/centos-gitlab 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 默认数据放在/opt/gitlab,如何修改这个路径</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir /opt/gitlab
</span></span><span style="display:flex;"><span>echo /dev/mapper/centos-gitlab  /opt/gitlab  ext4 defaults <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> &gt;&gt;/etc/fstab
</span></span><span style="display:flex;"><span>mount -a 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df -hT /gitlab
</span></span></code></pre></div></li>
<li>
<p>离线rpm包安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-15.0.1-ce.0.el7.x86_64.rpm
</span></span><span style="display:flex;"><span>yum localinstall gitlab-ce-15.0.1-ce.0.el7.x86_64.rpm -y
</span></span></code></pre></div></li>
<li>
<p>修改配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /etc/gitlab/gitlab.rb
</span></span><span style="display:flex;"><span> 修改下面这一行
</span></span><span style="display:flex;"><span> external_url <span style="color:#e6db74">&#39;http://192.168.0.247&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gitlab-ctl reconfigure
</span></span></code></pre></div><p>日后重启服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gitlab-ctl start gitaly
</span></span><span style="display:flex;"><span>gitlab-ctl start gitlab-kas
</span></span><span style="display:flex;"><span>gitlab-ctl start gitlab-workhorse
</span></span><span style="display:flex;"><span>gitlab-ctl start logrotate
</span></span><span style="display:flex;"><span>gitlab-ctl start nginx
</span></span><span style="display:flex;"><span>gitlab-ctl start postgresql
</span></span><span style="display:flex;"><span>gitlab-ctl start puma
</span></span><span style="display:flex;"><span>gitlab-ctl start redis
</span></span><span style="display:flex;"><span>gitlab-ctl start sidekiq
</span></span></code></pre></div></li>
<li>
<p><a href="https://docs.gitlab.com/omnibus/installation/" target="_blank">卸载</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo gitlab-ctl stop <span style="color:#f92672">&amp;&amp;</span> sudo gitlab-ctl remove-accounts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo systemctl stop gitlab-runsvdir
</span></span><span style="display:flex;"><span>sudo systemctl disable gitlab-runsvdir
</span></span><span style="display:flex;"><span>sudo rm /usr/lib/systemd/system/gitlab-runsvdir.service
</span></span><span style="display:flex;"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span>sudo systemctl reset-failed
</span></span><span style="display:flex;"><span>sudo gitlab-ctl uninstall
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo gitlab-ctl cleanse <span style="color:#f92672">&amp;&amp;</span> sudo rm -r /opt/gitlab
</span></span><span style="display:flex;"><span>yum remove gitlab-ce
</span></span></code></pre></div></li>
</ol>
<h3 id="使用">使用</h3>
<ol>
<li>默认用户<code>root</code>,密码 <code>cat /etc/gitlab/initial_root_password</code>
<img src="/docs/devops/gitlab/img/image.png" alt="alt text"></li>
<li>登录后首页
<img src="/docs/devops/gitlab/img/image-1.png" alt="alt text"></li>
<li>基础设置</li>
</ol>
<ul>
<li>
<p>修改root密码
<img src="/docs/devops/gitlab/img/image-2.png" alt="alt text">
<img src="/docs/devops/gitlab/img/image-3.png" alt="alt text"></p>
</li>
<li>
<p>基本页面，amdin是后台管理页面
<img src="/docs/devops/gitlab/img/image-5.png" alt="alt text"></p>
</li>
<li>
<p>关闭注册</p>
</li>
<li>
<p>中文显示</p>
</li>
<li>
<p>邮箱配置</p>
<p>Docs: <a href="https://docs.gitlab.com/omnibus/settings/smtp.html" target="_blank">https://docs.gitlab.com/omnibus/settings/smtp.html</a>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">ERROR</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:001:0&gt; Notify.test_email<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;1209233066@qq.com&#39;</span>,<span style="color:#e6db74">&#39;test&#39;</span>,<span style="color:#e6db74">&#39;gitlab test&#39;</span><span style="color:#f92672">)</span>.deliver_now
</span></span><span style="display:flex;"><span>Delivered mail 6683e6c0128bc_1e1d45d83bd@gitlab.mail <span style="color:#f92672">(</span>35089.4ms<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Traceback <span style="color:#f92672">(</span>most recent call last<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>        1: from <span style="color:#f92672">(</span>irb<span style="color:#f92672">)</span>:1
</span></span><span style="display:flex;"><span>EOFError <span style="color:#f92672">(</span>end of file reached<span style="color:#f92672">)</span>
</span></span></code></pre></div>

</div>
</p>
<p>vi /etc/gitlab/gitlab.rb</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#75715e">### GitLab email server settings</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###! Docs: https://docs.gitlab.com/omnibus/settings/smtp.html</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###! **Use smtp instead of sendmail/postfix.**</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;smtp_enable&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;smtp_address&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;smtp.qq.com&#34;</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;smtp_port&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">465</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;smtp_user_name&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;810654947@qq.com&#34;</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;smtp_password&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;kqaexaxpbrbdbajd&#34;</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;smtp_domain&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;smtp.qq.com&#34;</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;smtp_authentication&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;login&#34;</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;smtp_enable_starttls_auto&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;smtp_tls&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;smtp_pool&#39;] = false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### Email Settings</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;gitlab_email_enabled&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##! If your SMTP server does not like the default &#39;From: gitlab@gitlab.example.com&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##! can change the &#39;From&#39; with this setting.</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;gitlab_email_from&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;810654947@qq.com&#39;</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;gitlab_email_display_name&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;gitlabAdmin&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;gitlab_email_reply_to&#39;] = &#39;noreply@example.com&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;gitlab_email_subject_suffix&#39;] = &#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;gitlab_email_smime_enabled&#39;] = false</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;gitlab_email_smime_key_file&#39;] = &#39;/etc/gitlab/ssl/gitlab_smime.key&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;gitlab_email_smime_cert_file&#39;] = &#39;/etc/gitlab/ssl/gitlab_smime.crt&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;gitlab_email_smime_ca_certs_file&#39;] = &#39;/etc/gitlab/ssl/gitlab_smime_cas.crt&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gitlab-ctl stop 
</span></span><span style="display:flex;"><span>gitlab-ctl reconfigure
</span></span><span style="display:flex;"><span>gitlab-ctl start 
</span></span><span style="display:flex;"><span>gitlab-rails console
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Notify.test_email<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;1209233066@qq.com&#39;</span>, <span style="color:#e6db74">&#39;Message Subject&#39;</span>, <span style="color:#e6db74">&#39;Message Body&#39;</span><span style="color:#f92672">)</span>.deliver_now
</span></span></code></pre></div><p><img src="/docs/devops/gitlab/img/image-14.png" alt="alt text"></p>
</li>
</ul>
<ol start="4">
<li>组织配置</li>
</ol>
<ul>
<li>
<p>namespace 用于逻辑隔离，可以分为用户名称空间，组名称空间，子组名称空间。</p>
<ul>
<li>
<p>user namespace</p>
</li>
<li>
<p>group namespace
<img src="/docs/devops/gitlab/img/image-13.png" alt="alt text"></p>
</li>
<li>
<p>subgroup namespace</p>
<p>创建子组
<img src="/docs/devops/gitlab/img/image-4.png" alt="alt text">
<img src="/docs/devops/gitlab/img/image-11.png" alt="alt text">
<img src="/docs/devops/gitlab/img/image-12.png" alt="alt text"></p>
</li>
</ul>
</li>
<li>
<p>用户管理</p>
<ul>
<li>添加成员</li>
<li>加入组</li>
<li>分配角色</li>
</ul>
</li>
<li>
<p>groups 用户管理一个或多个项目</p>
</li>
</ul>
<ol start="5">
<li>项目管理</li>
</ol>
<ul>
<li>创建项目、导入项目</li>
<li></li>
</ul>
<ol start="6">
<li>
<p>版本升级
不要跨越大版本，直接下载rpm包更新</p>
</li>
<li>
<p>创建一个pytc的组
<img src="/docs/devops/gitlab/img/image-6.png" alt="alt text"></p>
</li>
<li>
<p>创建一个项目seagull，隶属于pytc 的组</p>
</li>
<li>
<p>添加dev01/dev02 属于该组织</p>
</li>
</ol>
<h3 id="触发jienkins构建">触发jienkins构建</h3>
<blockquote>
<p>路径： 找到对应项目 &gt; setting &gt; Webhooks
<img src="/docs/devops/gitlab/img/image-7.png" alt="alt text"></p>
</blockquote>
<p>选择对应触发事件进行测试</p>
<p><img src="/docs/devops/gitlab/img/image-8.png" alt="alt text">
<img src="/docs/devops/gitlab/img/image-9.png" alt="alt text"></p>
<h3 id="忘记root密码">忘记root密码</h3>
<p><a href="https://blog.csdn.net/qq_21017997/article/details/131420935" target="_blank">https://blog.csdn.net/qq_21017997/article/details/131420935</a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-8afbf6f159cf24c2fc7f40f4cf6afc70">ci/cd</h1>
	<div class="lead">cicd|gitlab</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h3 id="cicd工具">ci/cd工具</h3>
<h4 id="注册runner">注册runner</h4>
<p>runner 是go语言编写，真正执行ci构建的组件，runner不绑定任何端口</p>
<p>【runner分类】</p>
<ul>
<li>instance类型，所有项目可用</li>
<li>group 类型，组成员可用</li>
<li>project类型，该项目可用</li>
</ul>
<h5 id="注册nstance类型-runner">注册nstance类型 runner</h5>
<p><img src="/docs/devops/gitlab/img/image-15.png" alt="alt text">
<img src="/docs/devops/gitlab/img/image-18.png" alt="alt text"></p>
<p><strong>安装runner</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -L --output /usr/local/bin/gitlab-runner https://s3.dualstack.us-east-1.amazonaws.com/gitlab-runner-downloads/v15.5.0/binaries/gitlab-runner-linux-386
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chmod +x /usr/local/bin/gitlab-runner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>useradd --comment <span style="color:#e6db74">&#39;GitLab Runner&#39;</span> --create-home gitlab-runner --shell /bin/bash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gitlab-runner install --user<span style="color:#f92672">=</span>gitlab-runner --working-directory<span style="color:#f92672">=</span>/home/gitlab-runner
</span></span><span style="display:flex;"><span>gitlab-runner start
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@tidb-dev01-s2 tmp<span style="color:#f92672">]</span><span style="color:#75715e"># gitlab-runner -v</span>
</span></span><span style="display:flex;"><span>Version:      15.5.0
</span></span><span style="display:flex;"><span>Git revision: 0d4137b8
</span></span><span style="display:flex;"><span>Git branch:   15-5-stable
</span></span><span style="display:flex;"><span>GO version:   go1.18.7
</span></span><span style="display:flex;"><span>Built:        2022-10-22T23:52:17+0000
</span></span><span style="display:flex;"><span>OS/Arch:      linux/386
</span></span></code></pre></div><p><strong>注册runner 到gitlab</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gitlab-runner register --url http://192.168.0.247/ --registration-token ADtKhX4s9UfJ6Fnn8vs_
</span></span></code></pre></div><p><img src="/docs/devops/gitlab/img/image-19.png" alt="alt text"></p>
<p><img src="/docs/devops/gitlab/img/image-20.png" alt="alt text"></p>
<p>非交互式注册</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gitlab-runner register <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--non-interactive <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--url http://192.168.0.247/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--registration-token <span style="color:#e6db74">&#34;GR1348941aQM2R2A6-Jgm_xtbnjGN&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--executor <span style="color:#e6db74">&#34;shell&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--description <span style="color:#e6db74">&#34;用于构建golang项目&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--tag-list <span style="color:#e6db74">&#34;linux,go&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--run-untagged<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--locked false <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--access-level not_protected
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gitlab-runner register <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--non-interactive <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--url http://192.168.0.247/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--registration-token <span style="color:#e6db74">&#34;GR1348941q6P-P5K4vkyCjNWnMBsm&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--executor <span style="color:#e6db74">&#34;shell&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--description <span style="color:#e6db74">&#34;用于构建golang、java项目&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--tag-list <span style="color:#e6db74">&#34;linux,go,mvn&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--run-untagged<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--locked false <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--access-level not_protected
</span></span></code></pre></div><h5 id="注册group类型-runner">注册group类型 runner</h5>
<p><img src="/docs/devops/gitlab/img/image-16.png" alt="alt text"></p>
<p>安装和注册方式与instance 类型一致，只是其中注册命令中的token 不同</p>
<h5 id="注册project类型-runner">注册project类型 runner</h5>
<p><img src="/docs/devops/gitlab/img/image-17.png" alt="alt text"></p>
<p>安装和注册方式与instance 类型一致，只是其中注册命令中的token 不同</p>
<h4 id="流水线文件">流水线文件</h4>
<p>名词：
流水线： 一个.gitlab-ci.yml 是一个流水线
作业： 一个job 是一个作业</p>
<pre class="mermaid">graph LR
z[.gitlab-ci.yml]
z -.-&gt;A
z -.-&gt;B
z -.-&gt;C
z -.-&gt;D
z -.-&gt;E
A[stages]
B[variables]

C[job]
C1[allow_failure]
C2[tags]
C3[stage]
C4[script]
C5[when]
C6[retry]
D[before_script]
E[after_script]
C --&gt; B
C --&gt;|允许失败| C1
C --&gt; C2
C --&gt; C3
C --&gt; C4
C --&gt; |按照上一个job的状态决定是否运行这里和jenkins不同|C5
C --&gt;C6
C --&gt; D
C --&gt; E</pre>
<p>pipeline 变量</p>
<p>本次提交跳过流水线
<img src="/docs/devops/gitlab/img/image-21.png" alt="alt text">
<img src="/docs/devops/gitlab/img/image-22.png" alt="alt text"></p>
<p>语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">stages</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span>- <span style="color:#ae81ff">test</span>
</span></span><span style="display:flex;"><span>- <span style="color:#ae81ff">deploy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">job1</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">linux</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">echo &#34;123&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">job2</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">linux</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">.post</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">allow_failure</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">echo &#34;456&#34;</span>
</span></span></code></pre></div><p>环境变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">stages</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">k1</span>: <span style="color:#e6db74">&#34;v1&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">k2</span>: <span style="color:#e6db74">&#34;v2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">job1</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">k1</span>: <span style="color:#e6db74">&#34;v1&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">k2</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;v2&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;k2 这个变量对应的值是v2,我只是一个描述信息&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">linux</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">echo &#34;${k1}&#34;</span>
</span></span></code></pre></div><p>job 作业</p>

</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-4572c2ec7409e33797ae2a1657dd1e52"></h1>
	<div class="lead">redmine 文档中心</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-6135d11c82eb95bad75696659564e90f">redmine</h1>
	<div class="lead">redmine|gitlab</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt="">
依赖
Ruby 2.7, 3.0, 3.1, 3.2
SQLite3 (tested with SQLite 3.11)
MySQL (tested with MySQL 8)</p>
<p>redmine 是一个项目管理工具，使用ruby开发，支持sqlit3/mysql/postgresql 作为后端存储库。</p>
<h3 id="部署安装">部署安装</h3>
<p>操作系统： <em>CentOS Linux release 7.9.2009 (Core)</em>
软件版本： <em>5.1.3</em>
ruby版本： <em>2.7.2</em></p>
<hr>
<p>ruby 环境安装</p>
<blockquote>
<p>gem 是ruby的包管理工具，可以理解为python的pip</p>
<p>设置gem 国内仓库地址：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 安装ruby环境</span>
</span></span><span style="display:flex;"><span>ruby_version<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;3.1.0&#39;</span>
</span></span><span style="display:flex;"><span>major_minor<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ruby_version%.*<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>install_ruby<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -f ruby-<span style="color:#e6db74">${</span>ruby_version<span style="color:#e6db74">}</span>.tar.gz <span style="color:#f92672">]</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		curl -q -# https://cache.ruby-lang.org/pub/ruby/<span style="color:#e6db74">${</span>major_minor<span style="color:#e6db74">}</span>/ruby-<span style="color:#e6db74">${</span>ruby_version<span style="color:#e6db74">}</span>.tar.gz -O
</span></span><span style="display:flex;"><span>		tar xf ruby-<span style="color:#e6db74">${</span>ruby_version<span style="color:#e6db74">}</span>.tar.gz
</span></span><span style="display:flex;"><span>		cd ruby-<span style="color:#e6db74">${</span>ruby_version<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>		./configure --disable-install-rdoc <span style="color:#f92672">&amp;&amp;</span>  make -j <span style="color:#ae81ff">8</span>  <span style="color:#f92672">&amp;&amp;</span> make install 
</span></span><span style="display:flex;"><span>		ruby -v
</span></span><span style="display:flex;"><span>		gem -v
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		tar xf ruby-<span style="color:#e6db74">${</span>ruby_version<span style="color:#e6db74">}</span>.tar.gz
</span></span><span style="display:flex;"><span>		cd ruby-<span style="color:#e6db74">${</span>ruby_version<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>		./configure --disable-install-rdoc <span style="color:#f92672">&amp;&amp;</span>  make -j <span style="color:#ae81ff">8</span>  <span style="color:#f92672">&amp;&amp;</span> make install 
</span></span><span style="display:flex;"><span>		ruby -v
</span></span><span style="display:flex;"><span>		gem -v
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>install_bundler<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 更新镜像源</span>
</span></span><span style="display:flex;"><span>    gem sources --add https://mirrors.tuna.tsinghua.edu.cn/rubygems/
</span></span><span style="display:flex;"><span>    gem sources --remove https://rubygems.org/
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bundler是一个Ruby库，用于管理Ruby应用程序的依赖</span>
</span></span><span style="display:flex;"><span>    gem install bundler --no-document --version <span style="color:#e6db74">&#39;&lt; 2&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 设置bundler的国内镜像地址</span>
</span></span><span style="display:flex;"><span>    bundle config set mirror.https://rubygems.org https://mirrors.tuna.tsinghua.edu.cn/rubygems/
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 查看设置是否成功</span>
</span></span><span style="display:flex;"><span>    bundle config get mirror.https://rubygems.org
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>yum install gdbm-devel readline-devel zlib-devel openssl-devel -y
</span></span><span style="display:flex;"><span>install_ruby
</span></span><span style="display:flex;"><span>install_bundler
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>install_redmine<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>   	curl -q -#  https://www.redmine.org/releases/redmine-5.1.3.tar.gz -O
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    tar xf redmine-5.1.3.tar.gz 
</span></span><span style="display:flex;"><span>    cd redmine-5.1.3/
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;production:\n  adapter: sqlite3\n  database: db/redmine.sqlite3\n&#34;</span> &gt;config/database.yml
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 安装依赖</span>
</span></span><span style="display:flex;"><span>    bundle install --without development test
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 生成secret</span>
</span></span><span style="display:flex;"><span>    bundle exec rake generate_secret_token
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 生成数据库表结构</span>
</span></span><span style="display:flex;"><span>    bundle exec rake db:migrate RAILS_ENV<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;production&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>    useradd redmine -s /usr/sbin/nologin 
</span></span><span style="display:flex;"><span>    chown -R redmine:redmine files log tmp public/plugin_assets
</span></span><span style="display:flex;"><span>    chmod -R <span style="color:#ae81ff">755</span> files log tmp public/plugin_assets
</span></span><span style="display:flex;"><span>    ruby bin/rails server -e production
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>install_redmine
</span></span></code></pre></div><blockquote>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e"># gem 是ruby 的包管理工具，该命令安装了一个包bundler</span>
</span></span><span style="display:flex;"><span>   bundle install --without development test
</span></span><span style="display:flex;"><span>   bundle exec rake db:migrate RAILS_ENV<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;production&#34;</span>
</span></span><span style="display:flex;"><span>   bundle exec rake generate_secret_token
</span></span><span style="display:flex;"><span>   useradd redmine
</span></span><span style="display:flex;"><span>   chown -R redmine:redmine files log tmp public/plugin_assets
</span></span><span style="display:flex;"><span>   chmod -R <span style="color:#ae81ff">755</span> files log tmp public/plugin_assets
</span></span><span style="display:flex;"><span>    ruby bin/rails server -e production
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>yum install ncurses ncurses-devel libaio cpanminus -y
</span></span><span style="display:flex;"><span>useradd -s /sbin/nologin -M mysql
</span></span><span style="display:flex;"><span>wget https://downloads.mysql.com/archives/get/p/23/file/mysql-8.0.36-linux-glibc2.12-x86_64.tar.xz
</span></span><span style="display:flex;"><span>tar xf mysql-8.0.36-linux-glibc2.12-x86_64.tar.xz -C /opt/
</span></span><span style="display:flex;"><span>ln -svf /opt/mysql-8.0.36-linux-glibc2.12-x86_64 /opt/mysql
</span></span><span style="display:flex;"><span>chown -R mysql.mysql /opt/mysql*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@localhost ~<span style="color:#f92672">]</span><span style="color:#75715e"># /opt/mysql/bin/mysqld  --initialize --user=mysql --basedir=/opt/mysql/ --datadir=/opt/mysql/data/</span>
</span></span><span style="display:flex;"><span>2024-06-29T10:10:23.688320Z <span style="color:#ae81ff">0</span> <span style="color:#f92672">[</span>Warning<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>MY-011070<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>Server<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;Disabling symbolic links using --skip-symbolic-links (or equivalent) is the default. Consider not using this option as it&#39;</span> is deprecated and will be removed in a future release.
</span></span><span style="display:flex;"><span>2024-06-29T10:10:23.688422Z <span style="color:#ae81ff">0</span> <span style="color:#f92672">[</span>System<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>MY-013169<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>Server<span style="color:#f92672">]</span> /opt/mysql/bin/mysqld <span style="color:#f92672">(</span>mysqld 8.0.36<span style="color:#f92672">)</span> initializing of server in progress as process <span style="color:#ae81ff">7931</span>
</span></span><span style="display:flex;"><span>2024-06-29T10:10:23.699452Z <span style="color:#ae81ff">1</span> <span style="color:#f92672">[</span>System<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>MY-013576<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>InnoDB<span style="color:#f92672">]</span> InnoDB initialization has started.
</span></span><span style="display:flex;"><span>2024-06-29T10:10:24.026657Z <span style="color:#ae81ff">1</span> <span style="color:#f92672">[</span>System<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>MY-013577<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>InnoDB<span style="color:#f92672">]</span> InnoDB initialization has ended.
</span></span><span style="display:flex;"><span>2024-06-29T10:10:25.693738Z <span style="color:#ae81ff">6</span> <span style="color:#f92672">[</span>Note<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>MY-010454<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>Server<span style="color:#f92672">]</span> A temporary password is generated <span style="color:#66d9ef">for</span> root@localhost: GJk1t<span style="color:#f92672">)</span>H<span style="color:#f92672">)</span>0Cug
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/opt/mysql/bin/mysqld_safe --defaults-file<span style="color:#f92672">=</span>/opt/mysql/my.cnf --datadir<span style="color:#f92672">=</span>/opt/mysql/data --pid-file<span style="color:#f92672">=</span>/opt/mysql/mysql.pid
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/opt/mysql/bin/mysqld_safe  --datadir<span style="color:#f92672">=</span>/opt/mysql/data --pid-file<span style="color:#f92672">=</span>/opt/mysql/mysql.pid
</span></span><span style="display:flex;"><span>/opt/mysql/bin/mysql -uroot -p<span style="color:#e6db74">&#39;hj2paRhqJl&#39;</span>
</span></span></code></pre></div><pre tabindex="0"><code>yum install mysql-devel
bundle install --without development test
</code></pre><p>create database redmine  set utf8 collate utf8_general_ci;</p>
<ol start="2">
<li>
<p>Create an empty utf8 encoded database: &ldquo;redmine&rdquo; for example</p>
</li>
<li>
<p>Configure the database parameters in config/database.yml
for the &ldquo;production&rdquo; environment (default database is MySQL)</p>
</li>
<li>
<p>Install the required gems by running:
bundle install &ndash;without development test</p>
<p>Only the gems that are needed by the adapters you&rsquo;ve specified in your
database configuration file are actually installed (eg. if your
config/database.yml uses the &lsquo;mysql2&rsquo; adapter, then only the mysql2 gem
will be installed). Don&rsquo;t forget to re-run <code>bundle install</code> when you
change config/database.yml for using other database adapters.</p>
<p>If you need to load some gems that are not required by Redmine core
(eg. fcgi), you can create a file named Gemfile.local at the root of
your redmine directory.
It will be loaded automatically when running <code>bundle install</code>.</p>
</li>
<li>
<p>Generate a session store secret</p>
<p>Redmine stores session data in cookies by default, which requires
a secret to be generated. Under the application main directory run:
bundle exec rake generate_secret_token</p>
<p>Alternatively, you can store this secret in config/secrets.yml:
<a href="http://guides.rubyonrails.org/upgrading_ruby_on_rails.html#config-secrets-yml" target="_blank">http://guides.rubyonrails.org/upgrading_ruby_on_rails.html#config-secrets-yml</a></p>
</li>
<li>
<p>Create the database structure</p>
<p>Under the application main directory run:
bundle exec rake db:migrate RAILS_ENV=&ldquo;production&rdquo;</p>
<p>It will create all the tables and an administrator account.</p>
</li>
<li>
<p>Setting up permissions (Windows users have to skip this section)</p>
<p>The user who runs Redmine must have write permission on the following
subdirectories: files, log, tmp &amp; public/plugin_assets.</p>
<p>Assuming you run Redmine with a user named &ldquo;redmine&rdquo;:
sudo chown -R redmine:redmine files log tmp public/plugin_assets
sudo chmod -R 755 files log tmp public/plugin_assets</p>
</li>
<li>
<p>Test the installation by running the Puma web server</p>
<p>Under the main application directory run:
ruby bin/rails server -e production</p>
<p>Once Puma has started, point your browser to http://localhost:3000/
You should now see the application welcome page.</p>
</li>
<li>
<p>Use the default administrator account to log in:
login: admin
password: admin</p>
<p>Go to &ldquo;Administration&rdquo; to load the default configuration data (roles,
trackers, statuses, workflow) and to adjust the application settings</p>
</li>
</ol>
<p>== Database server configuration</p>
<p>When using MySQL with Redmine 5.1.1 or later, it is necessary to change
the transaction isolation level from the default REPEATABLE READ to
READ_COMMITTED. To modify this setting, either change the database
configuration file or alter the settings on your MySQL server.</p>
<p>To set the transaction isolation level in the database configuration file,
add transaction_isolation variable as below:</p>
<p>production:
adapter: mysql2
database: redmine
host: localhost
[&hellip;]
variables:
transaction_isolation: &ldquo;READ-COMMITTED&rdquo;</p>
<p>More details can be found in <a href="https://www.redmine.org/projects/redmine/wiki/MySQL_configuration" target="_blank">https://www.redmine.org/projects/redmine/wiki/MySQL_configuration</a>.</p>
<p>== SMTP server Configuration</p>
<p>Copy config/configuration.yml.example to config/configuration.yml and
edit this file to adjust your SMTP settings.
Do not forget to restart the application after any change to this file.</p>
<p>Please do not enter your SMTP settings in environment.rb.</p>
<p>== References</p>
<ul>
<li><a href="http://www.redmine.org/wiki/redmine/RedmineInstall" target="_blank">http://www.redmine.org/wiki/redmine/RedmineInstall</a></li>
<li><a href="http://www.redmine.org/wiki/redmine/EmailConfiguration" target="_blank">http://www.redmine.org/wiki/redmine/EmailConfiguration</a></li>
<li><a href="http://www.redmine.org/wiki/redmine/RedmineSettings" target="_blank">http://www.redmine.org/wiki/redmine/RedmineSettings</a></li>
<li><a href="http://www.redmine.org/wiki/redmine/RedmineRepositories" target="_blank">http://www.redmine.org/wiki/redmine/RedmineRepositories</a></li>
<li><a href="http://www.redmine.org/wiki/redmine/RedmineReceivingEmails" target="_blank">http://www.redmine.org/wiki/redmine/RedmineReceivingEmails</a></li>
<li><a href="http://www.redmine.org/wiki/redmine/RedmineReminderEmails" target="_blank">http://www.redmine.org/wiki/redmine/RedmineReminderEmails</a></li>
<li><a href="http://www.redmine.org/wiki/redmine/RedmineLDAP" target="_blank">http://www.redmine.org/wiki/redmine/RedmineLDAP</a></li>
</ul>

</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-1702e0a177bcb438ed121b0f72f53789"></h1>
	<div class="lead">terraform 文档中心</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e7f89e9f3ce58272813dcb7eb3618b40">4.6.1 - </h1>
    
	<p><a href="https://developer.hashicorp.com/terraform/tutorials" target="_blank">doc</a>|<a href="https://registry.terraform.io/" target="_blank">registry</a></p>
<p>terraform 是HashiCorp 的基础设施即代码（IaC）的管理工具。使用golang编写
安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://releases.hashicorp.com/terraform/1.9.2/terraform_1.9.2_linux_amd64.zip
</span></span><span style="display:flex;"><span>unzip terraform_1.9.2_linux_amd64.zip
</span></span><span style="display:flex;"><span>mv terraform /usr/bin/
</span></span></code></pre></div><p>验证</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@jenkins01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># terraform  --version</span>
</span></span><span style="display:flex;"><span>Terraform v1.9.2
</span></span><span style="display:flex;"><span>on linux_amd64
</span></span></code></pre></div><p>安装命令补全</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform -install-autocomplete <span style="color:#f92672">&amp;&amp;</span> logout
</span></span></code></pre></div><h3 id="快速开始">快速开始</h3>
<ol>
<li>
<p>创建一个空目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir terraform-demo
</span></span></code></pre></div></li>
<li>
<p>将以下内容写入 <code>terraform-demo/main.tf</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">terraform</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">required_providers</span> <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">docker</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">source</span>  <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#f92672">&#34;kreuzwerker/docker&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">version</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#e6db74">&#34;~&gt; 3.0.1&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">provider</span> <span style="color:#e6db74">&#34;docker&#34;</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">resource</span> <span style="color:#e6db74">&#34;docker_image&#34;</span> <span style="color:#e6db74">&#34;nginx&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">name</span>         <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#f92672">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">keep_locally</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">resource</span> <span style="color:#e6db74">&#34;docker_container&#34;</span> <span style="color:#e6db74">&#34;nginx&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">image</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#960050;background-color:#1e0010">docker_image.nginx.name</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">name</span>  <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#f92672">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">ports</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">internal</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#960050;background-color:#1e0010">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">external</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#960050;background-color:#1e0010">8000</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>初始化</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/kreuzwerker/terraform-provider-docker/releases/download/v3.0.2/terraform-provider-docker_3.0.2_linux_amd64.zip
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> mkdir -p ~/.terraform.d/plugins/registry.terraform.io/kreuzwerker/docker/3.0.2/linux_amd64
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>unzip terraform-provider-docker_3.0.2_linux_amd64.zip -d  ~/.terraform.d/plugins/registry.terraform.io/kreuzwerker/docker/3.0.2/linux_amd64
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform init
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@jenkins01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cd terraform-demo/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@jenkins01 terraform-demo<span style="color:#f92672">]</span><span style="color:#75715e"># terraform init</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Initializing the backend...
</span></span><span style="display:flex;"><span>Initializing provider plugins...
</span></span><span style="display:flex;"><span>- Finding kreuzwerker/docker versions matching <span style="color:#e6db74">&#34;~&gt; 3.0.1&#34;</span>...
</span></span><span style="display:flex;"><span>- Installing kreuzwerker/docker v3.0.2...
</span></span><span style="display:flex;"><span>- Installed kreuzwerker/docker v3.0.2 <span style="color:#f92672">(</span>self-signed, key ID BD080C4571C6104C<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Partner and community providers are signed by their developers.
</span></span><span style="display:flex;"><span>If you<span style="color:#960050;background-color:#1e0010">&#39;</span>d like to know more about provider signing, you can read about it here:
</span></span><span style="display:flex;"><span>https://www.terraform.io/docs/cli/plugins/signing.html
</span></span><span style="display:flex;"><span>Terraform has created a lock file .terraform.lock.hcl to record the provider
</span></span><span style="display:flex;"><span>selections it made above. Include this file in your version control repository
</span></span><span style="display:flex;"><span>so that Terraform can guarantee to make the same selections by default when
</span></span><span style="display:flex;"><span>you run <span style="color:#e6db74">&#34;terraform init&#34;</span> in the future.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Terraform has been successfully initialized!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You may now begin working with Terraform. Try running <span style="color:#e6db74">&#34;terraform plan&#34;</span> to see
</span></span><span style="display:flex;"><span>any changes that are required <span style="color:#66d9ef">for</span> your infrastructure. All Terraform commands
</span></span><span style="display:flex;"><span>should now work.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>If you ever set or change modules or backend configuration <span style="color:#66d9ef">for</span> Terraform,
</span></span><span style="display:flex;"><span>rerun this command to reinitialize your working directory. If you forget, other
</span></span><span style="display:flex;"><span>commands will detect it and remind you to <span style="color:#66d9ef">do</span> so <span style="color:#66d9ef">if</span> necessary.
</span></span></code></pre></div></li>
<li>
<p>预览应用计划</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@192 test<span style="color:#f92672">]</span><span style="color:#75715e"># terraform plan</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span></span><span style="display:flex;"><span>+ create
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Terraform will perform the following actions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># docker_container.nginx will be created</span>
</span></span><span style="display:flex;"><span>+ resource <span style="color:#e6db74">&#34;docker_container&#34;</span> <span style="color:#e6db74">&#34;nginx&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    + attach                                      <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + bridge                                      <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + command                                     <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + container_logs                              <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + container_read_refresh_timeout_milliseconds <span style="color:#f92672">=</span> <span style="color:#ae81ff">15000</span>
</span></span><span style="display:flex;"><span>    + entrypoint                                  <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + env                                         <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + exit_code                                   <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + hostname                                    <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + id                                          <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + image                                       <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + init                                        <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + ipc_mode                                    <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + log_driver                                  <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + logs                                        <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + must_run                                    <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span>    + name                                        <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;tutorial&#34;</span>
</span></span><span style="display:flex;"><span>    + network_data                                <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + read_only                                   <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + remove_volumes                              <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span>    + restart                                     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;no&#34;</span>
</span></span><span style="display:flex;"><span>    + rm                                          <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + runtime                                     <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + security_opts                               <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + shm_size                                    <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + start                                       <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span>    + stdin_open                                  <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + stop_signal                                 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + stop_timeout                                <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + tty                                         <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + wait                                        <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + wait_timeout                                <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    + healthcheck <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    + labels <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    + ports <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        + external <span style="color:#f92672">=</span> <span style="color:#ae81ff">8000</span>
</span></span><span style="display:flex;"><span>        + internal <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        + ip       <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>
</span></span><span style="display:flex;"><span>        + protocol <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># docker_image.nginx will be created</span>
</span></span><span style="display:flex;"><span>+ resource <span style="color:#e6db74">&#34;docker_image&#34;</span> <span style="color:#e6db74">&#34;nginx&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    + id           <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + image_id     <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + keep_locally <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + name         <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>    + repo_digest  <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Plan: <span style="color:#ae81ff">2</span> to add, <span style="color:#ae81ff">0</span> to change, <span style="color:#ae81ff">0</span> to destroy.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Note: You didn<span style="color:#e6db74">&#39;t use the -out option to save this plan, so Terraform can&#39;</span>t guarantee to take exactly these actions <span style="color:#66d9ef">if</span> you run <span style="color:#e6db74">&#34;terraform apply&#34;</span>
</span></span><span style="display:flex;"><span>now.
</span></span></code></pre></div></li>
<li>
<p>应用该配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@192 test<span style="color:#f92672">]</span><span style="color:#75715e"># terraform apply</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span></span><span style="display:flex;"><span>+ create
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Terraform will perform the following actions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># docker_container.nginx will be created</span>
</span></span><span style="display:flex;"><span>+ resource <span style="color:#e6db74">&#34;docker_container&#34;</span> <span style="color:#e6db74">&#34;nginx&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    + attach                                      <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + bridge                                      <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + command                                     <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + container_logs                              <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + container_read_refresh_timeout_milliseconds <span style="color:#f92672">=</span> <span style="color:#ae81ff">15000</span>
</span></span><span style="display:flex;"><span>    + entrypoint                                  <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + env                                         <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + exit_code                                   <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + hostname                                    <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + id                                          <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + image                                       <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + init                                        <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + ipc_mode                                    <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + log_driver                                  <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + logs                                        <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + must_run                                    <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span>    + name                                        <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;tutorial&#34;</span>
</span></span><span style="display:flex;"><span>    + network_data                                <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + read_only                                   <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + remove_volumes                              <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span>    + restart                                     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;no&#34;</span>
</span></span><span style="display:flex;"><span>    + rm                                          <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + runtime                                     <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + security_opts                               <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + shm_size                                    <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + start                                       <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span>    + stdin_open                                  <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + stop_signal                                 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + stop_timeout                                <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + tty                                         <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + wait                                        <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + wait_timeout                                <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    + healthcheck <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    + labels <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    + ports <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        + external <span style="color:#f92672">=</span> <span style="color:#ae81ff">8000</span>
</span></span><span style="display:flex;"><span>        + internal <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        + ip       <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>
</span></span><span style="display:flex;"><span>        + protocol <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># docker_image.nginx will be created</span>
</span></span><span style="display:flex;"><span>+ resource <span style="color:#e6db74">&#34;docker_image&#34;</span> <span style="color:#e6db74">&#34;nginx&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    + id           <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + image_id     <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    + keep_locally <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    + name         <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>    + repo_digest  <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>known after apply<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Plan: <span style="color:#ae81ff">2</span> to add, <span style="color:#ae81ff">0</span> to change, <span style="color:#ae81ff">0</span> to destroy.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want to perform these actions?
</span></span><span style="display:flex;"><span>Terraform will perform the actions described above.
</span></span><span style="display:flex;"><span>Only <span style="color:#e6db74">&#39;yes&#39;</span> will be accepted to approve.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enter a value: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker_image.nginx: Creating...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker_image.nginx: Still creating... <span style="color:#f92672">[</span>10s elapsed<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>docker_image.nginx: Creation complete after 20s <span style="color:#f92672">[</span>id<span style="color:#f92672">=</span>sha256:fffffc90d343cbcb01a5032edac86db5998c536cd0a366514121a45c6723765cnginx<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>docker_container.nginx: Creating...
</span></span><span style="display:flex;"><span>docker_container.nginx: Creation complete after 1s <span style="color:#f92672">[</span>id<span style="color:#f92672">=</span>360704dcbb82c35c9e4c65f604ad6af22e4277fed5bb34b0b75eed58ead3ced6<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Apply complete! Resources: <span style="color:#ae81ff">2</span> added, <span style="color:#ae81ff">0</span> changed, <span style="color:#ae81ff">0</span> destroyed.
</span></span></code></pre></div><p>创建了一个pod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@192 test<span style="color:#f92672">]</span><span style="color:#75715e"># docker ps </span>
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE             COMMAND                  CREATED         STATUS         PORTS                                                                                                                             NAMES
</span></span><span style="display:flex;"><span>360704dcbb82   fffffc90d343      <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">5</span> seconds ago   Up <span style="color:#ae81ff">4</span> seconds   0.0.0.0:8000-&gt;80/tcp                                                                                                              tutorial
</span></span></code></pre></div></li>
<li>
<p>销毁pod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@192 test<span style="color:#f92672">]</span><span style="color:#75715e"># terraform destroy </span>
</span></span><span style="display:flex;"><span>docker_image.nginx: Refreshing state... <span style="color:#f92672">[</span>id<span style="color:#f92672">=</span>sha256:fffffc90d343cbcb01a5032edac86db5998c536cd0a366514121a45c6723765cnginx<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>docker_container.nginx: Refreshing state... <span style="color:#f92672">[</span>id<span style="color:#f92672">=</span>360704dcbb82c35c9e4c65f604ad6af22e4277fed5bb34b0b75eed58ead3ced6<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span></span><span style="display:flex;"><span>- destroy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Terraform will perform the following actions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># docker_container.nginx will be destroyed</span>
</span></span><span style="display:flex;"><span>- resource <span style="color:#e6db74">&#34;docker_container&#34;</span> <span style="color:#e6db74">&#34;nginx&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    - attach                                      <span style="color:#f92672">=</span> false -&gt; null
</span></span><span style="display:flex;"><span>    - command                                     <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#34;nginx&#34;</span>,
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#34;-g&#34;</span>,
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#34;daemon off;&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">]</span> -&gt; null
</span></span><span style="display:flex;"><span>    - container_read_refresh_timeout_milliseconds <span style="color:#f92672">=</span> <span style="color:#ae81ff">15000</span> -&gt; null
</span></span><span style="display:flex;"><span>    - cpu_shares                                  <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> -&gt; null
</span></span><span style="display:flex;"><span>    - dns                                         <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span> -&gt; null
</span></span><span style="display:flex;"><span>    - dns_opts                                    <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span> -&gt; null
</span></span><span style="display:flex;"><span>    - dns_search                                  <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span> -&gt; null
</span></span><span style="display:flex;"><span>    - entrypoint                                  <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#34;/docker-entrypoint.sh&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">]</span> -&gt; null
</span></span><span style="display:flex;"><span>    - env                                         <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span> -&gt; null
</span></span><span style="display:flex;"><span>    - group_add                                   <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span> -&gt; null
</span></span><span style="display:flex;"><span>    - hostname                                    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;360704dcbb82&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    - id                                          <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;360704dcbb82c35c9e4c65f604ad6af22e4277fed5bb34b0b75eed58ead3ced6&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    - image                                       <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sha256:fffffc90d343cbcb01a5032edac86db5998c536cd0a366514121a45c6723765c&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    - init                                        <span style="color:#f92672">=</span> false -&gt; null
</span></span><span style="display:flex;"><span>    - ipc_mode                                    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;private&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    - log_driver                                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;json-file&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    - log_opts                                    <span style="color:#f92672">=</span> <span style="color:#f92672">{}</span> -&gt; null
</span></span><span style="display:flex;"><span>    - logs                                        <span style="color:#f92672">=</span> false -&gt; null
</span></span><span style="display:flex;"><span>    - max_retry_count                             <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> -&gt; null
</span></span><span style="display:flex;"><span>    - memory                                      <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> -&gt; null
</span></span><span style="display:flex;"><span>    - memory_swap                                 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> -&gt; null
</span></span><span style="display:flex;"><span>    - must_run                                    <span style="color:#f92672">=</span> true -&gt; null
</span></span><span style="display:flex;"><span>    - name                                        <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;tutorial&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    - network_data                                <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            - gateway                   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.17.0.1&#34;</span>
</span></span><span style="display:flex;"><span>            - global_ipv6_prefix_length <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            - ip_address                <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.17.0.3&#34;</span>
</span></span><span style="display:flex;"><span>            - ip_prefix_length          <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>            - mac_address               <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;02:42:ac:11:00:03&#34;</span>
</span></span><span style="display:flex;"><span>            - network_name              <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bridge&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># (2 unchanged attributes hidden)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">]</span> -&gt; null
</span></span><span style="display:flex;"><span>    - network_mode                                <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;default&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    - privileged                                  <span style="color:#f92672">=</span> false -&gt; null
</span></span><span style="display:flex;"><span>    - publish_all_ports                           <span style="color:#f92672">=</span> false -&gt; null
</span></span><span style="display:flex;"><span>    - read_only                                   <span style="color:#f92672">=</span> false -&gt; null
</span></span><span style="display:flex;"><span>    - remove_volumes                              <span style="color:#f92672">=</span> true -&gt; null
</span></span><span style="display:flex;"><span>    - restart                                     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;no&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    - rm                                          <span style="color:#f92672">=</span> false -&gt; null
</span></span><span style="display:flex;"><span>    - runtime                                     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;runc&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    - security_opts                               <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span> -&gt; null
</span></span><span style="display:flex;"><span>    - shm_size                                    <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span> -&gt; null
</span></span><span style="display:flex;"><span>    - start                                       <span style="color:#f92672">=</span> true -&gt; null
</span></span><span style="display:flex;"><span>    - stdin_open                                  <span style="color:#f92672">=</span> false -&gt; null
</span></span><span style="display:flex;"><span>    - stop_signal                                 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SIGQUIT&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    - stop_timeout                                <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> -&gt; null
</span></span><span style="display:flex;"><span>    - storage_opts                                <span style="color:#f92672">=</span> <span style="color:#f92672">{}</span> -&gt; null
</span></span><span style="display:flex;"><span>    - sysctls                                     <span style="color:#f92672">=</span> <span style="color:#f92672">{}</span> -&gt; null
</span></span><span style="display:flex;"><span>    - tmpfs                                       <span style="color:#f92672">=</span> <span style="color:#f92672">{}</span> -&gt; null
</span></span><span style="display:flex;"><span>    - tty                                         <span style="color:#f92672">=</span> false -&gt; null
</span></span><span style="display:flex;"><span>    - wait                                        <span style="color:#f92672">=</span> false -&gt; null
</span></span><span style="display:flex;"><span>    - wait_timeout                                <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span> -&gt; null
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># (7 unchanged attributes hidden)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - ports <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        - external <span style="color:#f92672">=</span> <span style="color:#ae81ff">8000</span> -&gt; null
</span></span><span style="display:flex;"><span>        - internal <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span> -&gt; null
</span></span><span style="display:flex;"><span>        - ip       <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0.0.0.0&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>        - protocol <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;tcp&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># docker_image.nginx will be destroyed</span>
</span></span><span style="display:flex;"><span>- resource <span style="color:#e6db74">&#34;docker_image&#34;</span> <span style="color:#e6db74">&#34;nginx&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    - id           <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sha256:fffffc90d343cbcb01a5032edac86db5998c536cd0a366514121a45c6723765cnginx&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    - image_id     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sha256:fffffc90d343cbcb01a5032edac86db5998c536cd0a366514121a45c6723765c&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    - keep_locally <span style="color:#f92672">=</span> false -&gt; null
</span></span><span style="display:flex;"><span>    - name         <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nginx&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    - repo_digest  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nginx@sha256:67682bda769fae1ccf5183192b8daf37b64cae99c6c3302650f6f8bf5f0f95df&#34;</span> -&gt; null
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Plan: <span style="color:#ae81ff">0</span> to add, <span style="color:#ae81ff">0</span> to change, <span style="color:#ae81ff">2</span> to destroy.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you really want to destroy all resources?
</span></span><span style="display:flex;"><span>Terraform will destroy all your managed infrastructure, as shown above.
</span></span><span style="display:flex;"><span>There is no undo. Only <span style="color:#e6db74">&#39;yes&#39;</span> will be accepted to confirm.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enter a value: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker_container.nginx: Destroying... <span style="color:#f92672">[</span>id<span style="color:#f92672">=</span>360704dcbb82c35c9e4c65f604ad6af22e4277fed5bb34b0b75eed58ead3ced6<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>docker_container.nginx: Destruction complete after 1s
</span></span><span style="display:flex;"><span>docker_image.nginx: Destroying... <span style="color:#f92672">[</span>id<span style="color:#f92672">=</span>sha256:fffffc90d343cbcb01a5032edac86db5998c536cd0a366514121a45c6723765cnginx<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>docker_image.nginx: Destruction complete after 0s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Destroy complete! Resources: <span style="color:#ae81ff">2</span> destroyed.
</span></span></code></pre></div></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@jenkins01 terraform-exsi<span style="color:#f92672">]</span><span style="color:#75715e"># cat main.tf </span>
</span></span><span style="display:flex;"><span>terraform <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  required_version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&gt;= 0.13&#34;</span>
</span></span><span style="display:flex;"><span>  required_providers <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    vsphere <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      source  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hashicorp/vsphere&#34;</span>
</span></span><span style="display:flex;"><span>      version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&gt;= 2.0.0&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>provider <span style="color:#e6db74">&#34;vsphere&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  user           <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;administrator@vsphere.local&#34;</span>
</span></span><span style="display:flex;"><span>  password       <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Cc1020304050!&#34;</span>
</span></span><span style="display:flex;"><span>  vsphere_server <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.0.214&#34;</span>
</span></span><span style="display:flex;"><span>  allow_unverified_ssl <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#e6db74">&#34;vsphere_datacenter&#34;</span> <span style="color:#e6db74">&#34;datacenter&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Beijing&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#e6db74">&#34;vsphere_resource_pool&#34;</span> <span style="color:#e6db74">&#34;pool&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  name          <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Resources&#34;</span>
</span></span><span style="display:flex;"><span>  datacenter_id <span style="color:#f92672">=</span> data.vsphere_datacenter.datacenter.id
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#e6db74">&#34;vsphere_datastore&#34;</span> <span style="color:#e6db74">&#34;store&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  name          <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;data&#34;</span>
</span></span><span style="display:flex;"><span>  datacenter_id <span style="color:#f92672">=</span> data.vsphere_datacenter.datacenter.id
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#e6db74">&#34;vsphere_network&#34;</span> <span style="color:#e6db74">&#34;network&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  name          <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;VM Network&#34;</span>
</span></span><span style="display:flex;"><span>  datacenter_id <span style="color:#f92672">=</span> data.vsphere_datacenter.datacenter.id
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resource <span style="color:#e6db74">&#34;vsphere_virtual_machine&#34;</span> <span style="color:#e6db74">&#34;example_vm&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  name             <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ExampleVM&#34;</span>
</span></span><span style="display:flex;"><span>  resource_pool_id <span style="color:#f92672">=</span> data.vsphere_resource_pool.pool.id
</span></span><span style="display:flex;"><span>  datastore_id     <span style="color:#f92672">=</span> data.vsphere_datastore.store.id
</span></span><span style="display:flex;"><span>  num_cpus         <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  memory           <span style="color:#f92672">=</span> <span style="color:#ae81ff">4096</span>
</span></span><span style="display:flex;"><span>  guest_id         <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;otherGuest&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  network_interface <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    network_id <span style="color:#f92672">=</span> data.vsphere_network.network.id
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  disk <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;disk0&#34;</span>
</span></span><span style="display:flex;"><span>    size  <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  cdrom <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    path          <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CentOS-7.9-x86_64-DVD-2009.iso&#34;</span>
</span></span><span style="display:flex;"><span>    datastore_id <span style="color:#f92672">=</span> data.vsphere_datastore.store.id
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>datastore1/template-centos7/centos7-template-1.vmdk
</span></span><span style="display:flex;"><span>datastore1/template-centos7/centos7-template.ovf
</span></span></code></pre></div>
</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5990d373ac824b52e97a76c2b3e2ff2c">5 - </h1>
    <div class="lead">linux 文档中心</div>
	<pre class="mermaid">graph LR
    A[&#34;/&#34;] -.-&gt;|User Binaries| B[&#34;/bin&#34;]
    A -.-&gt;|System Binaries| C[&#34;/sbin&#34;]
    A -.-&gt;|Configuration Files| D[&#34;/etc&#34;]
    A -.-&gt;|Device Files| E[&#34;/dev&#34;]
    A -.-&gt;|Process Information| F[&#34;/proc&#34;]
    A -.-&gt;|Variable Files| G[&#34;/var&#34;]
    A -.-&gt;|Temporary Files| H[&#34;/tmp&#34;]
    A -.-&gt;|User Programs| I[&#34;/usr&#34;]
    A -.-&gt;|Home Directories| J[&#34;/home&#34;]
    A -.-&gt;|Boot Loader Files| K[&#34;/boot&#34;]
    A -.-&gt;|System Libraries| L[&#34;/lib&#34;]
    A -.-&gt;|Optional add-on Apps| M[&#34;/opt&#34;]
    A -.-&gt;|Mount Directory| N[&#34;/mnt&#34;]
    A -.-&gt;|Removable Devices| O[&#34;/media&#34;]
    A -.-&gt;|Service Data| P[&#34;/srv&#34;]</pre>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c5846110725fe6073de26c491841db19">问题排查</h1>
	<div class="lead">问题排查|linux</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-21" class="text-body-secondary">Wednesday, May 21, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h3 id="查看服务器基本信息">查看服务器基本信息</h3>
<table>
  <thead>
      <tr>
          <th>分类</th>
          <th>功能</th>
          <th>命令</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>硬件</td>
          <td>通过DMI获取系统硬件信息</td>
          <td><code>dmidecode</code> 或 <code>lshw</code></td>
      </tr>
      <tr>
          <td></td>
          <td>显示PCI/USB接口信息</td>
          <td><code>lspci</code>/<code>lsusb</code></td>
      </tr>
      <tr>
          <td></td>
          <td>显示CPU信息</td>
          <td><code>lscpu</code> 或 <code>cat /proc/cpuinfo</code></td>
      </tr>
      <tr>
          <td></td>
          <td>检查硬件虚拟化的支持</td>
          <td><code>egrep --color &quot;vmx|svm&quot; /proc/cpuinfo</code></td>
      </tr>
      <tr>
          <td></td>
          <td>显示物理内存大小</td>
          <td><code>free -m</code> 或 `cat /proc/meminfo</td>
      </tr>
      <tr>
          <td>系统</td>
          <td>查看系统发行版本</td>
          <td><code>cat /etc/system-release</code></td>
      </tr>
      <tr>
          <td></td>
          <td>查看系统内核版本</td>
          <td><code>uname -r</code></td>
      </tr>
      <tr>
          <td></td>
          <td>显示机器的体系结构</td>
          <td><code>arch</code> 或 <code>uname -m</code></td>
      </tr>
      <tr>
          <td></td>
          <td>显示系统加载的内核模块</td>
          <td><code>lsmod</code></td>
      </tr>
      <tr>
          <td></td>
          <td>查看磁盘的<code>inode size</code>  和 <code>block size</code></td>
          <td><code>dumpe2fs /dev/mapper/seagullcore-data</code></td>
      </tr>
      <tr>
          <td>日志</td>
          <td>查看系统启动、硬件</td>
          <td><code>dmesg</code> 或 <code>/var/log/dmesg</code></td>
      </tr>
      <tr>
          <td></td>
          <td>系统日志，记录内核、服务、应用程序的非关键信息</td>
          <td><code>/var/log/messages </code></td>
      </tr>
      <tr>
          <td></td>
          <td>用户登录日志</td>
          <td><code>/var/log/secure</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>cron</code> 定时任务日志</td>
          <td><code>/var/log/cron</code></td>
      </tr>
      <tr>
          <td></td>
          <td>审计日志</td>
          <td><code>/var/log/audit/audit.log</code></td>
      </tr>
      <tr>
          <td></td>
          <td>yum日志</td>
          <td><code>/var/log/yum.log</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>postfix</code> 或 <code>sendmail</code> 等邮件服务的日志</td>
          <td><code>/var/log/maillog</code></td>
      </tr>
  </tbody>
</table>
<h3 id="journalctl-命令">journalctl 命令</h3>
<p>centos7 中<code>journalctl</code> 命令用于显示系统日志。
默认情况下，<code>journalctl</code> 仅显示当前会话的日志，并滚动显示最新的日志条目。
若要显示完整的日志信息，应使用 <code>journalctl</code> 命令配合一些选项来获取更多的日志细节。以下是一些常用的选项：</p>
<ul>
<li><code>-u &lt;unit&gt;</code>：指定要查看的服务名称，例如 <code>-u nginx</code>。</li>
<li><code>-f</code>：以滚动模式显示日志，实时显示新日志条目。</li>
<li><code>-r</code>：以逆序（即从新到旧的顺序）显示日志条目。</li>
<li><code>-o &lt;format&gt;</code>：指定输出格式，可以是 <code>short</code>、<code>verbose</code>、<code>json</code> 等。例如，使用 <code>journalctl -o json</code> 将输出日志以 JSON 格式显示。</li>
<li><code>--since &lt;time&gt;</code>：指定要显示的日志开始时间，该参数可以是时间戳，或者使用类似 <code>yesterday</code>，<code>1 hour ago</code> 的相对时间。例如，使用 <code>journalctl --since &quot;2023-06-24 10:00:00&quot;</code> 将显示从 2023-06-24 10:00:00 开始的所有日志。</li>
<li><code>--until &lt;time&gt;</code>：指定要显示的日志截止时间。例如: <code>journalctl --until &quot;1 hour ago&quot;</code> 将显示截止到 1 小时前的所有日志。</li>
<li><code>-n &lt;number&gt;</code>：指定要显示的日志条目数量。例如，使用 <code>journalctl -n 50</code> 将仅显示最新的 50 条日志。</li>
</ul>
<p>以下是一个示例，可以使用该示例来查看系统的所有服务的日志，显示所有启动时间为 2022 年 1 月 1 日之后的日志，以详细模式显示这些日志，并按照事件发生的反向顺序排列输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>journalctl --since <span style="color:#e6db74">&#34;2022-01-01&#34;</span> -o verbose -u all -r
</span></span></code></pre></div><h3 id="journald-日志系统">journald 日志系统</h3>
<p>centos7 中journalctl是systemd日志系统的管理工具，默认临时存储在<code>/run/log/journal/</code>目录中，重启后丢失。</p>
<p><strong>开启持久化:</strong></p>
<blockquote>
<p><code>/etc/systemd/journald.conf</code> 配置文件中关键参数：</p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th>可选值</th>
          <th>注释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong><code>Storage</code></strong></td>
          <td>volatile</td>
          <td>仅保存在内存中。 例如  <code>Storage=volatile</code></td>
      </tr>
      <tr>
          <td></td>
          <td>persistent</td>
          <td>优先保存在磁盘。例如：<code>Storage=persistent</code></td>
      </tr>
      <tr>
          <td></td>
          <td>auto</td>
          <td>若存在<code>/var/log/journal</code>则持久化，否在仅保存内存中。例如：<code>Storage=auto</code></td>
      </tr>
      <tr>
          <td><strong><code>SystemMaxUse</code></strong></td>
          <td></td>
          <td>限制最大磁盘使用量。例如 <code>SystemMaxUse=10G</code></td>
      </tr>
      <tr>
          <td><strong><code>RuntimeMaxUse</code></strong></td>
          <td></td>
          <td>限制最大内存使用量。例如 <code>RuntimeMaxUse=1G</code></td>
      </tr>
  </tbody>
</table>
</blockquote>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">日志清理</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 清理早于指定时间的日志</span>
</span></span><span style="display:flex;"><span>journalctl --vacuum-time<span style="color:#f92672">=</span>7d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 限制日志体积（如保留500MB）</span>
</span></span><span style="display:flex;"><span>journalctl --vacuum-size<span style="color:#f92672">=</span>500M
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /var/log/journal
</span></span><span style="display:flex;"><span>chown root:systemd-journal /var/log/journal
</span></span><span style="display:flex;"><span>chmod <span style="color:#ae81ff">2755</span> /var/log/journal
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/.*Storage.*/Storage=persistent/&#39;</span> /etc/systemd/journald.conf
</span></span><span style="display:flex;"><span>systemctl restart systemd-journald
</span></span></code></pre></div><h3 id="系统性能监视工具">系统性能监视工具</h3>
<blockquote>
<p><code>  yum install htop iftop iptraf nethogs iperf3 strace perf systemtap-sdt-devel.x86_64 -y</code></p>
</blockquote>
<table>
  <thead>
      <tr>
          <th>工具</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>htop</td>
          <td>动态显示系统进程任务</td>
      </tr>
      <tr>
          <td>top</td>
          <td>动态显示系统进程任务</td>
      </tr>
      <tr>
          <td>iotop</td>
          <td>显示进程的磁盘 I/O 信息（iostat 和 top 的结合体）</td>
      </tr>
      <tr>
          <td>slabtop</td>
          <td></td>
      </tr>
      <tr>
          <td>iftop</td>
          <td></td>
      </tr>
      <tr>
          <td>vmstat</td>
          <td>显示进程队列、内存、交换空间、块 I/O、CPU 活动信息</td>
      </tr>
      <tr>
          <td>sysstat</td>
          <td>输出 CPU 的各种统计信息。可以用来分析程序运行时在内核态和用户态的时间</td>
      </tr>
      <tr>
          <td>iostat</td>
          <td>显示当前的网络流量</td>
      </tr>
      <tr>
          <td>pidstat</td>
          <td></td>
      </tr>
      <tr>
          <td>fstat</td>
          <td>输出 CPU、IO 系统和磁盘分区的统计信息。可以用来分析磁盘 I/O、带宽等</td>
      </tr>
      <tr>
          <td>uptime</td>
          <td>显示系统的运行时间和平均负载</td>
      </tr>
      <tr>
          <td>procps</td>
          <td>显示系统内存的使用</td>
      </tr>
      <tr>
          <td>sar</td>
          <td>定时搜集系统的各种状态信息，然后对系统各个时间点的状态进行监控</td>
      </tr>
      <tr>
          <td>pmap</td>
          <td></td>
      </tr>
      <tr>
          <td>iptraf</td>
          <td></td>
      </tr>
      <tr>
          <td>nethogs</td>
          <td></td>
      </tr>
      <tr>
          <td>iperf3</td>
          <td></td>
      </tr>
      <tr>
          <td>strace</td>
          <td></td>
      </tr>
      <tr>
          <td>dtrace</td>
          <td></td>
      </tr>
      <tr>
          <td>ionice</td>
          <td></td>
      </tr>
      <tr>
          <td>nice</td>
          <td></td>
      </tr>
      <tr>
          <td>renice</td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="top命令">top命令</h3>
<p><strong>VIRT：virtual memory usage 虚拟内存</strong></p>
<p>1、进程“需要的”虚拟内存大小，包括进程使用的库、代码、数据等
2、假如进程申请100m的内存，但实际只使用了10m，那么它会增长100m，而不是实际的使用量</p>
<p><strong>RES：resident memory usage 常驻内存</strong>
1、进程当前使用的内存大小，但不包括swap out
2、包含其他进程的共享
3、如果申请100m的内存，实际使用10m，它只增长10m，与VIRT相反
4、关于库占用内存的情况，它只统计加载的库文件所占内存大小
<strong>SHR：shared memory 共享内存</strong>
1、除了自身进程的共享内存，也包括其他进程的共享内存
2、虽然进程只使用了几个共享库的函数，但它包含了整个共享库的大小
3、计算某个进程所占的物理内存大小公式：RES – SHR
4、swap out后，它将会降下来
<strong>DATA</strong>
1、数据占用的内存。如果top没有显示，按f键可以显示出来。
2、真正的该程序要求的数据空间，是真正在运行中要使用的。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">快捷键</th>
          <th style="text-align: left">注释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">1</td>
          <td style="text-align: left">展开逻辑cpu详情</td>
      </tr>
      <tr>
          <td style="text-align: left">u</td>
          <td style="text-align: left">显示指定用户的进程</td>
      </tr>
      <tr>
          <td style="text-align: left">k</td>
          <td style="text-align: left">杀死指定进程</td>
      </tr>
      <tr>
          <td style="text-align: left">c</td>
          <td style="text-align: left">显示命令的完整信息</td>
      </tr>
      <tr>
          <td style="text-align: left">f</td>
          <td style="text-align: left">选择要输出显示的列</td>
      </tr>
      <tr>
          <td style="text-align: left"><Space>或<Enter></td>
          <td style="text-align: left">立即刷新显示</td>
      </tr>
      <tr>
          <td style="text-align: left">l</td>
          <td style="text-align: left">– 关闭或开启第一部分第一行 top 信息的表示</td>
      </tr>
      <tr>
          <td style="text-align: left">t</td>
          <td style="text-align: left">– 关闭或开启第一部分第二行 Tasks 和第三行 Cpus 信息的表示</td>
      </tr>
      <tr>
          <td style="text-align: left">m</td>
          <td style="text-align: left">– 关闭或开启第一部分第四行 Mem 和 第五行 Swap 信息的表示</td>
      </tr>
      <tr>
          <td style="text-align: left">N</td>
          <td style="text-align: left">– 以 PID 的大小的顺序排列表示进程列表</td>
      </tr>
      <tr>
          <td style="text-align: left">P</td>
          <td style="text-align: left">– 以 CPU 占用率大小的顺序排列进程列表</td>
      </tr>
      <tr>
          <td style="text-align: left">M</td>
          <td style="text-align: left">– 以内存占用率大小的顺序排列进程列表</td>
      </tr>
  </tbody>
</table>
<h3 id="iostat命令">iostat命令</h3>
<table>
  <thead>
      <tr>
          <th>选项</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>-c</td>
          <td>仅显示 CPU 统计信息。与 -d 选项互斥</td>
      </tr>
      <tr>
          <td>-d</td>
          <td>仅显示磁盘统计信息。与 -c 选项互斥</td>
      </tr>
      <tr>
          <td>-k</td>
          <td>以 KB 为单位显示每秒的磁盘请求数。默认单位为块</td>
      </tr>
      <tr>
          <td>-m</td>
          <td>以 MB 为单位显示每秒的磁盘请求数。默认单位为块</td>
      </tr>
      <tr>
          <td>-p {device|ALL}</td>
          <td>用于显示块设备及系统分区的统计信息。与 -x 选项互斥</td>
      </tr>
      <tr>
          <td>-x</td>
          <td>输出扩展信息</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@iostat ~<span style="color:#f92672">]</span><span style="color:#75715e"># iostat -x</span>
</span></span><span style="display:flex;"><span>Linux 3.10.0-957.el7.x86_64 <span style="color:#f92672">(</span>redis-uat07-s1<span style="color:#f92672">)</span>    05/27/2025      _x86_64_        <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span> CPU<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>avg-cpu:  %user   %nice %system %iowait  %steal   %idle
</span></span><span style="display:flex;"><span>           2.56    0.00    3.90    0.00    0.00   93.54
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
</span></span><span style="display:flex;"><span>sda               0.00     0.01    0.00    0.29     0.04     8.19    56.11     0.00    0.43   17.40    0.37   0.11   0.00
</span></span><span style="display:flex;"><span>dm-0              0.00     0.00    0.00    0.30     0.03     8.19    54.11     0.00    0.44   18.19    0.38   0.11   0.00
</span></span><span style="display:flex;"><span>dm-1              0.00     0.00    0.00    0.00     0.00     0.00    54.67     0.00    0.33    0.33    0.00   0.30   0.00
</span></span></code></pre></div><p>avg-cpu 部分输出项说明</p>
<table>
  <thead>
      <tr>
          <th>输出项</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%user</td>
          <td>在用户级别运行所使用的 CPU 的百分比</td>
      </tr>
      <tr>
          <td>%nice</td>
          <td>高优先级进程（nice=0）使用的 CPU 的百分比</td>
      </tr>
      <tr>
          <td>%system</td>
          <td>在核心级别（kernel）运行所使用 CPU 的百分比</td>
      </tr>
      <tr>
          <td>%iowait</td>
          <td>CPU 等待硬件 IO 所占用 CPU 的百分比</td>
      </tr>
      <tr>
          <td>%steal</td>
          <td>当管理程序（hypervisor）为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比</td>
      </tr>
      <tr>
          <td>%idle</td>
          <td>CPU 空闲时间的百分比</td>
      </tr>
  </tbody>
</table>
<p>Device 部分基本输出项说明</p>
<table>
  <thead>
      <tr>
          <th>输出项</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Blk_read</td>
          <td>读入的数据总量，单位为块</td>
      </tr>
      <tr>
          <td>Blk_wrtn</td>
          <td>写入的数据总量，单位为块</td>
      </tr>
      <tr>
          <td>kb_read</td>
          <td>读入的数据总量，单位为 KB</td>
      </tr>
      <tr>
          <td>kb_wrtn</td>
          <td>写入的数据总量，单位为 KB</td>
      </tr>
      <tr>
          <td>MB_read</td>
          <td>读入的数据总量，单位为 MB</td>
      </tr>
      <tr>
          <td>MB_wrtn</td>
          <td>写入的数据总量，单位为 MB</td>
      </tr>
      <tr>
          <td>Blk_read/s</td>
          <td>每秒从驱动器读入的数据量，单位为块/s</td>
      </tr>
      <tr>
          <td>Blk_wrtn/s</td>
          <td>每秒向驱动器写入的数据量，单位为块/s</td>
      </tr>
      <tr>
          <td>KB_read/s</td>
          <td>每秒从驱动器读入的数据量，单位为 KB/s</td>
      </tr>
      <tr>
          <td>KB_wrtn/s</td>
          <td>每秒向驱动器写入的数据量，单位为 KB/s</td>
      </tr>
      <tr>
          <td>MB_read/s</td>
          <td>每秒从驱动器读入的数据量，单位为 MB/s</td>
      </tr>
      <tr>
          <td>MB_wrtn/s</td>
          <td>每秒向驱动器写入的数据量，单位为 MB/s</td>
      </tr>
      <tr>
          <td>tps</td>
          <td>每秒向物理设备写入的 IO 传输总量</td>
      </tr>
  </tbody>
</table>
<p>Device 部分扩展输出项说明</p>
<table>
  <thead>
      <tr>
          <th>输出项</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>rrqm/s</td>
          <td>将读入请求合并后，每秒发送到设备的读入请求数</td>
      </tr>
      <tr>
          <td>wrqm/s</td>
          <td>将写入请求合并后，每秒发送到设备的写入请求数</td>
      </tr>
      <tr>
          <td>r/s</td>
          <td>每秒发送到设备的读入请求数</td>
      </tr>
      <tr>
          <td>w/s</td>
          <td>每秒发送到设备的写入请求数</td>
      </tr>
      <tr>
          <td>rkB/s</td>
          <td>每秒从设备读入的数据量，单位为 KB/s</td>
      </tr>
      <tr>
          <td>wkB/s</td>
          <td>每秒向设备写入的数据量，单位为 KB/s</td>
      </tr>
      <tr>
          <td>avgrq-sz</td>
          <td>发送到设备的请求的平均大小，单位为扇区</td>
      </tr>
      <tr>
          <td>avgqu-sz</td>
          <td>发送到设备的请求的平均队列长度</td>
      </tr>
      <tr>
          <td>await</td>
          <td>IO 请求平均执行时间，包括发送请求和执行的时间，单位为毫秒</td>
      </tr>
      <tr>
          <td>r_await</td>
          <td>读入请求平均执行时间，单位为毫秒</td>
      </tr>
      <tr>
          <td>w_await</td>
          <td>写入请求平均执行时间，单位为毫秒</td>
      </tr>
      <tr>
          <td>svctm</td>
          <td>IO 请求在设备上的平均执行时间，单位为毫秒</td>
      </tr>
      <tr>
          <td>%util</td>
          <td>设备利用率，表示设备的忙碌程度，当值接近 100% 时，表示设备带宽已占满</td>
      </tr>
      <tr>
          <td>usec/s</td>
          <td>每秒向设备写入的扇区数</td>
      </tr>
      <tr>
          <td>rMB/s</td>
          <td>每秒从设备读入的数据量，单位为 MB/s</td>
      </tr>
      <tr>
          <td>wMB/s</td>
          <td>每秒向设备写入的数据量，单位为 MB/s</td>
      </tr>
  </tbody>
</table>
<h3 id="vmstat命令">vmstat命令</h3>
<table>
  <thead>
      <tr>
          <th>选项</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>-n</td>
          <td>只在开始时显示一次各字段名称</td>
      </tr>
      <tr>
          <td>-a</td>
          <td>显示活跃和非活跃内存</td>
      </tr>
      <tr>
          <td>-m</td>
          <td>显示 procs/abinfo</td>
      </tr>
      <tr>
          <td>-S</td>
          <td>使用指定单位显示，K(1000)、K(1024)、M(1000000)、M(1048576) 字节，默认单位为 K</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@vmstat ~<span style="color:#f92672">]</span><span style="color:#75715e"># vmstat  5</span>
</span></span><span style="display:flex;"><span>procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
</span></span><span style="display:flex;"><span> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">159304</span>     <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">1821284</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">4</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">3</span>  <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">94</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>输出结果字段说明</p>
<table>
  <thead>
      <tr>
          <th>分类</th>
          <th>输出项</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>procs</td>
          <td>r</td>
          <td>在运行队列中等待运行的进程数</td>
      </tr>
      <tr>
          <td></td>
          <td>b</td>
          <td>等待 IO 的进程数</td>
      </tr>
      <tr>
          <td>memory (默认单位为 KB)</td>
          <td>swpd</td>
          <td>当前使用的交换空间</td>
      </tr>
      <tr>
          <td></td>
          <td>free</td>
          <td>当前空闲的物理内存</td>
      </tr>
      <tr>
          <td></td>
          <td>buff</td>
          <td>用作缓冲的内存大小</td>
      </tr>
      <tr>
          <td></td>
          <td>cache</td>
          <td>用作缓存的内存大小</td>
      </tr>
      <tr>
          <td></td>
          <td>inactive</td>
          <td>非活跃的内存大小（当使用 -a 选项时显示）</td>
      </tr>
      <tr>
          <td></td>
          <td>active</td>
          <td>活跃的内存大小（当使用 -a 选项时显示）</td>
      </tr>
      <tr>
          <td>swap</td>
          <td>si</td>
          <td>每秒写入交换区的内存大小</td>
      </tr>
      <tr>
          <td></td>
          <td>so</td>
          <td>每秒写入交换区的内存大小</td>
      </tr>
      <tr>
          <td>io</td>
          <td>bi</td>
          <td>每秒读取块设备的块数</td>
      </tr>
      <tr>
          <td></td>
          <td>bo</td>
          <td>每秒写入块设备的块数</td>
      </tr>
      <tr>
          <td>system</td>
          <td>in</td>
          <td>每秒的中断数，包括时钟中断</td>
      </tr>
      <tr>
          <td></td>
          <td>cs</td>
          <td>每秒的环境（上下文）切换次数</td>
      </tr>
      <tr>
          <td>cpu</td>
          <td>us</td>
          <td>用户进程执行时间的百分比</td>
      </tr>
      <tr>
          <td></td>
          <td>sy</td>
          <td>系统进程执行时间的百分比</td>
      </tr>
      <tr>
          <td></td>
          <td>id</td>
          <td>空闲时间（包括等待 IO 时间）的百分比</td>
      </tr>
      <tr>
          <td></td>
          <td>wa</td>
          <td>等待 IO 时间的百分比</td>
      </tr>
      <tr>
          <td></td>
          <td>st</td>
          <td>管理程序（hypervisor）为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比</td>
      </tr>
  </tbody>
</table>
<h3 id="mpstat命令">mpstat命令</h3>
<blockquote>
<p>mpstat 通过分析 <code>/proc/stat</code> 文件报告cpu相关信息</p>
</blockquote>
<p>输出结果字段说明</p>
<table>
  <thead>
      <tr>
          <th>输出项</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%user</td>
          <td>在多 CPU 系统里，每个 CPU 有一个 ID 号。第一个 CPU 为 0，all 表示统计信息为所有 CPU 的平均值</td>
      </tr>
      <tr>
          <td>%nice</td>
          <td>显示在用户级别运行所占用 CPU 总时间的百分比</td>
      </tr>
      <tr>
          <td>%system</td>
          <td>显示在核心级别（kernel）运行所占用 CPU 总时间的百分比。这个值并不包括服务中断和 softirq</td>
      </tr>
      <tr>
          <td>%iowait</td>
          <td>显示用于等待 IO 操作中，占用 CPU 总时间的百分比</td>
      </tr>
      <tr>
          <td>%steal</td>
          <td>显示用于虚拟机管理程序（hypervisor）为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比</td>
      </tr>
      <tr>
          <td>%idle</td>
          <td>显示 CPU 在空闲状态，占用 CPU 总时间的百分比</td>
      </tr>
      <tr>
          <td>intr/s</td>
          <td>显示 CPU 每秒接收到的中断总数</td>
      </tr>
  </tbody>
</table>
<h3 id="sar命令">sar命令</h3>
<blockquote>
<p>用于收集、报告、保存系统活跃信息</p>
</blockquote>
<p>在<code>sar</code>的基础上增加 <code>sar [ interval [ count ] ]</code>选项。可以指定统计间隔和统计次数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sar 1 2</span>
</span></span><span style="display:flex;"><span>Linux 3.10.0-1160.92.1.el7.x86_64 <span style="color:#f92672">(</span>master01<span style="color:#f92672">)</span>    10/03/2023      _x86_64_        <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span> CPU<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>11:20:15 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
</span></span><span style="display:flex;"><span>11:20:16 AM     all      4.11      0.00      4.38      0.00      0.00     91.51
</span></span><span style="display:flex;"><span>11:20:17 AM     all      2.79      0.00      5.29      0.00      0.00     91.92
</span></span><span style="display:flex;"><span>Average:        all      3.45      0.00      4.83      0.00      0.00     91.71
</span></span></code></pre></div><p>将 <code>sar [ interval [ count ] ] -o datafile</code> 命令结果输出到文件中。</p>
<p>举例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sar -o datafile <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span> &gt;/dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span> &amp;
</span></span></code></pre></div><p>查看datafile 中的内容 :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sar -f ./datafile 
</span></span></code></pre></div><p>查看cpu状态</p>
<p><code>sar -u 1 2 </code> 查看cpu的统计信息，此时和 <code>sar 1 2</code> 结果一样</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sar -u 1 2</span>
</span></span><span style="display:flex;"><span>Linux 3.10.0-1160.92.1.el7.x86_64 <span style="color:#f92672">(</span>master01<span style="color:#f92672">)</span>    10/03/2023      _x86_64_        <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span> CPU<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>11:22:44 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
</span></span><span style="display:flex;"><span>11:22:45 AM     all      2.41      0.00      4.83      0.00      0.00     92.76
</span></span><span style="display:flex;"><span>11:22:46 AM     all      2.66      0.00      3.99      0.00      0.00     93.35
</span></span><span style="display:flex;"><span>Average:        all      2.54      0.00      4.41      0.00      0.00     93.06
</span></span></code></pre></div><p><code>sar -P 0 1 2</code> 查看cpu0的统计信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sar  -P 0 1 2 </span>
</span></span><span style="display:flex;"><span>Linux 3.10.0-1160.92.1.el7.x86_64 <span style="color:#f92672">(</span>master01<span style="color:#f92672">)</span>    10/03/2023      _x86_64_        <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span> CPU<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>11:19:19 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
</span></span><span style="display:flex;"><span>11:19:20 AM       <span style="color:#ae81ff">0</span>      5.26      0.00      2.11      0.00      0.00     92.63
</span></span><span style="display:flex;"><span>11:19:21 AM       <span style="color:#ae81ff">0</span>      2.08      0.00      5.21      0.00      0.00     92.71
</span></span><span style="display:flex;"><span>Average:          <span style="color:#ae81ff">0</span>      3.66      0.00      3.66      0.00      0.00     92.67
</span></span></code></pre></div><p><code>sar -P ALL 1 2</code> 展开显示所有核心的统计信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sar -P ALL 1 2 </span>
</span></span><span style="display:flex;"><span>Linux 3.10.0-1160.92.1.el7.x86_64 <span style="color:#f92672">(</span>master01<span style="color:#f92672">)</span>    10/03/2023      _x86_64_        <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span> CPU<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>11:26:58 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
</span></span><span style="display:flex;"><span>11:26:59 AM     all      2.70      0.00      4.59      0.00      0.00     92.70
</span></span><span style="display:flex;"><span>11:26:59 AM       <span style="color:#ae81ff">0</span>      3.37      0.00      3.37      0.00      0.00     93.26
</span></span><span style="display:flex;"><span>11:26:59 AM       <span style="color:#ae81ff">1</span>      3.30      0.00      4.40      0.00      0.00     92.31
</span></span><span style="display:flex;"><span>11:26:59 AM       <span style="color:#ae81ff">2</span>      3.09      0.00      5.15      0.00      0.00     91.75
</span></span><span style="display:flex;"><span>11:26:59 AM       <span style="color:#ae81ff">3</span>      3.23      0.00      4.30      0.00      0.00     92.47
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>11:26:59 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
</span></span><span style="display:flex;"><span>11:27:00 AM     all      3.98      0.00      2.39      0.00      0.00     93.63
</span></span><span style="display:flex;"><span>11:27:00 AM       <span style="color:#ae81ff">0</span>      2.13      0.00      3.19      0.00      0.00     94.68
</span></span><span style="display:flex;"><span>11:27:00 AM       <span style="color:#ae81ff">1</span>      6.32      0.00      4.21      0.00      0.00     89.47
</span></span><span style="display:flex;"><span>11:27:00 AM       <span style="color:#ae81ff">2</span>      3.16      0.00      2.11      0.00      0.00     94.74
</span></span><span style="display:flex;"><span>11:27:00 AM       <span style="color:#ae81ff">3</span>      3.12      0.00      3.12      0.00      0.00     93.75
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Average:        CPU     %user     %nice   %system   %iowait    %steal     %idle
</span></span><span style="display:flex;"><span>Average:        all      3.35      0.00      3.48      0.00      0.00     93.17
</span></span><span style="display:flex;"><span>Average:          <span style="color:#ae81ff">0</span>      2.73      0.00      3.28      0.00      0.00     93.99
</span></span><span style="display:flex;"><span>Average:          <span style="color:#ae81ff">1</span>      4.84      0.00      4.30      0.00      0.00     90.86
</span></span><span style="display:flex;"><span>Average:          <span style="color:#ae81ff">2</span>      3.12      0.00      3.65      0.00      0.00     93.23
</span></span><span style="display:flex;"><span>Average:          <span style="color:#ae81ff">3</span>      3.17      0.00      3.70      0.00      0.00     93.12
</span></span></code></pre></div><h3 id="lsof命令">lsof命令</h3>
<p>Lsof是遵从Unix哲学的典范，它只完成一个功能，并且做的相当完美——它可以列出某个进程打开的所有文件信息。打开的文件可能是普通的文件、目录、NFS文件、块文件、字符文件、共享库、常规管道、命名管道、符号链接、Socket流、网络Socket、UNIX域Socket，以及其它更多类型。因为“一切皆文件”乃为Unix系统的重要哲学思想之一，因此可以想象lsof命令的重要地位。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lsof ［options］ filename
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lsof  /path/to/somefile：显示打开指定文件的所有进程之列表
</span></span><span style="display:flex;"><span>lsof -c string：显示其COMMAND列中包含指定字符<span style="color:#f92672">(</span>string<span style="color:#f92672">)</span>的进程所有打开的文件；此选项可以重复使用，以指定多个模式；
</span></span><span style="display:flex;"><span>lsof -p PID：查看该进程打开了哪些文件；进程号前可以使用脱字符“^”取反；
</span></span><span style="display:flex;"><span>lsof -u USERNAME：显示指定用户的进程打开的文件；用户名前可以使用脱字符“^”取反，如“lsof -u ^root”则用于显示非root用户打开的所有文件；
</span></span><span style="display:flex;"><span>lsof -g GID：显示归属gid的进程情况
</span></span><span style="display:flex;"><span>lsof +d /DIR/：显示指定目录下被进程打开的文件
</span></span><span style="display:flex;"><span>lsof +D /DIR/：基本功能同上，但lsof会对指定目录进行递归查找，注意这个参数要比grep版本慢：
</span></span><span style="display:flex;"><span>lsof -a：按“与”组合多个条件，如lsof -a -c apache -u apache
</span></span><span style="display:flex;"><span>lsof -N：列出所有NFS（网络文件系统）文件
</span></span><span style="display:flex;"><span>lsof -d FD：显示指定文件描述符的相关进程；也可以为描述符指定一个范围，如0-2表示0,1,2三个文件描述符；另外，-d还支持其它很多特殊值，如：
</span></span><span style="display:flex;"><span>	mem: 列出所有内存映射文件；
</span></span><span style="display:flex;"><span>	mmap：显示所有内存映射设备；
</span></span><span style="display:flex;"><span>	txt：列出所有加载在内存中并正在执行的进程，包含code和data；
</span></span><span style="display:flex;"><span>	cwd：正在访问当前目录的进程列表；
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>lsof -n：不反解IP至HOSTNAME
</span></span><span style="display:flex;"><span>lsof -i：用以显示符合条件的进程情况
</span></span><span style="display:flex;"><span>lsof -i<span style="color:#f92672">[</span>46<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>protocol<span style="color:#f92672">][</span>@hostname|hostaddr<span style="color:#f92672">][</span>:service|port<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	46：IPv4或IPv6
</span></span><span style="display:flex;"><span>	protocol：TCP or UDP
</span></span><span style="display:flex;"><span>	hostname：Internet host name
</span></span><span style="display:flex;"><span>	hostaddr：IPv4地址
</span></span><span style="display:flex;"><span>	service：/etc/service中的服务名称<span style="color:#f92672">(</span>可以不只一个<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	port：端口号 <span style="color:#f92672">(</span>可以不只一个<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>例如： 查看22端口现在运行的情况
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@www ~<span style="color:#f92672">]</span><span style="color:#75715e"># lsof -i :22</span>
</span></span><span style="display:flex;"><span>COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>sshd     <span style="color:#ae81ff">1390</span> root    3u  IPv4  <span style="color:#ae81ff">13050</span>      0t0  TCP *:ssh <span style="color:#f92672">(</span>LISTEN<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>sshd     <span style="color:#ae81ff">1390</span> root    4u  IPv6  <span style="color:#ae81ff">13056</span>      0t0  TCP *:ssh <span style="color:#f92672">(</span>LISTEN<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>sshd    <span style="color:#ae81ff">36454</span> root    3r  IPv4  <span style="color:#ae81ff">94352</span>      0t0  TCP www.magedu.com:ssh-&gt;172.16.0.1:50018 <span style="color:#f92672">(</span>ESTABLISHED<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>上述命令中，每行显示一个打开的文件，若不指定条件默认将显示所有进程打开的所有文件。lsof输出各列信息的意义如下：
</span></span><span style="display:flex;"><span>	COMMAND：进程的名称
</span></span><span style="display:flex;"><span>	PID：进程标识符
</span></span><span style="display:flex;"><span>	USER：进程所有者
</span></span><span style="display:flex;"><span>	FD：文件描述符，应用程序通过文件描述符识别该文件。如cwd、txt等
</span></span><span style="display:flex;"><span>	TYPE：文件类型，如DIR、REG等
</span></span><span style="display:flex;"><span>	DEVICE：指定磁盘的名称
</span></span><span style="display:flex;"><span>	SIZE：文件的大小
</span></span><span style="display:flex;"><span>	NODE：索引节点（文件在磁盘上的标识）
</span></span><span style="display:flex;"><span>	NAME：打开文件的确切名称
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-aabda7bf6d1a96b643d9cd390156de59">常用命令</h1>
	<div class="lead">command|linux</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-21" class="text-body-secondary">Wednesday, May 21, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<div class="td-card-group card-group p-0 mb-4">
  <div class="td-card card border me-4">
<div class="card-header">
      <strong>文本处理</strong>
    </div>
<div class="card-body">
    <p class="card-text">
        
  <a href="#mkdir">mkdir</a>, <a href="#touch">touch</a>, <a href="#mktemp">mktemp</a>, <a href="#ln">ln</a>, 
  <a href="#tar">tar</a>, <a href="#gzip">gzip</a>, <a href="#zip">zip</a>, <a href="#unzip">unzip</a>, 
  <a href="#grep">grep</a>, <a href="#sed">sed</a>, <a href="#awk">awk</a>, <a href="#tr">tr</a>, <a href="#sort">sort</a>, <a href="#uniq">uniq</a>, <a href="#more">more</a>, <a href="#less">less</a>, <a href="#dd">dd</a>, <a href="#echo">echo</a>, <a href="#printf">printf</a>,
  <a href="#tail">tail</a>, <a href="#tailf">tailf</a>, <a href="#head">head</a>, <a href="#stat">stat</a>, <a href="#wc">wc</a>, <a href="#cat">cat</a>, <a href="#tac">tac</a>, <a href="#nl">nl</a>, <a href="#tee">tee</a>, <a href="#cut">cut</a>, <a href="#source">source</a>, <a href="#read">read</a>, <a href="#seq">seq</a>, 
  <a href="#find">find</a>, <a href="#xargs">xargs</a>, <a href="#exec">exec</a>, <a href="#expr">expr</a>, <a href="#install">install</a>,  <a href="#test">test</a>,   <a href="#eval">eval</a>, 
  <a href="#base64">base64</a>, <a href="#openssl">openssl</a>, <a href="#cfssl">cfssl</a>
  </p>
      </div>
  </div>

  <div class="td-card card border me-4">
<div class="card-header">
      <strong>系统命令</strong>
    </div>
<div class="card-body">
    <p class="card-text">
        
  <a href="#top">top/htop</a>, <a href="#vmstat">vmstat</a>, <a href="#sar">sar</a>, <a href="#iostat">iostat</a>, <a href="#ionice">ionice</a>, <a href="#taskset">taskset</a>, <a href="#uptime">uptime</a>, <a href="#journalctl">journalctl</a>, <a href="#lsmem">lsmem</a>, <a href="#lscpu">lscpu</a>, <a href="#crontab">crontab</a>, <a href="#at">at</a>, <a href="#hostname">hostname</a>, <a href="#halt">halt</a>, <a href="#init">init</a>, <a href="#chkconfig">chkconfig</a>, <a href="#ntpdate">ntpdate</a>, <a href="#chronyd">chronyd</a>, <a href="#ps">ps</a>, <a href="#pstree">pstree</a>, <a href="#pgrep">pgrep</a>, <a href="#pidof">pidof</a>, <a href="#kill">kill</a>, <a href="#killall">killall</a>, <a href="#runlevel">runlevel</a>, <a href="#free">free</a>, <a href="#dmidecode">dmidecode</a>, <a href="#date">date</a>, <a href="#yum">yum</a>, <a href="#rpm">rpm</a>, <a href="#getent">getent</a>, <a href="#info">info</a>, <a href="#man">man</a>, <a href="#lz">lz</a>, <a href="#sz">sz</a>
  </p>
      </div>
  </div>

  <div class="td-card card border me-4">
<div class="card-header">
      <strong>网络管理</strong>
    </div>
<div class="card-body">
    <p class="card-text">
        
  <a href="#curl">curl</a>, <a href="#wget">wget</a>, <a href="#dig">dig</a>, <a href="#nc">nc</a>, <a href="#tcpdump">tcpdump</a>, <a href="#nmap">nmap</a>, <a href="#telnet">telnet</a>, <a href="#ip">ip</a>, <a href="#ifconfig">ifconfig</a>, <a href="#route">route</a>, <a href="#ifup">ifup</a>, <a href="#ifdown">ifdown</a>, <a href="#brctl">brctl</a>
  </p>
      </div>
  </div>

  <div class="td-card card border me-4">
<div class="card-header">
      <strong>磁盘管理</strong>
    </div>
<div class="card-body">
    <p class="card-text">
        
  <a href="#df">df</a>, <a href="#du">du</a>, <a href="#fdisk">fdisk</a>, <a href="#parted">parted</a>,<a href="#mount">mount</a>, <a href="#showmount">showmount</a>, <a href="#lsblk">lsblk</a>, <a href="#blkid">blkid</a>, <a href="#fsdump">fsdump</a>
  </p>
      </div>
  </div>

</div>

<p><span id=date><strong>date</strong></span></p>
<ul>
<li>查看时区: <code>date -R </code></li>
<li>获取当前时间时间戳: <code>date +%s</code></li>
<li>时间戳格式化为时间格式: <code>date -d @1674108177 +&quot;%F %H:%m%S&quot;</code></li>
<li>时间格式格式化为时间戳: <code> date -d &quot;2023-01-19 14:01:57&quot; +%s</code></li>
</ul>
<p><span id=yum><strong>yum</strong></span></p>
<ul>
<li>列出软件包可以用的版本: <code>yum search --showduplicates docker</code></li>
<li>查看软件包信息: <code>yum info docker</code></li>
</ul>
<p><span id=rpm><strong>rpm</strong></span></p>
<ul>
<li>
<p>查看rpm包是否安装: <code>rpm -qa docker</code></p>
</li>
<li>
<p>列出软件包相关文件: <code>rpm -ql docker</code></p>
</li>
</ul>
<p><span id=getent ><strong>getent</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># grep ^root /etc/passwd</span>
</span></span><span style="display:flex;"><span>getent passwd root
</span></span></code></pre></div><p><span id=read><strong>read</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-p    指定提示符  
</span></span><span style="display:flex;"><span>-t    指定超时时间
</span></span><span style="display:flex;"><span>-s    隐藏输入内容
</span></span><span style="display:flex;"><span>-u    读取文件描述符
</span></span><span style="display:flex;"><span>-n    读取指定字符后自动回车 例如： read -n <span style="color:#ae81ff">1</span> -p <span style="color:#e6db74">&#34;将在你输入第一个字符后自动回车：&#34;</span>
</span></span><span style="display:flex;"><span>REPLY 默认接受键盘的输入的变量名
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#read -t 30 -p &#34;please input firstname:&#34; firstname</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#echo $firstname</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#read -t 30 -p &#34;please input firstname:&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#echo $REPLY</span>
</span></span></code></pre></div><p><span id=stat><strong>stat</strong></span></p>
<ul>
<li>获取文件的权限信息: <code>stat -c %A /etc/services</code></li>
<li>获取文件的权限信息: <code>stat -c %a /etc/services</code></li>
<li>获取文件的大小: <code>stat -c %s /etc/services</code></li>
</ul>
<p><span id=echo><strong>echo</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo -e 
</span></span><span style="display:flex;"><span>转义
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\a</span> 发出警告声； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\b</span> 删除前一个字符； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\c</span> 最后不加上换行符号； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\f</span> 换行但光标仍旧停留在原来的位置； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\n</span> 换行且光标移至行首； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\r</span> 光标移至行首，但不换行； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\t</span> 插入tab； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\v</span> 与<span style="color:#ae81ff">\f</span>相同； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\\</span> 插入<span style="color:#ae81ff">\字</span>符； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\n</span>nn 插入nnn（八进制）所代表的ASCII字符；
</span></span></code></pre></div><p><span id=printf><strong>printf</strong></span></p>
<p>优势就在于格式化处理字符串</p>

  
  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="格式化字符" aria-controls="tabs-01-00" aria-selected="true">
        格式化字符
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="转义字符" aria-controls="tabs-01-01" aria-selected="false">
        转义字符
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="对齐和精度" aria-controls="tabs-01-02" aria-selected="false">
        对齐和精度
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <table>
  <thead>
      <tr>
          <th>格式符</th>
          <th>描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%s</td>
          <td>字符串</td>
      </tr>
      <tr>
          <td>%f</td>
          <td>浮点格式</td>
      </tr>
      <tr>
          <td>%b</td>
          <td>转义字符会被转义</td>
      </tr>
      <tr>
          <td>%c</td>
          <td>ASCII字符，显示对应参数的第一个字符</td>
      </tr>
      <tr>
          <td>%d, %i</td>
          <td>十进制整数</td>
      </tr>
      <tr>
          <td>%o</td>
          <td>不带正负号的八进制值</td>
      </tr>
      <tr>
          <td>%u</td>
          <td>不带正负号的十进制值</td>
      </tr>
      <tr>
          <td>%x</td>
          <td>不带正负号的十六进制值，用a到f表示10至15</td>
      </tr>
      <tr>
          <td>%X</td>
          <td>不带正负号的十六进制值，用A到F表示10至15</td>
      </tr>
      <tr>
          <td>%%</td>
          <td>表示‘%’本身</td>
      </tr>
  </tbody>
</table>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <table>
  <thead>
      <tr>
          <th>转义字符</th>
          <th>描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>\a</td>
          <td>警告字符，常为ASCII的BEL字符</td>
      </tr>
      <tr>
          <td>\b</td>
          <td>后退</td>
      </tr>
      <tr>
          <td>\c</td>
          <td>不显示输出结果中任何结尾的换行字符</td>
      </tr>
      <tr>
          <td>\f</td>
          <td>换页（formfeed）</td>
      </tr>
      <tr>
          <td>\n</td>
          <td>换行</td>
      </tr>
      <tr>
          <td>\r</td>
          <td>回车</td>
      </tr>
      <tr>
          <td>\t</td>
          <td>水平制表符</td>
      </tr>
      <tr>
          <td>\v</td>
          <td>垂直制表符</td>
      </tr>
      <tr>
          <td>\</td>
          <td>“\”本身</td>
      </tr>
      <tr>
          <td>\ddd</td>
          <td>表示1到3位数八进制值得字符串，仅在字符格式串中有效</td>
      </tr>
      <tr>
          <td>\0ddd</td>
          <td>表示1到3位数八进制值得字符串</td>
      </tr>
  </tbody>
</table>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <table>
  <thead>
      <tr>
          <th>对齐和精度控制格式符</th>
          <th>描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%7s</td>
          <td>当前替换符对应的输出长度为7个字符宽，不足补齐，超出也正常显示</td>
      </tr>
      <tr>
          <td>%-7s</td>
          <td>“-”，表示左对齐，不加时，是右对齐</td>
      </tr>
      <tr>
          <td>%+5d</td>
          <td>正数会自动变为+num</td>
      </tr>
      <tr>
          <td>%12.3f</td>
          <td>“.3”表示保留小数点后三位，%f默认是小数点后6位</td>
      </tr>
      <tr>
          <td>%12.5d</td>
          <td>“.5”表示整数的长度，不足用0补齐</td>
      </tr>
  </tbody>
</table>

    </div>
</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;%s\n&#34;</span> <span style="color:#f92672">{</span>1..20<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;%10s\n&#34;</span> <span style="color:#f92672">{</span>1..20<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;%-10s\n&#34;</span> <span style="color:#f92672">{</span>1..20<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;%2.2f\n&#34;</span> <span style="color:#f92672">{</span>1..20<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;%2d\n&#34;</span> <span style="color:#f92672">{</span>1..20<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;(%d)\n&#34;</span> <span style="color:#f92672">{</span>1..20<span style="color:#f92672">}</span> 
</span></span></code></pre></div><p><span id=sort><strong>sort</strong></span></p>
<ul>
<li>按照ASCII 排序: <code>sort /etc/hosts</code></li>
<li>排序并去除重复行: <code>sort -u /etc/hosts</code></li>
<li>按照ASCII  逆序: <code>sort -r /etc/hosts</code></li>
<li>按照数字排序: <code>sort -n /etc/hosts</code></li>
<li>按照月份排序: <code>sort -M /etc/hosts</code></li>
<li>按照指定分隔符分割后，指定列排序: <code>sort -t &quot;:&quot; -k 3 -n /etc/passwd</code></li>
</ul>
<p><span id=uniq><strong>uniq</strong></span></p>
<ul>
<li>查看文件内容等同cat: <code>uniq /etc/hosts</code></li>
<li>只显示重复行: <code>uniq -d /etc/hosts</code></li>
<li>去重重复行显示: <code>uniq -u /etc/hosts</code></li>
<li>显示重复行出现的次数: <code>uniq -c /etc/hosts</code></li>
</ul>
<p><span id=uniq><strong>wc</strong></span></p>
<ul>
<li>统计文本函数: <code>wc -l /etc/hosts</code></li>
<li>统计文本字数: <code>wc -w /etc/hosts</code></li>
<li>统计文本字节数: <code>wc -c /etc/hosts</code></li>
<li>统计文本中最长一行包含的字节数: <code>wc -L /etc/hosts</code></li>
</ul>
<p><span id=seq><strong>seq</strong></span></p>
<p>语法	<font color=red> <strong><code>命令格式seq [OPTION]... FIRST INCREMENT LAST</code></strong></font></p>
<ul>
<li>从2开始到10结尾步长为1：<code>seq 2 10</code></li>
<li>从2开始到10结尾步长为2: <code>seq 2 2 10</code></li>
<li>从2开始到10结尾步长为2，等宽显示: <code>seq -w 2 2 10</code></li>
<li>从2开始到10结尾步长为2，等宽显示.修改分隔符为空格: <code>seq -s &quot; &quot; -w 2 2 10</code></li>
</ul>
<p><span id=cut><strong>cut</strong></span></p>
<p>语法：<font color=red> <code>cut OPTION... [FILE]</code></font></p>
<ul>
<li>按照字符串截取: <code>echo &quot;http://127.0.0.1/#/zh-cn/bash&quot;|cut -c 1-4,8-10</code></li>
<li>按照字符串截取,1-  表示从第一个字符到结尾: <code>echo &quot;http://127.0.0.1/#/zh-cn/bash&quot;|cut -c 1-</code></li>
<li>按照字符串截取,-5  表示从第一个字符到结尾: <code>echo &quot;http://127.0.0.1/#/zh-cn/bash&quot;|cut -c -5</code></li>
<li>按照分隔符截取: <code>echo &quot;http://127.0.0.1/#/zh-cn/bash&quot;|cut -d '/' -f1,2,3</code></li>
</ul>
<p><span id=tr><strong>tr</strong></span></p>
<p><em>translate or delete characters</em></p>
<p>删除:	<code>echo {a..z}{1..10}|tr -d [0-9]</code></p>
<p>替换:	<code>echo {a..z}{1..10}|tr [a-z] [A-Z]</code></p>
<p><span id=find><strong>find</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>find  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>!<span style="color:#f92672">]</span>-type 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>!<span style="color:#f92672">]</span>--maxdepth levels
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>!<span style="color:#f92672">]</span>-name 
</span></span><span style="display:flex;"><span>    -o   或  
</span></span><span style="display:flex;"><span>    -a   and
</span></span><span style="display:flex;"><span>    -mtime +-7
</span></span><span style="display:flex;"><span>    -ctime +-7 
</span></span><span style="display:flex;"><span>    -atime +-7
</span></span><span style="display:flex;"><span>    -perm
</span></span><span style="display:flex;"><span>    -user &lt;username&gt;
</span></span><span style="display:flex;"><span>    -group &lt;groupname&gt;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>find / -type f -name curl -or -name wget -perm <span style="color:#ae81ff">755</span>
</span></span><span style="display:flex;"><span>find /etc -name <span style="color:#e6db74">&#34;host*&#34;</span> -print
</span></span><span style="display:flex;"><span>find /etc -name <span style="color:#e6db74">&#34;host*&#34;</span> -print0
</span></span><span style="display:flex;"><span>find / -nouser -a -nogroup
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查找时排除指定文件夹./rules_file</span>
</span></span><span style="display:flex;"><span>find . -path <span style="color:#e6db74">&#34;./rules_file&#34;</span> -prune -o -print
</span></span></code></pre></div><p><span id=expr><strong>expr</strong></span></p>
<ul>
<li>计算字符串长度: <code>expr length &quot;hello world&quot;</code></li>
<li>模式匹配</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#e6db74">&#39;STRING : REGEX&#39;</span>
</span></span><span style="display:flex;"><span>     执行模式匹配。两端参数会转换为字符格式，且第二个参数被视为正则表达式<span style="color:#f92672">(</span>GNU基本正则<span style="color:#f92672">)</span>，它默认会隐含前缀<span style="color:#e6db74">&#34;^&#34;</span>。随后将第一个参数和正则模式做匹配。
</span></span><span style="display:flex;"><span>     如果匹配成功，且REGEX使用了<span style="color:#e6db74">&#39;\(&#39;</span>和<span style="color:#e6db74">&#39;\)&#39;</span>，则此表达式返回匹配到的，如果未使用<span style="color:#e6db74">&#39;\(&#39;</span>和<span style="color:#e6db74">&#39;\)&#39;</span>，则返回匹配的字符数。
</span></span><span style="display:flex;"><span>     如果匹配失败，如果REGEX中使用了<span style="color:#e6db74">&#39;\(&#39;</span>和<span style="color:#e6db74">&#39;\)&#39;</span>，则此表达式返回空字符串，否则返回为0。
</span></span><span style="display:flex;"><span>     只有第一个<span style="color:#e6db74">&#39;\(...\)&#39;</span>会引用返回的值；其余的<span style="color:#e6db74">&#39;\(...\)&#39;</span>只在正则表达式分组时有意义。
</span></span><span style="display:flex;"><span>     在正则表达式中，<span style="color:#e6db74">&#39;\+&#39;</span>，<span style="color:#e6db74">&#39;\?&#39;</span>和<span style="color:#e6db74">&#39;\|&#39;</span>分表代表匹配一个或多个，0个或1个以及两端任选其一的意思
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@allinone ~<span style="color:#f92672">]</span><span style="color:#75715e"># expr &#34;423-46-7&#34; : &#34;\([0-9]\{,3\}-[0-9]\{,3\}-[0-9]\{,3\}\)&#34;</span>
</span></span><span style="display:flex;"><span>423-46-7
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@allinone ~<span style="color:#f92672">]</span><span style="color:#75715e"># expr &#34;423-46-7&#34; : &#34;[0-9]\{,3\}-[0-9]\{,3\}-[0-9]\{,3\}&#34;    </span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span>
</span></span></code></pre></div><p><span id=mktemp><strong>mktemp</strong></span></p>
<p>创建临时的文件：<code>mktemp</code>
创建临时的命名文件: <code>mktemp -t test.XXXXXXXXXX</code>
创建一个临时目录 <code>mktemp -d</code>
创建一个临时命名目录 <code>mktemp -d test.XXXXXXXXXX</code></p>
<p><span id=install><strong>install</strong></span></p>
<p>是mkdir 、copy 、chown、chmod等命令的复合体</p>
<ul>
<li>创建目录，并授予权限。所有者nginx,所属组nginx 权限7777 类型为目录: <code>install -o nginx -g nginx -m 7777 -d /tmp/456</code></li>
<li>拷贝文件： <code>install -m 755 /etc/hosts /tmp</code></li>
</ul>
<p><span id=install><strong>base64</strong></span></p>
<p>base64加密: <code>echo &quot;123&quot;|base64</code>
base64解码 : <code>echo $(echo 123|base64)|base64 -d</code></p>
<p><span id=test><strong>test</strong></span></p>
<table>
  <thead>
      <tr>
          <th>参数</th>
          <th>代表意义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>-e</td>
          <td>该【文件名】是否存在（常用）</td>
      </tr>
      <tr>
          <td>-f</td>
          <td>该【文件名】是否存在且为文件（file）（常用）</td>
      </tr>
      <tr>
          <td>-d</td>
          <td>该【文件名】是否存在且为目录（directory）</td>
      </tr>
      <tr>
          <td>-b</td>
          <td>该【文件名】是否存在且为 block device 设备</td>
      </tr>
      <tr>
          <td>-c</td>
          <td>该【文件名】是否存在且为 character device 设备</td>
      </tr>
      <tr>
          <td>-S</td>
          <td>该【文件名】是否存在且为 socket 文件</td>
      </tr>
      <tr>
          <td>-p</td>
          <td>该【文件名】是否存在且为 FIFO (pipe) 文件</td>
      </tr>
      <tr>
          <td>-L</td>
          <td>该【文件名】是否存在且为一个链接文件</td>
      </tr>
      <tr>
          <td>-r</td>
          <td>检测该文件名是否存在且具有【可读】的权限</td>
      </tr>
      <tr>
          <td>-w</td>
          <td>检测该文件名是否存在且具有【可写】的权限</td>
      </tr>
      <tr>
          <td>-x</td>
          <td>检测该文件名是否存在且具有【可执行】的权限</td>
      </tr>
      <tr>
          <td>-u</td>
          <td>检测该文件名是否存在且具有【SUID】的属性</td>
      </tr>
      <tr>
          <td>-g</td>
          <td>检测该文件名是否存在且具有【SGID】的属性</td>
      </tr>
      <tr>
          <td>-k</td>
          <td>检测该文件名是否存在且具有【Sticky bit】的属性</td>
      </tr>
      <tr>
          <td>-s</td>
          <td>检测该文件名是否存在且为【非空文件】</td>
      </tr>
      <tr>
          <td>-nt</td>
          <td>两个文件之间的比较，如：test file1 -nt file2（newer than）判断 file1 是否比 file2 新</td>
      </tr>
      <tr>
          <td>-ot</td>
          <td>（older than）判断 file1 是否比 file2 旧</td>
      </tr>
      <tr>
          <td>-ef</td>
          <td>判断 file1 与 file2 是否为同一文件，可用在判断 hard link 的判定上。主要意义在判断两个文件是否均指向同一个 inode</td>
      </tr>
      <tr>
          <td>-eq</td>
          <td>两数值相等（equal）</td>
      </tr>
      <tr>
          <td>-ne</td>
          <td>两数值不等（not equal）</td>
      </tr>
      <tr>
          <td>-gt</td>
          <td>n1 大于 n2（greater than）</td>
      </tr>
      <tr>
          <td>-lt</td>
          <td>n1 小于 n2（less than）</td>
      </tr>
      <tr>
          <td>-ge</td>
          <td>n1 大于等于 n2（greater than or equal）</td>
      </tr>
      <tr>
          <td>-le</td>
          <td>n1 小于等于 n2（less than or equal）</td>
      </tr>
      <tr>
          <td>-z string</td>
          <td>判定字符串是否为 0？若 string 为空字符串，则为 true</td>
      </tr>
      <tr>
          <td>-n string</td>
          <td>判定字符串是否非空为 0？若 string 为非空字符串，则为 true</td>
      </tr>
      <tr>
          <td>str1 = str2</td>
          <td>判断 str1 是否等于 str2，若相等，则返回 true</td>
      </tr>
      <tr>
          <td>str1 != str2</td>
          <td>判断 str1 是否不等于 str2，若相等，则返回 false</td>
      </tr>
      <tr>
          <td>-a</td>
          <td>[and] 两条件同时成立，例如 test -f file -a -x file，则 file 同时具有 -f 与 x 权限时，返回 true</td>
      </tr>
  </tbody>
</table>
<p><span id=curl><strong>curl</strong></span></p>
<blockquote>
<p>curl 是向服务端发送和接收数据的工具。
<em>支持的协议(DICT, FILE, FTP, FTPS, GOPHER, HTTP, HTTPS, IMAP, IMAPS, LDAP,LDAPS, POP3, POP3S, RTMP, RTSP, SCP, SFTP, SMTP, SMTPS, TELNET and TFTP）</em></p>
</blockquote>
<hr>
<ul>
<li>
<p>查看服务端响应头信息: <code>curl -I https://www.baidu.com</code></p>
</li>
<li>
<p>获取响应码: <code> curl -o /dev/null -s -w &quot;%{http_code}&quot; https://www.baidu.com</code></p>
</li>
<li>
<p>携带证书访问: <code>curl -k --cacert /etc/kubernetes/pki/ca.crt  --cert /etc/kubernetes/pki/apiserver-kubelet-client.crt --key /etc/kubernetes/pki/apiserver-kubelet-client.key https://127.0.0.1:10250/metrics</code></p>
</li>
<li>
<p>指定请求头信息 <code>curl -k -H &quot;Authorization: Bearer $TOKEN&quot; https://&lt;KUBERNETES_API_SERVER&gt;/api/v1/nodes</code></p>
</li>
<li>
<p>指定请求方法, -g, &ndash;globoff允许url中存在 {} [] 等特殊字符 : <code>curl -g -X GET http://114.132.158.2:9100/metrics?collect[]=cpu</code></p>
</li>
<li>
<p>通过post发送数据: <code>curl -X POST -H 'content-type: application/json' -d '{&quot;password&quot;:&quot;123&quot;}'  http://172.16.100.10:8060/dingtalk/webhook1/send</code></p>
</li>
<li>
<p>文件下载: <code>curl -fSsL https://example.com/file.zip -o /local/path/file.zip</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-f, --fail  如果curl失败时不显示错误输出，主要用于书写脚本
</span></span><span style="display:flex;"><span>-s, --silent   静默
</span></span><span style="display:flex;"><span>-L, --location  如果站定已经搬迁，支持重定向
</span></span></code></pre></div></li>
</ul>
<p><span id=dig><strong>dig</strong></span></p>
<ul>
<li>查询A 记录: <code>dig @114.114.114.114 a baidu.com +short</code></li>
<li>查询RTP记录 <code>dig @114.114.114.114 -x 1.2.3.4.in-addr.arpa</code></li>
</ul>
<p><span id=mount><strong>mount</strong></span></p>
<ul>
<li>查看所有系统挂载: <code>mount</code></li>
<li>挂载定义在<code>/etc/fstab</code>中的所有文件系统: <code>mount -a</code></li>
<li>挂载定义在<code>/etc/fstab</code>中的指定文件系统 <code>mount -a -t ext4</code></li>
<li>指定挂载选项: <code>mount -o noatime,rw /dev/sdb /mnt</code></li>
</ul>
<p><strong>xargs</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>举例：
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@test /<span style="color:#f92672">]</span><span style="color:#75715e"># cat 1.txt </span>
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@test /<span style="color:#f92672">]</span><span style="color:#75715e"># cat 1.txt|xargs       对文本格式的重定向</span>
</span></span><span style="display:flex;"><span>a b c d e f a b c d e f a b c d e f a b c d e f
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@test /<span style="color:#f92672">]</span><span style="color:#75715e"># cat 1.txt|xargs -n6   每行6个重排</span>
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@test /<span style="color:#f92672">]</span><span style="color:#75715e"># cat 1.txt|xargs|sort &gt;2.txt      对文本格式重定向后默认排序输出到2.txt</span>
</span></span><span style="display:flex;"><span>a b c d e f a b c d e f a b c d e f a b c d e f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>举例：
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@test /<span style="color:#f92672">]</span><span style="color:#75715e"># cat 2.txt </span>
</span></span><span style="display:flex;"><span>a b ,c d e f a b ,c d e f a b ,c d e f a b ,c d e f
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@test /<span style="color:#f92672">]</span><span style="color:#75715e"># cat 2.txt|xargs -d&#34;,&#34; -n2  以，为分隔符每行两个域重排</span>
</span></span><span style="display:flex;"><span>a b  c d e f a b 
</span></span><span style="display:flex;"><span>c d e f a b  c d e f a b 
</span></span><span style="display:flex;"><span>c d e f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>find /tmp -name 1.log -type f -print0|xargs -0 rm -f   可用于处理文件中含有空格换行的文件
</span></span><span style="display:flex;"><span>find ./ -name <span style="color:#e6db74">&#34;*.log&#34;</span> -type f -print0|xargs -0 rm -f    用于日志的删除
</span></span><span style="display:flex;"><span>find -type f -name <span style="color:#e6db74">&#34;*.jpg&#34;</span> -print|xargs tar zcvf jpg.tar.gz  压缩所有图片文件
</span></span><span style="display:flex;"><span>cat url-list.txt|xargs wget -c  
</span></span></code></pre></div><p><span id=kill><strong>kill</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kill -l 查询所有信号量
</span></span><span style="display:flex;"><span>kill -s HUP <span style="color:#ae81ff">3940</span>
</span></span><span style="display:flex;"><span>kill -0 <span style="color:#ae81ff">3940</span>
</span></span><span style="display:flex;"><span>kill -15
</span></span></code></pre></div><p><span id=crontab><strong>crontab</strong></span></p>
<p><strong>crond</strong>是执行定时任务的后台程序，<code>systemctl status crond</code>命令确保服务正常运行。</p>
<p><code>/etc/crontab</code> 系统定时任务，默认为空</p>
<p><code> /etc/cron.d/</code> 包含系统定时任务</p>
<p><code>/var/spool/cron</code> 包含用户创建的定时任务，文件名以用户名命名</p>
<p><code>/var/log/cron</code> 包含定时任务执行的日志</p>
<p><strong>示例：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SHELL<span style="color:#f92672">=</span>/bin/bash
</span></span><span style="display:flex;"><span>PATH<span style="color:#f92672">=</span>/sbin:/bin:/usr/sbin:/usr/bin
</span></span><span style="display:flex;"><span>MAILTO<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*/5 * * * * echo <span style="color:#ae81ff">1</span> &gt;/dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>10/5 * * * * echo <span style="color:#ae81ff">1</span> &gt;/dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>*/5 23,24 * * * echo <span style="color:#ae81ff">1</span> &gt;/dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>*/5 20-24 * * * echo <span style="color:#ae81ff">1</span> &gt;/dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><span id=at><strong>at</strong></span></p>
<p><span id=tar><strong>tar</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> -v, --verbose 显示过程
</span></span><span style="display:flex;"><span> -f  --file    
</span></span><span style="display:flex;"><span> -c  --creat
</span></span><span style="display:flex;"><span> -z, --gzip   gzip压缩方式
</span></span><span style="display:flex;"><span> -j, --bzip2  bizp压缩方式
</span></span><span style="display:flex;"><span> -x  --extract  取出
</span></span><span style="display:flex;"><span> -C, --directory DIR 指定解压路径
</span></span><span style="display:flex;"><span> -t, --list 显示压缩文件列表
</span></span><span style="display:flex;"><span> --exclude<span style="color:#f92672">=</span>     压缩但不包含否个文件
</span></span><span style="display:flex;"><span> -X, --exclude-from FILE 用文件列表的方式排除不需要打包的文件
</span></span><span style="display:flex;"><span> -Z, --compress, --uncompress 调用compress完成压缩
</span></span><span style="display:flex;"><span> -N, --after-date DATE, --newer DATE 打包比指定日期新的文件，用于增量打包
</span></span><span style="display:flex;"><span> -p, --same-permissions, --preserve-permissions   保持属性
</span></span><span style="display:flex;"><span>              extract all protection information
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> -P, --absolute-names                             保存根目录的 /
</span></span><span style="display:flex;"><span>              don<span style="color:#e6db74">&#39;t strip leading &#39;</span>/<span style="color:#960050;background-color:#1e0010">&#39;</span>s from file names  
</span></span></code></pre></div><ul>
<li>
<p>打包时排除指定文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar --exclude <span style="color:#e6db74">&#39;conf/input.promtail&#39;</span>  --exclude <span style="color:#e6db74">&#39;conf/input.redis*&#39;</span> -czvf  seagullagent.tar.gz  conf seagullagent
</span></span></code></pre></div></li>
</ul>
<p><span id=fsdumpe2fs><strong>dumpe2fs</strong></span></p>
<blockquote>
<p>dump ext2/ext3/ext4 的文件系统信息,xfs 文件格式待整理</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 磁盘</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@tencent-sh ~<span style="color:#f92672">]</span><span style="color:#75715e"># dumpe2fs /dev/vda1 |grep -i &#34;inode size&#34;</span>
</span></span><span style="display:flex;"><span>dumpe2fs 1.42.9 <span style="color:#f92672">(</span>28-Dec-2013<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Inode size:               <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@tencent-sh ~<span style="color:#f92672">]</span><span style="color:#75715e"># dumpe2fs /dev/vda1 |grep -i &#34;block size&#34;</span>
</span></span><span style="display:flex;"><span>dumpe2fs 1.42.9 <span style="color:#f92672">(</span>28-Dec-2013<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Block size:               <span style="color:#ae81ff">4096</span>
</span></span></code></pre></div><p><span id=ln><strong>ln</strong></span></p>
<p>语法：<code>ln [OPTION]src dest</code></p>
<p>example</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln -svf /etc/hosts /tmp/hosts
</span></span></code></pre></div><p><span id=nl><strong>nl</strong></span></p>
<p>语法：<code>nl [OPTION] file</code></p>
<p>example</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 显示行号</span>
</span></span><span style="display:flex;"><span>nl /etc/hosts
</span></span></code></pre></div><p><span id=ntpdate><strong>ntpdate</strong></span>
在centos6 中我们经常使用的时间同步命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>timedatectl set-timezone Asia/Shanghai            
</span></span><span style="display:flex;"><span>date -s <span style="color:#e6db74">&#34;12/12/2010 15:40:30“
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hwclock -w 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">*/5 * * * * /usr/sbin/ntpdate 10.0.76.177 &gt;/dev/null 2&gt;&amp;1
</span></span></span></code></pre></div><p><span id=chronyd><strong>chronyd</strong></span></p>
<p><span id=cfssl><strong>cfssl</strong></span></p>
<p>下载地址</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># cfssl  生成证书</span>
</span></span><span style="display:flex;"><span>wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cfssl-json  证书格式化成文件</span>
</span></span><span style="display:flex;"><span>wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cfss-certinfo  查看证书的信息，发证机构，证书有效期</span>
</span></span><span style="display:flex;"><span>wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cfssl-certinfo -cert file
</span></span><span style="display:flex;"><span>cfssl-certinfo -domain domain_name
</span></span><span style="display:flex;"><span>cfssl-certinfo -domain pinduoduo.com
</span></span><span style="display:flex;"><span>cfssl certinfo -domain jd.com
</span></span><span style="display:flex;"><span>cfssl-certinfo -cert apiserver.pem 
</span></span><span style="display:flex;"><span>cfssl-certinfo -domain dashboard.od.com
</span></span></code></pre></div><p><span id=openssl><strong>openssl</strong></span></p>
<p><strong>SSL：</strong> Secure Socket Layer（安全套接层协议)</p>
<p><strong>TLS：</strong> Transport Layer Security（传输层安全协议）</p>
<p>加密算法</p>
<ol>
<li>RSA算法是一个广泛使用的公钥算法。其密钥包括公钥和私钥。它能用于数字签名、身份认证以及密钥交换。RSA密钥长度一般使用1024位或者更高。</li>
<li>DSA (Digital Signature Algorithm)算法是一种公钥算法.</li>
</ol>
<p>功能</p>
<ol>
<li>证书签发</li>
<li>文件加密</li>
<li>数字签名</li>
<li>生成随机数</li>
</ol>
<p><strong>证书签发</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#自签CA</span>
</span></span><span style="display:flex;"><span>openssl genrsa -out caKey.pem <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl req -new -key caKey.pem -out ca.csr -subj <span style="color:#e6db74">&#34;/C=CN/ST=Gd/L=SZ/O=od.com/CN=harbor.od.com&#34;</span>
</span></span><span style="display:flex;"><span>openssl x509 -req -in ca.csr -out ca-cert.pem -signkey caKey.pem -days <span style="color:#ae81ff">3650</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#签署应用key和crt</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1)用户生成自己的私钥；</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># genrsa Generation of DSA Private Key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gendsa Generation of DSA Private Key</span>
</span></span><span style="display:flex;"><span>openssl genrsa -out serverkey.pem <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2)构造证书申请文件</span>
</span></span><span style="display:flex;"><span>openssl req  -new -key serverkey.pem -out server.csr -subj <span style="color:#e6db74">&#34;/C=CN/ST=Gd/L=SZ/O=od.com/CN=harbor.od.com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># req X.509 Certificate Signing Request (CSR) Management.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -new   new request.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3)用户将证书申请文件提交给CA；CA验证签名，提取用户信息，并加上其他信息（比如颁发者等信息）</span>
</span></span><span style="display:flex;"><span>openssl x509 -req <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-in server.csr <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-out server-cert.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-signkey serverkey.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-CA ca-cert.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-CAkey caKey.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-CAcreateserial <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-days <span style="color:#ae81ff">3650</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># x509      X.509 Certificate Data Management.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -signkey arg    - self sign cert with arg</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -CAcreateserial - create serial number file if it does not exist</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -CA arg         - set the CA certificate, must be PEM format.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -CAkey arg      - set the CA key, must be PEM format</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                  missing, it is assumed to be in the CA file.</span>
</span></span></code></pre></div><p>另一种签发方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 跳过ca自签秘钥,如Nginx 中ssl</span>
</span></span><span style="display:flex;"><span>openssl genrsa -out server.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#-x509   output a x509 structure instead of a cert</span>
</span></span><span style="display:flex;"><span>openssl req -new -x509 -key server.key -out server.crt -subj /C<span style="color:#f92672">=</span>CN/ST<span style="color:#f92672">=</span>GD/L<span style="color:#f92672">=</span>SZ/O<span style="color:#f92672">=</span>devops/CN<span style="color:#f92672">=</span>wangendao.xyz -days <span style="color:#ae81ff">3650</span>
</span></span></code></pre></div><p><code>-subj</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>C：Country ，单位所在国家，为两位数的国家缩写，如： CN 就是中国
</span></span><span style="display:flex;"><span>ST：State/Province ，单位所在州或省
</span></span><span style="display:flex;"><span>L：Locality ，单位所在城市 / 或县区
</span></span><span style="display:flex;"><span>O：Organization ，网站的单位名称
</span></span><span style="display:flex;"><span>OU：Organization Unit，部门名称，也常常用于显示其他证书相关信息，如证书类型，证书产品名称或身份验证类型或验证内容等
</span></span><span style="display:flex;"><span>CN：Common Name ，网站的域名;
</span></span><span style="display:flex;"><span>EA：Email Address ，邮箱地址
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查看证书的信息</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -noout          - no certificate output</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -text           - print the certificate in text form</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>openssl x509 -noout -text -in server.crt
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查证书CN是否与域名匹配</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -checkhost host - check certificate matches &#34;host&#34;</span>
</span></span><span style="display:flex;"><span>openssl x509 -noout -checkhost seafile.example.com -in cert.pem  
</span></span><span style="display:flex;"><span>Hostname seafile.example.com does match certificate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  检查证书是否包含对应ip</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -checkip ipaddr - check certificate matches &#34;ipaddr&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@hdss7-21 certs<span style="color:#f92672">]</span><span style="color:#75715e"># openssl x509 -checkip 10.4.7.55 -in kubelet.pem </span>
</span></span><span style="display:flex;"><span>IP 10.4.7.55 does NOT match certificate
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  检查证书是否过期</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  -checkend arg   - check whether the cert expires in the next arg seconds</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                  exit 1 if so, 0 if not</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@hdss7-21 ssl<span style="color:#f92672">]</span><span style="color:#75715e"># openssl x509 -checkend 2592000 -in cert.pem          </span>
</span></span><span style="display:flex;"><span>Certificate will expire
</span></span></code></pre></div><p><strong>文件加密</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 生成私钥</span>
</span></span><span style="display:flex;"><span>openssl genrsa -out private.pem <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成公钥</span>
</span></span><span style="display:flex;"><span>openssl rsa -in private.pem -pubout -out public.pem
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建文件</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#ae81ff">12345678</span> &gt;a.txt
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加密文件</span>
</span></span><span style="display:flex;"><span>openssl rsautl -encrypt -in a.txt -inkey public.pem -pubin -out miwen.txt
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解密文件</span>
</span></span><span style="display:flex;"><span>openssl rsautl -decrypt -in miwen.txt -inkey private.pem -out b.txt
</span></span></code></pre></div><p>文件摘要（文件md5等验证是否被篡改）</p>
<pre tabindex="0"><code>openssl dgst -sign private.pem -md5 -out check a.txt
</code></pre><p><strong>生成随机数</strong></p>
<pre tabindex="0"><code>openssl rand -base64 10
openssl rand -hex 10
</code></pre><p><a href="https://www.cnblogs.com/technology178/p/14094375.html" target="_blank">https://www.cnblogs.com/technology178/p/14094375.html</a>
<a href="https://blog.csdn.net/qq_35014708/article/details/89351248" target="_blank">https://blog.csdn.net/qq_35014708/article/details/89351248</a>
<a href="https://github.com/ssllabs/research/wiki/SSL-and-TLS-Deployment-Best-Practices" target="_blank">https://github.com/ssllabs/research/wiki/SSL-and-TLS-Deployment-Best-Practices</a>
<a href="https://www.cnblogs.com/littleatp/p/5878763.html" target="_blank">https://www.cnblogs.com/littleatp/p/5878763.html</a></p>
<p><span id=dmidecode>查看主机型号：</span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@spa00x1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># dmidecode |grep &#39;Product Name&#39;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>Product Name: PowerEdge R720
</span></span><span style="display:flex;"><span>Product Name: 0X6FFV
</span></span></code></pre></div><p>查看主机序列号: <code>dmidecode |grep 'Serial Number'</code></p>
<p>查看操作系统：<code>cat /etc/redhat-release</code></p>
<p>查看cpu：<code>/proc/cpuinfo  </code></p>
<p>查看内存：<code>/proc/meminfo</code> <code>free -m</code></p>
<p>查看负载: <code>/proc/loadavg</code> <code>load</code> <code>uptime</code></p>
<p><span id=nc>nc</span>
<a href="https://www.jianshu.com/p/fa4eeac44e5c" target="_blank">网络命令nc</a></p>
<p><span id=folder><strong>centos中的目录</strong></span></p>
<table>
  <thead>
      <tr>
          <th>/etc/rsyslog</th>
          <th>日志配置文件</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>/var/spool/clientmqueue</td>
          <td>邮件队列</td>
      </tr>
      <tr>
          <td>/etc/motd</td>
          <td>添加登录时提示信息</td>
      </tr>
  </tbody>
</table>
<h3 id="打印ip的方法">打印ip的方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ifconfig eth0|awk -F <span style="color:#e6db74">&#34;[ :]+&#34;</span> <span style="color:#e6db74">&#39;NR==2{print $4}&#39;</span> 
</span></span><span style="display:flex;"><span>ifconfig eth0|awk -v FS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;[ :]+&#34;</span> <span style="color:#e6db74">&#39;NR==2{print $4}&#39;</span>
</span></span><span style="display:flex;"><span>ifconfig eth0|sed -n <span style="color:#e6db74">&#39;s/^.*addr:\(.*\)  Bcast.*$/\1/gp&#39;</span>
</span></span></code></pre></div><h3 id="awk-int">awk int()</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@seagullcore01-uat-s2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># echo &#34;1 0.1 2%&#34;|awk &#39;{print int($2)}&#39;  </span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div><h3 id="计算字符串长度">计算字符串长度</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>计算字符串长度的三种方法
</span></span><span style="display:flex;"><span>char<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>seq -s <span style="color:#e6db74">&#34;\t&#34;</span> 100<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">${#</span>char<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">${</span>char<span style="color:#e6db74">}</span>|wc -m
</span></span><span style="display:flex;"><span>echo <span style="color:#66d9ef">$(</span>expr length $char<span style="color:#66d9ef">)</span>  
</span></span></code></pre></div><h3 id="bash-魔法">bash 魔法</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#打印连续序列</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#f92672">{</span>0..10<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#打印偶数数列</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#f92672">{</span>0..10..2<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#打印组合数列</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#f92672">{</span>a..z<span style="color:#f92672">}{</span>a..z<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#f92672">{</span>0..10<span style="color:#f92672">}{</span>0..10..2<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#利用序列定义数组</span>
</span></span><span style="display:flex;"><span>letter_combos<span style="color:#f92672">=({</span>a..z<span style="color:#f92672">}{</span>a..z<span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">${</span>letter_combos[*]<span style="color:#e6db74">}</span> 
</span></span></code></pre></div><p>时间同步</p>
<ol>
<li>配置chrony</li>
<li>配置时区
ln -sf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone</li>
<li>手动时间同步</li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-b92cf9231f6f9197252551c27d29cc5f">postfix</h1>
	<div class="lead">centos7 配置 Postfix |linux</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-17" class="text-body-secondary">Tuesday, June 17, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<p>centos7 配置 Postfix</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y postfix mailx  install cyrus-sasl-plain cyrus-sasl-lib
</span></span></code></pre></div><ol>
<li>检查 /etc/postfix/main.cf 相关配置</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;&gt;/etc/postfix/main.cf<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relayhost = [smtp.qq.com]:587
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_sasl_auth_enable = yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_sasl_security_options = noanonymous
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_use_tls = yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_tls_CAfile = /etc/ssl/certs/ca-bundle.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">inet_protocols = ipv4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><ol start="2">
<li>检查 /etc/postfix/sasl_passwd 内容</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># [smtp.qq.com]:587 你的QQ邮箱@qq.com:授权码</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;[smtp.qq.com]:587 810654947@qq.com:kqaexaxpbrbdbajd&#34;</span> &gt;&gt;/etc/postfix/sasl_passwd
</span></span></code></pre></div><ol start="3">
<li>生成 hash 文件并设置权限</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo postmap /etc/postfix/sasl_passwd
</span></span><span style="display:flex;"><span>sudo chmod <span style="color:#ae81ff">600</span> /etc/postfix/sasl_passwd /etc/postfix/sasl_passwd.db
</span></span></code></pre></div><ol start="4">
<li>重启 Postfix</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl restart postfix
</span></span></code></pre></div><ol start="5">
<li>测试</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;good luck&#34;</span> | mail -s <span style="color:#e6db74">&#34;test&#34;</span> -r 810654947@qq.com 1209233066@qq.com
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-905550e769bb3ce68ebf7701485d4e9d">LVM (logical volume manager)</h1>
	<div class="lead">linux lvm</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-18" class="text-body-secondary">Sunday, May 18, 2025</time>
        
	</div>
	<p><strong>术语：</strong></p>
<p>&#x31;&#xfe0f;&#x20e3;<strong>物理卷PV</strong>(Physical Volume):  通过 <code>pvcreate</code> 创建的物理设备（如磁盘或分区），是LVM的基础存储单元。</p>
<p>&#x32;&#xfe0f;&#x20e3;<strong>物理块PE</strong>(Physical Extent) LVM管理的最小存储单元，默认大小为4MB</p>
<p>&#x33;&#xfe0f;&#x20e3;<strong>卷组VG</strong>(Volume Group) 由多个PV组合而成，构成逻辑存储池。</p>
<p>&#x34;&#xfe0f;&#x20e3;<strong>逻辑卷LV</strong>(Logical Volume) 从VG中划分的逻辑分区，可挂载使用。</p>
<p><img src="https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-8-Configuring_and_managing_logical_volumes-en-US/images/31bd96635c4120abe3e771a423f61cd6/basic-lvm-volume-components.png" alt=""></p>
<h3 id="环境准备">环境准备</h3>
<p><strong>创建pv</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@lvm:~# pvcreate /dev/sd<span style="color:#f92672">{</span>c..g<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#e6db74">&#34;/dev/sdc&#34;</span> successfully created.
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#e6db74">&#34;/dev/sdd&#34;</span> successfully created.
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#e6db74">&#34;/dev/sde&#34;</span> successfully created.
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#e6db74">&#34;/dev/sdf&#34;</span> successfully created.
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#e6db74">&#34;/dev/sdg&#34;</span> successfully created.
</span></span></code></pre></div><p><strong>创建vg</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@lvm:~# vgcreate data /dev/sd<span style="color:#f92672">{</span>c..f<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  Volume group <span style="color:#e6db74">&#34;data&#34;</span> successfully created
</span></span></code></pre></div><h3 id="逻辑卷类型">逻辑卷类型</h3>

  
  
  

  

  

<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>逻辑卷类型</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="线性卷" aria-controls="tabs-00-01" aria-selected="true">
        线性卷
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="条带化卷" aria-controls="tabs-00-02" aria-selected="false">
        条带化卷
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="raid卷" aria-controls="tabs-00-03" aria-selected="false">
        Raid卷
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-04" role="tab"
          data-td-tp-persist="精简卷" aria-controls="tabs-00-04" aria-selected="false">
        精简卷
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-nomarl --size 1g data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@pc:~# lvs --select lv_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test-nomarl&#34;</span> -o lv_name,vg_name,lv_size -o +seg_type
</span></span><span style="display:flex;"><span>  LV          VG   LSize Type  
</span></span><span style="display:flex;"><span>  test-nomarl data 1.00g linear
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <blockquote>
<p>&ndash;stripes 条带数量，不超过pv数量</p>
<p>&ndash;stripesize  条带大小，超过该值的大小保存到下一个pv上</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-stripes --stripes <span style="color:#ae81ff">4</span> --stripesize 64kb --size 1g  data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@lvm:~# lvs --select lv_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test-stripes&#34;</span> -o lv_name,vg_name,lv_size -o +seg_type
</span></span><span style="display:flex;"><span>  LV           VG   LSize Type   
</span></span><span style="display:flex;"><span>  test-stripes data 1.00g striped
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <blockquote>
<p>包括 RAID0、RAID1、RAID4、RAID5、RAID6 和 RAID10</p>
</blockquote>
<ul>
<li>RAID 4 的校验集中在一个磁盘，RAID 5 和 6 的校验分散在所有磁盘。</li>
<li>RAID 6 有两份独立的校验（如 P+Q 或 Reed-Solomon 编码），可承受双磁盘故障。</li>
</ul>
<table>
  <thead>
      <tr>
          <th>RAID级别</th>
          <th>校验方式</th>
          <th><strong>写入性能特点</strong></th>
          <th>容错能力</th>
          <th>最小磁盘数</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>RAID 4</td>
          <td><strong>专用校验盘</strong>（固定某个磁盘）</td>
          <td><strong>写入瓶颈</strong>：所有校验数据写入专用盘，高负载时易成为性能瓶颈。</td>
          <td>允许 <strong>1块磁盘故障</strong></td>
          <td>3块</td>
      </tr>
      <tr>
          <td>RAID 5</td>
          <td><strong>分布式校验</strong>（校验块轮流分布）</td>
          <td><strong>较高并发</strong>：校验分散，支持并行读写，但每次写操作需计算并更新校验块（读-改-写）。</td>
          <td>允许 <strong>1块磁盘故障</strong></td>
          <td>3块</td>
      </tr>
      <tr>
          <td>RAID 6</td>
          <td><strong>双重分布式校验</strong>（两套独立校验）</td>
          <td><strong>较低写入速度</strong>：相比 RAID 5，每次写入需计算两套校验，延迟更高（更高的 <em>写惩罚</em>）。</td>
          <td>允许 <strong>2块磁盘故障</strong></td>
          <td>4块</td>
      </tr>
  </tbody>
</table>
<ul>
<li>
<p>Raid0</p>
<blockquote>
<p>最少2块pv, 2个条带</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-raid0 --type raid0 --stripes <span style="color:#ae81ff">4</span> --stripesize 64k --size 1g data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@pc:~# lvs --select lv_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test-raid0&#34;</span> -o lv_name,vg_name -o +seg_type 
</span></span><span style="display:flex;"><span>  LV         VG   Type 
</span></span><span style="display:flex;"><span>  test-raid0 data raid0
</span></span></code></pre></div></li>
<li>
<p>raid4 ，raid5</p>
<blockquote>
<p>最少3块pv, 2个条带</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-raid4 --type raid4 --stripes <span style="color:#ae81ff">2</span> --stripesize 64k --size 1g data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@pc:~# lvs --select lv_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test-raid4&#34;</span> -o lv_name,vg_name -o +seg_type 
</span></span><span style="display:flex;"><span>  LV         VG   Type 
</span></span><span style="display:flex;"><span>  test-raid4 data raid4
</span></span></code></pre></div><p>raid5</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-raid5 --type raid5 --stripes <span style="color:#ae81ff">2</span> --stripesize 64k --size 100g data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@pc:~# lvs --select lv_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test-raid5&#34;</span> -o lv_name,vg_name -o +seg_type 
</span></span><span style="display:flex;"><span>  LV         VG   Type 
</span></span><span style="display:flex;"><span>  test-raid5 data raid5
</span></span></code></pre></div><p>raid6</p>
<blockquote>
<p>最少5块pv，3个条带</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-raid6 --type raid6 --stripes <span style="color:#ae81ff">3</span> --stripesize 64k --size 10g data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@pc:~# lvs --select lv_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test-raid6&#34;</span> -o lv_name,vg_name -o +seg_type 
</span></span><span style="display:flex;"><span>  LV         VG   Type 
</span></span><span style="display:flex;"><span>  test-raid6 data raid6
</span></span></code></pre></div></li>
<li>
<p>raid1</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># lvcreate --type raid1 --mirrors MirrorsNumber --size Size --name LogicalVolumeName VolumeGroupName</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name raid1 --type raid1 --mirrors <span style="color:#ae81ff">1</span> --size 1g data 
</span></span></code></pre></div></li>
<li>
<p>raid10</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># lvcreate --type raid10 --mirrors MirrorsNumber --stripes NumberOfStripes --stripesize StripeSize --size Size --name LogicalVolumeName VolumeGroupName</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name raid10 --type raid10 --mirrors <span style="color:#ae81ff">1</span> --stripes <span style="color:#ae81ff">2</span> --stripesize 64k --size 1g data 
</span></span></code></pre></div></li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-04" role="tabpanel" aria-labelled-by="tabs-00-04-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># lvcreate --type thin-pool --size PoolSize --name ThinPoolName VolumeGroupName</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name thinpool --type thin-pool --size 1g data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># lvcreate --type thin --virtualsize MaxVolumeSize --name ThinVolumeName --thinpool ThinPoolName VolumeGroupName</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-thin --type thin --virtualsize 100g --thinpool thinpool data
</span></span></code></pre></div>
    </div>
</div>

<h3 id="场景举例">场景举例</h3>
<p>场景：磁盘空间马上要满</p>
<p><strong>第一步：创建分区或增加一块硬盘</strong></p>
<p>vmware 扩展磁盘分区</p>
<p><strong>第二步：给刚才扩展的磁盘分配一个分区</strong></p>
<p>查看磁盘有多少未分区空间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># parted /dev/sda</span>
</span></span><span style="display:flex;"><span>GNU Parted 3.1
</span></span><span style="display:flex;"><span>使用 /dev/sda
</span></span><span style="display:flex;"><span>Welcome to GNU Parted! Type <span style="color:#e6db74">&#39;help&#39;</span> to view a list of commands.
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>parted<span style="color:#f92672">)</span> print free
</span></span><span style="display:flex;"><span>Model: VMware, VMware Virtual S <span style="color:#f92672">(</span>scsi<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Disk /dev/sda: 69.8GB
</span></span><span style="display:flex;"><span>Sector size <span style="color:#f92672">(</span>logical/physical<span style="color:#f92672">)</span>: 512B/512B
</span></span><span style="display:flex;"><span>Partition Table: msdos
</span></span><span style="display:flex;"><span>Disk Flags:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Number  Start   End     Size    Type     File system  标志
</span></span><span style="display:flex;"><span>        32.3kB  1049kB  1016kB           Free Space
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">1</span>      1049kB  1075MB  1074MB  primary  xfs          启动
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">2</span>      1075MB  21.5GB  20.4GB  primary               lvm
</span></span><span style="display:flex;"><span>        21.5GB  64.4GB  42.9GB           Free Space
</span></span></code></pre></div><p>创建分区</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># fdisk /dev/sda</span>
</span></span><span style="display:flex;"><span>Welcome to fdisk <span style="color:#f92672">(</span>util-linux 2.23.2<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Changes will remain in memory only, <span style="color:#66d9ef">until</span> you decide to write them.
</span></span><span style="display:flex;"><span>Be careful before using the write command.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Command <span style="color:#f92672">(</span>m <span style="color:#66d9ef">for</span> help<span style="color:#f92672">)</span>: n
</span></span><span style="display:flex;"><span>Partition type:
</span></span><span style="display:flex;"><span>   p   primary <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span> primary, <span style="color:#ae81ff">0</span> extended, <span style="color:#ae81ff">2</span> free<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>   e   extended
</span></span><span style="display:flex;"><span>Select <span style="color:#f92672">(</span>default p<span style="color:#f92672">)</span>: p
</span></span><span style="display:flex;"><span>Partition number <span style="color:#f92672">(</span>3,4, default 3<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>First sector <span style="color:#f92672">(</span>41943040-125829119, default 41943040<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>Using default value <span style="color:#ae81ff">41943040</span>
</span></span><span style="display:flex;"><span>Last sector, +sectors or +size<span style="color:#f92672">{</span>K,M,G<span style="color:#f92672">}</span> <span style="color:#f92672">(</span>41943040-125829119, default 125829119<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>Using default value <span style="color:#ae81ff">125829119</span>
</span></span><span style="display:flex;"><span>Partition <span style="color:#ae81ff">3</span> of type Linux and of size <span style="color:#ae81ff">40</span> GiB is set
</span></span><span style="display:flex;"><span>Command <span style="color:#f92672">(</span>m <span style="color:#66d9ef">for</span> help<span style="color:#f92672">)</span>: w
</span></span></code></pre></div><p>通知内核分区变动,否则需要重启操作系统</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># partprobe</span>
</span></span></code></pre></div><p><strong>第三步：把分区转换为pv</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># pvcreate /dev/sda3</span>
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#e6db74">&#34;/dev/sda3&#34;</span> successfully created.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># pvs</span>
</span></span><span style="display:flex;"><span>  PV         VG                                        Fmt  Attr PSize   PFree
</span></span><span style="display:flex;"><span>  /dev/sda2  centos                                    lvm2 a--  &lt;19.00g     <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  /dev/sda3                                            lvm2 ---   40.00g 40.00g
</span></span></code></pre></div><p><strong>第四步：扩展所在vg</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># vgextend centos /dev/sda3</span>
</span></span><span style="display:flex;"><span>  Volume group <span style="color:#e6db74">&#34;centos&#34;</span> successfully extended
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># vgs centos</span>
</span></span><span style="display:flex;"><span>  VG     <span style="color:#75715e">#PV #LV #SN Attr   VSize  VFree</span>
</span></span><span style="display:flex;"><span>  centos   <span style="color:#ae81ff">2</span>   <span style="color:#ae81ff">2</span>   <span style="color:#ae81ff">0</span> wz--n- 58.99g &lt;40.00g
</span></span></code></pre></div><p><strong>第四步：调整lv的空间大小</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># lvresize -L  +39g /dev/centos/root</span>
</span></span><span style="display:flex;"><span>  Size of logical volume centos/root changed from &lt;17.00 GiB <span style="color:#f92672">(</span><span style="color:#ae81ff">4351</span> extents<span style="color:#f92672">)</span> to &lt;56.00 GiB <span style="color:#f92672">(</span><span style="color:#ae81ff">14335</span> extents<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>  Logical volume centos/root successfully resized
</span></span></code></pre></div><p><strong>第五步：通知文件系统调整文件系统大小</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># xfs_growfs /dev/mapper/centos-root</span>
</span></span><span style="display:flex;"><span>meta-data<span style="color:#f92672">=</span>/dev/mapper/centos-root isize<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span>    agcount<span style="color:#f92672">=</span>4, agsize<span style="color:#f92672">=</span><span style="color:#ae81ff">1113856</span> blks
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">=</span>                       sectsz<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span>   attr<span style="color:#f92672">=</span>2, projid32bit<span style="color:#f92672">=</span>1
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">=</span>                       crc<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>        finobt<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> spinodes<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>data     <span style="color:#f92672">=</span>                       bsize<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>   blocks<span style="color:#f92672">=</span>4455424, imaxpct<span style="color:#f92672">=</span>25
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">=</span>                       sunit<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>      swidth<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> blks
</span></span><span style="display:flex;"><span>naming   <span style="color:#f92672">=</span>version <span style="color:#ae81ff">2</span>              bsize<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>   ascii-ci<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ftype<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>log      <span style="color:#f92672">=</span>internal               bsize<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>   blocks<span style="color:#f92672">=</span>2560, version<span style="color:#f92672">=</span>2
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">=</span>                       sectsz<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span>   sunit<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> blks, lazy-count<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>realtime <span style="color:#f92672">=</span>none                   extsz<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>   blocks<span style="color:#f92672">=</span>0, rtextents<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>data blocks changed from <span style="color:#ae81ff">4455424</span> to <span style="color:#ae81ff">14679040</span>
</span></span></code></pre></div><p><strong>完成</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># df -HT</span>
</span></span><span style="display:flex;"><span>文件系统                类型      容量  已用  可用 已用% 挂载点
</span></span><span style="display:flex;"><span>devtmpfs                devtmpfs  1.5G     <span style="color:#ae81ff">0</span>  1.5G    0% /dev
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     1.5G     <span style="color:#ae81ff">0</span>  1.5G    0% /dev/shm
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     1.5G   11M  1.5G    1% /run
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     1.5G     <span style="color:#ae81ff">0</span>  1.5G    0% /sys/fs/cgroup
</span></span><span style="display:flex;"><span>/dev/mapper/centos-root xfs        61G   15G   46G   25% /
</span></span><span style="display:flex;"><span>/dev/sda1               xfs       1.1G  224M  840M   22% /boot
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     1.5G   25k  1.5G    1% /var/lib/ceph/osd/ceph-1
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     1.5G   25k  1.5G    1% /var/lib/ceph/osd/ceph-0
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     1.5G   25k  1.5G    1% /var/lib/ceph/osd/ceph-2
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     297M   13k  297M    1% /run/user/42
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     297M     <span style="color:#ae81ff">0</span>  297M    0% /run/user/0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># lsblk -f /dev/sda</span>
</span></span><span style="display:flex;"><span>NAME            FSTYPE      LABEL UUID                                   MOUNTPOINT
</span></span><span style="display:flex;"><span>sda
</span></span><span style="display:flex;"><span>├─sda1          xfs               2698408f-1135-4c91-b11c-02892e5208f8   /boot
</span></span><span style="display:flex;"><span>├─sda2          LVM2_member       eZESEK-nJJ1-UvCV-x3st-lJKM-m3Zx-JZNvWO
</span></span><span style="display:flex;"><span>│ ├─centos-root xfs               e011e279-e5c9-4dfd-87e9-ecfc7e46bccd   /
</span></span><span style="display:flex;"><span>│ └─centos-swap swap              e14f66e7-6647-486f-a9d7-acc044d455a1
</span></span><span style="display:flex;"><span>└─sda3          LVM2_member       ugnjZw-FN0H-V8vi-acLb-D6sC-YB1f-CtZIF7
</span></span><span style="display:flex;"><span>  └─centos-root xfs               e011e279-e5c9-4dfd-87e9-ecfc7e46bccd   /
</span></span></code></pre></div><p>参考
<a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/8/html-single/configuring_and_managing_logical_volumes/index" target="_blank">红帽</a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-6ac20a0b99b404f8617a619f7cf7fc51">rsyslog</h1>
	<div class="lead">centos7 配置 rsyslog|linux</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-17" class="text-body-secondary">Wednesday, September 17, 2025</time>
        
	</div>
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install rsyslog 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@zabbix ~<span style="color:#f92672">]</span><span style="color:#75715e"># grep -Ev &#39;^$|^#&#39; /etc/rsyslog.conf </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#开启udp/tcp 514 接收日志</span>
</span></span><span style="display:flex;"><span>$ModLoad imudp
</span></span><span style="display:flex;"><span>$UDPServerRun <span style="color:#ae81ff">514</span>
</span></span><span style="display:flex;"><span>$ModLoad imtcp
</span></span><span style="display:flex;"><span>$InputTCPServerRun <span style="color:#ae81ff">514</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#默认的日志格式模板，无需定义</span>
</span></span><span style="display:flex;"><span>$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat
</span></span><span style="display:flex;"><span><span style="color:#75715e">#屏蔽本机的日志</span>
</span></span><span style="display:flex;"><span>:fromhost-ip,!isequal,<span style="color:#e6db74">&#34;127.0.0.1&#34;</span> ?RSYSLOG_TraditionalFileFormat
</span></span><span style="display:flex;"><span><span style="color:#75715e">#所有类型.所以级别				: :ommysql:主机,库名,用户名,密码</span>
</span></span><span style="display:flex;"><span>*.*                          @filebeat:端口
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#检查语法rsyslog.conf </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@Nagios ~<span style="color:#f92672">]</span><span style="color:#75715e"># rsyslogd -f /etc/rsyslog.conf -N1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@Nagios ~<span style="color:#f92672">]</span><span style="color:#75715e"># /etc/init.d/rsyslog restart</span>
</span></span></code></pre></div><p>客户端配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>H3C 配置
</span></span><span style="display:flex;"><span>sys
</span></span><span style="display:flex;"><span>info-center loghost 168.204.37.50
</span></span><span style="display:flex;"><span>linux配置
</span></span><span style="display:flex;"><span>*.* 	@168.204.37.50  <span style="color:#75715e"># udp</span>
</span></span><span style="display:flex;"><span>*.* 	@@168.204.37.50  <span style="color:#75715e">## tcp</span>
</span></span></code></pre></div><p>rsyslog.conf</p>
<p>rsyslog中的数据库支持是通过可加载的插件模块集成的。要使用数据库功能，必须在使用第一个数据库表操作之前在配置文件中启用数据库插件。这是通过放置</p>
<p>$ModLoad ommysql</p>
<p>接下来，我们需要告诉rsyslogd将数据写入数据库。由于使用默认架构，因此无需为此定义模板。我们可以使用硬编码的代码（rsyslogd处理正确的模板链接）。因此，对于MySQL，我们需要做的就是在/etc/rsyslog.conf中添加一个简单的选择器行：</p>
<p><em>.</em>    :ommysql:database-server,database-name,database-userid,database-password</p>
<p>例如，如果您仅对来自邮件子系统的消息感兴趣，则可以使用以下选择器行：</p>
<p>mail.*    :ommysql:127.0.0.1,syslog,syslogwriter,topsecret</p>
<p>如果您要转发多个服务器，则可以很快完成。Rsyslog对操作的数量或类型没有限制，因此您可以定义任意多个目标。然而，重要的是要知道，全套指令构成了一个动作。因此，您不能简单地添加（仅）第二条转发规则，而还需要复制规则配置。请注意，对于第二个操作，请使用不同的队列文件名，否则将使系统混乱。</p>
<p>转发到两个主机的示例如下所示：</p>
<p>$ ModLoad imuxsock ＃本地消息接收</p>
<p>$ WorkDirectory / rsyslog / work ＃工作（假脱机）文件的默认位置</p>
<h2 id="记录系统日志消息的优先级"><em><strong>*记录系统日志消息的优先级*</strong></em><a href="#recording-the-priority-of-syslog-messages"><em><strong>*¶*</strong></em></a></h2>
<p>＃开始转发规则1</p>
<p>$ ActionQueueType LinkedList ＃使用异步处理</p>
<p>$ ActionQueueFileName srvrfwd1 ＃设置文件名，还启用磁盘模式</p>
<p>$ ActionResumeRetryCount -1 ＃插入失败时无限重试</p>
<p>$ ActionQueueSaveOnShutdown on ＃如果rsyslog关闭，则保存内存数据</p>
<p><em>.</em> @@ server1：端口</p>
<p>＃结束转发规则1</p>
<p>＃开始转发规则2</p>
<p>$ ActionQueueType LinkedList ＃使用异步处理</p>
<p>$ ActionQueueFileName srvrfwd2 ＃设置文件名，还启用磁盘模式</p>
<p>$ ActionResumeRetryCount -1 ＃插入失败时无限重试</p>
<p>$ ActionQueueSaveOnShutdown on ＃如果rsyslog关闭，则保存内存数据</p>
<p><em>.</em> @@ server2</p>
<p>＃结束转发规则2</p>
<p>配置日志模板：</p>
<pre tabindex="0"><code> $template 模板名称,&#34;%timegenerated% %HOSTNAME% %syslogtag%%msg%0
 $template RemoteLogs,&#34;/tmp/rsyslog/%$YEAR%-%$MONTH%/%fromhost-ip%/%fromhost-ip%_%$YEAR%-%$MONTH%-%$DAY%.log&#34;
 
</code></pre>
</div>





    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5e1eecb0ef0b07d2fc44652e2fc03e66">5.6 - nginx</h1>
    
	<p><em>简介</em></p>
<p>Nginx (engine x <a href="http://nginx.org" target="_blank">http://nginx.org</a>)是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP服务器。Nginx是由伊戈尔·赛索耶夫开发的，第一个公开版本0.1.0发布于2004年10月4日。其特点是占用内存少，并发能力强。</p>
<p><em>应用场景</em></p>
<table>
  <thead>
      <tr>
          <th>应用场景</th>
          <th>竞争产品</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>静态服务器（图片、视频服务器</td>
          <td>lighttpd</td>
      </tr>
      <tr>
          <td>动态服务</td>
          <td>nignx +fastcgi</td>
      </tr>
      <tr>
          <td>反向代理 负载均衡</td>
          <td>haproxy</td>
      </tr>
      <tr>
          <td>cache(web缓存)</td>
          <td>vanish</td>
      </tr>
  </tbody>
</table>
<h3 id="安装nginx">安装nginx</h3>
<h3 id="配置详解">配置详解</h3>
<ol>
<li>全局配置</li>
<li>http服务</li>
<li>location</li>
<li>upsteam</li>
<li>rewrite</li>
<li>log</li>
</ol>
<h3 id="模块">模块</h3>
<h4 id="ngx_http_autoindex_module">ngx_http_autoindex_module</h4>
<p>生成目录列表所用
<a href="https://nginx.org/en/docs/http/ngx_http_autoindex_module.html" target="_blank">https://nginx.org/en/docs/http/ngx_http_autoindex_module.html</a></p>
<p><code>http、 server、 location</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">autoindex</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">autoindex_exact_size</span> <span style="color:#66d9ef">on</span>; <span style="color:#75715e"># 精确输出文件大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">autoindex_format</span> <span style="color:#e6db74">html</span>;   <span style="color:#75715e"># 展示格式 html/xml/json/jsonp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">autoindex_localtime</span> <span style="color:#66d9ef">on</span>; <span style="color:#75715e"># 时间展示
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h4 id="ngx_"><a href="https://nginx.org/en/docs/http/ngx_http_stub_status_module.html" target="_blank">ngx_http_stub_status_module</a></h4>
<p><strong>stub_status</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">stub_status</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">syntax:</span> <span style="color:#e6db74">stub_status</span> <span style="color:#66d9ef">on</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">default:</span> <span style="color:#e6db74">None</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">context:</span> <span style="color:#e6db74">location</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">Enables</span> <span style="color:#e6db74">the</span> <span style="color:#e6db74">status</span> <span style="color:#e6db74">handler</span> <span style="color:#e6db74">in</span> <span style="color:#e6db74">this</span> <span style="color:#e6db74">location.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">/nginx_status</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stub_status</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">access_log</span>   <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">allow</span> <span style="color:#e6db74">SOME.IP.ADD.RESS</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">active</span> <span style="color:#e6db74">connections</span> <span style="color:#e6db74">--</span> <span style="color:#e6db74">number</span> <span style="color:#e6db74">of</span> <span style="color:#e6db74">all</span> <span style="color:#e6db74">open</span> <span style="color:#e6db74">connections</span> <span style="color:#e6db74">including</span> <span style="color:#e6db74">connections</span> <span style="color:#e6db74">to</span> <span style="color:#e6db74">backends</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">server</span> <span style="color:#e6db74">accepts</span> <span style="color:#e6db74">handled</span> <span style="color:#e6db74">requests</span> <span style="color:#e6db74">--</span> <span style="color:#e6db74">nginx</span> <span style="color:#e6db74">accepted</span> <span style="color:#ae81ff">16630948</span> <span style="color:#e6db74">connections,</span> <span style="color:#e6db74">handled</span> <span style="color:#ae81ff">16630948</span> <span style="color:#e6db74">connections</span> <span style="color:#e6db74">(no</span> <span style="color:#66d9ef">on</span><span style="color:#e6db74">e</span> <span style="color:#e6db74">was</span> <span style="color:#e6db74">closed</span> <span style="color:#e6db74">just</span> <span style="color:#e6db74">it</span> <span style="color:#e6db74">was</span> <span style="color:#e6db74">accepted),</span> <span style="color:#e6db74">and</span> <span style="color:#e6db74">handles</span> <span style="color:#ae81ff">31070465</span> <span style="color:#e6db74">requests</span> <span style="color:#e6db74">(1.8</span> <span style="color:#e6db74">requests</span> <span style="color:#e6db74">per</span> <span style="color:#e6db74">connection)</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">reading</span> <span style="color:#e6db74">--</span> <span style="color:#e6db74">nginx</span> <span style="color:#e6db74">reads</span> <span style="color:#e6db74">request</span> <span style="color:#e6db74">header</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">writing</span> <span style="color:#e6db74">--</span> <span style="color:#e6db74">nginx</span> <span style="color:#e6db74">reads</span> <span style="color:#e6db74">request</span> <span style="color:#e6db74">body,</span> <span style="color:#e6db74">processes</span> <span style="color:#e6db74">request,</span> <span style="color:#e6db74">or</span> <span style="color:#e6db74">writes</span> <span style="color:#e6db74">response</span> <span style="color:#e6db74">to</span> <span style="color:#e6db74">a</span> <span style="color:#e6db74">client</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">waiting</span> <span style="color:#e6db74">--</span> <span style="color:#e6db74">keep-alive</span> <span style="color:#e6db74">connections,</span> <span style="color:#e6db74">actually</span> <span style="color:#e6db74">it</span> <span style="color:#e6db74">is</span> <span style="color:#e6db74">active</span> <span style="color:#e6db74">-</span> <span style="color:#e6db74">(reading</span> <span style="color:#e6db74">+</span> <span style="color:#e6db74">writing)</span>
</span></span></code></pre></div><h4 id="gx_"><a href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html" target="_blank">gx_http_rewrite_module</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-84a82bd7aae117864d19f5961c931ac6">安装nginx</h1>
	<div class="lead">install|nginx</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-22" class="text-body-secondary">Thursday, May 22, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h3 id="安装部署">安装部署</h3>
<p>第一步：安装依赖


  
  
<ul class="nav nav-tabs justify-content-end" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="centos" aria-controls="tabs-00-00" aria-selected="true">
        centos
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="ubuntu" aria-controls="tabs-00-01" aria-selected="false">
        ubuntu
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#GCC (gun compiler collection)c语言编译器</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#gcc-c++ c++语言编译器</span>
</span></span><span style="display:flex;"><span>yum install gcc gcc-c++ -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># rewrite模块需要  pcre (perl compatible regular expression  per 兼容正则表达式) </span>
</span></span><span style="display:flex;"><span>yum install pcre pcre-devel -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># zlib 配置中gizp on 使用</span>
</span></span><span style="display:flex;"><span>yum install zlib zlib-devel -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># openssl 提供https 和md5 sha1等</span>
</span></span><span style="display:flex;"><span>yum install openssl openssl-devel -y
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 更新软件包列表</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装GCC和G++编译器</span>
</span></span><span style="display:flex;"><span>sudo apt-get install gcc g++ -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装PCRE库</span>
</span></span><span style="display:flex;"><span>sudo apt-get install libpcre3 libpcre3-dev -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装zlib库</span>
</span></span><span style="display:flex;"><span>sudo apt-get install zlib1g zlib1g-dev -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装OpenSSL库</span>
</span></span><span style="display:flex;"><span>sudo apt-get install openssl libssl-dev -y
</span></span></code></pre></div>
    </div>
</div>
</p>
<p>第二步下载源码并修改源代码（非必须）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget http://nginx.org/download/nginx-1.22.1.tar.gz
</span></span><span style="display:flex;"><span>tar xf nginx-1.22.1.tar.gz <span style="color:#f92672">&amp;&amp;</span> cd nginx-1.22.1
</span></span></code></pre></div><p><strong>隐藏nginx标识和版本信息</strong>:</p>
<blockquote>
<p>修改源码位置：src/http/ngx_http_header_filter_module.c</p>
</blockquote>



  
  
<ul class="nav nav-tabs justify-content-end" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="源码" aria-controls="tabs-01-00" aria-selected="true">
        源码
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="修改后" aria-controls="tabs-01-01" aria-selected="false">
        修改后
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_server_string[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Server: nginx&#34;</span> CRLF;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_server_full_string[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Server: &#34;</span> NGINX_VER CRLF;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_server_build_string[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Server: &#34;</span> NGINX_VER_BUILD CRLF;
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_server_string[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Server: IIS&#34;</span> CRLF;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_server_full_string[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Server: IIS&#34;</span> CRLF;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_server_build_string[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Server: IIS&#34;</span> CRLF;
</span></span></code></pre></div>
    </div>
</div>

<blockquote>
<p>修改源码位置：src/http/ngx_http_special_response.c</p>
</blockquote>


  
  

<ul class="nav nav-tabs justify-content-end" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          data-td-tp-persist="源码" aria-controls="tabs-02-00" aria-selected="true">
        源码
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="修改后" aria-controls="tabs-02-01" aria-selected="false">
        修改后
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_error_full_tail[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;hr&gt;&lt;center&gt;&#34;</span> NGINX_VER <span style="color:#e6db74">&#34;&lt;/center&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/body&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/html&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_error_build_tail[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;hr&gt;&lt;center&gt;&#34;</span> NGINX_VER_BUILD <span style="color:#e6db74">&#34;&lt;/center&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/body&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/html&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_error_tail[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/body&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/html&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span>;
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_error_full_tail[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;hr&gt;&lt;center&gt; IIS &lt;/center&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/body&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/html&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_error_build_tail[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;hr&gt;&lt;center&gt; IIS &lt;/center&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/body&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/html&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_error_tail[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;hr&gt;&lt;center&gt;IIS&lt;/center&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/body&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/html&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span>;
</span></span></code></pre></div>
    </div>
</div>

<p>第三步执行编译</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>useradd nginx -M -s /bin/nologin
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./configure <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--prefix<span style="color:#f92672">=</span>/opt/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--group<span style="color:#f92672">=</span>nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_flv_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_mp4_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_stub_status_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_gzip_static_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-pcre <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-debug
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make <span style="color:#f92672">&amp;&amp;</span> make install
</span></span><span style="display:flex;"><span><span style="color:#75715e">#查看编译信息</span>
</span></span><span style="display:flex;"><span>/opt/nginx/sbin/nginx -V
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 启动服务</span>
</span></span><span style="display:flex;"><span>/opt/nginx/sbin/nginx
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nginx-1.22.1<span style="color:#f92672">]</span><span style="color:#75715e"># curl -I 127.0.0.1</span>
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#ae81ff">200</span> OK
</span></span><span style="display:flex;"><span>Server: IIS
</span></span><span style="display:flex;"><span>Date: Thu, <span style="color:#ae81ff">22</span> May <span style="color:#ae81ff">2025</span> 07:39:59 GMT
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#ae81ff">615</span>
</span></span><span style="display:flex;"><span>Last-Modified: Thu, <span style="color:#ae81ff">22</span> May <span style="color:#ae81ff">2025</span> 07:39:16 GMT
</span></span><span style="display:flex;"><span>Connection: keep-alive
</span></span><span style="display:flex;"><span>ETag: <span style="color:#e6db74">&#34;682ed4a4-267&#34;</span>
</span></span><span style="display:flex;"><span>Accept-Ranges: bytes
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-2fb0f235e6fc12a93aed4b8df6d5a972">配置nginx</h1>
	<div class="lead">nginx.conf|nginx</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-23" class="text-body-secondary">Friday, May 23, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<hr>
<p>nginx 进程关系： nginx 由master和worker进程组成，master进程负责管理work进程，worker进程负责处理具体的任务.</p>
<p>配置文件结构：</p>
<pre class="mermaid">graph LR
    A[nginx.conf]
    B[global]
    C[http]
    C1[upstream]
    C2[server]
    C21[location]
    C211[if]
    D[stream]
    D1[upstream]
    D2[server]
    A -.-&gt;|worker进程配置| B
    A -.-&gt;|http服务配置| C
    C -.-&gt; C1
    C -.-&gt; C2
    C2 -.-&gt; C21
    C21 -.-&gt; C211
    D -.-&gt; D1
    D -.-&gt; D2
    A -.- |4层反向代理|D
    subgraph 反向代理和http服务  
    C1
    C2
    end 

    subgraph 7层服务配置
    C
    end 
    subgraph 4层反向代理
    D1
    D2
    end 
    subgraph 4层服务配置
    D
    end 

    subgraph 全局配置
    B
    end
    
    subgraph 主配置文件
    A
    end</pre>
<h3 id="配置模板">配置模板</h3>

<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 进程模式启动
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">daemon</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># master worker 模式运行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">master_process</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 错误日志设置 日志路径   日志记录级别（debug info notice warn error crit alert emerg）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">error_log</span> <span style="color:#e6db74">logs/error.log</span> <span style="color:#e6db74">error</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">user</span>  <span style="color:#e6db74">nginx</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">worker_cpu_affinity</span> <span style="color:#ae81ff">0001</span> <span style="color:#ae81ff">0010</span> <span style="color:#ae81ff">0100</span> <span style="color:#ae81ff">1000</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#worker_processes 8;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#worker_cpu_affinity 0001 0010 0100 1000 0001 0010 0100 1000;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 批量建立连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">multi_accept</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 对指定客户端执行debug,需要在编译时 --with-debug,否则不生效
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">debug_connection</span> 127.0.0.1;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug_connection</span> 192.168.0.0<span style="color:#e6db74">/24</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 使用epoll i/o模型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">use</span> <span style="color:#e6db74">epoll</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 单个进程最大连接数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">worker_connections</span> <span style="color:#ae81ff">15000</span>;  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指定work进程打开的最大文件数，可设置为系统ulimit -HSn的结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">worker_rlimit_nofile</span> <span style="color:#ae81ff">65535</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4层代理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">stream</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">log_format</span> <span style="color:#e6db74">main</span> <span style="color:#e6db74">&#39;</span>$remote_addr <span style="color:#e6db74">[</span>$time_local] <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;</span>$protocol $status $bytes_sent $bytes_received <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;</span>$session_time <span style="color:#e6db74">&#34;</span>$upstream_addr&#34; <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;&#34;</span>$upstream_bytes_sent&#34; <span style="color:#e6db74">&#34;</span>$upstream_bytes_received&#34; <span style="color:#e6db74">&#34;</span>$upstream_connect_time&#34;&#39;;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">upstream</span> <span style="color:#e6db74">mysql</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server</span> 172.16.100.10:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server</span> 172.16.100.11:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server</span> 172.16.100.12:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">listen</span> <span style="color:#ae81ff">3306</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#e6db74">2s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_timeout</span> <span style="color:#e6db74">900s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">mysql</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">access_log</span>  <span style="color:#e6db74">/dev/stdout</span> <span style="color:#e6db74">main</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>       <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>  <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_tokens</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 指定字符集
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">charset</span> <span style="color:#e6db74">utf-8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#sendfile参数控制文件高效传输模式，同时将tcp_nopush和tcp_nodelay设置为on防止网络阻塞
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">sendfile</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tcp_nopush</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#在keepalive开启才有效
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">tcp_nodelay</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#设置客户端保持会话的时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">keepalive_timeout</span> <span style="color:#ae81ff">60</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#设置客户端请求头读取超时时间，如果超过这个时间，客户端还没有发送任何数据，nginx将返回&#34;request time out(408)&#34;错误
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">client_header_timeout</span> <span style="color:#ae81ff">15</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#设置客户端请求主体读取超时时间，如果超过这个时间，客户端还没有发送任何数据，nginx将返回&#34;request time out(408)&#34;错误，默认时长60
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">send_timeout</span> <span style="color:#ae81ff">60</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">################################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#开启压缩
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#压缩对象的最小大小（小于1k不压缩）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_min_length</span> <span style="color:#ae81ff">1k</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#压缩缓冲区，申请4个单位为16k的内存空间作为缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_buffers</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">16k</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#压缩版本(默认1.1，前端为squid2.5时使用1.0)用于设置识别http协议版本，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#压缩比例 1压缩比最小 9压缩比最大
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_comp_level</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#指定压缩的类型，&#34;text/html&#34;类型总是被压缩.类型cat mime.types
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_types</span> <span style="color:#e6db74">text/plain</span> <span style="color:#e6db74">application/x-javascript</span> <span style="color:#e6db74">text/css</span> <span style="color:#e6db74">application/xml</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#告诉前端缓存服务器不要解压，到客户端时才解压.发送vary:Accept_Enconding 响应头字段，从而通知接收方我做了gzip 压缩
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#e6db74">gzip_vary</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># nginx做反向代理时，按照后端web服务器的压缩策略设置gzip 参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_proxied</span> <span style="color:#e6db74">any</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 关闭对ie6 的压缩
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_disable</span> <span style="color:#e6db74">&#34;msie6&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_names_hash_max_size</span>  <span style="color:#ae81ff">1024</span>;  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_names_hash_bucket_size</span>   <span style="color:#ae81ff">512</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 七层代理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">upstream</span> <span style="color:#e6db74">backend</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># backup 当其他主机失败后使用该主机，不能用在 hash ip_hash 和random 调度算法中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e"># down 当前主机不可用，当使用ip_hash 中标记为down不会影响hash值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">server</span> 172.16.100.10:<span style="color:#ae81ff">8080</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> 172.16.100.11:<span style="color:#ae81ff">8080</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> 172.16.100.12:<span style="color:#ae81ff">8080</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> 172.16.100.13:<span style="color:#ae81ff">8080</span>   <span style="color:#e6db74">backup</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> 172.16.100.14:<span style="color:#ae81ff">8080</span>   <span style="color:#e6db74">backup</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 设置X-Real-IP头，让服务端看到客户端的真实IP地址。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">proxy_set_header</span>  <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 设置X-Forwarded-For头，添加原始请求的IP地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">proxy_set_header</span>  <span style="color:#e6db74">X-Forwarded-For</span> $remote_addr;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 设置代理请求的Host头，使用请求的原始主机名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 设置客户端请求的最大body大小为50MB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">client_max_body_size</span> <span style="color:#ae81ff">50m</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 设置客户端请求body的缓冲区大小为256KB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">client_body_buffer_size</span> <span style="color:#ae81ff">256k</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/backend</span> {
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">localhost</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></details>

<h3 id="参数解释">参数解释</h3>
<p><strong>cup亲和力绑定</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>global</code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">worker_cpu_affinity</span> <span style="color:#ae81ff">0001</span> <span style="color:#ae81ff">0010</span> <span style="color:#ae81ff">0100</span> <span style="color:#ae81ff">1000</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#worker_processes 8;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#worker_cpu_affinity 0001 0010 0100 1000 0001 0010 0100 1000;
</span></span></span></code></pre></div><p><strong>事件模型优化</strong></p>


<div class="alert alert-primary" role="alert">


    <p>位置：全局 <code>global</code> 中<code>events</code>指令下</p>
<p>推荐：
在linux中使用<code>epoll</code>模型；
在freebsd中使用<code>kqueue</code>模型；
在solaris中使用<code>/dev/poll</code>的模式；
在windows中使用<code>icop</code>模型</p>


</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">use</span> <span style="color:#e6db74">epoll</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#单个进程最大连接数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">2048</span>;  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>单个worker可以打开的最大文件描述符</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>global</code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e">#指定work进程打开的最大文件数，可设置为系统ulimit -HSn的结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">worker_rlimit_nofile</span> <span style="color:#ae81ff">65535</span>;
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-d0f39a2ca728b30b9d3532605c8e36a3">http服务器</h1>
	<div class="lead">http服务器|nginx</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-22" class="text-body-secondary">Thursday, May 22, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<p>nginx 是一个高性能的HTTP和反向代理服务器，本章主要介绍nginx的http服务器配置。</p>
<h3 id="基于ip的多虚拟机">基于ip的多虚拟机</h3>

<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>       <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>  <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sendfile</span>        <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keepalive_timeout</span>  <span style="color:#ae81ff">65</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务一
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       192.168.0.106:<span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">localhost</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务二
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       192.168.0.236:<span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">localhost</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }    
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></details>

<h3 id="基于端口的多虚拟机">基于端口的多虚拟机</h3>

<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>       <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>  <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sendfile</span>        <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keepalive_timeout</span>  <span style="color:#ae81ff">65</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务一
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">localhost</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务二
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">81</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">localhost</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }    
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></details>

<h3 id="基于域名的多虚拟机">基于域名的多虚拟机</h3>

<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>       <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>  <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sendfile</span>        <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keepalive_timeout</span>  <span style="color:#ae81ff">65</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务一
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">docs.zero-dew.com</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务二
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">blog.zero-dew.com</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }    
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></details>

<h3 id="基于用户名密码的简单认证">基于用户名密码的简单认证</h3>

<details>
  <summary>Details</summary>
  <p>生成用户名和密码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo user01:<span style="color:#e6db74">`</span>openssl passwd 456<span style="color:#e6db74">`</span> &gt;&gt;/opt/nginx/passwd
</span></span><span style="display:flex;"><span>echo user02:<span style="color:#e6db74">`</span>openssl passwd 456<span style="color:#e6db74">`</span> &gt;&gt;/opt/nginx/passwd
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>       <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>  <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sendfile</span>        <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keepalive_timeout</span>  <span style="color:#ae81ff">65</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">localhost</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">####
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">auth_basic</span> <span style="color:#e6db74">&#34;Restricted</span> <span style="color:#e6db74">Content&#34;</span>;  
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">auth_basic_user_file</span> <span style="color:#e6db74">passwd</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">####
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></details>

<h3 id="基于ssl的https服务">基于SSL的HTTPS服务</h3>

<details>
  <summary>Details</summary>
  <p>生成证书</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /opt/nginx/conf/ssl
</span></span><span style="display:flex;"><span>cd /opt/nginx/conf/ssl
</span></span><span style="display:flex;"><span>openssl genrsa -out server.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl req -new -key server.key -out server.csr -subj <span style="color:#e6db74">&#34;/C=CN/ST=GD/L=SZ/O=zero-dew.com/CN=docs.zero-dew.com&#34;</span>
</span></span><span style="display:flex;"><span>openssl x509 -req -in server.csr -out server.crt -signkey server.key -days <span style="color:#ae81ff">3650</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>       <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>  <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sendfile</span>        <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keepalive_timeout</span>  <span style="color:#ae81ff">65</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span> <span style="color:#e6db74">docs.zero-dew.com</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 所有80端口的请求都重定向到443端口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">return</span> <span style="color:#ae81ff">301</span> <span style="color:#e6db74">https://</span>$host$request_uri;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span> <span style="color:#e6db74">docs.zero-dew.com</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 指定SSL证书和私钥的位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">ssl_certificate</span> <span style="color:#e6db74">ssl/server.crt</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ssl_certificate_key</span> <span style="color:#e6db74">ssl/server.key</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># SSL会话超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">ssl_session_timeout</span> <span style="color:#ae81ff">10m</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 指定SSL密码套件，使用安全的加密套件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">ssl_ciphers</span> <span style="color:#e6db74">ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 指定支持的TLS协议版本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">ssl_protocols</span> <span style="color:#e6db74">TLSv1</span> <span style="color:#e6db74">TLSv1.1</span> <span style="color:#e6db74">TLSv1.2</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 优先使用服务器指定的密码套件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">ssl_prefer_server_ciphers</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 配置HTTPS下的访问规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></details>

<h3 id="配置指令解释">配置指令解释</h3>
<p><strong>隐藏版本号</strong>


<div class="alert alert-primary" role="alert">


    位置： <code>http</code> 指令下

</div>
</p>
<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server_tokens</span> <span style="color:#66d9ef">off</span>;
</span></span></code></pre></div><p><strong>开启高效文件传输模式</strong>


<div class="alert alert-primary" role="alert">


    <p>Nginx的sendfile指令用于控制文件传输的高效模式，同时将tcp_nopush和tcp_nodelay设置为on防止网络阻塞。</p>
<p>位置：<code>http</code> 、<code>server</code> 或 <code>location</code> 指令下</p>


</div>
</p>
<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">sendfile</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">tcp_nopush</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">tcp_nodelay</span> <span style="color:#66d9ef">on</span>;  <span style="color:#75715e">#在keepalive开启才有效
</span></span></span></code></pre></div><p><strong>设置连接超时时间</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>http</code> 、<code>server</code>  指令下

</div>
</p>
<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e">#设置客户端保持会话的时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">keepalive_timeout</span> <span style="color:#ae81ff">60</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#设置客户端请求头读取超时时间，如果超过这个时间，客户端还没有发送任何数据，nginx将返回&#34;request time out(408)&#34;错误
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">client_header_timeout</span> <span style="color:#ae81ff">15</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#设置客户端请求主体读取超时时间，如果超过这个时间，客户端还没有发送任何数据，nginx将返回&#34;request time out(408)&#34;错误，默认时长60
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">send_timeout</span> <span style="color:#ae81ff">60</span>;
</span></span></code></pre></div><p><strong>nginx  gzip压缩功能</strong></p>


<div class="alert alert-primary" role="alert">


    位置：<code>http</code> 、<code>server</code>  指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e">#开启压缩
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#压缩对象的最小大小（小于1k不压缩）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_min_length</span> <span style="color:#ae81ff">1k</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#压缩缓冲区，申请4个单位为16k的内存空间作为缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_buffers</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">16k</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#压缩版本(默认1.1，前端为squid2.5时使用1.0)用于设置识别http协议版本，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.0</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#压缩比例 1压缩比最小 9压缩比最大
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_comp_level</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#指定压缩的类型，&#34;text/html&#34;类型总是被压缩.类型cat mime.types
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_types</span> <span style="color:#e6db74">text/plain</span> <span style="color:#e6db74">application/x-javascript</span> <span style="color:#e6db74">text/css</span> <span style="color:#e6db74">application/xml</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#告诉前端缓存服务器不要解压，到客户端时才解压.发送vary:Accept_Enconding 响应头字段，从而通知接收方我做了gzip 压缩
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">gzip_vary</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx做反向代理时，按照后端web服务器的压缩策略设置gzip 参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_proxied</span> <span style="color:#e6db74">any</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关闭对ie6 的压缩
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_disable</span> <span style="color:#e6db74">&#34;msie6&#34;</span>;
</span></span></code></pre></div><p><strong>浏览器缓存功能</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>http</code> 、<code>server</code> <code>location</code> 指令下

</div>
</p>
<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~<span style="color:#e6db74">.*\.(gif|jpg|png|bmp|swf)$</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expires</span> <span style="color:#e6db74">3650d</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~<span style="color:#e6db74">.*\.(js|css)?$</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expires</span> <span style="color:#e6db74">30d</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~<span style="color:#e6db74">(roboots.txt)</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">log_not_found</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">expires</span> <span style="color:#e6db74">7d</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>客户端请求的最大大小</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>http</code> 、<code>server</code> <code>location</code> 指令下

</div>
</p>
<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#超过这个值提示 413错误 ，值0=&gt;不控制 </span>
</span></span><span style="display:flex;"><span>client_max_body_size   16M;
</span></span></code></pre></div><p><strong>root</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>http, server, location</code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span>  <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">root</span>  <span style="color:#e6db74">/var/www/html</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>server</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>http</code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {}
</span></span></code></pre></div><p><strong>listen</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>server</code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">listen</span> 127.0.0.1:<span style="color:#ae81ff">8000</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">listen</span> 127.0.0.1;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">listen</span> <span style="color:#ae81ff">8000</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">listen</span> <span style="color:#e6db74">*:8000</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">listen</span> localhost:<span style="color:#ae81ff">8000</span>;
</span></span></code></pre></div><p><strong>server_name</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>server </code> 指令下

</div>



<div class="alert alert-primary" role="alert">


    <p>Nginx使用哈希表来快速查找匹配的server块，而这两个参数分别控制哈希表的总容量和每个桶的大小。max_size是哈希表的总槽位数，而bucket_size是每个槽位占用的内存大小</p>
<p>位置： <code>http</code> 指令下</p>


</div>



<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">报错提示</h4>

    <code>nginx: [warn] could not build optimal server_names_hash, you should increase either server_names_hash_max_size: 512 or server_names_hash_bucket_size: 64; ignoring server_names_hash_bucket_size</code>

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 支持多个
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">server_name</span> <span style="color:#e6db74">test1.go.dev</span> <span style="color:#e6db74">test2.go.dev</span> <span style="color:#e6db74">*.python.dev</span> <span style="color:#e6db74">test.dev.*</span>; 
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 为了提高匹配server_name的速度，nginx将server_name hash后存储,这里设置么个hash桶占用内存的大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">server_names_hash_bucket_size</span> <span style="color:#ae81ff">128</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 该值越大，hash冲突的可能性越小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">server_names_hash_max_size</span> <span style="color:#ae81ff">512</span>;  <span style="color:#75715e">#必须2的幂次方
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><strong>alias</strong></p>


<div class="alert alert-primary" role="alert">


    <p>位置：全局 <code>location</code> 指令下</p>
<p>语法：<code>alias file-path|directory-path;</code></p>


</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 例如请求 http://127.0.0.1/test/nginx.conf =&gt; /etc/nginx/conf/nginx.conf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/conf</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">aliase</span> <span style="color:#e6db74">/etc/nginx/conf/</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 例如请求 http://127.0.0.1/test/nginx.conf =&gt; /etc/nginx/conf/nginx.conf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">location</span> ~ <span style="color:#e6db74">^/test/(\w+)\.(\w+)$</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">aliase</span> <span style="color:#e6db74">/etc/nginx/</span>$2/$1.$2;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>index</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>server, location </code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span>  <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">root</span>  <span style="color:#e6db74">/var/www/html</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.php</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>error_page</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>http server location if </code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">404</span> <span style="color:#e6db74">/404.html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span> <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">403</span> <span style="color:#e6db74">http://127.0.0.1/forbidden.html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 如果重定向后仍然与原来的相同，可以使用 如下格式修改状态码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">404</span> = <span style="color:#ae81ff">200</span> <span style="color:#e6db74">/empty.html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 如果不想修改状态码只是想让重定向到另一个location 可以这样写
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">404</span> = <span style="color:#e6db74">@fetch</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">@fetch</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://other</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>autoindex</strong></p>


<div class="alert alert-primary" role="alert">


    <p>模块：<code>ngx_http_autoindex_module</code></p>
<p>位置：全局 <code>http, server, location</code> 指令下</p>


</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span>  <span style="color:#e6db74">/</span>  {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">autoindex</span>  <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>location指令详解</strong></p>


<div class="alert alert-primary" role="alert">


    <p>所属模块：<code>ngx_http_core_module</code></p>
<p>位置：<code>server、location</code></p>
<p>语法：<code>location [=|~|~*|^~|@] /uri/ { ... }</code></p>


</div>

<table>
  <thead>
      <tr>
          <th>匹配动作</th>
          <th>解释</th>
          <th>优先级</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>=</td>
          <td>精确匹配</td>
          <td>1</td>
      </tr>
      <tr>
          <td>^~</td>
          <td>匹配以xx开头,忽略正则</td>
          <td>2</td>
      </tr>
      <tr>
          <td>/html/</td>
          <td>匹配目录</td>
          <td>3</td>
      </tr>
      <tr>
          <td>~</td>
          <td>匹配正则 区分大小写</td>
          <td>4</td>
      </tr>
      <tr>
          <td>~*</td>
          <td>匹配正则 不区分大小写</td>
          <td>4</td>
      </tr>
      <tr>
          <td>/</td>
          <td>默认规则</td>
          <td>5</td>
      </tr>
      <tr>
          <td>@</td>
          <td>内部的重定向</td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><em>在location 最经常使用的参数为proxy_pass，接下来参照下图解释proxy_pass中路径拼接规则</em>


<div class="alert alert-primary" role="alert">


    <p><code>location /foo { proxy_pass http://host/bar; }</code>
如果 location 后面没有 /，Nginx 会把请求的 URI 不变地拼接到 proxy_pass 后的地址。</p>
<p><code>location /foo/ { proxy_pass http://host/bar/; }</code>
如果 location 后面有 /，Nginx 会把匹配到的前缀 /foo/ 去掉，然后把剩下的 URI 拼接到 proxy_pass 后的地址</p>


</div>
</p>
<p><strong>示例：</strong></p>
<pre class="mermaid">flowchart LR
    A(nginx)
    B(prometheus)
    C(alertmanager)
    D(grafana)
    
    z&gt;浏览器] --&gt; A
    
    A -..-&gt;|/prom| B
    A -..-&gt;|/alert| C
    A -..-&gt;|/grafana| D
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style C fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style D fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5</pre>


  
  
  
<ul class="nav nav-tabs" id="tabs-23" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-23-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-23-00" role="tab"
          data-td-tp-persist="location匹配不以`/`结尾" aria-controls="tabs-23-00" aria-selected="true">
        location匹配不以<code>/</code>结尾
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-23-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-23-01" role="tab"
          data-td-tp-persist="location匹配以`/`结尾(推荐)" aria-controls="tabs-23-01" aria-selected="false">
        location匹配以<code>/</code>结尾(推荐)
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-23-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-23-02" role="tab"
          data-td-tp-persist="修改访问url" aria-controls="tabs-23-02" aria-selected="false">
        修改访问url
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-23-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-23-00" role="tabpanel" aria-labelled-by="tabs-23-00-tab" tabindex="23">
        <div class="alert alert-primary" role="alert">
<h4 class="alert-heading">正确配置</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/graph 直接拼接到 http://192.168.0.161:9090/prom 后面，变成http://192.168.0.161:9090/prom/graph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom</span>;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>       }
</span></span></code></pre></div><div class="alert alert-warning" role="alert">
<h4 class="alert-heading">错误配置，显示404</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/graph 直接拼接到 http://192.168.0.161:9090/prom/ 后面，变成http://192.168.0.161:9090/prom//graph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom/</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-23-01" role="tabpanel" aria-labelled-by="tabs-23-01-tab" tabindex="23">
        <div class="alert alert-primary" role="alert">
<h4 class="alert-heading">正确配置</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/ 去掉，剩下 graph，拼接到 http://192.168.0.161:9090/prom/ 后面，变成http://192.168.0.161:9090/prom/graph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>         <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom/</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><div class="alert alert-warning" role="alert">
<h4 class="alert-heading">错误配置，显示404</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/ 去掉，剩下 graph，拼接到 http://192.168.0.161:9090/prom 后面，变成http://192.168.0.161:9090/promgraph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>         <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-23-02" role="tabpanel" aria-labelled-by="tabs-23-02-tab" tabindex="23">
        <p>默认情况下，nginx会将请求转发到后端的服务器上，而不会将请求的路径进行修改。如果需要将请求的路径进行修改，可以使用  <code>proxy_redirect</code> 指令。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>       <span style="color:#66d9ef">location</span> = <span style="color:#e6db74">/abc</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">return</span> <span style="color:#ae81ff">301</span> <span style="color:#e6db74">/abc/</span>;
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/abc/</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom/</span>;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_redirect</span> <span style="color:#e6db74">/prom/</span> <span style="color:#e6db74">/abc/</span>;
</span></span><span style="display:flex;"><span>       }
</span></span></code></pre></div>
    </div>
</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-bd8fa7533b3710dac09a20bf9487ec31">反向代理</h1>
	<div class="lead">7层反向代理|nginx</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-22" class="text-body-secondary">Thursday, May 22, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h1 id="反向代理">反向代理</h1>
<p>nginx 是一个高性能的HTTP和反向代理服务器，本章主要介绍nginx的反向代理配置。</p>

  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="四层代理" aria-controls="tabs-00-00" aria-selected="true">
        四层代理
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="七层代理" aria-controls="tabs-00-01" aria-selected="false">
        七层代理
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Info</h4>
<pre><code>nginx 在1.9 版本后开始支持 4层代理
</code></pre>
</div>
<p>配置文件示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">user</span>  <span style="color:#e6db74">nginx</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">stream</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">log_format</span> <span style="color:#e6db74">main</span> <span style="color:#e6db74">&#39;</span>$remote_addr <span style="color:#e6db74">[</span>$time_local] <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;</span>$protocol $status $bytes_sent $bytes_received <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;</span>$session_time <span style="color:#e6db74">&#34;</span>$upstream_addr&#34; <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;&#34;</span>$upstream_bytes_sent&#34; <span style="color:#e6db74">&#34;</span>$upstream_bytes_received&#34; <span style="color:#e6db74">&#34;</span>$upstream_connect_time&#34;&#39;;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">upstream</span> <span style="color:#e6db74">mysql</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server</span> 172.16.100.10:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server</span> 172.16.100.11:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server</span> 172.16.100.12:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">listen</span> <span style="color:#ae81ff">3306</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#e6db74">2s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_timeout</span> <span style="color:#e6db74">900s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">mysql</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">access_log</span>  <span style="color:#e6db74">/dev/stdout</span> <span style="color:#e6db74">main</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">user</span>  <span style="color:#e6db74">nginx</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span><span style="color:#f92672">upstream</span> <span style="color:#e6db74">backend</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># backup 当其他主机失败后使用该主机，不能用在 hash ip_hash 和random 调度算法中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># down 当前主机不可用，当使用ip_hash 中标记为down不会影响hash值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> 172.16.100.10:<span style="color:#ae81ff">8080</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 172.16.100.11:<span style="color:#ae81ff">8080</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 172.16.100.12:<span style="color:#ae81ff">8080</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 172.16.100.13:<span style="color:#ae81ff">8080</span>   <span style="color:#e6db74">backup</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 172.16.100.14:<span style="color:#ae81ff">8080</span>   <span style="color:#e6db74">backup</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 设置X-Real-IP头，让服务端看到客户端的真实IP地址。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_set_header</span>  <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 设置X-Forwarded-For头，添加原始请求的IP地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_set_header</span>  <span style="color:#e6db74">X-Forwarded-For</span> $remote_addr;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 设置代理请求的Host头，使用请求的原始主机名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 设置客户端请求的最大body大小为50MB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">client_max_body_size</span> <span style="color:#ae81ff">50m</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 设置客户端请求body的缓冲区大小为256KB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">client_body_buffer_size</span> <span style="color:#ae81ff">256k</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
</div>

<p>对于七层代理服务器主要有<a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html" target="_blank">ngx_http_upstream_module</a>和<a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html" target="_blank">ngx_http_proxy_module</a> 模块实现，</p>
<h3 id="ngx_"><strong>ngx_http_proxy_module</strong></h3>
<ol>
<li>
<p>proxy_set_header 设置 http 请求 header并传递给后端服务器。 格式 <code>proxy_set_header field value;</code></p>
</li>
<li>
<p>proxy_pass 把用户的请求转向到反向代理定义的 upstream 服务器池</p>
</li>
<li>
<p>proxy_redirect 重写location并刷新从upstream server收到的报文的首部；</p>
</li>
<li>
<p>client_body_buffer_size  指定客户端请求主体缓冲区大小</p>
</li>
<li>
<p>proxy_connect_timeout 30s; 反向代理与后端节点服务器连接的超时时间</p>
</li>
<li>
<p>proxy_send_timeout 在规定时间之内后端服务器必须传完所有数据，否则 Nginx 将断开这个连接</p>
</li>
<li>
<p>proxy_read_timeout Nginx 从代理的后端服务器获取信息的超时时间</p>
</li>
<li>
<p>proxy_buffering on; #如果缓冲区开启，把内容保存在由指令 proxy_buffer_size  proxy_buffers</p>
</li>
<li>
<p>proxy_buffer_size 32k;  #默认来说,该缓冲区大小等于指令proxy_buffers</p>
</li>
<li>
<p>proxy_buffers 32 4k;  设置缓冲区的数量和大小，Nginx 从代理的后端服务器获取的响应信息会放置到缓冲区</p>
</li>
<li>
<p>proxy_busy_buffers_size 64k;  设置系统很忙时使用的 proxy_buffers 大小，官方推荐为 proxy_buffers * 2</p>
</li>
<li>
<p>proxy_temp_file_write_size  指定 proxy 缓存临时文件的大小</p>
</li>
<li>
<p>proxy_next_upstream error timeout  #请求发生错误分配到写一个web</p>
</li>
<li>
<p>proxy_cookie_domain 将upstream server通过Set-Cookie首部设定的domain属性修改为指定的值，其值可以为一个字符串、正则表达式的模式或一个引用的变量；</p>
</li>
<li>
<p>proxy_cookie_path 将upstream server通过Set-Cookie首部设定的path属性修改为指定的值，其值可以为一个字符串、正则表达式的模式或一个引用的变量；</p>
</li>
<li>
<p>proxy_hide_header 设定发送给客户端的报文中需要隐藏的首部；</p>
</li>
</ol>
<p><strong>获取到真实的用户ip</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>server</code> <code>location </code> 指令下

</div>
</p>
<p>配置示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend_server</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;                      <span style="color:#75715e"># 客户端真实 IP（单值）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;  <span style="color:#75715e"># 记录完整的代理路径（多层代理时拼接所有中间节点 IP）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-Proto</span> $scheme;                   <span style="color:#75715e"># 协议（http/https）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><strong>重写发送给后端的http请求头的Host</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>server</code> <code>location </code> 指令下

</div>
</p>
<p>配置示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend_server</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>设置代理连接超时时间</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>server</code> <code>location </code> 指令下

</div>
</p>
<p>配置示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend_server</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#ae81ff">30</span>;           <span style="color:#75715e"># 设置代理连接超时时间为30秒。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_send_timeout</span> <span style="color:#ae81ff">30</span>;              <span style="color:#75715e"># 设置代理发送请求的超时时间为30秒。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_read_timeout</span> <span style="color:#ae81ff">60</span>;              <span style="color:#75715e"># 设置代理读取响应的超时时间为60秒。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><strong>设置代理buffer</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>server</code> <code>location </code> 指令下

</div>
</p>
<p>配置示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend_server</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_buffering</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_buffer_size</span> <span style="color:#ae81ff">32k</span>;            <span style="color:#75715e"># 设置代理缓冲区的大小为4KB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_buffers</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">32k</span>;             <span style="color:#75715e"># 设置代理缓冲区的数量和大小 为4*32KB。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_busy_buffers_size</span> <span style="color:#ae81ff">64k</span>;     <span style="color:#75715e"># 设置代理繁忙缓冲区的大小为64KB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><strong>提高代理的容错能力</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>server</code> <code>location </code> 指令下

</div>
</p>
<p>配置示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend_server</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 定义当出现错误、超时、无效头部、或HTTP状态码为500、503、404时，请求将被转发到下一个上游服务器。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_next_upstream</span> <span style="color:#e6db74">error</span> <span style="color:#e6db74">timeout</span> <span style="color:#e6db74">invalid_header</span> <span style="color:#e6db74">http_500</span> <span style="color:#e6db74">http_503</span> <span style="color:#e6db74">http_404</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>镜像静态内容到本地磁盘</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>server</code> <code>location </code> 指令下

</div>
</p>
<p>配置示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend_server</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_store</span> <span style="color:#66d9ef">on</span>;                             <span style="color:#75715e"># 开启代理存储静态内容到磁盘的功能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_store_access</span> <span style="color:#e6db74">user:rw</span> <span style="color:#e6db74">group:rw</span> <span style="color:#e6db74">all:r</span>;  <span style="color:#75715e"># 设置代理存储文件的访问权限。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_temp_path</span> <span style="color:#e6db74">/dev/shm/nginx_proxy</span>;       <span style="color:#75715e"># 定义了代理临时文件存储的路径
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h3 id="调度算法">调度算法</h3>
<p>Nginx使用的负载均衡调度算法主要有以下几种：</p>
<ol>
<li>
<p><strong>轮询（rr Round Robin）</strong>：这是默认的负载均衡算法。每个请求按时间顺序逐一分配到不同的后端服务器，如果服务器down掉，能自动剔除。</p>
</li>
<li>
<p><strong>加权轮询（wrr Weighted Round Robin）</strong>：与轮询类似，但是不同的后端服务器可以设置不同的权重，可以根据服务器的处理能力，分配不同数量的请求。权重越高，分配的请求越多。</p>
</li>
<li>
<p><strong>最少连接（least_conn Least Connections）</strong>：优先分配给当前连接数最少的服务器，适用于请求处理时间相差较大的情况。</p>
</li>
<li>
<p><strong>IP Hash(ip_hash)</strong>：根据请求的IP的hash结果分配，每个请求会固定访问一个后端服务器，适用于需要会话保持的应用。这有助于为缓存服务器实现更高的缓存命中率,如果其中一台服务器需要临时删除，则应使用down参数标记该服务器，以保留客户端IP地址的当前哈希值</p>
</li>
<li>
<p><strong>URL Hash(url_hash)</strong>：根据请求的URL的hash结果来分配请求，使得每个URL定向到同一个后端服务器，适用于服务器缓存时提高效率。</p>
</li>
<li>
<p><strong>Fair（第三方）</strong>：按后端服务器的响应时间来分配请求，响应时间短的优先分配。</p>
</li>
<li>
<p><strong>URL参数（第三方）</strong>：按照URL中带的参数进行hash，然后进行请求分发，可以实现会话保持。</p>
</li>
</ol>
<p><em>以上算法可以通过在Nginx的http或stream模块中使用upstream指令来配置。</em></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-bb64f1e09c3c57ef9271a135603f6231">location指令</h1>
	<div class="lead">location指令|nginx</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-23" class="text-body-secondary">Friday, May 23, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h3 id="location"><strong>location</strong></h3>


<div class="alert alert-primary" role="alert">


    <p>所属模块：<code>ngx_http_core_module</code></p>
<p>位置：<code>server、location</code></p>
<p>语法：<code>location [=|~|~*|^~|@] /uri/ { ... }</code></p>


</div>

<table>
  <thead>
      <tr>
          <th>匹配动作</th>
          <th>解释</th>
          <th>优先级</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>=</td>
          <td>精确匹配</td>
          <td>1</td>
      </tr>
      <tr>
          <td>^~</td>
          <td>匹配以xx开头,忽略正则</td>
          <td>2</td>
      </tr>
      <tr>
          <td>/html/</td>
          <td>匹配目录</td>
          <td>3</td>
      </tr>
      <tr>
          <td>~</td>
          <td>匹配正则 区分大小写</td>
          <td>4</td>
      </tr>
      <tr>
          <td>~*</td>
          <td>匹配正则 不区分大小写</td>
          <td>4</td>
      </tr>
      <tr>
          <td>/</td>
          <td>默认规则</td>
          <td>5</td>
      </tr>
      <tr>
          <td>@</td>
          <td>内部的重定向</td>
          <td></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~ <span style="color:#e6db74">.*\.(js|jpg|jpeg|JPEG|css|BMP|gif|GIF)$</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">access_log</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">expires</span> <span style="color:#e6db74">3650d</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~ <span style="color:#e6db74">^/images/.*\.(php|php5)$</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~ <span style="color:#e6db74">^/static..*\.(php|php5)$</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">^/data/(attachment|avatar)/.*\.(php|php5)</span>$ {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~ <span style="color:#e6db74">(roboots.txt)</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">log_not_found</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">expires</span> <span style="color:#e6db74">7d</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">set</span> $memcached_key $uri;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">memcached_pass</span>     name:<span style="color:#ae81ff">11211</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>       <span style="color:#e6db74">text/html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">error_page</span>         <span style="color:#ae81ff">404</span> <span style="color:#e6db74">@fallback</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">location</span> <span style="color:#e6db74">@fallback</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><em>在location 最经常使用的参数为proxy_pass，接下来参照下图解释proxy_pass中路径拼接规则</em>


<div class="alert alert-primary" role="alert">


    <p><code>location /foo { proxy_pass http://host/bar; }</code>
如果 location 后面没有 /，Nginx 会把请求的 URI 不变地拼接到 proxy_pass 后的地址。</p>
<p><code>location /foo/ { proxy_pass http://host/bar/; }</code>
如果 location 后面有 /，Nginx 会把匹配到的前缀 /foo/ 去掉，然后把剩下的 URI 拼接到 proxy_pass 后的地址</p>


</div>
</p>
<p><strong>示例：</strong></p>
<pre class="mermaid">flowchart LR
    A(nginx)
    B(prometheus)
    C(alertmanager)
    D(grafana)
    
    z&gt;浏览器] --&gt; A
    
    A -..-&gt;|/prom| B
    A -..-&gt;|/alert| C
    A -..-&gt;|/grafana| D
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style C fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style D fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5</pre>


  
  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          data-td-tp-persist="location匹配不以`/`结尾" aria-controls="tabs-02-00" aria-selected="true">
        location匹配不以<code>/</code>结尾
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="location匹配以`/`结尾(推荐)" aria-controls="tabs-02-01" aria-selected="false">
        location匹配以<code>/</code>结尾(推荐)
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-02" role="tab"
          data-td-tp-persist="修改访问url" aria-controls="tabs-02-02" aria-selected="false">
        修改访问url
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        <div class="alert alert-primary" role="alert">
<h4 class="alert-heading">正确配置</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/graph 直接拼接到 http://192.168.0.161:9090/prom 后面，变成http://192.168.0.161:9090/prom/graph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom</span>;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>       }
</span></span></code></pre></div><div class="alert alert-warning" role="alert">
<h4 class="alert-heading">错误配置，显示404</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/graph 直接拼接到 http://192.168.0.161:9090/prom/ 后面，变成http://192.168.0.161:9090/prom//graph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom/</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="alert alert-primary" role="alert">
<h4 class="alert-heading">正确配置</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/ 去掉，剩下 graph，拼接到 http://192.168.0.161:9090/prom/ 后面，变成http://192.168.0.161:9090/prom/graph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>         <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom/</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><div class="alert alert-warning" role="alert">
<h4 class="alert-heading">错误配置，显示404</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/ 去掉，剩下 graph，拼接到 http://192.168.0.161:9090/prom 后面，变成http://192.168.0.161:9090/promgraph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>         <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-02" role="tabpanel" aria-labelled-by="tabs-02-02-tab" tabindex="2">
        <p>默认情况下，nginx会将请求转发到后端的服务器上，而不会将请求的路径进行修改。如果需要将请求的路径进行修改，可以使用  <code>proxy_redirect</code> 指令。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>       <span style="color:#66d9ef">location</span> = <span style="color:#e6db74">/abc</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">return</span> <span style="color:#ae81ff">301</span> <span style="color:#e6db74">/abc/</span>;
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/abc/</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom/</span>;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_redirect</span> <span style="color:#e6db74">/prom/</span> <span style="color:#e6db74">/abc/</span>;
</span></span><span style="display:flex;"><span>       }
</span></span></code></pre></div>
    </div>
</div>

<h3 id="rewrite"><strong>rewrite</strong></h3>
<p>rewrite <a href="https://www.cnblogs.com/likwo/p/6513117.html" target="_blank">https://www.cnblogs.com/likwo/p/6513117.html</a></p>
<p>Nginx 的 <code>rewrite</code> 指令的主要作用是通过<strong>重写请求 URI</strong>，从而满足安全、兼容、优化或特定业务逻辑需求</p>


<div class="alert alert-primary" role="alert">


    <p>所属模块：<code>ngx_http_core_module</code></p>
<p>位置：<code>server、location</code></p>
<p>基本语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">关键字</span>       <span style="color:#e6db74">正则表达式</span>        <span style="color:#e6db74">代替的内容</span>           <span style="color:#e6db74">重写类型</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">rewrite</span>     <span style="color:#e6db74">&lt;regex&gt;</span>        <span style="color:#e6db74">&lt;replacement&gt;</span>        <span style="color:#e6db74">&lt;flag&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &lt;regex&gt;: 可以是字符串或者正则来表示想要匹配的目标URL   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># &lt;replacement&gt;: 将正则匹配的内容替换成replacement
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># &lt;flag&gt;: 重写类型：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># last: 本条规则匹配完成后，继续向下匹配新的location URI规则；相当于Apache里(L)标记，表示完成rewrite，浏览器地址栏URL地址不变；一般写在server和if中;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># break: 本条规则匹配完成后，终止匹配，不再匹配后面的规则，浏览器地址栏URL地址不变；一般使用在location中；
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># redirect: 返回302临时重定向，浏览器地址会显示跳转后的URL地址；
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># permanent: 返回301永久重定向，浏览器地址栏会显示跳转后的URL地址；
</span></span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>  <span style="color:#75715e"># 访问 /last.html 的时候，页面内容重写到 /index.html 中，并继续后面的匹配，浏览器地址栏URL地址不变
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">/last.html</span> <span style="color:#e6db74">/index.html</span> <span style="color:#e6db74">last</span>;    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 访问 /break.html 的时候，页面内容重写到 /index.html 中，并停止后续的匹配，浏览器地址栏URL地址不变；    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">/break.html</span> <span style="color:#e6db74">/index.html</span> <span style="color:#e6db74">break</span>;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 访问 /redirect.html 的时候，页面直接302定向到 /index.html中，浏览器地址URL跳为index.html     
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">/redirect.html</span> <span style="color:#e6db74">/index.html</span> <span style="color:#e6db74">redirect</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 访问 /permanent.html 的时候，页面直接301定向到 /index.html中，浏览器地址URL跳为index.html   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">/permanent.html</span> <span style="color:#e6db74">/index.html</span> <span style="color:#e6db74">permanent</span>;     
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 把 /html/*.html =&gt; /post/*.html ，301定向  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^/html/(.+?).html</span>$ <span style="color:#e6db74">/post/</span>$1.html <span style="color:#e6db74">permanent</span>;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 把 /search/key =&gt;/search.html?keyword=key   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^/search\/([^\/]+?)(\/|</span>$<span style="color:#e6db74">)</span> <span style="color:#e6db74">/search.html?keyword=</span>$1 <span style="color:#e6db74">permanent</span>;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 把当前域名的请求，跳转到新域名上，域名变化但路径不变    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^/(.*)</span> <span style="color:#e6db74">http://www.jd.com/</span>$1 <span style="color:#e6db74">permanent</span>;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 隐藏真实目录
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">server</span> {     
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">root</span> <span style="color:#e6db74">/var/www/html</span>;     <span style="color:#75715e"># 用 /html_test 来掩饰 html   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {        
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">/html_test</span> <span style="color:#e6db74">/html</span> <span style="color:#e6db74">break</span>;  <span style="color:#75715e"># 使用break拿一旦匹配成功则忽略后续location      
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span> <span style="color:#f92672">location</span> <span style="color:#e6db74">/html</span> {      
</span></span><span style="display:flex;"><span> <span style="color:#f92672">return</span> <span style="color:#ae81ff">403</span>;         <span style="color:#75715e"># 访问真实地址直接报没权限 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }       
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 对/images/bla_500x400.jpg文件请求，重写到/resizer/bla.jpg?width=500&amp;height=400地址，并会继续尝试匹配location。  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^/images/(.*)_(\d+)x(\d+)\.(png|jpg|gif)</span>$ <span style="color:#e6db74">/resizer/</span>$1.$4?width=$2&amp;height=$3? <span style="color:#e6db74">last</span>;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">20.防盗链</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">\.(jpg|gif|png|swf|flv|wmv|asf|mp3|mmf|zip|rar)</span>${
</span></span><span style="display:flex;"><span><span style="color:#e6db74">vaild_referers</span> <span style="color:#e6db74">none</span> <span style="color:#e6db74">blocked</span> <span style="color:#e6db74">*.etiantian.org</span> <span style="color:#e6db74">etiantian.org</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(</span>$incalid_referer<span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">rewirte</span> <span style="color:#e6db74">^/http://www.etiantian.org/img/nolink.jpg</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">21</span><span style="color:#e6db74">.伪静态（discuz）</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">rewrite</span> <span style="color:#e6db74">^([^\.]*)/topic-(.+)\.html</span>$ $1/portal.php?mod=topic&amp;topic=$2 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/article-([0-9]+)-([0-9]+)\.html</span>$ $1/portal.php?mod=view&amp;aid=$2&amp;page=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/forum-(\w+)-([0-9]+)\.html</span>$ $1/forum.php?mod=forumdisplay&amp;fid=$2&amp;page=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/thread-([0-9]+)-([0-9]+)-([0-9]+)\.html</span>$ $1/forum.php?mod=viewthread&amp;tid=$2&amp;extra=page%3D$4&amp;page=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/group-([0-9]+)-([0-9]+)\.html</span>$ $1/forum.php?mod=group&amp;fid=$2&amp;page=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/space-(username|uid)-(.+)\.html</span>$ $1/home.php?mod=space&amp;$2=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/blog-([0-9]+)-([0-9]+)\.html</span>$ $1/home.php?mod=space&amp;uid=$2&amp;do=blog&amp;id=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/(fid|tid)-([0-9]+)\.html</span>$ $1/index.php?action=$2&amp;value=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/([a-z]+[a-z0-9_]*)-([a-z0-9_\-]+)\.html</span>$ $1/plugin.php?id=$2:$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(!-e</span> $request_filename<span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">return</span> <span style="color:#ae81ff">404</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^/images/(.*\.jpg)</span>$  <span style="color:#e6db74">/images2/</span>$1 <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^/abc/.*</span>$ <span style="color:#e6db74">/</span>$1/abc/ <span style="color:#e6db74">last</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/images/(.*\.jpg)</span>$  <span style="color:#e6db74">/images2/</span>$1 <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/abc/.*</span>$ <span style="color:#e6db74">/</span>$1/abc/ <span style="color:#e6db74">last</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">/images/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/images/(.*\.jpg)</span>$  <span style="color:#e6db74">/images2/</span>$1 <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">location</span> <span style="color:#e6db74">/abc/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/abc/(.*)</span>$ <span style="color:#e6db74">/</span>$1/abc/ <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/images/.*\.jpg</span>$ <span style="color:#e6db74">/images/b.jpg</span> <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">http://172.16.100.1/images/b.jpg</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">rewrite</span> <span style="color:#e6db74">&#34;^/test/(.*\.jpg)</span>$&#34; <span style="color:#e6db74">&#34;/test/repire.jpg&#34;</span> <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rewrite</span> <span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">一、设置一个简单的URL重写：</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">比如，某网站原有的论坛访问路径为/forum/，但后来根据要求需要更改为/bbs，于是，就可以通过下面的方法实现：</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">rewrite</span> <span style="color:#e6db74">^/forum/?</span>$ <span style="color:#e6db74">/bbs/</span> <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">http://172.16.100.1/forum/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#e6db74">、if指令：</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">语法:</span> <span style="color:#e6db74">if</span> <span style="color:#e6db74">(condition)</span> { <span style="color:#f92672">...</span> <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">应用环境:</span> <span style="color:#e6db74">server,</span> <span style="color:#e6db74">location</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">条件:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#e6db74">、变量名</span>; <span style="color:#f92672">false</span> <span style="color:#e6db74">values</span> <span style="color:#e6db74">are:</span> <span style="color:#e6db74">empty</span> <span style="color:#e6db74">string</span> <span style="color:#e6db74">(&#34;&#34;,</span> <span style="color:#e6db74">or</span> <span style="color:#e6db74">any</span> <span style="color:#e6db74">string</span> <span style="color:#e6db74">starting</span> <span style="color:#e6db74">with</span> <span style="color:#e6db74">&#34;0&#34;</span>;<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span><span style="color:#e6db74">、对于变量进行的比较表达式，可使用=或!=进行测试</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">3、正则表达式的模式匹配:</span>
</span></span><span style="display:flex;"><span>~  <span style="color:#e6db74">区分大小的模式匹配</span>
</span></span><span style="display:flex;"><span>~<span style="color:#e6db74">*</span> <span style="color:#e6db74">不区分字母大小写的模式匹配</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">!~</span> <span style="color:#e6db74">和</span> <span style="color:#e6db74">!~*</span> <span style="color:#e6db74">分别对上面的两种测试取反</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span><span style="color:#e6db74">、测试文件是否存在-f或!-f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span><span style="color:#e6db74">、测试目录是否存在-d或!-d</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span><span style="color:#e6db74">、测试目录、文件或链接文件的存在性-e或!-e</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7</span><span style="color:#e6db74">、检查一个文件的执行权限-x或!-x</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">在正则表达式中，可以使用圆括号标记匹配到的字符串，并可以分别使用</span>$1,$2,...,$9进行引用；
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">例如：</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">判断用户的浏览器类型：</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">MSIE)</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rewrite</span>  <span style="color:#e6db74">^(.*)</span>$  <span style="color:#e6db74">/msie/</span>$1  <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">opera)</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rewrite</span>  <span style="color:#e6db74">^(.*)</span>$  <span style="color:#e6db74">/opera/</span>$1  <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">如果用户请求的页面不存在，实现自定义跳转：</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">if</span> <span style="color:#e6db74">(!-f</span> $request_filename<span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^(/.*)</span>$ <span style="color:#e6db74">/rewrite.html</span> <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">实现域名跳转</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">server</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">jump.magedu.com</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.php</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">root</span> <span style="color:#e6db74">/www/htdocs</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/</span> <span style="color:#e6db74">http://www.magedu.com/</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">实现域名镜像</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">server</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">server_name</span> <span style="color:#e6db74">mirror.magedu.com</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.php</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">root</span> <span style="color:#e6db74">/www/htdocs</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/(.*)</span>$ <span style="color:#e6db74">http://www.magedu.com/</span>$1 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">简单的防盗链配置：</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">\.(gif|jpg|png|swf|flv)</span>$ {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">valid_referers</span> <span style="color:#e6db74">none</span> <span style="color:#e6db74">blocked</span> <span style="color:#e6db74">www.magedu.com</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$invalid_referer<span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/</span> <span style="color:#e6db74">http://www.magedu.com/403.html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># return 404
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">第一行：gif|jpg|png|swf|flv</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">表示对gif、jpg、png、swf、flv后缀的文件实行防盗链</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">第二行：www.magedu.com</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">表示对www.magedu.com这个来路进行判断if</span>{}<span style="color:#f92672">里面内容的意思是，如果来路不是指定来路就跳转到错误页面，当然直接返回404也是可以的。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">if</span> <span style="color:#e6db74">(!-e</span> $request_filename<span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/user/([0-9]+)/?</span>$ <span style="color:#e6db74">/view.php?go=user_</span>$1 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/component/id/([0-9]+)/?</span>$ <span style="color:#e6db74">/page.php?pageid=</span>$1 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/component/([^/]+)/?</span>$ <span style="color:#e6db74">/page.php?pagealias=</span>$1 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/category\_([0-9]+)\.htm</span>$ <span style="color:#e6db74">http://</span>$host/category/$1/ <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/showday\_([0-9]+)\_([0-9]+)\_([0-9]+)\.htm</span>$ <span style="color:#e6db74">http://</span>$host/date/$1/$2/$3/ <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">showday_1_2_3.htm</span> $host/date/1/2/3/
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">server</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span> <span style="color:#e6db74">default</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server_name</span> <span style="color:#e6db74">*.mysite.com</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^</span> <span style="color:#e6db74">http://mysite.com</span>$request_uri <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="if">if</h3>


<div class="alert alert-primary" role="alert">


    <p>if判断自定义和内置全局环境变量</p>
<p>位置: 全局 <code>location</code> 指令下</p>
<p>语法: <code>if (表达式) { };</code></p>


</div>

<blockquote>
<p>例如访问： <code>http://localhost:81/download/stat.php?id=1585378&amp;web_id=1585378 </code>    <br>
root：/var/www/html</p>
</blockquote>
<table>
  <thead>
      <tr>
          <th>变量</th>
          <th>解释</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>$args</code></td>
          <td>这个变量等于请求行中的参数，同$query_string</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$content_length</code></td>
          <td>请求头中的Content-length字段</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$content_type</code></td>
          <td>请求头中的Content-Type字段</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$document_root</code></td>
          <td>当前请求在root指令中指定的值</td>
          <td>/var/www/html</td>
      </tr>
      <tr>
          <td><code>$host</code></td>
          <td>请求主机头字段，否则为服务器名称</td>
          <td>localhost</td>
      </tr>
      <tr>
          <td><code>$http_user_agent</code></td>
          <td>客户端agent信息</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$http_cookie</code></td>
          <td>客户端cookie信息</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$limit_rate</code></td>
          <td>这个变量可以限制连接速率</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$request_method</code></td>
          <td>客户端请求的动作，通常为GET或POST</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$request_body_file</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>$request_filename</code></td>
          <td>当前请求的文件路径，由root或alias指令与URI请求生成</td>
          <td>/var/www/html/download/stat.php</td>
      </tr>
      <tr>
          <td><code>$request_uri</code></td>
          <td>包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”</td>
          <td>/download/stat.php?id=1585378&amp;web_id=1585378</td>
      </tr>
      <tr>
          <td><code>$query_string</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>$remote_addr</code></td>
          <td>客户端的IP地址</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$remote_port</code></td>
          <td>客户端的端口</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$remote_user</code></td>
          <td>已经经过Auth Basic Module验证的用户名</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$scheme</code></td>
          <td>HTTP方法（如http，https）</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$server_protocol</code></td>
          <td>请求使用的协议，通常是HTTP/1.0或HTTP/1.1</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$server_addr</code></td>
          <td>服务器地址，在完成一次系统调用后可以确定这个值</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$server_name</code></td>
          <td>服务器名称</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$server_port</code></td>
          <td>请求到达服务器的端口号</td>
          <td>81</td>
      </tr>
      <tr>
          <td><code>$uri</code></td>
          <td>不带请求参数的当前URI，$uri不包含主机名，如”/foo/bar.html</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$document_uri</code></td>
          <td>与$uri相同</td>
          <td>/download/stat.php</td>
      </tr>
  </tbody>
</table>
<p>条件表达式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">正则表达式匹配：</span>
</span></span><span style="display:flex;"><span>    ~<span style="color:#e6db74">：与指定正则表达式模式匹配时返回“真”，判断匹配与否时区分字符大小写；</span>
</span></span><span style="display:flex;"><span>    ~<span style="color:#e6db74">*：与指定正则表达式模式匹配时返回“真”，判断匹配与否时不区分字符大小写；</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">!~：与指定正则表达式模式不匹配时返回“真”，判断匹配与否时区分字符大小写；</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">!~*：与指定正则表达式模式不匹配时返回“真”，判断匹配与否时不区分字符大小写；</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">文件及目录匹配判断：</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-f,</span> <span style="color:#e6db74">!-f：判断指定的路径是否为存在且为文件；</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-d,</span> <span style="color:#e6db74">!-d：判断指定的路径是否为存在且为目录；</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-e,</span> <span style="color:#e6db74">!-e：判断指定的路径是否存在，文件或目录均可；</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-x,</span> <span style="color:#e6db74">!-x：判断指定路径的文件是否存在且可执行；</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 如果文件不存在则返回400  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(!-f</span> $request_filename<span style="color:#e6db74">)</span> {     
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">return</span> <span style="color:#ae81ff">400</span>;    
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果host是www.360buy.com，则301到www.jd.com中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(</span> $host <span style="color:#e6db74">!=</span> <span style="color:#e6db74">&#34;www.jd.com&#34;</span> <span style="color:#e6db74">)</span>{
</span></span><span style="display:flex;"><span> <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/(.*)</span>$ <span style="color:#e6db74">https://www.jd.com/</span>$1 <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果请求类型是POST则返回405，return不能返回301,302
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(</span>$request_method = <span style="color:#e6db74">POST)</span> { 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">return</span> <span style="color:#ae81ff">405</span>; 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果参数中有 a=1 则301到指定域名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(</span>$args ~ <span style="color:#e6db74">a=1)</span> {     
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^</span> <span style="color:#e6db74">http://example.com/</span> <span style="color:#e6db74">permanent</span>;   
</span></span><span style="display:flex;"><span>}   
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 文件名及参数重写
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#66d9ef">location</span> = <span style="color:#e6db74">/index.html</span> {       
</span></span><span style="display:flex;"><span> <span style="color:#f92672">set</span> $name <span style="color:#e6db74">test</span>;    <span style="color:#75715e"># 修改默认值为         
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#f92672">if($args</span> ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">name=(\w+?)(&amp;|</span>$<span style="color:#e6db74">))</span> {      
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">set</span> $name $1;     <span style="color:#75715e"># 如果参数中有 name=xx 则使用该值 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> }
</span></span><span style="display:flex;"><span> <span style="color:#75715e">#permanent 301重定向     
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^</span> <span style="color:#e6db74">/</span>$name.html <span style="color:#e6db74">permanent</span>;      
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># 禁止指定IP访问
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$remote_addr = 192.168.1.253<span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">return</span> <span style="color:#ae81ff">403</span>;
</span></span><span style="display:flex;"><span>    }       
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果请求的文件不存在，则反向代理到localhost 。这里的break也是停止继续rewrite 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(!-f</span> $request_filename<span style="color:#e6db74">)</span>{        
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">break</span>;      
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1</span>;     
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">&#34;andriod&#34;)</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://lb1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">&#34;iphome&#34;)</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://lb2</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">&#34;qihoobot|Baiduspider|Googlebot|Googlebot-Mobile|Googlebot-Image|Mediapartners-Google|Adsbot-Google|Feedfetcher-Google|Yahoo!</span> <span style="color:#e6db74">Slurp|Yahoo!</span> <span style="color:#e6db74">Slurp</span> <span style="color:#e6db74">China|YoudaoBot|Sosospider|Sogou</span> <span style="color:#e6db74">spider|Sogou</span> <span style="color:#e6db74">web</span> <span style="color:#e6db74">spider|MSNBot|ia_archiver|Tomato</span> <span style="color:#e6db74">Bot&#34;)</span> 
</span></span><span style="display:flex;"><span>   { 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">return</span> <span style="color:#ae81ff">403</span>; 
</span></span><span style="display:flex;"><span>   } 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">在location中使用if语句可以实现条件判断，其通常有一个return语句，且一般与有着last或break标记的rewrite规则一同使用。但其也可以按需要使用在多种场景下，需要注意的是，不当的使用可能会导致不可预料的后果。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$request_method == <span style="color:#e6db74">“PUT”)</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://upload.magedu.com:8080</span>;
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$request_uri ~ <span style="color:#e6db74">&#34;\.(jpg|gif|jpeg|png)$&#34;)</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://imageservers</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">agent</span> <span style="color:#e6db74">参数</span>    <span style="color:#e6db74">根基客户端设备不同选择主机</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">_______________________________________________________</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">upstream</span> <span style="color:#e6db74">LB1</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 10.0.0.2:<span style="color:#ae81ff">81</span> <span style="color:#e6db74">weight=10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 10.0.0.3:<span style="color:#ae81ff">82</span> <span style="color:#e6db74">weight=6</span> <span style="color:#e6db74">down</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 10.0.0.1:<span style="color:#ae81ff">83</span> <span style="color:#e6db74">weight=5</span> <span style="color:#e6db74">backup</span> <span style="color:#e6db74">max_fails=2</span> <span style="color:#e6db74">fail_timeout=20s</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ip_hash</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">upstream</span> <span style="color:#e6db74">LB2</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 10.0.0.2:<span style="color:#ae81ff">84</span> <span style="color:#e6db74">weight=10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 10.0.0.3:<span style="color:#ae81ff">85</span> <span style="color:#e6db74">weight=6</span> <span style="color:#e6db74">down</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 10.0.0.1:<span style="color:#ae81ff">86</span> <span style="color:#e6db74">weight=5</span> <span style="color:#e6db74">backup</span> <span style="color:#e6db74">max_fails=2</span> <span style="color:#e6db74">fail_timeout=20s</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ip_hash</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">blog.etiantian.org</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">&#34;andriod&#34;)</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://lb1</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">&#34;iphone&#34;)</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://lb2</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://lb1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span>  <span style="color:#e6db74">X-Real-IP</span> $remote_addr; <span style="color:#f92672">后端服务器接收到真实的客户IP</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">proxy_set_header</span>  <span style="color:#e6db74">X-Forwarded-For</span> $remote_addr; <span style="color:#f92672">后端服务器接收到真实的客户IP</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">proxy_set_header</span>  <span style="color:#e6db74">Host</span> $host;   <span style="color:#f92672">按照负载均衡的server_name</span> <span style="color:#e6db74">名称查找后端的基于域名的虚拟主机</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>
</span></span></code></pre></div>
</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c8a277e554b08c5c1a52fa904ed67ca0">ansible</h1>
	
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-21" class="text-body-secondary">Wednesday, May 21, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-73cbbd40bbb62c473e2785f489790835">Quitstart</h1>
	<div class="lead">quitstart|ansible</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-21" class="text-body-secondary">Wednesday, May 21, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<p><em>Ansible 是一个 IT 自动化工具,每年大约发布三到四次新的 Ansible 主要版本。</em></p>
<p>文档使用版本2.9</p>
<h3 id="概念">概念</h3>
<ul>
<li>控制节点： 安装了ansible 的主机，window主机不能作为控制节点</li>
<li>被管理节点：受控制节点管理的主机</li>
<li>inventory :  被管理节点的主机清单</li>
<li>模块：ansible 调用的python包</li>
<li>tasks: 要ansible执行的任务</li>
<li>playbook: 通过编排后的task集合，可以完成复杂任务</li>
</ul>
<h3 id="工作原理">工作原理</h3>
<ul>
<li>选择被管理节点</li>
<li>通过ssh连接到节点</li>
<li>将一个或多个模块复制到被管理节点执行</li>
</ul>
<h3 id="快速开始">快速开始</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install ansible-2.9.27-1.el7.noarch
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2.9 开始支持补全功能</span>
</span></span><span style="display:flex;"><span>yum install epel-release
</span></span><span style="display:flex;"><span>yum install python-argcomplete
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m ping
</span></span></code></pre></div><p>主配置文件: <code>/etc/ansible/ansible.cfg</code></p>
<p>定义资产配置清单: <code>/etc/ansible/hosts</code></p>

  
  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>资产配置清单</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="ini格式" aria-controls="tabs-00-01" aria-selected="true">
        ini格式
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="yaml格式" aria-controls="tabs-00-02" aria-selected="false">
        yaml格式
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75715e"># /etc/ansible/hosts</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[master]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">10.4.7.9</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">10.4.7.1[0:1]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[node]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">node[1:15]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[all:vars]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ansible_ssh_user: root</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># /etc/ansible/hosts</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">all</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">master</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hosts</span>: <span style="color:#e6db74">&#34;10.4.7.9,10.4.7.1[0:1]&#34;</span>  <span style="color:#75715e"># 展开为 10.4.7.9, 10.4.7.10, 10.4.7.11</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">node</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hosts</span>: <span style="color:#e6db74">&#34;node[1:15]&#34;</span>              <span style="color:#75715e"># 展开为 node1, node2, ..., node15</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ansible_ssh_user</span>: <span style="color:#ae81ff">root            </span> <span style="color:#75715e"># 全局 SSH 用户设置为 root</span>
</span></span></code></pre></div>
    </div>
</div>

<p>查询配置清单中的主机</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible all --list-hosts
</span></span></code></pre></div><h3 id="模块">模块</h3>
<h5 id="ping--模块">ping  模块</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible all -m ping
</span></span></code></pre></div><h5 id="debug">debug</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible 127.0.0.1 -m debug -a <span style="color:#e6db74">&#34;msg=hello world&#34;</span>
</span></span></code></pre></div><h5 id="hostname">hostname</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 修改主机名</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m hostname -a <span style="color:#e6db74">&#34;name=ansible-master&#34;</span>
</span></span></code></pre></div><h5 id="fetch">fetch</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ansible-doc -s fetch 从远端拉取文件</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m fetch -a <span style="color:#e6db74">&#34;src=/etc/hosts dest=/tmp&#34;</span>
</span></span></code></pre></div><h5 id="file">file</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ansible-doc -s file  创建/删除 文件/目录/软连接</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m file -a <span style="color:#e6db74">&#34;path=/tmp/a.log state=touch&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m file -a <span style="color:#e6db74">&#34;path=/tmp/a.log state=absent&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m file -a <span style="color:#e6db74">&#34;path=/tmp/a/b state=directory recurse=yes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m file -a <span style="color:#e6db74">&#34;path=/tmp/a state=absent&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m file -a <span style="color:#e6db74">&#34;path=/tmp/a state=link src=/etc/hosts&#34;</span>
</span></span></code></pre></div><h5 id="blockinfile">blockinfile</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ansible-doc -s blockinfile  按照标记添加/删除文件内容</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 插入内容</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m blockinfile -a <span style="color:#e6db74">&#34;path=/tmp/a marker=#{mark}20220318 block=&#39;101.43.43.9  test.com&#39;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除标记位置内容</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m blockinfile -a <span style="color:#e6db74">&#34;path=/tmp/a marker=#{mark}20220318 state=absent&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在开头插入 BOF（begin of file）</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m blockinfile -a <span style="color:#e6db74">&#34;path=/tmp/a marker=#{mark}20220318 block=&#39;10.43.43.9 test.com&#39; insertbefore=BOF&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在结尾插入 EOF (end of file)</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m blockinfile -a <span style="color:#e6db74">&#34;path=/tmp/a marker=#{mark}20220318 block=&#39;10.43.43.9 test.com&#39; insertbefore=EOF&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在insertafter=&#39;^127.0.0.1&#39; 之后插入</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m blockinfile -a <span style="color:#e6db74">&#34;path=/tmp/a marker=#{mark}20220318 block=&#39;10.43.43.9 test.com&#39; insertafter=&#39;^127.0.0.1&#39;&#34;</span>
</span></span></code></pre></div><h5 id="lineinfile">lineinfile</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># sed -i &#39;s/^10/#############/g&#39; /tmp/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># backrefs=yes 支持正则分组引用 ，当正则不匹配时不执行动作</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m lineinfile -a <span style="color:#e6db74">&#34;path=/tmp/a regexp=&#39;^10&#39; line=&#39;#############&#39; backrefs=yes&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># sed -i &#39;s/^#(.*)/\1g&#39; /tmp/a</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m lineinfile -a <span style="color:#e6db74">&#34;path=/tmp/a regexp=&#39;^#(.*)&#39; line=&#39;\1&#39; backrefs=yes
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># sed - &#39;/#############/d&#39; /tmp/a</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m lineinfile -a <span style="color:#e6db74">&#34;path=/tmp/a line=&#39;#############&#39; state=absent&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># sed - &#39;/^.*20220318$/d&#39; /tmp/a</span>
</span></span><span style="display:flex;"><span>ansibel 127.0.0.1 -m lineinfile -a <span style="color:#e6db74">&#34;path=/tmp/a regexp=&#39;^.*20220318</span>$<span style="color:#e6db74">&#39; state=absent&#34;</span>
</span></span></code></pre></div><h5 id="find">find</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ansible-doc -s find</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m find -a <span style="color:#e6db74">&#34;paths=&#39;/root&#39; patterns=&#39;zookeeper.out&#39; recurse=yes&#34;</span>
</span></span></code></pre></div><h5 id="replace">replace</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># sed -i &#39;s/^[a-Z]/##/g&#39; /tmp/a</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m replace -a <span style="color:#e6db74">&#34;path=/tmp/a regexp=&#39;^[a-Z]&#39; replace=&#39;##&#39;&#34;</span>
</span></span></code></pre></div><h5 id="command">command</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible 127.0.0.1 -m  command -a <span style="color:#e6db74">&#34;chdir=&#39;/&#39; ls -a&#34;</span>
</span></span></code></pre></div><h5 id="shell">shell</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 支持管道，command 不支持</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m  shell -a <span style="color:#e6db74">&#34;chdir=&#39;/&#39; ls -a|wc&#34;</span>
</span></span></code></pre></div><p><strong>script</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># /tmp/1.sh 在运维主机</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m  script -a <span style="color:#e6db74">&#34;chdir=&#39;/&#39; /tmp/1.sh&#34;</span>
</span></span></code></pre></div><h5 id="cron">cron</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 添加定时任务</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># */5 * * * * usr/sbin/ntpdate ntpdate ntp.aliyun.com &gt;/dev/null 2&gt;&amp;1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m cron -a <span style="color:#e6db74">&#34;minute=*/5 hour=* name=&#39;ntp date&#39; job=&#39;/usr/sbin/ntpdate ntpdate ntp.aliyun.com &gt;/dev/null 2&gt;&amp;1&#39;&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 启用注释的定时任务</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m cron -a <span style="color:#e6db74">&#34;disabled=false name=&#39;ntp date&#39; job=&#39;/usr/sbin/ntpdate ntpdate ntp.aliyun.com &gt;/dev/null 2&gt;&amp;1&#39;&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 删除定时任务</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m cron -a <span style="color:#e6db74">&#34;state=absent name=&#39;ntp date&#39; backup=yes&#34;</span>
</span></span></code></pre></div><h5 id="yum">yum</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 安装</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m yum -a <span style="color:#e6db74">&#34;name=rsync,vim,lrzsz state=present&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 卸载</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m yum -a <span style="color:#e6db74">&#34;name=rsync,vim,lrzsz state=absent&#34;</span>
</span></span></code></pre></div><h5 id="systemd">systemd</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible all -m systemd -a <span style="color:#e6db74">&#34;name=network state=restarted enabled=yes&#34;</span>
</span></span></code></pre></div><h5 id="group">group</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># groupadd mysql</span>
</span></span><span style="display:flex;"><span>ansible all -m group -a <span style="color:#e6db74">&#34;name=mysql state=present&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># groupadd mysql</span>
</span></span><span style="display:flex;"><span>ansible all -m group -a <span style="color:#e6db74">&#34;name=db state=present&#34;</span>
</span></span></code></pre></div><h5 id="user">user</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># useradd -g mysql -G root,db  -M -s /bin/nologin mysql</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible all -m user -a <span style="color:#e6db74">&#34;name=mysql group=mysql groups=db,root create_home=no shell=/bin/nologin state=present&#34;</span>
</span></span></code></pre></div><h5 id="template">template</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">template:	# 与copy类似，支持变量解析</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">src</span>: <span style="color:#ae81ff">/tmp/nginx.conf.j2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/tmp/nginx.conf</span>
</span></span></code></pre></div><h3 id="剧本playbook">剧本playbook</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 检查语法</span>
</span></span><span style="display:flex;"><span>ansible-playbook --syntax-check /etc/ansible/play.yml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># dry-run</span>
</span></span><span style="display:flex;"><span>ansible-playbook --check /etc/ansible/play.yml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 执行剧本</span>
</span></span><span style="display:flex;"><span>ansible-playbook /etc/ansible/play.yml
</span></span><span style="display:flex;"><span>ansible-playbook /etc/ansible/play.yml --list-hosts
</span></span><span style="display:flex;"><span>ansible-playbook /etc/ansible/play.yml --list-tasks
</span></span><span style="display:flex;"><span>ansible-playbook /etc/ansible/play.yml --limit 10.4.7.21
</span></span></code></pre></div><h5 id="基本语法tasks">基本语法tasks</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># /etc/ansible/play.yml</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ping host</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ping</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>: 
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">10.4.7.11</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">10.4.7.12</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fetch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fetch</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">src</span>: <span style="color:#ae81ff">/etc/services</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/tmp</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">copy file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">copy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">src</span>: <span style="color:#ae81ff">/etc/services</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/tmp</span>
</span></span></code></pre></div><h5 id="基本语法handlers">基本语法handlers</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 通过notify 调用handlers</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">touch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">notify</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">wirte file</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">handlers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">wirte file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">blockinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">block</span>: <span style="color:#e6db74">&#39;this is first line&#39;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">remove file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span></code></pre></div><h5 id="基本语法meta">基本语法meta</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">touch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">notify</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">wirte file</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># python 按顺序执行，如果添加了meta: flush_handlers 对应的task完成后会直接触发handlers</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">meta</span>: <span style="color:#ae81ff">flush_handlers</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ping</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ping</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">handlers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">wirte file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">blockinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">block</span>: <span style="color:#e6db74">&#39;this is first line&#39;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">remove file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span></code></pre></div><h5 id="基本语法listen">基本语法listen</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">touch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">notify</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">group1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">handlers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">wirte file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span>: <span style="color:#ae81ff">group1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">blockinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">block</span>: <span style="color:#e6db74">&#39;this is first line&#39;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">modify file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span>: <span style="color:#ae81ff">group1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lineinfile</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">regexp</span>: <span style="color:#e6db74">&#39;(.*)first(.*)&#39;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">line</span>: <span style="color:#ae81ff">\1\2</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">backrefs</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><h5 id="基本语法tags">基本语法tags</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">touch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">notify</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">group1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ping</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ping</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tags</span>: <span style="color:#ae81ff">tag_ping</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">handlers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">wirte file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span>: <span style="color:#ae81ff">group1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">blockinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">block</span>: <span style="color:#e6db74">&#39;this is first line&#39;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">modify file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span>: <span style="color:#ae81ff">group1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lineinfile</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">regexp</span>: <span style="color:#e6db74">&#39;(.*)first(.*)&#39;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">line</span>: <span style="color:#ae81ff">\1\2</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">backrefs</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查看有哪些tag</span>
</span></span><span style="display:flex;"><span>ansible-playbook --list-tags /etc/ansible/play.yml
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> ansible-playbook --tags<span style="color:#f92672">=</span>tag_ping /etc/ansible/play.yml
</span></span><span style="display:flex;"><span>ansible-playbook --skip-tags<span style="color:#f92672">=</span>tag_ping /etc/ansible/play.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有任务都不会被执行</span>
</span></span><span style="display:flex;"><span>ansible-playbook --skip-tags all /etc/ansible/play.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>ansible-playbook --tags tagged /etc/ansible/play.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>ansible-playbook --tags untagged /etc/ansible/play.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># always 默认执行，除非明确指定--skip-tags</span>
</span></span><span style="display:flex;"><span>ansible-playbook --skip-tags always /etc/ansible/play.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># never 在不明确指定的情况下默认不执行</span>
</span></span><span style="display:flex;"><span>ansible-playbook --tags never /etc/ansible/play.yml
</span></span></code></pre></div><h5 id="循环"><strong>循环</strong></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ item }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">with_items</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">first line</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">second line</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 带索引的列表</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{item.1}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">with_indexed_items</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">first line</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">second line</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># range(1,10,3)</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ item }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">with_sequence</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">start=1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">end=10</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">stride=3</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ item.name }}{{ item.age }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">with_items</span>:
</span></span><span style="display:flex;"><span>    - {<span style="color:#f92672">name: wangendao,age</span>: <span style="color:#ae81ff">31</span>}
</span></span><span style="display:flex;"><span>    - {<span style="color:#f92672">name: zhangsan,age</span>: <span style="color:#ae81ff">18</span>}
</span></span></code></pre></div><h5 id="判断"><strong>判断</strong></h5>
<ul>
<li><strong>when</strong></li>
</ul>
<pre tabindex="0"><code class="language-jinja2" data-lang="jinja2">- hosts:
  - all
  tasks:
  - debug:
    msg: &#34;{{ansible_hostname}}&#34;
    when:
    # 可以使系统变量或自定义变量
      ansible_hostname == &#34;hdss7-200&#34;
</code></pre><h5 id="变量">变量</h5>
<p><strong>一、系统变量：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># cpu  核心数</span>
</span></span><span style="display:flex;"><span>ansible_processor_vcpus
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 主机名</span>
</span></span><span style="display:flex;"><span>ansible_hostname
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ip</span>
</span></span><span style="display:flex;"><span>ansible_host
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 内存</span>
</span></span><span style="display:flex;"><span>ansible_memtotal_mb
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ansible的版本信息</span>
</span></span><span style="display:flex;"><span>ansible_version
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ansible-play 1.yml --list-host</span>
</span></span><span style="display:flex;"><span>play_hosts
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>groups
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 系统发行版</span>
</span></span><span style="display:flex;"><span>ansible_distribution
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 系统版本号</span>
</span></span><span style="display:flex;"><span>ansible_distribution_major_version 
</span></span></code></pre></div><p>二、用户自定义变量</p>
<p>在资产清单中定义</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># /etc/ansible/hosts</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">all</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">10.4.7.11</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">wangendao</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">10.4.7.12</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">10.4.7.200</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ansible_ssh_user</span>: <span style="color:#ae81ff">root </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ansible_ssh_pass</span>: <span style="color:#ae81ff">123</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">k8s_node</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">10.4.7.21</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">10.4.7.22</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ansible_ssh_user</span>: <span style="color:#ae81ff">root </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ansible_ssh_pass</span>: <span style="color:#ae81ff">123</span>
</span></span></code></pre></div><ul>
<li>
<p>主机变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[atlanta]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host1 http_port</span><span style="color:#f92672">=</span><span style="color:#e6db74">80 maxRequestsPerChild=808</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host2 http_port</span><span style="color:#f92672">=</span><span style="color:#e6db74">303 maxRequestsPerChild=909</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">all</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">atlanta</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">host1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">http_port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">maxRequestsPerChild</span>: <span style="color:#ae81ff">808</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">host2</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">http_port</span>: <span style="color:#ae81ff">303</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">maxRequestsPerChild</span>: <span style="color:#ae81ff">909</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[targets]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指定连接方式</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">localhost              ansible_connection</span><span style="color:#f92672">=</span><span style="color:#e6db74">local</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">other1.example.com     ansible_connection</span><span style="color:#f92672">=</span><span style="color:#e6db74">ssh        ansible_user=myuser</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">other2.example.com     ansible_connection</span><span style="color:#f92672">=</span><span style="color:#e6db74">ssh        ansible_user=myotheruser</span>
</span></span></code></pre></div><p>此外还可以在<code>/etc/ansible/host_vars/主机名</code> 举例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /etc/ansible/host_vars/localhost &lt;&lt;EOF
</span></span><span style="display:flex;"><span>username<span style="color:#f92672">=</span>admin
</span></span><span style="display:flex;"><span>passwd<span style="color:#f92672">=</span><span style="color:#ae81ff">123</span>
</span></span></code></pre></div></li>
<li>
<p>组变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[atlanta]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[atlanta:vars]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ntp_server</span><span style="color:#f92672">=</span><span style="color:#e6db74">ntp.atlanta.example.com</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">proxy</span><span style="color:#f92672">=</span><span style="color:#e6db74">proxy.atlanta.example.com</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">all</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">atlanta</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host2</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ntp_server</span>: <span style="color:#ae81ff">ntp.atlanta.example.com</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy</span>: <span style="color:#ae81ff">proxy.atlanta.example.com</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[atlanta]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[raleigh]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[southeast:children]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">atlanta</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">raleigh</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[southeast:vars]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">some_server</span><span style="color:#f92672">=</span><span style="color:#e6db74">foo.southeast.example.com</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">halon_system_timeout</span><span style="color:#f92672">=</span><span style="color:#e6db74">30</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">self_destruct_countdown</span><span style="color:#f92672">=</span><span style="color:#e6db74">60</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">escape_pods</span><span style="color:#f92672">=</span><span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[usa:children]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">southeast</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">northeast</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">southwest</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">northwest</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">all</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">usa</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">southeast</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">atlanta</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">host1</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">host2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">raleigh</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">host2</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">host3</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">some_server</span>: <span style="color:#ae81ff">foo.southeast.example.com</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">halon_system_timeout</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">self_destruct_countdown</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">escape_pods</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">northeast</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">northwest</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">southwest</span>:
</span></span></code></pre></div><p>此外还可以在<code>/etc/ansible/group_vars/分组名称/...</code> 举例：</p>
<p>ini格式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">tee /etc/ansible/group_vars/db &lt;&lt;EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">username</span><span style="color:#f92672">=</span><span style="color:#e6db74">root</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">passwd</span><span style="color:#f92672">=</span><span style="color:#e6db74">123</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EOF</span>
</span></span></code></pre></div><p>yaml格式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">tee /etc/ansible/group_vars/db &lt;&lt;EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">username</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">passwd</span>: <span style="color:#ae81ff">123</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>指定别名</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">jumper ansible_port</span><span style="color:#f92672">=</span><span style="color:#e6db74">5555 ansible_host=192.0.2.50</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">all</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jumper</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ansible_port</span>: <span style="color:#ae81ff">5555</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ansible_host</span>: <span style="color:#ae81ff">192.0.2.50</span>
</span></span></code></pre></div></li>
</ul>
<p>playbook中定义</p>
<p>书写方式一：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">127.0.0.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">info</span>: {<span style="color:#f92672">&#39;name&#39;</span>: <span style="color:#ae81ff">wangendao,&#39;age&#39;:31}</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">filename</span>: <span style="color:#ae81ff">f1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/{{filename}}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">touch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tags</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;name: {{ info.name }} age: {{ info.age }}&#34;</span>
</span></span></code></pre></div><p>书写方式二：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># vars.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">wangendao</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">age</span>: <span style="color:#ae81ff">31</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars_files</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">vars.yml</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ name }}{{age}}&#34;</span>
</span></span></code></pre></div><p>书写方式三：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 接收键盘输入</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">127.0.0.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars_prompt</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;name&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prompt</span>: <span style="color:#e6db74">&#34;please input your name: &#34;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># 显示输入的信息，默认隐藏</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">private</span>: <span style="color:#66d9ef">no</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;age&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prompt</span>: <span style="color:#e6db74">&#34;please input your age: &#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 显示输入的信息，默认隐藏</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">private</span>: <span style="color:#66d9ef">no</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ name }} {{ age }}&#34;</span>
</span></span></code></pre></div><p>书写方式四：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">127.0.0.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ name }}&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-e ,--extra-vars
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible-playbook  /etc/ansible/play_vars.yml  --extra-vars <span style="color:#e6db74">&#34;name=wangendao&#34;</span>
</span></span><span style="display:flex;"><span>ansible-playbook  /etc/ansible/play_vars.yml  -e <span style="color:#e6db74">&#34;name=wangendao&#34;</span>
</span></span></code></pre></div><p><strong>变量注册</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">127.0.0.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">info</span>: {<span style="color:#f92672">&#39;name&#39;</span>: <span style="color:#ae81ff">wangendao,&#39;age&#39;:31}</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">filename</span>: <span style="color:#ae81ff">f1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/{{filename}}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">touch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 把 touch file 的执行结果保存到变量AAA 中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">register</span>: <span style="color:#ae81ff">AAAA</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tags</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;name: {{ info.name }} age: {{ info.age }} {{ AAAA }}&#34;</span>
</span></span></code></pre></div><h3 id="roles">roles</h3>
<p>下载roles的方法</p>
<ol>
<li>
<p>ansible-galaxy install</p>
<ul>
<li>roles</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>roles
</span></span><span style="display:flex;"><span>  |- nginx
</span></span><span style="display:flex;"><span>	|- tasks
</span></span><span style="display:flex;"><span>		|- 定义任务列表
</span></span><span style="display:flex;"><span>    |- handler
</span></span><span style="display:flex;"><span>    	|- main.yml	定义handlers
</span></span><span style="display:flex;"><span>    |- vars
</span></span><span style="display:flex;"><span>    	|- main.yml	定义变量
</span></span><span style="display:flex;"><span>    |- templates
</span></span><span style="display:flex;"><span>    |- files
</span></span><span style="display:flex;"><span>    |- meta
</span></span><span style="display:flex;"><span>    	|- main.yml 作者、版本信息
</span></span><span style="display:flex;"><span>    |- defaults
</span></span><span style="display:flex;"><span>    	|- main.yml 定义变量的初始值
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 在/tmp 下创建一个标准的roles目录结构</span>
</span></span><span style="display:flex;"><span>ansible-galaxy init /tmp/nginx
</span></span></code></pre></div><p>从互联网 现在roles</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查找仓库中的role</span>
</span></span><span style="display:flex;"><span>ansible-galaxy search <span style="color:#e6db74">&#34;k8s&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看仓库中role信息</span>
</span></span><span style="display:flex;"><span>ansible-galaxy info 24_komal.ec2_k8s_master
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 下载到/tmp/roles下</span>
</span></span><span style="display:flex;"><span>ansible-galaxy install 24_komal.ec2_k8s_master -p /tmp/roles
</span></span></code></pre></div></li>
<li>
<p>通过requirements.yml 文件下载</p>
<p>requiremets.yml的格式如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 从galaxy 官网下载http://galaxy.ansible.com/</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">src</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从git下载</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">src</span>: <span style="color:#ae81ff">http://github.com/xxx/xxx.git</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scm</span>: <span style="color:#ae81ff">git</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">56200a54</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-acme</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 把roles 打包成tar.gz 上传到自检的http服务器后，要想从这个http服务器下载</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">src</span>: <span style="color:#ae81ff">http://127.0.0.1/my.tar.gz</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="二进制命令">二进制命令</h3>
<p><span id=command><strong>二进制命令</strong></span ></p>
<table>
  <thead>
      <tr>
          <th>名称</th>
          <th>功能</th>
          <th>举例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>ansible</td>
          <td>用于临时执行命令</td>
          <td><code>ansible all -m ping</code></td>
      </tr>
      <tr>
          <td>ansible-console</td>
          <td>交互式命令</td>
          <td></td>
      </tr>
      <tr>
          <td>ansible-vault</td>
          <td>由于文件加密和解密</td>
          <td></td>
      </tr>
      <tr>
          <td>ansible-galaxy</td>
          <td>用于和roles仓库交互</td>
          <td><code>ansible-galaxy  init</code></td>
      </tr>
      <tr>
          <td>ansible-playbook</td>
          <td>用于运行playbook</td>
          <td></td>
      </tr>
      <tr>
          <td>ansible-doc</td>
          <td>查询帮助</td>
          <td><code>ansible-doc -l</code><br/>ansible-doc -s ping</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 加密 yml</span>
</span></span><span style="display:flex;"><span>bash-4.4# ansible-vault encrypt /etc/ansible/play1.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看加密的 yml</span>
</span></span><span style="display:flex;"><span>bash-4.4# ansible-vault view /etc/ansible/play1.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 编辑加密的 yml</span>
</span></span><span style="display:flex;"><span>bash-4.4# ansible-vault edit /etc/ansible/play1.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改加密的密码</span>
</span></span><span style="display:flex;"><span>bash-4.4# ansible-vault rekey /etc/ansible/play1.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解密 yml</span>
</span></span><span style="display:flex;"><span>bash-4.4# ansible-vault decrypt /etc/ansible/play1.yml
</span></span></code></pre></div><h3 id="参考">参考</h3>
<p><a href="https://docs.ansible.com/ansible/latest/index.html" target="_blank"><em>官方文档</em></a></p>
<p><a href="http://www.ansible.com.cn/" target="_blank">Ansible中文权威指南- 国内最专业的Ansible中文官方学习手册</a></p>
<p><a href="https://galaxy.ansible.com/nn708/openwrt" target="_blank">Ansible Galaxy</a></p>
<p><a href="https://www.cnblogs.com/michael-xiang/p/10462749.html" target="_blank">https://www.cnblogs.com/michael-xiang/p/10462749.html</a>)</p>
<p><a href="http://docs.jinkan.org/docs/jinja2/" target="_blank">欢迎来到 Jinja2 — Jinja2 2.7 documentation (jinkan.org)</a></p>
<p>[yaml官网](</p>

</div>





    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-00c869c8082cb1d3aca423fe64068b59">5.7.2 - </h1>
    
	<!-- 添加状态显示区域 -->
<div id="status" style="padding: 10px; text-align: center; font-weight: bold;"></div>
<img id="video" style="max-width: 100%; margin: 0 auto; display: block;" />

<script>
const statusElement = document.getElementById('status');
const audioContext = new (window.AudioContext || window.webkitAudioContext)(); // 新增：音频上下文
let ws;
let reconnectTimeout;
const RECONNECT_DELAY = 5000; // 5秒重连间隔

function updateStatus(text, color) {
    statusElement.textContent = text;
    statusElement.style.backgroundColor = color;
}

function connectWebSocket() {
    // 清除之前的重连计时器（避免重复连接）
    clearTimeout(reconnectTimeout);
    
    ws = new WebSocket('ws://100.64.0.3:9000/ws');
    ws.binaryType = 'arraybuffer';

    // 连接建立时
    ws.onopen = () => {
        updateStatus('已连接到视频流', '#dff0d8'); // 绿色背景
    };

    // 接收视频帧时
    ws.onmessage = (event) => {
        const data = new Uint8Array(event.data);
        const type = data[0];
        const payload = data.slice(1);

        if (type === 0) { // 视频处理保持不变
            const img = document.getElementById('video');
            if (img.src) URL.revokeObjectURL(img.src);
            const blob = new Blob([payload], { type: 'image/jpeg' });
            img.src = URL.createObjectURL(blob);
        } else if (type === 1) { // 音频处理修改为手动创建AudioBuffer
            // 将Uint8Array转换为Int16Array（匹配后端paInt16格式）
            const pcmData = new Int16Array(payload.buffer);
            
            // 创建AudioBuffer（参数需与后端采样率/通道数一致）
            const audioBuffer = audioContext.createBuffer(
                1,                 // 单声道（与后端channels=1一致）
                pcmData.length,    // 数据长度
                44100              // 采样率44.1kHz（与后端rate=44100一致）
            );
            
            // 将PCM数据复制到AudioBuffer通道
            audioBuffer.copyToChannel(pcmData, 0);
            
            // 播放音频
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start(0);
        }
    };

    // 连接错误时
    ws.onerror = (error) => {
        updateStatus('连接错误，正在尝试重连...', '#f2dede'); // 红色背景
        ws.close();
        reconnectTimeout = setTimeout(connectWebSocket, RECONNECT_DELAY);
    };

    // 连接关闭时（正常或异常）
    ws.onclose = (event) => {
        if (!event.wasClean) { // 非正常关闭时触发重连
            updateStatus('连接断开，正在尝试重连...', '#fcf8e3'); // 黄色背景
            reconnectTimeout = setTimeout(connectWebSocket, RECONNECT_DELAY);
        }
    };
}

// 初始连接
updateStatus('正在连接视频流...', '#d9edf7'); // 蓝色背景
connectWebSocket();
</script>

</div>



    
	
  

    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-105501b93b0496b7fd5cf9a548940557"></h1>
	<div class="lead">编程语言</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-09" class="text-body-secondary">Friday, May 09, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-2315d804757b4b950277d941c6c9be8b"></h1>
	<div class="lead">golang 文档中心</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-09" class="text-body-secondary">Friday, May 09, 2025</time>
        
	</div>
	<h3 id="简介">简介</h3>
<p>Go 语言最初由谷歌公司的 Robert Griesemer、Ken Thompson 和 Rob Pike 于 2007年开始设计发明</p>
<h3 id="开发环境安装">开发环境安装</h3>
<h3 id="数据类型">数据类型</h3>
<p>基本数据类型： int/float  、string 、bool</p>
<p>复合数据类型：指针、数组、切片、集合、结构体、接口、channel、函数</p>
<h3 id="流程控制语句">流程控制语句</h3>
<p>if、swith、for 、goto</p>
<h3 id="包">包</h3>
<p>社区通用项目结构</p>
<p>常用的包</p>
<h3 id="并发编程">并发编程</h3>
<h3 id="框架">框架</h3>

</div>





    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2ac805f1e67dfbdedfce89008160b3b8">6.1.1 - 环境安装</h1>
    <div class="lead">go|开发环境</div>
	<h3 id="windows环境安装">windows环境安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>GO111MODULE<span style="color:#f92672">=</span>on
</span></span><span style="display:flex;"><span>GOPATH<span style="color:#f92672">=</span>d:<span style="color:#ae81ff">\g</span>opath
</span></span><span style="display:flex;"><span>GOPROXY<span style="color:#f92672">=</span>https://goproxy.cn
</span></span><span style="display:flex;"><span>GOROOT<span style="color:#f92672">=</span>D:<span style="color:#ae81ff">\g</span>o
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>go version
</span></span><span style="display:flex;"><span>go env
</span></span></code></pre></div><h3 id="在linux环境安装">在linux环境安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># centos 启动桌面环境</span>
</span></span><span style="display:flex;"><span>yum groupinstall <span style="color:#e6db74">&#34;X Window System&#34;</span>
</span></span><span style="display:flex;"><span>yum groupinstall -y <span style="color:#e6db74">&#34;GNOME Desktop&#34;</span>
</span></span><span style="display:flex;"><span>init <span style="color:#ae81ff">5</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ubuntu server 启动桌面环境</span>
</span></span><span style="display:flex;"><span>sudo apt install ubuntu-desktop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>init <span style="color:#ae81ff">5</span>
</span></span></code></pre></div><p>安装golang</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#https://studygolang.com/dl</span>
</span></span><span style="display:flex;"><span>wget https://golang.google.cn/dl/go1.19.6.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar xf go1.19.6.linux-amd64.tar.gz -C /opt/
</span></span><span style="display:flex;"><span>mkdir /home/pc/golang -p
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@golang:~# ls /opt/go/
</span></span><span style="display:flex;"><span>api  codereview.cfg   doc  LICENSE  PATENTS  README.md    src   VERSION
</span></span><span style="display:flex;"><span>bin  CONTRIBUTING.md  lib  misc     pkg      SECURITY.md  test
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;&gt;/etc/profile <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export GOROOT=/opt/go
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export GOPATH=/opt/gopath
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=\$GOROOT/bin:$PATH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export GO111MODULE=&#34;on&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export GOPROXY=&#34;https://goproxy.cn&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>source /etc/profile
</span></span><span style="display:flex;"><span>go version
</span></span><span style="display:flex;"><span>go env
</span></span></code></pre></div><p>安装vscode</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>https://vscode.download.prss.microsoft.com/dbazure/download/stable/019f4d1419fbc8219a181fab7892ebccf7ee29a2/code-stable-x64-1709077346.tar.gz
</span></span></code></pre></div><p>启动vscode</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/VSCode-linux-x64/code --no-sandbox
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
</span></span><span style="display:flex;"><span>sudo sh -c <span style="color:#e6db74">&#39;echo -e &#34;[code]\nname=Visual Studio Code\nbaseurl=https://packages.microsoft.com/yumrepos/vscode\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc&#34; &gt; /etc/yum.repos.d/vscode.repo&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>yum check-update
</span></span><span style="display:flex;"><span>sudo yum install code
</span></span></code></pre></div><p>vscode golang插件安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ctrl + shift + p 
</span></span><span style="display:flex;"><span>输入 install/Update Tools
</span></span><span style="display:flex;"><span>选择所有提示安装的插件
</span></span></code></pre></div><h3 id="demo">demo</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p lvminfo/<span style="color:#f92672">{</span>utils,cmd<span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>go mod init wangendao.com/lvminfo
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvminfo/
</span></span><span style="display:flex;"><span>├── cmd
</span></span><span style="display:flex;"><span>│   └── main.go		<span style="color:#75715e"># 入口文件</span>
</span></span><span style="display:flex;"><span>├── go.mod
</span></span><span style="display:flex;"><span>└── utils			<span style="color:#75715e"># 内部包存放目录</span>
</span></span><span style="display:flex;"><span>    └── getinfo.go
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// utils/getinfo.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">utils</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;os/exec&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Getlvinfo</span>() []<span style="color:#66d9ef">byte</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lvs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;lvs&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lvs</span>.<span style="color:#a6e22e">Output</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// cmd/main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;wangendao.com/lvminfo/utils&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">Getlvinfo</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">a</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f94ce343fdb329b17c4daf205f56cd67">6.1.2 - 常量和变量</h1>
    <div class="lead">go|常量和变量</div>
	
  
  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>单引号，双引号，反引号</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="区别" aria-controls="tabs-00-01" aria-selected="true">
        区别
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="示例" aria-controls="tabs-00-02" aria-selected="false">
        示例
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <table>
  <thead>
      <tr>
          <th style="text-align: left">写法</th>
          <th style="text-align: left">类型</th>
          <th style="text-align: left">转义</th>
          <th style="text-align: left">多字符</th>
          <th style="text-align: left">跨行</th>
          <th style="text-align: left">典型用途</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><code>'a'</code></td>
          <td style="text-align: left">rune</td>
          <td style="text-align: left">❌</td>
          <td style="text-align: left">❌</td>
          <td style="text-align: left">❌</td>
          <td style="text-align: left">单个字符、码点运算,类型是 rune（int32 别名）；</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>&quot;abc&quot;</code></td>
          <td style="text-align: left">string</td>
          <td style="text-align: left">✅</td>
          <td style="text-align: left">✅</td>
          <td style="text-align: left">❌</td>
          <td style="text-align: left">普通字符串</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>raw</code></td>
          <td style="text-align: left">string</td>
          <td style="text-align: left">❌</td>
          <td style="text-align: left">✅</td>
          <td style="text-align: left">✅</td>
          <td style="text-align: left">正则/SQL/模板</td>
      </tr>
  </tbody>
</table>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ch</span> <span style="color:#66d9ef">rune</span> = <span style="color:#e6db74">&#39;中&#39;</span>   <span style="color:#75715e">// 正确，字符字面量，类型是 rune（int32 别名）</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">var s string = &#34;hello\n世界&#34;   // 支持转义：\n \t \u4e2d 等</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">sql := `</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SELECT</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">user</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WHERE</span> <span style="color:#a6e22e">id</span> = <span style="color:#960050;background-color:#1e0010">?</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">`</span>
</span></span></code></pre></div>
    </div>
</div>

<h3 id="常量">常量</h3>
<p>常量(constant)声明格式:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> &lt;<span style="color:#a6e22e">name</span>&gt; [<span style="color:#66d9ef">type</span>] = &lt;<span style="color:#a6e22e">value</span>&gt;
</span></span></code></pre></div><ul>
<li><code>const</code> 是关键字固定不变，表示声明了一个常量</li>
<li><code>&lt;name&gt;</code> 是常量的名称</li>
<li><code>[type]</code>该常量存储的数据类型，可省略。<font color=red>constant 仅支持基本数据类型(bool, 数字类型，string)</font>。</li>
<li><code>value</code> 常量赋值</li>
</ul>
<p>举例:</p>
<ul>
<li>
<p>单一常量声明</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 单一常量声明</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">spring</span> <span style="color:#66d9ef">int8</span> = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">summer</span> = <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;spring = %d \nsummer = %d \n&#34;</span>, <span style="color:#a6e22e">spring</span>, <span style="color:#a6e22e">summer</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>批量声明常量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 批量声明常量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">spring</span> <span style="color:#66d9ef">int8</span> = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">summer</span>      = <span style="color:#e6db74">&#34;2&#34;</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;spring = %d \nsummer = %s \n&#34;</span>, <span style="color:#a6e22e">spring</span>, <span style="color:#a6e22e">summer</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>iota为常量连续增1赋值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// iota 连续增量复制</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">spring</span> <span style="color:#66d9ef">int8</span> = <span style="color:#66d9ef">iota</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">summer</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">autumn</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">winter</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;spring = %d \nsummer = %d \nautumn = %d\nwinter = %d\n&#34;</span>, <span style="color:#a6e22e">spring</span>, <span style="color:#a6e22e">summer</span>, <span style="color:#a6e22e">autumn</span>, <span style="color:#a6e22e">winter</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h3 id="变量">变量</h3>
<p>变量(variable)声明格式:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> &lt;<span style="color:#a6e22e">name</span>&gt; [<span style="color:#66d9ef">type</span>] = [<span style="color:#a6e22e">expression</span>]
</span></span></code></pre></div><ul>
<li><code>var</code> 为关键字表明声明一个变量</li>
<li><code>&lt;name&gt;</code> 变量名称</li>
<li><code>[type]</code> 变量类型，可省略</li>
<li><code>[expression]</code> 赋值，可省略（不能与【type】一起省略）</li>
</ul>
<p>举例：</p>
<ul>
<li>
<p>单一变量声明</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 先声明后赋值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;张三&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 类型推断</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">age</span> = <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 简短声明，只能在函数内部声明</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">message</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">`人生没有最晚，只有更晚`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;我的名字叫 %s\n我%d岁开始学习golang\n%s\n&#34;</span>, <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">age</span>, <span style="color:#a6e22e">message</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>批量声明变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 批量声明，数据类型相同的变量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">spring</span>, <span style="color:#a6e22e">summer</span>, <span style="color:#a6e22e">autumn</span>, <span style="color:#a6e22e">winter</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">spring</span> = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;spring -- %d\nsummer -- %d\n autumn -- %d\nwinter -- %d&#34;</span>, <span style="color:#a6e22e">spring</span>, <span style="color:#a6e22e">summer</span>, <span style="color:#a6e22e">autumn</span>, <span style="color:#a6e22e">winter</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 批量声明</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">name</span>    <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">age</span>     <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">address</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;张三&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">age</span> = <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">address</span> = <span style="color:#e6db74">&#34;中国深圳&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s,今年%d,来自%s\n&#34;</span>, <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">age</span>, <span style="color:#a6e22e">address</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>全局变量和局部变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 全局变量必须使用 var 声明，如果想要在其他包中引用首字母必须大写</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">Age</span> = <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Age</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d\n&#34;</span>, <span style="color:#a6e22e">Age</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d5a19957c069c59ca70f1703d5db4d3a">6.1.3 - 数据类型</h1>
    <div class="lead">go|数据类型</div>
	<p>golang 中数据类型分为基本数据类型和复合数据类型，常量只能使用基本数据类型，变量可以使用全部数据类型。</p>
<h3 id="基本数据类型">基本数据类型</h3>


  
  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="数值型" aria-controls="tabs-00-00" aria-selected="true">
        数值型
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="字符串" aria-controls="tabs-00-01" aria-selected="false">
        字符串
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="布尔型" aria-controls="tabs-00-02" aria-selected="false">
        布尔型
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <blockquote>
<p>按照取值范围可以分为：<code>int</code>,<code>int8</code>, <code>int16</code> ,<code>int32</code> <code>int64</code>,<code>uint</code>,<code>uint8</code> <code>uint16</code> ,<code>uint32</code>, <code>uint64</code> ,<code>float32</code>,<code>float64</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">weigh</span>, <span style="color:#a6e22e">price</span> <span style="color:#66d9ef">float32</span> = <span style="color:#ae81ff">100.1</span>, <span style="color:#ae81ff">9.99</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// %T 查看数据类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;数据类型：%T\n数据类型：%T\n&#34;</span>, <span style="color:#a6e22e">weigh</span>, <span style="color:#a6e22e">price</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <p>获取字符串长度和字符串切片</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// len 获取字符串长度</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">message</span> = <span style="color:#e6db74">`相对于技术革新的速度，
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	人性数千年的变换却是渺小的`</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s\n占用%dbytes\n&#34;</span>, <span style="color:#a6e22e">message</span>, len(<span style="color:#a6e22e">message</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 字符串切片，一个汉字占用3个字符</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// substr := message[:]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// substr := message[0]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">substr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">message</span>[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s\n&#34;</span>, <span style="color:#a6e22e">substr</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <blockquote>
<p>bool 数据类型取值范围 <code>true</code> 和 <code>false</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">overall</span> <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">overall</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;数据类型：%T\n&#34;</span>, <span style="color:#a6e22e">overall</span>) <span style="color:#75715e">//数据类型：bool</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
</div>

<h3 id="复合数据类型">复合数据类型</h3>


  

  

  

  

  

  

<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="指针 pointer" aria-controls="tabs-01-00" aria-selected="true">
        指针 pointer
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="数组 arrary" aria-controls="tabs-01-01" aria-selected="false">
        数组 arrary
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="切片 slice" aria-controls="tabs-01-02" aria-selected="false">
        切片 slice
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="集合 map" aria-controls="tabs-01-03" aria-selected="false">
        集合 map
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-04" role="tab"
          data-td-tp-persist="结构体 struct" aria-controls="tabs-01-04" aria-selected="false">
        结构体 struct
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-05-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-05" role="tab"
          data-td-tp-persist="接口 interface" aria-controls="tabs-01-05" aria-selected="false">
        接口 interface
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <p>指针保存了变量的内存地址，可以是<code> *int *float64 *bool *string</code></p>
<p>指针类型变量声明:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> &lt;<span style="color:#a6e22e">name</span>&gt; <span style="color:#f92672">*</span>[<span style="color:#66d9ef">type</span>] = [<span style="color:#a6e22e">value</span>]
</span></span></code></pre></div><ul>
<li><code>var</code> 关键字，表示声明一个变量</li>
<li><code>&lt;name&gt;</code> 变量名称</li>
<li><code>*[type]</code>  type为引用的数据类型</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">age</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">Age</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">age</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;数据类型：%T\n变量中存储的值:%d\n变量内存引用的值：%d\n&#34;</span>, <span style="color:#a6e22e">Age</span>, <span style="color:#a6e22e">Age</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">Age</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	数据类型：*int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 变量中存储的值:824634916864</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 变量内存引用的值：32</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>空指针</p>
<blockquote>
<p>只声明未赋值的指针成为空指针,编码过程中避免出现空指针</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 只声明未赋值的指针成为空指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">Age</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">Age</span>) <span style="color:#75715e">//nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">Age</span>) <span style="color:#75715e">//&lt;nil&gt;panic: runtime error: invalid memory address or nil pointer dereference</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <p>存放相同数据类型的集合，长度相对固定，有序</p>
<p>声明语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> &lt;<span style="color:#a6e22e">name</span>&gt; [<span style="color:#a6e22e">size</span>]<span style="color:#66d9ef">type</span>
</span></span></code></pre></div><ul>
<li><code>var</code> 关键字，表示声明一个变量</li>
<li><code>&lt;name&gt;</code> 变量名称</li>
<li><code>[size]string</code>  指定数据元素<code>size</code>,元素类型为 <code>type</code>等</li>
</ul>
<p>示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 数值的特征： 存放相同类型，有序，定长</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 定义数组 var &lt;name&gt; [size]string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang</span> [<span style="color:#ae81ff">3</span>]<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">0</span>] = <span style="color:#e6db74">&#34;python&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">1</span>] = <span style="color:#e6db74">&#34;go&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">2</span>] = <span style="color:#e6db74">&#34;java&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;数据类型：%T\n存储的值：%s\n数组长度%d\n&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">lang</span>, <span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">0</span>], len(<span style="color:#a6e22e">lang</span>),
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 定义并赋值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang1</span> = [<span style="color:#ae81ff">3</span>]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;python&#34;</span>, <span style="color:#e6db74">&#34;go&#34;</span>, <span style="color:#e6db74">&#34;java&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;数据类型：%T\n存储的值：%s\n数组长度%d\n&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">lang1</span>, <span style="color:#a6e22e">lang1</span>[<span style="color:#ae81ff">0</span>], len(<span style="color:#a6e22e">lang1</span>),
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 简短定义并赋值，只能在函数里使用</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang2</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">3</span>]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;python&#34;</span>, <span style="color:#e6db74">&#34;go&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;数据类型：%T\n存储的值：%s\n数组长度%d\n&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">lang2</span>, <span style="color:#a6e22e">lang2</span>, len(<span style="color:#a6e22e">lang2</span>),
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 定义不定长数组</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang3</span> <span style="color:#f92672">:=</span> [<span style="color:#f92672">...</span>]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;python&#34;</span>, <span style="color:#e6db74">&#34;go&#34;</span>, <span style="color:#e6db74">&#34;java&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;数据类型：%T\n存储的值：%s\n数组长度%d\n&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">lang3</span>, <span style="color:#a6e22e">lang3</span>, len(<span style="color:#a6e22e">lang3</span>),
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; len(<span style="color:#a6e22e">lang3</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d -- %s\n&#34;</span>, <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">lang3</span>[<span style="color:#a6e22e">i</span>])
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>指针类型的数组</p>
<blockquote>
<p>存放一种类型数据的指针</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang</span> [<span style="color:#ae81ff">3</span>]<span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;python&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">0</span>] = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">a</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;数据类型：%T\n存储的值：%s\n&#34;</span>, <span style="color:#a6e22e">lang</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 数据类型：[3]*string</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 存储的值：python</span>
</span></span></code></pre></div><p>使用new 创建 <em>数组指针</em></p>
<blockquote>
<p>定义了一个 数组类型 的指针，这一部分应该放在指针章节</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang</span> = new([<span style="color:#ae81ff">20</span>]<span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">10</span>] = <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;数据类型：%T\n存储的值：%d\n&#34;</span>, <span style="color:#a6e22e">lang</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">lang</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// root@master01:/home/pc/Desktop/test# go run .</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 数据类型：*[20]int</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 存储的值：[0 0 0 0 0 0 0 0 0 0 100 0 0 0 0 0 0 0 0 0]</span>
</span></span></code></pre></div><p>多维数组</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 语法  var &lt;name&gt; [外层size][内层size]type</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 多为数组 [[python php perl] [c go java]]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang</span> [<span style="color:#ae81ff">2</span>][<span style="color:#ae81ff">3</span>]<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>] = <span style="color:#e6db74">&#34;python&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">1</span>] = <span style="color:#e6db74">&#34;php&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">2</span>] = <span style="color:#e6db74">&#34;perl&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>] = <span style="color:#e6db74">&#34;c&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">1</span>] = <span style="color:#e6db74">&#34;go&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">2</span>] = <span style="color:#e6db74">&#34;java&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">lang</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; len(<span style="color:#a6e22e">lang</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">lang</span>[<span style="color:#a6e22e">i</span>] {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">v</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <p>切片长度可变。又称为动态数组</p>
<p>声明语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> &lt;<span style="color:#a6e22e">name</span>&gt; []<span style="color:#66d9ef">type</span>
</span></span></code></pre></div><ul>
<li><code>var</code> 关键字，表示声明一个变量</li>
<li><code>&lt;name&gt;</code> 变量名称</li>
<li><code>[]type</code>  指定元素数据类型</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang</span> []<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span> = append(<span style="color:#a6e22e">lang</span>, <span style="color:#e6db74">&#34;python&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span> = append(<span style="color:#a6e22e">lang</span>, <span style="color:#e6db74">&#34;go&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;变量类型：%T\n切片元素数量: %d\n切片容量: %d\n变量内容：%s\n&#34;</span>, <span style="color:#a6e22e">lang</span>, len(<span style="color:#a6e22e">lang</span>), cap(<span style="color:#a6e22e">lang</span>), <span style="color:#a6e22e">lang</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 变量类型：[]string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 切片元素数量: 2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 切片容量: 2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 变量内容：[python go]</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>使用make创建切片</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// make(t Type, size ...IntegerType) ,3 切片长度，5 切片容量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang</span> = make([]<span style="color:#66d9ef">string</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 追加两个元素</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span> = append(<span style="color:#a6e22e">lang</span>, <span style="color:#e6db74">&#34;python&#34;</span>, <span style="color:#e6db74">&#34;go&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;数据类型：%T\n切片长度:%d\n切片容量：%d\n变量内容：%s\n最后一个元素: %s\n&#34;</span>, <span style="color:#a6e22e">lang</span>, len(<span style="color:#a6e22e">lang</span>), cap(<span style="color:#a6e22e">lang</span>), <span style="color:#a6e22e">lang</span>, <span style="color:#a6e22e">lang</span>[len(<span style="color:#a6e22e">lang</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 数据类型：[]string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 切片长度:5</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 切片容量：5</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 变量内容：[   python go]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 最后一个元素: go</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">lang</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">k</span>, <span style="color:#e6db74">&#34;--&gt;&#34;</span>, <span style="color:#a6e22e">v</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 0 --&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 1 --&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 2 --&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 3 --&gt; python</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 4 --&gt; go</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>截取数组作为切片</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang</span> = [<span style="color:#ae81ff">5</span>]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;python&#34;</span>, <span style="color:#e6db74">&#34;go&#34;</span>, <span style="color:#e6db74">&#34;c&#34;</span>, <span style="color:#e6db74">&#34;java&#34;</span>, <span style="color:#e6db74">&#34;perl&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">langSlice</span> = <span style="color:#a6e22e">lang</span>[:]
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;数据类型：%T\n切片长度:%d\n切片容量：%d\n变量内容：%s\n&#34;</span>, <span style="color:#a6e22e">langSlice</span>, len(<span style="color:#a6e22e">langSlice</span>), cap(<span style="color:#a6e22e">langSlice</span>), <span style="color:#a6e22e">langSlice</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 数据类型：[]string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 切片长度:5</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 切片容量：5</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 变量内容：[python go c java perl]</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>append()函数</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// append() 函数向切片追加元素</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang</span> = []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;python&#34;</span>, <span style="color:#e6db74">&#34;java&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span> = append(<span style="color:#a6e22e">lang</span>, <span style="color:#e6db74">&#34;go&#34;</span>, <span style="color:#e6db74">&#34;c&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">lang</span>) <span style="color:#75715e">//[python java go c]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 追加一个切片</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span> = append(<span style="color:#a6e22e">lang</span>, []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;sql&#34;</span>, <span style="color:#e6db74">&#34;bash&#34;</span>}<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">lang</span>) <span style="color:#75715e">//[python java go c sql bash]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 像指定位置插入。此过程利用了append的嵌套</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// append([]string{&#34;ruby&#34;}, lang[1:]...) 把lang[:1]切片内容添加到切片[]string{&#34;ruby&#34;}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span> = append(<span style="color:#a6e22e">lang</span>[:<span style="color:#ae81ff">1</span>], append([]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;ruby&#34;</span>}, <span style="color:#a6e22e">lang</span>[<span style="color:#ae81ff">1</span>:]<span style="color:#f92672">...</span>)<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">lang</span>) <span style="color:#75715e">//[python ruby java go c sql bash]</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>copy()函数</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang</span> = []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;python&#34;</span>, <span style="color:#e6db74">&#34;java&#34;</span>, <span style="color:#e6db74">&#34;go&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">langCopy</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">string</span>, len(<span style="color:#a6e22e">lang</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// copy(目标切片，原切片)</span>
</span></span><span style="display:flex;"><span>	copy(<span style="color:#a6e22e">langCopy</span>, <span style="color:#a6e22e">lang</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">langCopy</span>) <span style="color:#75715e">//[python java go]</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <p>存放相同数据类型元素，可变长，无序</p>
<p>声明语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> &lt;<span style="color:#a6e22e">name</span>&gt; <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">keytype</span>]<span style="color:#a6e22e">valuetype</span>
</span></span></code></pre></div><ul>
<li>
<p><code>var</code> 关键字，表示声明一个变量</p>
</li>
<li>
<p><code>&lt;name&gt;</code> 变量名称</p>
</li>
<li>
<p><code>map[keytype]valuetype</code> map 为关键字 <code>[keytype]</code>表示key的数据类型 <code>valuetype</code> 表示value的数据类型</p>
</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// map 声明后并不能直接使用，声明时并没有分配内存地址。因此需要make执行初始化。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>][]<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>][]<span style="color:#66d9ef">string</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#e6db74">&#34;python&#34;</span>] = []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;吉多·范罗苏姆&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#e6db74">&#34;go&#34;</span>] = []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;罗伯特·格瑞史莫&#34;</span>, <span style="color:#e6db74">&#34;罗布·派克&#34;</span>, <span style="color:#e6db74">&#34;肯·汤普逊&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">lang</span>) <span style="color:#75715e">// 打印：map[python:[吉多·范罗苏姆] go:[罗伯特·格瑞史莫 罗布·派克 肯·汤普逊]]</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>声明并初始化</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>][]<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;python&#34;</span>: []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;吉多·范罗苏姆&#34;</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;go&#34;</span>:     []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;罗伯特·格瑞史莫&#34;</span>, <span style="color:#e6db74">&#34;罗布·派克&#34;</span>, <span style="color:#e6db74">&#34;肯·汤普逊&#34;</span>},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">lang</span>) <span style="color:#75715e">//map[go:[罗伯特·格瑞史莫 罗布·派克 肯·汤普逊] python:[吉多·范罗苏姆]]</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>make()</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 集合，存放key value 键值对，类似python中的字典</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>][]<span style="color:#66d9ef">string</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;数据类型：%T\n&#34;</span>, <span style="color:#a6e22e">lang</span>) <span style="color:#75715e">// 数据类型：map[string][]string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#e6db74">&#34;python&#34;</span>] = []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;吉多·范罗苏姆&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lang</span>[<span style="color:#e6db74">&#34;go&#34;</span>] = []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;罗伯特·格瑞史莫&#34;</span>, <span style="color:#e6db74">&#34;罗布·派克&#34;</span>, <span style="color:#e6db74">&#34;肯·汤普逊&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">lang</span>) <span style="color:#75715e">// 打印：map[python:[吉多·范罗苏姆] go:[罗伯特·格瑞史莫 罗布·派克 肯·汤普逊]]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">lang</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s &gt;&gt;&gt; %s\n&#34;</span>, <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// python &gt;&gt;&gt; [吉多·范罗苏姆]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// go &gt;&gt;&gt; [罗伯特·格瑞史莫 罗布·派克 肯·汤普逊]</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>判断key是否存在map中</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lang</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>][]<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;python&#34;</span>: []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;吉多·范罗苏姆&#34;</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;go&#34;</span>:     []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;罗伯特·格瑞史莫&#34;</span>, <span style="color:#e6db74">&#34;罗布·派克&#34;</span>, <span style="color:#e6db74">&#34;肯·汤普逊&#34;</span>},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">keyExist</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lang</span>[<span style="color:#e6db74">&#34;c&#34;</span>];<span style="color:#a6e22e">keyExist</span>{ <span style="color:#75715e">//[] false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">value</span>) 
</span></span><span style="display:flex;"><span>	}<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;不存在&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-04" role="tabpanel" aria-labelled-by="tabs-01-04-tab" tabindex="1">
        <p>声明语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> &lt;<span style="color:#a6e22e">name</span>&gt; <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">filed1</span> <span style="color:#a6e22e">filedtype</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">filed1</span> <span style="color:#a6e22e">filedtype</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>type</code> 关键字</li>
<li><code>&lt;name&gt;</code> 结构体名称，首字符大写表示可以被其他包引用</li>
<li><code>struct</code>表示声明结构体类型</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 约定： 首字符大写表示为可以导出的变量和字段</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Persion</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Name</span>    <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Age</span>     <span style="color:#66d9ef">int8</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Sex</span>     <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Favorit</span> []<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">persion</span> <span style="color:#a6e22e">Persion</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">persion</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;张三&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">persion</span>.<span style="color:#a6e22e">Age</span> = <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">persion</span>.<span style="color:#a6e22e">Sex</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%+v\n%v\n&#34;</span>, <span style="color:#a6e22e">persion</span>, <span style="color:#a6e22e">persion</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// {Name:张三 Age:33 Sex:true Favorit:[]}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// {张三 33 true []}</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><em>示例声明一个alertmanager 告警规则的结构体</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// AlertStatus represents the status of an alert.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AlertStatus</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Status</span>       <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Labels</span>       <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;labels&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Annotations</span>  <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;annotations&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">StartsAt</span>     <span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;startsAt&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">EndsAt</span>       <span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;endsAt&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GeneratorURL</span> <span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;generatorURL&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Fingerprint</span>  <span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;fingerprint&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Alert represents the structure of an alert.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Alert</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Receiver</span>          <span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;receiver&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Status</span>            <span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;status&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Alerts</span>            []<span style="color:#a6e22e">AlertStatus</span>     <span style="color:#e6db74">`json:&#34;alerts&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GroupLabels</span>       <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;groupLabels&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">CommonLabels</span>      <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;commonLabels&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">CommonAnnotations</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;commonAnnotations&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ExternalURL</span>       <span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;externalURL&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Version</span>           <span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;version&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GroupKey</span>          <span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;groupKey&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">TruncatedAlerts</span>   <span style="color:#66d9ef">int</span>               <span style="color:#e6db74">`json:&#34;truncatedAlerts&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// JSON content as a raw string.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">jsonData</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">`{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		&#34;receiver&#34;: &#34;webhook&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		&#34;status&#34;: &#34;firing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		&#34;alerts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				&#34;status&#34;: &#34;firing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				&#34;labels&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					&#34;alertname&#34;: &#34;cpu3&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					&#34;instance&#34;: &#34;localhost:9100&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					&#34;job&#34;: &#34;node_exporter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					&#34;severity&#34;: &#34;warning&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				&#34;annotations&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					&#34;description&#34;: &#34;localhost:9100 of job node_exporter has been used cpu &gt;0 more than 5 minutes. (current value: 44.99%)&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					&#34;summary&#34;: &#34;Instance localhost:9100 cpu usage high&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				&#34;startsAt&#34;: &#34;2024-04-21T09:36:36.26148042Z&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				&#34;endsAt&#34;: &#34;0001-01-01T00:00:00Z&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				&#34;generatorURL&#34;: &#34;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				&#34;fingerprint&#34;: &#34;c4c0776a34942165&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		&#34;groupLabels&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			&#34;alertname&#34;: &#34;cpu3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		&#34;commonLabels&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			&#34;alertname&#34;: &#34;cpu3&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			&#34;instance&#34;: &#34;localhost:9100&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			&#34;job&#34;: &#34;node_exporter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			&#34;severity&#34;: &#34;warning&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		&#34;commonAnnotations&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			&#34;description&#34;: &#34;localhost:9100 of job node_exporter has been used cpu &gt;0 more than 5 minutes. (current value: 44.99%)&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			&#34;summary&#34;: &#34;Instance localhost:9100 cpu usage high&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		&#34;externalURL&#34;: &#34;http://e7b40e5c9054:9093&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		&#34;version&#34;: &#34;4&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		&#34;groupKey&#34;: &#34;{}:{alertname=\&#34;cpu3\&#34;}&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		&#34;truncatedAlerts&#34;: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Declare a variable of type Alert to hold the unmarshalled data.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">alert</span> <span style="color:#a6e22e">Alert</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Unmarshal the JSON data into the struct.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>([]byte(<span style="color:#a6e22e">jsonData</span>), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">alert</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error unmarshalling JSON:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Print the unmarshalled data.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%+v\n&#34;</span>, <span style="color:#a6e22e">alert</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-05" role="tabpanel" aria-labelled-by="tabs-01-05-tab" tabindex="1">
        
    </div>
</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5410e2027a7d9c13483e14a61fbf2c1c">6.1.4 - 运算符</h1>
    <div class="lead">go|运算符</div>
	<h3 id="运算符">运算符</h3>
<blockquote>
<p>算术运算符中 <code>%</code> 仅仅使用于整数类型，其他符号可用于整数、浮点数、复数的运算</p>
</blockquote>
<table>
    <tr>
        <td>算术运算</td>
        <td>+</td>
        <td>-</td>
        <td>*</td>
        <td>/</td>
        <td>%</td>
        <td>++</td>
        <td>--</td>
    </tr>
    <tr>
        <td>赋值运算</td>
        <td>=</td>
        <td>+=</td>
        <td>-=</td>
        <td>*=</td>
        <td>/=</td>
        <td>%=</td>
        <td></td>
    </tr>
    <tr>
        <td>比较运算</td>
        <td>==</td>
        <td>!=</td>
        <td><</td>
        <td><=</td>
        <td>></td>
        <td>>=</td>
        <td></td>
    </tr>
    <tr>
        <td>逻辑运算</td>
        <td>&&</td>
        <td>||</td>
        <td>!</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>位运算</td>
        <td>&</td>
        <td>|</td>
        <td>^</td>
        <td><<</td>
        <td>>></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>指针运算符</td>
        <td>&</td>
        <td>*</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
</table>
<p>幂运算需要使用math包下的 pow()函数</p>
<ul>
<li>
<p>算术运算符</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 假设一个收银系统</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  重量和单价</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">weigh</span>, <span style="color:#a6e22e">price</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">2.18</span>, <span style="color:#ae81ff">1.99</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 称重去皮</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">weigh</span> <span style="color:#f92672">-=</span> <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 总价</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">total</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">weigh</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">price</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;应付金额：%2.1f\n&#34;</span>, <span style="color:#a6e22e">total</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ca426c14ccbdd2d3e8407c9338804473">6.1.5 - 流程控制语句</h1>
    <div class="lead">go|流程控制语句</div>
	<h3 id="流程控制语句">流程控制语句</h3>
<table>
    <tr>
        <td>if 判断</td>
        <td>switch 判断</td>
        <td>for 循环</td>
        <td>for range</td>
        <td>goto 跳转</td>
    </tr>
</table>
<h4 id="if判断">if判断</h4>
<ul>
<li>
<p>基本if语法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">overall</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">overall</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;当前值为true&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">overall</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;当前值不是true&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>if else</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">overall</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>; <span style="color:#a6e22e">overall</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;你做出了正确的选择&#34;</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;再接再厉&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>if else if</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">score</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">60</span>; <span style="color:#a6e22e">score</span> &lt; <span style="color:#ae81ff">60</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;成绩不及格需要补考&#34;</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">score</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">60</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;恭喜你，你是最幸运的人&#34;</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;恭喜你，你的能力很强&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h4 id="switch">switch</h4>
<ul>
<li>
<p>基本switch 语法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">role</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;other&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">role</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;master&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;我是%s&#34;</span>, <span style="color:#a6e22e">role</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;slave&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;我是%s&#34;</span>, <span style="color:#a6e22e">role</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;unknow&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">role</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;other&#34;</span>; <span style="color:#a6e22e">role</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;master&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;我是%s&#34;</span>, <span style="color:#a6e22e">role</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;slave&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;我是%s&#34;</span>, <span style="color:#a6e22e">role</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;unknow&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">role</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;MASTER&#34;</span>; <span style="color:#a6e22e">role</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;master&#34;</span>, <span style="color:#e6db74">&#34;Master&#34;</span>, <span style="color:#e6db74">&#34;MASTER&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;我是%s&#34;</span>, <span style="color:#a6e22e">role</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;slave&#34;</span>, <span style="color:#e6db74">&#34;Slave&#34;</span>, <span style="color:#e6db74">&#34;SLAVE&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;我是%s&#34;</span>, <span style="color:#a6e22e">role</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;unknow&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>判断条件中包含逻辑运算</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">os</span> <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;Centos&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">release</span> <span style="color:#66d9ef">int</span> = <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">release</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">7</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;centos7&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">release</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">6</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;centos6&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">release</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">5</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;centos5&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">release</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;centos4&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>break 跳出switch</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">os</span> <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;Centos&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">release</span> <span style="color:#66d9ef">int</span> = <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">release</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">7</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;centos7&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;我准备用systemd管理服务&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;我准备用rsyslog记录日志&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">release</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">6</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;centos6&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">release</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">5</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;centos5&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">release</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;centos4&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>fallthrough执行完毕当前case 会执行紧接着的case</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">os</span> <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;Centos&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">release</span> <span style="color:#66d9ef">int</span> = <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">release</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">7</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;centos7&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;我准备用systemd管理服务&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;我准备用rsyslog记录日志&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">fallthrough</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">release</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">6</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;centos6&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;我准备用init管理服务&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;我准备用syslog记录日志&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fallthrough</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">release</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">5</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;centos5&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">release</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;centos4&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h4 id="for-循环">for 循环</h4>
<ul>
<li>
<p>格式1 标准格式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">9</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">i</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d * %d = %d    &#34;</span>, <span style="color:#a6e22e">j</span>, <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span><span style="color:#f92672">*</span><span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>格式2</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">i</span>; {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d * %d = %d    &#34;</span>, <span style="color:#a6e22e">j</span>, <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span><span style="color:#f92672">*</span><span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">j</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">i</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d * %d = %d    &#34;</span>, <span style="color:#a6e22e">j</span>, <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span><span style="color:#f92672">*</span><span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">j</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>格式三，相当于while true</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> &gt; <span style="color:#ae81ff">100</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>示例： 水仙花数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 水仙花数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 百位^3 + 十位^3 + 个位^3 = 这个数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">x</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">999</span>; <span style="color:#a6e22e">x</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">a</span><span style="color:#f92672">*</span><span style="color:#a6e22e">a</span><span style="color:#f92672">*</span><span style="color:#a6e22e">a</span><span style="color:#f92672">+</span><span style="color:#a6e22e">b</span><span style="color:#f92672">*</span><span style="color:#a6e22e">b</span><span style="color:#f92672">*</span><span style="color:#a6e22e">b</span><span style="color:#f92672">+</span><span style="color:#a6e22e">c</span><span style="color:#f92672">*</span><span style="color:#a6e22e">c</span><span style="color:#f92672">*</span><span style="color:#a6e22e">c</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">x</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">x</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h4 id="for-range">for range</h4>
<ul>
<li>
<p>对数组，切片，集合，字符串友好</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> =[<span style="color:#ae81ff">4</span>]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;a&#34;</span>,<span style="color:#e6db74">&#34;b&#34;</span>,<span style="color:#e6db74">&#34;c&#34;</span>,<span style="color:#e6db74">&#34;d&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">a</span> {
</span></span><span style="display:flex;"><span>		println(<span style="color:#a6e22e">k</span>, <span style="color:#e6db74">&#34;----&gt;&#34;</span>, <span style="color:#a6e22e">v</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h4 id="break">break</h4>
<ul>
<li>
<p>break 默认结束当前循环，也可以定义标签跳出指定层循环</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">out</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">i</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d*%d=%d  &#34;</span>, <span style="color:#a6e22e">j</span>, <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#a6e22e">j</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> &gt; <span style="color:#ae81ff">5</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span> <span style="color:#a6e22e">out</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h4 id="continue">continue</h4>
<ul>
<li>
<p>跳过当前循环，执行下一个循环。也可以指定下一个循环的标签</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">out</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">i</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d*%d=%d  &#34;</span>, <span style="color:#a6e22e">j</span>, <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#a6e22e">j</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> &gt; <span style="color:#ae81ff">5</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">continue</span> <span style="color:#a6e22e">out</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h4 id="goto">goto</h4>
<ul>
<li>
<p>跳转到指定标签处</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">out</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">i</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d*%d=%d  &#34;</span>, <span style="color:#a6e22e">j</span>, <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#a6e22e">j</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> &gt; <span style="color:#ae81ff">5</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">out</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-accc5d7079984749296c70694e1055a5">6.1.6 - 函数</h1>
    <div class="lead">go|函数</div>
	<h3 id="函数">函数</h3>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">函数定义基本语法</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">func_name</span>(<span style="color:#a6e22e">params</span>) (<span style="color:#a6e22e">return_types</span>) {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>func</code> 关键字表示定义一个函数</li>
<li><code>func_name</code> 函数名称</li>
<li><code>params</code>  形参</li>
<li><code>return_types</code> 返回值类型</li>
</ul>


</div>

<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sum</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">sum</span>) <span style="color:#75715e">//3</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">b</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
  
  
  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="**基本函数**" aria-controls="tabs-01-00" aria-selected="true">
        <strong>基本函数</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="**带参数的函数**" aria-controls="tabs-01-01" aria-selected="false">
        <strong>带参数的函数</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="**值传递和引用传递**" aria-controls="tabs-01-02" aria-selected="false">
        <strong>值传递和引用传递</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="**返回值的函数**" aria-controls="tabs-01-03" aria-selected="false">
        <strong>返回值的函数</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">add</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">float32</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">a</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">b</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 可变参数</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">num</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sum</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">num</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sum</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">sum</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 可变参数</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">add</span>([]<span style="color:#66d9ef">int</span>{<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>})
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">num</span> []<span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sum</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">num</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sum</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">sum</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//值传递，复制变量值给函数，不会影响原有变量</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">num1</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">num2</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">swap</span>(<span style="color:#a6e22e">num1</span>, <span style="color:#a6e22e">num2</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;num1的值：%d\nnum2的值：%d\n&#34;</span>, <span style="color:#a6e22e">num1</span>, <span style="color:#a6e22e">num2</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// num1的值：1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// num2的值：2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">swap</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span> = <span style="color:#a6e22e">b</span>, <span style="color:#a6e22e">a</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//引用传递，会修改原有变量</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">num1</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">num2</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">swap</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">num1</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">num2</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;num1的值：%d\nnum2的值：%d\n&#34;</span>, <span style="color:#a6e22e">num1</span>, <span style="color:#a6e22e">num2</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// num1的值：2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// num2的值：1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">swap</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">a</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">b</span> = <span style="color:#f92672">*</span><span style="color:#a6e22e">b</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">a</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">mesg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">56</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">mesg</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">num</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sum</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">num</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sum</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sum</span>, <span style="color:#e6db74">&#34;计算完成&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">mesg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">56</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">mesg</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">num</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">int</span>) (<span style="color:#a6e22e">sum</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">mesg</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">num</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sum</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mesg</span> = <span style="color:#e6db74">&#34;计算完成&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
</div>

<h3 id="递归函数">递归函数</h3>
<ul>
<li>
<p><strong>函数体内调用函数自身 称为递归函数</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 斐波那契数列是指这样一个数列：1，1，2，3，5，8，13，21，34，55，89……这个数列从第3项开始 ，每一项都等于前两项之和</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">i</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 求第n项</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">2</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">test4</span>(<span style="color:#a6e22e">i</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 递归函数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">test4</span>(<span style="color:#a6e22e">a</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">test4</span>(<span style="color:#a6e22e">a</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">a</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h3 id="匿名函数">匿名函数</h3>
<p><strong>函数定义基本语法</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 省略了函数的名称</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">params</span>) (<span style="color:#a6e22e">return_types</span>) {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>func</code> 关键字表示定义一个函数</li>
<li><code>params</code>  形参</li>
<li><code>return_types</code> 返回值类型</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">mesg</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">num</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sum</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">num</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">sum</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sum</span>, <span style="color:#e6db74">&#34;计算完毕&#34;</span>
</span></span><span style="display:flex;"><span>	}(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">mesg</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>将匿名函数赋值给一个变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">f1</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">num</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">int</span>) (<span style="color:#a6e22e">sum</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">mesg</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">num</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">sum</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">mesg</span> = <span style="color:#e6db74">&#34;计算完毕&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">mesg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f1</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">mesg</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h3 id="回调函数">回调函数</h3>
<ul>
<li>
<p>利用匿名函数实现回调</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">operator</span>(<span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hello world&#34;</span>)
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">operator</span>(<span style="color:#a6e22e">f</span> <span style="color:#66d9ef">func</span>()) { <span style="color:#75715e">// f  func() 表示 f 变量是一个无参数，无返回值的函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">f</span>()  <span style="color:#75715e">// 在此处回调了函数f</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>带参数的回调函数</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 把函数作为参数,回调函数</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">add</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">b</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">operator</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">add</span>),
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">operator</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">fun</span> <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fun</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 把函数作为参数,回调函数</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">operator</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">b</span>
</span></span><span style="display:flex;"><span>		}),
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">operator</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">fun</span> <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fun</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h3 id="闭包函数">闭包函数</h3>
<blockquote>
<p>把函数作为返回值，这个函数保存了变量不被释放</p>
</blockquote>
<ul>
<li>
<p>利用匿名函数实现闭包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">add</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>() <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#ae81ff">123</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  add 函数已经结束，但是result 保留了变量num的变量值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">123</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">result</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 124</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 125</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 126</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 127</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 128</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 129</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 130</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 131</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 132</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 133</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">num</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">num</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">num</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h3 id="函数延迟调用">函数延迟调用</h3>
<ul>
<li>
<p>defer 声明位置，暂存当前变量状态。类似一个快照</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">a</span>) <span style="color:#75715e">//1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">a</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">a</span>) <span style="color:#75715e">//2</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>多个defer 函数按照顺序逆序执行，暂存defer任务的地方类似栈</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;1&#34;</span>, <span style="color:#e6db74">&#34;2&#34;</span>, <span style="color:#e6db74">&#34;3&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">a</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> println(<span style="color:#a6e22e">v</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 3</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 2</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 1</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h3 id="冒泡排序函数示例">冒泡排序函数示例</h3>
<p><img src="../docs/golang/static/%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F.png" alt="冒泡排序"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sort</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;3&#34;</span>, <span style="color:#e6db74">&#34;0&#34;</span>, <span style="color:#e6db74">&#34;9&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span>, <span style="color:#e6db74">&#34;4&#34;</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">result</span>) <span style="color:#75715e">//[0 1 3 4 9]</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 一个冒泡比较的函数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">sort</span>(<span style="color:#a6e22e">a</span> []<span style="color:#66d9ef">string</span>) []<span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> &lt; len(<span style="color:#a6e22e">a</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> { <span style="color:#75715e">//比较的轮数</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; len(<span style="color:#a6e22e">a</span>)<span style="color:#f92672">-</span><span style="color:#a6e22e">i</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> { <span style="color:#75715e">// 每轮比较的次数</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">j</span>] &gt; <span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">j</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">j</span>], <span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">j</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] = <span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">j</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>], <span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">j</span>]
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2c3b8fa82fae8e2d552840ed6ce3d15f">6.1.7 - 结构体</h1>
    <div class="lead">结构体|数据类型</div>
	<p>golang 除了包含内置数据类型，同样还允许用户通过<code>type</code> 关键字自定义数据类型。自定义数据类型是内置数据类型一个或多个类型的组合。</p>
<p>示例：</p>
<ul>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">newstring</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">name</span> <span style="color:#a6e22e">newstring</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;张三&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s的数据类型是：%T\n&#34;</span>, <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">name</span>) <span style="color:#75715e">//张三的数据类型是：main.newstring</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">newstring</span> = <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">name</span> <span style="color:#a6e22e">newstring</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;张三&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s的数据类型是：%T\n&#34;</span>, <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">name</span>) <span style="color:#75715e">// 张三的数据类型是：string</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h3 id="结构体的基本语法">结构体的基本语法</h3>
<p><strong>结构体定义基本语法</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> &lt;<span style="color:#a6e22e">name</span>&gt; <span style="color:#66d9ef">struct</span> {}
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Persion</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Persion</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;张三&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Age</span> = <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">p</span>) <span style="color:#75715e">//{张三 33}</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>结构体赋值的语法</strong></p>
<ul>
<li>
<p>使用 “.” 赋值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 使用 . 对字段赋值</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Persion</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Persion</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;张三&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Age</span> = <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>声明变量时赋值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Persion</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span> = <span style="color:#a6e22e">Persion</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;张三&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Age</span>:  <span style="color:#ae81ff">33</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>也可以省略字段直接赋值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Persion</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span> = <span style="color:#a6e22e">Persion</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;张三&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">33</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h3 id="实例化结构体">实例化结构体</h3>
<ul>
<li>
<p>使用<code>new()</code>函数实例化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 结构体定义后并不会分配内存空间，一旦结构体变量完成实例化，就完成了内存地址的分配</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Persion</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 通过new() 返回数据类型的指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">Persion</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;实例化后p的内存地址为：%p\n保存的值为: %+v\n&#34;</span>, <span style="color:#a6e22e">p</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 实例化后p的内存地址为：0xc0000a8018</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 保存的值为: {Name: Age:0}</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>使用取地址符号 <code>&amp;</code> 实例化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Persion</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Persion</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;实例化后p的内存地址为：%p\n保存的值为: %+v\n&#34;</span>, <span style="color:#a6e22e">p</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 实例化后p的内存地址为：0xc000010030</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 保存的值为: {Name: Age:0}</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>[waring]</p>
<p><span style="color: red; background-color: black;"><code>var p *Persion</code>并没有完成实例化，go程序并未分配内存给<code>p</code>,此时<code>p</code> 就是空指针</span></p>
</blockquote>
<hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Persion</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Persion</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;实例化后p的内存地址为：%p\n保存的值为: %+v\n&#34;</span>, <span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 实例化后p的内存地址为：0x0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 保存的值为: &lt;nil&gt;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h3 id="结构体方法">结构体方法</h3>
<ul>
<li>
<p>通过构造函数返回结构体变量，进而通过结构体变量操作结构体方法</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Persion</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">initFunction</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">age</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Persion</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Persion</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Age</span>:  <span style="color:#a6e22e">age</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Persion</span>) <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34;可以跑步&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">initFunction</span>(<span style="color:#e6db74">&#34;张三&#34;</span>, <span style="color:#ae81ff">33</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">run</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>方法同样支持传参，和定义返回值</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Persion</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">initFunction</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">age</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Persion</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Persion</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Age</span>:  <span style="color:#a6e22e">age</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 不带参数的方法</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Persion</span>) <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34;可以跑步&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 带参数的方法</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Persion</span>) <span style="color:#a6e22e">work</span>(<span style="color:#a6e22e">w</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;做一份%s的工作\n&#34;</span>, <span style="color:#a6e22e">w</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 带返回值的方法</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Persion</span>) <span style="color:#a6e22e">rename</span>(<span style="color:#a6e22e">newName</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Persion</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#a6e22e">newName</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">initFunction</span>(<span style="color:#e6db74">&#34;张三&#34;</span>, <span style="color:#ae81ff">33</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">run</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">work</span>(<span style="color:#e6db74">&#34;挑战&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">newPersion</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">rename</span>(<span style="color:#e6db74">&#34;王五&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%+v\n&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">newPersion</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h3 id="匿名结构体">匿名结构体</h3>
<p><strong>结构体定义基本语法</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>&lt;<span style="color:#a6e22e">name</span>&gt;<span style="color:#f92672">:=</span><span style="color:#66d9ef">struct</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">field_name</span> <span style="color:#a6e22e">definition</span>
</span></span><span style="display:flex;"><span>}{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">field_name</span>: <span style="color:#a6e22e">value</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>举例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	}{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;张三&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Age</span>:  <span style="color:#ae81ff">33</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="结构体嵌套">结构体嵌套</h3>
<ul>
<li>
<p>匿名字段</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 没有定义名称的字段称为匿名字段</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Persion</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span> = <span style="color:#a6e22e">Persion</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">string</span>: <span style="color:#e6db74">&#34;张三&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span>:    <span style="color:#ae81ff">33</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">p</span>) <span style="color:#75715e">//{张三 33}</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>结构体嵌套</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Alert</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Status</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Alerts</span> []<span style="color:#a6e22e">AlertItem</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AlertItem</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">AlertName</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">alert</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Alert</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Status</span>: <span style="color:#e6db74">&#34;firing&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Alerts</span>: []<span style="color:#a6e22e">AlertItem</span>{{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">AlertName</span>: <span style="color:#e6db74">&#34;cpu&#34;</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%+v\n&#34;</span>, <span style="color:#a6e22e">alert</span>) <span style="color:#75715e">//&amp;{Status:firing Alerts:[{AlertName:cpu}]}</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bb18142a6ab4131e12e6a9adfd9a40ee">6.1.8 - 接口</h1>
    <div class="lead">接口|数据类型</div>
	<h3 id="接口">接口</h3>
<p>接口是一种抽象类型，它定义了一组方法，但没有实现。接口可以被任何类型实现，这意味着一个类型可以实现多个接口。通过接口，我们可以实现多态性，即一个对象可以具有多种类型。</p>
<ul>
<li>
<p><strong>接口定义</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">systemd</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Start</span>() <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Stop</span>() <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>接口实现，需要实现接口中定义的所有方法</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">systemd</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Start</span>() <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Stop</span>() <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Start</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34;starting...&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Stop</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34;stoping...&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 构造函数,实现了接口定义的所有方法的对象 也就是接口数据类型</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newServer</span>() <span style="color:#a6e22e">systemd</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Server</span>{<span style="color:#e6db74">&#34;Redis&#34;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  同样方法在定义一个client 结构体并实现 接口定义</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Client</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span>) <span style="color:#a6e22e">Start</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34;starting...&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span>) <span style="color:#a6e22e">Stop</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34;stoping...&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newClient</span>() <span style="color:#a6e22e">systemd</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Client</span>{<span style="color:#e6db74">&#34;Redis-cli&#34;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">server</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newServer</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Start</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Stop</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	client := newClient()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Start</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Stop</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<p>接口作为函数参数</p>
<p>接口作为函数返回值</p>
<p>接口类型的数据</p>
<p>接口类型切片</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">systemd</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Start</span>() <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Stop</span>() <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">system</span> []<span style="color:#a6e22e">systemd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Start</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Stop</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 实现了所有接口方法的结构体实例，都是这种数据类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Server</span>{<span style="color:#e6db74">&#34;Redis&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">system</span> = append(<span style="color:#a6e22e">system</span>, <span style="color:#a6e22e">s</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">system</span>[<span style="color:#ae81ff">0</span>]) <span style="color:#75715e">//&amp;{Redis}</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接口类型map</p>
<p>空接口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 定义一个空接口</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">empty</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//定义一个函数，参数为空接口类型。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">test</span> <span style="color:#a6e22e">empty</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">test</span>)
</span></span><span style="display:flex;"><span>	}(<span style="color:#ae81ff">3.14</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//可变参数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">test</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">empty</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">test</span>)
</span></span><span style="display:flex;"><span>	}(<span style="color:#e6db74">&#34;hello world&#34;</span>, <span style="color:#ae81ff">1234</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 定义一个结构体,使用空接口类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">test</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">a</span> <span style="color:#66d9ef">interface</span>{}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">t1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">test</span>{<span style="color:#e6db74">&#34;hello world&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">t2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">test</span>{<span style="color:#ae81ff">3.14</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">t1</span>, <span style="color:#a6e22e">t2</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接口继承</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-20177545e90bb6e34794d53eb0978e4b">6.1.9 - </h1>
    <div class="lead">package 文档中心</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-56a7f342707b88eb73a4964718cb5654">6.1.9.1 - 包管理</h1>
    <div class="lead">库|golang</div>
	<p><strong>包的声明:</strong></p>
<ul>
<li>同一目录下的文件必须属于同一个包</li>
<li>package 声明的包名应该和所在目录名称一致。允许不一致</li>
<li>包可以嵌套</li>
<li>同包下的函数不需要导入和直接使用</li>
<li>init() 函数和 main() 函数是golang 保留函数，不能有参数和返回值。init() 可以在任意包中，并且一个包下允许存在多个init()函数main() 函数只能被定义在main包中。</li>
</ul>
<p><strong>包的导入格式：</strong></p>

  
  

  

  


  
<ul class="nav nav-tabs justify-content-end" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>导包方法</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="标准导入" aria-controls="tabs-00-01" aria-selected="true">
        标准导入
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="自定义别名" aria-controls="tabs-00-02" aria-selected="false">
        自定义别名
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="省略导入格式" aria-controls="tabs-00-03" aria-selected="false">
        省略导入格式
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-04" role="tab"
          data-td-tp-persist="匿名导入" aria-controls="tabs-00-04" aria-selected="false">
        匿名导入
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hello world&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#a6e22e">f</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hello world&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> . <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hello world&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-04" role="tabpanel" aria-labelled-by="tabs-00-04-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">初始化函数通常在这个包执行main</span>()<span style="color:#a6e22e">前执行初始化动作</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">一个包可以包含0或多个init</span>()<span style="color:#a6e22e">函数</span>
</span></span></code></pre></div>
    </div>
</div>

<h3 id="常见库">常见库</h3>
<table>
  <thead>
      <tr>
          <th>库名</th>
          <th>类型</th>
          <th>功能</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>fmt</code></td>
          <td>格式化 I/O</td>
          <td>提供格式化输入输出函数（如 <code>Printf</code>、<code>Scanf</code> 等）</td>
      </tr>
      <tr>
          <td><code>os</code></td>
          <td>系统交互</td>
          <td>操作系统功能接口（文件、进程、环境变量等）</td>
      </tr>
      <tr>
          <td><code>filepath</code></td>
          <td>文件路径处理</td>
          <td>跨平台路径操作（路径拼接、分析、规范化等）</td>
      </tr>
      <tr>
          <td><code>io</code></td>
          <td>基础 I/O</td>
          <td>定义 <code>Reader</code>/<code>Writer</code> 接口及流式数据操作</td>
      </tr>
      <tr>
          <td><code>bufio</code></td>
          <td>缓冲 I/O</td>
          <td>带缓冲的读写操作（纠正自 <code>iobufer</code>，原库名无效）</td>
      </tr>
      <tr>
          <td><code>time</code></td>
          <td>时间处理</td>
          <td>时间获取、格式化、计算与时区转换</td>
      </tr>
      <tr>
          <td><code>strings</code></td>
          <td>字符串处理</td>
          <td>字符串分割、替换、查找等操作</td>
      </tr>
      <tr>
          <td><code>log</code></td>
          <td>日志管理</td>
          <td>基础日志记录（支持输出到文件、终端等）</td>
      </tr>
      <tr>
          <td><code>encoding/json</code></td>
          <td>数据序列化</td>
          <td>JSON 编码与解码</td>
      </tr>
      <tr>
          <td><code>gopkg.in/yaml.v3</code></td>
          <td>数据序列化（第三方）</td>
          <td>YAML 解析与生成（需手动导入第三方库）</td>
      </tr>
      <tr>
          <td><code>net/http</code></td>
          <td>网络通信</td>
          <td>HTTP 客户端/服务端实现（构建 Web 应用）</td>
      </tr>
      <tr>
          <td><code>flag</code></td>
          <td>命令行工具</td>
          <td>解析命令行参数与选项</td>
      </tr>
      <tr>
          <td><code>context</code></td>
          <td>并发控制</td>
          <td>跨协程传递请求上下文（超时、取消信号等）</td>
      </tr>
      <tr>
          <td><code>sync</code></td>
          <td>并发控制</td>
          <td>互斥锁、条件变量、并发安全工具（<code>Mutex</code>/<code>WaitGroup</code>）</td>
      </tr>
      <tr>
          <td><code>runtime</code></td>
          <td>系统交互</td>
          <td>访问 Go 运行时信息（GC、协程监控等）</td>
      </tr>
      <tr>
          <td><code>syscall</code></td>
          <td>系统交互</td>
          <td>直接调用操作系统底层接口</td>
      </tr>
      <tr>
          <td><code>path/filepath</code></td>
          <td>文件路径处理</td>
          <td>跨平台文件路径解析（已补全标准写法）</td>
      </tr>
      <tr>
          <td><code>net</code></td>
          <td>网络通信</td>
          <td>底层网络协议（TCP/UDP）与 DNS 解析</td>
      </tr>
      <tr>
          <td><code>net/http/pprof</code></td>
          <td>性能监控</td>
          <td>集成性能分析工具（CPU/内存/协程分析）</td>
      </tr>
      <tr>
          <td><code>reflect</code></td>
          <td>元编程</td>
          <td>运行时类型反射与动态操作</td>
      </tr>
      <tr>
          <td><code>testing</code></td>
          <td>测试框架</td>
          <td>单元测试与基准测试</td>
      </tr>
      <tr>
          <td><code>errors</code></td>
          <td>错误处理</td>
          <td>错误包装与自定义错误类型</td>
      </tr>
      <tr>
          <td><code>compress/gzip</code></td>
          <td>压缩解压</td>
          <td>GZIP 格式压缩与解压</td>
      </tr>
      <tr>
          <td><code>github.com/spf13/cobra</code></td>
          <td>命令行工具（第三方）</td>
          <td>强大的 CLI 应用框架（替代 <code>flag</code> 的高级选择）</td>
      </tr>
      <tr>
          <td><code>github.com/spf13/viper</code></td>
          <td>配置管理（第三方）</td>
          <td>多格式配置读取（JSON/YAML/ENV 等）</td>
      </tr>
      <tr>
          <td><code>github.com/sirupsen/logrus</code></td>
          <td>日志管理（第三方）</td>
          <td>结构化日志记录（支持 Hook 和多种输出格式）</td>
      </tr>
      <tr>
          <td><code>github.com/gin-gonic/gin</code></td>
          <td>Web 框架（第三方）</td>
          <td>高性能 HTTP Web 框架（路由、中间件等）</td>
      </tr>
      <tr>
          <td><code>github.com/gorilla/websocket</code></td>
          <td>网络通信（第三方）</td>
          <td>WebSocket 协议实现（客户端/服务端）</td>
      </tr>
      <tr>
          <td><code>github.com/go-redis/redis</code></td>
          <td>数据存储（第三方）</td>
          <td>Redis 客户端库</td>
      </tr>
      <tr>
          <td><code>github.com/stretchr/testify</code></td>
          <td>测试工具（第三方）</td>
          <td>断言库与 Mock 工具（增强 <code>testing</code> 功能）</td>
      </tr>
      <tr>
          <td><code>github.com/prometheus/client_golang</code></td>
          <td>监控（第三方）</td>
          <td>Prometheus 指标暴露与收集（运维监控必备）</td>
      </tr>
      <tr>
          <td><code>github.com/docker/docker</code></td>
          <td>容器交互（第三方）</td>
          <td>Docker 引擎 API 客户端（容器管理）</td>
      </tr>
      <tr>
          <td><code>gorm.io/gorm</code></td>
          <td>ORM 框架（第三方）</td>
          <td>数据库 ORM 操作（支持 MySQL/PostgreSQL 等）</td>
      </tr>
  </tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-134739c923dfae9273d77b5641e79497">6.1.9.2 - fmt</h1>
    <div class="lead">fmt|标准库</div>
	<ul>
<li>
<p><strong>printf 格式化输出</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// %s %q字符串占位符</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s\n&#34;</span>, <span style="color:#e6db74">&#34;中文&#34;</span>) <span style="color:#75715e">//中文</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%q\n&#34;</span>, <span style="color:#e6db74">&#34;中文&#34;</span>) <span style="color:#75715e">//&#34;中文&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// %d 十进制占位符</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// %b 二进制占位符</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// %q 按照assic 码输出字面值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d\n&#34;</span>, <span style="color:#ae81ff">91</span>) <span style="color:#75715e">// 91</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%b\n&#34;</span>, <span style="color:#ae81ff">91</span>) <span style="color:#75715e">// 1011011</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%q\n&#34;</span>, <span style="color:#ae81ff">91</span>) <span style="color:#75715e">// &#39;[&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// %f 浮点数占位符</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%.2f\n&#34;</span>, <span style="color:#ae81ff">3.141592657</span>) <span style="color:#75715e">// 3.14</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// %t 布尔型占位符</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%t\n&#34;</span>, <span style="color:#66d9ef">true</span>) <span style="color:#75715e">//true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// %p 指针类型占位符 0x表示16进制</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;张三&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%p\n&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Name</span>) <span style="color:#75715e">//0xc000014270</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// %v 按照值的默认格式输出</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v %v %v\n&#34;</span>, <span style="color:#ae81ff">123</span>, <span style="color:#66d9ef">true</span>, <span style="color:#e6db74">&#34;张三&#34;</span>) <span style="color:#75715e">//123 true 张三</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// %+v 按照值的默认格式输出,结构体会添加字段名</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Persion</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Persion</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;张三&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Age</span> = <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v\n%+v\n&#34;</span>, <span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// %T 数据类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%T\n&#34;</span>, <span style="color:#66d9ef">true</span>) <span style="color:#75715e">//bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// %% 表示一个%</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%.2f%%\n&#34;</span>, <span style="color:#ae81ff">3.141592657</span>) <span style="color:#75715e">//3.14%</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>向文件中写入内容</strong></p>
<p><code>Fprint</code>,<code>Fprintf</code> <code>Fprintln</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// os.OpenFile: 这是Go标准库中os包提供的一个函数，用于打开一个文件，并返回一个文件句柄。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* os.O_CREATE|os.O_WRONLY|os.O_APPEND：这是文件打开的模式，由几个常量进行位或（|）操作得到:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        os.O_CREATE：如果文件不存在，创建一个新文件。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        os.O_WRONLY：以只写方式打开文件。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        os.O_APPEND：写入文件时，每次写操作都从文件末尾开始，即追加模式。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#e6db74">&#34;./1.txt&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_WRONLY</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_APPEND</span>, <span style="color:#ae81ff">0644</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">f</span>, <span style="color:#e6db74">&#34;%.2f\n&#34;</span>, <span style="color:#ae81ff">3.141592657</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>获取输出的字符串</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Sprint Sprintf Sprintln 把输出值赋值给变量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">name</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprint</span>(<span style="color:#e6db74">&#34;张三&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;张三&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>键盘输入</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Scan Scanln Scanf</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">userName</span>, <span style="color:#a6e22e">passWord</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">num</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">userName</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">passWord</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">num</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  获取变量 userName 和 passWord 的值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;用户名:%s\n密码:%s\n&#34;</span>, <span style="color:#a6e22e">userName</span>, <span style="color:#a6e22e">passWord</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Scan Scanln Scanf</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">userName</span>, <span style="color:#a6e22e">passWord</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">num</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Scanln</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">userName</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">passWord</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">num</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  获取变量 userName 和 passWord 的值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;用户名:%s\n密码:%s\n&#34;</span>, <span style="color:#a6e22e">userName</span>, <span style="color:#a6e22e">passWord</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// root 123</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 用户名:root</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 密码:123</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>自定义错误输出</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">file</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;/etc/hosts&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%s文件内容为空&#34;</span>, <span style="color:#a6e22e">file</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>) <span style="color:#75715e">// /etc/hosts文件内容为空</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ed4a7d377a0d2a0b80a970c4c56643fc">6.1.9.3 - os</h1>
    <div class="lead">os|标准库</div>
	<h4 id="os操作文件系统">os操作文件系统</h4>
<ul>
<li>
<p><strong><code>os.Create()</code> 创建文件或清空文件</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 创建文件或清空文件 如果文件不存在则创建默认权限0644，如果文件存在文件中内容会被清空</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;1.txt&#34;</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintln</span>(<span style="color:#a6e22e">f</span>, <span style="color:#e6db74">&#34;创建了一个文件,并向文件中写入了一行&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong><code>os.Mkdir()</code> 创建目录</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// os.Mkdir() 创建目录,可以看作是linux中mkdir</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Mkdir</span>(<span style="color:#e6db74">&#34;newdir&#34;</span>, <span style="color:#ae81ff">0755</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>) <span style="color:#75715e">//目录如果存在时执行报错：mkdir newdir: file exists</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong><code>os.MkdirAll()</code>递归创建目录</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 递归创建目录</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">MkdirAll</span>(<span style="color:#e6db74">&#34;newdir1/newdir2&#34;</span>, <span style="color:#ae81ff">0755</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>) <span style="color:#75715e">//当目录存在时不会报错</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong><code>os.Rename()</code> 移动目录</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// mv 目录</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Rename</span>(<span style="color:#e6db74">&#34;newdir1&#34;</span>, <span style="color:#e6db74">&#34;/tmp/newdir1&#34;</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 当目标已经存在时报错：rename newdir1 /tmp/newdir1: file exists</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 当目标是文件时报错：rename newdir1 /tmp/newdir1: not a directory</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong><code>os.Open()</code> 只读方式打开文件</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// os.Open() 只读方式打开文件</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;/etc/hosts1&#34;</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">err</span>) <span style="color:#75715e">//如果文件不存在报错：open /etc/hosts1: no such file or directory</span>
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 分批次循环读取文件</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">buffer</span> [<span style="color:#ae81ff">128</span>]<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">result</span> []<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">lenth</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buffer</span>[:])
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> {
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">result</span> = append(<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">buffer</span>[:<span style="color:#a6e22e">lenth</span>]<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">result</span>))
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong><code>os.OpenFile()</code> 整合并扩展了<code>os.Create()</code>，<code>os.Open()</code>功能</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//  O_CREATE create a new file if none exists.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//  O_RDONLY open the file read-only.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//  O_WRONLY open the file write-only.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//  O_RDWR open the file read-write.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//  O_APPEND append data to the file when writing.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#e6db74">&#34;1.txt&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_WRONLY</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_APPEND</span>, <span style="color:#ae81ff">0644</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintln</span>(<span style="color:#a6e22e">f</span>, <span style="color:#e6db74">&#34;追加一条信息到文本&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong><code>os.Remove() 和 os.RemoveAll()</code>文件删除</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 删除文件 或 空目录[目录下有目录或文件不能被删除]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fileList</span> = []<span style="color:#66d9ef">string</span>{}
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;1.txt&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">MkdirAll</span>(<span style="color:#e6db74">&#34;dir1/dir2&#34;</span>, <span style="color:#ae81ff">0755</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fileList</span> = append(<span style="color:#a6e22e">fileList</span>, <span style="color:#e6db74">&#34;1.txt&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fileList</span> = append(<span style="color:#a6e22e">fileList</span>, <span style="color:#e6db74">&#34;dir1&#34;</span>)      <span style="color:#75715e">//remove dir1: directory not empty</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fileList</span> = append(<span style="color:#a6e22e">fileList</span>, <span style="color:#e6db74">&#34;dir1/dir2&#34;</span>) 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">fileName</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">fileList</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">fileName</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 删除文件 或 目录</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fileList</span> = []<span style="color:#66d9ef">string</span>{}
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;1.txt&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">MkdirAll</span>(<span style="color:#e6db74">&#34;dir1/dir2&#34;</span>, <span style="color:#ae81ff">0755</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fileList</span> = append(<span style="color:#a6e22e">fileList</span>, <span style="color:#e6db74">&#34;1.txt&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fileList</span> = append(<span style="color:#a6e22e">fileList</span>, <span style="color:#e6db74">&#34;dir1&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">fileName</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">fileList</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">RemoveAll</span>(<span style="color:#a6e22e">fileName</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong><code>os.Stat()</code> 文件状态</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fileInfo</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#e6db74">&#34;/etc/hosts&#34;</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 文件名，basename /etc/hosts</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">filename</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fileInfo</span>.<span style="color:#a6e22e">Name</span>()
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">filename</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 文件大小</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">size</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fileInfo</span>.<span style="color:#a6e22e">Size</span>()
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d bytes\n&#34;</span>, <span style="color:#a6e22e">size</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fileInfo</span>.<span style="color:#a6e22e">IsDir</span>() {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;是目录&#34;</span>)
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;是文件&#34;</span>)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong><code>os.Args</code> 获取命令行传递的参数</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">1</span>:])
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@golang ~<span style="color:#f92672">]</span><span style="color:#75715e"># go run test.go  123 455 789</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span><span style="color:#ae81ff">123</span> <span style="color:#ae81ff">455</span> 789<span style="color:#f92672">]</span>
</span></span></code></pre></div></li>
<li>
<p><strong>os/exec 执行系统命令</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os/exec&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;ls&#34;</span>, <span style="color:#e6db74">&#34;-l&#34;</span>) <span style="color:#75715e">// 更改为你需要执行的命令和参数</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">output</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">output</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li>
<p><strong>os获取环境变量</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//os.LookupEnv 和 os.Getenv 都可以读取环境变量的值，os.Getenv 只返回值（不存在时返回空串），无法区分“未设置”与“已设置但为空”。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取系统环境变量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">hostname</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;USER&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Geteuid</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;当前用户名:%s\n当前用户uid:%d\n&#34;</span>, <span style="color:#a6e22e">hostname</span>, <span style="color:#a6e22e">uid</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>文件读写示例</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">readFile</span>(<span style="color:#e6db74">&#34;email04.png&#34;</span>, <span style="color:#e6db74">&#34;email041.png&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">readFile</span>(<span style="color:#a6e22e">oldfile</span>, <span style="color:#a6e22e">newfile</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 实现文件的复制</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#a6e22e">oldfile</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">buffer</span> [<span style="color:#ae81ff">128</span>]<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">result</span> []<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">seed</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buffer</span>[:]); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;文件读取完毕&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">result</span> = append(<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">buffer</span>[:<span style="color:#a6e22e">seed</span>]<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#a6e22e">newfile</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_APPEND</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_RDWR</span>, <span style="color:#ae81ff">0644</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">result</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-97e147d7d4a73fe0f945dd49a092141f">6.1.9.4 - path</h1>
    <div class="lead">path|标准库</div>
	<h4 id="filepath获取文件路径"><strong>filepath获取文件路径</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;path/filepath&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 判断是否为绝对路径</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">IsAbs</span>(<span style="color:#e6db74">&#34;/&#34;</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;是绝对路径&#34;</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;是相对路径&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取一个文件的绝对路径，如果当前文件是绝对路径则直接输出，否则拼接当前目录并输出</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">dirname</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Abs</span>(<span style="color:#e6db74">&#34;hosts&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">dirname</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取上一级目录</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#e6db74">&#34;/etc/hosts&#34;</span>, <span style="color:#e6db74">&#34;..&#34;</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b4fb2930e691a0cf7acecfb40a183170">6.1.9.5 - io</h1>
    <div class="lead">io|标准库</div>
	<h3 id="io-操作文件内容">i/o 操作文件内容</h3>
<ul>
<li>
<p>读取文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 打开文件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;/etc/hosts&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 关闭文件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 读取文件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">buffer</span> [<span style="color:#ae81ff">2048</span>]<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">result</span> []<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">seed</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buffer</span>[:])
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">result</span> = append(<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">buffer</span>[:<span style="color:#a6e22e">seed</span>]<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">result</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>文件写入</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 打开文件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;/etc/hosts&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 关闭文件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 读取文件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">buffer</span> [<span style="color:#ae81ff">2048</span>]<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">result</span> []<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">seed</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buffer</span>[:])
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;文件读取完毕&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">result</span> = append(<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">buffer</span>[:<span style="color:#a6e22e">seed</span>]<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 文件写入操作</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#e6db74">&#34;/tmp/hosts&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_APPEND</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_WRONLY</span>, <span style="color:#ae81ff">0644</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">result</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>文件拷贝 <code>io.cpoy()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">source</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;/etc/hosts&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">dest</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#e6db74">&#34;/tmp/hosts&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_APPEND</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_WRONLY</span>, <span style="color:#ae81ff">0644</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">source</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">dest</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">countwrite</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">dest</span>, <span style="color:#a6e22e">source</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">countwrite</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3f9604aad21461dcc082973b2b94800c">6.1.9.6 - time</h1>
    <div class="lead">time|标准库</div>
	<h4 id="time-时间操作">time 时间操作</h4>
<ul>
<li>
<p>获取当前时间、时间格式化、字符串解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取当前时间</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">now</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">now</span>) <span style="color:#75715e">//2024-05-12 16:03:54.379957201 +0800 CST m=+0.000041572</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取指定时间 年 月 日 时 分 秒，纳秒， 时区</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">t1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Date</span>(<span style="color:#ae81ff">2024</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">07</span>, <span style="color:#ae81ff">19</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Local</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">t1</span>) <span style="color:#75715e">//2024-05-12 16:07:19 +0800 CST</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 时间的格式化 Format()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">t2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Format</span>(<span style="color:#e6db74">&#34;2006/01/02 15:04:05 PM&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">t2</span>) <span style="color:#75715e">//2024/05/12 16:21:02 PM</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 解析 Parse()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t3</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">&#34;2006-01-02 15:04:05&#34;</span>, <span style="color:#e6db74">&#34;2024-05-12 16:03:54&#34;</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">t3</span>) <span style="color:#75715e">//2024-05-12 16:03:54 +0000 UTC</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sleep()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9d93ac71d7602c7057d3f99677327641">6.1.9.7 - net/http</h1>
    <div class="lead">net/http|标准库</div>
	<h3 id="nethttp">net/http</h3>
<ul>
<li>
<p><strong>发送GET请求</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 发送Get 请求</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">response</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;http://175.178.65.213:7292&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 关闭连接</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 读取响应体内容</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadAll</span>(<span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">Body</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">result</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>创建http服务</strong></p>

  
    
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="简单的http" aria-controls="tabs-00-00" aria-selected="true">
        简单的http
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="多路复用http" aria-controls="tabs-00-01" aria-selected="false">
        多路复用http
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;接收到%s一个请求\n&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Method</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;你执行了一个%s方法&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Method</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mux</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewServeMux</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;Hello, World!&#34;</span>))
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>, <span style="color:#a6e22e">mux</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
</div>

</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6f972b6ca95bc49c4edecab74e624c45">6.1.9.8 - flag</h1>
    <div class="lead">flag|标准库</div>
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">功能：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	通过flag,实现用户传参
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	通过os/exec，实现调用操作系统命令
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os/exec&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ip</span>   = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;ip&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#e6db74">&#34;--ip &lt;ip地址&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">port</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Int</span>(<span style="color:#e6db74">&#34;port&#34;</span>, <span style="color:#ae81ff">80</span>, <span style="color:#e6db74">&#34;--port &lt;端口&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ssl</span>  = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Bool</span>(<span style="color:#e6db74">&#34;ssl&#34;</span>, <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">&#34;--ssl &lt;true|false&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GenerateUrl</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">url</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ssl</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Sprintf() 实现字符串格式化</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">url</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;https://%s:%d&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">ip</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">port</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">url</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;http://%s:%d&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">ip</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">port</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">url</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 解析flag定义参数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">url</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GenerateUrl</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;curl&#34;</span>, <span style="color:#a6e22e">url</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">output</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(string(<span style="color:#a6e22e">output</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fbbd2965d31e5953e03b5cdf97dc31b8">6.1.9.9 - pflag</h1>
    <div class="lead">pflag|第三方库</div>
	
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-914a94e7f31499ccbe14f925549af3f1">6.1.9.10 - cobra</h1>
    <div class="lead">cobar|第三方库 处理命令行参数</div>
	
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6cd3c6e5efe79ba8f5f98419e7adb485">6.1.9.11 - viper</h1>
    <div class="lead">viper|第三方库 处理配置管理</div>
	
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7028525bb97786d501063441ca36ea7a">6.1.9.12 - raft</h1>
    <div class="lead">raft|第三方库 实现选举和数据复制</div>
	<p><a href="https://pkg.go.dev/github.com/coreos/etcd/raft" target="_blank">raft package - github.com/coreos/etcd/raft - Go Packages</a></p>
<p>Raft 是一种协议，节点集群可以使用它来维护复制的状态机。 状态机通过使用复制的日志保持同步。 有关 Raft 的更多详细信息，请参阅“寻找可理解的共识算法” （https://ramcloud.stanford.edu/raft.pdf） 迭戈·翁加罗 （Diego Ongaro） 和约翰·奥斯特豪特 （John Ousterhout）。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f12bcddd2849f1b5eaf7e262b5308d7b">6.1.9.13 - uuid</h1>
    <div class="lead">raft|第三方库 生成uuid</div>
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/google/uuid&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>,<span style="color:#a6e22e">uuid</span>.<span style="color:#a6e22e">New</span>().<span style="color:#a6e22e">String</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bb3cda9b54f328eabb3760d5f18c97b2">6.1.9.14 - redis</h1>
    <div class="lead">raft|第三方库 操作redis数据库</div>
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v7&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cluster</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClusterClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">ClusterOptions</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Addrs</span>: []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;10.4.7.250:6379&#34;</span>, <span style="color:#e6db74">&#34;10.4.7.250:6380&#34;</span>, <span style="color:#e6db74">&#34;10.4.7.250:6381&#34;</span>},
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pong</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">Ping</span>().<span style="color:#a6e22e">Result</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">255</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">LPush</span>(<span style="color:#e6db74">&#34;ip_list&#34;</span>, <span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">pong</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>



    
	
  

    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-0577191c256ef0a782b28becf1a500d7"></h1>
	<div class="lead">python 文档中心</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-09" class="text-body-secondary">Friday, May 09, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-af8116099787cbfdb086e33c1d1479f2">6.2.1 - </h1>
    <div class="lead">package 文档中心</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-6e010b4e4ced28817e2d4a2b8fdfa68c">6.2.1.1 - 包管理</h1>
    <div class="lead">库|python</div>
	<h3 id="常用库">常用库</h3>
<p>把源码包打包成 whl 文件,减少安装依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip3 install --upgrade setuptools wheel
</span></span><span style="display:flex;"><span>pip3 wheel . --wheel-dir<span style="color:#f92672">=</span>dist
</span></span><span style="display:flex;"><span>ls dist/ibm_db-3.2.3-cp36-cp36m-linux_x86_64.whl
</span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>库名</th>
          <th>来源</th>
          <th>描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>os</td>
          <td>标准库</td>
          <td>标准库提供与操作系统进行交互的功能，例如文件和目录操作</td>
      </tr>
      <tr>
          <td>sys</td>
          <td>标准库</td>
          <td>标准库提供访问 Python 解释器的能力，处理命令行参数和环境设置</td>
      </tr>
      <tr>
          <td>io</td>
          <td>标准库</td>
          <td>处理流式I/O操作</td>
      </tr>
      <tr>
          <td>subprocess</td>
          <td>标准库</td>
          <td>用于执行子进程，允许调用外部程序和命令(Shell)</td>
      </tr>
      <tr>
          <td>shutil</td>
          <td>标准库</td>
          <td>标准库文件和目录的高级操作，例如复制、移动和删除</td>
      </tr>
      <tr>
          <td>time</td>
          <td>标准库</td>
          <td>提供与时间相关的功能，例如获取当前时间和暂停程序执行</td>
      </tr>
      <tr>
          <td>datetime</td>
          <td>标准库</td>
          <td>提供处理日期和时间的类和方法</td>
      </tr>
      <tr>
          <td>random</td>
          <td>标准库</td>
          <td>生成随机数和随机选择元素的工具</td>
      </tr>
      <tr>
          <td>json</td>
          <td>标准库</td>
          <td>用于处理 JSON 数据，提供解析和生成 JSON 的方法</td>
      </tr>
      <tr>
          <td>re</td>
          <td>标准库</td>
          <td>提供正则表达式支持，用于字符串模式匹配和处理</td>
      </tr>
      <tr>
          <td>platform</td>
          <td>标准库</td>
          <td>获取操作系统和平台信息，例如版本号、架构等</td>
      </tr>
      <tr>
          <td>fcntl</td>
          <td>标准库</td>
          <td>文件控制（Unix系统文件描述符操作）</td>
      </tr>
      <tr>
          <td>optparse</td>
          <td>标准库</td>
          <td>命令行选项解析（已弃用，推荐使用<code>argparse</code>）</td>
      </tr>
      <tr>
          <td>glob</td>
          <td><code>optparse</code>标准库</td>
          <td>文件名模式匹配工具，用于查找符合特定模式的文件</td>
      </tr>
      <tr>
          <td>ast</td>
          <td>标准库</td>
          <td>抽象语法树操作</td>
      </tr>
      <tr>
          <td>socket</td>
          <td>标准库</td>
          <td>网络套接字通信</td>
      </tr>
      <tr>
          <td>math</td>
          <td>标准库</td>
          <td>数学运算函数</td>
      </tr>
      <tr>
          <td>decimal</td>
          <td>标准库</td>
          <td>十进制高精度计算（标准库中的<code>Decimal</code>类）</td>
      </tr>
      <tr>
          <td>base64</td>
          <td>标准库</td>
          <td>Base64编解码</td>
      </tr>
      <tr>
          <td>random</td>
          <td>标准库</td>
          <td>生成伪随机数</td>
      </tr>
      <tr>
          <td>traceback</td>
          <td>标准库</td>
          <td>异常堆栈跟踪处理</td>
      </tr>
      <tr>
          <td>urlib</td>
          <td>标准库</td>
          <td>处理 URL 请求和响应的工具，用于网络操作</td>
      </tr>
      <tr>
          <td>smtplib</td>
          <td>标准库</td>
          <td>与SMTP服务器交互，用于发送邮件</td>
      </tr>
      <tr>
          <td>requests</td>
          <td>第三方</td>
          <td>对http 发起请求</td>
      </tr>
      <tr>
          <td>psutil</td>
          <td>第三方</td>
          <td>获取操作系统级别 cpu / mem /disk 等基础信息</td>
      </tr>
      <tr>
          <td>Paramiko</td>
          <td>第三方</td>
          <td>库基于 SSH 的客户端库，用于远程服务器自动化控制</td>
      </tr>
      <tr>
          <td>Ansible</td>
          <td>第三方</td>
          <td>IT 自动化工具，用于配置管理、应用部署和任务白动化</td>
      </tr>
      <tr>
          <td>Crontab</td>
          <td>第三方</td>
          <td>提供与 Linux cron 服务的交互，方便创建和管理定时任务</td>
      </tr>
      <tr>
          <td>Docker</td>
          <td>第三方</td>
          <td>管理 Docker 容器和镜像的 API 库，支持创建、管理和监控容器</td>
      </tr>
      <tr>
          <td>Kubernetes</td>
          <td>第三方</td>
          <td>与K8s API 进行交互，管理K8s集群和资源</td>
      </tr>
      <tr>
          <td>pyg2plot</td>
          <td>第三方</td>
          <td>数据可视化</td>
      </tr>
      <tr>
          <td>redis</td>
          <td>第三方</td>
          <td>redis数据库驱动</td>
      </tr>
      <tr>
          <td>mysql.connector</td>
          <td>第三方</td>
          <td>MySQL官方数据库连接</td>
      </tr>
      <tr>
          <td>pymsql</td>
          <td>第三方</td>
          <td>纯Python实现的MySQL客户端</td>
      </tr>
      <tr>
          <td>pymongo</td>
          <td>第三方</td>
          <td>MongoDB数据库驱动</td>
      </tr>
      <tr>
          <td>bson</td>
          <td></td>
          <td>MongoDB BSON格式处理（Binary JSON）</td>
      </tr>
      <tr>
          <td>oracledb</td>
          <td>第三方</td>
          <td>Oracle数据库连接（原cx_Oracle）</td>
      </tr>
      <tr>
          <td>pyodbc</td>
          <td>第三方</td>
          <td>ODBC数据库连接</td>
      </tr>
      <tr>
          <td>kazoo</td>
          <td>第三方</td>
          <td>zookeeper</td>
      </tr>
      <tr>
          <td>kafka-python</td>
          <td>第三方</td>
          <td></td>
      </tr>
      <tr>
          <td>rabbitMQ</td>
          <td>第三方</td>
          <td></td>
      </tr>
      <tr>
          <td>argparse</td>
          <td>第三方</td>
          <td></td>
      </tr>
      <tr>
          <td>typer</td>
          <td>第三方</td>
          <td></td>
      </tr>
      <tr>
          <td>uvicorn</td>
          <td>第三方</td>
          <td>异步 Web 服务</td>
      </tr>
  </tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1868e7f697cc3be5aa5025000f20291f">6.2.1.2 - kafka</h1>
    <div class="lead">库|python</div>
	

<div class="alert alert-primary" role="alert">


    <p>kafka版本: <code>0.9+</code></p>
<p>python版本：<code>2.7+</code></p>
<p>安装：<code>pip install kafka-python==2.2.15</code></p>
<p>文档：<code>https://kafka-python.readthedocs.io/en/master/apidoc/KafkaProducer.html</code></p>


</div>


  
  
  

  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>API</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="**生产者**" aria-controls="tabs-01-01" aria-selected="true">
        <strong>生产者</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="**消费者**" aria-controls="tabs-01-02" aria-selected="false">
        <strong>消费者</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="**管理kafka**" aria-controls="tabs-01-03" aria-selected="false">
        <strong>管理kafka</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <hr>
<p><font color=red><strong>bootstrap_servers</strong>  </font></p>
<blockquote>
<p>数据类型 <code>str|list</code></p>
<p>Kafka 集 群 的 连 接 字 符 串,至少填写kafka 集群中的一个节点。</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaProducer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer <span style="color:#f92672">=</span> KafkaProducer(bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092,192.168.0.152:9092,192.168.0.153:9092&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># producer = KafkaProducer(bootstrap_servers=[&#39;192.168.0.151:9092&#39;,&#39;192.168.0.152:9092&#39;,&#39;192.168.0.153:9092&#39;])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>):
</span></span><span style="display:flex;"><span>    producer<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#39;foobar&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;some_message_bytes&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>flush()  <span style="color:#75715e"># 强制把缓冲区消息发出去</span>
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>close()  <span style="color:#75715e"># 优雅关闭</span>
</span></span></code></pre></div><hr>
<p><font color=red><strong>acks</strong></font></p>
<blockquote>
<p>指定了必须要有多少个副本收到消息，才会向生产者返回写入成功</p>
<ul>
<li><code>acks=0</code>	生产者不等待kafka server 确认写入成功</li>
<li><code>acks=1</code>	生产者等待leader副本写入成功,生产者就会收到一个来自kafka服务器的成功响应</li>
<li><code>acks='all' 或 acks=-1</code> 生产者等待所有副本写入成功，生产者才会收到一个来自kafka服务器的成功响应</li>
</ul>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaProducer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer <span style="color:#f92672">=</span> KafkaProducer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092,192.168.0.152:9092,192.168.0.153:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    acks<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>):
</span></span><span style="display:flex;"><span>    producer<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#39;foobar&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;some_message_bytes&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><hr>
<p><font color=red><strong>retries | retry_backoff_ms</strong>  </font></p>
<blockquote>
<p>生产者向broker 发送消息时，broker 可以返回一个成功响应码或者一个错误响应码。错误响应码可以 分为两种，一种是在重试之后可以解决的，还有一种是无法通过重试解决的。例如，如果broker 返回的是 LEADER_NOT_AVAILABLE 错误，生产者可以尝试重新发送消息。也许在这个时候一个新的首领被选举出来了，那么这次发送就会成功。</p>
<p><code>retries </code> 定义最大重试次数</p>
<p><code>retry_backoff_ms </code> 定义重试的间隔，默认值100</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaProducer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer <span style="color:#f92672">=</span> KafkaProducer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092,192.168.0.152:9092,192.168.0.153:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    acks<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    retries<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>    retry_backoff_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>):
</span></span><span style="display:flex;"><span>    producer<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#39;foobar&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;some_message_bytes&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><hr>
<p><font color=red><strong>enable_idempotence</strong></font></p>
<blockquote>
<p>开启该功能需要设置 <code>acks=-1</code>或 <code>acks='all'</code></p>
<p>当开启<code>acks</code> 和 <code>retries </code> 后可能造成生产者重复发送数据到kafka，可以通过开启幂等性进行优化。默认为false</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaProducer
</span></span><span style="display:flex;"><span>producer <span style="color:#f92672">=</span> KafkaProducer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092,192.168.0.152:9092,192.168.0.153:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    acks<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    retries<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>    retry_backoff_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>    enable_idempotence<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>):
</span></span><span style="display:flex;"><span>    producer<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#39;foobar&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;some_message_bytes&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><hr>
<p><font color=red><strong>max_in_flight_requests_per_connection</strong>  </font></p>
<blockquote>
<p>【前提】</p>
<ul>
<li><code>acks='all'</code> 或 <code>acks=-1</code></li>
<li><code>reties=3 不能小于1</code></li>
</ul>
<p>生产者在收到broker响应之前可以继续发送多少条消息，但是在开启<code>reties</code> 功能后需要将<code>max_in_flight_requests_per_connection=1</code> 设置为1，从而保证消息的顺序。默认值5（此功能在于提高吞吐量）</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaProducer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer <span style="color:#f92672">=</span> KafkaProducer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092,192.168.0.152:9092,192.168.0.153:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    acks<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    retries<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>    retry_backoff_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>    enable_idempotence<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    max_in_flight_requests_per_connection<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>):
</span></span><span style="display:flex;"><span>    producer<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#39;foobar&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;some_message_bytes&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><hr>
<p><font color=red><strong>compression_type</strong>  </font></p>
<blockquote>
<p>指定了消息被发送给 broker 之前使用哪一种压缩算法进行压缩，有效的压缩算法包括‘<em>gzip</em>’, ‘<em>snappy</em>’, ‘<em>lz4</em>’, ‘<em>zstd</em>’ or <em>None</em>。默认值为None</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaProducer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer <span style="color:#f92672">=</span> KafkaProducer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092,192.168.0.152:9092,192.168.0.153:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    acks<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    retries<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>    retry_backoff_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>    enable_idempotence<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    max_in_flight_requests_per_connection<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    compression_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gzip&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>):
</span></span><span style="display:flex;"><span>    producer<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#39;foobar&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;some_message_bytes&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><hr>
<p><font color=red><strong>batch_size | linger_ms</strong>  </font></p>
<blockquote>
<p>当有多个消息需要被发送到同一个分区时，生产者会把它们放在同一个批次里。KafkaProducer 会在批次填满或 linger_ms 达到上限时把批次发送出去</p>
<p><code>batch_size </code>参数指定了一个批次可以使用的内存大小，按照字节数计算。当批次被填满，批次里的所有消息会被一次性发送出去。</p>
<p><code>linger_ms</code> 指定了生产者发送批次的时间间隔</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaProducer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer <span style="color:#f92672">=</span> KafkaProducer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092,192.168.0.152:9092,192.168.0.153:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    acks<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    retries<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>    retry_backoff_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>    enable_idempotence<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    max_in_flight_requests_per_connection<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    compression_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gzip&#39;</span>,
</span></span><span style="display:flex;"><span>    batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">10240</span>,
</span></span><span style="display:flex;"><span>    linger_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>):
</span></span><span style="display:flex;"><span>    producer<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#39;foobar&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;some_message_bytes&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><hr>
<p><font color=red><strong>key_serializer|value_serializer</strong>  </font></p>
<blockquote>
<p>kafka只接受字节数据，生产者执行序列化，消费者对应反序列化</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaProducer
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer <span style="color:#f92672">=</span> KafkaProducer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092,192.168.0.152:9092,192.168.0.153:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    acks<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    retries<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>    retry_backoff_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>    enable_idempotence<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    max_in_flight_requests_per_connection<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    compression_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gzip&#39;</span>,
</span></span><span style="display:flex;"><span>    batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">10240</span>,
</span></span><span style="display:flex;"><span>    linger_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>    key_serializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> k: json<span style="color:#f92672">.</span>dumps(k)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>) <span style="color:#66d9ef">if</span> k <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    value_serializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> v: json<span style="color:#f92672">.</span>dumps(v)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>) <span style="color:#66d9ef">if</span> v <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>):
</span></span><span style="display:flex;"><span>    producer<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#39;foobar&#39;</span>, <span style="color:#e6db74">&#39;some_message_bytes&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>producer<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><hr>
<p><font color=red><strong>max_block_ms</strong>  </font></p>
<blockquote>
<p>该参数用来设置生产者内存缓冲区的大小，生产者用它缓冲要发送到服务器的消息。如果应用程序发送消息的速度超过发送到服务器的速度，会导致生产者空间不足。这个时候，send() 方法调用要么被阻塞，要么抛出异常。max.block.ms表示在抛出异常之前可以阻塞一段时间 默认60000</p>
</blockquote>
<p><font color=red><strong>client_id</strong>  </font></p>
<blockquote>
<p>可以是任意的字符串，服务器会用它来识别消息的来源</p>
</blockquote>
<p><font color=red><strong>request_timeout_ms</strong>  </font></p>
<blockquote>
<p>生产者在发送数据时等待服务器返回响应的时间 ，默认 30000</p>
</blockquote>
<p><font color=red><strong>max_request_size</strong>  </font></p>
<blockquote>
<p>能发送的单个消息的最大值。小于等于broker中 <code>message.max.bytes</code> 配置，否则可能被broker拒绝</p>
</blockquote>
<p><font color=red><strong>max_request_size | receive_buffer_bytes | send_buffer_bytes</strong>  </font></p>
<blockquote>
<p>TCP socket 接收和发送数据包的缓冲区大小。</p>
<p>如果它们被设为 -1，就使用操作系统的默认值。如果生产者或消费者与 broker 处于不同的数据中心，那么可以适当增大这些值，因为跨数据中心的网络一般都有比较高的延迟和比较低的带宽。</p>
</blockquote>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <hr>
<p><font color=red><strong>bootstrap_servers</strong>  </font></p>
<blockquote>
<p>数据类型 <code>str|list</code></p>
<p>Kafka 集 群 的 连 接 字 符 串,至少填写kafka 集群中的一个节点。</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaConsumer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>counsumer <span style="color:#f92672">=</span> KafkaConsumer(bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092,192.168.0.152:9092,192.168.0.153:9092&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># producer = KafkaConsumer(bootstrap_servers=[&#39;192.168.0.151:9092&#39;,&#39;192.168.0.152:9092&#39;,&#39;192.168.0.153:9092&#39;])</span>
</span></span></code></pre></div><hr>
<p><font color=red><strong>client_id</strong></font></p>
<blockquote>
<p>数据类型 <code>str</code></p>
<p>可以是任意字符串，broker 用它来标识从客户端发送过来的消息，通常被用在日志、度量指标和配额里。</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaConsumer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>consumer <span style="color:#f92672">=</span> KafkaConsumer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    client_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;consumer-1&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><hr>
<p><font color=red><strong>group_id</strong></font></p>
<blockquote>
<p>数据类型 <code>str</code></p>
<p>标识消费者组名称</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaConsumer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>consumer <span style="color:#f92672">=</span> KafkaConsumer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    client_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;consumer-1&#39;</span>,
</span></span><span style="display:flex;"><span>    group_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;group-1&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><hr>
<p><font color=red><strong>enable_auto_commit | auto_commit_interval_ms</strong></font></p>
<blockquote>
<p>enable_auto_commit 数据类型 <code>bool</code></p>
<p>指定了消费者是否自动提交偏移量，默认值是 true。为了尽量避免出现重复数据和数据丢失，可以把它设为 false，由自己控制何时提交偏移量。如果把它设为 true，还可以通过配置 <code>auto_commit_interval_ms</code>	属性来控制提交的频率。</p>
<hr>
<p><code>auto_commit_interval_ms</code> 自动提交的间隔 默认值5000（5s）</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaConsumer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>consumer <span style="color:#f92672">=</span> KafkaConsumer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    client_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;consumer-1&#39;</span>,
</span></span><span style="display:flex;"><span>    group_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;group-1&#39;</span>,
</span></span><span style="display:flex;"><span>    enable_auto_commit<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><hr>
<p><font color=red><strong>auto_offset_reset</strong></font></p>
<blockquote>
<p>可选类型 <code>'earliest'</code>、<code>  'latest'</code></p>
<p>指定了消费者在读取一个没有偏移量的分区或者偏移量无效的情况下（因消费者长时间失效，包含偏移量的记录已经过时并被删除）该作何处理。它的默认值是 latest</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaConsumer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>consumer <span style="color:#f92672">=</span> KafkaConsumer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    client_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;client-1&#39;</span>,
</span></span><span style="display:flex;"><span>    group_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;group-1&#39;</span>,
</span></span><span style="display:flex;"><span>    enable_auto_commit<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    auto_offset_reset<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;earliest&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><hr>
<p><font color=red><strong>key_deserializer | value_deserializer</strong></font></p>
<blockquote>
<p>Any callable that takes a raw message key and returns a deserialized key.</p>
<p>key的反序列化，与生产者中<code>key_serializer</code> 对应</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaConsumer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>consumer <span style="color:#f92672">=</span> KafkaConsumer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    client_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;client-1&#39;</span>,
</span></span><span style="display:flex;"><span>    group_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;group-1&#39;</span>,
</span></span><span style="display:flex;"><span>    enable_auto_commit<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    auto_offset_reset<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;earliest&#39;</span>,
</span></span><span style="display:flex;"><span>    key_deserializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> m: json<span style="color:#f92672">.</span>loads(m<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)) <span style="color:#66d9ef">if</span> m <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    value_deserializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> m: json<span style="color:#f92672">.</span>loads(m<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)) <span style="color:#66d9ef">if</span> m <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><hr>
<p><font color=red> <strong>fetch_min_bytes | fetch_max_wait_ms</strong></font>  目的是在性能和延迟之间找到一个均衡</p>
<blockquote>
<p><code>fetch_min_bytes </code>broker 在收到消费者的数据请求时，如果可用的数据量小于 fetch_min_bytes 指定的大小，那么它会等到有足够的可用数据时才把它返回给消费者。该参数为了减少网络io</p>
<hr>
<p><code>fetch_max_wait_ms</code>  指定broker最大等待多少ms将响应数据发送给consumer，默认是 500ms。例如：fetch_min_bytes被设为 1MB，fetch_max_wait_ms被设为 100ms, 那么 Kafka 在收到消费者的请求后，要么返回 1MB 数据，要么在 100ms 后返回所有可用的数据，就看哪个条件先得到满足。</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaConsumer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>consumer <span style="color:#f92672">=</span> KafkaConsumer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    client_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;client-1&#39;</span>,
</span></span><span style="display:flex;"><span>    group_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;group-1&#39;</span>,
</span></span><span style="display:flex;"><span>    enable_auto_commit<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    auto_offset_reset<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;earliest&#39;</span>,
</span></span><span style="display:flex;"><span>    key_deserializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> m: json<span style="color:#f92672">.</span>loads(m<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)) <span style="color:#66d9ef">if</span> m <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    value_deserializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> m: json<span style="color:#f92672">.</span>loads(m<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)) <span style="color:#66d9ef">if</span> m <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    fetch_min_bytes<span style="color:#f92672">=</span><span style="color:#ae81ff">1024000</span>,
</span></span><span style="display:flex;"><span>    fetch_max_wait_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><hr>
<p><font color=red><strong>session_timeout_ms | heartbeat_interval_ms</strong></font> 用于检测消费组中消费者是否断开，是否需要执行在均衡</p>
<blockquote>
<p><code>session_timeout_ms </code>指定了消费者在被认为死亡之前可以与服务器断开连接的时间，默认是 3s。如果消费者没有<code>session_timeout_ms</code> 指定的时间内发送心跳给群组协调器，就被认为已经死亡，协调器就会触发再均衡，把它的分区分配给群组里的其他消费者。</p>
<hr>
<p><code>heartbeat_interval_ms</code>  指定了 poll() 方法向协调器发送心跳的频率</p>
<p>,一般需要同时修改这两个属性通常 <code>heartbeat_interval_ms</code>  = 1/3 * <code>session_timeout_ms</code></p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaConsumer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>consumer <span style="color:#f92672">=</span> KafkaConsumer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    client_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;client-1&#39;</span>,
</span></span><span style="display:flex;"><span>    group_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;group-1&#39;</span>,
</span></span><span style="display:flex;"><span>    enable_auto_commit<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    auto_offset_reset<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;earliest&#39;</span>,
</span></span><span style="display:flex;"><span>    key_deserializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> m: json<span style="color:#f92672">.</span>loads(m<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)) <span style="color:#66d9ef">if</span> m <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    value_deserializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> m: json<span style="color:#f92672">.</span>loads(m<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)) <span style="color:#66d9ef">if</span> m <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    fetch_min_bytes<span style="color:#f92672">=</span><span style="color:#ae81ff">1024000</span>,
</span></span><span style="display:flex;"><span>    fetch_max_wait_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>,
</span></span><span style="display:flex;"><span>    session_timeout_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>    heartbeat_interval_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><hr>
<p><font color=red><strong>max_poll_records</strong></font></p>
<blockquote>
<p>属性用于控制单次调用 call() 方法能够返回的记录数量，可以帮你控制在轮询里需要处理的数据量。默认500</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaConsumer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>consumer <span style="color:#f92672">=</span> KafkaConsumer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    client_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;client-1&#39;</span>,
</span></span><span style="display:flex;"><span>    group_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;group-1&#39;</span>,
</span></span><span style="display:flex;"><span>    enable_auto_commit<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    auto_offset_reset<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;earliest&#39;</span>,
</span></span><span style="display:flex;"><span>    key_deserializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> m: json<span style="color:#f92672">.</span>loads(m<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)) <span style="color:#66d9ef">if</span> m <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    value_deserializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> m: json<span style="color:#f92672">.</span>loads(m<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)) <span style="color:#66d9ef">if</span> m <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    fetch_min_bytes<span style="color:#f92672">=</span><span style="color:#ae81ff">1024000</span>,
</span></span><span style="display:flex;"><span>    fetch_max_wait_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>,
</span></span><span style="display:flex;"><span>    session_timeout_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>    heartbeat_interval_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    max_poll_records<span style="color:#f92672">=</span><span style="color:#ae81ff">500</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><hr>
<p><font color=red><strong>partition_assignment_strategy</strong></font></p>
<blockquote>
<p>根据给定的消费者和主题，决定哪些分区应该被分配给哪个消费者</p>
<p>Range</p>
<p>该策略会把主题的若干个连续的分区分配给消费者。假设消费者 C1 和消费者 C2 同时</p>
<p>订阅了主题 T1 和主题 T2，并且每个主题有 3 个分区。那么消费者 C1 有可能分配到这</p>
<p>两个主题的分区 0 和分区 1，而消费者 C2 分配到这两个主题的分区 2。因为每个主题</p>
<p>拥有奇数个分区，而分配是在主题内独立完成的，第一个消费者最后分配到比第二个消</p>
<p>费者更多的分区。只要使用了 Range 策略，而且分区数量无法被消费者数量整除，就会</p>
<p>出现这种情况。</p>
<p>RoundRobin</p>
<p>该策略把主题的所有分区逐个分配给消费者。如果使用 RoundRobin 策略来给消费者 C1</p>
<p>和消费者 C2 分配分区，那么消费者 C1 将分到主题 T1 的分区 0 和分区 2 以及主题 T2</p>
<p>的分区 1，消费者 C2 将分配到主题 T1 的分区 1 以及主题 T2 的分区 0 和分区 2。一般</p>
<p>来说，如果所有消费者都订阅相同的主题（这种情况很常见），RoundRobin 策略会给所</p>
<p>有消费者分配相同数量的分区（或最多就差一个分区）。</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaConsumer
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka.coordinator.assignors.roundrobin <span style="color:#f92672">import</span> RoundRobinPartitionAssignor 
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka.coordinator.assignors.range <span style="color:#f92672">import</span> RangePartitionAssignor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>consumer <span style="color:#f92672">=</span> KafkaConsumer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    client_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;client-1&#39;</span>,
</span></span><span style="display:flex;"><span>    group_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;group-1&#39;</span>,
</span></span><span style="display:flex;"><span>    enable_auto_commit<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    auto_offset_reset<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;earliest&#39;</span>,
</span></span><span style="display:flex;"><span>    key_deserializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> m: json<span style="color:#f92672">.</span>loads(m<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)) <span style="color:#66d9ef">if</span> m <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    value_deserializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> m: json<span style="color:#f92672">.</span>loads(m<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)) <span style="color:#66d9ef">if</span> m <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    fetch_min_bytes<span style="color:#f92672">=</span><span style="color:#ae81ff">1024000</span>,
</span></span><span style="display:flex;"><span>    fetch_max_wait_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>,
</span></span><span style="display:flex;"><span>    session_timeout_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>    heartbeat_interval_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    max_poll_records<span style="color:#f92672">=</span><span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>    partition_assignment_strategy<span style="color:#f92672">=</span>[RoundRobinPartitionAssignor,RangePartitionAssignor]
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><hr>
<p><font color=red><strong>receive.buffer.bytes | send.buffer.bytes</strong></font></p>
<blockquote>
<p>socket 在读写数据时用到的 TCP 缓冲区也可以设置大小。如果它们被设为 -1，就使用操</p>
<p>作系统的默认值。如果生产者或消费者与 broker 处于不同的数据中心内，可以适当增大这</p>
<p>些值，因为跨数据中心的网络一般都有比较高的延迟和比较低的带宽。</p>
</blockquote>
<p><em>示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaConsumer
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka.coordinator.assignors.roundrobin <span style="color:#f92672">import</span> RoundRobinPartitionAssignor 
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka.coordinator.assignors.range <span style="color:#f92672">import</span> RangePartitionAssignor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>consumer <span style="color:#f92672">=</span> KafkaConsumer(
</span></span><span style="display:flex;"><span>    bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092&#39;</span>,
</span></span><span style="display:flex;"><span>    client_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;client-1&#39;</span>,
</span></span><span style="display:flex;"><span>    group_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;group-1&#39;</span>,
</span></span><span style="display:flex;"><span>    enable_auto_commit<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    auto_offset_reset<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;earliest&#39;</span>,
</span></span><span style="display:flex;"><span>    key_deserializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> m: json<span style="color:#f92672">.</span>loads(m<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)) <span style="color:#66d9ef">if</span> m <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    value_deserializer<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> m: json<span style="color:#f92672">.</span>loads(m<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)) <span style="color:#66d9ef">if</span> m <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    fetch_min_bytes<span style="color:#f92672">=</span><span style="color:#ae81ff">1024000</span>,
</span></span><span style="display:flex;"><span>    fetch_max_wait_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>,
</span></span><span style="display:flex;"><span>    session_timeout_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">30000</span>,
</span></span><span style="display:flex;"><span>    heartbeat_interval_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">2000</span>,
</span></span><span style="display:flex;"><span>    max_poll_records<span style="color:#f92672">=</span><span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>    partition_assignment_strategy<span style="color:#f92672">=</span>[RoundRobinPartitionAssignor,RangePartitionAssignor],
</span></span><span style="display:flex;"><span>    receive_buffer_bytes<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    send_buffer_bytes<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 订阅topic</span>
</span></span><span style="display:flex;"><span>consumer<span style="color:#f92672">.</span>subscribe([<span style="color:#e6db74">&#39;test&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 拉取topic数据</span>
</span></span><span style="display:flex;"><span>        msg<span style="color:#f92672">=</span>consumer<span style="color:#f92672">.</span>poll(timeout_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">5000</span>,
</span></span><span style="display:flex;"><span>                    max_records<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> k,v <span style="color:#f92672">in</span> msg<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> v:
</span></span><span style="display:flex;"><span>                print(m<span style="color:#f92672">.</span>value)
</span></span><span style="display:flex;"><span>        consumer<span style="color:#f92672">.</span>commit_async()        
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># time.sleep(10)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>    consumer<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><hr>
<p><font color=red><strong>max_partition_fetch_bytes</strong></font></p>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <hr>
<p><font color=red><strong>create_topics</strong></font></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaAdminClient
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka.admin <span style="color:#f92672">import</span> NewTopic
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>admin_client <span style="color:#f92672">=</span> KafkaAdminClient(bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建 kubeevents 和 kubeaudit 多个topic</span>
</span></span><span style="display:flex;"><span>admin_client<span style="color:#f92672">.</span>create_topics([
</span></span><span style="display:flex;"><span>    NewTopic(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kubeevents&#39;</span>, num_partitions<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, replication_factor<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>),
</span></span><span style="display:flex;"><span>    NewTopic(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kubeaudit&#39;</span>, num_partitions<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, replication_factor<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>),
</span></span><span style="display:flex;"><span>    ])
</span></span></code></pre></div><p><em>创建topic时手动指定分区所在的broker,<code>replica_assignments</code></em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka <span style="color:#f92672">import</span> KafkaAdminClient
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka.admin <span style="color:#f92672">import</span> NewTopic
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kafka.errors <span style="color:#f92672">import</span> TopicAlreadyExistsError
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>admin_client <span style="color:#f92672">=</span> KafkaAdminClient(bootstrap_servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.0.151:9092&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {0: [1, 2, 0]} 0表示partition 0 ,[1,2,0]对应brokerid 其中列表中第一个id为主分片</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    admin_client<span style="color:#f92672">.</span>create_topics([
</span></span><span style="display:flex;"><span>        NewTopic(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kubeevents&#39;</span>, num_partitions<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, replication_factor<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>),
</span></span><span style="display:flex;"><span>        NewTopic(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kubeaudit&#39;</span>, num_partitions<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>, replication_factor<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>,replica_assignments<span style="color:#f92672">=</span>{<span style="color:#ae81ff">0</span>: [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">1</span>: [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">2</span>: [<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>]}),
</span></span><span style="display:flex;"><span>        ])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> TopicAlreadyExistsError:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div>
    </div>
</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-da72bccd00d9cae50240b122f9fef791">6.2.1.3 - kubernetes</h1>
    <div class="lead">库|python</div>
	

<div class="alert alert-primary" role="alert">


    <p>kubernetes版本: <code>1.23.17</code></p>
<p>python版本：<code>3.6+</code></p>
<p>安装：<code>pip install kubernetes==23.6.0 </code></p>
<p>文档：<code>https://github.com/kubernetes-client/python</code></p>


</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> kubernetes <span style="color:#f92672">import</span> client, config,watch
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configs can be set in Configuration class directly or using helper utility</span>
</span></span><span style="display:flex;"><span>config<span style="color:#f92672">.</span>load_kube_config(config_file<span style="color:#f92672">=</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;C:\Users\pc\Desktop\kubeconfing&#39;</span>)
</span></span><span style="display:flex;"><span>w <span style="color:#f92672">=</span> watch<span style="color:#f92672">.</span>Watch()
</span></span><span style="display:flex;"><span>v1 <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>CoreV1Api()
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> w<span style="color:#f92672">.</span>stream(v1<span style="color:#f92672">.</span>list_namespaced_event, <span style="color:#e6db74">&#39;kube-system&#39;</span>, watch<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> ret:
</span></span><span style="display:flex;"><span>    print(item[<span style="color:#e6db74">&#39;object&#39;</span>]<span style="color:#f92672">.</span>message)
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a954c348f509983e05c14c4953dddd9c">6.2.1.4 - kopf</h1>
    <div class="lead">kopf是一个kubernetes的operator框架，用于开发自定义的controller。</div>
	

<div class="alert alert-primary" role="alert">


    <p>kubernetes版本: <code>1.23.17</code></p>
<p>python版本：<code>3.6+</code></p>
<p>安装：<code>pip install kubernetes==23.6.0 </code></p>
<p>文档：<code>https://github.com/kubernetes-client/python</code>  <code>https://kopf.readthedocs.io/en/stable/index.html</code></p>
<p>​</p>


</div>


</div>



    
	
  

    
	
  

    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-593e803ca4275cbee5da083ad76cc9bc"></h1>
	<div class="lead">database 文档中心</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	<p>通常数据库需要服务器提供低延迟、高i/o的能力</p>
<p>开启服务器的性能优化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo performance | tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
</span></span></code></pre></div>
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-daab71bd6c339cc69eec143a409d109c">7.1 - </h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-ab65920c557ab2b33439fc56e73645b6">install mysql5.6</h1>
	<div class="lead">mysql 5.6版本二进制安装和编译安装</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	<h3 id="部署安装">部署安装</h3>
<ul>
<li>
<p>实例名称 <code>mysql-01</code> 示例使用全局变量引用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export clsName<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mysql-01&#39;</span>
</span></span></code></pre></div></li>
</ul>
<ol>
<li>
<p>添加用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>useradd -s /sbin/nologin -u <span style="color:#ae81ff">3306</span> -M mysql
</span></span></code></pre></div><p>安装mysql依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># libaio提供 Linux 原生异步 I/O（AIO）支持，允许程序发起非阻塞的磁盘读写操作，提高高并发场景下的 I/O 性能</span>
</span></span><span style="display:flex;"><span>yum install -y libaio libaio-devel ncurses ncurses-devel cpanminus
</span></span></code></pre></div></li>
<li>
<p>mysql软件安装，示例安装在<code>/opt/mysql</code>目录下</p>

    
    
    
<ul class="nav nav-tabs justify-content-end" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>软件安装</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="二进制安装" aria-controls="tabs-00-01" aria-selected="true">
        二进制安装
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="编译安装" aria-controls="tabs-00-02" aria-selected="false">
        编译安装
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <p><em>软件下载</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://downloads.mysql.com/archives/get/p/23/file/mysql-5.6.40-linux-glibc2.12-x86_64.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf mysql-5.6.40-linux-glibc2.12-x86_64.tar.gz -C /opt
</span></span></code></pre></div><p><em>安装到/opt/mysql下</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln -svf /opt/<span style="color:#f92672">{</span>mysql-5.6.40-linux-glibc2.12-x86_64,mysql<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>ln -svf /opt/mysql-5.6.40-linux-glibc2.12-x86_64/bin/mysql /usr/bin/mysql
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <p><em>软件下载</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://downloads.mysql.com/archives/get/p/23/file/mysql-5.6.40.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf mysql-5.6.40.tar.gz -C /opt
</span></span><span style="display:flex;"><span>cd /opt/mysql-5.6.40
</span></span></code></pre></div><p><em>安装编译依赖</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y cmake  libaio-devel  gcc-c++ perl-devel cpanminus ncurses-devel
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cmake . -DCMAKE_INSTALL_PREFIX<span style="color:#f92672">=</span>/opt/mysql <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DMYSQL_DATADIR<span style="color:#f92672">=</span>/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DMYSQL_UNIX_ADDR<span style="color:#f92672">=</span>/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DDEFAULT_CHARSET<span style="color:#f92672">=</span>utf8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DDEFAULT_COLLATION<span style="color:#f92672">=</span>utf8_general_ci <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_EXTRA_CHARSETs<span style="color:#f92672">=</span>all <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_INNOBASE_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_FEDERATED_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_BLACKHOLE_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_EXAMPLE_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_ZLIB<span style="color:#f92672">=</span>bundled <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_SSL<span style="color:#f92672">=</span>bundled <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DENABLED_LOCAL_INFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_EMBEDDED_SERVER<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DENABLE_DOWNLOADS<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_DEBUG<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make -j <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> make install
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> ln -svf /opt/mysql/bin/mysql /usr/bin/mysql
</span></span></code></pre></div>
    </div>
</div>

</li>
<li>
<p>初始化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 构建目录结构</span>
</span></span><span style="display:flex;"><span>mkdir -p /data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/<span style="color:#f92672">{</span>data,binlog,logs,relay_log,conf<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>chown -R mysql:mysql /data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化数据库</span>
</span></span><span style="display:flex;"><span>/opt/mysql/scripts/mysql_install_db <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--basedir<span style="color:#f92672">=</span>/opt/mysql/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--datadir<span style="color:#f92672">=</span>/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--explicit_defaults_for_timestamp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>mysql
</span></span></code></pre></div>
<details>
  <summary>Details</summary>
  <pre tabindex="0"><code class="language-log" data-lang="log">[root@seagullcore01-uat-s2 ~]# /opt/mysql/scripts/mysql_install_db \
&gt; --basedir=/opt/mysql/ \
&gt; --datadir=/data/instances/${clsName}/data \
&gt; --explicit_defaults_for_timestamp \
&gt; --user=mysql
Installing MySQL system tables...2025-07-28 11:23:40 0 [Note] Ignoring --secure-file-priv value as server is running with --bootstrap.
2025-07-28 11:23:40 0 [Note] /opt/mysql//bin/mysqld (mysqld 5.6.40) starting as process 29771 ...
2025-07-28 11:23:40 29771 [Note] InnoDB: Using atomics to ref count buffer pool pages
2025-07-28 11:23:40 29771 [Note] InnoDB: The InnoDB memory heap is disabled
2025-07-28 11:23:40 29771 [Note] InnoDB: Mutexes and rw_locks use GCC atomic builtins
2025-07-28 11:23:40 29771 [Note] InnoDB: Memory barrier is not used
2025-07-28 11:23:40 29771 [Note] InnoDB: Compressed tables use zlib 1.2.3
2025-07-28 11:23:40 29771 [Note] InnoDB: Using Linux native AIO
2025-07-28 11:23:40 29771 [Note] InnoDB: Using CPU crc32 instructions
2025-07-28 11:23:40 29771 [Note] InnoDB: Initializing buffer pool, size = 128.0M
2025-07-28 11:23:40 29771 [Note] InnoDB: Completed initialization of buffer pool
2025-07-28 11:23:40 29771 [Note] InnoDB: The first specified data file ./ibdata1 did not exist: a new database to be created!
2025-07-28 11:23:40 29771 [Note] InnoDB: Setting file ./ibdata1 size to 12 MB
2025-07-28 11:23:40 29771 [Note] InnoDB: Database physically writes the file full: wait...
2025-07-28 11:23:40 29771 [Note] InnoDB: Setting log file ./ib_logfile101 size to 48 MB
2025-07-28 11:23:40 29771 [Note] InnoDB: Setting log file ./ib_logfile1 size to 48 MB
2025-07-28 11:23:40 29771 [Note] InnoDB: Renaming log file ./ib_logfile101 to ./ib_logfile0
2025-07-28 11:23:40 29771 [Warning] InnoDB: New log files created, LSN=45781
2025-07-28 11:23:40 29771 [Note] InnoDB: Doublewrite buffer not found: creating new
2025-07-28 11:23:40 29771 [Note] InnoDB: Doublewrite buffer created
2025-07-28 11:23:40 29771 [Note] InnoDB: 128 rollback segment(s) are active.
2025-07-28 11:23:40 29771 [Warning] InnoDB: Creating foreign key constraint system tables.
2025-07-28 11:23:40 29771 [Note] InnoDB: Foreign key constraint system tables created
2025-07-28 11:23:40 29771 [Note] InnoDB: Creating tablespace and datafile system tables.
2025-07-28 11:23:40 29771 [Note] InnoDB: Tablespace and datafile system tables created.
2025-07-28 11:23:40 29771 [Note] InnoDB: Waiting for purge to start
2025-07-28 11:23:40 29771 [Note] InnoDB: 5.6.40 started; log sequence number 0
2025-07-28 11:23:41 29771 [Note] Binlog end
2025-07-28 11:23:41 29771 [Note] InnoDB: FTS optimize thread exiting.
2025-07-28 11:23:41 29771 [Note] InnoDB: Starting shutdown...
2025-07-28 11:23:42 29771 [Note] InnoDB: Shutdown completed; log sequence number 1625977
OK

Filling help tables...2025-07-28 11:23:42 0 [Note] Ignoring --secure-file-priv value as server is running with --bootstrap.
2025-07-28 11:23:42 0 [Note] /opt/mysql//bin/mysqld (mysqld 5.6.40) starting as process 29794 ...
2025-07-28 11:23:42 29794 [Note] InnoDB: Using atomics to ref count buffer pool pages
2025-07-28 11:23:42 29794 [Note] InnoDB: The InnoDB memory heap is disabled
2025-07-28 11:23:42 29794 [Note] InnoDB: Mutexes and rw_locks use GCC atomic builtins
2025-07-28 11:23:42 29794 [Note] InnoDB: Memory barrier is not used
2025-07-28 11:23:42 29794 [Note] InnoDB: Compressed tables use zlib 1.2.3
2025-07-28 11:23:42 29794 [Note] InnoDB: Using Linux native AIO
2025-07-28 11:23:42 29794 [Note] InnoDB: Using CPU crc32 instructions
2025-07-28 11:23:42 29794 [Note] InnoDB: Initializing buffer pool, size = 128.0M
2025-07-28 11:23:42 29794 [Note] InnoDB: Completed initialization of buffer pool
2025-07-28 11:23:42 29794 [Note] InnoDB: Highest supported file format is Barracuda.
2025-07-28 11:23:42 29794 [Note] InnoDB: 128 rollback segment(s) are active.
2025-07-28 11:23:42 29794 [Note] InnoDB: Waiting for purge to start
2025-07-28 11:23:43 29794 [Note] InnoDB: 5.6.40 started; log sequence number 1625977
2025-07-28 11:23:43 29794 [Note] Binlog end
2025-07-28 11:23:43 29794 [Note] InnoDB: FTS optimize thread exiting.
2025-07-28 11:23:43 29794 [Note] InnoDB: Starting shutdown...
2025-07-28 11:23:44 29794 [Note] InnoDB: Shutdown completed; log sequence number 1625987
OK

To start mysqld at boot time you have to copy
support-files/mysql.server to the right place for your system

PLEASE REMEMBER TO SET A PASSWORD FOR THE MySQL root USER !
To do so, start the server, then issue the following commands:

  /opt/mysql//bin/mysqladmin -u root password &#39;new-password&#39;
  /opt/mysql//bin/mysqladmin -u root -h seagullcore01-uat-s2 password &#39;new-password&#39;

Alternatively you can run:

  /opt/mysql//bin/mysql_secure_installation

which will also give you the option of removing the test
databases and anonymous user created by default.  This is
strongly recommended for production servers.

See the manual for more instructions.

You can start the MySQL daemon with:

  cd . ; /opt/mysql//bin/mysqld_safe &amp;

You can test the MySQL daemon with mysql-test-run.pl

  cd mysql-test ; perl mysql-test-run.pl

Please report any problems at http://bugs.mysql.com/

The latest information about MySQL is available on the web at

  http://www.mysql.com

Support MySQL by buying support/licenses at http://shop.mysql.com

New default config file was created as /opt/mysql//my.cnf and
will be used by default by the server when you start it.
You may edit this file to change server settings

WARNING: Default config file /etc/my.cnf exists on the system
This file will be read by default by the MySQL server
If you do not want to use this, either remove it, or use the
--defaults-file argument to mysqld_safe when starting the server
</code></pre></details>

</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/conf/my.cnf<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mysqld]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">performance_schema=ON
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server_id=1921680152
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port=3306
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">character-set-server=utf8mb4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basedir=/opt/mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datadir=/data/instances/${clsName}/data/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pid-file=/data/instances/${clsName}/mysql.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socket=/data/instances/${clsName}/mysql.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log_error=/data/instances/${clsName}/logs/mysql-error.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">slow_query_log_file=/data/instances/${clsName}/logs/mysql_slow_query.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">slow_query_log=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">long_query_time=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">binlog_format=row
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-bin=/data/instances/${clsName}/binlog/log_bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-bin-index=/data/instances/${clsName}/binlog/binlog.index
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#gtid-mode=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#enforce-gtid-consistency=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log=/data/instances/${clsName}/relay_log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log_index=/data/instances/${clsName}/relaylog/relay-bin.index
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log_recovery=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_authentication_plugin=mysql_native_password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">master_info_repository=table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log_info_repository=table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/mysql.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=mysql service https://dev.mysql.com/doc/refman/5.6/en
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/mysql/bin/mysqld_safe \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--defaults-file=/data/instances/mysql-01/conf/my.cnf \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--pid-file=/data/instances/mysql-01/mysql.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/bin/kill -HUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置最大文件描述符
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=1024
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置CPU使用率限制为50%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CPUQuota=50%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置内存限制为1G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MemoryLimit=1G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable mysql --now
</span></span><span style="display:flex;"><span>systemctl status  mysql
</span></span></code></pre></div></li>
<li>
<p>创建用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 修改root密码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>; 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 超管用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">grant</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">privileges</span> <span style="color:#66d9ef">on</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">OPTION</span> ;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 管理用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;rdsAdmin&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">grant</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">privileges</span> <span style="color:#66d9ef">on</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;rdsAdmin&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">OPTION</span>  ; 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 复制用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;rdsRpl&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> REPLICATION SLAVE, REPLICATION CLIENT <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;rdsRpl&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div></li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-aa85c31520ed761c10303a065029e27b">install mysql5.7</h1>
	<div class="lead">mysql 5.7版本二进制安装和编译安装</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	<h3 id="部署安装">部署安装</h3>
<ul>
<li>
<p>实例名称 <code>mysql-01</code> 示例使用全局变量引用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export clsName<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mysql-01&#39;</span>
</span></span></code></pre></div></li>
</ul>
<ol>
<li>
<p>添加用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>useradd -s /sbin/nologin -u <span style="color:#ae81ff">3306</span> -M mysql
</span></span></code></pre></div><p>安装mysql依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># libaio提供 Linux 原生异步 I/O（AIO）支持，允许程序发起非阻塞的磁盘读写操作，提高高并发场景下的 I/O 性能</span>
</span></span><span style="display:flex;"><span>yum install -y libaio libaio-devel ncurses ncurses-devel cpanminus
</span></span></code></pre></div></li>
<li>
<p>mysql软件安装，示例安装在<code>/opt/mysql</code>目录下</p>

    
    
    
<ul class="nav nav-tabs justify-content-end" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>软件安装</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="二进制安装" aria-controls="tabs-00-01" aria-selected="true">
        二进制安装
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="编译安装" aria-controls="tabs-00-02" aria-selected="false">
        编译安装
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <p><em>软件下载</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.40-linux-glibc2.12-x86_64.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf mysql-5.7.40-linux-glibc2.12-x86_64.tar.gz -C /opt
</span></span></code></pre></div><p><em>安装到/opt/mysql下</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln -svf /opt/<span style="color:#f92672">{</span>mysql-5.7.40-linux-glibc2.12-x86_64,mysql<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>ln -svf /opt/mysql-5.7.40-linux-glibc2.12-x86_64/bin/mysql /usr/bin/mysql
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <p><em>软件下载,5.7.5之后的版本需要boost</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://downloads.mysql.com/archives/get/p/23/file/mysql-boost-5.7.40.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf mysql-boost-5.7.40.tar.gz -C /opt
</span></span><span style="display:flex;"><span>cd /opt/mysql-5.7.40
</span></span></code></pre></div><p><em>安装编译依赖</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y cmake  libaio-devel  gcc-c++ perl-devel cpanminus ncurses-devel
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cmake . -DCMAKE_INSTALL_PREFIX<span style="color:#f92672">=</span>/opt/mysql <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DMYSQL_DATADIR<span style="color:#f92672">=</span>/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DMYSQL_UNIX_ADDR<span style="color:#f92672">=</span>/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DDEFAULT_CHARSET<span style="color:#f92672">=</span>utf8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DDEFAULT_COLLATION<span style="color:#f92672">=</span>utf8_general_ci <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_EXTRA_CHARSETs<span style="color:#f92672">=</span>all <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_INNOBASE_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_FEDERATED_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_BLACKHOLE_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_EXAMPLE_STORAGE_ENGINE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_ZLIB<span style="color:#f92672">=</span>system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_SSL<span style="color:#f92672">=</span>system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DENABLED_LOCAL_INFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_EMBEDDED_SERVER<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DENABLE_DOWNLOADS<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_DEBUG<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-DWITH_BOOST<span style="color:#f92672">=</span>boost
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make -j <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> make install
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln -svf /opt/mysql/bin/mysql /usr/bin/mysql
</span></span></code></pre></div>
    </div>
</div>

</li>
<li>
<p>初始化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 构建目录结构</span>
</span></span><span style="display:flex;"><span>mkdir -p /data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/<span style="color:#f92672">{</span>data,binlog,logs,relay_log,conf<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>chown -R mysql:mysql /data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>配置文件


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">mysql从5.7开始支持 GTID(Global Transaction Identifiers)，开启gtid功能配置如下：</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">gtid-mode</span><span style="color:#f92672">=</span><span style="color:#e6db74">on</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enforce-gtid-consistency</span><span style="color:#f92672">=</span><span style="color:#e6db74">on</span>
</span></span></code></pre></div>

</div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/conf/my.cnf<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mysqld]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">performance_schema=ON
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server_id=1921680152
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port=3306
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">character-set-server=utf8mb4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basedir=/opt/mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datadir=/data/instances/${clsName}/data/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pid-file=/data/instances/${clsName}/mysql.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socket=/data/instances/${clsName}/mysql.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log_error=/data/instances/${clsName}/logs/mysql-error.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">slow_query_log_file=/data/instances/${clsName}/logs/mysql_slow_query.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">slow_query_log=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">long_query_time=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log_timestamps=SYSTEM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">binlog_format=row
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-bin=/data/instances/${clsName}/binlog/log_bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-bin-index=/data/instances/${clsName}/binlog/binlog.index
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gtid-mode=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enforce-gtid-consistency=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log=/data/instances/${clsName}/relay_log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log_index=/data/instances/${clsName}/relaylog/relay-bin.index
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log_recovery=on
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_authentication_plugin=mysql_native_password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">master_info_repository=table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay_log_info_repository=table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>初始化数据库


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">查看初始化密码</h4>

    <code>cat /data/instances/${clsName}/logs/mysql-error.log</code>

</div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/mysql/bin/mysqld --defaults-file<span style="color:#f92672">=</span>/data/instances/<span style="color:#e6db74">${</span>clsName<span style="color:#e6db74">}</span>/conf/my.cnf --user<span style="color:#f92672">=</span>mysql --initialize
</span></span></code></pre></div></li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/mysql.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=mysql service https://dev.mysql.com/doc/refman/5.7/en
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/mysql/bin/mysqld_safe \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--defaults-file=/data/instances/mysql-01/conf/my.cnf \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--pid-file=/data/instances/mysql-01/mysql.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/bin/kill -HUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置最大文件描述符
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=1024
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置CPU使用率限制为50%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CPUQuota=50%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置内存限制为1G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MemoryLimit=1G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable mysql --now
</span></span><span style="display:flex;"><span>systemctl status  mysql
</span></span></code></pre></div></li>
<li>
<p>创建用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 修改root密码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>; 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 超管用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">grant</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">privileges</span> <span style="color:#66d9ef">on</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">OPTION</span> ;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 管理用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;rdsAdmin&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">grant</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">privileges</span> <span style="color:#66d9ef">on</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;rdsAdmin&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">OPTION</span>  ; 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--- 复制用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;rdsRpl&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;li&lt;)&lt;#jyi9S)2024&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> REPLICATION SLAVE, REPLICATION CLIENT <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;rdsRpl&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div></li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c2bad65068c0dc6f4d1427dce06dd4fd">master_slave</h1>
	<div class="lead">mysql主从同步的原理和实现</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-04" class="text-body-secondary">Friday, July 04, 2025</time>
        
	</div>
	<table>
    <tr>
        <td><img src="/docs/database/mysql/主从架构.png" alt="主从架构图"></td>
        <td><img src="/docs/database/mysql/主从复制原理.png" alt="主从复制原理"></td>
    </tr>
</table>
<hr>
<h3 id="mater-slave-实现">Mater-Slave 实现</h3>
<p>主从是一种异步同步，主库在执行完客户端提交的事务后会立即将结果返回给客户端，并不关心从库是否已经接收并处理。


<div class="alert alert-warning" role="alert">


    <ol>
<li>主库开启binlog</li>
<li>主从之间设置不同的server_id</li>
<li>从库设置为只读，防止多点写入</li>
</ol>


</div>
</p>
<hr>

  
  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>搭建主备关系</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="主库" aria-controls="tabs-01-01" aria-selected="true">
        主库
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="从库" aria-controls="tabs-01-02" aria-selected="false">
        从库
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;replUser&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> IDENTIFIED  <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;RsU#58d1@&#39;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> REPLICATION SLAVE,REPLICATION CLIENT <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;replUser&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span>; 
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">---
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> MASTER STATUS;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----------------+----------+--------------+------------------+------------------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> File           <span style="color:#f92672">|</span> <span style="color:#66d9ef">Position</span> <span style="color:#f92672">|</span> Binlog_Do_DB <span style="color:#f92672">|</span> Binlog_Ignore_DB <span style="color:#f92672">|</span> Executed_Gtid_Set                        <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----------------+----------+--------------+------------------+------------------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> log_bin.<span style="color:#ae81ff">000002</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">551</span> <span style="color:#f92672">|</span>              <span style="color:#f92672">|</span>                  <span style="color:#f92672">|</span> b2a464ed<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>c16<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>f0<span style="color:#f92672">-</span><span style="color:#ae81ff">8445</span><span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c299bad95:<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----------------+----------+--------------+------------------+------------------------------------------+
</span></span></span></code></pre></div><p><strong>同步指定库/表</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">在主库的配置文件中执行</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[mysqld]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">binlog-do-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">mysql</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">binlog-do-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">radius</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">binlog-ignore-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">syslog</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">binlog-ignore-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">sys</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <h3 id="57-之前没有开启gtid的数据库">5.7 之前没有开启gtid的数据库</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">reset</span> slave <span style="color:#66d9ef">all</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">---
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>CHANGE MASTER <span style="color:#66d9ef">TO</span> 
</span></span><span style="display:flex;"><span>  MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;10.128.99.157&#39;</span>,
</span></span><span style="display:flex;"><span>  MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span>,
</span></span><span style="display:flex;"><span>  MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rdsRpl&#39;</span>,
</span></span><span style="display:flex;"><span>  MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RsU#58d1@&#39;</span>,
</span></span><span style="display:flex;"><span>  master_log_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;log_bin.000002&#39;</span>,
</span></span><span style="display:flex;"><span>  MASTER_LOG_POS<span style="color:#f92672">=</span><span style="color:#ae81ff">551</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">start</span> slave;<span style="color:#66d9ef">show</span> slave status <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 设置只读
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>;
</span></span></code></pre></div><h3 id="57-及之后版本开始gtid的数据库">5.7 及之后版本开始gtid的数据库</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">reset</span> slave <span style="color:#66d9ef">all</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">--- 重置gtid执行历史
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">reset</span> slave <span style="color:#66d9ef">all</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">reset</span> master;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> <span style="color:#f92672">@@</span><span style="color:#66d9ef">GLOBAL</span>.GTID_PURGED<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;b2a464ed-6c16-11f0-8445-000c299bad95:1-2&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">---
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>CHANGE MASTER <span style="color:#66d9ef">TO</span> 
</span></span><span style="display:flex;"><span>  MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;10.128.99.157&#39;</span>,
</span></span><span style="display:flex;"><span>  MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span>,
</span></span><span style="display:flex;"><span>  MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rdsRpl&#39;</span>,
</span></span><span style="display:flex;"><span>  MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RsU#58d1@&#39;</span>,
</span></span><span style="display:flex;"><span>  MASTER_AUTO_POSITION<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">start</span> slave;<span style="color:#66d9ef">show</span> slave status <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">关键指标：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Slave_IO_Running: Yes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Slave_SQL_Running: Yes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Seconds_Behind_Master: 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 设置只读
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>;
</span></span></code></pre></div><p><strong>同步指定库/表&ndash;在配置文件中指定</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">或在从库的配置文件中指定</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">[mysqld] </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">replicate-do-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">mysql</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">replicate-do-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">radius</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">replicate-ignore-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">syslog</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">replicate-ignore-db</span><span style="color:#f92672">=</span><span style="color:#e6db74">sys</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 通配符表级</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">replication-wild-do-table</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">db1.user_% </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">replication-wild-ignore-table</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">db1.log_%</span>
</span></span></code></pre></div><p><strong>同步指定库/表&ndash;动态修改</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 停止 SQL 线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>STOP SLAVE SQL_THREAD;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 修改过滤规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>CHANGE REPLICATION FILTER
</span></span><span style="display:flex;"><span>    REPLICATE_DO_DB <span style="color:#f92672">=</span> (db1, db2),
</span></span><span style="display:flex;"><span>    REPLICATE_IGNORE_TABLE <span style="color:#f92672">=</span> (db3.log);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 重新启动 SQL 线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">START</span> SLAVE SQL_THREAD;
</span></span></code></pre></div>
    </div>
</div>

<h3 id="主从报错处理">主从报错处理</h3>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">从库连接异常</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>Slave_IO_Running: Connecting
</span></span><span style="display:flex;"><span>Last_IO_Errno: <span style="color:#ae81ff">1045</span>
</span></span><span style="display:flex;"><span>Last_IO_Error: error connecting <span style="color:#66d9ef">to</span> master <span style="color:#e6db74">&#39;rep@168.101.1.177:3306&#39;</span> <span style="color:#f92672">-</span> retry<span style="color:#f92672">-</span>time: <span style="color:#ae81ff">60</span>  retries: <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>处理办法</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">update</span> mysql.<span style="color:#66d9ef">user</span> <span style="color:#66d9ef">set</span> authentication_string<span style="color:#f92672">=</span>password(<span style="color:#e6db74">&#39;rep&#39;</span>) <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">user</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rep&#39;</span>;
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div>

</div>



<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">从库sql线程错误</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">跳过主从复制的</span>sql线程错误
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> sql_slve_skip_counter  <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div>

</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-0e11fa2ec489b8755847ce6778235e54">mha</h1>
	<div class="lead">mha是使用ruby语言实现的高可用方案</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	<table>
  <thead>
      <tr>
          <th>主机名</th>
          <th>IP</th>
          <th>server_id</th>
          <th>角色</th>
          <th>版本</th>
          <th>设置</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>mysqldbphw01</td>
          <td>172.32.4.10/24</td>
          <td>1</td>
          <td><code>master</code>/<code>MHA Node</code></td>
          <td>5.6.40</td>
          <td>1.设置server-id<br>2.开启binlog<br>3.配置vip 172.32.4.50/24</td>
      </tr>
      <tr>
          <td>mysqldbphw02</td>
          <td>172.32.4.20/24</td>
          <td>2</td>
          <td><code>slave</code>/<code>MHA Node</code></td>
          <td>5.6.40</td>
          <td>1.设置server-id<br>2.设置为只读</td>
      </tr>
      <tr>
          <td>mysqldbphw03</td>
          <td>172.32.4.30/24</td>
          <td>3</td>
          <td><code>slave</code>/<code>MHA Node</code></td>
          <td>5.6.40</td>
          <td>1.设置server-id<br/>2.设置为只读</td>
      </tr>
      <tr>
          <td>mysqldbphw04</td>
          <td>172.32.4.40/24</td>
          <td></td>
          <td><code>MHA Manager</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>

<div class="alert alert-primary" role="alert">


    <ul>
<li>添加一个vip 用于应用接入</li>
<li>设置ssh免密要认证，用于failover时执行网络、binlog拷贝等动作</li>
</ul>


</div>
</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ifconfig eth0:2 172.32.4.50/24
</span></span><span style="display:flex;"><span>ssh-keygen -t rsa -f /root/.ssh/id_rsa -N <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>2.5测试
</span></span><span style="display:flex;"><span>主库手工绑定vip：ifconfig eth0:1 168.204.37.17/24 up 
</span></span><span style="display:flex;"><span>masterha_check_ssh --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf 
</span></span><span style="display:flex;"><span>masterha_check_repl --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf
</span></span><span style="display:flex;"><span>2.6启动
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@mysqldbphw04 /<span style="color:#f92672">]</span><span style="color:#75715e"># nohup masterha_manager --conf=/etc/mha/app1.cnf &gt; /mha/manager.log &lt; /dev/null &amp;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#ae81ff">933</span>
</span></span><span style="display:flex;"><span>查看运行状态
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@mysqldbphw04 /<span style="color:#f92672">]</span><span style="color:#75715e"># masterha_check_status --conf=/etc/mha/app1.cnf</span>
</span></span><span style="display:flex;"><span>app1 <span style="color:#f92672">(</span>pid:933<span style="color:#f92672">)</span> is running<span style="color:#f92672">(</span>0:PING_OK<span style="color:#f92672">)</span>, master:mysqldbphw01
</span></span><span style="display:flex;"><span>2.7关闭
</span></span><span style="display:flex;"><span>masterha_sotp  --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@mysqldbphw04 /<span style="color:#f92672">]</span><span style="color:#75715e"># masterha_secondary_check -s mysqldbphw01 -s  mysqldbp</span>
</span></span><span style="display:flex;"><span>hw02  -s mysqldbphw03 --user<span style="color:#f92672">=</span>root --master_host<span style="color:#f92672">=</span>mysqldbphw01 --master_ip<span style="color:#f92672">=</span><span style="color:#ae81ff">172</span>
</span></span><span style="display:flex;"><span>.32.4.10 --master_port<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>Master is reachable from mysqldbphw01!
</span></span></code></pre></div><p><a href="https://www.cnblogs.com/xiaoyuxixi/p/13814811.html" target="_blank">MYSQL高可用架构MGR、MHA对比 - 小雨淅淅o0 - 博客园 (cnblogs.com)</a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-b808a50b951bb2eae264b55dcb7e33fc">mgr</h1>
	<div class="lead">MGR是 MySQL 官方提供的高可用、高一致性的分布式数据库解决方案</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	<p>MySQL Group Replication（MGR）是 MySQL 官方提供的高可用、高一致性的分布式数据库解决方案，基于原生 MySQL 实现多主/单主架构的同步复制。其核心原理是通过 Paxos 协议变种（Group Communication System, GCS） 实现节点间的数据强一致性，MGR和传统主从复制的本质区别——不是简单的异步复制改进，而是基于paxos的同步复制。</p>
<ul>
<li>使用 <strong>Paxos 分布式共识算法</strong>（具体实现为 <code>XCom</code>）确保集群内节点状态一致。</li>
<li>所有事务需在组内<strong>多数节点（N/2+1）</strong> 确认后才提交（避免脑裂）。</li>
<li>通信基于 <strong>MySQL 插件 <code>group_replication</code></strong> 实现。</li>
</ul>
<pre class="mermaid">graph LR
A[客户端发起事务] --&gt; B[本地节点执行]
B --&gt; C[生成Binlog Event]
C --&gt; D[广播到组内所有节点]
D --&gt; E[多数节点验证冲突]
E --&gt; F{多数节点通过?}
F --&gt;|Yes| G[提交事务并通知组]
F --&gt;|No| H[回滚事务]</pre>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c8013d862a736f0c8b81cda693116416">mysqldump</h1>
	<div class="lead">mysqldump逻辑备份工具</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	

<div class="alert alert-warning" role="alert">


    <ol>
<li><strong>InnoDB 优先用 <code>--single-transaction</code></strong>，避免锁表影响业务。</li>
<li><strong>MyISAM 必须锁表</strong>（默认行为），需在低峰期操作。</li>
<li><strong>大表备份</strong>：结合 <code>--quick</code> 和输出压缩（如 <code>gzip</code>）。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--备份前先执行flush tables 将内容写入磁盘（mysql必知必会中提到）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>flush tables ;
</span></span></code></pre></div>

</div>


  
  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>逻辑备份</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="备份所有库" aria-controls="tabs-01-01" aria-selected="true">
        备份所有库
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="备份指定库" aria-controls="tabs-01-02" aria-selected="false">
        备份指定库
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <p>创建备份用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;backup&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">SELECT</span>, <span style="color:#66d9ef">SHOW</span> <span style="color:#66d9ef">VIEW</span>, RELOAD, <span style="color:#66d9ef">LOCK</span> TABLES, PROCESS <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;backup&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div><p>备份命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 备份所有数据库</span>
</span></span><span style="display:flex;"><span>/usr/local/mysql80/bin/mysqldump <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-A <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--single-transaction --master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-u root -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> -h 10.128.99.157 -P <span style="color:#ae81ff">6301</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>|gzip &gt;/Backup/fullbackup<span style="color:#e6db74">`</span>date +%F-%H:%M:%S<span style="color:#e6db74">`</span>.sql.gz
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <p>创建备份用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;backup&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> identified <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">SELECT</span>, <span style="color:#66d9ef">SHOW</span> <span style="color:#66d9ef">VIEW</span>, RELOAD, <span style="color:#66d9ef">LOCK</span> TABLES, PROCESS <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;backup&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div><p>备份命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 备份指定数据库</span>
</span></span><span style="display:flex;"><span>/usr/local/mysql80/bin/mysqldump <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-B infra_settle <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--single-transaction --master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-u root -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> -h 10.128.99.157 -P <span style="color:#ae81ff">6301</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>|gzip &gt;/Backup/fullbackup<span style="color:#e6db74">`</span>date +%F-%H:%M:%S<span style="color:#e6db74">`</span>.sql.gz
</span></span></code></pre></div>
    </div>
</div>

<table>
  <thead>
      <tr>
          <th style="text-align: left">参数</th>
          <th style="text-align: left">说明</th>
          <th style="text-align: left">示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><code>-u</code>, <code>--user</code></td>
          <td style="text-align: left">指定用户名</td>
          <td style="text-align: left"><code>-u root</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-p</code>, <code>--password</code></td>
          <td style="text-align: left">密码（建议不加密码，后续输入）</td>
          <td style="text-align: left"><code>-p</code> 或 <code>-p'123'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-h</code>, <code>--host</code></td>
          <td style="text-align: left">MySQL 服务器地址</td>
          <td style="text-align: left"><code>-h 127.0.0.1</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-P</code>, <code>--port</code></td>
          <td style="text-align: left">端口号（默认3306）</td>
          <td style="text-align: left"><code>-P 6301</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--socket</code></td>
          <td style="text-align: left">指定 Unix Socket 文件路径</td>
          <td style="text-align: left"><code>--socket=/tmp/mysql.sock</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-A</code>, <code>--all-databases</code></td>
          <td style="text-align: left">备份所有数据库</td>
          <td style="text-align: left"><code>mysqldump -A &gt; full_backup.sql</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-B</code>, <code>--databases</code></td>
          <td style="text-align: left">备份指定数据库（可多个）</td>
          <td style="text-align: left"><code>-B db1 db2</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--tables</code></td>
          <td style="text-align: left">指定表（需先指定数据库）</td>
          <td style="text-align: left"><code>dbname --tables table1 table2</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--ignore-table</code></td>
          <td style="text-align: left">排除指定表</td>
          <td style="text-align: left"><code>--ignore-table=db.logs</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--no-data</code></td>
          <td style="text-align: left">仅备份表结构，不备份数据</td>
          <td style="text-align: left"><code>--no-data</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--no-create-info</code></td>
          <td style="text-align: left">仅备份数据，不备份表结构</td>
          <td style="text-align: left"><code>--no-create-info</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--routines</code></td>
          <td style="text-align: left">包含存储过程和函数</td>
          <td style="text-align: left"><code>--routines</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--triggers</code></td>
          <td style="text-align: left">包含触发器</td>
          <td style="text-align: left"><code>--triggers</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--events</code></td>
          <td style="text-align: left">包含事件调度器</td>
          <td style="text-align: left"><code>--events</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--skip-triggers</code></td>
          <td style="text-align: left">排除触发器</td>
          <td style="text-align: left"><code>--skip-triggers</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--single-transaction</code></td>
          <td style="text-align: left">开启事务保证 InnoDB 一致性快照</td>
          <td style="text-align: left">InnoDB</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--lock-tables</code></td>
          <td style="text-align: left">备份前锁定所有表（默认开启）</td>
          <td style="text-align: left">MyISAM</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--skip-lock-tables</code></td>
          <td style="text-align: left">不锁表（可能导致不一致）</td>
          <td style="text-align: left">紧急情况</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--flush-logs</code></td>
          <td style="text-align: left">备份前刷新日志（用于 Binlog 增量恢复）</td>
          <td style="text-align: left">所有引擎</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--master-data</code></td>
          <td style="text-align: left">记录 Binlog 位置（<code>=1</code>注释，<code>=2</code>SQL语句）</td>
          <td style="text-align: left">主从复制</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--result-file</code></td>
          <td style="text-align: left">指定输出文件（避免 Windows 换行问题）</td>
          <td style="text-align: left"><code>--result-file=backup.sql</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--compress</code></td>
          <td style="text-align: left">压缩传输（节省网络带宽）</td>
          <td style="text-align: left"><code>--compress</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--tz-utc</code></td>
          <td style="text-align: left">统一时区为 UTC（默认开启）</td>
          <td style="text-align: left"><code>--tz-utc</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--hex-blob</code></td>
          <td style="text-align: left">二进制数据以十六进制导出</td>
          <td style="text-align: left"><code>--hex-blob</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--quick</code></td>
          <td style="text-align: left">逐行导出（避免内存溢出）</td>
          <td style="text-align: left">大表备份</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--extended-insert</code></td>
          <td style="text-align: left">合并多行 INSERT（默认开启）</td>
          <td style="text-align: left">减少备份体积</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--skip-extended-insert</code></td>
          <td style="text-align: left">每行单独 INSERT（可读性高）</td>
          <td style="text-align: left">调试用途</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>--opt</code></td>
          <td style="text-align: left">启用所有优化选项（默认开启）</td>
          <td style="text-align: left">综合优化</td>
      </tr>
  </tbody>
</table>
<p>备份脚本
<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e"># 脚本名称: mysql_backup.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 描述: MySQL数据库备份脚本，支持全库备份、binlog同步及过期清理</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 作者: wangendao(1209233066@qq.com)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建日期: 2019/03/01</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 最后修改日期: $(date +%F)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 调试选项 (取消注释以启用)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># set -euo pipefail  # 更严格的错误检查</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># set -x            # 显示执行过程</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置变量</span>
</span></span><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span>/application/mysql5.6/bin:$PATH
</span></span><span style="display:flex;"><span>datadir<span style="color:#f92672">=</span>/application/mysql5.6/
</span></span><span style="display:flex;"><span>backupdir<span style="color:#f92672">=</span>/backup
</span></span><span style="display:flex;"><span>logdir<span style="color:#f92672">=</span>/var/log/mysql_backup
</span></span><span style="display:flex;"><span>timestamp<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>date +%F_%H%M%S<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>user<span style="color:#f92672">=</span>root
</span></span><span style="display:flex;"><span>password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;123&#39;</span>
</span></span><span style="display:flex;"><span>socket<span style="color:#f92672">=</span>/application/mysql5.6/mysql.sock
</span></span><span style="display:flex;"><span>rsync_ip<span style="color:#f92672">=</span>168.204.37.25
</span></span><span style="display:flex;"><span>retention_days<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>  <span style="color:#75715e"># 备份保留天数</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建必要的目录</span>
</span></span><span style="display:flex;"><span>mkdir -p <span style="color:#e6db74">&#34;</span>$backupdir<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$logdir<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 日志函数</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;[</span><span style="color:#66d9ef">$(</span>date <span style="color:#e6db74">&#39;+%F %T&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">] </span>$1<span style="color:#e6db74">&#34;</span> &gt;&gt; <span style="color:#e6db74">&#34;</span>$logdir<span style="color:#e6db74">/mysql_backup_</span><span style="color:#e6db74">${</span>timestamp<span style="color:#e6db74">}</span><span style="color:#e6db74">.log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 错误处理函数</span>
</span></span><span style="display:flex;"><span>error_exit<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    log <span style="color:#e6db74">&#34;ERROR: </span>$1<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    sendEmail -f wangendao@crv.com.cn -t wangendao@crv.com.cn <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              -s 10.248.2.15 -u <span style="color:#e6db74">&#34;MySQL备份失败警报&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              -o tls<span style="color:#f92672">=</span>no -o message-content-type<span style="color:#f92672">=</span>html <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              -o message-charset<span style="color:#f92672">=</span>utf8 -xu wangendao@crv.com.cn <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              -xp Wed10203040 -m <span style="color:#e6db74">&#34;MySQL备份失败: </span>$1<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取数据库列表</span>
</span></span><span style="display:flex;"><span>DBlist<span style="color:#f92672">=(</span><span style="color:#66d9ef">$(</span>mysql -u <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>user<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -p<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>password<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -S <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>socket<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -e <span style="color:#e6db74">&#34;SHOW DATABASES;&#34;</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          awk <span style="color:#e6db74">&#39;!/^(information_schema|performance_schema|test|database|mysql)$/&#39;</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          tail -n +2<span style="color:#66d9ef">)</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">${#</span>DBlist[@]<span style="color:#e6db74">}</span> -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    error_exit <span style="color:#e6db74">&#34;未获取到数据库列表&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 备份每个数据库</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> db in <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DBlist[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    backup_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>backupdir<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>db<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">${</span>timestamp<span style="color:#e6db74">}</span><span style="color:#e6db74">.gz&#34;</span>
</span></span><span style="display:flex;"><span>    md5_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>backupdir<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>db<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">${</span>timestamp<span style="color:#e6db74">}</span><span style="color:#e6db74">.md5&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    log <span style="color:#e6db74">&#34;开始备份数据库: </span>$db<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ! mysqldump -B <span style="color:#e6db74">&#34;</span>$db<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        -u<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>user<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -p<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>password<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -S <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>socket<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --single-transaction <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --routines <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --triggers | gzip &gt; <span style="color:#e6db74">&#34;</span>$backup_file<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        error_exit <span style="color:#e6db74">&#34;数据库 </span>$db<span style="color:#e6db74"> 备份失败&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 生成MD5校验文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ! md5sum <span style="color:#e6db74">&#34;</span>$backup_file<span style="color:#e6db74">&#34;</span> &gt; <span style="color:#e6db74">&#34;</span>$md5_file<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        error_exit <span style="color:#e6db74">&#34;无法生成MD5校验文件&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    log <span style="color:#e6db74">&#34;数据库 </span>$db<span style="color:#e6db74"> 备份完成, 文件: </span>$backup_file<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 同步备份文件</span>
</span></span><span style="display:flex;"><span>log <span style="color:#e6db74">&#34;开始同步备份文件到远程服务器&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ! rsync -az --delete <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>backupdir<span style="color:#e6db74">}</span><span style="color:#e6db74">/&#34;</span> <span style="color:#e6db74">&#34;rsync@</span><span style="color:#e6db74">${</span>rsync_ip<span style="color:#e6db74">}</span><span style="color:#e6db74">::ftp&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --password-file<span style="color:#f92672">=</span>/etc/rsync.password &gt;&gt; <span style="color:#e6db74">&#34;</span>$logdir<span style="color:#e6db74">/rsync.log&#34;</span> 2&gt;&amp;1; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    error_exit <span style="color:#e6db74">&#34;备份文件同步失败&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 同步binlog文件</span>
</span></span><span style="display:flex;"><span>log <span style="color:#e6db74">&#34;开始同步binlog文件&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ! rsync -az <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>datadir<span style="color:#e6db74">}</span><span style="color:#e6db74">/&#34;</span> --include <span style="color:#e6db74">&#39;mysql-bin*&#39;</span> --exclude <span style="color:#e6db74">&#39;*&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     <span style="color:#e6db74">&#34;rsync@</span><span style="color:#e6db74">${</span>rsync_ip<span style="color:#e6db74">}</span><span style="color:#e6db74">::ftp&#34;</span> --password-file<span style="color:#f92672">=</span>/etc/rsync.password <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     &gt;&gt; <span style="color:#e6db74">&#34;</span>$logdir<span style="color:#e6db74">/binlog_sync.log&#34;</span> 2&gt;&amp;1; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    error_exit <span style="color:#e6db74">&#34;binlog文件同步失败&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清理过期备份</span>
</span></span><span style="display:flex;"><span>log <span style="color:#e6db74">&#34;清理</span><span style="color:#e6db74">${</span>retention_days<span style="color:#e6db74">}</span><span style="color:#e6db74">天前的备份&#34;</span>
</span></span><span style="display:flex;"><span>find <span style="color:#e6db74">&#34;</span>$backupdir<span style="color:#e6db74">&#34;</span> -type f -name <span style="color:#e6db74">&#34;*.gz&#34;</span> -mtime +<span style="color:#e6db74">&#34;</span>$retention_days<span style="color:#e6db74">&#34;</span> -delete
</span></span><span style="display:flex;"><span>find <span style="color:#e6db74">&#34;</span>$backupdir<span style="color:#e6db74">&#34;</span> -type f -name <span style="color:#e6db74">&#34;*.md5&#34;</span> -mtime +<span style="color:#e6db74">&#34;</span>$retention_days<span style="color:#e6db74">&#34;</span> -delete
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 发送成功通知</span>
</span></span><span style="display:flex;"><span>log <span style="color:#e6db74">&#34;备份任务完成&#34;</span>
</span></span><span style="display:flex;"><span>sendEmail -f wangendao@crv.com.cn -t wangendao@crv.com.cn <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -s 10.248.2.15 -u <span style="color:#e6db74">&#34;MySQL备份成功通知&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -o tls<span style="color:#f92672">=</span>no -o message-content-type<span style="color:#f92672">=</span>html <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -o message-charset<span style="color:#f92672">=</span>utf8 -xu wangendao@crv.com.cn <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -xp Wed10203040 -m <span style="color:#e6db74">&#34;MySQL备份任务已完成&lt;br&gt;&lt;br&gt;备份数据库列表:&lt;br&gt;</span><span style="color:#e6db74">${</span>DBlist[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;br&gt;&lt;br&gt;备份文件已保留最近</span><span style="color:#e6db74">${</span>retention_days<span style="color:#e6db74">}</span><span style="color:#e6db74">天&#34;</span>
</span></span></code></pre></div></details>
</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-ce9d44ed09004288aefaac879ed320af">xtrabackup</h1>
	<div class="lead">mysql 备份工具之xtrabackup</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-23" class="text-body-secondary">Wednesday, July 23, 2025</time>
        
	</div>
	<h3 id="xtrabackup">xtrabackup</h3>
<p>xtrabackup 与mysql版本矩阵：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">XtraBackup 版本</th>
          <th style="text-align: left">支持的 MySQL 版本</th>
          <th style="text-align: left">关键限制</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>8.0 系列</strong></td>
          <td style="text-align: left">MySQL 8.0.x（推荐 8.0.20+）</td>
          <td style="text-align: left">完全兼容 MySQL 8.0，<strong>不支持 MySQL 5.7 及以下</strong></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>2.4 系列</strong></td>
          <td style="text-align: left">MySQL 5.6、5.7</td>
          <td style="text-align: left">不支持 MySQL 8.0</td>
      </tr>
  </tbody>
</table>
<blockquote>
<p><strong>注意</strong>：</p>
<ul>
<li>XtraBackup <strong>8.0 不支持备份 MySQL 5.7</strong>。若需备份 MySQL 5.7，必须使用 XtraBackup 2.4。</li>
<li>Percona 强烈建议 <strong>XtraBackup 小版本号与 MySQL 大版本一致</strong>（例如 MySQL 8.0.32 搭配 XtraBackup 8.0.32）。</li>
</ul>
</blockquote>
<h5 id="安装xtrabackup">安装xtrabackup</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/etc/yum.repos.d/percona-original-release.repo <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[percona-release-x86_64]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name = Percona Original release/x86_64 YUM repository
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl = http://repo.percona.com/percona/yum/release/$releasever/RPMS/x86_64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey = file:///etc/pki/rpm-gpg/PERCONA-PACKAGING-KEY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[percona-release-noarch]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name = Percona Original release/noarch YUM repository
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl = http://repo.percona.com/percona/yum/release/$releasever/RPMS/noarch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey = file:///etc/pki/rpm-gpg/PERCONA-PACKAGING-KEY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[percona-release-sources]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name = Percona Original release/sources YUM repository
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl = http://repo.percona.com/percona/yum/release/$releasever/SRPMS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey = file:///etc/pki/rpm-gpg/PERCONA-PACKAGING-KEY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y percona-xtrabackup-80.x86_64 
</span></span></code></pre></div><h5 id="全量备份">全量备份</h5>
<blockquote>
<p>170G 数据压缩后16g,全备耗时7分钟,占用1.5核心cpu</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>xtrabackup <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--defaults-file<span style="color:#f92672">=</span>/etc/mysql80/mysql80_6301.cnf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--backup <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;root&#34;</span> --password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--target-dir<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Backup/fullbackup-</span><span style="color:#66d9ef">$(</span>date +%F<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--compress --compress-threads<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>  2&gt;&amp;<span style="color:#ae81ff">1</span> | tee /tmp/mysql6301_<span style="color:#66d9ef">$(</span>date +%F_%H%M%S<span style="color:#66d9ef">)</span>.log
</span></span></code></pre></div><h5 id="恢复全量备份">恢复全量备份</h5>
<blockquote>
<p>限速100Mb 传输16G, 耗时3分钟</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>scp -l <span style="color:#ae81ff">819200</span> -rp /Backup/fullbackup-2025-07-22/* bak@10.128.99.157:/Data/bak/
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rm -fr /Data/mysql6301/<span style="color:#f92672">{</span>binlog,data,log<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>mkdir  /Data/mysql6301/<span style="color:#f92672">{</span>binlog,data,log<span style="color:#f92672">}</span> -p
</span></span><span style="display:flex;"><span>touch /Data/mysql6301/log/mysqld-error.log
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 解压 16gb 耗时 2分钟</span>
</span></span><span style="display:flex;"><span>xtrabackup --decompress --parallel<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --target-dir<span style="color:#f92672">=</span>/Data/bak --remove-original
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 应用undolog</span>
</span></span><span style="display:flex;"><span>xtrabackup --prepare --apply-log-only --target-dir<span style="color:#f92672">=</span>/Data/bak
</span></span><span style="display:flex;"><span>xtrabackup --prepare --target-dir<span style="color:#f92672">=</span>/Data/bak
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 拷贝全量备份到datadir</span>
</span></span><span style="display:flex;"><span>xtrabackup --defaults-file<span style="color:#f92672">=</span>/etc/my.cnf --copy-back --target-dir<span style="color:#f92672">=</span>/Data/bak
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown -R mysql.mysql /Data/mysql6301
</span></span><span style="display:flex;"><span>service mysql start 
</span></span><span style="display:flex;"><span>chkconfig mysql on
</span></span></code></pre></div><h5 id="增量同步数据">增量同步数据</h5>


  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="主库" aria-controls="tabs-00-00" aria-selected="true">
        主库
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="从库" aria-controls="tabs-00-01" aria-selected="false">
        从库
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <p>创建复制用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;replUser&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> IDENTIFIED <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;Repl#0001&#39;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> REPLICATION SLAVE <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;replUser&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span>; 
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span> ;
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <p>设置只读，预防多点写入</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/local/mysql80/bin/mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> --socket<span style="color:#f92672">=</span>/Data/mysql6301/mysql6301.sock --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; set global read_only<span style="color:#f92672">=</span>on;
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> rows affected <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; set global super_read_only<span style="color:#f92672">=</span>on;
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> rows affected <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; show variables like <span style="color:#e6db74">&#39;%read_only%&#39;</span>;
</span></span><span style="display:flex;"><span>+-----------------------+-------+
</span></span><span style="display:flex;"><span>| Variable_name         | Value |
</span></span><span style="display:flex;"><span>+-----------------------+-------+
</span></span><span style="display:flex;"><span>| innodb_read_only      | OFF   |
</span></span><span style="display:flex;"><span>| read_only             | ON    |
</span></span><span style="display:flex;"><span>| super_read_only       | ON    |
</span></span><span style="display:flex;"><span>| transaction_read_only | OFF   |
</span></span><span style="display:flex;"><span>+-----------------------+-------+
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span> rows in set <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>找到全备时的binlog位置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@db3-mysql80-m data<span style="color:#f92672">]</span><span style="color:#75715e"># cat xtrabackup_binlog_info </span>
</span></span><span style="display:flex;"><span>mysql-bin.000362        <span style="color:#ae81ff">156</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">/*从库*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">reset</span> slave <span style="color:#66d9ef">all</span>;
</span></span><span style="display:flex;"><span>CHANGE MASTER <span style="color:#66d9ef">TO</span> 
</span></span><span style="display:flex;"><span>    MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;10.128.111.157&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span>,
</span></span><span style="display:flex;"><span>    MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;replUser&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Repl#0001&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mysql-bin.000362&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_LOG_POS<span style="color:#f92672">=</span><span style="color:#ae81ff">156</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">start</span> slave ;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> slave status <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span></code></pre></div><p>检查slave状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@db3-mysql80 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /usr/local/mysql80/bin/mysql -uroot  -p&#39;d988ec6a93!@#MYSQL&#39; --socket=/Data/mysql6301/mysql6301.sock --port=6301 -e &#34;show slave status\G&#34;|grep -E &#34;Slave_IO_Running|Slave_SQL_Running:|Seconds_Behind_Master&#34;</span>
</span></span><span style="display:flex;"><span>mysql: <span style="color:#f92672">[</span>Warning<span style="color:#f92672">]</span> Using a password on the command line interface can be insecure.
</span></span><span style="display:flex;"><span>             Slave_IO_Running: Yes
</span></span><span style="display:flex;"><span>            Slave_SQL_Running: Yes
</span></span><span style="display:flex;"><span>        Seconds_Behind_Master: <span style="color:#ae81ff">0</span>
</span></span></code></pre></div>
    </div>
</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-4bf71c58d88b7380dd55e728c09e47c2">config</h1>
	<div class="lead">mysql 配置文件解析</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[mysqld]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">innodb_lock_wait_timeout</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">60</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sort_buffer_size</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">8M</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">query_cache_limit</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">32M</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto_increment_offset</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1 </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto_increment_increment</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_database</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_results</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_server</span>  <span style="color:#f92672">=</span> <span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">init_connect</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;启动时自动执行的内容&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#php设置为短连接</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">interactive_timeout</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">30;  #合作的超时时间</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wait_tiemout</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">30;	#闲置的超时时间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#java 设置长连接</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">interactive_timeout</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">28800;  </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wait_tiemout</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">28800;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#一个端口最大连接数</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">max_connections</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">800</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#一个用户的最大连接数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#max_user_connections = 800</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#连接错误的最大数量</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">max_connect_errors</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#兼容旧的密码模式</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#old_password = on</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">read_only</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">on</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#默认情况下从库启动自动开始同步，添加参数后需要手动start slave ;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">skip_slave_start</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">on</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#更新master_info 信息</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sync_master_info</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">记录relaylog，默认开启</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sync_relay_log</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">记录relaylog info </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sync_relay_log_info</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[client]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_client</span> <span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_connection</span> <span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_results</span> <span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[mysql]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_connection</span><span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span></code></pre></div><p>mysql 乱码字符集设置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">字符集设置</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">names</span> utf8 ;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">等同于</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#f92672">@@</span><span style="color:#66d9ef">session</span>.character_set_client <span style="color:#f92672">=</span>utf8;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#f92672">@@</span><span style="color:#66d9ef">session</span>.character_set_connection <span style="color:#f92672">=</span>utf8;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#f92672">@@</span><span style="color:#66d9ef">session</span>.character_set_results <span style="color:#f92672">=</span>utf8;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#f92672">@@</span><span style="color:#66d9ef">session</span>.character_set_database <span style="color:#f92672">=</span>utf8;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#f92672">@@</span><span style="color:#66d9ef">session</span>.character_set_server <span style="color:#f92672">=</span>utf8;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[client]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_client</span> <span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_connection</span> <span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_results</span> <span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[mysql]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">character_set_connection</span><span style="color:#f92672">=</span><span style="color:#e6db74">utf8</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#导入表时关闭外检检查</span>
</span></span><span style="display:flex;"><span>set foreign_key_check <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#查询语句的性能</span>
</span></span><span style="display:flex;"><span>show profing;
</span></span><span style="display:flex;"><span>show profie all;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#设置为分页查询</span>
</span></span><span style="display:flex;"><span>mysql&gt; page less 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; show master logs ;
</span></span><span style="display:flex;"><span>mysql&gt; purge master logs to <span style="color:#e6db74">&#39;binlog文件&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>修复表
</span></span><span style="display:flex;"><span>mysql&gt; repair table 表名
</span></span><span style="display:flex;"><span>myisamchk -r /var/lib/mysql/*.MYI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>查询 innodb 的状态<span style="color:#f92672">(</span>比如死锁<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>show engine innodb status <span style="color:#ae81ff">\G</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>查询运行状态
</span></span><span style="display:flex;"><span>show global status <span style="color:#ae81ff">\G</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>查询增删改的数量
</span></span><span style="display:flex;"><span>mysqladmin -uroot -i <span style="color:#ae81ff">3</span> -r exten|egrep -i <span style="color:#e6db74">&#39;(com_insert\b)|(com_select)|(com_delete\b)|(com_update\b)&#39;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#查询进程号</span>
</span></span><span style="display:flex;"><span>pidof mysqld
</span></span><span style="display:flex;"><span>gdb -p <span style="color:#e6db74">`</span>pidof mysqld<span style="color:#e6db74">`</span> -ex <span style="color:#e6db74">&#34;set opt_log_slave_updates=1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IO PS 每秒吞吐量
</span></span><span style="display:flex;"><span>flashcache 开源软件 可以把ssd和sas磁盘虚拟化一块
</span></span><span style="display:flex;"><span>把热数据存在ssd上把sas放在sas上
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>查询 cp io
</span></span><span style="display:flex;"><span>mpstats -P ALL <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">100</span>   查询所有cpu的使用情况 每秒打印一个打印100次
</span></span><span style="display:flex;"><span>sar -u <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">100</span>          查询所有cpu的使用情况 每秒打印一个打印100次
</span></span><span style="display:flex;"><span>iostat -x <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>sar -b <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>sar -d <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>sar -q
</span></span><span style="display:flex;"><span>sar -n DEV  查看网路
</span></span><span style="display:flex;"><span>sar -W    查看内存
</span></span><span style="display:flex;"><span>sar -r
</span></span><span style="display:flex;"><span>sar -B
</span></span><span style="display:flex;"><span>top 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dmesg -H --level<span style="color:#f92672">=</span>err,warn -k
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>优化
</span></span><span style="display:flex;"><span>numad 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>不使用swap
</span></span><span style="display:flex;"><span>sysctl -a|grep swap 
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;vm.swappiness = 0&#34;</span> &gt;&gt;/etc/sysctl.conf  
</span></span><span style="display:flex;"><span>sysctl -p 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io调度
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@localhost ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat /sys/block/sda/queue/scheduler </span>
</span></span><span style="display:flex;"><span>noop <span style="color:#f92672">[</span>deadline<span style="color:#f92672">]</span> cfq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ulimit 设定
</span></span><span style="display:flex;"><span>软硬文件打开数
</span></span><span style="display:flex;"><span>ulimit -HSn <span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#stack size</span>
</span></span><span style="display:flex;"><span>ulimit -s <span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>查看raid信息
</span></span><span style="display:flex;"><span>megacil 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@localhost ~<span style="color:#f92672">]</span><span style="color:#75715e"># top -b -n 1 | grep Cpu </span>
</span></span><span style="display:flex;"><span>%Cpu<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>:  0.0 us,  6.2 sy,  0.0 ni, 93.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>性能调优
</span></span><span style="display:flex;"><span>https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/6/html/performance_tuning_guide/index
</span></span><span style="display:flex;"><span>https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/performance_tuning_guide/index
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>《mysql反范式》
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>数据类型
</span></span><span style="display:flex;"><span>timestamp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; <span style="color:#66d9ef">select</span> current_time<span style="color:#f92672">()</span>,now<span style="color:#f92672">()</span>,sysdate<span style="color:#f92672">()</span>;
</span></span><span style="display:flex;"><span>+----------------+---------------------+---------------------+
</span></span><span style="display:flex;"><span>| current_time<span style="color:#f92672">()</span> | now<span style="color:#f92672">()</span>               | sysdate<span style="color:#f92672">()</span>           |
</span></span><span style="display:flex;"><span>+----------------+---------------------+---------------------+
</span></span><span style="display:flex;"><span>| 12:08:14       | 2020-03-08 12:08:14 | 2020-03-08 12:08:14 |
</span></span><span style="display:flex;"><span>+----------------+---------------------+---------------------+
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> row in set <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; <span style="color:#66d9ef">select</span> inet_aton<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;192.168.0.1&#39;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>+--------------------------+
</span></span><span style="display:flex;"><span>| inet_aton<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;192.168.0.1&#39;</span><span style="color:#f92672">)</span> |
</span></span><span style="display:flex;"><span>+--------------------------+
</span></span><span style="display:flex;"><span>|               <span style="color:#ae81ff">3232235521</span> |
</span></span><span style="display:flex;"><span>+--------------------------+
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> row in set <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; <span style="color:#66d9ef">select</span> inet_ntoa<span style="color:#f92672">(</span>3232235521<span style="color:#f92672">)</span>;    
</span></span><span style="display:flex;"><span>+-----------------------+
</span></span><span style="display:flex;"><span>| inet_ntoa<span style="color:#f92672">(</span>3232235521<span style="color:#f92672">)</span> |
</span></span><span style="display:flex;"><span>+-----------------------+
</span></span><span style="display:flex;"><span>| 192.168.0.1           |
</span></span><span style="display:flex;"><span>+-----------------------+
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> row in set <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>1.xtrabackup 安装
</span></span><span style="display:flex;"><span>wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.4/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.4-1.el7.x86_64.rpm
</span></span><span style="display:flex;"><span>yum install libev-devel.x86_64
</span></span><span style="display:flex;"><span>yum install numactl-libs.x86_64
</span></span><span style="display:flex;"><span>yum install perl-DBD-MySQL.x86_64
</span></span><span style="display:flex;"><span>rpm -ivh percona-xtrabackup-24-2.4.4-1.el7.x86_64.rpm 
</span></span><span style="display:flex;"><span>which xtrabackup
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>备份原理
</span></span><span style="display:flex;"><span>xtrabackup 
</span></span><span style="display:flex;"><span>首先启动备份innodb 引擎的线程 redolog 的备份和监听线程，
</span></span><span style="display:flex;"><span>并开始备份ibd 数据文件。
</span></span><span style="display:flex;"><span>当innodb引擎的数据文件备份完毕后，
</span></span><span style="display:flex;"><span>flust table with read lock;
</span></span><span style="display:flex;"><span>备份 .frm .myd .myi 文件。非innodb引擎数据文件备份完毕后
</span></span><span style="display:flex;"><span>通知redolog 线程结束并记录数据文件的lsn号，便于下次增量
</span></span><span style="display:flex;"><span>备份
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 性能测试工具
</span></span><span style="display:flex;"><span> mysqlslap
</span></span><span style="display:flex;"><span> 日志分析工具
</span></span><span style="display:flex;"><span>https://www.jb51.net/article/75064.htm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### Centos7,centos6适用</span>
</span></span><span style="display:flex;"><span>yum groupinstall <span style="color:#e6db74">&#34;X Window System&#34;</span>
</span></span><span style="display:flex;"><span>yum groupinstall <span style="color:#e6db74">&#34;GNOME Desktop&#34;</span>
</span></span><span style="display:flex;"><span>通过命令 startx 进入图形界面
</span></span><span style="display:flex;"><span>图形到dos：ctrl+alt+f2
</span></span><span style="display:flex;"><span>dos到图形：输入startx
</span></span><span style="display:flex;"><span>或者
</span></span><span style="display:flex;"><span>在命令上输入 init <span style="color:#ae81ff">3</span> 命令 切换到dos界面
</span></span><span style="display:flex;"><span>输入 init 5命令 切换到图形界面
</span></span><span style="display:flex;"><span><span style="color:#75715e">### centos 7</span>
</span></span><span style="display:flex;"><span>systemctl get-default
</span></span><span style="display:flex;"><span>graphical.target代表开机时启动图形化界面
</span></span><span style="display:flex;"><span>multi-user.target代表开机时启动dos界面
</span></span><span style="display:flex;"><span>systemctl set-default graphical.target 
</span></span><span style="display:flex;"><span>systemctl set-default multi-user.target 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh 连接客户端长时间不使用自动断开
</span></span><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span><span style="color:#ae81ff">\$</span>PATH:.
</span></span><span style="display:flex;"><span>export PS1<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\`hostname\`:\$PWD&gt;&#39;</span>
</span></span><span style="display:flex;"><span>set -o vi
</span></span><span style="display:flex;"><span>stty erase ^H
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>back_log <span style="color:#f92672">=</span> <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>external-locking <span style="color:#f92672">=</span> FALSE
</span></span><span style="display:flex;"><span>max_allowed_packet <span style="color:#f92672">=</span>8M
</span></span><span style="display:flex;"><span>thread_stack <span style="color:#f92672">=</span> 192K
</span></span><span style="display:flex;"><span>thread_stack <span style="color:#f92672">=</span> <span style="color:#ae81ff">192</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>mysql<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>no-auto-rehash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>过滤
</span></span><span style="display:flex;"><span>change master to Replicate_Ignore_DB <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;test&#39;</span>;
</span></span><span style="display:flex;"><span>Replicate_Do_DB:
</span></span><span style="display:flex;"><span>Replicate_Ignore_DB: 
</span></span><span style="display:flex;"><span>Replicate_Do_Table: 
</span></span><span style="display:flex;"><span>Replicate_Ignore_Table: 
</span></span><span style="display:flex;"><span>Replicate_Wild_Do_Table: 
</span></span><span style="display:flex;"><span>Replicate_Wild_Ignore_Table:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http://itindex.net/index/mha
</span></span><span style="display:flex;"><span>http://mysqlserverteam.com/
</span></span><span style="display:flex;"><span>https://www.cnblogs.com/xiaoboluo768/p/5973827.html
</span></span><span style="display:flex;"><span>https://blog.51cto.com/8370646/2150179
</span></span><span style="display:flex;"><span>https://www.cnblogs.com/zengkefu/p/5600776.html
</span></span><span style="display:flex;"><span>http://www.mamicode.com/info-detail-1488956.html?__cf_chl_jschl_tk__<span style="color:#f92672">=</span>864bd8082fbcc44cff88faa95540ef89c8b1b1ed-1584599149-0-AZzn7zH3F9Q-fMosxg8_z2LhSKfhM8v8fHU4CwyiFxVIk0VzRZI1cOMDw3H6MDQvflAFPsEL9s1MKiUp0hv-9DgUhwYnONrP7mGzp5ZLoSQBlxx9PK4W74ZQrzdsLbUqj3x_clEVUJwdXTPNq-3NiQ0Oz08ONGXWoF2Bx9WfddC9sPngJHUB9CgTE-TKk6o1ktyutexm0QT_zn1jyvml2RK4N133vdGwewmb4QttA_CjOSV4ftDAhu5284B86HQd3Q8VGbn0W9aIC0VGHARUdb5JE0tb2usYTx_IbtaG-QglcJIVYJD5eFWX8Vf7_Okbtw
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a051ebfaac6fc3a51384fae8d41525a3">mysql数据库搬迁</h1>
	<div class="lead">数据中心搬迁，龙腾出行mysql数据库迁移</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-01" class="text-body-secondary">Friday, August 01, 2025</time>
        
	</div>
	<table>
  <thead>
      <tr>
          <th>版本</th>
          <th>旧环境</th>
          <th>新环境</th>
          <th>root密码</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>8.0.22</td>
          <td>192.168.100.157  主库  4C  32GB  350G  + 100GB <br/>192.168.100.158   从库. 4C  32GB  350G  + 0GB</td>
          <td>已部署<br/>10.128.99.157  主库   主库  4C  32GB /Data=  350G  + /Backup = 100GB <br/>10.128.99.158   从库  从库. 4C  32GB /Data= 350G  +  /Backup = null</td>
          <td>d988ec6a93!@#MYSQL</td>
      </tr>
  </tbody>
</table>
<h3 id="全量迁移">全量迁移</h3>
<p>并发请求不高，在主节点执行全量备份</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y percona-xtrabackup-80.x86_64 
</span></span></code></pre></div><blockquote>
<p>耗时14分钟</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>xtrabackup <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--defaults-file<span style="color:#f92672">=</span>/etc/mysql80/mysql80_6301.cnf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--backup <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;root&#34;</span> --password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--target-dir<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Backup/fullbackup-</span><span style="color:#66d9ef">$(</span>date +%F<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--compress --compress-threads<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>  2&gt;&amp;<span style="color:#ae81ff">1</span> | tee /tmp/mysql6301_<span style="color:#66d9ef">$(</span>date +%F_%H%M%S<span style="color:#66d9ef">)</span>.log
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 限速50MB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 10.128.99.157 10.128.99.158</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### service mysql stop</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### rm -fr /Data/bak/* </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### rm -fr /Data/mysql6301/* &amp;&amp;  mkdir /Data/mysql6301/{binlog,data,log} -p ;touch /Data/mysql6301/log/mysqld-error.log </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 10分</span>
</span></span><span style="display:flex;"><span>scp -l <span style="color:#ae81ff">409600</span> -rp /Backup/fullbackup-2025-08-01/* bak@10.128.99.157:/Data/bak/
</span></span><span style="display:flex;"><span>scp -l <span style="color:#ae81ff">409600</span> -rp /Backup/fullbackup-2025-08-01/* bak@10.128.99.158:/Data/bak/
</span></span></code></pre></div><p>全量恢复</p>


<div class="alert alert-warning" role="alert">


    <p>从库备份时会将主从复制关系备份过来, 恢复数据时希望手动指定复制关系，可以通过只读参数取消<strong>slave进程</strong>启动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[mysqld]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">skip_slave_start</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">ON</span>
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 解压 16gb 耗时 2分钟</span>
</span></span><span style="display:flex;"><span>xtrabackup --decompress --parallel<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --target-dir<span style="color:#f92672">=</span>/Data/bak --remove-original
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 应用undolog</span>
</span></span><span style="display:flex;"><span>xtrabackup --prepare --apply-log-only --target-dir<span style="color:#f92672">=</span>/Data/bak
</span></span><span style="display:flex;"><span>xtrabackup --prepare --target-dir<span style="color:#f92672">=</span>/Data/bak
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 拷贝全量备份到datadir</span>
</span></span><span style="display:flex;"><span>xtrabackup --defaults-file<span style="color:#f92672">=</span>/etc/my.cnf --copy-back --target-dir<span style="color:#f92672">=</span>/Data/bak
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown -R mysql.mysql /Data/mysql6301
</span></span><span style="display:flex;"><span>service mysql start 
</span></span><span style="display:flex;"><span>chkconfig mysql on
</span></span></code></pre></div><p>设置只读</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>h <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">128</span>.<span style="color:#ae81ff">99</span>.<span style="color:#ae81ff">157</span> <span style="color:#75715e">--port=6301 -uroot -p&#39;d988ec6a93!@#MYSQL&#39; -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>; <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;super_read_only&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;read_only&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>h <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">128</span>.<span style="color:#ae81ff">99</span>.<span style="color:#ae81ff">158</span> <span style="color:#75715e">--port=6301 -uroot -p&#39;d988ec6a93!@#MYSQL&#39; -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>; <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;super_read_only&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;read_only&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><h3 id="增量同步">增量同步</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;replUser&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> IDENTIFIED  <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;RsU#58d1@&#39;</span> <span style="color:#66d9ef">WITH</span> mysql_native_password ; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> REPLICATION SLAVE,REPLICATION CLIENT <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;replUser&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span>; 
</span></span><span style="display:flex;"><span>flush <span style="color:#66d9ef">privileges</span>;
</span></span></code></pre></div><p>查找全备时binlog位置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@db3-mysql80-m ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat /Data/bak/xtrabackup_binlog_info </span>
</span></span><span style="display:flex;"><span>mysql-bin.000451       <span style="color:#ae81ff">156</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>h <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">128</span>.<span style="color:#ae81ff">99</span>.<span style="color:#ae81ff">157</span> <span style="color:#75715e">--port=6301 -uroot -p&#39;d988ec6a93!@#MYSQL&#39; -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">reset</span> slave <span style="color:#66d9ef">all</span>;
</span></span><span style="display:flex;"><span>CHANGE MASTER <span style="color:#66d9ef">TO</span> 
</span></span><span style="display:flex;"><span>    MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.100.157&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span>,
</span></span><span style="display:flex;"><span>    MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;replUser&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RsU#58d1@&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mysql-bin.000451&#39;</span>,
</span></span><span style="display:flex;"><span>    MASTER_LOG_POS<span style="color:#f92672">=</span><span style="color:#ae81ff">156</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">start</span> slave ;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> slave status <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -h 10.128.99.158 --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -uroot -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> -e <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">reset slave all;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CHANGE MASTER TO 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    MASTER_HOST=&#39;10.128.99.157&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    MASTER_PORT=6301,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    MASTER_USER=&#39;replUser&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    MASTER_PASSWORD=&#39;RsU#58d1@&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    MASTER_LOG_FILE=&#39;mysql-bin.000453&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    MASTER_LOG_POS=156;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start slave ;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">show slave status \G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><h3 id="数据对比">数据对比</h3>
<p>检查主从同步状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157 -e &#34;show slave status\G show variables like &#39;%read_only%&#39;&#34;|grep -E &#34;Slave_IO_Running:|Slave_SQL_Running:|Seconds_Behind_Master:|read_only&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.158 -e &#34;show slave status\G show variables like &#39;%read_only%&#39;&#34;|grep -E &#34;Slave_IO_Running:|Slave_SQL_Running:|Seconds_Behind_Master:|read_only&#34;
</span></span></span></code></pre></div><p>统计数据库元数据信息。确保数据库数量、表数量、索引数量、触发器、函数、存储过程、用户数量一致</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.158 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>    object_type,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">COUNT</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">AS</span> <span style="color:#66d9ef">count</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Users&#39;</span> <span style="color:#66d9ef">AS</span> object_type <span style="color:#66d9ef">FROM</span> mysql.<span style="color:#66d9ef">user</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Databases&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.SCHEMATA <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">SCHEMA_NAME</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Tables&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.TABLES <span style="color:#66d9ef">WHERE</span> TABLE_TYPE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;BASE TABLE&#39;</span> <span style="color:#66d9ef">AND</span> TABLE_SCHEMA <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Views&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.VIEWS <span style="color:#66d9ef">WHERE</span> TABLE_SCHEMA <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Triggers&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.TRIGGERS <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">TRIGGER_SCHEMA</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Routines&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.ROUTINES <span style="color:#66d9ef">WHERE</span> ROUTINE_TYPE <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;FUNCTION&#39;</span>, <span style="color:#e6db74">&#39;PROCEDURE&#39;</span>) <span style="color:#66d9ef">AND</span> <span style="color:#66d9ef">ROUTINE_SCHEMA</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Events&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.EVENTS <span style="color:#66d9ef">WHERE</span> EVENT_SCHEMA <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#e6db74">&#39;Indexes&#39;</span> <span style="color:#66d9ef">FROM</span> information_schema.<span style="color:#66d9ef">STATISTICS</span> <span style="color:#66d9ef">WHERE</span> TABLE_SCHEMA <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;mysql&#39;</span>, <span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;sys&#39;</span>)
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">AS</span> all_objects
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> object_type <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">ROLLUP</span>;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><h3 id="应用切割">应用切割</h3>
<ol>
<li>
<p>网络层做隔离(网络工程师)</p>
</li>
<li>
<p>旧库设置只读，杀连接 192.168.100.157</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.157  -e &#34;set global read_only=on;set global super_read_only=on;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.157    -e &#34;SELECT CONCAT(&#39;KILL &#39;, id, &#39;;&#39;) FROM information_schema.processlist WHERE user NOT IN (&#39;root&#39;, &#39;replUser&#39;,&#39;event_scheduler&#39;);&#34;  | grep -v CONCAT &gt; /tmp/kill192.168.100.157
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.157  &lt; /tmp/kill192.168.100.157
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.157   -e &#34;show processlist;&#34;
</span></span></span></code></pre></div><p>旧库设置只读，杀连接 192.168.100.158</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.158  -e <span style="color:#e6db74">&#34;set global read_only=on;set global super_read_only=on;show variables like &#39;%read_only%&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.158    -e <span style="color:#e6db74">&#34;SELECT CONCAT(&#39;KILL &#39;, id, &#39;;&#39;) FROM information_schema.processlist WHERE user NOT IN (&#39;root&#39;, &#39;replUser&#39;,&#39;event_scheduler&#39;);&#34;</span>  | grep -v CONCAT &gt; /tmp/kill192.168.100.158
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.158  &lt; /tmp/kill192.168.100.158
</span></span><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.158   -e <span style="color:#e6db74">&#34;show processlist;&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>停旧库和新库之间的数据同步</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 10.128.99.157  -e <span style="color:#e6db74">&#34;show slave status\G&#34;</span> &gt;/tmp/last_slave_state
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sleep 5;
</span></span><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 10.128.99.157  -e <span style="color:#e6db74">&#34;stop slave;reset slave all;show slave status\G&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>记录当前binglog位置用于回滚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157 -e &#34;show master status;&#34; &gt;/tmp/binlog_rollback_info
</span></span></span></code></pre></div></li>
<li>
<p>创建双主关系 10.128.99.157 &ndash;&gt; 10.128.99.158</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">多次执行确认master 位置不在变化</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.158 -e &#34;show master status;&#34; |tee /tmp/master1012899158
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>cat <span style="color:#f92672">/</span>tmp<span style="color:#f92672">/</span>master1012899158
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>CHANGE MASTER <span style="color:#66d9ef">TO</span>
</span></span><span style="display:flex;"><span>MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;10.128.99.158&#39;</span>,
</span></span><span style="display:flex;"><span>MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span>,
</span></span><span style="display:flex;"><span>MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;replUser&#39;</span>,
</span></span><span style="display:flex;"><span>MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RsU#58d1@&#39;</span>,
</span></span><span style="display:flex;"><span>MASTER_LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>MASTER_LOG_POS<span style="color:#f92672">=</span>;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><p>启动主从关系</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 10.128.99.157 -e <span style="color:#e6db74">&#34;start slave ; show slave status \G&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>新库关闭只读</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%read_only%&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.158 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%read_only%&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div></li>
<li>
<p>观察连接情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.158  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.157  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.158  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span></code></pre></div></li>
</ol>
<h3 id="回退环境搭建">回退环境搭建</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> <span style="color:#75715e">--port=6301 -h 192.168.100.157 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>stop slave; <span style="color:#66d9ef">reset</span> slave <span style="color:#66d9ef">all</span>; <span style="color:#66d9ef">show</span> slave status <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /tmp/binlog_rollback_info
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.157 -e <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;CHANGE MASTER TO
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_HOST=&#39;10.128.99.157&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PORT=6301,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_USER=&#39;replUser&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PASSWORD=&#39;RsU#58d1@&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_LOG_FILE=&#39;&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_LOG_POS=;&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.157 -e <span style="color:#e6db74">&#34;start slave;show slave status\G&#34;</span>
</span></span></code></pre></div><h3 id="执行回退">执行回退</h3>
<ol>
<li>
<p>旧库设置只读，杀连接</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157 -e &#34;set global read_only=on;set global super_read_only=on;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157  -e &#34;SELECT CONCAT(&#39;KILL &#39;, id, &#39;;&#39;) FROM information_schema.processlist WHERE user NOT IN (&#39;root&#39;, &#39;replUser&#39;,&#39;event_scheduler&#39;);&#34;  | grep -v CONCAT &gt; /tmp/kill10.128.99.157 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157   &lt; /tmp/kill10.128.99.157 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157    -e &#34;show processlist;&#34;
</span></span></span></code></pre></div></li>
<li>
<p>停旧库和新库之间的数据同步</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">没有延迟后，重置主从同步，取消只读。</span>
</span></span><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> <span style="color:#75715e">--port=6301 -h 192.168.100.157 -e &#34;stop slave;reset slave all;&#34;
</span></span></span></code></pre></div><p>恢复 192.168.100.157 &ndash;&gt; 192.168.100.158 的数据同步</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">多次执行确认master 位置不在变化</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> <span style="color:#75715e">--port=6301 -h 192.168.100.158 -e &#34;show master status;&#34; |tee /tmp/master192168100158
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>cat <span style="color:#f92672">/</span>tmp<span style="color:#f92672">/</span>master192168100158
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -uroot  -p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> --port<span style="color:#f92672">=</span><span style="color:#ae81ff">6301</span> -h 192.168.100.157 -e <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CHANGE MASTER TO
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_HOST=&#39;192.168.100.158&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PORT=6301,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_USER=&#39;replUser&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PASSWORD=&#39;RsU#58d1@&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_LOG_FILE=&#39;&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_LOG_POS=;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> <span style="color:#75715e">--port=6301 -h 192.168.100.157 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">start</span> slave ;<span style="color:#66d9ef">show</span> slave status <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> <span style="color:#75715e">--port=6301 -h 192.168.100.157 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;<span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span> <span style="color:#75715e">--port=6301 -h 192.168.100.158 -e &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> super_read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> read_only<span style="color:#f92672">=</span><span style="color:#66d9ef">off</span>;<span style="color:#e6db74">&#34;
</span></span></span></code></pre></div></li>
<li>
<p>查看连接状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.157  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 10.128.99.158  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.157  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql <span style="color:#f92672">-</span>uroot  <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;d988ec6a93!@#MYSQL&#39;</span>  <span style="color:#75715e">--port=6301 -h 192.168.100.158  -e &#34;show processlist;show variables like &#39;%read_only%&#39;;&#34;
</span></span></span></code></pre></div></li>
</ol>

</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-600b4b95c21a8be4c420759c9c310fb0">7.2 - </h1>
    
	<p><a href="https://www.bilibili.com/video/BV1vL4y1J7i3/?p=14&amp;spm_id_from=pageDriver" target="_blank">mongo入门bilibili</a></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c17b09cb9416e4f7264c73ad103ea272">7.3 - </h1>
    
	<table>
  <thead>
      <tr>
          <th>特性</th>
          <th>开源版</th>
          <th>企业版</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>部署与管理</td>
          <td>手动部署、配置复杂</td>
          <td>支持多种部署模式，提供管理工具（GUI/CLI/API）  - 自建环境（软件安装） - Kubernetes - 托管服务（DBaaS） - 多云/混合云</td>
      </tr>
      <tr>
          <td>扩展性</td>
          <td>扩展需手动分片，可能停机</td>
          <td>支持在线水平和垂直扩容</td>
      </tr>
      <tr>
          <td>数据同步</td>
          <td>无内置数据同步工具</td>
          <td>RDI 自动同步关系数据库 - RDI（Redis Data Integration）自动同步关系型数据库 - 支持 Write Behind 模式</td>
      </tr>
      <tr>
          <td>技术支持</td>
          <td>社区支持</td>
          <td>24x7 原厂 + 虹科技术支持</td>
      </tr>
      <tr>
          <td>监控与运维</td>
          <td>需自行集成监控工具</td>
          <td>内置可观测性，支持多种监控平台 - 集成 Prometheus、Grafana、DataDog、Dynatrace 等 - 提供 Admin GUI、CLI、REST API、Terraform</td>
      </tr>
      <tr>
          <td>安全性</td>
          <td>基础认证，无企业级加密与审计</td>
          <td>全链路加密、ACL、LDAP、SSO、合规支持</td>
      </tr>
      <tr>
          <td>多租户</td>
          <td>-</td>
          <td>支持多租户，资源隔离</td>
      </tr>
      <tr>
          <td>Proxy支持</td>
          <td>-</td>
          <td>内置高性能 Proxy，简化客户端接入</td>
      </tr>
      <tr>
          <td>AI/ML支持</td>
          <td>-</td>
          <td>完整向量数据库与特征存储 - 向量数据库（Vector Database） - 特征存储（Feature Store） - 加速大语言模型（LLM）应用</td>
      </tr>
      <tr>
          <td>双主架构</td>
          <td>-</td>
          <td>支持Active-Active系统架构</td>
      </tr>
  </tbody>
</table>
<h3 id="常见问题">常见问题</h3>
<p>redis 主从切换
1.由于主节点阻塞通讯异常导致的主从切换 ==&gt; 检查慢查询命令（批量写入、批量删除、lua脚本等）、bigkeys</p>
<pre><code>2.主节点所在机器硬件故障导致的主从切换 ==》 检查主节点是否宕机，等待机器修复；检查服务器日志是否存在硬件报错
</code></pre>
<p>redis 内存使用率过高 ==》 检查是否存在内存泄漏（如：缓存未过期、缓存未命中等）；检查是否存在bigkeys（如：hash、list、set、zset等）
==》 redis节点扩容内存</p>
<p>redis 连接数过高 ==》 导出客户端连接明细给开发分析，分析是否存在异常连接数增加的客户端或者调整最大连接数配置</p>
<p>redis 响应时间过高 ==》 检查是否存在慢查询命令（如：批量写入、批量删除、lua脚本等）</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-e77814dc865bc892f94ffc02d54f2cfc">安装部署</h1>
	<div class="lead">redis部署安装</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-01" class="text-body-secondary">Friday, August 01, 2025</time>
        
	</div>
	<p>redis（<em>remote dictionary server</em>） 是开源的k-v<a href="https://db-engines.com/en/ranking" target="_blank">数据库</a>，使用内存存储，主要定位为数据缓存。除此之外还可以用于 <em>session 共享</em>，<em>排行榜、计数器</em>，<em>消息队列</em></p>

  
  
  

  
   
     

<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>安装部署</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="单节点" aria-controls="tabs-00-01" aria-selected="true">
        单节点
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="主从" aria-controls="tabs-00-02" aria-selected="false">
        主从
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="哨兵" aria-controls="tabs-00-03" aria-selected="false">
        哨兵
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-04" role="tab"
          data-td-tp-persist="集群" aria-controls="tabs-00-04" aria-selected="false">
        集群
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <p><span id=redis部署之单节点><font color=red size=4px>redis部署之单节点</font></span></p>
<ol>
<li>
<p>部署安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget http://download.redis.io/releases/redis-5.0.14.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf redis-5.0.14.tar.gz <span style="color:#f92672">&amp;&amp;</span> cd redis-5.0.14
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make <span style="color:#f92672">&amp;&amp;</span> make PREFIX<span style="color:#f92672">=</span>/opt/redis install 
</span></span></code></pre></div><p>二进制文件介绍</p>
<table>
  <thead>
      <tr>
          <th>命令</th>
          <th>释义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis-server</code></td>
          <td>启动server</td>
      </tr>
      <tr>
          <td><code>redis-cli</code></td>
          <td>客户端工具</td>
      </tr>
      <tr>
          <td><code>redis-benchmark</code></td>
          <td>基准测试工具</td>
      </tr>
      <tr>
          <td><code>redis-check-aof</code></td>
          <td>aof 检测和修复工具</td>
      </tr>
      <tr>
          <td><code>redis-check-dump</code></td>
          <td>rdb 检测和修复工具</td>
      </tr>
      <tr>
          <td><code>redis-sentinel</code></td>
          <td>启动 sentinel</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server
</span></span></code></pre></div></li>
</ol>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <p><span id=redis部署之主从><font color=red size=4px>redis部署之主从</font></span></p>
<blockquote>
<p><sub>主从架构在单节点基础上提供了数据的冗余能力，提升了redis的读取能力</sub></p>
</blockquote>
<ol>
<li>
<p>部署安装</p>
<p>参照 <a href=#redis部署之单节点>redis部署之单节点</a></p>
</li>
<li>
<p>启动服务</p>
<blockquote>
<p><sub>【支持三种配置方式：】</sub></p>
<p><sub>1. 在启动命令中添加<code> --SLAVEOF 10.4.7.251 6379</code></sub></p>
<p><sub>2. 通过redis-cli 登录到redis 执行 <code>slaveof 10.4.7.251 6379</code></sub></p>
<p><sub>3. 在redis.conf配置文件中写入 <code>slaveof 10.4.7.251 6379</code></sub></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6379</span> --daemonize yes --protected-mode no 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6380</span> --daemonize yes  --protected-mode no --SLAVEOF 10.4.7.251 <span style="color:#ae81ff">6379</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6381</span> --daemonize yes  --protected-mode no --SLAVEOF 10.4.7.251 <span style="color:#ae81ff">6379</span>
</span></span></code></pre></div><p>确认主从关系</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /opt/redis/bin/redis-cli -h 10.4.7.251 -p 6379 info replication</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Replication</span>
</span></span><span style="display:flex;"><span>role:master
</span></span><span style="display:flex;"><span>connected_slaves:2
</span></span><span style="display:flex;"><span>slave0:ip<span style="color:#f92672">=</span>10.4.7.251,port<span style="color:#f92672">=</span>6380,state<span style="color:#f92672">=</span>online,offset<span style="color:#f92672">=</span>56,lag<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>slave1:ip<span style="color:#f92672">=</span>10.4.7.251,port<span style="color:#f92672">=</span>6381,state<span style="color:#f92672">=</span>online,offset<span style="color:#f92672">=</span>56,lag<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div></li>
<li>
<p>测试主从切换</p>
<p>首先观察从节点复制偏移量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6380</span> info replication|grep master_repl_offset
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6381</span> info replication|grep master_repl_offset
</span></span></code></pre></div><p>选择一个偏移量最大的从节点，执行切换为主节点。当前环境我们把 <code>10.4.7.251:6381</code>切换为新的主节点。其他节点从新建立与该节点的主从关系</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6381</span> slaveof no one
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6381</span> role
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6379</span> SLAVEOF 10.4.7.251 <span style="color:#ae81ff">6381</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6380</span> SLAVEOF 10.4.7.251 <span style="color:#ae81ff">6381</span>
</span></span></code></pre></div></li>
<li>
<p>复制原理及相关参数</p>
<p><strong>复制原理</strong></p>
<pre><code>1. 从库通过slaveof 指令连接到master，并发起sync请求
2. master确认后，派生子线程bgsave生成rdb快照，并将快照传递给salve
3. salve接收到rdb快照后，清空本机rdb,加载主库传递过来的rdb 到内存
4. 以上完成后，master 会将变更数据缓存到本地 buffer中，按照一定规则传递给slave。允许从节点在短时间与主节点断开。
</code></pre>
<table>
  <thead>
      <tr>
          <th>复制相关参数</th>
          <th>解释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>repl-backlog-szie 1M</code></td>
          <td>环形复制积压缓冲区。最小值16k</td>
      </tr>
      <tr>
          <td><code>repl-diskless-sync yes</code></td>
          <td>开启无盘复制</td>
      </tr>
      <tr>
          <td><code>repl-diskless-sync-delay 5</code></td>
          <td>无盘复制延迟等待时长</td>
      </tr>
  </tbody>
</table>
</li>
</ol>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <p><span id=redis部署之哨兵><a herf=https://redis.io/docs/management/sentinel/><font color=red size=4px>redis部署之哨兵</font></a></span></p>
<blockquote>
<p><sub>哨兵集群是对主从的扩展，提供了主节点故障的自动转移并通知应用方能力。Redis从2.8开始正式 提供了Redis Sentinel</sub></p>
</blockquote>
<p>架构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>       +----+
</span></span><span style="display:flex;"><span>       | M1 |
</span></span><span style="display:flex;"><span>       | S1 |
</span></span><span style="display:flex;"><span>       +----+
</span></span><span style="display:flex;"><span>          |
</span></span><span style="display:flex;"><span>+----+    |    +----+
</span></span><span style="display:flex;"><span>| R2 |----+----| R3 |
</span></span><span style="display:flex;"><span>| S2 |         | S3 |
</span></span><span style="display:flex;"><span>+----+         +----+
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Configuration: quorum <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span></code></pre></div><ol>
<li>
<p>部署安装</p>
<p>参照<a href=#redis部署之单节点>redis部署之单节点</a></p>
</li>
<li>
<p>启动服务</p>
<p>参照<a href=#redis部署之主从>redis部署之主从</a></p>
</li>
<li>
<p>配置sentinel</p>
<blockquote>
<p><sub>Master-specific configuration parameters are modified using：<code>SENTINEL SET</code></sub></p>
<p><sub>Global configuration parameters are modified using <code>SENTINEL CONFIG SET</code>.</sub></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee redis-sentinel.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">daemonize yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># mymaster 为该集群起一个别名。一个sentinel 可以同时监控多个集群，因此使用别名区分
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># redis master的地址和端口10.4.7.251 6379
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2 表示有2个sentinel 判断master失败后才进行主从切换
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sentinel monitor mymaster 10.4.7.251 6379 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 每个Sentinel节点都要通过定期发送ping命令来判断Redis数据节点和其
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 余Sentinel节点是否可达，如果超过了down-after-milliseconds配置的时间且没
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 有有效的回复，则判定节点不可达 30000ms
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sentinel down-after-milliseconds mymaster 30000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 选举出新的主节点后，同时向主节点执行psync的从节点个数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sentinel parallel-syncs mymaster 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 故障转移超时时间 180000ms（选举新的主节点+从节点完成主从复制）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sentinel failover-timeout mymaster 180000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置sentinel 密码
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sentinel auth-pass mymaster 123456
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#sentinel auth-pass mymaster 12345
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#### 一组sentinel 支持多个主从集群
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#sentinel monitor resque 192.168.1.3 6380 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#sentinel down-after-milliseconds resque 10000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#sentinel failover-timeout resque 180000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#sentinel parallel-syncs resque 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>启动sentinel【默认监听26379】</p>
<blockquote>
<p><sub>【sentinel 的启动方式有2种：】</sub></p>
<p><sub><code>redis-sentinel /path/to/sentinel.conf</code></sub></p>
<p><sub><code>redis-server /path/to/sentinel.conf --sentinel</code></sub></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /tmp/<span style="color:#f92672">{</span>26379,26380,26381<span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server redis-sentinel.conf --sentinel <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bind 10.4.7.251 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--port <span style="color:#ae81ff">26379</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--dir /tmp/26379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--logfile /tmp/26379.log
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server redis-sentinel.conf --sentinel <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bind 10.4.7.251 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--port <span style="color:#ae81ff">26380</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--dir /tmp/26380 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--logfile /tmp/26380.log
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server redis-sentinel.conf --sentinel <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bind 10.4.7.251 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--port <span style="color:#ae81ff">26381</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--dir /tmp/26381 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--logfile /tmp/26381.log
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis-4.2/bin/redis-server ./redis-4.0.2/redis-sentinel17778.conf --port <span style="color:#ae81ff">17778</span> --sentinel --protected-mode no  --logfile /tmp/17778.log 
</span></span><span style="display:flex;"><span>/opt/redis-4.2/bin/redis-server ./redis-4.0.2/redis-sentinel17779.conf --port <span style="color:#ae81ff">17779</span> --sentinel --protected-mode no --logfile /tmp/17779.log
</span></span><span style="display:flex;"><span>/opt/redis-4.2/bin/redis-server ./redis-4.0.2/redis-sentinel17777.conf --port <span style="color:#ae81ff">17777</span> --sentinel --protected-mode no --logfile /tmp/17777.log
</span></span></code></pre></div></li>
<li>
<p>验证状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /opt/redis/bin/redis-cli -p 26379 -h 10.4.7.251</span>
</span></span><span style="display:flex;"><span>10.4.7.251:26379&gt; info sentinel
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sentinel</span>
</span></span><span style="display:flex;"><span>sentinel_masters:1
</span></span><span style="display:flex;"><span>sentinel_tilt:0
</span></span><span style="display:flex;"><span>sentinel_running_scripts:0
</span></span><span style="display:flex;"><span>sentinel_scripts_queue_length:0
</span></span><span style="display:flex;"><span>sentinel_simulate_failure_flags:0
</span></span><span style="display:flex;"><span>master0:name<span style="color:#f92672">=</span>mymaster,status<span style="color:#f92672">=</span>ok,address<span style="color:#f92672">=</span>10.4.7.251:6379,slaves<span style="color:#f92672">=</span>2,sentinels<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ok  状态正常</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#sdown 主观下线</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#odown 客观下线</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Redis Sentinel 有两种不同的宕机概念，一种称为 主观上为 Down 条件 （SDOWN），并且是 local 添加到给定的 Sentinel 实例。另一个称为客观关闭条件 （ODOWN），当有足够的 Sentinel（至少 number 配置为被监控 master 的参数）具有 SDOWN 条件</span>
</span></span></code></pre></div></li>
<li>
<p>验证主宕机</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -p <span style="color:#ae81ff">6379</span> -h 10.4.7.251 shutdown 
</span></span></code></pre></div><p>sentinel 节点30s 后标记节点主观（Subjectively）下线</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sentinel1_1  | 1:X <span style="color:#ae81ff">15</span> Apr <span style="color:#ae81ff">2024</span> 08:40:26.982 <span style="color:#75715e"># +sdown master mymaster 10.4.7.251 6379</span>
</span></span><span style="display:flex;"><span>sentinel2_1  | 1:X <span style="color:#ae81ff">15</span> Apr <span style="color:#ae81ff">2024</span> 08:40:26.983 <span style="color:#75715e"># +sdown master mymaster 10.4.7.251 6379</span>
</span></span><span style="display:flex;"><span>sentinel3_1  | 1:X <span style="color:#ae81ff">15</span> Apr <span style="color:#ae81ff">2024</span> 08:40:27.032 <span style="color:#75715e"># +sdown master mymaster 10.4.7.251 6379</span>
</span></span></code></pre></div><p>等待30s 后选出主节&hellip;.</p>
<p>重新启动宕机的节点，会自动加入到该主从中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> /opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6379</span> --daemonize yes
</span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>命令</th>
          <th>解释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>sentinel master mymaster</code></td>
          <td>查询主节点状态</td>
      </tr>
      <tr>
          <td><code>sentinel slaves mymaster</code></td>
          <td>查询从节点状态。或者命令 <code>sentinel replicas mymaster</code></td>
      </tr>
      <tr>
          <td><code>sentinel sentinels mymaster</code></td>
          <td>查询除自己外的sentinel节点信息</td>
      </tr>
      <tr>
          <td><code>sentinel get-master--by-name mymaster</code></td>
          <td>查询主节点的ip:port</td>
      </tr>
      <tr>
          <td><code> sentinel ckquorum mymaster</code></td>
          <td>检查哨兵集群是否满足切换需求</td>
      </tr>
      <tr>
          <td><code>sentinel flushconfig</code></td>
          <td>强制将sentinel 配置写入磁盘</td>
      </tr>
      <tr>
          <td><code>sentinel failover mymaster</code></td>
          <td>强制主从切换</td>
      </tr>
      <tr>
          <td><code>sentinel info-cache</code></td>
          <td>返回master-slave的缓存信息</td>
      </tr>
      <tr>
          <td><code>sentinel config get *</code></td>
          <td>获取sentinel 配置信息 &gt;=6.2</td>
      </tr>
      <tr>
          <td><code>sentinel config set &lt;key&gt; &lt;value&gt;</code></td>
          <td>动态设置sentinel 配置 &gt;=6.2</td>
      </tr>
  </tbody>
</table>
</li>
</ol>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-04" role="tabpanel" aria-labelled-by="tabs-00-04-tab" tabindex="0">
        <p><span id=redis部署之集群><font color=red size=4px>redis部署之集群</font></span></p>
<blockquote>
<p><sub>redis cluster 是redis 的分布式解决方案，在3.0后正式推出。其主要解决<strong>单节点写能力</strong>和<strong>存储能力</strong>受限的问题。</sub></p>
<p><sub>Redis集群相对单机在功能上存在一些限制，需要开发人员提前了解， 在使用时做好规避。限制如下：</sub></p>
<p><sub>1）key批量操作支持有限。如mset、mget，目前只支持具有相同slot值的 key执行批量操作。对于映射为不同slot值的key由于执行mset、mget等操作可能存在于多个节点上因此不被支持。<br>2）key事务操作支持有限。同理只支持多key在同一节点上的事务操作，当多个key分布在不同的节点上时无法使用事务功能。<br>3）key作为数据分区的最小粒度，因此不能将一个大的键值对象如 hash、list等映射到不同的节点。<br>4）不支持多数据库空间。单机下的Redis可以支持16个数据库，集群模式下只能使用一个数据库空间，即db0。<br>5）复制结构只支持一层，从节点只能复制主节点，不支持嵌套树状复制结构。</sub></p>
</blockquote>
<p><strong>部署方法一：</strong></p>
<ol>
<li>
<p>部署安装</p>
<p>参照 <a href=#redis部署之单节点>redis部署之单节点</a></p>
</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> port in <span style="color:#f92672">{</span>6379,6380,6381,7379,7380,7381<span style="color:#f92672">}</span>;<span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    mkdir -p /opt/redis_<span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>	/opt/redis/bin/redis-server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--bind 0.0.0.0 --port <span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--daemonize yes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--cluster-enabled yes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--cluster-config-file /opt/redis_<span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span>/nodes.conf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--logfile  /opt/redis_<span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span>/redis.log <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--cluster-node-timeout <span style="color:#ae81ff">1500</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--requirepass pytc@2024
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div></li>
<li>
<p>创建集群</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo yes |/opt/redis/bin/redis-cli -a pytc@2024 --cluster create <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster-replicas <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>192.168.0.161:6379 192.168.0.161:6380 192.168.0.161:6381 192.168.0.161:7379 192.168.0.161:7380 192.168.0.161:7381 
</span></span></code></pre></div></li>
</ol>
<p><strong>部署方法二：</strong></p>
<ol>
<li>
<p>部署安装</p>
<p>参照 <a href=#redis部署之单节点>redis部署之单节点</a></p>
</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6379</span> --daemonize yes  --cluster-enabled yes --cluster-config-file nodes-6379.conf --cluster-node-timeout <span style="color:#ae81ff">1500</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6380</span> --daemonize yes  --cluster-enabled yes --cluster-config-file nodes-6380.conf --cluster-node-timeout <span style="color:#ae81ff">1500</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6381</span> --daemonize yes  --cluster-enabled yes --cluster-config-file nodes-6381.conf --cluster-node-timeout <span style="color:#ae81ff">1500</span>
</span></span></code></pre></div></li>
<li>
<p>安装ruby环境</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rpm -e ruby --nodeps
</span></span><span style="display:flex;"><span>wget https://github.com/postmodern/ruby-install/archive/refs/tags/v0.8.5.tar.gz
</span></span><span style="display:flex;"><span>tar xf v0.8.5.tar.gz
</span></span><span style="display:flex;"><span>cd ruby-install-0.8.5/
</span></span><span style="display:flex;"><span>make install
</span></span><span style="display:flex;"><span>ruby-install --system ruby 2.6.10
</span></span></code></pre></div></li>
<li>
<p>安装redis-trib 工具</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># gem 是ruby的包管理工具，可以类比python的pip</span>
</span></span><span style="display:flex;"><span>yum install rubygems redis-trib -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gem sources
</span></span><span style="display:flex;"><span>gem sources --remove https://rubygems.org/
</span></span><span style="display:flex;"><span>gem sources -a https://mirrors.aliyun.com/rubygems/
</span></span><span style="display:flex;"><span>gem install redis
</span></span></code></pre></div></li>
<li>
<p>创建集群</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-trib create --replicas <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>10.4.7.251:6379 10.4.7.251:6380 10.4.7.251:6381
</span></span></code></pre></div></li>
</ol>
<p><strong>部署方法三：</strong></p>
<ol>
<li>
<p>部署安装</p>
<p>参照 <a href=#redis部署之单节点>redis部署之单节点</a></p>
</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6379</span> --daemonize yes  --cluster-enabled yes --cluster-config-file nodes-6379.conf --cluster-node-timeout <span style="color:#ae81ff">1500</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6380</span> --daemonize yes  --cluster-enabled yes --cluster-config-file nodes-6380.conf --cluster-node-timeout <span style="color:#ae81ff">1500</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-server --bind 10.4.7.251 --port <span style="color:#ae81ff">6381</span> --daemonize yes  --cluster-enabled yes --cluster-config-file nodes-6381.conf --cluster-node-timeout <span style="color:#ae81ff">1500</span>
</span></span></code></pre></div></li>
<li>
<p>加入集群</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 cluster meet 10.4.7.251 <span style="color:#ae81ff">6380</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 cluster meet 10.4.7.251 <span style="color:#ae81ff">6381</span>
</span></span></code></pre></div></li>
<li>
<p>分配槽位</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 cluster addslots <span style="color:#f92672">{</span>0..5460<span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6380</span> cluster addslots <span style="color:#f92672">{</span>5461..10921<span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/redis/bin/redis-cli -h 10.4.7.251 -p <span style="color:#ae81ff">6381</span> cluster addslots <span style="color:#f92672">{</span>10922..16383<span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>建立主从关系</p>
</li>
</ol>
<p><strong>新增分片</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli --cluster add-node 127.0.0.1:7006 127.0.0.1:7000
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli -p <span style="color:#ae81ff">7000</span> cluster nodes
</span></span><span style="display:flex;"><span>46a768cfeadb9d2aee91ddd882433a1798f53271 127.0.0.1:7006@17006 master - <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754504000</span> <span style="color:#ae81ff">0</span> connected
</span></span><span style="display:flex;"><span>1f2bc068c7ccc9e408161bd51b695a9a47b890b2 127.0.0.1:7003@17003 slave a138f48fe038b93ea2e186e7a5962fb1fa6e34fa <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754504551</span> <span style="color:#ae81ff">3</span> connected
</span></span><span style="display:flex;"><span>5b4e4be56158cf6103ffa3035024a8d820337973 127.0.0.1:7001@17001 master - <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754505584</span> <span style="color:#ae81ff">2</span> connected 5461-10922
</span></span><span style="display:flex;"><span>a138f48fe038b93ea2e186e7a5962fb1fa6e34fa 127.0.0.1:7002@17002 master - <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754505000</span> <span style="color:#ae81ff">3</span> connected 10923-16383
</span></span><span style="display:flex;"><span>71e078dab649166dcbbcec51520742bc7a5c1992 127.0.0.1:7005@17005 slave 5b4e4be56158cf6103ffa3035024a8d820337973 <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754505584</span> <span style="color:#ae81ff">2</span> connected
</span></span><span style="display:flex;"><span>f224ecabedf39d1fffb34fb6c1683f8252f3b7dc 127.0.0.1:7000@17000 myself,master - <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754502000</span> <span style="color:#ae81ff">1</span> connected 0-5460
</span></span><span style="display:flex;"><span>04d71d5eb200353713da475c5c4f0a4253295aa4 127.0.0.1:7004@17004 slave f224ecabedf39d1fffb34fb6c1683f8252f3b7dc <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1616754505896</span> <span style="color:#ae81ff">1</span> connect
</span></span></code></pre></div><p>添加从节点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli -p <span style="color:#ae81ff">7000</span> --cluster add-node 127.0.0.1:7007 127.0.0.1:7000 --cluster-slave --cluster-master-id 46a768cfeadb9d2aee91ddd882433a1798f53271
</span></span></code></pre></div><p>为新分片分配slot</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli -p <span style="color:#ae81ff">7000</span> --cluster reshard 127.0.0.1:7000
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>How many slots <span style="color:#66d9ef">do</span> you want to move <span style="color:#f92672">(</span>from <span style="color:#ae81ff">1</span> to 16384<span style="color:#f92672">)</span>? <span style="color:#ae81ff">4096</span>
</span></span><span style="display:flex;"><span>What is the receiving node ID? 46a768cfeadb9d2aee91ddd882433a1798f53271
</span></span><span style="display:flex;"><span>Please enter all the source node IDs.
</span></span><span style="display:flex;"><span>  Type <span style="color:#e6db74">&#39;all&#39;</span> to use all the nodes as source nodes <span style="color:#66d9ef">for</span> the hash slots.
</span></span><span style="display:flex;"><span>  Type <span style="color:#e6db74">&#39;done&#39;</span> once you entered all the source nodes IDs.
</span></span><span style="display:flex;"><span>Source node <span style="color:#75715e">#1: all</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Ready to move <span style="color:#ae81ff">4096</span> slots.
</span></span><span style="display:flex;"><span>  Source nodes:
</span></span><span style="display:flex;"><span>	M: f224ecabedf39d1fffb34fb6c1683f8252f3b7dc 127.0.0.1:7000
</span></span><span style="display:flex;"><span>   	slots:<span style="color:#f92672">[</span>0-5460<span style="color:#f92672">]</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">5461</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   	<span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	M: 5b4e4be56158cf6103ffa3035024a8d820337973 127.0.0.1:7001
</span></span><span style="display:flex;"><span>   	slots:<span style="color:#f92672">[</span>5461-10922<span style="color:#f92672">]</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">5462</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   	<span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	M: a138f48fe038b93ea2e186e7a5962fb1fa6e34fa 127.0.0.1:7002
</span></span><span style="display:flex;"><span>   	slots:<span style="color:#f92672">[</span>10923-16383<span style="color:#f92672">]</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">5461</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   	<span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  Destination node:
</span></span><span style="display:flex;"><span>	M: 46a768cfeadb9d2aee91ddd882433a1798f53271 127.0.0.1:7006
</span></span><span style="display:flex;"><span>   	slots: <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   	<span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  Resharding plan:
</span></span><span style="display:flex;"><span>	Moving slot <span style="color:#ae81ff">5461</span> from 5b4e4be56158cf6103ffa3035024a8d820337973
</span></span><span style="display:flex;"><span>	Moving slot <span style="color:#ae81ff">5462</span> from 5b4e4be56158cf6103ffa3035024a8d820337973
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want to proceed with the proposed reshard plan <span style="color:#f92672">(</span>yes/no<span style="color:#f92672">)</span>? 
</span></span><span style="display:flex;"><span>Moving slot <span style="color:#ae81ff">5461</span> from 127.0.0.1:7001 to 127.0.0.1:7006:
</span></span><span style="display:flex;"><span>Moving slot <span style="color:#ae81ff">5462</span> from 127.0.0.1:7001 to 127.0.0.1:7006:
</span></span><span style="display:flex;"><span>Moving slot <span style="color:#ae81ff">5463</span> from 127.0.0.1:7001 to 127.0.0.1:7006:
</span></span></code></pre></div>
    </div>
</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c15fb40811dca9bb931163d78690c06b">redis-shake2.1.2</h1>
	<div class="lead">redis-shake2.1.2 docker镜像构建</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-01" class="text-body-secondary">Friday, August 01, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">


    redis-shake2.1.2 版本支持 redis 2.x to 6.x

</div>

<p><strong>参数</strong></p>
<table>
  <thead>
      <tr>
          <th>变量名</th>
          <th>可选值（举例）</th>
          <th><strong>备注</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>sourceType</td>
          <td>standalone sentinel cluster proxy</td>
          <td></td>
      </tr>
      <tr>
          <td>sourceAddress</td>
          <td>10.1.1.1:20331;10.1.1.2:20441</td>
          <td></td>
      </tr>
      <tr>
          <td>sourcePassword</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>targetType</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>targetAddress</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>targetPassword</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>keyExists</td>
          <td>rewrite none ignore</td>
          <td></td>
      </tr>
      <tr>
          <td>filterKeyWhitelist</td>
          <td>&ldquo;abc;bzz&rdquo;</td>
          <td>filterKeyWhitelist 和 filterKeyBlacklist 不能同时设置</td>
      </tr>
      <tr>
          <td>filterKeyBlacklist</td>
          <td>&ldquo;abc;bzz&rdquo;</td>
          <td></td>
      </tr>
      <tr>
          <td>filterDbWhitelist</td>
          <td>0;5;10</td>
          <td></td>
      </tr>
      <tr>
          <td>filterDbBlacklist</td>
          <td>0;5;10</td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="构建镜像">构建镜像</h3>

<details>
  <summary>Details</summary>
  <p>启动脚本<code>entrypoint.sh</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>set -ex
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>config<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>cat &gt;/etc/redis-shake.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">conf.version = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">id = redis-shake
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">system_profile = 9310
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http_profile = 9320
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">parallel = 32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">source.type = ${sourceType:- &#34;cluster&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">source.address = ${sourceAddress}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">source.password_raw = ${sourcePassword}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">source.auth_type = auth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target.type = ${targetType:- &#34;cluster&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target.address = ${targetAddress}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target.password_raw = ${targetPassword}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target.auth_type = auth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target.db = -1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">key_exists = ${keyExists:-&#34;ignore&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filter.db.whitelist = ${filterDbWhitelist}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filter.db.blacklist = ${filterDbBlacklist}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filter.key.whitelist = ${filterKeyWhitelist}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filter.key.blacklist = ${filterKeyBlacklist}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">big_key_threshold = 524288000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metric = true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metric.print_log = false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sender.size = 104857600
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sender.count = 4095
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sender.delay_channel_size = 65535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keep_alive = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">scan.key_number = 50
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">scan.special_cloud =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">scan.key_file =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">qps = 200000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">resume_from_break_point = false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">replace_hash_tag = false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exec <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div></details>


<details>
  <summary>Details</summary>
  <p><code>Dockerfile.yml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>FROM alpine:3.13
</span></span><span style="display:flex;"><span>ARG version<span style="color:#f92672">=</span>2.1.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN sed -i s#dl-cdn.alpinelinux.org#mirrors.tuna.tsinghua.edu.cn#g /etc/apk/repositories <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\ </span>
</span></span><span style="display:flex;"><span>    apk update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apk add vim curl python3 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    alias python<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;python3&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    rm -rf /var/cache/apk/*
</span></span><span style="display:flex;"><span><span style="color:#75715e">#wget https://github.com/tair-opensource/RedisShake/releases/download/release-v2.1.2-20220329/release-v2.1.2-20220329.tar.gz</span>
</span></span><span style="display:flex;"><span>COPY entrypoint.sh /
</span></span><span style="display:flex;"><span>COPY redis-shake.linux /usr/bin/redis-shake.linux
</span></span><span style="display:flex;"><span>EXPOSE <span style="color:#ae81ff">9320</span>
</span></span><span style="display:flex;"><span>ENTRYPOINT <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/entrypoint.sh&#34;</span><span style="color:#f92672">]</span>
</span></span></code></pre></div></details>

<p>构建镜像</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod +x  entrypoint.sh
</span></span><span style="display:flex;"><span>docker build . -t redis-shake:2.1.2-alpine
</span></span></code></pre></div><h3 id="迁移示例">迁移示例</h3>
<ol>
<li>
<p>docker环境测试变量解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee env<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sourceType=cluster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sourceAddress=127.0.0.1:6379;127.0.0.1:6380;127.0.0.1:6381;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sourcePassword=123
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetType=cluster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetAddress= 127.0.0.1:6479;127.0.0.1:6480;127.0.0.1:6481;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetPassword=456
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keyExists=rewrite
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filterKeyWhitelist=&#34;abc;bzz&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filterKeyBlacklist=&#34;abc;bzz&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filterDbWhitelist=0;5;10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filterKeyBlacklist=0;5;10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it  --env-file env redis-shak:2.1.2-alpine sh
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it  --env-file env redis-shak:2.1.2-alpine redis-shake.linux -type<span style="color:#f92672">=</span>sync -conf<span style="color:#f92672">=</span>/etc/redis-shake.conf
</span></span></code></pre></div></li>
<li>
<p>资源压力测试</p>
<table>
  <thead>
      <tr>
          <th>源端（版本5.0）</th>
          <th>目标端（版本5.0）</th>
          <th>数据量</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>8分片</td>
          <td>3分片</td>
          <td>12GB</td>
      </tr>
  </tbody>
</table>
<p>2.1 在源端生成数据</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 约12G数据</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nodelist<span style="color:#f92672">=(</span>
</span></span><span style="display:flex;"><span>node01
</span></span><span style="display:flex;"><span>node02
</span></span><span style="display:flex;"><span>node03
</span></span><span style="display:flex;"><span>node04
</span></span><span style="display:flex;"><span>node05
</span></span><span style="display:flex;"><span>node06
</span></span><span style="display:flex;"><span>node07
</span></span><span style="display:flex;"><span>node08
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#e6db74">${</span>nodelist[@]<span style="color:#e6db74">}</span>;<span style="color:#66d9ef">do</span> redis-cli -a <span style="color:#ae81ff">123</span> -h $i debug populate <span style="color:#ae81ff">12000000</span> $i;<span style="color:#66d9ef">done</span>
</span></span></code></pre></div>
     
     
<ul class="nav nav-tabs" id="tabs-3" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-03-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-00" role="tab"
          data-td-tp-persist="资源使用情况1" aria-controls="tabs-03-00" aria-selected="true">
        资源使用情况1
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-03-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-01" role="tab"
          data-td-tp-persist="资源使用情况2" aria-controls="tabs-03-01" aria-selected="false">
        资源使用情况2
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-3-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-03-00" role="tabpanel" aria-labelled-by="tabs-03-00-tab" tabindex="3">
        <p>2.2.1  配置同步</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d --net<span style="color:#f92672">=</span>host --env-file env nosql.registry.io:5000/redis-shak:2.1.2-alpine redis-shake.linux -type<span style="color:#f92672">=</span>sync -conf<span style="color:#f92672">=</span>/etc/redis-shake.conf
</span></span></code></pre></div><p>2.3.1 资源使用情况和同步耗时</p>
<p><img src="/docs/database/redis/%E8%B5%84%E6%BA%90%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B52.png" alt=""></p>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-03-01" role="tabpanel" aria-labelled-by="tabs-03-01-tab" tabindex="3">
        <p>2.2.1  配置同步，限制为 3c 4g</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d --cpus<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> -m 4G --net<span style="color:#f92672">=</span>host --env-file env nosql.registry.io:5000/redis-shak:2.1.2-alpine redis-shake.linux -type<span style="color:#f92672">=</span>sync -conf<span style="color:#f92672">=</span>/etc/redis-shake.conf
</span></span></code></pre></div><p>2.3.1 资源使用情况和同步耗时</p>
<p><img src="/docs/database/redis/%E8%B5%84%E6%BA%90%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5.png" alt=""></p>

    </div>
</div>

</li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-6ddb86c8e13cf6905967891813012ff5">redis-shake3.1.11</h1>
	<div class="lead">redis-shake3.1.11 docker镜像构建</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-01" class="text-body-secondary">Friday, August 01, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">


    Tested on Redis 5.0, Redis 6.0 and Redis 7.0

</div>

<p><strong>参数</strong></p>
<table>
  <thead>
      <tr>
          <th>变量名</th>
          <th>可选值（举例）</th>
          <th>备注</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>redisSourceVersion</td>
          <td>such as 2.8, 4.0, 5.0, 6.0, 6.2, 7.0, &hellip;</td>
          <td>浮点类型，赋值不需要加引号</td>
      </tr>
      <tr>
          <td>sourceAddress</td>
          <td>10.1.1.1:20331</td>
          <td>字符串类型，赋值需要加引号。集群中任意节点</td>
      </tr>
      <tr>
          <td>sourcePassword</td>
          <td></td>
          <td>字符串类型，赋值需要加引号</td>
      </tr>
      <tr>
          <td>targetType</td>
          <td>&ldquo;standalone&rdquo; or &ldquo;cluster&rdquo;</td>
          <td>字符串类型，赋值需要加引号</td>
      </tr>
      <tr>
          <td>redisTargetVersion</td>
          <td>such as 2.8, 4.0, 5.0, 6.0, 6.2, 7.0, &hellip;</td>
          <td>浮点类型，赋值不需要加引号</td>
      </tr>
      <tr>
          <td>targetAddress</td>
          <td>10.1.1.1:20331</td>
          <td>如果是集群模式，只写其中一个node,其他node信息redis-shake 通过 <code>cluster nodes</code>获取</td>
      </tr>
      <tr>
          <td>targetPassword</td>
          <td></td>
          <td>字符串类型，赋值需要加引号</td>
      </tr>
      <tr>
          <td>keyExists</td>
          <td>rewrite panic ignore</td>
          <td>字符串类型，赋值需要加引号</td>
      </tr>
      <tr>
          <td>prefixfilter</td>
          <td>true false</td>
          <td>确定前缀后后缀匹配</td>
      </tr>
      <tr>
          <td>filterKey</td>
          <td>{&ldquo;ABC&rdquo;,&ldquo;abc&rdquo;,&ldquo;def&rdquo;,&ldquo;def_&rdquo;}</td>
          <td></td>
      </tr>
      <tr>
          <td>blackfilter</td>
          <td>true false</td>
          <td>确定是黑名单还是白名单过滤</td>
      </tr>
  </tbody>
</table>
<h3 id="构建镜像">构建镜像</h3>

<details>
  <summary>Details</summary>
  <p>启动脚本<code>entrypoint.sh</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>set -ex
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>config<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>cat &gt;/etc/sync.toml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">type = &#34;sync&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[source]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">version = ${redisSourceVersion}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">address = ${sourceAddress}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">username = &#34;&#34; # keep empty if not using ACL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password = ${sourcePassword}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tls = false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[target]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">type = ${targetType}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">version = ${redisTargetVersion}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">address = ${targetAddress}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">username = &#34;&#34; # keep empty if not using ACL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password = ${targetPassword}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tls = false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[advanced]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dir = &#34;data&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># runtime.GOMAXPROCS, 0 means use runtime.NumCPU() cpu cores
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ncpu = 4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pprof_port = 9310
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metrics_port = 9320
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rdb_restore_command_behavior = ${keyExists:-&#34;ignore&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pipeline_count_limit = 1024
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target_redis_client_max_querybuf_len = 1024_000_000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">target_redis_proto_max_bulk_len = 512_000_000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#array = {&#34;ABC&#34;,&#34;abc&#34;,&#34;def&#34;,&#34;def_&#34;}</span>
</span></span><span style="display:flex;"><span>array<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>filterKey<span style="color:#66d9ef">:-</span><span style="color:#e6db74">&#34;{}&#34;</span><span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">${</span>prefixfilter<span style="color:#e6db74">}</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#34;^&#34;&#39;</span>
</span></span><span style="display:flex;"><span>    suffix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#34;&#34;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#34;&#34;&#39;</span>
</span></span><span style="display:flex;"><span>    suffix<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">${</span>blackfilter<span style="color:#e6db74">}</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    allow<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    disallow<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    allow<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    disallow<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>cat &gt;/etc/filter.lua<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">function filter(id, is_base, group, cmd_name, keys, slots, db_id, timestamp_ms)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    -- 对mset多key的判断
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    if #keys ~= 1 then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        for _k,key in ipairs(keys)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            for k,v in ipairs(${array})
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                -- if string.match(key,string.format(&#34;^%s&#34;,v)) then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                if string.match(key,string.format(&#34;%s%s%s&#34;,${prefix:-&#34;&#34;},v,${suffix:-&#34;&#34;})) then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -- print(key,v)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    return ${allow:-0}, db_id -- 0 is  allow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        return ${disallow:-0}, db_id --1 is disallow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for k,v in ipairs(${array})
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        -- if string.sub(keys[1], -3, -1) == v then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        if string.match(keys[1],string.format(&#34;%s%s%s&#34;,${prefix},v,${suffix})) then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            return ${allow:-0}, db_id -- allow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    return ${disallow:-0}, db_id -- disallow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exec <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div></details>


<details>
  <summary>Details</summary>
  <p><code>Dockerfile.yml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>FROM alpine:3.13
</span></span><span style="display:flex;"><span>ARG version<span style="color:#f92672">=</span>3.1.11
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN sed -i s#dl-cdn.alpinelinux.org#mirrors.tuna.tsinghua.edu.cn#g /etc/apk/repositories <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\ </span>
</span></span><span style="display:flex;"><span>    apk update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apk add vim curl python3 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    alias python<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;python3&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    rm -rf /var/cache/apk/*
</span></span><span style="display:flex;"><span><span style="color:#75715e">#wget https://github.com/tair-opensource/RedisShake/releases/download/v3.1.11/redis-shake-linux-amd64.tar.gz</span>
</span></span><span style="display:flex;"><span>COPY entrypoint.sh /
</span></span><span style="display:flex;"><span>COPY redis-shake /usr/bin/redis-shake
</span></span><span style="display:flex;"><span>EXPOSE <span style="color:#ae81ff">9320</span>
</span></span><span style="display:flex;"><span>ENTRYPOINT <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/entrypoint.sh&#34;</span><span style="color:#f92672">]</span>
</span></span></code></pre></div></details>

<p>构建镜像</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod +x  entrypoint.sh
</span></span><span style="display:flex;"><span>docker build . -t redis-shake:3.1.11-alpine 
</span></span></code></pre></div><h3 id="迁移示例">迁移示例</h3>
<ol>
<li>
<p>docker环境测试变量解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee env<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">redisSourceVersion=5.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sourceAddress=&#34;127.0.0.1:6379&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sourcePassword=&#34;123&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">redisTargetVersion=5.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetType=&#34;cluster&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetAddress=&#34;127.0.0.1:6479&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetPassword=&#34;456&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keyExists=&#34;rewrite&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prefixfilter=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filterKey={&#34;ABC&#34;,&#34;abc&#34;,&#34;def&#34;,&#34;def_&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">blackfilter=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it  --env-file env redis-shake:3.1.11-alpine sh
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it  --env-file env redis-shake:3.1.11-alpine  redis-shake /etc/sync.toml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it  --env-file env redis-shake:3.1.11-alpine  redis-shake /etc/sync.toml /etc/filter.lua
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker exec -it 36e54 curl 127.0.0.1:9320/metrics|python -m json.tool
</span></span></code></pre></div><p>指标监控：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>syncing aof. allowOps<span style="color:#f92672">=[</span>0.60<span style="color:#f92672">]</span>, disallowOps<span style="color:#f92672">=[</span>0.00<span style="color:#f92672">]</span>, entryId<span style="color:#f92672">=[</span>2<span style="color:#f92672">]</span>, InQueueEntriesCount<span style="color:#f92672">=[</span>0<span style="color:#f92672">]</span>, unansweredBytesCount<span style="color:#f92672">=[</span>0<span style="color:#f92672">]</span>bytes, diff<span style="color:#f92672">=[</span>0<span style="color:#f92672">]</span>, aofReceivedOffset<span style="color:#f92672">=[</span>9808<span style="color:#f92672">]</span>, aofAppliedOffset<span style="color:#f92672">=[</span>9808<span style="color:#f92672">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>allowOps：代表每秒向目的端发送多少条命令
</span></span><span style="display:flex;"><span>disallowOps：代表每秒有多少条命令被过滤掉
</span></span><span style="display:flex;"><span>entryId：从 <span style="color:#ae81ff">1</span> 开始计数，代表 redis-shake 从启动开始总共处理多少条命令
</span></span><span style="display:flex;"><span>InQueueEntriesCount：代表多少条命令待发送
</span></span><span style="display:flex;"><span>unansweredBytesCount：代表多少 bytes 命令已经发送了，但是对端还没有答复
</span></span><span style="display:flex;"><span>diff：aofReceivedOffset-aofAppliedOffset
</span></span><span style="display:flex;"><span>aofReceivedOffset：已经从源端接收到的点位
</span></span><span style="display:flex;"><span>aofAppliedOffset：已经在目的端恢复的点位
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>一般当 allowOps 为 <span style="color:#ae81ff">0</span> 时，代表数据迁移完成，可以停止 redis-shake。⚠️注意，因为源端会定时发送 PING 命令，所以哪怕源端没有写入，allowOps 偶尔也会不是 0。
</span></span></code></pre></div></li>
<li>
<p>资源压力测试</p>
<table>
  <thead>
      <tr>
          <th>源端（版本5.0）</th>
          <th>目标端（版本5.0）</th>
          <th>数据量</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>8分片</td>
          <td>3分片</td>
          <td>12GB</td>
      </tr>
  </tbody>
</table>
<p>测试结果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>单pod 消耗 220% cpu
</span></span><span style="display:flex;"><span>单pod 消耗 12MB memory
</span></span><span style="display:flex;"><span>全量同步耗时 6分钟
</span></span></code></pre></div></li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-9171779f07ad97b25103d1ce9ca3b8a7">redis数据库搬迁方案2</h1>
	<div class="lead">数据中心搬迁，龙腾出行redis数据库迁移</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-01" class="text-body-secondary">Friday, August 01, 2025</time>
        
	</div>
	<table>
  <thead>
      <tr>
          <th>旧环境</th>
          <th>新环境</th>
          <th>密码</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>192.168.100.66、192.168.100.67 11G</td>
          <td>10.128.100.66（主）、10.128.100.67（从）</td>
          <td>YSxeEr3e4ZdF</td>
      </tr>
      <tr>
          <td>192.168.100.34 11G</td>
          <td>10.128.100.34(主）、10.128.99.34(从)</td>
          <td></td>
      </tr>
      <tr>
          <td>192.168.100.57, 192.168.100.58, 192.168.100.59  6G</td>
          <td>10.128.100.57, 10.128.100.58, 10.128.100.59</td>
          <td>xb91830913039bhdk</td>
      </tr>
  </tbody>
</table>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">内存空余的情况下，被同步的源端执行</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 默认 256m 64m 60 调整为 512m 128m 60</span>
</span></span><span style="display:flex;"><span>CONFIG set client-output-buffer-limit <span style="color:#e6db74">&#34;slave 536870912 134217728 60&#34;</span>
</span></span><span style="display:flex;"><span>CONFIG GET client-output-buffer-limit 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 默认1m 调整为1gb</span>
</span></span><span style="display:flex;"><span>config set repl-backlog-size <span style="color:#ae81ff">1073741824</span>
</span></span><span style="display:flex;"><span>CONFIG GET repl-backlog-size
</span></span></code></pre></div>

</div>

<h3 id="切换">切换</h3>


  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="redis01" aria-controls="tabs-01-00" aria-selected="true">
        redis01
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="redis02" aria-controls="tabs-01-01" aria-selected="false">
        redis02
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <p><strong>redis01登录 10.128.100.66 杀连接</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.100.66/ &amp;&amp; !/10.128.100.67/ {print &#34;client kill&#34;, $4}&#39;</span>| redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.100.66/ &amp;&amp; !/10.128.100.67/ {print &#34;client kill&#34;, $4}&#39;</span>
</span></span></code></pre></div><p><strong>停同步</strong></p>
<p>数据校验</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info keyspace
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 info keyspace
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis_check.sh --source-ip 192.168.100.67 --source-pwd YSxeEr3e4ZdF <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --target-ip 10.128.100.66 --target-pwd YSxeEr3e4ZdF <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --compare-mode <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --qps <span style="color:#ae81ff">5000</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --db-file redis01.db
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 client list
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 slaveof no one 
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 info replication
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;set a b\n del a&#34;</span> | redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66
</span></span></code></pre></div><p>添加从节点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.67 slaveof 10.128.100.66 <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.67 info replication
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <p><strong>redis02登录 10.128.99.34 杀连接</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 192.168.100.34 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.99.34/ &amp;&amp; !/10.128.100.34/{print &#34;client kill&#34;, $4}&#39;</span>|redis-cli -h 192.168.100.34
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>redis-cli -h 192.168.100.34 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.99.34/ &amp;&amp; !/10.128.100.34/{print &#34;client kill&#34;, $4}&#39;</span>
</span></span></code></pre></div><p><strong>停同步</strong></p>
<p>数据校验</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 192.168.100.34 info keyspace
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.34 info keyspace
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis_check.sh --source-ip 192.168.100.34 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --target-ip 10.128.100.34 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --compare-mode <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --qps <span style="color:#ae81ff">5000</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --db-file redis02.db
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 10.128.100.34 client list
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.34 slaveof no one 
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.34 info replication
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;set a b\n del a&#34;</span> | redis-cli -h 10.128.100.34  
</span></span></code></pre></div>
    </div>
</div>

<h3 id="回退">回退</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## redis01登录 10.128.100.66 清理旧库数据</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 bgsave </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># mv /dump.rdb /dump.rdb.$(date +%F\ %H:%M:%S)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 确认没有从节点连接</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info replication </span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 slaveof 10.128.100.66 6379 </span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info replication</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## redis02登录 10.128.99.34 清理旧库数据 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -h 192.168.100.34 bgsave </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># mv /dump.rdb /dump.rdb.$(date +%F\ %H:%M:%S)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 确认没有从节点连接</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -h 192.168.100.34 info replication </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -a YSxeEr3e4ZdF -h 192.168.100.34 slaveof 10.128.100.34 6379 </span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># redis-cli -a YSxeEr3e4ZdF -h 192.168.100.34 info replication</span>
</span></span></code></pre></div>

  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          data-td-tp-persist="redis01" aria-controls="tabs-02-00" aria-selected="true">
        redis01
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="redis02" aria-controls="tabs-02-01" aria-selected="false">
        redis02
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        <p><strong>redis01登录 10.128.100.66 杀连接</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.100.66/ &amp;&amp; !/10.128.100.67/ &amp;&amp; !/192.168.100.66/{print &#34;client kill&#34;, $4}&#39;</span>| redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.100.66/ &amp;&amp; !/10.128.100.67/ &amp;&amp; !/192.168.100.66/{print &#34;client kill&#34;, $4}&#39;</span>
</span></span></code></pre></div><p><strong>停同步</strong></p>
<p>数据校验</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info keyspace
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 10.128.100.66 info keyspace
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis_check.sh --source-ip 10.128.100.66 --source-pwd YSxeEr3e4ZdF <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --target-ip 192.168.100.66 --target-pwd YSxeEr3e4ZdF <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --compare-mode <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --qps <span style="color:#ae81ff">50000</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>               --db-file redis01.db
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 client list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 slaveof no one 
</span></span><span style="display:flex;"><span>redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 info replication
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;set a b\n del a&#34;</span> | redis-cli -a YSxeEr3e4ZdF -h 192.168.100.66 
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <p><strong>redis02登录 10.128.99.34 杀连接</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># redis02登录 10.128.99.34 杀连接</span>
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.34 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.99.34/ &amp;&amp; !/192.168.100.34/{print &#34;client kill&#34;, $4}&#39;</span>|redis-cli -h 10.128.100.34
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.34 client list|awk -F <span style="color:#e6db74">&#34; |=&#34;</span>  <span style="color:#e6db74">&#39;!/127.0.0.1/ &amp;&amp; !/10.128.99.34/ &amp;&amp; !/192.168.100.34/{print &#34;client kill&#34;, $4}&#39;</span>
</span></span></code></pre></div><p><strong>停同步</strong></p>
<p>数据校验</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 192.168.100.34 info keyspace
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.34 info keyspace
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis_check.sh --source-ip 10.128.100.34 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --target-ip 192.168.100.34 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --compare-mode <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --qps <span style="color:#ae81ff">50000</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                 --db-file redis02.db
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 停同步</span>
</span></span><span style="display:flex;"><span>redis-cli -h 192.168.100.34  client list
</span></span><span style="display:flex;"><span>redis-cli -h 192.168.100.34 slaveof no one 
</span></span><span style="display:flex;"><span>redis-cli -h 192.168.100.34 info replication
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;set a b\n del a&#34;</span> | redis-cli -h 192.168.100.34 
</span></span></code></pre></div>
    </div>
</div>

<h3 id="收尾工作">收尾工作</h3>
<ol>
<li>
<p>停止集群的同步工具</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/Data/redis7/redis7_6379/bin/redis-cli -a xb91830913039bhdk --cluster call 192.168.100.58:6379 dbsize
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl status redis_sync_cluster01
</span></span></code></pre></div></li>
<li>
<p>从节点接入到master</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 10.128.99.34 slaveof 10.128.100.34 <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.67 -a YSxeEr3e4ZdF slaveof 10.128.100.66 <span style="color:#ae81ff">6379</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 10.128.99.34 config set save <span style="color:#e6db74">&#34;900 1 300 10 60 10000&#34;</span>
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.99.34 config rewirte
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -h 10.128.100.67 -a YSxeEr3e4ZdF config set save <span style="color:#e6db74">&#34;900 1 300 10 60 10000&#34;</span>
</span></span><span style="display:flex;"><span>redis-cli -h 10.128.100.67 -a YSxeEr3e4ZdF config rewirte
</span></span></code></pre></div></li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a9beb947715b173b615f76eaebc63922">Redis8.4.0版本</h1>
	<div class="lead">背景:Redis5.0.14 被爆出存在多种安全漏洞，为规避漏洞考虑升级为8.4.0</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-12-23" class="text-body-secondary">Tuesday, December 23, 2025</time>
        
	</div>
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker network create 8.4.0 --subnet 100.100.1.0/24
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#f92672">{</span>2..7<span style="color:#f92672">}</span>;<span style="color:#66d9ef">do</span> docker rm -fv cmbredis<span style="color:#e6db74">${</span>i<span style="color:#e6db74">}</span>;<span style="color:#66d9ef">done</span> 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#f92672">{</span>2..7<span style="color:#f92672">}</span>;<span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>docker run -d <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--name<span style="color:#f92672">=</span>cmbredis<span style="color:#e6db74">${</span>i<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--net<span style="color:#f92672">=</span>8.4.0 --ip<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100.100.1.</span><span style="color:#e6db74">${</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e SALT_MASTER_IP_LIST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;192.168.0.1&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_CONFIG<span style="color:#f92672">=</span>pcloud_config <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_BGSAVE<span style="color:#f92672">=</span>bgsave <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_DEBUG<span style="color:#f92672">=</span>debug <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_SAVE<span style="color:#f92672">=</span>save <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_SHUTDOWN<span style="color:#f92672">=</span>shutdown <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_SLAVEOF<span style="color:#f92672">=</span>slaveof <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e RENAME_CMD_BGREWRITEAOF<span style="color:#f92672">=</span>bgrewriteaof <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e REDIS_PASSWORD<span style="color:#f92672">=</span><span style="color:#ae81ff">123</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>cmb-redis:8.4.0-alpine313;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker exec -it cmbredis2  redis-cli --user default -a <span style="color:#ae81ff">123</span> --cluster create <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster-replicas <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>100.100.1.2:6379 100.100.1.3:6379 100.100.1.4:6379 100.100.1.5:6379 100.100.1.6:6379 100.100.1.7:6379
</span></span></code></pre></div>
</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c8553d33d8183ae3ce84731b8c2608db">7.4 - </h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-13e8e3ce9786760d8157f34cd761bd21">7.5 - </h1>
    
	<p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tidb-architecture-v6.png" alt=""></p>
<h3 id="集群安装">集群安装</h3>
<h3 id="数据同步">数据同步</h3>
<h3 id="数据迁移">数据迁移</h3>
<h3 id="数据备份">数据备份</h3>
<h3 id="数据恢复">数据恢复</h3>
<h3 id="命令行工具">命令行工具</h3>
<h3 id="监控">监控</h3>
<h3 id="安全">安全</h3>
<h3 id="性能优化">性能优化</h3>
<h3 id="故障处理">故障处理</h3>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-67eb87020312586dadda63d97ee6dd73">pcta</h1>
	<div class="lead">平凯数据库认证 TiDB 数据库专员（简称 PCTA）是平凯星辰对于数据库从业者安装部署及日常运维分布式关系型数据库能力的认证，要求数据库从业者熟练掌握 TiDB Open Core 架构原理、安装部署、周边工具等基础知识。</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-08-11" class="text-body-secondary">Monday, August 11, 2025</time>
        
	</div>
	<p><img src="https://asktug.com/uploads/default/original/4X/c/d/9/cd9bcb7f3bd551a7febf28c9f79c86cd81589517.png" alt=""></p>
<p>Tso(timestamp oracle) 用于标识事务的先后顺序</p>
<h3 id="tidb数据库架构">tidb数据库架构</h3>
<p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tidb-architecture-v6.png" alt=""></p>
<h4 id="tidb-server">tidb server</h4>
<p>tidb server为<font color=red>无状态</font>服务，在生产中可以启动多个实例并通过LB对外提供统一的连接地址。</p>
<p><strong>主要功能：</strong></p>
<ol>
<li>
<p>对外提供mysql 5.7协议的连接服务 （<code>protocol layer</code>）</p>
</li>
<li>
<p>负责对sql解析、编译、优化并最终生成执行计划 (<code>parese</code>、<code>compile</code>)</p>
<p><code>parse</code> 通过此法分析器将sql 拆借成一个一个的字段，接着进行此法分析。将解析后的内容传递给 <code>compile</code>, 编译器执行逻辑优化和物理优化生成执行计划</p>
</li>
<li>
<p>执行sql (<code>executor</code>、<code>distsql</code>、<code>kv</code>)、事务（<code>transaction</code>、<code>kv</code>）</p>
</li>
<li>
<p>负责sql语句与tikv 数据结构的转化 。</p>
<p><strong>表数据与 Key-Value 的映射关系:</strong></p>
<p>TiDB 会为每个表分配一个表 ID，用 <code>TableID</code> 表示。表 ID 是一个整数，在整个集群内唯一。TiDB 会为表中每行数据分配一个行 ID，用 <code>RowID</code> 表示。行 ID 也是一个整数，在表内唯一。对于行 ID，TiDB 做了一个小优化，如果某个表有整数型的主键，TiDB 会使用主键的值当做这一行数据的行 ID。</p>
<p>最终将每一行转换成以k:v 格式的数据,其中 <code>tablePrefix</code> 和 <code>recordPrefixSep</code> 都是特定的字符串常量，用于在 Key 空间内区分其他数据</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Key:   tablePrefix<span style="color:#f92672">{</span>TableID<span style="color:#f92672">}</span>_recordPrefixSep<span style="color:#f92672">{</span>RowID<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Value: <span style="color:#f92672">[</span>col1, col2, col3, col4<span style="color:#f92672">]</span>
</span></span></code></pre></div><p><strong>索引数据和 Key-Value 的映射关系:</strong></p>
<p>与表数据映射方案类似，TiDB 为表中每个索引分配了一个索引 ID，用 <code>IndexID</code> 表示。</p>
<p>对于主键和唯一索引，需要根据键值快速定位到对应的 RowID，因此，按照如下规则编码成 (Key, Value) 键值对：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Key:   tablePrefix<span style="color:#f92672">{</span>tableID<span style="color:#f92672">}</span>_indexPrefixSep<span style="color:#f92672">{</span>indexID<span style="color:#f92672">}</span>_indexedColumnsValue
</span></span><span style="display:flex;"><span>Value: RowID
</span></span></code></pre></div><p>对于不需要满足唯一性约束的普通二级索引，一个键值可能对应多行，需要根据键值范围查询对应的 RowID。因此，按照如下规则编码成 (Key, Value) 键值对：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Key:   tablePrefix<span style="color:#f92672">{</span>TableID<span style="color:#f92672">}</span>_indexPrefixSep<span style="color:#f92672">{</span>IndexID<span style="color:#f92672">}</span>_indexedColumnsValue_<span style="color:#f92672">{</span>RowID<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Value: null
</span></span></code></pre></div></li>
<li>
<p>执行online DDL (<code>schema load</code>、<code>worker</code>、<code>start job</code>)在同一时刻只有一个tidbserver执行该操作</p>
</li>
<li>
<p>垃圾回收（对于update 等多次的修改，数据库会保留历史版本，tidbserver 每隔10分钟(gc lifetime)执行一次历史版本的回收） （gc）</p>
</li>
<li>
<p>缓存（memBuffer）默认使用tidb-server 所有内存。</p>
<ul>
<li>sql结果</li>
<li>线程缓存</li>
<li>元数据，统计信息</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 每个sql可以使用最大内存</span>
</span></span><span style="display:flex;"><span>tidb_mem_quota_query
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 超过最大缓存时的动作，可以是杀掉sql</span>
</span></span><span style="display:flex;"><span>oom-action
</span></span></code></pre></div></li>
<li>
<p>热点小表缓存功能（v6.0版本开始支持对热点表缓存）(<code>cache table</code>)</p>
<ul>
<li>
<p>64MB 以下的表</p>
</li>
<li>
<p>查询频繁，修改极少</p>
</li>
<li>
<p>缓存租约时间内，阻塞写操作。</p>
</li>
<li>
<p>开启热点小表缓存的表，无法执行ddl 修改。</p>
</li>
</ul>
<p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250801085345694.png" alt=" "></p>
</li>
</ol>
<h4 id="pd">pd</h4>
<p>被称为<code>placement driver</code> 是整个集群的大脑内置etcd,<font color=red>有状态</font>建议部署奇数实现高可用。</p>
<ol>
<li>
<p>存储每个 TiKV 节点实时的数据分布情况和集群的整体拓扑结构等元数据</p>
</li>
<li>
<p>分配全局id和事务id</p>
</li>
<li>
<p>负责为集群内各组件分配TSO 时间戳。这些时间戳用于为事务和数据分配时间标记。对于事务提供一个开始TSO 和一个结束TSO 。</p>
<p>TSO 时间戳由两部分组成：</p>
<ul>
<li>物理时间戳：自 1970 年 1 月 1 日以来的 UNIX 时间戳，单位为毫秒</li>
<li>逻辑时间戳：递增计数器，用于需要在一毫秒内使用多个时间戳的情况，或某些事件可能触发时钟进程逆转的情况。在这些情况下，物理时间戳会保持不变，而逻辑时间戳保持递增。该机制可以确保 TSO 时间戳的完整性，确保时间戳始终递增而不会倒退。</li>
</ul>
</li>
<li>
<p>根据 TiKV 节点上报的数据动态均衡数据分布,例如：</p>
<ul>
<li>对tikv执行leader、热点region 均衡</li>
</ul>
<ul>
<li>集群拓扑</li>
<li>缩容</li>
<li>故障恢复</li>
<li>Region merge</li>
</ul>
</li>
<li>
<p>根据label，支持对region分布的手动调度。</p>
<p>tikv实例添加zone 、rack、host等标签后，可以通过pd的调度功能实现基于标签不同级别的高可用。（k8s的node节点添加标签后当pod调度时添加亲和反亲和策略）</p>
</li>
<li>
<p>提供 TiDB Dashboard 管控界面</p>
</li>
</ol>
<p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250808112254855.png" alt="image-20250808112254855"></p>
<p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250808112604664.png" alt="image-20250808112604664"></p>
<h4 id="tikv">TiKV</h4>
<p>作为分布式存储系统,tikv基于key-value方式存储数据。数据按照key的范围保存到region中，region是tikv的最小存储单元（大小在96MB-144MB之间），每个region默认保证三个副本通过raft协议保证数据的强一致性，而数据的落盘则调用 Facebook 开源的rocksDB实现。<font color=red>有状态服务</font></p>
<h5 id="rocksdb">RocksDB</h5>
<p><code>RocksDB</code> 是 Facebook 开源的单机 KV 存储引擎，内部使用LSM存储引擎</p>
<p><strong>数据存储流程：</strong> 数据存储时先写入wal 预写日志和 memTable中，当memtable 写入达到指定大小后将该memtable 归档并入immutable 的队列中，从新开启一个新的memtable继续接收新的写入。开启一个新线程将队列中的数据持续写入磁盘持久化</p>
<p>当队列中等待写入磁盘的队列大于5时，rocksdb开启流量控制降低写入速度。</p>
<p>磁盘中文件按照压缩级别分为6个级别：</p>
<p>level0 是 immutable的数据复刻，level0数据达到一定大小时rocksdb 执行数据合并压缩（compaction）生成level1文件，依次类推。 每一个文件称为SST（stored string table）</p>
<p><strong>数据读取流程：</strong> rocksdb中存在一个<em>blockcache</em> 的查询内存空间用于缓存最近查询，如果缓存中不存在则从memtable中查找，如果memtable找不到，继续去磁盘中通过<em>二分查找法</em>继续查找</p>
<p><strong>数据删除流程：</strong> 无需要查找到原始数据，只需要执行del操作</p>
<p><strong>RocksDB列族（column family）:</strong> 是rocksdb的数据分片技术，可以按照不同的id分配给不同的<strong>列族</strong>，如果未指定列族则写入default。一个rocksdb 实例可以对应多个列族，每个列族有自己的memtabl 、SST ，共享wal</p>
<p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250807084844225.png" alt="image-20250807084844225"></p>
<h5 id="raft">Raft</h5>
<p>RocksDB提供单机存储能力，为保证数据的高可用引入了<a href="https://raft.github.io/raft.pdf" target="_blank">raft协议</a>。TiKV 利用 Raft 来做数据复制，每个数据变更都会落地为一条 Raft 日志，通过 Raft 的日志复制功能，将数据安全可靠地同步到复制组的每一个节点中。通过实现 Raft，TiKV 变成了一个分布式的 Key-Value 存储。</p>
<ul>
<li>
<p>Leader选举。</p>
<p>在raft协议中节点刚创建时所有节点都处于<em>flollower</em>状态，在指定的 <em>election timeout</em>  时间内如果没有找到 <em>leader</em> ,优先达到 <em>election timeout</em> 的节点将发起选举进入<em>candidate</em> 状态并将<code>term+1</code>，在获得多数投票后该成员状态转为 <em>leader</em> 状态。</p>
<p>集群关系建立后，<em>leader</em>定期向<em>follower</em> 发送心跳消息，在指定的 <em>heartbeat time interval</em> 内未收到 <em>leader</em> 的心跳信息的<em>follwer</em> 将会进入下一个<em>term</em> 并发起选举进去<em>candidate</em>状态，在获得多数投票后该成员状态转为 <em>leader</em> 状态。</p>
</li>
<li>
<p>日志复制</p>
<p>raft 主从节点之间通过日志复制实现数据的一致性，期间经历以下阶段：</p>
<ol>
<li><code>propose</code> leader将写入请求转成raft log 格式</li>
<li><code>append</code> 保存日志到 <em>leader</em> 本地</li>
<li><code>replicate</code> 收到集群内大多数节点日志复制成功的确认消息</li>
<li><code>commited</code> 收到集群内大多数节点日志复制成功并持久化到本地确认消息</li>
<li><code>apply</code> 成功完成日志的持久化写入</li>
</ol>
</li>
<li>
<p>成员变更（如添加副本、删除副本、转移 Leader 等操作）</p>
</li>
</ul>
<p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250807111853595.png" alt="image-20250807111853595"></p>
<p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250807112836082.png" alt="image-20250807112836082"></p>
<h5 id="mvcc">MVCC</h5>
<p><code>MVCC (Multi-Version Concurrency Control)</code>假设有这样一种场景：某客户端 A 在写一个 Key，另一个客户端 B 同时在对这个 Key 进行读操作。如果没有数据的多版本控制机制，那么这里的读写操作必然互斥。在分布式场景下，这种情况可能会导致性能问题和死锁问题。有了 MVCC，只要客户端 B 执行的读操作的逻辑时间早于客户端 A，那么客户端 B 就可以在客户端 A 写入的同时正确地读原有的值。即使该 Key 被多个写操作修改过多次，客户端 B 也可以按照其逻辑时间读到旧的值。</p>
<h5 id="transaction">Transaction</h5>
<ol>
<li>
<p><code>Transaction</code>提供了分布式事务能力</p>
<p>两阶段提交</p>
<p>第一阶段：<code>prewrite</code>  设置锁信息，并将锁在rocksdb的lock列族中（锁信息仅在事务的第一行所在的tikv实例的lock列族中添加锁，其他行所在tikv lock列族引用该锁的地址）。需要修改的信息放入到default 列族中（修改信息大于255byte 放入default 列族中，小于255bytes放入到write列族中）</p>
<p>第二阶段：<code>commit</code> 从pd中获取tso,在write列族中写入提交信息。并释放lock 列族中的锁信息</p>
</li>
</ol>
<h5 id="coprocessor">coprocessor</h5>
<ol>
<li>coprocessor算子下推(在每个tikv中执行例如 <code>where</code> 、<code>group by</code> 等操作，过滤后再发给tidb server)</li>
</ol>
<p><strong>tikv 数据读取流程</strong></p>
<p>用户从tidb-server 发起查询请求，此时从pd 分配一个tso给到该线程，并告知该线程用户需要读取的数据在哪个tikv节点</p>
<p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tikv-arch.png" alt=""></p>
<pre class="mermaid">   graph TB
   
       subgraph TiKV node
       A(Transation)
       B(MVCC)
       C(Raft)
           subgraph rocksdb
           D[(RocksDB raft)]
           E[(RocksDB kv)]
           end
       end</pre>
<h3 id="tidb-htap">tidb HTAP</h3>
<p>TiDB 是PingCAP 公司开源的分布式数据库，兼容mysql协议支持水平扩缩容能力，同时实现HTAP（OLTP online transactional processing 和 OLAP online analytical processing）。具备智能选择（CBO自动或人工选择）能力</p>
<p><strong>OLTP 特征：</strong></p>
<ul>
<li>支持试试更新的行存</li>
<li>高并发、一致性要求高</li>
<li>每次操作少量数据</li>
</ul>
<p><strong>OLAP 特征：</strong></p>
<ul>
<li>
<p>批量更新列存</p>
</li>
<li>
<p>并发数低</p>
</li>
<li>
<p>每次操作大量数据</p>
</li>
<li>
<p><strong>tiflash：</strong> 是TiDB HTAP(OLAP OLTP ) 形态的关键组件，它是 TiKV 的列存扩展。和普通 TiKV 节点不一样的是，在 TiFlash 内部作为<code>learner</code>角色加入到tikv 的<code>region</code> 通过<code>raft log</code> 异步复制leader数据,tiflash不参与tikv数据选举、投票，数据是以列式的形式进行存储，主要的功能是为分析型的场景加速。可以理解为<font color=red>tikv是行存储，tiflash 是列存储。</font></p>
<p>MPP架构：每个tiflash 作为worker节点首先过滤符合条件的数据，之后按照 <strong>等值连接</strong> 将具有符合条件的数据执行数据交换到同一台tiflash中执行聚合计算</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>tidb_allow_mpp      
</span></span><span style="display:flex;"><span>tidb_enforce_mpp
</span></span></code></pre></div><p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tidb-storage-architecture-1.png" alt=""></p>
</li>
</ul>
<h3 id="60新功能">6.0新功能</h3>
<ul>
<li>
<p>热点小表缓存（表的特征：1. 表的数据不大(小于64MB) 2. 只读表或者修改不频繁的表 3.表的访问特别频繁）用于将表缓存在tidb server 的<code>cache table</code> 中提升读性能。</p>
<p>开启热点小表缓存的表，无法做ddl 的修改</p>
<p>实现原理：通过租约的方式缓存表内容，在租约时间范围内该表只能读，写处于阻塞状态。租约到期后批量将写内容更新的tikv，并更新tidb server的<code>cache table</code>重新计算租约时间。 相关参数 <code>tidb_table_cache_lease=5</code></p>
<p>具体实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t1 <span style="color:#66d9ef">cache</span>;
</span></span></code></pre></div><p><img src="C:%5CUsers%5Cpc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250810204836420.png" alt="image-20250810204836420"></p>
</li>
<li>
<p><code>placement rules in sql </code> 使用sql的方式精细化调度表在tikv的分布、副本数</p>
<p>创建一个规则</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> PLACEMENT POLICY P1
</span></span><span style="display:flex;"><span>PRIMARY_REGION <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Beijing&#34;</span>   <span style="color:#75715e">--leader 角色的region位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>REGIONS <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Beijing, Tokyo, Shanghai, London&#34;</span>  <span style="color:#75715e">--follower角色的region位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>FOLLOWERS <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>; <span style="color:#75715e">--follower数量
</span></span></span></code></pre></div><p>创建表时引用该规则</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> T5 (id INT) PLACEMENT POLICY<span style="color:#f92672">=</span>P1;
</span></span></code></pre></div></li>
<li>
<p>内存悲观锁, 事务的锁信息放置在leader 所在tikv的缓存中不会将锁信息复制到follwer节点，减少了磁盘io。当leader所在节点的tivk宕机后锁信息会丢失此时事务执行回滚。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--在线开启内存悲观锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> config tikv pessimistic<span style="color:#f92672">-</span>txn.pipelined<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;true&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> config tikv pessimistic<span style="color:#f92672">-</span>txn.<span style="color:#66d9ef">in</span><span style="color:#f92672">-</span>memory<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;true&#39;</span>;
</span></span></code></pre></div></li>
<li>
<p>topsql 基于cpu的使用量查找对应的sql。</p>
<p>例如：单个tikv 实例负载较高，此时可以使用topsql 功能查找到对应sql</p>
</li>
<li>
<p>tidb enterprise manager (TiEM) 可视化管理工具</p>
<ol>
<li>部署集群</li>
<li>升级集群</li>
<li>参数管理</li>
<li>组件管理</li>
<li>备份恢复与高可用管理</li>
<li>集群监控与告警</li>
<li>集群日志收集</li>
<li>审计与安全</li>
</ol>
</li>
</ul>
<h3 id="tidb-cloud">tidb cloud</h3>
<p>是一个DBaas 服务</p>
<p><strong>1. 关于 TiKV 或 TiDB Server，下列说法不正确的是?</strong></p>
<ul>
<li><input disabled="" type="checkbox"> A. 数据被持久化在 TiKV 的 RocksDB 引擎中</li>
<li><input disabled="" type="checkbox"> B. 对于老版本数据的回收（GC），是由 TiDB Server 在 TiKV 上完成的</li>
<li><input checked="" disabled="" type="checkbox"> C. 两阶段提交的锁信息被持久化到 TiDB Server 中</li>
<li><input disabled="" type="checkbox"> D. Region 可以在多个 TiKV 节点上进行调度，但是需要 PD 节点发出调度指令</li>
</ul>
<p>解题：tidb server 不存储数据</p>
<p><strong>2.关于关系型数据与KV的转化，下列说法不正确的是？</strong></p>
<ul>
<li><input disabled="" type="checkbox"> A. 如果没有定义主键，key中包含RowID，IndexID和TableID，都是int64类型</li>
<li><input disabled="" type="checkbox"> B. Table ID在整个集群内唯一</li>
<li><input checked="" disabled="" type="checkbox"> C. 如果定义了主键，那么将使用主键作为RowID</li>
<li><input disabled="" type="checkbox"> D. 不需要为每张表指定主键</li>
</ul>
<p><strong>3.关于关系型数据与 KV 的转化，下列说法</strong>不正确<strong>的是？</strong></p>
<ul>
<li><input disabled="" type="checkbox"> A. 如果没有定义主键，key 中包含 RowID、IndexID 和 TableID，都是 int64 类型</li>
<li><input disabled="" type="checkbox"> B. Table ID 在整个集群内唯一</li>
<li><input checked="" disabled="" type="checkbox"> C. 如果定义了主键，那么将使用主键作为 RowID</li>
<li><input disabled="" type="checkbox"> D. 不需要为每张表指定主键</li>
</ul>
<p><strong>解释：</strong> C 如果定义了主键，并主键为整数型的，TiDB 会使用主键的值当做这一行数据的RowID。</p>
<ul>
<li>
<p>6.0版本region 默认96MB,当达到144MB 是自动分裂</p>
</li>
<li>
<p>所有tidb server都可以接受ddl任务，并将ddl任务放在tikv 队列中。同一时刻只有一个tidb server的worker 模块是ower角色，该worker拥有执行ddl 任务的权利</p>
</li>
<li>
<p>tidb server 的gc 间隔默认10m一次</p>
</li>
</ul>
<p><a href="https://learn.pingcap.cn/learner/course" target="_blank">课程中心</a></p>
<p><a href="https://docs.pingcap.com/zh/tidb/stable/tidb-architecture/" target="_blank">TiDB 整体架构 | TiDB 文档中心</a></p>
<p><a href="https://docs.pingcap.com/zh/tidb/stable/tikv-overview/" target="_blank">TiKV 简介 | TiDB 文档中心</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span>  tidb_enable_top_sql<span style="color:#f92672">=</span><span style="color:#66d9ef">ON</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%top%&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">------------------------------------+------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Variable_name                      <span style="color:#f92672">|</span> Value      <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">------------------------------------+------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> ft_stopword_file                   <span style="color:#f92672">|</span> (built<span style="color:#f92672">-</span><span style="color:#66d9ef">in</span>) <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> innodb_ft_enable_stopword          <span style="color:#f92672">|</span> <span style="color:#66d9ef">ON</span>         <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> innodb_ft_server_stopword_table    <span style="color:#f92672">|</span>            <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> innodb_ft_user_stopword_table      <span style="color:#f92672">|</span>            <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> rpl_stop_slave_timeout             <span style="color:#f92672">|</span> <span style="color:#ae81ff">31536000</span>   <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> tidb_enable_top_sql                <span style="color:#f92672">|</span> <span style="color:#66d9ef">ON</span>         <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> tidb_top_sql_max_meta_count        <span style="color:#f92672">|</span> <span style="color:#ae81ff">5000</span>       <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> tidb_top_sql_max_time_series_count <span style="color:#f92672">|</span> <span style="color:#ae81ff">100</span>        <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">------------------------------------+------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">8</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
</span></span></code></pre></div><h3 id="sql-中的锁和事务">sql 中的锁和事务</h3>
<p>SQL-92 标准定义了 4 种隔离级别：读未提交 ()、读已提交 ()、可重复读 ()、串行化 ()。 详见下表：<code>READ UNCOMMITTED</code>、<code>READ COMMITTED</code>、<code>REPEATABLE READ</code>、<code>SERIALIZABLE</code></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">隔离级别</th>
          <th style="text-align: left">脏写</th>
          <th style="text-align: left">脏读</th>
          <th style="text-align: left">模糊读取</th>
          <th style="text-align: left">幻读</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">READ UNCOMMITTED</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">可能</td>
          <td style="text-align: left">可能</td>
          <td style="text-align: left">可能</td>
      </tr>
      <tr>
          <td style="text-align: left">READ COMMITTED</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">可能</td>
          <td style="text-align: left">可能</td>
      </tr>
      <tr>
          <td style="text-align: left">REPEATABLE READ</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">可能</td>
      </tr>
      <tr>
          <td style="text-align: left">SERIALIZABLE</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">不可能</td>
          <td style="text-align: left">不可能</td>
      </tr>
  </tbody>
</table>
<p>TiDB 语法上支持设置 和 两种隔离级别：<code>READ COMMITTED``REPEATABLE READ</code></p>
<p>缓存表的功能</p>
<p>rocksdb 性能与cpu数量的关系</p>
<p>导入数据后的一致性校验可以借助Coprocessor 由TiKV来完成</p>
<p>tidb server 各个组件的功能</p>
<p>GC life time是无法手工调整的</p>
<p>SQL语句的解析和编译可以与TSO的获取异步执行</p>
<p>sql 解析和编译流程，物理编译和逻辑编译</p>
<p>tidb cloud 的功能</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-6cd2fa811bb545211e56673b02260128">环境检查</h1>
	<div class="lead">prerun| tidb</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-17" class="text-body-secondary">Saturday, May 17, 2025</time>
        
	</div>
	<h3 id="版本选择">版本选择</h3>
<p>企业版和社区版的区别</p>
<h3 id="安装前环境检查">安装前环境检查</h3>
<p><strong>操作系统</strong>
支持部署在x86_64、arm_64、容器环境的 Linux 操作系统。</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    <ul>
<li>
<p>TiDB 在 v8.4.0 DMR 和 v8.5.0 版本中移除了对 glibc 2.17 的适配，以及对 CentOS Linux 7 的兼容性测试和支持，建议使用 Rocky Linux 9.1 及以上的版本。</p>
<p>如果在使用 CentOS Linux 7 的情况下将 TiDB 升级到 v8.4.0 DMR 或 v8.5.0 版本，将存在导致集群不可用的风险。</p>
</li>
<li>
<p>为了更好地服务仍在使用 CentOS Linux 7 的用户，TiDB 从 v8.5.1 版本起重新适配 glibc 2.17，恢复了对 CentOS Linux 7 的兼容性支持和测试。</p>
</li>
</ul>


</div>


  
  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>软件要求</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="中控机" aria-controls="tabs-01-01" aria-selected="true">
        中控机
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="目标主机" aria-controls="tabs-01-02" aria-selected="false">
        目标主机
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <table>
  <thead>
      <tr>
          <th style="text-align: left">软件</th>
          <th style="text-align: left">版本</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">sshpass</td>
          <td style="text-align: left">1.06 及以上</td>
      </tr>
      <tr>
          <td style="text-align: left">TiUP</td>
          <td style="text-align: left">1.5.0 及以上</td>
      </tr>
  </tbody>
</table>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <table>
  <thead>
      <tr>
          <th style="text-align: left">软件</th>
          <th style="text-align: left">版本</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">sshpass</td>
          <td style="text-align: left">1.06 及以上</td>
      </tr>
      <tr>
          <td style="text-align: left">numa</td>
          <td style="text-align: left">2.0.12 及以上</td>
      </tr>
      <tr>
          <td style="text-align: left">tar</td>
          <td style="text-align: left">任意</td>
      </tr>
  </tbody>
</table>

    </div>
</div>



<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    <ul>
<li>生产环境中的 TiDB 和 PD 可以部署和运行在同一台服务器上，如对性能和可靠性有更高的要求，应尽可能分开部署。</li>
<li>强烈建议分别为生产环境中的 TiDB、TiKV 和 TiFlash 配置至少 8 核的 CPU。强烈推荐使用更高的配置，以获得更好的性能。</li>
<li>TiKV 硬盘大小配置建议 PCIe SSD 不超过 4 TB，普通 SSD 不超过 1.5 TB。</li>
</ul>


</div>


  
  
  
<ul class="nav nav-tabs" id="tabs-3" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-03-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-00" role="tab"
          aria-controls="tabs-03-00" aria-selected="false">
        <strong>硬件要求</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-03-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-01" role="tab"
          data-td-tp-persist="开发及测试环境" aria-controls="tabs-03-01" aria-selected="true">
        开发及测试环境
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-03-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-02" role="tab"
          data-td-tp-persist="生产环境" aria-controls="tabs-03-02" aria-selected="false">
        生产环境
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-3-content">
    <div class="tab-body tab-pane fade"
        id="tabs-03-00" role="tabpanel" aria-labelled-by="tabs-03-00-tab" tabindex="3">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-03-01" role="tabpanel" aria-labelled-by="tabs-03-01-tab" tabindex="3">
        <table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>组件</strong></th>
          <th style="text-align: left"><strong>CPU</strong></th>
          <th style="text-align: left"><strong>内存</strong></th>
          <th style="text-align: left"><strong>本地存储</strong></th>
          <th style="text-align: left"><strong>网络</strong></th>
          <th style="text-align: left"><strong>实例数量(最低要求)</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">TiDB</td>
          <td style="text-align: left">8 核+</td>
          <td style="text-align: left">16 GB+</td>
          <td style="text-align: left"><a href="https://docs.pingcap.com/zh/tidb/stable/hardware-and-software-requirements/#%e7%a3%81%e7%9b%98%e7%a9%ba%e9%97%b4%e8%a6%81%e6%b1%82" target="_blank">磁盘空间要求</a></td>
          <td style="text-align: left">千兆网卡</td>
          <td style="text-align: left">1（可与 PD 同机器）</td>
      </tr>
      <tr>
          <td style="text-align: left">PD</td>
          <td style="text-align: left">4 核+</td>
          <td style="text-align: left">8 GB+</td>
          <td style="text-align: left">SAS, 200 GB+</td>
          <td style="text-align: left">千兆网卡</td>
          <td style="text-align: left">1（可与 TiDB 同机器）</td>
      </tr>
      <tr>
          <td style="text-align: left">TiKV</td>
          <td style="text-align: left">8 核+</td>
          <td style="text-align: left">32 GB+</td>
          <td style="text-align: left">SSD, 200 GB+</td>
          <td style="text-align: left">千兆网卡</td>
          <td style="text-align: left">3</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">32 核+</td>
          <td style="text-align: left">64 GB+</td>
          <td style="text-align: left">SSD, 200 GB+</td>
          <td style="text-align: left">千兆网卡</td>
          <td style="text-align: left">1</td>
      </tr>
      <tr>
          <td style="text-align: left">TiCDC</td>
          <td style="text-align: left">8 核+</td>
          <td style="text-align: left">16 GB+</td>
          <td style="text-align: left">SAS, 200 GB+</td>
          <td style="text-align: left">千兆网卡</td>
          <td style="text-align: left">1</td>
      </tr>
  </tbody>
</table>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-03-02" role="tabpanel" aria-labelled-by="tabs-03-02-tab" tabindex="3">
        <table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>组件</strong></th>
          <th style="text-align: left"><strong>CPU</strong></th>
          <th style="text-align: left"><strong>内存</strong></th>
          <th style="text-align: left"><strong>硬盘类型</strong></th>
          <th style="text-align: left"><strong>网络</strong></th>
          <th style="text-align: left"><strong>实例数量(最低要求)</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">TiDB</td>
          <td style="text-align: left">16 核+</td>
          <td style="text-align: left">48 GB+</td>
          <td style="text-align: left">SSD</td>
          <td style="text-align: left">万兆网卡（2 块最佳）</td>
          <td style="text-align: left">2</td>
      </tr>
      <tr>
          <td style="text-align: left">PD</td>
          <td style="text-align: left">8 核+</td>
          <td style="text-align: left">16 GB+</td>
          <td style="text-align: left">SSD</td>
          <td style="text-align: left">万兆网卡（2 块最佳）</td>
          <td style="text-align: left">3</td>
      </tr>
      <tr>
          <td style="text-align: left">TiKV</td>
          <td style="text-align: left">16 核+</td>
          <td style="text-align: left">64 GB+</td>
          <td style="text-align: left">SSD</td>
          <td style="text-align: left">万兆网卡（2 块最佳）</td>
          <td style="text-align: left">3</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">48 核+</td>
          <td style="text-align: left">128 GB+</td>
          <td style="text-align: left">1 or more SSDs</td>
          <td style="text-align: left">万兆网卡（2 块最佳）</td>
          <td style="text-align: left">2</td>
      </tr>
      <tr>
          <td style="text-align: left">TiCDC</td>
          <td style="text-align: left">16 核+</td>
          <td style="text-align: left">64 GB+</td>
          <td style="text-align: left">SSD</td>
          <td style="text-align: left">万兆网卡（2 块最佳）</td>
          <td style="text-align: left">2</td>
      </tr>
      <tr>
          <td style="text-align: left">监控</td>
          <td style="text-align: left">8 核+</td>
          <td style="text-align: left">16 GB+</td>
          <td style="text-align: left">SAS</td>
          <td style="text-align: left">千兆网卡</td>
          <td style="text-align: left">1</td>
      </tr>
  </tbody>
</table>

    </div>
</div>

<p><strong>网络要求</strong></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">组件</th>
          <th style="text-align: left">默认端口</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">TiDB</td>
          <td style="text-align: left">4000</td>
          <td style="text-align: left">应用及 DBA 工具访问通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiDB</td>
          <td style="text-align: left">10080</td>
          <td style="text-align: left">TiDB 状态信息上报通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiKV</td>
          <td style="text-align: left">20160</td>
          <td style="text-align: left">TiKV 通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiKV</td>
          <td style="text-align: left">20180</td>
          <td style="text-align: left">TiKV 状态信息上报通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">PD</td>
          <td style="text-align: left">2379</td>
          <td style="text-align: left">提供 TiDB 和 PD 通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">PD</td>
          <td style="text-align: left">2380</td>
          <td style="text-align: left">PD 集群节点间通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">9000</td>
          <td style="text-align: left">TiFlash TCP 服务端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">3930</td>
          <td style="text-align: left">TiFlash RAFT 服务和 Coprocessor 服务端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">20170</td>
          <td style="text-align: left">TiFlash Proxy 服务端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">20292</td>
          <td style="text-align: left">Prometheus 拉取 TiFlash Proxy metrics 端口</td>
      </tr>
      <tr>
          <td style="text-align: left">TiFlash</td>
          <td style="text-align: left">8234</td>
          <td style="text-align: left">Prometheus 拉取 TiFlash metrics 端口</td>
      </tr>
      <tr>
          <td style="text-align: left">CDC</td>
          <td style="text-align: left">8300</td>
          <td style="text-align: left">CDC 通信接口</td>
      </tr>
      <tr>
          <td style="text-align: left">Monitoring</td>
          <td style="text-align: left">9090</td>
          <td style="text-align: left">Prometheus 服务通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">Monitoring</td>
          <td style="text-align: left">12020</td>
          <td style="text-align: left">NgMonitoring 服务通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">Node_exporter</td>
          <td style="text-align: left">9100</td>
          <td style="text-align: left">TiDB 集群每个节点的系统信息上报通信端口</td>
      </tr>
      <tr>
          <td style="text-align: left">Blackbox_exporter</td>
          <td style="text-align: left">9115</td>
          <td style="text-align: left">Blackbox_exporter 通信端口，用于 TiDB 集群端口监控</td>
      </tr>
      <tr>
          <td style="text-align: left">Grafana</td>
          <td style="text-align: left">3000</td>
          <td style="text-align: left">Web 监控服务对外服务和客户端(浏览器)访问端口</td>
      </tr>
      <tr>
          <td style="text-align: left">Alertmanager</td>
          <td style="text-align: left">9093</td>
          <td style="text-align: left">告警 web 服务端口</td>
      </tr>
      <tr>
          <td style="text-align: left">Alertmanager</td>
          <td style="text-align: left">9094</td>
          <td style="text-align: left">告警通信端口</td>
      </tr>
  </tbody>
</table>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c968788ec97c1b8ea0974bc58c38f16b">集群安装</h1>
	<div class="lead">install|tidb</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	<p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tidb-architecture-v6.png" alt=""></p>

  
  

  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>环境准备</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="主机环境" aria-controls="tabs-00-01" aria-selected="true">
        主机环境
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="系统环境" aria-controls="tabs-00-02" aria-selected="false">
        系统环境
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <table>
  <thead>
      <tr>
          <th>os</th>
          <th>主机名</th>
          <th>ip</th>
          <th>cpu</th>
          <th>内存</th>
          <th>磁盘</th>
          <th>网卡</th>
          <th>集群</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>centos7.6</td>
          <td>tidb-dev01-s2</td>
          <td>192.168.0.223</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td>中控机</td>
      </tr>
      <tr>
          <td>centos7.6</td>
          <td>tidb-cmb01-s3</td>
          <td>192.168.0.105</td>
          <td>8</td>
          <td>8</td>
          <td>200G</td>
          <td>千兆</td>
          <td>cluster01</td>
      </tr>
      <tr>
          <td>centos7.6</td>
          <td>tidb-cmb02-s3</td>
          <td>192.168.0.106</td>
          <td>8</td>
          <td>8</td>
          <td>200G</td>
          <td>千兆</td>
          <td>cluster01</td>
      </tr>
      <tr>
          <td>centos7.6</td>
          <td>tidb-cmb03-s3</td>
          <td>192.168.0.107</td>
          <td>8</td>
          <td>8</td>
          <td>200G</td>
          <td>千兆</td>
          <td>cluster01</td>
      </tr>
      <tr>
          <td>centos7.6</td>
          <td>tidb-cmb04-s3</td>
          <td>192.168.0.108</td>
          <td>8</td>
          <td>8</td>
          <td>200G</td>
          <td>千兆</td>
          <td>cluster02</td>
      </tr>
      <tr>
          <td>centos7.6</td>
          <td>tidb-cmb05-s3</td>
          <td>192.168.0.140</td>
          <td>8</td>
          <td>8</td>
          <td>200G</td>
          <td>千兆</td>
          <td>cluster02</td>
      </tr>
      <tr>
          <td>centos7.6</td>
          <td>tidb-cmb06-s3</td>
          <td>192.168.0.162</td>
          <td>8</td>
          <td>8</td>
          <td>200G</td>
          <td>千兆</td>
          <td>cluster02</td>
      </tr>
  </tbody>
</table>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <ul>
<li>
<p>必备软件</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">软件</th>
          <th style="text-align: left">版本</th>
          <th>目标主机</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">sshpass</td>
          <td style="text-align: left">1.06 及以上</td>
          <td>中控机 &amp; 集群主机</td>
      </tr>
      <tr>
          <td style="text-align: left">numactl</td>
          <td style="text-align: left">2.0.12 及以上</td>
          <td>集群主机</td>
      </tr>
      <tr>
          <td style="text-align: left">tar</td>
          <td style="text-align: left">任意</td>
          <td>集群主机</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>时间同步</p>
</li>
<li>
<p>关闭swap</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;vm.swappiness = 0&#34;</span>&gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span>sysctl -p
</span></span><span style="display:flex;"><span>swapoff -a <span style="color:#f92672">&amp;&amp;</span> swapon -a
</span></span></code></pre></div></li>
<li>
<p>关闭防火墙</p>
</li>
<li>
<p>关闭selinux</p>
</li>
<li>
<p>关闭透明大页</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@tidb-cmb01-s3 ~<span style="color:#f92672">]</span><span style="color:#75715e"># echo never &gt;/sys/kernel/mm/transparent_hugepage/enabled</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@tidb-cmb01-s3 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat /sys/kernel/mm/transparent_hugepage/enabled</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># always madvise [never]</span>
</span></span></code></pre></div></li>
<li>
<p>关闭数据目录所在磁盘的i/o调度器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@tidb-cmb01-s3 ~<span style="color:#f92672">]</span><span style="color:#75715e"># echo noop &gt;/sys/block/sd[bc]/queue/scheduler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@tidb-cmb01-s3 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat /sys/block/sd[bc]/queue/scheduler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>noop<span style="color:#f92672">]</span> deadline cfq 
</span></span></code></pre></div></li>
<li>
<p>挂载磁盘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> mkfs.ext4 /dev/mapper/data-tidb 
</span></span><span style="display:flex;"><span> mount -o noatime -o nodelalloc -t ext4 /dev/mapper/data-tidb /data/
</span></span><span style="display:flex;"><span> mkdir -p /data/cluster01
</span></span><span style="display:flex;"><span> chown -R tidb:tidb /data/cluster01
</span></span></code></pre></div></li>
</ul>

    </div>
</div>

<p><strong>安装tiup工具</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl --proto <span style="color:#e6db74">&#39;=https&#39;</span> --tlsv1.2 -sSf https://tiup-mirrors.pingcap.com/install.sh | sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>source /root/.bash_profile
</span></span></code></pre></div><p><strong>下载离线镜像</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>version<span style="color:#f92672">=</span>v5.2.4
</span></span><span style="display:flex;"><span><span style="color:#75715e">#version=v6.5.12</span>
</span></span><span style="display:flex;"><span>wget https://download.pingcap.org/tidb-community-server-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar xf tidb-community-server-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-amd64.tar.gz
</span></span></code></pre></div><p><strong>设置本地镜像仓库</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tiup mirror set tidb-community-server-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-amd64
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 验证设置是否成功</span>
</span></span><span style="display:flex;"><span>tiup mirror show
</span></span></code></pre></div><p><strong>配置部署文件</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 通过该命令获取基础配置文件 </span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">tiup cluster template &gt; /tmp/topology.yaml</span>
</span></span></code></pre></div><p>检查配置文件语法和集群依赖</p>
<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">user</span>: <span style="color:#e6db74">&#34;root&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ssh_port</span>: <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">arch</span>: <span style="color:#e6db74">&#34;amd64&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">monitored</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">node_exporter_port</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">blackbox_exporter_port</span>: <span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">server_configs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pd</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replication.location-labels</span>: [<span style="color:#e6db74">&#34;host&#34;</span>, <span style="color:#e6db74">&#34;disk&#34;</span>]
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">pd_servers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">client_port</span>: <span style="color:#ae81ff">2379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">peer_port</span>: <span style="color:#ae81ff">2380</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/pd-2379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data/pd-2379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/pd-2379/log&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">client_port</span>: <span style="color:#ae81ff">3379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">peer_port</span>: <span style="color:#ae81ff">3380</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/pd-3379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data/pd-3379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/pd-3379/log&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">client_port</span>: <span style="color:#ae81ff">4379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">peer_port</span>: <span style="color:#ae81ff">4380</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/pd-4379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data/pd-4379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/pd-4379/log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">tidb_servers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">4000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">status_port</span>: <span style="color:#ae81ff">10080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tidb-4000&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tidb-4000/log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">tikv_servers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">20160</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">status_port</span>: <span style="color:#ae81ff">20180</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tikv-20160&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data/tikv-20160&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tikv-20160/log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server.labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">tikv1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">disk</span>: <span style="color:#ae81ff">disk1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">20161</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">status_port</span>: <span style="color:#ae81ff">20181</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tikv-20161&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data/tikv-20161&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tikv-20161/log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server.labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">tikv2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">disk</span>: <span style="color:#ae81ff">disk2</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.115</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">20162</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">status_port</span>: <span style="color:#ae81ff">20182</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tikv-20162&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_dir</span>: <span style="color:#e6db74">&#34;/tidb-data/tikv-20162&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">log_dir</span>: <span style="color:#e6db74">&#34;/tidb-deploy/tikv-20162/log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server.labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">tikv3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">disk</span>: <span style="color:#ae81ff">disk3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">monitoring_servers</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.0.114</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9090</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ng_port</span>: <span style="color:#ae81ff">12020</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">deploy_dir</span>: <span style="color:#ae81ff">/tidb-deploy/prometheus-9090</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">data_dir</span>: <span style="color:#ae81ff">/tidb-data/prometheus-9090</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">log_dir</span>: <span style="color:#ae81ff">/tidb-deploy/prometheus-9090/log</span>
</span></span></code></pre></div></details>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tiup cluster check /tmp/topology.yaml --user root -p
</span></span><span style="display:flex;"><span>tiup cluster check /tmp/topology.yaml --apply --user root -p
</span></span></code></pre></div><p><strong>部署集群</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tiup cluster deploy cluster01 v5.2.4 /tmp/topology.yaml --user root -p
</span></span></code></pre></div><p><strong>启动集群</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>tidb@tidb-dev01-s2 ~<span style="color:#f92672">]</span>$ tiup cluster start cluster01 --init
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Started cluster <span style="color:#e6db74">`</span>cluster01<span style="color:#e6db74">`</span> successfully
</span></span><span style="display:flex;"><span>The root password of TiDB database has been changed.
</span></span><span style="display:flex;"><span>The new password is: <span style="color:#e6db74">&#39;jS7y!61*gz8MUZ50_%&#39;</span>.
</span></span><span style="display:flex;"><span>Copy and record it to somewhere safe, it is only displayed once, and will not be stored.
</span></span><span style="display:flex;"><span>The generated password can NOT be get and shown again.
</span></span></code></pre></div><p><strong>查看tiup管理的集群</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tiup cluster list 
</span></span><span style="display:flex;"><span>tiup cluster display cluster01
</span></span></code></pre></div><p><strong>验证功能</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -P <span style="color:#ae81ff">4000</span> -uroot -p<span style="color:#e6db74">&#39;jS7y!61*gz8MUZ50_%&#39;</span> -h 127.0.0.1
</span></span></code></pre></div><p><strong>dashboar:</strong> <code>http://192.168.0.115:3379/dashboard</code></p>
<p>默认用户： <code>root</code></p>
<p>默认密码： <code>jS7y!61*gz8MUZ50_%</code></p>
<p><strong>销毁集群</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tiup cluster stop cluster01
</span></span><span style="display:flex;"><span>tiup cluster destroy cluster01
</span></span></code></pre></div><h3 id="数据备份">数据备份</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tiup install br:v6.5.12
</span></span></code></pre></div><h3 id="数据迁移">数据迁移</h3>
<p><a href="https://docs.pingcap.com/zh/tidb/stable/migration-overview/" target="_blank">数据迁移概述 | TiDB 文档中心</a></p>
<h3 id="数据同步">数据同步</h3>
<p><a href="https://docs.pingcap.com/zh/tidb/stable/ticdc-overview/" target="_blank">数据同步概述 | TiDB 文档中心</a></p>
<h3 id="tidb工具链">tidb工具链</h3>
<p><a href="https://docs.pingcap.com/zh/tidb/stable/ecosystem-tool-user-guide/" target="_blank">TiDB 工具功能概览 | TiDB 文档中心</a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-187ec7198335d617c91d9604a38255b3">tiup工具</h1>
	<div class="lead">tiup|tidb</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-20" class="text-body-secondary">Tuesday, May 20, 2025</time>
        
	</div>
	<p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tidb-architecture-v6.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查看集群列表</span>
</span></span><span style="display:flex;"><span>tiup cluster list
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看集群每个组件的运行状态</span>
</span></span><span style="display:flex;"><span>tiup cluster display &lt;cluster-name&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动集群</span>
</span></span><span style="display:flex;"><span>tiup cluster start &lt;cluster-name&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -R 启动指定组件</span>
</span></span><span style="display:flex;"><span>tiup cluster start &lt;cluster-name&gt; -R pd
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -N 启动指定进程</span>
</span></span><span style="display:flex;"><span>tiup cluster start <span style="color:#e6db74">${</span>cluster-name<span style="color:#e6db74">}</span> -N 1.2.3.4:2379,1.2.3.5:2379
</span></span><span style="display:flex;"><span><span style="color:#75715e"># show-config 查看当前配置</span>
</span></span><span style="display:flex;"><span>tiup cluster show-config cluster01
</span></span><span style="display:flex;"><span><span style="color:#75715e"># edit-config 在线编辑配置</span>
</span></span><span style="display:flex;"><span>tiup cluster edit-config cluster01
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看tiup仓库</span>
</span></span><span style="display:flex;"><span>tiup mirror  show
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 默认读取变量 ${TIUP_MIRRORS} 的值</span>
</span></span><span style="display:flex;"><span>tiup mirror set 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>tiup mirror merge
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看仓库中可用的包 , 查看已安装包 tiup list --installed</span>
</span></span><span style="display:flex;"><span>tiup list
</span></span></code></pre></div><p><a href="https://docs.pingcap.com/zh/tidb/stable/maintain-tidb-using-tiup/" target="_blank">https://docs.pingcap.com/zh/tidb/stable/maintain-tidb-using-tiup/</a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-b6a1b6b4042adf75eca6f429ffbb92d1">checkssh</h1>
	<div class="lead">checkssh|tidb</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-19" class="text-body-secondary">Thursday, June 19, 2025</time>
        
	</div>
	<p><img src="https://docs-download.pingcap.com/media/images/docs-cn/tidb-architecture-v6.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e"># description: 在中控机tidb用户下，检查集群节点ssh秘钥认证</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PasswordAuthentication=no  禁用密码认证</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># StrictHostKeyChecking=no 禁用know_hosts 检查</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>declare -A info
</span></span><span style="display:flex;"><span>clusterName<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>tiup cluster list |awk <span style="color:#e6db74">&#39;NR&gt;2{print $1}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> cls in $clusterName;<span style="color:#66d9ef">do</span>  
</span></span><span style="display:flex;"><span>  iplist<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>tiup cluster display $cls|awk -F <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#e6db74">&#39;/^[0-9].*/{print $1}&#39;</span>|sort |uniq<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>  info<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;</span>$cls<span style="color:#e6db74">&#34;</span><span style="color:#f92672">]=</span>$iplist
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> cls in <span style="color:#e6db74">${</span>!info[@]<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> host in <span style="color:#e6db74">${</span>info[$cls]<span style="color:#e6db74">}</span>;<span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    rsa<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/tidbdata/tiupshare/tiuptool/storage/cluster/clusters/</span><span style="color:#e6db74">${</span>cls<span style="color:#e6db74">}</span><span style="color:#e6db74">/ssh/id_rsa&#34;</span>
</span></span><span style="display:flex;"><span>    ssh -o PasswordAuthentication<span style="color:#f92672">=</span>no -o StrictHostKeyChecking<span style="color:#f92672">=</span>no -T -i <span style="color:#e6db74">${</span>rsa<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>host<span style="color:#e6db74">}</span> exit 2&gt;/dev/null
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>       printf <span style="color:#e6db74">&#34;集群：%s,主机:%s  [OK]\n&#34;</span> $cls $host
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>       printf <span style="color:#e6db74">&#34;集群：%s,主机:%s  [Failed]\n&#34;</span> $cls $host
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">done</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>输出结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>集群：cluster01,主机:192.168.0.105  <span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>集群：cluster01,主机:192.168.0.106  <span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>集群：cluster01,主机:192.168.0.107  <span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>集群：tidb_dev_001,主机:192.168.0.223  <span style="color:#f92672">[</span>Failed<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>集群：tidb_dev_001,主机:192.168.0.224  <span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>集群：tidb_dev_001,主机:192.168.0.225  <span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>
</span></span></code></pre></div>
</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b7925a763a64b7d08f88e8b0539bd62d">7.6 - </h1>
    
	<ul>
<li><input disabled="" type="checkbox"> <a href="https://elkguide.elasticsearch.cn/" target="_blank">前言 · ELKstack 中文指南</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1ZL411k7HK/?spm_id_from=333.337.search-card.all.click&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76" target="_blank">老男孩教育倾向于运维</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1hh411D7sb/?spm_id_from=333.337.search-card.all.click&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76" target="_blank">尚硅谷讲解通过restful操作elasticsearch</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1iJ411c7Az/?spm_id_from=333.788.player.switch&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76&amp;p=7" target="_blank">07.Elasticsearch快速入门之基本概念_哔哩哔哩_bilibili</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1Zz4y1R7tq/?spm_id_from=333.337.search-card.all.click&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76" target="_blank">千锋教育ElasticSearch教程（深入讲解,一套掌握）_哔哩哔哩_bilibili</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1rG411x71e/?spm_id_from=333.337.search-card.all.click&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76" target="_blank">ElasticSearch面试50问保姆级教程入门到精通（基于ELK技术栈elasticsearch 7.17.3最新教程通俗易懂）_哔哩哔哩_bilibili</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1pY411F7QW/?spm_id_from=333.337.search-card.all.click&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76" target="_blank">马士兵教育ELK保姆级教程，从入门到精通！ElasticSearch+Logstash+Kibana精讲_哔哩哔哩_bilibili</a></li>
<li><input disabled="" type="checkbox"> <a href="https://www.bilibili.com/video/BV1Cd4y1773M/?spm_id_from=333.337.search-card.all.click&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76" target="_blank">【全网最细】耗时72小时整理的ElasticSearch教程入门到精通，让你少走99%的弯路！！_哔哩哔哩_bilibili</a></li>
</ul>
<ul>
<li>各组件兼容性： <a href="https://www.elastic.co/cn/support/matrix#matrix_compatibility" target="_blank">https://www.elastic.co/cn/support/matrix#matrix_compatibility</a></li>
<li>操作系统兼容性：https://www.elastic.co/cn/support/matrix</li>
</ul>
<p>龙腾出行公司elasticsearch版本： 7.17.3</p>
<p>日志量每天1.5TB</p>
<h3 id="面试题">面试题</h3>
<ol>
<li>使用的什么版本</li>
<li>日志量</li>
<li>遇到过哪些坑</li>
<li>elasticsearch 集群选主、数据复制原理</li>
</ol>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-3ae4dfccf1d4f425261aade622c853db">单机版本安装</h1>
	<div class="lead">使用elasticsearch</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-27" class="text-body-secondary">Saturday, September 27, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>elasticsearch版本： <code>7.15.0</code>、<code>7.17.27</code></p>
<hr>
<p>【注意事项】| <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/index.html" target="_blank">doc</a></p>
<ul>
<li>
<p>elasticsearch 依赖jdk 环境，<a href="https://www.elastic.co/cn/support/matrix#matrix_jvm" target="_blank">如果无法判断使用哪个版本jdk</a>。可以<a href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch" target="_blank">下载</a>/<a href="https://repo.huaweicloud.com" target="_blank">国内下载镜像</a>带有jdk版本的elasticsearch。</p>
</li>
<li>
<p>elasticsearch默认监听9200（提供restfull风格的服务） 和 9300 （集群内部选举和数据同步）</p>
</li>
<li>
<p>elasticsearch 属于io密集型应用，尽可能把数据目录单独挂载出来。并使用高性能磁盘。</p>
</li>
</ul>


</div>

<h3 id="部署环境准备">部署环境准备</h3>
<p><strong>内存映射</strong></p>
<blockquote>
<p>内存映射（Memory Mapping）是一种在应用程序地址空间和物理存储器之间建立映射关系的技术</p>
<p><code>max_map_count</code> 参数是用于限制每个进程能够使用的最大内存映射区域数量。</p>
<p>如果不修改，启动时提示错误： <em>max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</em></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sysctl -w vm.max_map_count<span style="color:#f92672">=</span><span style="color:#ae81ff">655360</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;vm.max_map_count=655360&#39;</span> &gt;&gt;/etc/sysctl.conf
</span></span></code></pre></div><p><strong>内存锁定</strong></p>
<blockquote>
<p><font color=red>当开启内存锁定后，以下参数必须设定</font>报错信息： <code>memory locking requested for elasticsearch process but memory is not locked</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;DefaultLimitMEMLOCK=infinity&#34;</span> &gt;&gt;/etc/systemd/system.conf
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 该命令会重启systemd 进程</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reexec
</span></span></code></pre></div><p><strong>文件描述符设置</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;&gt;/etc/security/limits.conf<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nofile 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nofile 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nproc 32000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nproc 32000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard memlock unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt;&gt; /etc/systemd/system.conf<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DefaultLimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DefaultLimitNPROC=32000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DefaultLimitMEMLOCK=infinity
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h3 id="安装部署">安装部署</h3>
<ol>
<li>
<p>创建服务账号</p>
<blockquote>
<p><font color=red>elasticsearch 无法以root用户启动</font></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>useradd  elasticsearch
</span></span></code></pre></div></li>
<li>
<p>安装elasticsearch</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>version<span style="color:#f92672">=</span>7.17.29
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>tar -xzf elasticsearch-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-linux-x86_64.tar.gz -C /data/elk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># $ES_HOME 对应/data/elk/elasticsearch</span>
</span></span><span style="display:flex;"><span>ln -svf /data/elk/<span style="color:#f92672">{</span>elasticsearch-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>,elasticsearch<span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>创建日志和数据目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /data/elk/instance1/<span style="color:#f92672">{</span>data,log,config<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>chown -R elasticsearch:elasticsearch /data/elk/<span style="color:#f92672">{</span>elasticsearch-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>,elasticsearch<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>chown -R elasticsearch:elasticsearch /data/elk/instance1
</span></span></code></pre></div></li>
<li>
<p>启动elasticsearch</p>
<blockquote>
<p><em>本示例实现单机多实例的部署，因此需要实现在配置文件、日志文件、数据文件上隔离。Elasticsearch 有三个配置文件：</em></p>
<ul>
<li><em><code>elasticsearch.yml</code>用于配置 Elasticsearch</em></li>
<li><em><code>jvm.options</code>用于配置 Elasticsearch JVM 设置</em></li>
<li><em><code>log4j2.properties</code>用于配置 Elasticsearch 日志记录</em></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grep -vE <span style="color:#e6db74">&#34;^#|^</span>$<span style="color:#e6db74">&#34;</span> /data/elk/elasticsearch/config/jvm.options &gt;/data/elk/instance1/config/jvm.options
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>grep -vE <span style="color:#e6db74">&#34;^#|^</span>$<span style="color:#e6db74">&#34;</span> /data/elk/elasticsearch/config/log4j2.properties &gt;/data/elk/instance1/config/log4j2.properties
</span></span></code></pre></div></blockquote>
<p>主配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/elk/instance1/config/elasticsearch.yml <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">path:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: /data/elk/instance1/data  # 等同path.data: /data/elk/instance1/data，其他依次类推
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  logs: /data/elk/instance1/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: node-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cluster:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: cluster-alerts
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  initial_master_nodes: [&#34;node-1&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bootstrap: 						# 是否在程序启动时立即分配指定大小内存给elasticsearch进程
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  memory_lock: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">network:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  port: 9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ingest:                        # 关闭geoip 组件下载
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  geoip:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    downloader:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p><em>systemd 管理服务</em></p>
<blockquote>
<p>测试启动命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># *命令行传参启动，在参数前添加`-E`来覆盖配置文件对应参数*</span>
</span></span><span style="display:flex;"><span>su - elasticsearch -c <span style="color:#e6db74">&#34;export ES_PATH_CONF=/data/elk/instance1/config ;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export ES_JAVA_HOME=/data/elk/elasticsearch/jdk ;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/data/elk/elasticsearch/bin/elasticsearch \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-Ehttp.port=8200&#34;</span>
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /etc/systemd/system/elasticsearch.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description= elasticsearch service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://www.elastic.co/docs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;ES_PATH_CONF=/data/elk/instance1/config&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;ES_JAVA_HOME=/data/elk/elasticsearch/jdk&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/elk/elasticsearch/bin/elasticsearch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=elasticsearch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable elasticsearch --now
</span></span><span style="display:flex;"><span>systemctl status elasticsearch
</span></span></code></pre></div></li>
<li>
<p>验证集群状态</p>
<p>通常情况下使用 <code>elasticsearch-head</code> 插件来监听elasticsearch。也可以使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.0/_cluster_health.html" target="_blank">api接口来查询</a></p>


<div class="alert alert-primary" role="alert">


    <ul>
<li>通过chrome 商店安装，需要vpn</li>
<li>通过github上提供的docker 镜像启动</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#由于前后端服务做了分离，因此需要开启elasticsearch跨域请求</span>
</span></span><span style="display:flex;"><span>http.cors.enabled: true 
</span></span><span style="display:flex;"><span>http.cors.allow-origin: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it -p9100:9100 mobz/elasticsearch-head:5-alpine
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl http://127.0.0.1:9200/_cat/nodes?v
</span></span><span style="display:flex;"><span>curl -s  http://127.0.0.1:9200/_cluster/health?pretty<span style="color:#f92672">=</span>true |jq <span style="color:#e6db74">&#34;.status&#34;</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="安全设置">安全设置</h3>
<ul>
<li>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/security-minimal-setup.html" target="_blank"><strong>开启用户认证</strong></a></p>


<div class="alert alert-warning" role="alert">


    <p>&#x26a0;&#xfe0f;</p>
<p>ERROR: [1] bootstrap checks failed. You must address the points described in the following [1] lines before starting Elasticsearch.
bootstrap check failure [1] of [1]: Transport SSL must be enabled if security is enabled on a [basic] license. Please set [xpack.security.transport.ssl.enabled] to [true] or disable security by setting [xpack.security.enabled] to [false]</p>


</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">xpack</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">security</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">transport</span>:  <span style="color:#75715e"># xpack.security.enabled 依赖xpack.security.transport.ssl.enabled 功能开启，实现在9300端口的https,而不是9200</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ssl</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>设置密码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/data/elk/elasticsearch/bin/elasticsearch-setup-passwords interactive
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@seagullcore01-uat-s2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /data/elk/elasticsearch/bin/elasticsearch-setup-passwords interactive -u  http://100.64.0.5:8200</span>
</span></span><span style="display:flex;"><span>warning: usage of JAVA_HOME is deprecated, use ES_JAVA_HOME
</span></span><span style="display:flex;"><span>Initiating the setup of passwords <span style="color:#66d9ef">for</span> reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.
</span></span><span style="display:flex;"><span>You will be prompted to enter passwords as the process progresses.
</span></span><span style="display:flex;"><span>Please confirm that you would like to <span style="color:#66d9ef">continue</span> <span style="color:#f92672">[</span>y/N<span style="color:#f92672">]</span>y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>elastic<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Reenter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>elastic<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Enter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>apm_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Reenter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>apm_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Enter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>kibana_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Reenter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>kibana_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Enter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>logstash_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Reenter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>logstash_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Enter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>beats_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Reenter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>beats_system<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Enter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>remote_monitoring_user<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Reenter password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>remote_monitoring_user<span style="color:#f92672">]</span>: 
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>apm_system<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>kibana_system<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>kibana<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>logstash_system<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>beats_system<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>remote_monitoring_user<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Changed password <span style="color:#66d9ef">for</span> user <span style="color:#f92672">[</span>elastic<span style="color:#f92672">]</span>
</span></span></code></pre></div></li>
<li>
<p><strong>开启https</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 生成ca</span>
</span></span><span style="display:flex;"><span>su - elasticsearch -c <span style="color:#e6db74">&#34;/data/elk/elasticsearch/bin/elasticsearch-certutil ca \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--out /data/elk/instance1/config/certs/ca.crt --pass mypass&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 生成公钥</span>
</span></span><span style="display:flex;"><span>su - elasticsearch -c <span style="color:#e6db74">&#34;/data/elk/elasticsearch/bin/elasticsearch-certutil cert --ca /data/elk/instance1/config/certs/ca.crt \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--out /data/elk/instance1/config/certs/server.crt --ca-pass mypass&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>xpack.security.http.ssl.enabled: true
</span></span><span style="display:flex;"><span>xpack.security.http.ssl.keystore.path: certs/server.crt
</span></span></code></pre></div></li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-2d9ddeb9ab30ddfb699011cd96663611">集群版本安装</h1>
	<div class="lead">部署集群版本elasticsearch</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-12" class="text-body-secondary">Thursday, June 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>elasticsearch版本： <code>7.15.0</code>、<code>7.17.27</code></p>
<hr>
<p>【注意事项】| <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/index.html" target="_blank">doc</a></p>
<ul>
<li>
<p>elasticsearch 依赖jdk 环境，<a href="https://www.elastic.co/cn/support/matrix#matrix_jvm" target="_blank">如果无法判断使用哪个版本jdk</a>。可以<a href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch" target="_blank">下载</a>/<a href="https://repo.huaweicloud.com" target="_blank">国内下载镜像</a>带有jdk版本的elasticsearch。</p>
</li>
<li>
<p>elasticsearch默认监听9200（提供restfull风格的服务） 和 9300 （集群内部选举和数据同步）</p>
</li>
<li>
<p>elasticsearch 属于io密集型应用，尽可能把数据目录单独挂载出来。并使用高性能磁盘。</p>
</li>
<li>
<p><font color=red>关闭防火墙、selinux、swap。并时间同步。</font></p>
</li>
</ul>


</div>

<h3 id="集群部署">集群部署</h3>
<table>
  <thead>
      <tr>
          <th>节点名称</th>
          <th>ip</th>
          <th>elasticsearch集群名</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>node-1</code></td>
          <td><code>192.168.0.151</code></td>
          <td><code>cluster-alerts</code></td>
      </tr>
      <tr>
          <td><code>node-2</code></td>
          <td><code>192.168.0.152</code></td>
          <td><code>cluster-alerts</code></td>
      </tr>
      <tr>
          <td><code>node-3</code></td>
          <td><code>192.168.0.153</code></td>
          <td><code>cluster-alerts</code></td>
      </tr>
  </tbody>
</table>

  
  
  

  

<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>集群配置文件</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="**节点一**" aria-controls="tabs-01-01" aria-selected="true">
        <strong>节点一</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="**节点二**" aria-controls="tabs-01-02" aria-selected="false">
        <strong>节点二</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="**节点三**" aria-controls="tabs-01-03" aria-selected="false">
        <strong>节点三</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/elk/instance1/config/elasticsearch.yml <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">path:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: /data/elk/instance1/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  logs: /data/elk/instance1/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: node-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  master: true                   # 节点可以是master角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: true                     # 节点可以是data角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">discovery:    # 启动时向哪些主机进行宣告，进行集群选举，集群内的主机都要填写上。包括自己
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  seed_hosts: [&#34;192.168.0.151&#34;,&#34;192.168.0.152&#34;,&#34;192.168.0.153&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cluster:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: cluster-alerts
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  initial_master_nodes: [&#34;192.168.0.151&#34;,&#34;192.168.0.152&#34;,&#34;192.168.0.153&#34;] #初始化时哪些节点可以被选举为master ，集群内的主机可以都填写上，也可以填写部分主机。支持使用 `node.name` 或者 `ip地址`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  routing:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    allocation:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cluster_concurrent_rebalance: 16         # 集群内同时启动的数据任务个数，默认是2个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_concurrent_recoveries: 16           # 添加或删除节点及负载均衡时并发恢复的线程个数，默认4个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_initial_primaries_recoveries: 16    # 初始化数据恢复时，并发恢复线程的个数，默认4个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">network:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tcp:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    keep_alive: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    no_delay: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  port: 9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  max_content_length: 200mb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  cors: # 允许跨域请求9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    allow-origin: &#34;*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gateway:               # 当集群进行数据恢复时必须大于指定数量的节点在线，才可以进行数据恢复。通常设置为 (集群节点数量/2+1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  recover_after_nodes: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">transport:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tcp:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    compress: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bootstrap: # 是否在程序启动时立即分配指定大小内存给elasticsearch进程
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  memory_lock: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ingest:             # 关闭geoip 组件下载
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  geoip:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    downloader:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/elk/instance1/config/elasticsearch.yml <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">path:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: /data/elk/instance1/data  # 等同path.data: /data/elk/instance1/data，其他依次类推
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  logs: /data/elk/instance1/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: node-2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  master: true                   # 节点可以是master角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: true                     # 节点可以是data角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">discovery:    # 启动时向哪些主机进行宣告，进行集群选举，集群内的主机都要填写上。包括自己
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  seed_hosts: [&#34;192.168.0.151&#34;,&#34;192.168.0.152&#34;,&#34;192.168.0.153&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cluster:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: cluster-alerts
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  initial_master_nodes: [&#34;192.168.0.151&#34;,&#34;192.168.0.152&#34;,&#34;192.168.0.153&#34;] #初始化时哪些节点可以被选举为master ，集群内的主机可以都填写上，也可以填写部分主机。支持使用 `node.name` 或者 `ip地址`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  routing:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    allocation:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cluster_concurrent_rebalance: 16         # 集群内同时启动的数据任务个数，默认是2个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_concurrent_recoveries: 16           # 添加或删除节点及负载均衡时并发恢复的线程个数，默认4个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_initial_primaries_recoveries: 16    # 初始化数据恢复时，并发恢复线程的个数，默认4个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">network:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tcp:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    keep_alive: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    no_delay: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  port: 9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  max_content_length: 200mb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  cors: # 允许跨域请求9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    allow-origin: &#34;*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gateway:               # 当集群进行数据恢复时必须大于指定数量的节点在线，才可以进行数据恢复。通常设置为 (集群节点数量/2+1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  recover_after_nodes: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">transport:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tcp:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    compress: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bootstrap: # 是否在程序启动时立即分配指定大小内存给elasticsearch进程
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  memory_lock: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ingest:             # 关闭geoip 组件下载
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  geoip:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    downloader:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/elk/instance1/config/elasticsearch.yml <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">path:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: /data/elk/instance1/data  # 等同path.data: /data/elk/instance1/data，其他依次类推
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  logs: /data/elk/instance1/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: node-3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  master: true                   # 节点可以是master角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  data: true                     # 节点可以是data角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">discovery:    # 启动时向哪些主机进行宣告，进行集群选举，集群内的主机都要填写上。包括自己
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  seed_hosts: [&#34;192.168.0.151&#34;,&#34;192.168.0.152&#34;,&#34;192.168.0.153&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cluster:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: cluster-alerts
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  initial_master_nodes: [&#34;192.168.0.151&#34;,&#34;192.168.0.152&#34;,&#34;192.168.0.153&#34;] #初始化时哪些节点可以被选举为master ，集群内的主机可以都填写上，也可以填写部分主机。支持使用 `node.name` 或者 `ip地址`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  routing:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    allocation:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cluster_concurrent_rebalance: 16         # 集群内同时启动的数据任务个数，默认是2个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_concurrent_recoveries: 16           # 添加或删除节点及负载均衡时并发恢复的线程个数，默认4个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_initial_primaries_recoveries: 16    # 初始化数据恢复时，并发恢复线程的个数，默认4个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">network:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tcp:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    keep_alive: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    no_delay: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  port: 9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  max_content_length: 200mb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  cors: # 允许跨域请求9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    allow-origin: &#34;*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gateway:               # 当集群进行数据恢复时必须大于指定数量的节点在线，才可以进行数据恢复。通常设置为 (集群节点数量/2+1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  recover_after_nodes: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">transport:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tcp:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    compress: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bootstrap: # 是否在程序启动时立即分配指定大小内存给elasticsearch进程
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  memory_lock: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ingest:             # 关闭geoip 组件下载
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  geoip:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    downloader:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>
    </div>
</div>

<p>如果可以查看到node信息，则集群节点创建成功</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/_cat/nodes
</span></span></code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">集群选举失败</h4>

    <hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Nov <span style="color:#ae81ff">25</span> 16: 12: <span style="color:#ae81ff">10</span> node-2 elasticsearch<span style="color:#f92672">[</span>8964<span style="color:#f92672">]</span>: <span style="color:#f92672">[</span>2025-11-25T16: 12: 10,131<span style="color:#f92672">][</span>WARN<span style="color:#f92672">][</span>o.e.c.c.ClusterFormationFailureHelper<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>node-2<span style="color:#f92672">]</span> master not discovered or elected yet, an election requires at least <span style="color:#ae81ff">2</span> nodes with ids from <span style="color:#f92672">[</span>VBlfeDBuQ0aKmj6sXYYDCA, YqHqBfh_TtSeyx8ToGC7cA, lsEs2XMTTRmteL7yxEiuOg<span style="color:#f92672">]</span>, have only discovered non-quorum <span style="color:#f92672">[{</span>node-2<span style="color:#f92672">}{</span>YqHqBfh_TtSeyx8ToGC7cA<span style="color:#f92672">}{</span>qOajkkUJQH6ks4hwaZ02Lw<span style="color:#f92672">}{</span>192.168.0.152<span style="color:#f92672">}{</span>192.168.0.152: 9300<span style="color:#f92672">}{</span>cdfhilmrstw<span style="color:#f92672">}]</span>; discovery will <span style="color:#66d9ef">continue</span> using <span style="color:#f92672">[</span>192.168.0.151: 9300,192.168.0.153: 9300<span style="color:#f92672">]</span> from hosts providers and <span style="color:#f92672">[{</span>node-2<span style="color:#f92672">}{</span>YqHqBfh_TtSeyx8ToGC7cA<span style="color:#f92672">}{</span>qOajkkUJQH6ks4hwaZ02Lw<span style="color:#f92672">}{</span>192.168.0.152<span style="color:#f92672">}{</span>192.168.0.152: 9300<span style="color:#f92672">}{</span>cdfhilmrstw<span style="color:#f92672">}]</span> from last-known cluster state; node term 4, last-accepted version <span style="color:#ae81ff">1272</span> in term <span style="color:#ae81ff">4</span>
</span></span></code></pre></div><hr>
<p>解决方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  检查9300集群通讯端口是否互访正常。例如<span style="color:#e6db74">`</span>telnet 192.168.0.152 9300<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>  关闭selinux 和 firewalld
</span></span></code></pre></div>

</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-0211872ddd3d7ac997b074513c5e8671">配置文件</h1>
	<div class="lead">elasticsearch支持restfull 方式的CRUD</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-12" class="text-body-secondary">Thursday, June 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">


    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>elasticsearch版本： <code>7.15.0</code>、<code>7.17.27</code></p>
<hr>
<p><strong>elasticsearch 包含三个主要的配置:</strong></p>
<p>大多数配置可以在运行时通过<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-update-settings.html" target="_blank">api</a>热修改，配置文件默认在<code>$ES_HOME/config</code> 目录下，可以通过变量 <code>export ES_PATH_CONF=/path/to/my/config</code> 自定义配置文件的路径</p>
<ul>
<li><code>elasticsearch.yml</code>用于配置 Elasticsearch</li>
<li><code>jvm.options</code>用于配置 Elasticsearch JVM</li>
<li><code>log4j2.properties</code>用于配置 Elasticsearch 日志记录</li>
</ul>


</div>

<p>集群管理</p>
<p>节点管理</p>
<p>数据和日志路径管理</p>
<p>内存管理</p>
<p>网络管理</p>
<p>自动发现</p>
<p><strong>数据/日志目录配置</strong></p>


  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="yaml" aria-controls="tabs-01-00" aria-selected="true">
        yaml
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="yaml扁平格式" aria-controls="tabs-01-01" aria-selected="false">
        yaml扁平格式
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">path</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">data</span>: <span style="color:#ae81ff">/data/elk/instance1/data</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">logs</span>: <span style="color:#ae81ff">/data/elk/instance1/log</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">path.data</span>: <span style="color:#ae81ff">/data/elk/instance1/data</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">path.logs</span>: <span style="color:#ae81ff">/data/elk/instance1/log</span>
</span></span></code></pre></div>
    </div>
</div>

<p><strong>集群名称</strong> 不同的集群用名字来区分，配置成相同集群名字的各个节点形成一个集群</p>


  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          data-td-tp-persist="yaml" aria-controls="tabs-02-00" aria-selected="true">
        yaml
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="yaml扁平格式" aria-controls="tabs-02-01" aria-selected="false">
        yaml扁平格式
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-alerts</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">cluster.name</span>: <span style="color:#ae81ff">cluster-alerts</span>
</span></span></code></pre></div>
    </div>
</div>

<p><strong>节点名称</strong> 可以不定义此参数，这时，Elasticsearch自动选择一个唯一的名称</p>


  
  
<ul class="nav nav-tabs" id="tabs-3" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-03-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-00" role="tab"
          data-td-tp-persist="yaml" aria-controls="tabs-03-00" aria-selected="true">
        yaml
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-03-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-03-01" role="tab"
          data-td-tp-persist="yaml扁平格式" aria-controls="tabs-03-01" aria-selected="false">
        yaml扁平格式
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-3-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-03-00" role="tabpanel" aria-labelled-by="tabs-03-00-tab" tabindex="3">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">node</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">node-1</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-03-01" role="tabpanel" aria-labelled-by="tabs-03-01-tab" tabindex="3">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">node.name</span>: <span style="color:#ae81ff">node-1</span>
</span></span></code></pre></div>
    </div>
</div>

<p><strong>网络设置</strong></p>


  
  
<ul class="nav nav-tabs" id="tabs-4" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-04-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-04-00" role="tab"
          data-td-tp-persist="yaml" aria-controls="tabs-04-00" aria-selected="true">
        yaml
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-04-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-04-01" role="tab"
          data-td-tp-persist="yaml扁平格式" aria-controls="tabs-04-01" aria-selected="false">
        yaml扁平格式
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-4-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-04-00" role="tabpanel" aria-labelled-by="tabs-04-00-tab" tabindex="4">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">network</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host</span>: <span style="color:#ae81ff">0.0.0.0</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-04-01" role="tabpanel" aria-labelled-by="tabs-04-01-tab" tabindex="4">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">network.host</span>: <span style="color:#ae81ff">0.0.0.0</span>
</span></span></code></pre></div>
    </div>
</div>

<p><strong>自动创建索引</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 关闭自动创建索引，默认为true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">action.auto_create_index</span>: <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 允许自动创建a开头但不能是an开头的索引</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">action.auto_create_index</span>: -<span style="color:#ae81ff">an*,+a,-*</span>
</span></span></code></pre></div><p><strong>跨域请求</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#由于前后端服务做了分离，因此需要开启elasticsearch跨域请求</span>
</span></span><span style="display:flex;"><span>http.cors.enabled: true 
</span></span><span style="display:flex;"><span>http.cors.allow-origin: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@node-1 bin<span style="color:#f92672">]</span><span style="color:#75715e"># /data/elk/elasticsearch/bin/elasticsearch-plugin  install https://get.infini.cloud/elasticsearch/analysis-ik/7.17.29</span>
</span></span><span style="display:flex;"><span>-&gt; Installing https://get.infini.cloud/elasticsearch/analysis-ik/7.17.29
</span></span><span style="display:flex;"><span>-&gt; Downloading https://get.infini.cloud/elasticsearch/analysis-ik/7.17.29
</span></span><span style="display:flex;"><span>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span></span><span style="display:flex;"><span>@     WARNING: plugin requires additional permissions     @
</span></span><span style="display:flex;"><span>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span></span><span style="display:flex;"><span>* java.net.SocketPermission * connect,resolve
</span></span><span style="display:flex;"><span>See https://docs.oracle.com/javase/8/docs/technotes/guides/security/permissions.html
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> descriptions of what these permissions allow and the associated risks.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Continue with installation? <span style="color:#f92672">[</span>y/N<span style="color:#f92672">]</span>y
</span></span><span style="display:flex;"><span>-&gt; Installed analysis-ik
</span></span><span style="display:flex;"><span>-&gt; Please restart Elasticsearch to activate any plugins installed
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -XPOST http://192.168.0.151:9200/_analyze <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;analyzer&#34;: &#34;ik_max_word&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;text&#34;: &#34;千锋教育&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>su - elasticsearch -c <span style="color:#e6db74">&#34;export ES_PATH_CONF=/data/elk/instance1/config ;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export ES_JAVA_HOME=/data/elk/elasticsearch/jdk ;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/data/elk/elasticsearch/bin/elasticsearch-plugin list &#34;</span>
</span></span></code></pre></div><h3 id="mapping">mapping</h3>

  
  
<ul class="nav nav-tabs" id="tabs-5" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-05-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-00" role="tab"
          data-td-tp-persist="**定义索引分片和副本数量**" aria-controls="tabs-05-00" aria-selected="true">
        <strong>定义索引分片和副本数量</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-05-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-01" role="tab"
          data-td-tp-persist="**定义数据类型**" aria-controls="tabs-05-01" aria-selected="false">
        <strong>定义数据类型</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-5-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-05-00" role="tabpanel" aria-labelled-by="tabs-05-00-tab" tabindex="5">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;settings&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;number_of_shards&#34;</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;number_of_replicas&#34;</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-05-01" role="tabpanel" aria-labelled-by="tabs-05-01-tab" tabindex="5">
        <p>支持的数据类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;mappings&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;name&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;index&#34;</span>: <span style="color:#66d9ef">false</span>  <span style="color:#75715e">// false 表示不创建索引不支持查询
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;value&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;integer&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;describe&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;text&#34;</span>, <span style="color:#75715e">// 支持分词检索
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">&#34;fields&#34;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;keyword&#34;</span>: { <span style="color:#75715e">// 保留原始值，用于聚合/排序/精确查询
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&#34;ignore_above&#34;</span>: <span style="color:#ae81ff">256</span> <span style="color:#75715e">// 长度超限就忽略，防止膨胀
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
</div>

<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X PUT 127.0.0.1:9200/alerts <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -d<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;mappings&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;properties&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;name&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;type&#34;: &#34;keyword&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;index&#34;: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;value&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;type&#34;: &#34;integer&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;describe&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;type&#34;: &#34;text&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;fields&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    &#34;keyword&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;type&#34;: &#34;keyword&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;ignore_above&#34;: 256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;settings&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;number_of_shards&#34;: 1,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;number_of_replicas&#34;: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><p>示例：动态调整分片的副本数量</p>
<blockquote>
<p>分片数量创建后不可以调整除非删除重建索引。副本数量可以动态调整</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X PUT 127.0.0.1:9200/alerts/_settings <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -d<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;number_of_replicas&#34; : 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }&#39;</span>
</span></span></code></pre></div><h3 id="index-template">index template</h3>
<p>分片数量在index创建后不能调整，一旦创建好索引，更改分片数量的唯一途径就是创建另一个索引并重新索引数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -XGET http://192.168.0.151:9200/_cluster/state/nodes/
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cluster_name&#34;</span>: <span style="color:#e6db74">&#34;cluster-alerts&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cluster_uuid&#34;</span>: <span style="color:#e6db74">&#34;sel1D22xQzWTiq_vZYiGow&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;nodes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;KrYRJaO-Qwq0FmnCETRnrw&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;node-3&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;ephemeral_id&#34;</span>: <span style="color:#e6db74">&#34;gOriln-aRNWmGg_6JdwkRA&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;transport_address&#34;</span>: <span style="color:#e6db74">&#34;192.168.0.153:9300&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.machine_memory&#34;</span>: <span style="color:#e6db74">&#34;8182120448&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.max_open_jobs&#34;</span>: <span style="color:#e6db74">&#34;512&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;xpack.installed&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.max_jvm_size&#34;</span>: <span style="color:#e6db74">&#34;1073741824&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;transform.node&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;roles&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_cold&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_content&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_frozen&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_hot&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_warm&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ingest&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;master&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;remote_cluster_client&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;transform&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;j1aQHoGtSGORdRYqSrosIQ&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;node-2&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;ephemeral_id&#34;</span>: <span style="color:#e6db74">&#34;bDT3W7RzTVyvXbRfbznVvQ&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;transport_address&#34;</span>: <span style="color:#e6db74">&#34;192.168.0.152:9300&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.machine_memory&#34;</span>: <span style="color:#e6db74">&#34;8182112256&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.max_open_jobs&#34;</span>: <span style="color:#e6db74">&#34;512&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;xpack.installed&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.max_jvm_size&#34;</span>: <span style="color:#e6db74">&#34;1073741824&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;transform.node&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;roles&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_cold&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_content&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_frozen&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_hot&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_warm&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ingest&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;master&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;remote_cluster_client&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;transform&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;28LwCUt0RmqDo0zSbmo8cg&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;node-1&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;ephemeral_id&#34;</span>: <span style="color:#e6db74">&#34;D8-vfrz0SY6uHru_WC84Dg&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;transport_address&#34;</span>: <span style="color:#e6db74">&#34;192.168.0.151:9300&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.machine_memory&#34;</span>: <span style="color:#e6db74">&#34;8182120448&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;xpack.installed&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;transform.node&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.max_open_jobs&#34;</span>: <span style="color:#e6db74">&#34;512&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml.max_jvm_size&#34;</span>: <span style="color:#e6db74">&#34;1073741824&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;roles&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_cold&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_content&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_frozen&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_hot&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data_warm&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ingest&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;master&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ml&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;remote_cluster_client&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;transform&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>&#x2753; 主节点和工作节点，主节点承担了什么任务，通过哪种协议选举出的主节点</p>
<ol>
<li>分片数量不超过节点熟练的3倍</li>
<li>内存分配不超过操作系统的50%，但最大不超过32GB</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -XPUT http://192.168.0.151:9200/a/_settings <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;settings&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;index.unassigned.node_left.delayed_timeout&#34;: &#34;5m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-2457b5f6d965f967eb0a2d2d273f1823">RestfullAPI</h1>
	<div class="lead">elasticsearch支持restfull 方式的CRUD</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-12" class="text-body-secondary">Thursday, June 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">


    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>elasticsearch版本： <code>7.15.0</code>、<code>7.17.27</code></p>


</div>

<h3 id="概念">概念</h3>
<p>Elasticsearch 是一个分布式文档存储，使用一种全文搜索的倒排索引，倒排索引列出任何文档中出现的每个唯一单词，并标识所有 每个单词都出现在文档中。</p>
<p>索引可以被认为是文档的集合，每个文档 document 是字段的集合</p>
<p>默认情况下，Elasticsearch 会索引每个字段和每个索引中的所有数据字段具有专用的、优化的数据结构。例如，文本字段是存储在倒排索引中，数字和地理字段存储在 BKD 树中。</p>
<ul>
<li>
<p>Lucene 是 Apache 软件基金会下的一个「<strong>纯 Java 编写的开源全文检索引擎库</strong>」。
它本身不是一套完整的搜索服务器，而是一组「<strong>jar 包</strong>」：你的应用把 Lucene 的代码直接引入，就能在 JVM 进程里完成倒排索引的构建、分词、打分、查询、高亮、拼写检查等全部搜索相关功能。换句话说，Lucene 是「<strong>搜索引擎的内核</strong>」。</p>
</li>
<li>
<p>Elasticsearch 是对Lucene 的封装,在Lucene功能的基础上实现了数据分片、副本、REST API、聚合、SQL、安全、监控等。</p>
</li>
<li>
<p>Index（索引）物理上就是一组 Segment 文件，内部采用「倒排索引」结构，保证关键词 → 文档列表的快速映射。</p>
</li>
<li>
<p>Document（文档）一条可被搜索的业务数据，由多个 Field 组成，等价于 ES 里的一条 JSON 记录。</p>
</li>
</ul>
<h3 id="index操作">index操作</h3>
<ul>
<li>
<p>创建索引<code>alerts</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># curl -X PUT 127.0.0.1:9200/alerts</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X PUT 127.0.0.1:9200/alerts <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -d<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;mappings&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;properties&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;name&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;type&#34;: &#34;keyword&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;value&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;type&#34;: &#34;integer&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;describe&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;type&#34;: &#34;text&#34;,               // 支持分词检索
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;fields&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;keyword&#34;: {                // 保留原始值，用于聚合/排序/精确查询
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;type&#34;: &#34;keyword&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;ignore_above&#34;: 256       // 长度超限就忽略，防止膨胀
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>列出所有索引</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X GET 127.0.0.1:9200/_cat/indices
</span></span></code></pre></div></li>
<li>
<p>列出索引<code>alerts</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X GET 127.0.0.1:9200/alerts?pretty
</span></span></code></pre></div></li>
<li>
<p>删除索引<code>alerts</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X DELETE 127.0.0.1:9200/alerts
</span></span></code></pre></div></li>
</ul>
<h3 id="document操作">document操作</h3>
<ul>
<li>
<p>写入一条数据</p>
<blockquote>
<p>格式： <code>127.0.0.1:9200/{索引名称}/{文档类型}/{文档id}</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST 127.0.0.1:9200/alerts/_doc/1001 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&#34;name&#34;: &#34;MemHigh&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&#34;value&#34;: &#34;80&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&#34;describe&#34;: &#34;instance [node-1] memory high,please recheck&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>写入多条数据</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST 127.0.0.1:9200/alerts/_bulk <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/x-ndjson&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -d<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{ &#34;index&#34; : { &#34;_index&#34; : &#34;alerts&#34;, &#34;_id&#34; : &#34;1002&#34; } }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{ &#34;name&#34; : &#34;MemHigh&#34;, &#34;value&#34; : 85 ,&#34;describe&#34; : &#34;instance [node-2] memory high,please recheck[cpu/diskio/memory]&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{ &#34;index&#34; : { &#34;_index&#34; : &#34;alerts&#34;, &#34;_id&#34; : &#34;1003&#34; } }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{ &#34;name&#34; : &#34;CpuHigh&#34;, &#34;value&#34; : 95 ,&#34;describe&#34; : &#34;instance [node-3] cpu high,please recheck[cpu/diskio/memory]&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>               <span style="color:#75715e"># ← 这里隐含 \n，确保最后有空行</span>
</span></span></code></pre></div></li>
<li>
<p>查看数据</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_doc/1001?pretty
</span></span></code></pre></div>

    

    

    

    
    

    

    

  <ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="*查找所有文档*" aria-controls="tabs-01-00" aria-selected="true">
        <em>查找所有文档</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="*分页显示*和排序" aria-controls="tabs-01-01" aria-selected="false">
        <em>分页显示</em>和排序
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="*仅展示指定字段*" aria-controls="tabs-01-02" aria-selected="false">
        <em>仅展示指定字段</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="*范围查找*" aria-controls="tabs-01-03" aria-selected="false">
        <em>范围查找</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-04" role="tab"
          data-td-tp-persist="*关键字查找和高亮显示*" aria-controls="tabs-01-04" aria-selected="false">
        <em>关键字查找和高亮显示</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-05-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-05" role="tab"
          data-td-tp-persist="*全文匹配*" aria-controls="tabs-01-05" aria-selected="false">
        <em>全文匹配</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-06-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-06" role="tab"
          data-td-tp-persist="*聚合查询*" aria-controls="tabs-01-06" aria-selected="false">
        <em>聚合查询</em>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;match_all&#34;: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;match_all&#34;: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;from&#34;: 0,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;match_all&#34;: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;from&#34;: 0,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;sort&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;value&#34;: {&#34;order&#34;:&#34;desc&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;match_all&#34;: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;from&#34;: 0,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;sort&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;value&#34;: {&#34;order&#34;:&#34;desc&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;_source&#34;: [&#34;name&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;range&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;value&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;gte&#34;: 85,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;lt&#34;: 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-04" role="tabpanel" aria-labelled-by="tabs-01-04-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查找 name=&#34;MemHigh&#34;</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;name&#34;: &#34;MemHigh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 多条件查找，name=&#34;MemHigh&#34; and value=85</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;bool&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;must&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;name&#34;: &#34;MemHigh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;value&#34;: &#34;85&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 高亮显示name字段值。适用于keyword类型字段</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;bool&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;must&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;name&#34;: &#34;MemHigh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;value&#34;: &#34;85&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;highlight&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;fields&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;name&#34;: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-05" role="tabpanel" aria-labelled-by="tabs-01-05-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># match 分词后不考虑`cpu` `High` 分词的顺序只要出现过的都会匹配到</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;describe&#34;:&#34;cpu High&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># match_phrase 分词后考虑`cpu` `High` 分词的顺序，只有完全符合的会匹配到</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;match_phrase&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;describe&#34;:&#34;cpu  High&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-06" role="tabpanel" aria-labelled-by="tabs-01-06-tab" tabindex="1">
        <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" target="_blank">文档参考</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 按照name 聚合计数</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;count_high&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;terms&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             &#34;field&#34;: &#34;name&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 求内存告警中最大值,类推 max / min / avg / sum</span>
</span></span><span style="display:flex;"><span>curl 127.0.0.1:9200/alerts/_search?pretty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;name&#34;:&#34;MemHigh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;mem_max&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;max&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             &#34;field&#34;: &#34;value&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;_source&#34;: false // 不显示原始数据
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
</div>

</li>
<li>
<p>修改数据</p>


    
    
  <ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          data-td-tp-persist="*全量覆盖1001*" aria-controls="tabs-02-00" aria-selected="true">
        <em>全量覆盖1001</em>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="*更新其中某些字段*" aria-controls="tabs-02-01" aria-selected="false">
        <em>更新其中某些字段</em>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X PUT 127.0.0.1:9200/alerts/_doc/1001 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&#34;name&#34;: &#34;MemHigh&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&#34;value&#34;: &#34;80&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST 127.0.0.1:9200/alerts/_update/1001 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -d<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;doc&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;value&#34;: &#34;88&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>
</span></span></code></pre></div>
    </div>
</div>

</li>
</ul>

</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6be196ad1a32509a6c7bc2a224b2a9e3">7.7 - </h1>
    
	<p><img src="https://pic2.zhimg.com/v2-d4bcfceda6ff7e56c16d2191b8d45ee9_r.jpg" alt="img"></p>
<h3></h3>
<table>
  <thead>
      <tr>
          <th>java版本</th>
          <th>zookeeper版本</th>
          <th>kafka版本</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>java8</td>
          <td></td>
          <td>0.7 至 3.0</td>
      </tr>
      <tr>
          <td>java11</td>
          <td></td>
          <td>0.7 至 3.7</td>
      </tr>
      <tr>
          <td>java17</td>
          <td></td>
          <td>0.7 至</td>
      </tr>
  </tbody>
</table>
<p><a href="https://www.bilibili.com/video/BV1a4411B7V9?spm_id_from=333.788.player.switch&amp;vd_source=a2dcea2da941e76b21b56f2b3cd2fc76&amp;p=6" target="_blank">尚硅谷_Kafka入门_</a></p>
<p>kafka可视化管理和监控工具<a href="https://www.kafka-eagle.org/" target="_blank">EFAK</a>，同样是使用jmx抓取数据</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-4fd1811155c0b30c4801ab6b3f671eaf">部署zookeeper</h1>
	<div class="lead"><em>如何快速启动一个zookeeper服务</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-12" class="text-body-secondary">Friday, September 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code> 支持jdk1.8</p>
<p>kafka版本：<code>3.3.2</code></p>
<p>zookeeper可视化工具: <a href="https://github.com/vran-dev/PrettyZoo?tab=readme-ov-file" target="_blank">PrettyZoo</a></p>
<hr>
<p><em>通常多个kafka集群通过chroot的方式使用同一个zookeer集群。在Kafka 0.9.0.0 版本之前，除了 broker 之外，消费者也会使用 Zookeeper 来保存一些信息，比如消费者群组的信息、主题信息、消费分区的偏移量</em></p>


</div>

<h3 id="安装部署">安装部署</h3>
<p><strong>安装依赖</strong></p>
<ul>
<li>
<p>jdk</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://download.java.net/java/ga/jdk11/openjdk-11_linux-x64_bin.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf openjdk-11_linux-x64_bin.tar.gz -C /opt
</span></span><span style="display:flex;"><span>ln -svf  /opt/<span style="color:#f92672">{</span>jdk-11,jdk<span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat&gt;&gt;/etc/profile<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/opt/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_JRE=$JAVA_HOME/jre
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=$JAVA_HOME/lib:$JAVA_HOME/jre/lib
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=$JAVA_HOME/bin:$JAVA_JRE/bin:$PATH:.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>source /etc/profile
</span></span><span style="display:flex;"><span>java -version
</span></span></code></pre></div></li>
</ul>
<p><strong>部署安装</strong></p>
<ul>
<li>
<p>下载软件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://archive.apache.org/dist/zookeeper/zookeeper-3.4.14/zookeeper-3.4.14.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf zookeeper-3.4.14.tar.gz -C /opt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ln -sv /opt/<span style="color:#f92672">{</span>zookeeper-3.4.14,zookeeper<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p /opt/zookeeper/<span style="color:#f92672">{</span>data,logs<span style="color:#f92672">}</span> 
</span></span></code></pre></div></li>
<li>
<p>修改配置文件</p>

    
    
    
  <ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>配置zookeeper</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="**单节点配置**" aria-controls="tabs-01-01" aria-selected="true">
        <strong>单节点配置</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="**集群配置**" aria-controls="tabs-01-02" aria-selected="false">
        <strong>集群配置</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /opt/zookeeper/conf/zoo.cfg<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 集群成员间每隔2000毫秒检查一下集群心跳 2s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tickTime=2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># follower 初次连接leader 的tick次数。例如 10 * 2000 =20s ,follower要在20s内连接上leader 否则被视为超时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">initLimit=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># follower 与leader通讯的tick 次数。例如 5*2000=10s,follower要在10s内与leader完成通讯，否则被视为超时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">syncLimit=5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># zookeeper 会定期在内存中生成快照，并定义把快照内容写入 dataDir
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dataDir=/opt/zookeeper/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dataLogDir=/opt/zookeeper/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2181 用于接受客户端连接的主要端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clientPort=2181
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /opt/zookeeper/conf/zoo.cfg<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 集群成员间每隔2000毫秒检查一下集群心跳 2s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tickTime=2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># follower 初次连接leader 的tick次数。例如 10 * 2000 =20s ,follower要在20s内连接上leader 否则被视为超时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">initLimit=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># follower 与leader通讯的tick 次数。例如 5*2000=10s,follower要在10s内与leader完成通讯，否则被视为超时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">syncLimit=5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># zookeeper 会定期在内存中生成快照，并定义把快照内容写入 dataDir
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dataDir=/opt/zookeeper/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dataLogDir=/opt/zookeeper/logs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2181 用于接受客户端连接的主要端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clientPort=2181
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2888 用于 ZooKeeper 集群内节点从leader同步数据，只有leader才监听该端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3888 用于 ZooKeeper 集群中的 Leader 选举过程中节点之间的通信
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># server.X=host:port:port 这里的X（1～255）必须是一个全局唯一的数字，且需要与 myid文件中的数字相对应
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server.1=node-1:2888:3888
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server.2=node-2:2888:3888
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server.3=node-3:2888:3888
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 为每个节点分配id，在dataDir下myid文件中</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># node-1</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;1&#34;</span> &gt;/opt/zookeeper/data/myid
</span></span><span style="display:flex;"><span><span style="color:#75715e"># node-2</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;2&#34;</span> &gt;/opt/zookeeper/data/myid
</span></span><span style="display:flex;"><span><span style="color:#75715e"># node-3</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;3&#34;</span> &gt;/opt/zookeeper/data/myid
</span></span></code></pre></div><p>​</p>

    </div>
</div>

</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/zookeeper.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=zookeeper service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://zookeeper.apache.org/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=forking
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=JAVA_HOME=/opt/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/zookeeper/bin/zkServer.sh start
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStop=/opt/zookeeper/bin/zkServer.sh stop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/opt/zookeeper/bin/zkServer.sh restart
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PIDFile=/opt/zookeeper/data/zookeeper_server.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>

<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Info</h4>

    zookeeper 主进程名为 <code>QuorumPeerMain</code>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable zookeeper --now
</span></span></code></pre></div></li>
<li>
<p>功能验证</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/zookeeper/bin/zkServer.sh  status
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@hdss7-12 bin<span style="color:#f92672">]</span><span style="color:#75715e">#  /opt/zookeeper/bin/zkCli.sh -server localhost:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>zk: localhost:2181<span style="color:#f92672">(</span>CONNECTED<span style="color:#f92672">)</span> 2<span style="color:#f92672">]</span> ls /
</span></span></code></pre></div></li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a2ebb8369fef061edbf7f3c10100d052">部署kafka</h1>
	<div class="lead"><em>如何快速启动一个kafka服务</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-12" class="text-body-secondary">Friday, September 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code></p>
<p>kafka版本：<code>3.3.2</code></p>
<hr>
<p><em>2011年初，美国领英公司（LinkedIn）开源了一款基础架构软件，以奥地利作家弗兰兹·卡夫卡（Franz Kafka）的名字命名，之后 LinkedIn将其贡献给 Apache基金会，随后该软件于2012年10月完成孵化并顺利晋升为Apache顶级项目——这便是大名鼎鼎的Apache Kafka</em></p>


</div>

<h3 id="安装部署">安装部署</h3>
<blockquote>
<p>作为高吞吐的数据流引擎，磁盘和网络性能对kafka影响最大。24C 、32GB 、1TB 7200转sas盘2块、1gb/s 带宽</p>
</blockquote>
<p><strong>安装依赖</strong></p>
<ul>
<li>安装<code>jdk</code> 和 <code>zookeeper</code>参考 <a href="zookeeper.html">部署zookeeper</a></li>
</ul>
<p><strong>部署安装<sub>【elk建议Kafka 版本 0.8.2.0+】</sub></strong></p>
<ul>
<li>
<p>下载软件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#												 kafaka_&lt;scala版本&gt;-&lt;kafka版本&gt;.tgz	</span>
</span></span><span style="display:flex;"><span>wget https://archive.apache.org/dist/kafka/3.3.2/kafka_2.13-3.3.2.tgz
</span></span><span style="display:flex;"><span>tar xf kafka_2.13-3.3.2.tgz -C /opt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ln -sv  /opt/<span style="color:#f92672">{</span>kafka_2.13-3.3.2,kafka<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir /opt/kafka/data
</span></span></code></pre></div></li>
<li>
<p>修改配置文件</p>

    
    
    
  <ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>配置kafka</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="**单节点配置**" aria-controls="tabs-01-01" aria-selected="true">
        <strong>单节点配置</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="**集群配置**" aria-controls="tabs-01-02" aria-selected="false">
        <strong>集群配置</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kafka_svc<span style="color:#f92672">=</span>kafka-1:9092
</span></span><span style="display:flex;"><span>broker_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>zookeeper_svc<span style="color:#f92672">=</span>zookeeper-1:2181,zookeeper-2:2181,zookeeper-3:2181
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tee /opt/kafka/config/server.properties <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">broker.id=${broker_id}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 尽量使用域名而不是ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listeners=PLAINTEXT://${kafka_svc}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">advertised.listeners=PLAINTEXT://${kafka_svc}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log.dirs=/opt/kafka/data/kafka1-logs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">zookeeper.connect=${zookeeper_svc}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">zookeeper.connection.timeout.ms=18000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">delete.topic.enable=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">unclean.leader.election.enable=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <p>同一集群中保证<code>broker_id</code>唯一，同时修改 <code>listeners</code> 和 <code>advertised.listeners</code></p>

    </div>
</div>

</li>
<li>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/kafka.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=zookeeper service 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://kafka.apache.org/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=forking
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=JAVA_HOME=/opt/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kafka/bin/kafka-server-start.sh -daemon /opt/kafka/config/server.properties
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStop=/opt/kafka/bin/kafka-server-stop.sh /opt/kafka/config/server.properties
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload 
</span></span><span style="display:flex;"><span>systemctl enable kafka --now
</span></span></code></pre></div></li>
<li>
<p>功能验证</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建topics</span>
</span></span><span style="display:flex;"><span>/opt/kafka/bin/kafka-topics.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--create --topic app-log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看topics</span>
</span></span><span style="display:flex;"><span>/opt/kafka/bin/kafka-topics.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看topics详情</span>
</span></span><span style="display:flex;"><span>/opt/kafka/bin/kafka-topics.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--describe <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--topic app-log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 向topics产生一个事件</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;This is my first event\nThis is my second event&#34;</span> |<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>/opt/kafka/bin/kafka-console-producer.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--topic  app-log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从头消费topics事件</span>
</span></span><span style="display:flex;"><span>/opt/kafka/bin/kafka-console-consumer.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--topic app-log <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--from-beginning 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#This is my first event</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#This is my second event</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除topic</span>
</span></span><span style="display:flex;"><span>/opt/kafka/bin/kafka-topics.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bootstrap-server localhost:9092  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--delete --topic app-log
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建指定分区和副本数量的topic</span>
</span></span><span style="display:flex;"><span>/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--create --topic app-log <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--replication-factor <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--partitions <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --describe --topic app-log</span>
</span></span><span style="display:flex;"><span>Topic: app-log        TopicId: sJH_EE1KT-aYppxi8Eq6qg PartitionCount: <span style="color:#ae81ff">2</span>       ReplicationFactor: <span style="color:#ae81ff">2</span>    Configs: unclean.leader.election.enable<span style="color:#f92672">=</span>false
</span></span><span style="display:flex;"><span>        Topic: app-log        Partition: <span style="color:#ae81ff">0</span>    Leader: <span style="color:#ae81ff">2</span>       Replicas: 2,1   Isr: 2,1
</span></span><span style="display:flex;"><span>        Topic: app-log        Partition: <span style="color:#ae81ff">1</span>    Leader: <span style="color:#ae81ff">1</span>       Replicas: 1,0   Isr: 1,0
</span></span></code></pre></div></li>
<li>
<p>压测</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 生产者压测脚本</span>
</span></span><span style="display:flex;"><span>kafka-producer-perf-test
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 消费者压测脚本</span>
</span></span><span style="display:flex;"><span>kafka-consumer-perf-test
</span></span></code></pre></div></li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-dc4ad1ef352d1381b1276b6e775efacb">kafka核心概念和配置文件</h1>
	<div class="lead"><em>剖析kafka架构、核心概念和配置</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-10-15" class="text-body-secondary">Wednesday, October 15, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code></p>
<p>kafka版本：<code>2.13-3.3.2</code>  龙腾出行生产环境使用<code>2.11-2.2.0</code></p>
<hr>
<p><em>2011年初，美国领英公司（LinkedIn）开源了一款基础架构软件，以奥地利作家弗兰兹·卡夫卡（Franz Kafka）的名字命名，之后 LinkedIn将其贡献给 Apache基金会，随后该软件于2012年10月完成孵化并顺利晋升为Apache顶级项目——这便是大名鼎鼎的Apache Kafka</em></p>


</div>

<h3 id="核心概念">核心概念</h3>
<ul>
<li><strong>broker</strong> 一个kafka进程实例可以称作一个broker,主要功能是持久化消息以及将消息队列中的消息从发送端传输到消费端</li>
<li><strong>topic</strong>主题就好比数据库的表，或者文件系统里的文件夹。一个主题可以有若干个<strong>partition</strong>，是实现分布式和高可用的关键</li>
<li><strong>producer</strong>生产者可能被称为发布者或写入者。</li>
<li><strong>consumer</strong>消费者可能被称为订阅者或读者。</li>
<li><strong>offset</strong>是一个不断递增的整数值，在创建消息时，Kafka 会把它添加到消息里。在给定的分区里，每个消息的偏移量都是唯一的。消费者把每个分区最后读取的消息偏移量保存在 Zookeeper 或 Kafka 上，如果消费者关闭或重启，它的读取状态不会丢失。</li>
<li><strong>consumer group</strong> 为使消费者按照消息顺序消费和避免重复消费，群组保证每个分区只能被一个消费者使用</li>
</ul>
<h3 id="核心配置">核心配置</h3>
<blockquote>
<p>kafka不支持动态调整参数，调整后需要重启broker</p>
</blockquote>


  
  



  

  

<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="**broker端参数**" aria-controls="tabs-01-00" aria-selected="true">
        <strong>broker端参数</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="**topic级别参数**" aria-controls="tabs-01-01" aria-selected="false">
        <strong>topic级别参数</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="**jvm参数**" aria-controls="tabs-01-02" aria-selected="false">
        <strong>jvm参数</strong>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="**os参数**" aria-controls="tabs-01-03" aria-selected="false">
        <strong>os参数</strong>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <p><a href="https://kafka.apache.org/30/documentation.html#brokerconfigs" target="_blank">文档</a></p>
<ul>
<li>
<p><strong>broker.id</strong></p>
<blockquote>
<p>Broker唯一标识，不指定时broker随机生成一个</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span></code></pre></div></li>
<li>
<p><strong>log.dirs</strong></p>
<blockquote>
<p>kafka数据存放位置，可以填写多个。多个使用<code>,</code>间隔</p>
</blockquote>
<p>示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span></code></pre></div></li>
<li>
<p><strong>zookeeper.connect</strong></p>
<blockquote>
<p>ZooKeeper服务器地址，多个使用<code>,</code>间隔。</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span></code></pre></div></li>
<li>
<p><strong>listeners</strong></p>
<blockquote>
<p>监听信息。格式:   <code>[协议]://[主机名]:[端口],[[协议]]://[主机名]:[端口]] </code></p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span></code></pre></div></li>
<li>
<p><strong>advertised.listeners</strong></p>
<blockquote>
<p>和listeners类似，该参数也是用于发布给clients的监听器，不过该参数主要用于 IaaS 环境，比如云上的机器通常都配有多块网卡（私网网卡和公网网卡）。对于这种机器，用户可以设置该参数绑定公网IP供外部clients使用，然后配置上面的listeners来绑定私网 IP供broker间通信使用</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span></code></pre></div></li>
<li>
<p><strong>auto.create.topics.enable</strong></p>
<blockquote>
<p>是否允许自动创建topic,默认值<em>true</em></p>
</blockquote>
<p>示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span></code></pre></div></li>
<li>
<p><strong>delete.topic.enable</strong></p>
<blockquote>
<p>是否允许删除topic,默认为true。建议配合acl使用</p>
</blockquote>
<p>示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span></code></pre></div></li>
<li>
<p><strong>log.retention.{hours|minutes|ms}</strong></p>
<blockquote>
<p>控制了消息数据的留存时间。如果同时设置，优先选取ms的设置，minutes次之，hours最后。默认值7天</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span></code></pre></div></li>
<li>
<p><strong>log.retention.bytes</strong></p>
<blockquote>
<p>空间上控制了消息数据的留存多大的数据。默认值是-1</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span></code></pre></div></li>
<li>
<p><strong>log.flush.interval.messages</strong></p>
<blockquote>
<p>写入的消息放置在kafka缓存中，达到指定条记录后写入到磁盘中，这个参数用于控制多少条数据后执行强制刷新</p>
</blockquote>
</li>
<li>
<p><strong>log.flush.interval.ms</strong></p>
</li>
<li>
<p><strong>log.flush.scheduler.interval.ms</strong></p>
</li>
<li>
<p><strong>unclean.leader.election.enable</strong></p>
<blockquote>
<p>如果我们允许不同步的副本成为首领，那么就要承担丢失数据和出现数据不一致的风险。如果不允许它们成为首领，那么就要接受较低的可用性，因为我们必须等待原先的首领恢复到可用状态。 默认为true</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span></code></pre></div></li>
<li>
<p><strong>min.insync.replicas</strong></p>
<blockquote>
<p>至少有多少个副本确认写入成功才会给生成者返回写入成功（数据可靠性）</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">min.insync.replicas</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
</span></span></code></pre></div></li>
<li>
<p><strong>num.network.threads</strong></p>
<blockquote>
<p>默认是3</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">min.insync.replicas</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.network.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3</span>
</span></span></code></pre></div></li>
<li>
<p><strong>num.io.threads</strong></p>
<blockquote>
<p>默认是8</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">min.insync.replicas</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.network.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.io.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">8</span>
</span></span></code></pre></div></li>
<li>
<p><strong>num.partitions</strong></p>
<blockquote>
<p>topic默认分区数</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">min.insync.replicas</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.network.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.io.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.partitions</span><span style="color:#f92672">=</span><span style="color:#e6db74">3</span>
</span></span></code></pre></div></li>
<li>
<p><strong>default.replication.factor</strong></p>
<blockquote>
<p>topic 默认副本数量</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">min.insync.replicas</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.network.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.io.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.partitions</span><span style="color:#f92672">=</span><span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">default.replication.factor</span><span style="color:#f92672">=</span><span style="color:#e6db74">2</span>
</span></span></code></pre></div></li>
<li>
<p><strong>message.max.bytes</strong></p>
<blockquote>
<p>能够接受的最大消息，默认 977kb</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">broker.id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.dirs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/tmp/kafka-logs,/tmp/kafka-log2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">zookeeper.connect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         PLAINTEXT表示明文传输     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://192.168.0.151:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">advertised.listeners</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">PLAINTEXT://120.24.171.66:9092</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">auto.create.topics.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">delete.topic.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.hours</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 						10g</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log.retention.bytes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1073741824</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unclean.leader.election.enable</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">min.insync.replicas</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.network.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.io.threads</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num.partitions</span><span style="color:#f92672">=</span><span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">default.replication.factor</span><span style="color:#f92672">=</span><span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">message.max.bytes</span><span style="color:#f92672">=</span><span style="color:#e6db74">977</span>
</span></span></code></pre></div></li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <ul>
<li>
<p><strong>num.partitions</strong></p>
<blockquote>
<p>通过设置指定<code>topic partitions</code> 数量来覆盖broker启动文件中的 <code>num.paritions</code>配置。</p>
<p>分区数量只能增加不能减少，但如果消息是按照不同的键来写入分区的，那么为已有的主题新增分区就会很困难</p>
</blockquote>
</li>
<li>
<p><strong>log.retention.ms</strong></p>
</li>
<li>
<p><strong>log.retention.bytes</strong></p>
<blockquote>
<p>覆盖全局的 log.retention.bytes，每个 topic 设置不同的日志留存尺寸。</p>
</blockquote>
</li>
<li>
<p><strong>log.segment.bytes</strong></p>
</li>
<li>
<p><strong>log.segment.ms</strong></p>
</li>
<li>
<p><strong>max.message.bytes</strong></p>
<blockquote>
<p>覆盖全局的 message.max.bytes，即为每个 topic指定不同的最大消息尺寸。</p>
</blockquote>
</li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-Xmx6g -Xms6g
</span></span><span style="display:flex;"><span>-XX:MetaspaceSize<span style="color:#f92672">=</span>96m
</span></span><span style="display:flex;"><span>-XX:+UseG1GC -XX:MaxGCPauseMillis<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>-XX:InitiatingHeapOccupancyPercent<span style="color:#f92672">=</span><span style="color:#ae81ff">35</span>
</span></span><span style="display:flex;"><span>-XX:G1HeapRegionSize<span style="color:#f92672">=</span>16M -XX:MinMetaspaceFreeRatio<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>-XX:MaxMetaspaceFreeRatio<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <ul>
<li>文件描述符</li>
<li>socket缓冲区</li>
<li>使用ext4 或xfs</li>
<li>关闭swap</li>
<li>设置更长的flush时间</li>
</ul>

    </div>
</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-4ca462b874e0f51208f6529a334ea449">Kafka认证和授权</h1>
	<div class="lead"><em>Kafka认证和授权</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-11-10" class="text-body-secondary">Monday, November 10, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code></p>
<p>kafka版本：<code>2.13-3.3.2</code>  龙腾出行生产环境使用<code>2.11-2.2.0</code></p>
<hr>
<p><em>2011年初，美国领英公司（LinkedIn）开源了一款基础架构软件，以奥地利作家弗兰兹·卡夫卡（Franz Kafka）的名字命名，之后 LinkedIn将其贡献给 Apache基金会，随后该软件于2012年10月完成孵化并顺利晋升为Apache顶级项目——这便是大名鼎鼎的Apache Kafka</em></p>


</div>

<h3 id="用户">用户</h3>
<p><font color=＃008B8B><strong>创建用户</strong></font></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建用户test 密码123456 加密方式SCRAM-SHA-256</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@seagullcore01-uat-s2 kafka_2.13-3.3.2<span style="color:#f92672">]</span><span style="color:#75715e"># bin/kafka-configs.sh \</span>
</span></span><span style="display:flex;"><span>--bootstrap-server 192.168.0.161:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--alter <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--add-config <span style="color:#e6db74">&#39;SCRAM-SHA-256=[password=123456]&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--entity-type users <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--entity-name test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Completed updating config <span style="color:#66d9ef">for</span> user test.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查看用户</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@seagullcore01-uat-s2 kafka_2.13-3.3.2<span style="color:#f92672">]</span><span style="color:#75715e"># bin/kafka-configs.sh \</span>
</span></span><span style="display:flex;"><span>--bootstrap-server 192.168.0.161:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--describe <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-entity-type users <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--entity-name test 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SCRAM credential configs <span style="color:#66d9ef">for</span> user-principal <span style="color:#e6db74">&#39;test&#39;</span> are SCRAM-SHA-256<span style="color:#f92672">=</span>iterations<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>
</span></span></code></pre></div><p><font color=＃008B8B><strong>修改kafka配置文件并重启服务</strong></font></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;&gt;config/server.properties <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 添加以下配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sasl.enabled.mechanisms=SCRAM-SHA-256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 如果已有 SSL，可写 SASL_SSL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">security.inter.broker.protocol=SASL_PLAINTEXT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sasl.mechanism.inter.broker.protocol=SCRAM-SHA-256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listeners=SASL_PLAINTEXT://192.168.0.161:9092
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">advertised.listeners=SASL_PLAINTEXT://192.168.0.161:9092
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 用于集群成员间通讯
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listener.name.sasl_plaintext.scram-sha-256.sasl.jaas.config=\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  org.apache.kafka.common.security.scram.ScramLoginModule required \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  username=&#34;test&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  password=&#34;123456&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt;config/kafka_server_jaas.conf <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KafkaServer {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    org.apache.kafka.common.security.scram.ScramLoginModule required
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    username=&#34;test&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    password=&#34;123456&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">};
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export KAFKA_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-Djava.security.auth.login.config=config/kafka_server_jaas.conf&#34;</span>
</span></span><span style="display:flex;"><span>./bin/kafka-server-start.sh  config/server.properties
</span></span></code></pre></div><p><font color=＃008B8B><strong>修改filebeat配置启动密码认证</strong></font></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>filebeat.inputs:
</span></span><span style="display:flex;"><span>- type: filestream
</span></span><span style="display:flex;"><span>  enabled: true
</span></span><span style="display:flex;"><span>  paths:
</span></span><span style="display:flex;"><span>  - /var/log/messages
</span></span><span style="display:flex;"><span>output.kafka:
</span></span><span style="display:flex;"><span>  enabled: true
</span></span><span style="display:flex;"><span>  hosts: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.0.161:9092&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  username: test
</span></span><span style="display:flex;"><span>  password: <span style="color:#e6db74">&#39;123456&#39;</span>
</span></span><span style="display:flex;"><span>  sasl.mechanism: <span style="color:#e6db74">&#39;SCRAM-SHA-256&#39;</span>
</span></span><span style="display:flex;"><span>  topic: <span style="color:#e6db74">&#39;foobar&#39;</span>
</span></span><span style="display:flex;"><span>  required_acks: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  compression: gzip
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 1MB</span>
</span></span><span style="display:flex;"><span>  max_message_bytes: <span style="color:#ae81ff">1000000</span>
</span></span></code></pre></div><h3 id="acl鉴权">acl鉴权</h3>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-5408ed3211021d47e8c86495e76d3ace">Kafka 如何进行复制</h1>
	<div class="lead"><em>剖析kafka副本之间数据如何复制</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-11-10" class="text-body-secondary">Monday, November 10, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code></p>
<p>kafka版本：<code>2.13-3.3.2</code>  龙腾出行生产环境使用<code>2.11-2.2.0</code></p>
<hr>
<p><em>2011年初，美国领英公司（LinkedIn）开源了一款基础架构软件，以奥地利作家弗兰兹·卡夫卡（Franz Kafka）的名字命名，之后 LinkedIn将其贡献给 Apache基金会，随后该软件于2012年10月完成孵化并顺利晋升为Apache顶级项目——这便是大名鼎鼎的Apache Kafka</em></p>


</div>

<p>Kafka 组件订阅 Zookeeper 的 /brokers/ids 路径（broker 在 Zookeeper 上的注册路径），当有 broker 加入集群或退出集群时，这些组件就可以获得通知。</p>
<p><strong>控制器</strong>其实就是一个 broker，只不过它除了具有一般 broker 的功能之外，还负责分区首领的选举</p>
<p>集群里第一个启动的 broker 通过在Zookeeper 里创建一个临时节点 /controller 让自己成为控制器其他 broker 在启动时也会尝试创建这个节点，不过它们会收到一个“节点已存在”的异常，然后“意识”到控制器节点已存在，也就是说集群里已经有一个控制器了其他 broker 在控制器节点上创建Zookeeper watch 对象，这样它们就可以收到这个节点的变更通知。这种方式可以确保集群里一次只有一个控制器存在。</p>
<p>每个新选出的控制器通过 Zookeeper 的条件递增操作获得一个全新的、数值更大的 controller epoch。其他 broker 在知道当前 controller epoch 后，如果收到由控制器发出的包含较旧epoch 的消息，就会忽略它们。</p>
<p>Kafka 使用主题来组织数据，每个主题被分为若干个分区，每个分区有多个副本,副本有以下两种类型。</p>
<p><strong>首领副本</strong>每个分区都有一个首领副本。为了保证一致性，所有生产者请求和消费者请求都会经过这个副本。</p>
<p><strong>跟随者副本</strong>首领以外的副本都是跟随者副本。跟随者副本不处理来自客户端的请求，它们唯一的任务就是从首领那里复制消息，保持与首领一致的状态。如果首领发生崩溃，其中的一个跟随者会被提升为新首领。</p>
<p>为了与首领保持同步，跟随者向首领发送获取数据的请求，这种请求与消费者为了读取消息而发送的请求是一样的。请求消息里包含了跟随者想要获取消息的偏移量，而且这些偏移量总是有序的。</p>
<p>如果跟随者在 10s 内没有请求任何消息，或者虽然在请求消息，但在 10s 内没有请求最新的数据，那么它就会被认为是不同步的,通过<code>replica.lag.time.max.ms</code>参数来配置超时时长</p>
<p><strong>首选首领</strong>的主要目的是保证集群的负载均衡。除了当前首领之外，每个分区都有一个首选首领——创建主题时选定的首领就是分区的首</p>
<p>选首领，如果不是，并且该副本是同步的，那么就会触发首领选举，让首选首领成为当前首领。</p>
<p><code>auto.leader.rebalance.enable=true</code> 默认已开启</p>
<p><strong>元数据请求</strong>服务器端的响应消息里指明了这些主题所包含的分区、每个分区都有哪些副本，以及哪个副本是首领。元数据请求可以发送给任意一个 broker，因为所有 broker 都缓存了这些信息。</p>
<p>客户端会把这些信息缓存起来，并直接往目标 broker 上发送生产请求和获取请求。它们需要时不时地通过发送元数据请求来刷新这些信息（python客户端中通过 <code>metadata_max_age_ms</code>参数来配置）</p>
<p><strong>生产请求</strong> 通过<code>acks</code>参数broker确认消息的成功写入，在 Linux 系统上，消息会被写到文件系统缓存里，并不保证它们何时会被刷新到磁盘上</p>
<p><strong>获取请求</strong> broker按照批次向客户端响应数据，客户端同步配置 <code>fetch_min_bytes</code>和<code>fetch_max_wait_ms</code>参数来控制每个批次大小或批次间隔。同时在多副本中消费者只能消费所有ISR副本已经完成复制的消息（也就是kafka数据的高水位），既然有了高水位也就引出了主从分片间数据同步超时时间<code>replica.lag.time.max.ms</code>(超过该时长的副本会被leader partition从ISR列表中提出，从而减少对消费者进度造成影响)</p>
<pre class="mermaid">flowchart LR

	A(元数据请求)
	B(生产请求)
	C(获取请求)
	Z&gt;请求类型]
	Z -..-&gt; A
	Z -..-&gt; B
	Z -..-&gt; C


    style A fill:#bbf,stroke:#333,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style B fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style C fill:#bbf,stroke:#333,stroke-width:2px,color:#fff,stroke-dasharray: 5 5</pre>
<p>kafka 数据保留策略：</p>
<ul>
<li>
<p><code>log.dir</code> 确认数据保留位置</p>
</li>
<li>
<p><code>log.retention.hours = 168</code> 和 <code>log.retention.bytes = 1073741824</code> 确认数据保留的时长或大小。</p>
<p>数据文件按照片段保留数据默认1g（ <code>log.segment.bytes=1073741824</code> ）如果达到片段上限，就关闭当前文件，并打开一个新文件。当前正在写入数据的片段叫作活跃片段。活动片段永远不会被删除，所以如果你要保留数据 1 天(<code>log.retention.hours = 24</code>)，但片段里包含了 5 天的数据，那么这些数据会被保留 5 天</p>
<p>kafka 提供了工具查看片段中的内容:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/kafka/bin/kafka-dump-log.sh --files 00000000000000000504.log |less
</span></span></code></pre></div></li>
</ul>
<p>JMX 全称为 Java Management Extensions，用来管理和监测 Java 程序。最常用到的就是对于 JVM 的监测和管理，比如 JVM 内存、CPU 使用率、线程数、垃圾收集情况等等。另外，还可以用作日志级别的动态修改，比如 log4j 就支持 JMX 方式动态修改线上服务的日志级别.</p>
<p>JMX是一个标准接口，不但可以用于管理JVM，还可以管理应用程序自身。下图是JMX的架构</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    ┌─────────┐  ┌─────────┐
</span></span><span style="display:flex;"><span>    │jconsole │  │   Web   │
</span></span><span style="display:flex;"><span>    └─────────┘  └─────────┘
</span></span><span style="display:flex;"><span>         │            │
</span></span><span style="display:flex;"><span>┌ ─ ─ ─ ─│─ ─ ─ ─ ─ ─ ┼ ─ ─ ─ ─
</span></span><span style="display:flex;"><span> JVM     ▼            ▼        │
</span></span><span style="display:flex;"><span>│   ┌─────────┐  ┌─────────┐
</span></span><span style="display:flex;"><span>  ┌─┤Connector├──┤ Adaptor ├─┐ │
</span></span><span style="display:flex;"><span>│ │ └─────────┘  └─────────┘ │
</span></span><span style="display:flex;"><span>  │       MBeanServer        │ │
</span></span><span style="display:flex;"><span>│ │ ┌──────┐┌──────┐┌──────┐ │
</span></span><span style="display:flex;"><span>  └─┤MBean1├┤MBean2├┤MBean3├─┘ │
</span></span><span style="display:flex;"><span>│   └──────┘└──────┘└──────┘
</span></span><span style="display:flex;"><span> ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-3f35b0366995d1b427499856875e611b">kafka_exporter</h1>
	<div class="lead"><em>通过kafka-exporter监控broker、producer、consumer</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-12" class="text-body-secondary">Friday, September 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code></p>
<p>kafka版本：<code>3.3.2</code></p>
<hr>
<p><em>2011年初，美国领英公司（LinkedIn）开源了一款基础架构软件，以奥地利作家弗兰兹·卡夫卡（Franz Kafka）的名字命名，之后 LinkedIn将其贡献给 Apache基金会，随后该软件于2012年10月完成孵化并顺利晋升为Apache顶级项目——这便是大名鼎鼎的Apache Kafka</em></p>


</div>

<h3 id="kafka_"><strong>kafka_exporter</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/danielqsj/kafka_exporter/releases/download/v1.9.0/kafka_exporter-1.9.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf kafka_exporter-1.9.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mv kafka_exporter-1.9.0.linux-amd64/kafka_exporter /usr/bin/kafka_exporter 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/kafka_exporter.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=kafka_exporter service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/danielqsj/kafka_exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/kafka_exporter \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=&#34;:9309&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kafka.server=192.168.0.151:9092 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kafka.server=192.168.0.152:9092 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kafka.server=192.168.0.153:9092
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 监控有密码认证的kafka
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#--sasl.enabled \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#--sasl.username=filebeat \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#--sasl.password=ZmlsZWJlYXRAMjAyNgo= \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#--sasl.mechanism=scram-sha256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload 
</span></span><span style="display:flex;"><span>systemctl enable kafka_exporter --now 
</span></span><span style="display:flex;"><span>systemctl status kafka_exporter
</span></span></code></pre></div><p>grafna 报表id <code>21078</code></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">指标名称</th>
          <th style="text-align: left">指标含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><code>kafka_consumergroup_lag</code></td>
          <td style="text-align: left"><strong>消费者组的滞后消息数</strong>，即消息积压量</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_consumergroup_members</code></td>
          <td style="text-align: left">消费者组中成员数量</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_consumergroup_current_offset</code></td>
          <td style="text-align: left">消费者组在当前分区的最新提交偏移量</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_topic_partition_current_offset</code></td>
          <td style="text-align: left">主题分区在Broker上的最新消息偏移量（生产者偏移）</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_brokers</code></td>
          <td style="text-align: left">Kafka集群中的代理（Broker）数量</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_broker_info</code></td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_topic_partitions</code></td>
          <td style="text-align: left">指定主题的分区数量</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_topic_partition_replicas</code></td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>kafka_topic_partition_in_sync_replica</code></td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>process_cpu_seconds_total</code></td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>process_max_fds</code></td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>process_open_fds</code></td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"><code>process_start_time_seconds</code></td>
          <td style="text-align: left"></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kafka</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">KAFKA_brokers异常</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">kafka_broker_info != 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">2m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.name }}当前brokers异常：{{ $labels.address }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">电商生产KAFKA消息整体积压</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">sum(kafka_consumergroup_lag_sum{job=&#34;kafka-exporter&#34;}) by (name,consumergroup, topic)&gt;5000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">2m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;【环境】{{ $labels.name }}\n【消费组】{{ $labels.consumergroup }}\n【topic】{{ $labels.topic }}【积压】：{{ $value | printf \&#34;%.2f\&#34; }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">电商生产KAFKA消息分区积压</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">(sum(kafka_consumergroup_lag{job=&#34;kafka-exporter&#34;}) by (name,consumergroup, topic, partition)&gt;1500) AND ON() (hour()+8)%24 &gt;= 7 &lt;= 21</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">3m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;【环境】{{ $labels.name }}\n【消费组】{{ $labels.consumergroup }}\n【topic】{{$labels.topic}}【分区】{{ $labels.partition }}【积压】：{{ $value | printf \&#34;%.2f\&#34; }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">电商生产KAFKA分区数过多</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">sum by(name)(kafka_topic_partitions{job=&#34;kafka-exporter&#34;,topic !~&#34;__.*&#34;})&gt;1500</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">2m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.name }}当前分区数：{{ $value | printf \&#34;%.2f\&#34; }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">电商生产KAFKA_brokers丢失</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">kafka_brokers{job=&#34;kafka-exporter&#34;} &lt; 3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">2m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.name }}当前brokers数：{{ $value | printf \&#34;%.2f\&#34; }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">电商生产KAFKA_TopicsReplicas</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">sum(kafka_topic_partition_in_sync_replica{job=&#34;kafka-exporter&#34;}) by (name,topic) &lt;1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">2m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.name }} Kafka topic in-sync partition：{{ $value | printf \&#34;%.2f\&#34; }}&#34;</span>
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-25e990c22a9d5ff7c6e251af66967092">kafka可视化管理工具</h1>
	<div class="lead"><em>如何可视化管理kafka,给开发使用</em></div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-12" class="text-body-secondary">Friday, September 12, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">文档环境</h4>

    <p>os 版本： <code>CentOS Linux release 7.9.2009 (Core)</code></p>
<p>jdk版本：<code>openjdk 11</code></p>
<p>zookeeper版本: <code>3.4.14</code></p>
<p>kafka版本：<code>3.3.2</code></p>
<hr>
<p><em>2011年初，美国领英公司（LinkedIn）开源了一款基础架构软件，以奥地利作家弗兰兹·卡夫卡（Franz Kafka）的名字命名，之后 LinkedIn将其贡献给 Apache基金会，随后该软件于2012年10月完成孵化并顺利晋升为Apache顶级项目——这便是大名鼎鼎的Apache Kafka</em></p>


</div>

<ul>
<li>
<p><a href="https://github.com/yahoo/CMAK.git" target="_blank">雅虎开源的kafka管理工具CMAK</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export ZK_HOSTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181&#34;</span>
</span></span><span style="display:flex;"><span>wget https://github.com/yahoo/CMAK/releases/download/3.0.0.6/cmak-3.0.0.6.zip
</span></span><span style="display:flex;"><span>unzip cmak-3.0.0.6.zip
</span></span><span style="display:flex;"><span>cmak-3.0.0.6/bin/cmak
</span></span></code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">启动报错</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>025-10-13 10:11:20,623 - <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> k.m.KafkaManager - Failed on input : KMAddCluster<span style="color:#f92672">(</span>ClusterConfig<span style="color:#f92672">(</span>demo,CuratorConfig<span style="color:#f92672">(</span>192.168.0.151:2181,192.168.0.152:2181,192.168.0.153:2181,10,100,1000<span style="color:#f92672">)</span>,true,3.1.0,false,None,None,false,false,true,true,false,false,Some<span style="color:#f92672">(</span>ClusterTuning<span style="color:#f92672">(</span>Some<span style="color:#f92672">(</span>30<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>100<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>100<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>100<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>30<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>5<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>4<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>1000<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>4<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>1000<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>4<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>1000<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>30000<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>1000000<span style="color:#f92672">)</span>,Some<span style="color:#f92672">(</span>7<span style="color:#f92672">)))</span>,PLAINTEXT,None,None<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>org.apache.zookeeper.KeeperException$UnimplementedException: KeeperErrorCode <span style="color:#f92672">=</span> Unimplemented <span style="color:#66d9ef">for</span> /kafka-manager/mutex
</span></span><span style="display:flex;"><span>        at org.apache.zookeeper.KeeperException.create<span style="color:#f92672">(</span>KeeperException.java:106<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.zookeeper.KeeperException.create<span style="color:#f92672">(</span>KeeperException.java:54<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.zookeeper.ZooKeeper.create<span style="color:#f92672">(</span>ZooKeeper.java:1538<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.utils.ZKPaths.mkdirs<span style="color:#f92672">(</span>ZKPaths.java:291<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl$11.call<span style="color:#f92672">(</span>CreateBuilderImpl.java:746<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl$11.call<span style="color:#f92672">(</span>CreateBuilderImpl.java:723<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.RetryLoop.callWithRetry<span style="color:#f92672">(</span>RetryLoop.java:109<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl.pathInForeground<span style="color:#f92672">(</span>CreateBuilderImpl.java:720<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl.protectedPathInForeground<span style="color:#f92672">(</span>CreateBuilderImpl.java:484<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl.forPath<span style="color:#f92672">(</span>CreateBuilderImpl.java:474<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2025-10-13 10:11:20,623 - <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> k.m.ApiError$ - error : KeeperErrorCode <span style="color:#f92672">=</span> Unimplemented <span style="color:#66d9ef">for</span> /kafka-manager/mutex
</span></span><span style="display:flex;"><span>org.apache.zookeeper.KeeperException$UnimplementedException: KeeperErrorCode <span style="color:#f92672">=</span> Unimplemented <span style="color:#66d9ef">for</span> /kafka-manager/mutex
</span></span><span style="display:flex;"><span>        at org.apache.zookeeper.KeeperException.create<span style="color:#f92672">(</span>KeeperException.java:106<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.zookeeper.KeeperException.create<span style="color:#f92672">(</span>KeeperException.java:54<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.zookeeper.ZooKeeper.create<span style="color:#f92672">(</span>ZooKeeper.java:1538<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.utils.ZKPaths.mkdirs<span style="color:#f92672">(</span>ZKPaths.java:291<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl$11.call<span style="color:#f92672">(</span>CreateBuilderImpl.java:746<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl$11.call<span style="color:#f92672">(</span>CreateBuilderImpl.java:723<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.RetryLoop.callWithRetry<span style="color:#f92672">(</span>RetryLoop.java:109<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl.pathInForeground<span style="color:#f92672">(</span>CreateBuilderImpl.java:720<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl.protectedPathInForeground<span style="color:#f92672">(</span>CreateBuilderImpl.java:484<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at org.apache.curator.framework.imps.CreateBuilderImpl.forPath<span style="color:#f92672">(</span>CreateBuilderImpl.java:474<span style="color:#f92672">)</span>
</span></span></code></pre></div><p><strong>解决办法</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建 kafka-manager 基础路径</span>
</span></span><span style="display:flex;"><span>create /kafka-manager <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>create /kafka-manager/mutex <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>create /kafka-manager/mutex/locks <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>create  /kafka-manager/mutex/leases <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div>

</div>

</li>
<li>
<p><a href="https://github.com/didi/KnowStreaming.git" target="_blank">滴滴开源的kafka管理工具</a></p>
</li>
<li>
<p><a href="https://www.kafkatool.com/download.html" target="_blank">Offset Explorer (kafkatool.com)</a></p>
</li>
</ul>

</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9faafc121020cd39ed50e11e26aaa6b3">7.8 - </h1>
    
	<p>RabbitMQ安装、集群</p>
<p>安全</p>
<p>监控</p>
<p>学习前3章</p>
<p>AMQP advanced message queuing protocol 2004公布协议标准</p>
<p>交换机 exchange</p>
<p>队列 queue</p>
<p>绑定</p>
<p>虚拟机 vhost： 是一个迷你版的rabbitMQ，可以隔离队列、交换机、绑定以及权限。默认vhost 为 “/“</p>
<p>rabbitmqctl add_vhost test</p>
<p>rabbitmqctl list_vhost test</p>
<p>rabbitmqctl delete_vhost test</p>
<p>消息持久化</p>
<ul>
<li>
<p>交换机和队列同时开启持久化参数durable = true</p>
</li>
<li>
<p>消息投递时开启持久化参数 delivery_mode=2</p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c9fd25539bbddcf7221fed520f3d1a93">快速开始</h1>
	
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-07-28" class="text-body-secondary">Monday, July 28, 2025</time>
        
	</div>
	

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">内容概要</h4>

    <ul>
<li>什么是rabbitMQ</li>
<li>安装单机版本rabbitMQ</li>
<li>python 编写demo</li>
</ul>


</div>

<hr>
<p>RabbitMQ 是一个开源的消息中间件（Message Broker），实现了 AMQP（Advanced Message Queuing Protocol） 协议，同时也支持 STOMP、MQTT 等协议。它用于在分布式系统中异步传递消息，解决系统间解耦、削峰、异步处理等问题。</p>
<p><strong>RabbitMQ 的核心概念</strong></p>
<table>
  <thead>
      <tr>
          <th>概念</th>
          <th>说明</th>
          <th>类比</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>Producer</code></td>
          <td>生产者发送消息到 RabbitMQ 的应用程序。</td>
          <td>寄快递的人</td>
      </tr>
      <tr>
          <td><code>Consumer</code></td>
          <td>消费者从队列中接收并处理消息的程序。</td>
          <td>收快递的人</td>
      </tr>
      <tr>
          <td><code>Queue</code></td>
          <td>存储消息的缓冲区，消息在这里等待被消费。</td>
          <td>快递柜</td>
      </tr>
      <tr>
          <td><a href="#exchange_type"><code>Exchange</code></a></td>
          <td>接收生产者消息，根据规则路由到一个或多个队列。</td>
          <td>快递分拣中心</td>
      </tr>
      <tr>
          <td><code>Routing Key</code></td>
          <td>生产者发送消息时指定的“地址”，用于匹配绑定的规则。</td>
          <td>快递上的地址</td>
      </tr>
      <tr>
          <td><code>Binding</code></td>
          <td>定义 Exchange 和 Queue 之间的关系，包含路由规则。</td>
          <td>快递分拣规则</td>
      </tr>
      <tr>
          <td><code>Channel</code></td>
          <td>轻量级连接，复用 TCP 连接，减少资源消耗。</td>
          <td>快递员的送货路线</td>
      </tr>
      <tr>
          <td><code>Virtual Host</code></td>
          <td>逻辑隔离的命名空间，类似数据库的 schema。</td>
          <td>不同快递公司的仓库</td>
      </tr>
  </tbody>
</table>
<hr>
<span id="exchange_type" />
<p>常见 Exchange 类型</p>
<table>
  <thead>
      <tr>
          <th>类型</th>
          <th>描述</th>
          <th>场景</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>Direct</code></td>
          <td>精确匹配 routing key。</td>
          <td>日志级别分发（error、info、warn）。</td>
      </tr>
      <tr>
          <td><code>Fanout</code></td>
          <td>广播消息到所有绑定队列，忽略 routing key。</td>
          <td>群发通知。</td>
      </tr>
      <tr>
          <td><code>Topic</code></td>
          <td>模糊匹配 routing key（支持通配符 <code>*</code> 和 <code>#</code>）。</td>
          <td>多维度日志分类。</td>
      </tr>
      <tr>
          <td><code>Headers</code></td>
          <td>基于消息头（headers）匹配，少用。</td>
          <td>复杂规则匹配。</td>
      </tr>
  </tbody>
</table>
<hr>
<h3 id="单机部署">单机部署</h3>
<table>
  <thead>
      <tr>
          <th>软件</th>
          <th>版本</th>
          <th>端口</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>erlang</td>
          <td>26.2</td>
          <td></td>
      </tr>
      <tr>
          <td>rabbitMQ</td>
          <td>3.12.10、4.1.3</td>
          <td>提供给客户端连接 <code>5672</code>   浏览器管理<code>15672</code>  集群内部通讯 <code>25672</code></td>
      </tr>
  </tbody>
</table>
<p><strong>第一步：安装erlang依赖</strong></p>
<blockquote>
<p>erlang 环境可以将其理解为运行java程序时的jre 环境</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install make gcc gcc-c++ perl ncurses-devel
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/erlang/otp.git <span style="color:#f92672">&amp;&amp;</span> cd otp/
</span></span><span style="display:flex;"><span>git checkout maint-26
</span></span><span style="display:flex;"><span>git reset --hard OTP-26.2
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./configure --prefix /opt/erlang
</span></span><span style="display:flex;"><span>make -j <span style="color:#ae81ff">8</span> 
</span></span><span style="display:flex;"><span>make install 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 26.2 是erlang软件的版本，这里看到的14.2是erlang内部运行时系统的版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@seagullcore01-uat-s2 rabbitmq_server-3.12.10<span style="color:#f92672">]</span><span style="color:#75715e"># /opt/erlang/bin/erl -version</span>
</span></span><span style="display:flex;"><span>Erlang <span style="color:#f92672">(</span>SMP,ASYNC_THREADS<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>BEAM<span style="color:#f92672">)</span> emulator version 14.2
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span>/opt/erlang/bin:$PATH
</span></span></code></pre></div><p><strong>第二步：安装rabbitMQ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://mirrors.huaweicloud.com/rabbitmq-server/v3.12.10/rabbitmq-server-generic-unix-3.12.10.tar.xz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf rabbitmq-server-generic-unix-3.12.10.tar.xz -C /opt
</span></span><span style="display:flex;"><span>ln -svf /opt/rabbitmq_server-3.12.10 /opt/rabbitmq
</span></span></code></pre></div><p>启动</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">管理插件</h4>

    <p>3.12.10版本没有自带管理页面，因此需要提前启用该plugins</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/rabbitmq/sbin/rabbitmq-plugins enable rabbitmq_management
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 启动rabbitMQ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 日志文件：/opt/rabbitmq/var/log/rabbitmq/rabbit@seagullcore01-uat-s2.log</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 数据文件：/opt/rabbitmq/var/lib/rabbitmq/mnesia/rabbit@seagullcore01-uat-s2</span>
</span></span><span style="display:flex;"><span>/opt/rabbitmq/sbin/rabbitmq-server -detached
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看rabbtiMQ状态 </span>
</span></span><span style="display:flex;"><span>/opt/rabbitmq/sbin/rabbitmqctl status
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 停止rabbitMQ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /opt/rabbitmq/sbin/rabbitmqctl shutdown</span>
</span></span></code></pre></div><p>创建管理员用户<code>admin</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># /opt/rabbitmq//sbin/rabbitmqctl delete_user admin</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>/opt/rabbitmq//sbin/rabbitmqctl add_user admin
</span></span><span style="display:flex;"><span> /opt/rabbitmq//sbin/rabbitmqctl change_password admin admin
</span></span><span style="display:flex;"><span>/opt/rabbitmq//sbin/rabbitmqctl set_user_tags admin administrator
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 授予 / vhost的所有权限，给admin 用户</span>
</span></span><span style="display:flex;"><span>/opt/rabbitmq/sbin/rabbitmqctl set_permissions -p / admin <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span>
</span></span><span style="display:flex;"><span>/opt/rabbitmq/sbin/rabbitmqctl set_permissions -p test admin <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span><span style="color:#75715e"># /opt/rabbitmq/sbin/rabbitmqctl list_users</span>
</span></span><span style="display:flex;"><span>Listing users ...
</span></span><span style="display:flex;"><span>user    tags
</span></span><span style="display:flex;"><span>admin   <span style="color:#f92672">[</span>administrator<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>guest   <span style="color:#f92672">[</span>administrator<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span><span style="color:#75715e"># /opt/rabbitmq/sbin/rabbitmqctl list_permissions -p /</span>
</span></span><span style="display:flex;"><span>Listing permissions <span style="color:#66d9ef">for</span> vhost <span style="color:#e6db74">&#34;/&#34;</span> ...
</span></span><span style="display:flex;"><span>user    configure       write   read
</span></span><span style="display:flex;"><span>guest   .*      .*      .*
</span></span><span style="display:flex;"><span>admin   .*      .*      .*
</span></span></code></pre></div><hr>
<h3 id="配置rabbitmq">配置rabbitmq</h3>
<p>通过上面启动示例，rabbitmq 启动时并没有指定配置文件。如果我们希望做一些定制化的参数修改可以在<code>/opt/rabbitmq/etc/rabbitmq/</code> 目录中创建 <code>rabbitmq.config</code>配置文件</p>
<blockquote>
<p>查看运行时配置: <code>/opt/rabbitmq/sbin/rabbitmq-diagnostics environment</code></p>
</blockquote>
<ul>
<li>
<p>修改端口和内存限制</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/opt/rabbitmq/etc/rabbitmq/rabbitmq.conf <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 网络配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listeners.tcp.default = 0.0.0.0:5672
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 资源限制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 允许使用总内存的40%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#vm_memory_high_watermark.relative = 0.4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 允许使用1G内存
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vm_memory_high_watermark.absolute = 1073741824
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>修改数据文件和日志文件路径</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /data/rabbitmq/<span style="color:#f92672">{</span>mnesia,logs<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#chown -R rabbitmq:rabbitmq /data/rabbitmq</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt;/opt/rabbitmq/etc/rabbitmq/rabbitmq-env.conf<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 数据目录（Mnesia 数据库、消息存储等）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RABBITMQ_MNESIA_BASE=/data/rabbitmq/mnesia
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 日志目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RABBITMQ_LOG_BASE=/data/rabbitmq/logs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
</ul>
<ol>
<li>声明交换机 <code>exchange.declare</code></li>
<li>声明队列 <code>queue.declare</code></li>
<li>队列绑定到交换机 <code>queue.bind</code></li>
</ol>

</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fd72358146a710880fd761142ab540c9">7.9 - </h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="联系我" aria-label="联系我">
    <a target="_blank" rel="noopener" href="/about/#%e8%81%94%e7%b3%bb%e6%96%b9%e5%bc%8f" aria-label="联系我">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="微信" aria-label="微信">
    <a target="_blank" rel="noopener" href="/about/#%e8%81%94%e7%b3%bb%e6%96%b9%e5%bc%8f" aria-label="微信">
      <i class="fa-brands fa-weixin"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">零露云©2025版权所有</span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.bf0cab613e991fc11bc28a4a07b0aedef47c7c7c2595703ac3adf962fd6a8099.js" integrity="sha256-vwyrYT6ZH8EbwopKB7Cu3vR8fHwllXA6w635Yv1qgJk=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
