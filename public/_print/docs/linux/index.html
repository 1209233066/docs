<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://zero-dew.netlify.app/docs/linux/">
<link rel="alternate" type="application/rss&#43;xml" href="https://zero-dew.netlify.app/docs/linux/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>零露云</title>
<meta name="description" content="linux 文档中心">
<meta property="og:url" content="https://zero-dew.netlify.app/docs/linux/">
  <meta property="og:site_name" content="零露云">
  <meta property="og:title" content="零露云">
  <meta property="og:description" content="linux 文档中心">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="零露云">
  <meta itemprop="description" content="linux 文档中心">
  <meta itemprop="datePublished" content="2025-05-21T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-05-21T00:00:00+00:00">
  <meta itemprop="wordCount" content="64">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="零露云">
  <meta name="twitter:description" content="linux 文档中心">
<link rel="preload" href="/scss/main.min.18c08ee35308968138c55945e86231cae563e39470a6efcb36f516f6b21b6a02.css" as="style" integrity="sha256-GMCO41MIloE4xVlF6GIxyuVj45Rwpu/LNvUW9rIbagI=" crossorigin="anonymous">
<link href="/scss/main.min.18c08ee35308968138c55945e86231cae563e39470a6efcb36f516f6b21b6a02.css" rel="stylesheet" integrity="sha256-GMCO41MIloE4xVlF6GIxyuVj45Rwpu/LNvUW9rIbagI=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">零露云</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/about"><i class="fa-solid fa-house"></i><span>关于</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/docs"><i class="fa-solid fa-book"></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/blog"><i class="fa-solid fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/google/docsy/" target="_blank" rel="noopener"><i class='fa-brands fa-github'></i><span></span></a>
      </li>
      <li class="td-light-dark-menu nav-item dropdown">
        <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
  <symbol id="check2" viewBox="0 0 16 16">
    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
  </symbol>
  <symbol id="circle-half" viewBox="0 0 16 16">
    <path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/>
  </symbol>
  <symbol id="moon-stars-fill" viewBox="0 0 16 16">
    <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
    <path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/>
  </symbol>
  <symbol id="sun-fill" viewBox="0 0 16 16">
    <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
  </symbol>
</svg>

<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center"
        id="bd-theme"
        type="button"
        aria-expanded="false"
        data-bs-toggle="dropdown"
        data-bs-display="static"
        aria-label="Toggle theme (auto)">
  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg>
</button>
<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#sun-fill"></use></svg>
      Light
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"></use></svg>
      Dark
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
      <svg class="bi me-2 opacity-50"><use href="#circle-half"></use></svg>
      Auto
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
</ul>

      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.a779bd279239ad7d8c03caec2282ddc3.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="25"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/linux/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title"></h1>
<div class="lead">linux 文档中心</div>




    <ul>
    
  
  
  
  

  
    
    
	

    <li><a href="#pg-c5846110725fe6073de26c491841db19">问题排查</a></li>



    
  
    
    
	

    <li><a href="#pg-aabda7bf6d1a96b643d9cd390156de59">常用命令</a></li>



    
  
    
    
	

    <li><a href="#pg-b92cf9231f6f9197252551c27d29cc5f">postfix</a></li>



    
  
    
    
	

    <li><a href="#pg-905550e769bb3ce68ebf7701485d4e9d">LVM (logical volume manager)</a></li>



    
  
    
    
	

    <li><a href="#pg-6ac20a0b99b404f8617a619f7cf7fc51">rsyslog</a></li>



    
  
    
    
	
<li>6: <a href="#pg-5e1eecb0ef0b07d2fc44652e2fc03e66">nginx</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-84a82bd7aae117864d19f5961c931ac6">安装nginx</a></li>



    
  
    
    
	

    <li><a href="#pg-2fb0f235e6fc12a93aed4b8df6d5a972">配置nginx</a></li>



    
  
    
    
	

    <li><a href="#pg-d0f39a2ca728b30b9d3532605c8e36a3">http服务器</a></li>



    
  
    
    
	

    <li><a href="#pg-bd8fa7533b3710dac09a20bf9487ec31">反向代理</a></li>



    
  
    
    
	

    <li><a href="#pg-bb64f1e09c3c57ef9271a135603f6231">location指令</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-c8a277e554b08c5c1a52fa904ed67ca0">ansible</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-73cbbd40bbb62c473e2785f489790835">Quitstart</a></li>



    
  
    
    
	
<li>7.2: <a href="#pg-00c869c8082cb1d3aca423fe64068b59"></a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      <pre class="mermaid">graph LR
    A[&#34;/&#34;] -.-&gt;|User Binaries| B[&#34;/bin&#34;]
    A -.-&gt;|System Binaries| C[&#34;/sbin&#34;]
    A -.-&gt;|Configuration Files| D[&#34;/etc&#34;]
    A -.-&gt;|Device Files| E[&#34;/dev&#34;]
    A -.-&gt;|Process Information| F[&#34;/proc&#34;]
    A -.-&gt;|Variable Files| G[&#34;/var&#34;]
    A -.-&gt;|Temporary Files| H[&#34;/tmp&#34;]
    A -.-&gt;|User Programs| I[&#34;/usr&#34;]
    A -.-&gt;|Home Directories| J[&#34;/home&#34;]
    A -.-&gt;|Boot Loader Files| K[&#34;/boot&#34;]
    A -.-&gt;|System Libraries| L[&#34;/lib&#34;]
    A -.-&gt;|Optional add-on Apps| M[&#34;/opt&#34;]
    A -.-&gt;|Mount Directory| N[&#34;/mnt&#34;]
    A -.-&gt;|Removable Devices| O[&#34;/media&#34;]
    A -.-&gt;|Service Data| P[&#34;/srv&#34;]</pre>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c5846110725fe6073de26c491841db19">问题排查</h1>
	<div class="lead">问题排查|linux</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-21" class="text-body-secondary">Wednesday, May 21, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h3 id="查看服务器基本信息">查看服务器基本信息</h3>
<table>
  <thead>
      <tr>
          <th>分类</th>
          <th>功能</th>
          <th>命令</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>硬件</td>
          <td>通过DMI获取系统硬件信息</td>
          <td><code>dmidecode</code> 或 <code>lshw</code></td>
      </tr>
      <tr>
          <td></td>
          <td>显示PCI/USB接口信息</td>
          <td><code>lspci</code>/<code>lsusb</code></td>
      </tr>
      <tr>
          <td></td>
          <td>显示CPU信息</td>
          <td><code>lscpu</code> 或 <code>cat /proc/cpuinfo</code></td>
      </tr>
      <tr>
          <td></td>
          <td>检查硬件虚拟化的支持</td>
          <td><code>egrep --color &quot;vmx|svm&quot; /proc/cpuinfo</code></td>
      </tr>
      <tr>
          <td></td>
          <td>显示物理内存大小</td>
          <td><code>free -m</code> 或 `cat /proc/meminfo</td>
      </tr>
      <tr>
          <td>系统</td>
          <td>查看系统发行版本</td>
          <td><code>cat /etc/system-release</code></td>
      </tr>
      <tr>
          <td></td>
          <td>查看系统内核版本</td>
          <td><code>uname -r</code></td>
      </tr>
      <tr>
          <td></td>
          <td>显示机器的体系结构</td>
          <td><code>arch</code> 或 <code>uname -m</code></td>
      </tr>
      <tr>
          <td></td>
          <td>显示系统加载的内核模块</td>
          <td><code>lsmod</code></td>
      </tr>
      <tr>
          <td></td>
          <td>查看磁盘的<code>inode size</code>  和 <code>block size</code></td>
          <td><code>dumpe2fs /dev/mapper/seagullcore-data</code></td>
      </tr>
      <tr>
          <td>日志</td>
          <td>查看系统启动、硬件</td>
          <td><code>dmesg</code> 或 <code>/var/log/dmesg</code></td>
      </tr>
      <tr>
          <td></td>
          <td>系统日志，记录内核、服务、应用程序的非关键信息</td>
          <td><code>/var/log/messages </code></td>
      </tr>
      <tr>
          <td></td>
          <td>用户登录日志</td>
          <td><code>/var/log/secure</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>cron</code> 定时任务日志</td>
          <td><code>/var/log/cron</code></td>
      </tr>
      <tr>
          <td></td>
          <td>审计日志</td>
          <td><code>/var/log/audit/audit.log</code></td>
      </tr>
      <tr>
          <td></td>
          <td>yum日志</td>
          <td><code>/var/log/yum.log</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>postfix</code> 或 <code>sendmail</code> 等邮件服务的日志</td>
          <td><code>/var/log/maillog</code></td>
      </tr>
  </tbody>
</table>
<h3 id="journalctl-命令">journalctl 命令</h3>
<p>centos7 中<code>journalctl</code> 命令用于显示系统日志。
默认情况下，<code>journalctl</code> 仅显示当前会话的日志，并滚动显示最新的日志条目。
若要显示完整的日志信息，应使用 <code>journalctl</code> 命令配合一些选项来获取更多的日志细节。以下是一些常用的选项：</p>
<ul>
<li><code>-u &lt;unit&gt;</code>：指定要查看的服务名称，例如 <code>-u nginx</code>。</li>
<li><code>-f</code>：以滚动模式显示日志，实时显示新日志条目。</li>
<li><code>-r</code>：以逆序（即从新到旧的顺序）显示日志条目。</li>
<li><code>-o &lt;format&gt;</code>：指定输出格式，可以是 <code>short</code>、<code>verbose</code>、<code>json</code> 等。例如，使用 <code>journalctl -o json</code> 将输出日志以 JSON 格式显示。</li>
<li><code>--since &lt;time&gt;</code>：指定要显示的日志开始时间，该参数可以是时间戳，或者使用类似 <code>yesterday</code>，<code>1 hour ago</code> 的相对时间。例如，使用 <code>journalctl --since &quot;2023-06-24 10:00:00&quot;</code> 将显示从 2023-06-24 10:00:00 开始的所有日志。</li>
<li><code>--until &lt;time&gt;</code>：指定要显示的日志截止时间。例如: <code>journalctl --until &quot;1 hour ago&quot;</code> 将显示截止到 1 小时前的所有日志。</li>
<li><code>-n &lt;number&gt;</code>：指定要显示的日志条目数量。例如，使用 <code>journalctl -n 50</code> 将仅显示最新的 50 条日志。</li>
</ul>
<p>以下是一个示例，可以使用该示例来查看系统的所有服务的日志，显示所有启动时间为 2022 年 1 月 1 日之后的日志，以详细模式显示这些日志，并按照事件发生的反向顺序排列输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>journalctl --since <span style="color:#e6db74">&#34;2022-01-01&#34;</span> -o verbose -u all -r
</span></span></code></pre></div><h3 id="journald-日志系统">journald 日志系统</h3>
<p>centos7 中journalctl是systemd日志系统的管理工具，默认临时存储在<code>/run/log/journal/</code>目录中，重启后丢失。</p>
<p><strong>开启持久化:</strong></p>
<blockquote>
<p><code>/etc/systemd/journald.conf</code> 配置文件中关键参数：</p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th>可选值</th>
          <th>注释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong><code>Storage</code></strong></td>
          <td>volatile</td>
          <td>仅保存在内存中。 例如  <code>Storage=volatile</code></td>
      </tr>
      <tr>
          <td></td>
          <td>persistent</td>
          <td>优先保存在磁盘。例如：<code>Storage=persistent</code></td>
      </tr>
      <tr>
          <td></td>
          <td>auto</td>
          <td>若存在<code>/var/log/journal</code>则持久化，否在仅保存内存中。例如：<code>Storage=auto</code></td>
      </tr>
      <tr>
          <td><strong><code>SystemMaxUse</code></strong></td>
          <td></td>
          <td>限制最大磁盘使用量。例如 <code>SystemMaxUse=10G</code></td>
      </tr>
      <tr>
          <td><strong><code>RuntimeMaxUse</code></strong></td>
          <td></td>
          <td>限制最大内存使用量。例如 <code>RuntimeMaxUse=1G</code></td>
      </tr>
  </tbody>
</table>
</blockquote>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">日志清理</h4>

    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 清理早于指定时间的日志</span>
</span></span><span style="display:flex;"><span>journalctl --vacuum-time<span style="color:#f92672">=</span>7d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 限制日志体积（如保留500MB）</span>
</span></span><span style="display:flex;"><span>journalctl --vacuum-size<span style="color:#f92672">=</span>500M
</span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /var/log/journal
</span></span><span style="display:flex;"><span>chown root:systemd-journal /var/log/journal
</span></span><span style="display:flex;"><span>chmod <span style="color:#ae81ff">2755</span> /var/log/journal
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/.*Storage.*/Storage=persistent/&#39;</span> /etc/systemd/journald.conf
</span></span><span style="display:flex;"><span>systemctl restart systemd-journald
</span></span></code></pre></div><h3 id="系统性能监视工具">系统性能监视工具</h3>
<blockquote>
<p><code>  yum install htop iftop iptraf nethogs iperf3 strace perf systemtap-sdt-devel.x86_64 -y</code></p>
</blockquote>
<table>
  <thead>
      <tr>
          <th>工具</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>htop</td>
          <td>动态显示系统进程任务</td>
      </tr>
      <tr>
          <td>top</td>
          <td>动态显示系统进程任务</td>
      </tr>
      <tr>
          <td>iotop</td>
          <td>显示进程的磁盘 I/O 信息（iostat 和 top 的结合体）</td>
      </tr>
      <tr>
          <td>slabtop</td>
          <td></td>
      </tr>
      <tr>
          <td>iftop</td>
          <td></td>
      </tr>
      <tr>
          <td>vmstat</td>
          <td>显示进程队列、内存、交换空间、块 I/O、CPU 活动信息</td>
      </tr>
      <tr>
          <td>sysstat</td>
          <td>输出 CPU 的各种统计信息。可以用来分析程序运行时在内核态和用户态的时间</td>
      </tr>
      <tr>
          <td>iostat</td>
          <td>显示当前的网络流量</td>
      </tr>
      <tr>
          <td>pidstat</td>
          <td></td>
      </tr>
      <tr>
          <td>fstat</td>
          <td>输出 CPU、IO 系统和磁盘分区的统计信息。可以用来分析磁盘 I/O、带宽等</td>
      </tr>
      <tr>
          <td>uptime</td>
          <td>显示系统的运行时间和平均负载</td>
      </tr>
      <tr>
          <td>procps</td>
          <td>显示系统内存的使用</td>
      </tr>
      <tr>
          <td>sar</td>
          <td>定时搜集系统的各种状态信息，然后对系统各个时间点的状态进行监控</td>
      </tr>
      <tr>
          <td>pmap</td>
          <td></td>
      </tr>
      <tr>
          <td>iptraf</td>
          <td></td>
      </tr>
      <tr>
          <td>nethogs</td>
          <td></td>
      </tr>
      <tr>
          <td>iperf3</td>
          <td></td>
      </tr>
      <tr>
          <td>strace</td>
          <td></td>
      </tr>
      <tr>
          <td>dtrace</td>
          <td></td>
      </tr>
      <tr>
          <td>ionice</td>
          <td></td>
      </tr>
      <tr>
          <td>nice</td>
          <td></td>
      </tr>
      <tr>
          <td>renice</td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="top命令">top命令</h3>
<p><strong>VIRT：virtual memory usage 虚拟内存</strong></p>
<p>1、进程“需要的”虚拟内存大小，包括进程使用的库、代码、数据等
2、假如进程申请100m的内存，但实际只使用了10m，那么它会增长100m，而不是实际的使用量</p>
<p><strong>RES：resident memory usage 常驻内存</strong>
1、进程当前使用的内存大小，但不包括swap out
2、包含其他进程的共享
3、如果申请100m的内存，实际使用10m，它只增长10m，与VIRT相反
4、关于库占用内存的情况，它只统计加载的库文件所占内存大小
<strong>SHR：shared memory 共享内存</strong>
1、除了自身进程的共享内存，也包括其他进程的共享内存
2、虽然进程只使用了几个共享库的函数，但它包含了整个共享库的大小
3、计算某个进程所占的物理内存大小公式：RES – SHR
4、swap out后，它将会降下来
<strong>DATA</strong>
1、数据占用的内存。如果top没有显示，按f键可以显示出来。
2、真正的该程序要求的数据空间，是真正在运行中要使用的。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">快捷键</th>
          <th style="text-align: left">注释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">1</td>
          <td style="text-align: left">展开逻辑cpu详情</td>
      </tr>
      <tr>
          <td style="text-align: left">u</td>
          <td style="text-align: left">显示指定用户的进程</td>
      </tr>
      <tr>
          <td style="text-align: left">k</td>
          <td style="text-align: left">杀死指定进程</td>
      </tr>
      <tr>
          <td style="text-align: left">c</td>
          <td style="text-align: left">显示命令的完整信息</td>
      </tr>
      <tr>
          <td style="text-align: left">f</td>
          <td style="text-align: left">选择要输出显示的列</td>
      </tr>
      <tr>
          <td style="text-align: left"><Space>或<Enter></td>
          <td style="text-align: left">立即刷新显示</td>
      </tr>
      <tr>
          <td style="text-align: left">l</td>
          <td style="text-align: left">– 关闭或开启第一部分第一行 top 信息的表示</td>
      </tr>
      <tr>
          <td style="text-align: left">t</td>
          <td style="text-align: left">– 关闭或开启第一部分第二行 Tasks 和第三行 Cpus 信息的表示</td>
      </tr>
      <tr>
          <td style="text-align: left">m</td>
          <td style="text-align: left">– 关闭或开启第一部分第四行 Mem 和 第五行 Swap 信息的表示</td>
      </tr>
      <tr>
          <td style="text-align: left">N</td>
          <td style="text-align: left">– 以 PID 的大小的顺序排列表示进程列表</td>
      </tr>
      <tr>
          <td style="text-align: left">P</td>
          <td style="text-align: left">– 以 CPU 占用率大小的顺序排列进程列表</td>
      </tr>
      <tr>
          <td style="text-align: left">M</td>
          <td style="text-align: left">– 以内存占用率大小的顺序排列进程列表</td>
      </tr>
  </tbody>
</table>
<h3 id="iostat命令">iostat命令</h3>
<table>
  <thead>
      <tr>
          <th>选项</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>-c</td>
          <td>仅显示 CPU 统计信息。与 -d 选项互斥</td>
      </tr>
      <tr>
          <td>-d</td>
          <td>仅显示磁盘统计信息。与 -c 选项互斥</td>
      </tr>
      <tr>
          <td>-k</td>
          <td>以 KB 为单位显示每秒的磁盘请求数。默认单位为块</td>
      </tr>
      <tr>
          <td>-m</td>
          <td>以 MB 为单位显示每秒的磁盘请求数。默认单位为块</td>
      </tr>
      <tr>
          <td>-p {device|ALL}</td>
          <td>用于显示块设备及系统分区的统计信息。与 -x 选项互斥</td>
      </tr>
      <tr>
          <td>-x</td>
          <td>输出扩展信息</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@iostat ~<span style="color:#f92672">]</span><span style="color:#75715e"># iostat -x</span>
</span></span><span style="display:flex;"><span>Linux 3.10.0-957.el7.x86_64 <span style="color:#f92672">(</span>redis-uat07-s1<span style="color:#f92672">)</span>    05/27/2025      _x86_64_        <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span> CPU<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>avg-cpu:  %user   %nice %system %iowait  %steal   %idle
</span></span><span style="display:flex;"><span>           2.56    0.00    3.90    0.00    0.00   93.54
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
</span></span><span style="display:flex;"><span>sda               0.00     0.01    0.00    0.29     0.04     8.19    56.11     0.00    0.43   17.40    0.37   0.11   0.00
</span></span><span style="display:flex;"><span>dm-0              0.00     0.00    0.00    0.30     0.03     8.19    54.11     0.00    0.44   18.19    0.38   0.11   0.00
</span></span><span style="display:flex;"><span>dm-1              0.00     0.00    0.00    0.00     0.00     0.00    54.67     0.00    0.33    0.33    0.00   0.30   0.00
</span></span></code></pre></div><p>avg-cpu 部分输出项说明</p>
<table>
  <thead>
      <tr>
          <th>输出项</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%user</td>
          <td>在用户级别运行所使用的 CPU 的百分比</td>
      </tr>
      <tr>
          <td>%nice</td>
          <td>高优先级进程（nice=0）使用的 CPU 的百分比</td>
      </tr>
      <tr>
          <td>%system</td>
          <td>在核心级别（kernel）运行所使用 CPU 的百分比</td>
      </tr>
      <tr>
          <td>%iowait</td>
          <td>CPU 等待硬件 IO 所占用 CPU 的百分比</td>
      </tr>
      <tr>
          <td>%steal</td>
          <td>当管理程序（hypervisor）为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比</td>
      </tr>
      <tr>
          <td>%idle</td>
          <td>CPU 空闲时间的百分比</td>
      </tr>
  </tbody>
</table>
<p>Device 部分基本输出项说明</p>
<table>
  <thead>
      <tr>
          <th>输出项</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Blk_read</td>
          <td>读入的数据总量，单位为块</td>
      </tr>
      <tr>
          <td>Blk_wrtn</td>
          <td>写入的数据总量，单位为块</td>
      </tr>
      <tr>
          <td>kb_read</td>
          <td>读入的数据总量，单位为 KB</td>
      </tr>
      <tr>
          <td>kb_wrtn</td>
          <td>写入的数据总量，单位为 KB</td>
      </tr>
      <tr>
          <td>MB_read</td>
          <td>读入的数据总量，单位为 MB</td>
      </tr>
      <tr>
          <td>MB_wrtn</td>
          <td>写入的数据总量，单位为 MB</td>
      </tr>
      <tr>
          <td>Blk_read/s</td>
          <td>每秒从驱动器读入的数据量，单位为块/s</td>
      </tr>
      <tr>
          <td>Blk_wrtn/s</td>
          <td>每秒向驱动器写入的数据量，单位为块/s</td>
      </tr>
      <tr>
          <td>KB_read/s</td>
          <td>每秒从驱动器读入的数据量，单位为 KB/s</td>
      </tr>
      <tr>
          <td>KB_wrtn/s</td>
          <td>每秒向驱动器写入的数据量，单位为 KB/s</td>
      </tr>
      <tr>
          <td>MB_read/s</td>
          <td>每秒从驱动器读入的数据量，单位为 MB/s</td>
      </tr>
      <tr>
          <td>MB_wrtn/s</td>
          <td>每秒向驱动器写入的数据量，单位为 MB/s</td>
      </tr>
      <tr>
          <td>tps</td>
          <td>每秒向物理设备写入的 IO 传输总量</td>
      </tr>
  </tbody>
</table>
<p>Device 部分扩展输出项说明</p>
<table>
  <thead>
      <tr>
          <th>输出项</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>rrqm/s</td>
          <td>将读入请求合并后，每秒发送到设备的读入请求数</td>
      </tr>
      <tr>
          <td>wrqm/s</td>
          <td>将写入请求合并后，每秒发送到设备的写入请求数</td>
      </tr>
      <tr>
          <td>r/s</td>
          <td>每秒发送到设备的读入请求数</td>
      </tr>
      <tr>
          <td>w/s</td>
          <td>每秒发送到设备的写入请求数</td>
      </tr>
      <tr>
          <td>rkB/s</td>
          <td>每秒从设备读入的数据量，单位为 KB/s</td>
      </tr>
      <tr>
          <td>wkB/s</td>
          <td>每秒向设备写入的数据量，单位为 KB/s</td>
      </tr>
      <tr>
          <td>avgrq-sz</td>
          <td>发送到设备的请求的平均大小，单位为扇区</td>
      </tr>
      <tr>
          <td>avgqu-sz</td>
          <td>发送到设备的请求的平均队列长度</td>
      </tr>
      <tr>
          <td>await</td>
          <td>IO 请求平均执行时间，包括发送请求和执行的时间，单位为毫秒</td>
      </tr>
      <tr>
          <td>r_await</td>
          <td>读入请求平均执行时间，单位为毫秒</td>
      </tr>
      <tr>
          <td>w_await</td>
          <td>写入请求平均执行时间，单位为毫秒</td>
      </tr>
      <tr>
          <td>svctm</td>
          <td>IO 请求在设备上的平均执行时间，单位为毫秒</td>
      </tr>
      <tr>
          <td>%util</td>
          <td>设备利用率，表示设备的忙碌程度，当值接近 100% 时，表示设备带宽已占满</td>
      </tr>
      <tr>
          <td>usec/s</td>
          <td>每秒向设备写入的扇区数</td>
      </tr>
      <tr>
          <td>rMB/s</td>
          <td>每秒从设备读入的数据量，单位为 MB/s</td>
      </tr>
      <tr>
          <td>wMB/s</td>
          <td>每秒向设备写入的数据量，单位为 MB/s</td>
      </tr>
  </tbody>
</table>
<h3 id="vmstat命令">vmstat命令</h3>
<table>
  <thead>
      <tr>
          <th>选项</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>-n</td>
          <td>只在开始时显示一次各字段名称</td>
      </tr>
      <tr>
          <td>-a</td>
          <td>显示活跃和非活跃内存</td>
      </tr>
      <tr>
          <td>-m</td>
          <td>显示 procs/abinfo</td>
      </tr>
      <tr>
          <td>-S</td>
          <td>使用指定单位显示，K(1000)、K(1024)、M(1000000)、M(1048576) 字节，默认单位为 K</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@vmstat ~<span style="color:#f92672">]</span><span style="color:#75715e"># vmstat  5</span>
</span></span><span style="display:flex;"><span>procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
</span></span><span style="display:flex;"><span> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">159304</span>     <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">1821284</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">4</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">3</span>  <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">94</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>输出结果字段说明</p>
<table>
  <thead>
      <tr>
          <th>分类</th>
          <th>输出项</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>procs</td>
          <td>r</td>
          <td>在运行队列中等待运行的进程数</td>
      </tr>
      <tr>
          <td></td>
          <td>b</td>
          <td>等待 IO 的进程数</td>
      </tr>
      <tr>
          <td>memory (默认单位为 KB)</td>
          <td>swpd</td>
          <td>当前使用的交换空间</td>
      </tr>
      <tr>
          <td></td>
          <td>free</td>
          <td>当前空闲的物理内存</td>
      </tr>
      <tr>
          <td></td>
          <td>buff</td>
          <td>用作缓冲的内存大小</td>
      </tr>
      <tr>
          <td></td>
          <td>cache</td>
          <td>用作缓存的内存大小</td>
      </tr>
      <tr>
          <td></td>
          <td>inactive</td>
          <td>非活跃的内存大小（当使用 -a 选项时显示）</td>
      </tr>
      <tr>
          <td></td>
          <td>active</td>
          <td>活跃的内存大小（当使用 -a 选项时显示）</td>
      </tr>
      <tr>
          <td>swap</td>
          <td>si</td>
          <td>每秒写入交换区的内存大小</td>
      </tr>
      <tr>
          <td></td>
          <td>so</td>
          <td>每秒写入交换区的内存大小</td>
      </tr>
      <tr>
          <td>io</td>
          <td>bi</td>
          <td>每秒读取块设备的块数</td>
      </tr>
      <tr>
          <td></td>
          <td>bo</td>
          <td>每秒写入块设备的块数</td>
      </tr>
      <tr>
          <td>system</td>
          <td>in</td>
          <td>每秒的中断数，包括时钟中断</td>
      </tr>
      <tr>
          <td></td>
          <td>cs</td>
          <td>每秒的环境（上下文）切换次数</td>
      </tr>
      <tr>
          <td>cpu</td>
          <td>us</td>
          <td>用户进程执行时间的百分比</td>
      </tr>
      <tr>
          <td></td>
          <td>sy</td>
          <td>系统进程执行时间的百分比</td>
      </tr>
      <tr>
          <td></td>
          <td>id</td>
          <td>空闲时间（包括等待 IO 时间）的百分比</td>
      </tr>
      <tr>
          <td></td>
          <td>wa</td>
          <td>等待 IO 时间的百分比</td>
      </tr>
      <tr>
          <td></td>
          <td>st</td>
          <td>管理程序（hypervisor）为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比</td>
      </tr>
  </tbody>
</table>
<h3 id="mpstat命令">mpstat命令</h3>
<blockquote>
<p>mpstat 通过分析 <code>/proc/stat</code> 文件报告cpu相关信息</p>
</blockquote>
<p>输出结果字段说明</p>
<table>
  <thead>
      <tr>
          <th>输出项</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%user</td>
          <td>在多 CPU 系统里，每个 CPU 有一个 ID 号。第一个 CPU 为 0，all 表示统计信息为所有 CPU 的平均值</td>
      </tr>
      <tr>
          <td>%nice</td>
          <td>显示在用户级别运行所占用 CPU 总时间的百分比</td>
      </tr>
      <tr>
          <td>%system</td>
          <td>显示在核心级别（kernel）运行所占用 CPU 总时间的百分比。这个值并不包括服务中断和 softirq</td>
      </tr>
      <tr>
          <td>%iowait</td>
          <td>显示用于等待 IO 操作中，占用 CPU 总时间的百分比</td>
      </tr>
      <tr>
          <td>%steal</td>
          <td>显示用于虚拟机管理程序（hypervisor）为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比</td>
      </tr>
      <tr>
          <td>%idle</td>
          <td>显示 CPU 在空闲状态，占用 CPU 总时间的百分比</td>
      </tr>
      <tr>
          <td>intr/s</td>
          <td>显示 CPU 每秒接收到的中断总数</td>
      </tr>
  </tbody>
</table>
<h3 id="sar命令">sar命令</h3>
<blockquote>
<p>用于收集、报告、保存系统活跃信息</p>
</blockquote>
<p>在<code>sar</code>的基础上增加 <code>sar [ interval [ count ] ]</code>选项。可以指定统计间隔和统计次数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sar 1 2</span>
</span></span><span style="display:flex;"><span>Linux 3.10.0-1160.92.1.el7.x86_64 <span style="color:#f92672">(</span>master01<span style="color:#f92672">)</span>    10/03/2023      _x86_64_        <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span> CPU<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>11:20:15 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
</span></span><span style="display:flex;"><span>11:20:16 AM     all      4.11      0.00      4.38      0.00      0.00     91.51
</span></span><span style="display:flex;"><span>11:20:17 AM     all      2.79      0.00      5.29      0.00      0.00     91.92
</span></span><span style="display:flex;"><span>Average:        all      3.45      0.00      4.83      0.00      0.00     91.71
</span></span></code></pre></div><p>将 <code>sar [ interval [ count ] ] -o datafile</code> 命令结果输出到文件中。</p>
<p>举例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sar -o datafile <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span> &gt;/dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span> &amp;
</span></span></code></pre></div><p>查看datafile 中的内容 :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sar -f ./datafile 
</span></span></code></pre></div><p>查看cpu状态</p>
<p><code>sar -u 1 2 </code> 查看cpu的统计信息，此时和 <code>sar 1 2</code> 结果一样</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sar -u 1 2</span>
</span></span><span style="display:flex;"><span>Linux 3.10.0-1160.92.1.el7.x86_64 <span style="color:#f92672">(</span>master01<span style="color:#f92672">)</span>    10/03/2023      _x86_64_        <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span> CPU<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>11:22:44 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
</span></span><span style="display:flex;"><span>11:22:45 AM     all      2.41      0.00      4.83      0.00      0.00     92.76
</span></span><span style="display:flex;"><span>11:22:46 AM     all      2.66      0.00      3.99      0.00      0.00     93.35
</span></span><span style="display:flex;"><span>Average:        all      2.54      0.00      4.41      0.00      0.00     93.06
</span></span></code></pre></div><p><code>sar -P 0 1 2</code> 查看cpu0的统计信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sar  -P 0 1 2 </span>
</span></span><span style="display:flex;"><span>Linux 3.10.0-1160.92.1.el7.x86_64 <span style="color:#f92672">(</span>master01<span style="color:#f92672">)</span>    10/03/2023      _x86_64_        <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span> CPU<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>11:19:19 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
</span></span><span style="display:flex;"><span>11:19:20 AM       <span style="color:#ae81ff">0</span>      5.26      0.00      2.11      0.00      0.00     92.63
</span></span><span style="display:flex;"><span>11:19:21 AM       <span style="color:#ae81ff">0</span>      2.08      0.00      5.21      0.00      0.00     92.71
</span></span><span style="display:flex;"><span>Average:          <span style="color:#ae81ff">0</span>      3.66      0.00      3.66      0.00      0.00     92.67
</span></span></code></pre></div><p><code>sar -P ALL 1 2</code> 展开显示所有核心的统计信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sar -P ALL 1 2 </span>
</span></span><span style="display:flex;"><span>Linux 3.10.0-1160.92.1.el7.x86_64 <span style="color:#f92672">(</span>master01<span style="color:#f92672">)</span>    10/03/2023      _x86_64_        <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span> CPU<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>11:26:58 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
</span></span><span style="display:flex;"><span>11:26:59 AM     all      2.70      0.00      4.59      0.00      0.00     92.70
</span></span><span style="display:flex;"><span>11:26:59 AM       <span style="color:#ae81ff">0</span>      3.37      0.00      3.37      0.00      0.00     93.26
</span></span><span style="display:flex;"><span>11:26:59 AM       <span style="color:#ae81ff">1</span>      3.30      0.00      4.40      0.00      0.00     92.31
</span></span><span style="display:flex;"><span>11:26:59 AM       <span style="color:#ae81ff">2</span>      3.09      0.00      5.15      0.00      0.00     91.75
</span></span><span style="display:flex;"><span>11:26:59 AM       <span style="color:#ae81ff">3</span>      3.23      0.00      4.30      0.00      0.00     92.47
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>11:26:59 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
</span></span><span style="display:flex;"><span>11:27:00 AM     all      3.98      0.00      2.39      0.00      0.00     93.63
</span></span><span style="display:flex;"><span>11:27:00 AM       <span style="color:#ae81ff">0</span>      2.13      0.00      3.19      0.00      0.00     94.68
</span></span><span style="display:flex;"><span>11:27:00 AM       <span style="color:#ae81ff">1</span>      6.32      0.00      4.21      0.00      0.00     89.47
</span></span><span style="display:flex;"><span>11:27:00 AM       <span style="color:#ae81ff">2</span>      3.16      0.00      2.11      0.00      0.00     94.74
</span></span><span style="display:flex;"><span>11:27:00 AM       <span style="color:#ae81ff">3</span>      3.12      0.00      3.12      0.00      0.00     93.75
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Average:        CPU     %user     %nice   %system   %iowait    %steal     %idle
</span></span><span style="display:flex;"><span>Average:        all      3.35      0.00      3.48      0.00      0.00     93.17
</span></span><span style="display:flex;"><span>Average:          <span style="color:#ae81ff">0</span>      2.73      0.00      3.28      0.00      0.00     93.99
</span></span><span style="display:flex;"><span>Average:          <span style="color:#ae81ff">1</span>      4.84      0.00      4.30      0.00      0.00     90.86
</span></span><span style="display:flex;"><span>Average:          <span style="color:#ae81ff">2</span>      3.12      0.00      3.65      0.00      0.00     93.23
</span></span><span style="display:flex;"><span>Average:          <span style="color:#ae81ff">3</span>      3.17      0.00      3.70      0.00      0.00     93.12
</span></span></code></pre></div><h3 id="lsof命令">lsof命令</h3>
<p>Lsof是遵从Unix哲学的典范，它只完成一个功能，并且做的相当完美——它可以列出某个进程打开的所有文件信息。打开的文件可能是普通的文件、目录、NFS文件、块文件、字符文件、共享库、常规管道、命名管道、符号链接、Socket流、网络Socket、UNIX域Socket，以及其它更多类型。因为“一切皆文件”乃为Unix系统的重要哲学思想之一，因此可以想象lsof命令的重要地位。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lsof ［options］ filename
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lsof  /path/to/somefile：显示打开指定文件的所有进程之列表
</span></span><span style="display:flex;"><span>lsof -c string：显示其COMMAND列中包含指定字符<span style="color:#f92672">(</span>string<span style="color:#f92672">)</span>的进程所有打开的文件；此选项可以重复使用，以指定多个模式；
</span></span><span style="display:flex;"><span>lsof -p PID：查看该进程打开了哪些文件；进程号前可以使用脱字符“^”取反；
</span></span><span style="display:flex;"><span>lsof -u USERNAME：显示指定用户的进程打开的文件；用户名前可以使用脱字符“^”取反，如“lsof -u ^root”则用于显示非root用户打开的所有文件；
</span></span><span style="display:flex;"><span>lsof -g GID：显示归属gid的进程情况
</span></span><span style="display:flex;"><span>lsof +d /DIR/：显示指定目录下被进程打开的文件
</span></span><span style="display:flex;"><span>lsof +D /DIR/：基本功能同上，但lsof会对指定目录进行递归查找，注意这个参数要比grep版本慢：
</span></span><span style="display:flex;"><span>lsof -a：按“与”组合多个条件，如lsof -a -c apache -u apache
</span></span><span style="display:flex;"><span>lsof -N：列出所有NFS（网络文件系统）文件
</span></span><span style="display:flex;"><span>lsof -d FD：显示指定文件描述符的相关进程；也可以为描述符指定一个范围，如0-2表示0,1,2三个文件描述符；另外，-d还支持其它很多特殊值，如：
</span></span><span style="display:flex;"><span>	mem: 列出所有内存映射文件；
</span></span><span style="display:flex;"><span>	mmap：显示所有内存映射设备；
</span></span><span style="display:flex;"><span>	txt：列出所有加载在内存中并正在执行的进程，包含code和data；
</span></span><span style="display:flex;"><span>	cwd：正在访问当前目录的进程列表；
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>lsof -n：不反解IP至HOSTNAME
</span></span><span style="display:flex;"><span>lsof -i：用以显示符合条件的进程情况
</span></span><span style="display:flex;"><span>lsof -i<span style="color:#f92672">[</span>46<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>protocol<span style="color:#f92672">][</span>@hostname|hostaddr<span style="color:#f92672">][</span>:service|port<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	46：IPv4或IPv6
</span></span><span style="display:flex;"><span>	protocol：TCP or UDP
</span></span><span style="display:flex;"><span>	hostname：Internet host name
</span></span><span style="display:flex;"><span>	hostaddr：IPv4地址
</span></span><span style="display:flex;"><span>	service：/etc/service中的服务名称<span style="color:#f92672">(</span>可以不只一个<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	port：端口号 <span style="color:#f92672">(</span>可以不只一个<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>例如： 查看22端口现在运行的情况
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@www ~<span style="color:#f92672">]</span><span style="color:#75715e"># lsof -i :22</span>
</span></span><span style="display:flex;"><span>COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>sshd     <span style="color:#ae81ff">1390</span> root    3u  IPv4  <span style="color:#ae81ff">13050</span>      0t0  TCP *:ssh <span style="color:#f92672">(</span>LISTEN<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>sshd     <span style="color:#ae81ff">1390</span> root    4u  IPv6  <span style="color:#ae81ff">13056</span>      0t0  TCP *:ssh <span style="color:#f92672">(</span>LISTEN<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>sshd    <span style="color:#ae81ff">36454</span> root    3r  IPv4  <span style="color:#ae81ff">94352</span>      0t0  TCP www.magedu.com:ssh-&gt;172.16.0.1:50018 <span style="color:#f92672">(</span>ESTABLISHED<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>上述命令中，每行显示一个打开的文件，若不指定条件默认将显示所有进程打开的所有文件。lsof输出各列信息的意义如下：
</span></span><span style="display:flex;"><span>	COMMAND：进程的名称
</span></span><span style="display:flex;"><span>	PID：进程标识符
</span></span><span style="display:flex;"><span>	USER：进程所有者
</span></span><span style="display:flex;"><span>	FD：文件描述符，应用程序通过文件描述符识别该文件。如cwd、txt等
</span></span><span style="display:flex;"><span>	TYPE：文件类型，如DIR、REG等
</span></span><span style="display:flex;"><span>	DEVICE：指定磁盘的名称
</span></span><span style="display:flex;"><span>	SIZE：文件的大小
</span></span><span style="display:flex;"><span>	NODE：索引节点（文件在磁盘上的标识）
</span></span><span style="display:flex;"><span>	NAME：打开文件的确切名称
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-aabda7bf6d1a96b643d9cd390156de59">常用命令</h1>
	<div class="lead">command|linux</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-21" class="text-body-secondary">Wednesday, May 21, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<div class="td-card-group card-group p-0 mb-4">
  <div class="td-card card border me-4">
<div class="card-header">
      <strong>文本处理</strong>
    </div>
<div class="card-body">
    <p class="card-text">
        
  <a href="#mkdir">mkdir</a>, <a href="#touch">touch</a>, <a href="#mktemp">mktemp</a>, <a href="#ln">ln</a>, 
  <a href="#tar">tar</a>, <a href="#gzip">gzip</a>, <a href="#zip">zip</a>, <a href="#unzip">unzip</a>, 
  <a href="#grep">grep</a>, <a href="#sed">sed</a>, <a href="#awk">awk</a>, <a href="#tr">tr</a>, <a href="#sort">sort</a>, <a href="#uniq">uniq</a>, <a href="#more">more</a>, <a href="#less">less</a>, <a href="#dd">dd</a>, <a href="#echo">echo</a>, <a href="#printf">printf</a>,
  <a href="#tail">tail</a>, <a href="#tailf">tailf</a>, <a href="#head">head</a>, <a href="#stat">stat</a>, <a href="#wc">wc</a>, <a href="#cat">cat</a>, <a href="#tac">tac</a>, <a href="#nl">nl</a>, <a href="#tee">tee</a>, <a href="#cut">cut</a>, <a href="#source">source</a>, <a href="#read">read</a>, <a href="#seq">seq</a>, 
  <a href="#find">find</a>, <a href="#xargs">xargs</a>, <a href="#exec">exec</a>, <a href="#expr">expr</a>, <a href="#install">install</a>,  <a href="#test">test</a>,   <a href="#eval">eval</a>, 
  <a href="#base64">base64</a>, <a href="#openssl">openssl</a>, <a href="#cfssl">cfssl</a>
  </p>
      </div>
  </div>

  <div class="td-card card border me-4">
<div class="card-header">
      <strong>系统命令</strong>
    </div>
<div class="card-body">
    <p class="card-text">
        
  <a href="#top">top/htop</a>, <a href="#vmstat">vmstat</a>, <a href="#sar">sar</a>, <a href="#iostat">iostat</a>, <a href="#ionice">ionice</a>, <a href="#taskset">taskset</a>, <a href="#uptime">uptime</a>, <a href="#journalctl">journalctl</a>, <a href="#lsmem">lsmem</a>, <a href="#lscpu">lscpu</a>, <a href="#crontab">crontab</a>, <a href="#at">at</a>, <a href="#hostname">hostname</a>, <a href="#halt">halt</a>, <a href="#init">init</a>, <a href="#chkconfig">chkconfig</a>, <a href="#ntpdate">ntpdate</a>, <a href="#chronyd">chronyd</a>, <a href="#ps">ps</a>, <a href="#pstree">pstree</a>, <a href="#pgrep">pgrep</a>, <a href="#pidof">pidof</a>, <a href="#kill">kill</a>, <a href="#killall">killall</a>, <a href="#runlevel">runlevel</a>, <a href="#free">free</a>, <a href="#dmidecode">dmidecode</a>, <a href="#date">date</a>, <a href="#yum">yum</a>, <a href="#rpm">rpm</a>, <a href="#getent">getent</a>, <a href="#info">info</a>, <a href="#man">man</a>, <a href="#lz">lz</a>, <a href="#sz">sz</a>
  </p>
      </div>
  </div>

  <div class="td-card card border me-4">
<div class="card-header">
      <strong>网络管理</strong>
    </div>
<div class="card-body">
    <p class="card-text">
        
  <a href="#curl">curl</a>, <a href="#wget">wget</a>, <a href="#dig">dig</a>, <a href="#nc">nc</a>, <a href="#tcpdump">tcpdump</a>, <a href="#nmap">nmap</a>, <a href="#telnet">telnet</a>, <a href="#ip">ip</a>, <a href="#ifconfig">ifconfig</a>, <a href="#route">route</a>, <a href="#ifup">ifup</a>, <a href="#ifdown">ifdown</a>, <a href="#brctl">brctl</a>
  </p>
      </div>
  </div>

  <div class="td-card card border me-4">
<div class="card-header">
      <strong>磁盘管理</strong>
    </div>
<div class="card-body">
    <p class="card-text">
        
  <a href="#df">df</a>, <a href="#du">du</a>, <a href="#fdisk">fdisk</a>, <a href="#parted">parted</a>,<a href="#mount">mount</a>, <a href="#showmount">showmount</a>, <a href="#lsblk">lsblk</a>, <a href="#blkid">blkid</a>, <a href="#fsdump">fsdump</a>
  </p>
      </div>
  </div>

</div>

<p><span id=date><strong>date</strong></span></p>
<ul>
<li>查看时区: <code>date -R </code></li>
<li>获取当前时间时间戳: <code>date +%s</code></li>
<li>时间戳格式化为时间格式: <code>date -d @1674108177 +&quot;%F %H:%m%S&quot;</code></li>
<li>时间格式格式化为时间戳: <code> date -d &quot;2023-01-19 14:01:57&quot; +%s</code></li>
</ul>
<p><span id=yum><strong>yum</strong></span></p>
<ul>
<li>列出软件包可以用的版本: <code>yum search --showduplicates docker</code></li>
<li>查看软件包信息: <code>yum info docker</code></li>
</ul>
<p><span id=rpm><strong>rpm</strong></span></p>
<ul>
<li>
<p>查看rpm包是否安装: <code>rpm -qa docker</code></p>
</li>
<li>
<p>列出软件包相关文件: <code>rpm -ql docker</code></p>
</li>
</ul>
<p><span id=getent ><strong>getent</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># grep ^root /etc/passwd</span>
</span></span><span style="display:flex;"><span>getent passwd root
</span></span></code></pre></div><p><span id=read><strong>read</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-p    指定提示符  
</span></span><span style="display:flex;"><span>-t    指定超时时间
</span></span><span style="display:flex;"><span>-s    隐藏输入内容
</span></span><span style="display:flex;"><span>-u    读取文件描述符
</span></span><span style="display:flex;"><span>-n    读取指定字符后自动回车 例如： read -n <span style="color:#ae81ff">1</span> -p <span style="color:#e6db74">&#34;将在你输入第一个字符后自动回车：&#34;</span>
</span></span><span style="display:flex;"><span>REPLY 默认接受键盘的输入的变量名
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#read -t 30 -p &#34;please input firstname:&#34; firstname</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#echo $firstname</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#read -t 30 -p &#34;please input firstname:&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#echo $REPLY</span>
</span></span></code></pre></div><p><span id=stat><strong>stat</strong></span></p>
<ul>
<li>获取文件的权限信息: <code>stat -c %A /etc/services</code></li>
<li>获取文件的权限信息: <code>stat -c %a /etc/services</code></li>
<li>获取文件的大小: <code>stat -c %s /etc/services</code></li>
</ul>
<p><span id=echo><strong>echo</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo -e 
</span></span><span style="display:flex;"><span>转义
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\a</span> 发出警告声； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\b</span> 删除前一个字符； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\c</span> 最后不加上换行符号； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\f</span> 换行但光标仍旧停留在原来的位置； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\n</span> 换行且光标移至行首； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\r</span> 光标移至行首，但不换行； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\t</span> 插入tab； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\v</span> 与<span style="color:#ae81ff">\f</span>相同； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\\</span> 插入<span style="color:#ae81ff">\字</span>符； 
</span></span><span style="display:flex;"><span>　　　　<span style="color:#ae81ff">\n</span>nn 插入nnn（八进制）所代表的ASCII字符；
</span></span></code></pre></div><p><span id=printf><strong>printf</strong></span></p>
<p>优势就在于格式化处理字符串</p>

  
  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="格式化字符" aria-controls="tabs-01-00" aria-selected="true">
        格式化字符
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="转义字符" aria-controls="tabs-01-01" aria-selected="false">
        转义字符
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="对齐和精度" aria-controls="tabs-01-02" aria-selected="false">
        对齐和精度
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <table>
  <thead>
      <tr>
          <th>格式符</th>
          <th>描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%s</td>
          <td>字符串</td>
      </tr>
      <tr>
          <td>%f</td>
          <td>浮点格式</td>
      </tr>
      <tr>
          <td>%b</td>
          <td>转义字符会被转义</td>
      </tr>
      <tr>
          <td>%c</td>
          <td>ASCII字符，显示对应参数的第一个字符</td>
      </tr>
      <tr>
          <td>%d, %i</td>
          <td>十进制整数</td>
      </tr>
      <tr>
          <td>%o</td>
          <td>不带正负号的八进制值</td>
      </tr>
      <tr>
          <td>%u</td>
          <td>不带正负号的十进制值</td>
      </tr>
      <tr>
          <td>%x</td>
          <td>不带正负号的十六进制值，用a到f表示10至15</td>
      </tr>
      <tr>
          <td>%X</td>
          <td>不带正负号的十六进制值，用A到F表示10至15</td>
      </tr>
      <tr>
          <td>%%</td>
          <td>表示‘%’本身</td>
      </tr>
  </tbody>
</table>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <table>
  <thead>
      <tr>
          <th>转义字符</th>
          <th>描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>\a</td>
          <td>警告字符，常为ASCII的BEL字符</td>
      </tr>
      <tr>
          <td>\b</td>
          <td>后退</td>
      </tr>
      <tr>
          <td>\c</td>
          <td>不显示输出结果中任何结尾的换行字符</td>
      </tr>
      <tr>
          <td>\f</td>
          <td>换页（formfeed）</td>
      </tr>
      <tr>
          <td>\n</td>
          <td>换行</td>
      </tr>
      <tr>
          <td>\r</td>
          <td>回车</td>
      </tr>
      <tr>
          <td>\t</td>
          <td>水平制表符</td>
      </tr>
      <tr>
          <td>\v</td>
          <td>垂直制表符</td>
      </tr>
      <tr>
          <td>\</td>
          <td>“\”本身</td>
      </tr>
      <tr>
          <td>\ddd</td>
          <td>表示1到3位数八进制值得字符串，仅在字符格式串中有效</td>
      </tr>
      <tr>
          <td>\0ddd</td>
          <td>表示1到3位数八进制值得字符串</td>
      </tr>
  </tbody>
</table>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <table>
  <thead>
      <tr>
          <th>对齐和精度控制格式符</th>
          <th>描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%7s</td>
          <td>当前替换符对应的输出长度为7个字符宽，不足补齐，超出也正常显示</td>
      </tr>
      <tr>
          <td>%-7s</td>
          <td>“-”，表示左对齐，不加时，是右对齐</td>
      </tr>
      <tr>
          <td>%+5d</td>
          <td>正数会自动变为+num</td>
      </tr>
      <tr>
          <td>%12.3f</td>
          <td>“.3”表示保留小数点后三位，%f默认是小数点后6位</td>
      </tr>
      <tr>
          <td>%12.5d</td>
          <td>“.5”表示整数的长度，不足用0补齐</td>
      </tr>
  </tbody>
</table>

    </div>
</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;%s\n&#34;</span> <span style="color:#f92672">{</span>1..20<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;%10s\n&#34;</span> <span style="color:#f92672">{</span>1..20<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;%-10s\n&#34;</span> <span style="color:#f92672">{</span>1..20<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;%2.2f\n&#34;</span> <span style="color:#f92672">{</span>1..20<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;%2d\n&#34;</span> <span style="color:#f92672">{</span>1..20<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;(%d)\n&#34;</span> <span style="color:#f92672">{</span>1..20<span style="color:#f92672">}</span> 
</span></span></code></pre></div><p><span id=sort><strong>sort</strong></span></p>
<ul>
<li>按照ASCII 排序: <code>sort /etc/hosts</code></li>
<li>排序并去除重复行: <code>sort -u /etc/hosts</code></li>
<li>按照ASCII  逆序: <code>sort -r /etc/hosts</code></li>
<li>按照数字排序: <code>sort -n /etc/hosts</code></li>
<li>按照月份排序: <code>sort -M /etc/hosts</code></li>
<li>按照指定分隔符分割后，指定列排序: <code>sort -t &quot;:&quot; -k 3 -n /etc/passwd</code></li>
</ul>
<p><span id=uniq><strong>uniq</strong></span></p>
<ul>
<li>查看文件内容等同cat: <code>uniq /etc/hosts</code></li>
<li>只显示重复行: <code>uniq -d /etc/hosts</code></li>
<li>去重重复行显示: <code>uniq -u /etc/hosts</code></li>
<li>显示重复行出现的次数: <code>uniq -c /etc/hosts</code></li>
</ul>
<p><span id=uniq><strong>wc</strong></span></p>
<ul>
<li>统计文本函数: <code>wc -l /etc/hosts</code></li>
<li>统计文本字数: <code>wc -w /etc/hosts</code></li>
<li>统计文本字节数: <code>wc -c /etc/hosts</code></li>
<li>统计文本中最长一行包含的字节数: <code>wc -L /etc/hosts</code></li>
</ul>
<p><span id=seq><strong>seq</strong></span></p>
<p>语法	<font color=red> <strong><code>命令格式seq [OPTION]... FIRST INCREMENT LAST</code></strong></font></p>
<ul>
<li>从2开始到10结尾步长为1：<code>seq 2 10</code></li>
<li>从2开始到10结尾步长为2: <code>seq 2 2 10</code></li>
<li>从2开始到10结尾步长为2，等宽显示: <code>seq -w 2 2 10</code></li>
<li>从2开始到10结尾步长为2，等宽显示.修改分隔符为空格: <code>seq -s &quot; &quot; -w 2 2 10</code></li>
</ul>
<p><span id=cut><strong>cut</strong></span></p>
<p>语法：<font color=red> <code>cut OPTION... [FILE]</code></font></p>
<ul>
<li>按照字符串截取: <code>echo &quot;http://127.0.0.1/#/zh-cn/bash&quot;|cut -c 1-4,8-10</code></li>
<li>按照字符串截取,1-  表示从第一个字符到结尾: <code>echo &quot;http://127.0.0.1/#/zh-cn/bash&quot;|cut -c 1-</code></li>
<li>按照字符串截取,-5  表示从第一个字符到结尾: <code>echo &quot;http://127.0.0.1/#/zh-cn/bash&quot;|cut -c -5</code></li>
<li>按照分隔符截取: <code>echo &quot;http://127.0.0.1/#/zh-cn/bash&quot;|cut -d '/' -f1,2,3</code></li>
</ul>
<p><span id=tr><strong>tr</strong></span></p>
<p><em>translate or delete characters</em></p>
<p>删除:	<code>echo {a..z}{1..10}|tr -d [0-9]</code></p>
<p>替换:	<code>echo {a..z}{1..10}|tr [a-z] [A-Z]</code></p>
<p><span id=find><strong>find</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>find  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>!<span style="color:#f92672">]</span>-type 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>!<span style="color:#f92672">]</span>--maxdepth levels
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>!<span style="color:#f92672">]</span>-name 
</span></span><span style="display:flex;"><span>    -o   或  
</span></span><span style="display:flex;"><span>    -a   and
</span></span><span style="display:flex;"><span>    -mtime +-7
</span></span><span style="display:flex;"><span>    -ctime +-7 
</span></span><span style="display:flex;"><span>    -atime +-7
</span></span><span style="display:flex;"><span>    -perm
</span></span><span style="display:flex;"><span>    -user &lt;username&gt;
</span></span><span style="display:flex;"><span>    -group &lt;groupname&gt;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>find / -type f -name curl -or -name wget -perm <span style="color:#ae81ff">755</span>
</span></span><span style="display:flex;"><span>find /etc -name <span style="color:#e6db74">&#34;host*&#34;</span> -print
</span></span><span style="display:flex;"><span>find /etc -name <span style="color:#e6db74">&#34;host*&#34;</span> -print0
</span></span><span style="display:flex;"><span>find / -nouser -a -nogroup
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查找时排除指定文件夹./rules_file</span>
</span></span><span style="display:flex;"><span>find . -path <span style="color:#e6db74">&#34;./rules_file&#34;</span> -prune -o -print
</span></span></code></pre></div><p><span id=expr><strong>expr</strong></span></p>
<ul>
<li>计算字符串长度: <code>expr length &quot;hello world&quot;</code></li>
<li>模式匹配</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#e6db74">&#39;STRING : REGEX&#39;</span>
</span></span><span style="display:flex;"><span>     执行模式匹配。两端参数会转换为字符格式，且第二个参数被视为正则表达式<span style="color:#f92672">(</span>GNU基本正则<span style="color:#f92672">)</span>，它默认会隐含前缀<span style="color:#e6db74">&#34;^&#34;</span>。随后将第一个参数和正则模式做匹配。
</span></span><span style="display:flex;"><span>     如果匹配成功，且REGEX使用了<span style="color:#e6db74">&#39;\(&#39;</span>和<span style="color:#e6db74">&#39;\)&#39;</span>，则此表达式返回匹配到的，如果未使用<span style="color:#e6db74">&#39;\(&#39;</span>和<span style="color:#e6db74">&#39;\)&#39;</span>，则返回匹配的字符数。
</span></span><span style="display:flex;"><span>     如果匹配失败，如果REGEX中使用了<span style="color:#e6db74">&#39;\(&#39;</span>和<span style="color:#e6db74">&#39;\)&#39;</span>，则此表达式返回空字符串，否则返回为0。
</span></span><span style="display:flex;"><span>     只有第一个<span style="color:#e6db74">&#39;\(...\)&#39;</span>会引用返回的值；其余的<span style="color:#e6db74">&#39;\(...\)&#39;</span>只在正则表达式分组时有意义。
</span></span><span style="display:flex;"><span>     在正则表达式中，<span style="color:#e6db74">&#39;\+&#39;</span>，<span style="color:#e6db74">&#39;\?&#39;</span>和<span style="color:#e6db74">&#39;\|&#39;</span>分表代表匹配一个或多个，0个或1个以及两端任选其一的意思
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@allinone ~<span style="color:#f92672">]</span><span style="color:#75715e"># expr &#34;423-46-7&#34; : &#34;\([0-9]\{,3\}-[0-9]\{,3\}-[0-9]\{,3\}\)&#34;</span>
</span></span><span style="display:flex;"><span>423-46-7
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@allinone ~<span style="color:#f92672">]</span><span style="color:#75715e"># expr &#34;423-46-7&#34; : &#34;[0-9]\{,3\}-[0-9]\{,3\}-[0-9]\{,3\}&#34;    </span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span>
</span></span></code></pre></div><p><span id=mktemp><strong>mktemp</strong></span></p>
<p>创建临时的文件：<code>mktemp</code>
创建临时的命名文件: <code>mktemp -t test.XXXXXXXXXX</code>
创建一个临时目录 <code>mktemp -d</code>
创建一个临时命名目录 <code>mktemp -d test.XXXXXXXXXX</code></p>
<p><span id=install><strong>install</strong></span></p>
<p>是mkdir 、copy 、chown、chmod等命令的复合体</p>
<ul>
<li>创建目录，并授予权限。所有者nginx,所属组nginx 权限7777 类型为目录: <code>install -o nginx -g nginx -m 7777 -d /tmp/456</code></li>
<li>拷贝文件： <code>install -m 755 /etc/hosts /tmp</code></li>
</ul>
<p><span id=install><strong>base64</strong></span></p>
<p>base64加密: <code>echo &quot;123&quot;|base64</code>
base64解码 : <code>echo $(echo 123|base64)|base64 -d</code></p>
<p><span id=test><strong>test</strong></span></p>
<table>
  <thead>
      <tr>
          <th>参数</th>
          <th>代表意义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>-e</td>
          <td>该【文件名】是否存在（常用）</td>
      </tr>
      <tr>
          <td>-f</td>
          <td>该【文件名】是否存在且为文件（file）（常用）</td>
      </tr>
      <tr>
          <td>-d</td>
          <td>该【文件名】是否存在且为目录（directory）</td>
      </tr>
      <tr>
          <td>-b</td>
          <td>该【文件名】是否存在且为 block device 设备</td>
      </tr>
      <tr>
          <td>-c</td>
          <td>该【文件名】是否存在且为 character device 设备</td>
      </tr>
      <tr>
          <td>-S</td>
          <td>该【文件名】是否存在且为 socket 文件</td>
      </tr>
      <tr>
          <td>-p</td>
          <td>该【文件名】是否存在且为 FIFO (pipe) 文件</td>
      </tr>
      <tr>
          <td>-L</td>
          <td>该【文件名】是否存在且为一个链接文件</td>
      </tr>
      <tr>
          <td>-r</td>
          <td>检测该文件名是否存在且具有【可读】的权限</td>
      </tr>
      <tr>
          <td>-w</td>
          <td>检测该文件名是否存在且具有【可写】的权限</td>
      </tr>
      <tr>
          <td>-x</td>
          <td>检测该文件名是否存在且具有【可执行】的权限</td>
      </tr>
      <tr>
          <td>-u</td>
          <td>检测该文件名是否存在且具有【SUID】的属性</td>
      </tr>
      <tr>
          <td>-g</td>
          <td>检测该文件名是否存在且具有【SGID】的属性</td>
      </tr>
      <tr>
          <td>-k</td>
          <td>检测该文件名是否存在且具有【Sticky bit】的属性</td>
      </tr>
      <tr>
          <td>-s</td>
          <td>检测该文件名是否存在且为【非空文件】</td>
      </tr>
      <tr>
          <td>-nt</td>
          <td>两个文件之间的比较，如：test file1 -nt file2（newer than）判断 file1 是否比 file2 新</td>
      </tr>
      <tr>
          <td>-ot</td>
          <td>（older than）判断 file1 是否比 file2 旧</td>
      </tr>
      <tr>
          <td>-ef</td>
          <td>判断 file1 与 file2 是否为同一文件，可用在判断 hard link 的判定上。主要意义在判断两个文件是否均指向同一个 inode</td>
      </tr>
      <tr>
          <td>-eq</td>
          <td>两数值相等（equal）</td>
      </tr>
      <tr>
          <td>-ne</td>
          <td>两数值不等（not equal）</td>
      </tr>
      <tr>
          <td>-gt</td>
          <td>n1 大于 n2（greater than）</td>
      </tr>
      <tr>
          <td>-lt</td>
          <td>n1 小于 n2（less than）</td>
      </tr>
      <tr>
          <td>-ge</td>
          <td>n1 大于等于 n2（greater than or equal）</td>
      </tr>
      <tr>
          <td>-le</td>
          <td>n1 小于等于 n2（less than or equal）</td>
      </tr>
      <tr>
          <td>-z string</td>
          <td>判定字符串是否为 0？若 string 为空字符串，则为 true</td>
      </tr>
      <tr>
          <td>-n string</td>
          <td>判定字符串是否非空为 0？若 string 为非空字符串，则为 true</td>
      </tr>
      <tr>
          <td>str1 = str2</td>
          <td>判断 str1 是否等于 str2，若相等，则返回 true</td>
      </tr>
      <tr>
          <td>str1 != str2</td>
          <td>判断 str1 是否不等于 str2，若相等，则返回 false</td>
      </tr>
      <tr>
          <td>-a</td>
          <td>[and] 两条件同时成立，例如 test -f file -a -x file，则 file 同时具有 -f 与 x 权限时，返回 true</td>
      </tr>
  </tbody>
</table>
<p><span id=curl><strong>curl</strong></span></p>
<blockquote>
<p>curl 是向服务端发送和接收数据的工具。
<em>支持的协议(DICT, FILE, FTP, FTPS, GOPHER, HTTP, HTTPS, IMAP, IMAPS, LDAP,LDAPS, POP3, POP3S, RTMP, RTSP, SCP, SFTP, SMTP, SMTPS, TELNET and TFTP）</em></p>
</blockquote>
<hr>
<ul>
<li>
<p>查看服务端响应头信息: <code>curl -I https://www.baidu.com</code></p>
</li>
<li>
<p>获取响应码: <code> curl -o /dev/null -s -w &quot;%{http_code}&quot; https://www.baidu.com</code></p>
</li>
<li>
<p>携带证书访问: <code>curl -k --cacert /etc/kubernetes/pki/ca.crt  --cert /etc/kubernetes/pki/apiserver-kubelet-client.crt --key /etc/kubernetes/pki/apiserver-kubelet-client.key https://127.0.0.1:10250/metrics</code></p>
</li>
<li>
<p>指定请求头信息 <code>curl -k -H &quot;Authorization: Bearer $TOKEN&quot; https://&lt;KUBERNETES_API_SERVER&gt;/api/v1/nodes</code></p>
</li>
<li>
<p>指定请求方法, -g, &ndash;globoff允许url中存在 {} [] 等特殊字符 : <code>curl -g -X GET http://114.132.158.2:9100/metrics?collect[]=cpu</code></p>
</li>
<li>
<p>通过post发送数据: <code>curl -X POST -H 'content-type: application/json' -d '{&quot;password&quot;:&quot;123&quot;}'  http://172.16.100.10:8060/dingtalk/webhook1/send</code></p>
</li>
<li>
<p>文件下载: <code>curl -fSsL https://example.com/file.zip -o /local/path/file.zip</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-f, --fail  如果curl失败时不显示错误输出，主要用于书写脚本
</span></span><span style="display:flex;"><span>-s, --silent   静默
</span></span><span style="display:flex;"><span>-L, --location  如果站定已经搬迁，支持重定向
</span></span></code></pre></div></li>
</ul>
<p><span id=dig><strong>dig</strong></span></p>
<ul>
<li>查询A 记录: <code>dig @114.114.114.114 a baidu.com +short</code></li>
<li>查询RTP记录 <code>dig @114.114.114.114 -x 1.2.3.4.in-addr.arpa</code></li>
</ul>
<p><span id=mount><strong>mount</strong></span></p>
<ul>
<li>查看所有系统挂载: <code>mount</code></li>
<li>挂载定义在<code>/etc/fstab</code>中的所有文件系统: <code>mount -a</code></li>
<li>挂载定义在<code>/etc/fstab</code>中的指定文件系统 <code>mount -a -t ext4</code></li>
<li>指定挂载选项: <code>mount -o noatime,rw /dev/sdb /mnt</code></li>
</ul>
<p><strong>xargs</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>举例：
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@test /<span style="color:#f92672">]</span><span style="color:#75715e"># cat 1.txt </span>
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@test /<span style="color:#f92672">]</span><span style="color:#75715e"># cat 1.txt|xargs       对文本格式的重定向</span>
</span></span><span style="display:flex;"><span>a b c d e f a b c d e f a b c d e f a b c d e f
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@test /<span style="color:#f92672">]</span><span style="color:#75715e"># cat 1.txt|xargs -n6   每行6个重排</span>
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>a b c d e f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@test /<span style="color:#f92672">]</span><span style="color:#75715e"># cat 1.txt|xargs|sort &gt;2.txt      对文本格式重定向后默认排序输出到2.txt</span>
</span></span><span style="display:flex;"><span>a b c d e f a b c d e f a b c d e f a b c d e f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>举例：
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@test /<span style="color:#f92672">]</span><span style="color:#75715e"># cat 2.txt </span>
</span></span><span style="display:flex;"><span>a b ,c d e f a b ,c d e f a b ,c d e f a b ,c d e f
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@test /<span style="color:#f92672">]</span><span style="color:#75715e"># cat 2.txt|xargs -d&#34;,&#34; -n2  以，为分隔符每行两个域重排</span>
</span></span><span style="display:flex;"><span>a b  c d e f a b 
</span></span><span style="display:flex;"><span>c d e f a b  c d e f a b 
</span></span><span style="display:flex;"><span>c d e f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>find /tmp -name 1.log -type f -print0|xargs -0 rm -f   可用于处理文件中含有空格换行的文件
</span></span><span style="display:flex;"><span>find ./ -name <span style="color:#e6db74">&#34;*.log&#34;</span> -type f -print0|xargs -0 rm -f    用于日志的删除
</span></span><span style="display:flex;"><span>find -type f -name <span style="color:#e6db74">&#34;*.jpg&#34;</span> -print|xargs tar zcvf jpg.tar.gz  压缩所有图片文件
</span></span><span style="display:flex;"><span>cat url-list.txt|xargs wget -c  
</span></span></code></pre></div><p><span id=kill><strong>kill</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kill -l 查询所有信号量
</span></span><span style="display:flex;"><span>kill -s HUP <span style="color:#ae81ff">3940</span>
</span></span><span style="display:flex;"><span>kill -0 <span style="color:#ae81ff">3940</span>
</span></span><span style="display:flex;"><span>kill -15
</span></span></code></pre></div><p><span id=crontab><strong>crontab</strong></span></p>
<p><strong>crond</strong>是执行定时任务的后台程序，<code>systemctl status crond</code>命令确保服务正常运行。</p>
<p><code>/etc/crontab</code> 系统定时任务，默认为空</p>
<p><code> /etc/cron.d/</code> 包含系统定时任务</p>
<p><code>/var/spool/cron</code> 包含用户创建的定时任务，文件名以用户名命名</p>
<p><code>/var/log/cron</code> 包含定时任务执行的日志</p>
<p><strong>示例：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SHELL<span style="color:#f92672">=</span>/bin/bash
</span></span><span style="display:flex;"><span>PATH<span style="color:#f92672">=</span>/sbin:/bin:/usr/sbin:/usr/bin
</span></span><span style="display:flex;"><span>MAILTO<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*/5 * * * * echo <span style="color:#ae81ff">1</span> &gt;/dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>10/5 * * * * echo <span style="color:#ae81ff">1</span> &gt;/dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>*/5 23,24 * * * echo <span style="color:#ae81ff">1</span> &gt;/dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>*/5 20-24 * * * echo <span style="color:#ae81ff">1</span> &gt;/dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><span id=at><strong>at</strong></span></p>
<p><span id=tar><strong>tar</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> -v, --verbose 显示过程
</span></span><span style="display:flex;"><span> -f  --file    
</span></span><span style="display:flex;"><span> -c  --creat
</span></span><span style="display:flex;"><span> -z, --gzip   gzip压缩方式
</span></span><span style="display:flex;"><span> -j, --bzip2  bizp压缩方式
</span></span><span style="display:flex;"><span> -x  --extract  取出
</span></span><span style="display:flex;"><span> -C, --directory DIR 指定解压路径
</span></span><span style="display:flex;"><span> -t, --list 显示压缩文件列表
</span></span><span style="display:flex;"><span> --exclude<span style="color:#f92672">=</span>     压缩但不包含否个文件
</span></span><span style="display:flex;"><span> -X, --exclude-from FILE 用文件列表的方式排除不需要打包的文件
</span></span><span style="display:flex;"><span> -Z, --compress, --uncompress 调用compress完成压缩
</span></span><span style="display:flex;"><span> -N, --after-date DATE, --newer DATE 打包比指定日期新的文件，用于增量打包
</span></span><span style="display:flex;"><span> -p, --same-permissions, --preserve-permissions   保持属性
</span></span><span style="display:flex;"><span>              extract all protection information
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> -P, --absolute-names                             保存根目录的 /
</span></span><span style="display:flex;"><span>              don<span style="color:#e6db74">&#39;t strip leading &#39;</span>/<span style="color:#960050;background-color:#1e0010">&#39;</span>s from file names  
</span></span></code></pre></div><ul>
<li>
<p>打包时排除指定文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar --exclude <span style="color:#e6db74">&#39;conf/input.promtail&#39;</span>  --exclude <span style="color:#e6db74">&#39;conf/input.redis*&#39;</span> -czvf  seagullagent.tar.gz  conf seagullagent
</span></span></code></pre></div></li>
</ul>
<p><span id=fsdumpe2fs><strong>dumpe2fs</strong></span></p>
<blockquote>
<p>dump ext2/ext3/ext4 的文件系统信息,xfs 文件格式待整理</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 磁盘</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@tencent-sh ~<span style="color:#f92672">]</span><span style="color:#75715e"># dumpe2fs /dev/vda1 |grep -i &#34;inode size&#34;</span>
</span></span><span style="display:flex;"><span>dumpe2fs 1.42.9 <span style="color:#f92672">(</span>28-Dec-2013<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Inode size:               <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@tencent-sh ~<span style="color:#f92672">]</span><span style="color:#75715e"># dumpe2fs /dev/vda1 |grep -i &#34;block size&#34;</span>
</span></span><span style="display:flex;"><span>dumpe2fs 1.42.9 <span style="color:#f92672">(</span>28-Dec-2013<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Block size:               <span style="color:#ae81ff">4096</span>
</span></span></code></pre></div><p><span id=ln><strong>ln</strong></span></p>
<p>语法：<code>ln [OPTION]src dest</code></p>
<p>example</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln -svf /etc/hosts /tmp/hosts
</span></span></code></pre></div><p><span id=nl><strong>nl</strong></span></p>
<p>语法：<code>nl [OPTION] file</code></p>
<p>example</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 显示行号</span>
</span></span><span style="display:flex;"><span>nl /etc/hosts
</span></span></code></pre></div><p><span id=ntpdate><strong>ntpdate</strong></span>
在centos6 中我们经常使用的时间同步命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>timedatectl set-timezone Asia/Shanghai            
</span></span><span style="display:flex;"><span>date -s <span style="color:#e6db74">&#34;12/12/2010 15:40:30“
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hwclock -w 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">*/5 * * * * /usr/sbin/ntpdate 10.0.76.177 &gt;/dev/null 2&gt;&amp;1
</span></span></span></code></pre></div><p><span id=chronyd><strong>chronyd</strong></span></p>
<p><span id=cfssl><strong>cfssl</strong></span></p>
<p>下载地址</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># cfssl  生成证书</span>
</span></span><span style="display:flex;"><span>wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cfssl-json  证书格式化成文件</span>
</span></span><span style="display:flex;"><span>wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cfss-certinfo  查看证书的信息，发证机构，证书有效期</span>
</span></span><span style="display:flex;"><span>wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cfssl-certinfo -cert file
</span></span><span style="display:flex;"><span>cfssl-certinfo -domain domain_name
</span></span><span style="display:flex;"><span>cfssl-certinfo -domain pinduoduo.com
</span></span><span style="display:flex;"><span>cfssl certinfo -domain jd.com
</span></span><span style="display:flex;"><span>cfssl-certinfo -cert apiserver.pem 
</span></span><span style="display:flex;"><span>cfssl-certinfo -domain dashboard.od.com
</span></span></code></pre></div><p><span id=openssl><strong>openssl</strong></span></p>
<p><strong>SSL：</strong> Secure Socket Layer（安全套接层协议)</p>
<p><strong>TLS：</strong> Transport Layer Security（传输层安全协议）</p>
<p>加密算法</p>
<ol>
<li>RSA算法是一个广泛使用的公钥算法。其密钥包括公钥和私钥。它能用于数字签名、身份认证以及密钥交换。RSA密钥长度一般使用1024位或者更高。</li>
<li>DSA (Digital Signature Algorithm)算法是一种公钥算法.</li>
</ol>
<p>功能</p>
<ol>
<li>证书签发</li>
<li>文件加密</li>
<li>数字签名</li>
<li>生成随机数</li>
</ol>
<p><strong>证书签发</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#自签CA</span>
</span></span><span style="display:flex;"><span>openssl genrsa -out caKey.pem <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl req -new -key caKey.pem -out ca.csr -subj <span style="color:#e6db74">&#34;/C=CN/ST=Gd/L=SZ/O=od.com/CN=harbor.od.com&#34;</span>
</span></span><span style="display:flex;"><span>openssl x509 -req -in ca.csr -out ca-cert.pem -signkey caKey.pem -days <span style="color:#ae81ff">3650</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#签署应用key和crt</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1)用户生成自己的私钥；</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># genrsa Generation of DSA Private Key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gendsa Generation of DSA Private Key</span>
</span></span><span style="display:flex;"><span>openssl genrsa -out serverkey.pem <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2)构造证书申请文件</span>
</span></span><span style="display:flex;"><span>openssl req  -new -key serverkey.pem -out server.csr -subj <span style="color:#e6db74">&#34;/C=CN/ST=Gd/L=SZ/O=od.com/CN=harbor.od.com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># req X.509 Certificate Signing Request (CSR) Management.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -new   new request.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3)用户将证书申请文件提交给CA；CA验证签名，提取用户信息，并加上其他信息（比如颁发者等信息）</span>
</span></span><span style="display:flex;"><span>openssl x509 -req <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-in server.csr <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-out server-cert.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-signkey serverkey.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-CA ca-cert.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-CAkey caKey.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-CAcreateserial <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-days <span style="color:#ae81ff">3650</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># x509      X.509 Certificate Data Management.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -signkey arg    - self sign cert with arg</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -CAcreateserial - create serial number file if it does not exist</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -CA arg         - set the CA certificate, must be PEM format.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -CAkey arg      - set the CA key, must be PEM format</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                  missing, it is assumed to be in the CA file.</span>
</span></span></code></pre></div><p>另一种签发方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 跳过ca自签秘钥,如Nginx 中ssl</span>
</span></span><span style="display:flex;"><span>openssl genrsa -out server.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#-x509   output a x509 structure instead of a cert</span>
</span></span><span style="display:flex;"><span>openssl req -new -x509 -key server.key -out server.crt -subj /C<span style="color:#f92672">=</span>CN/ST<span style="color:#f92672">=</span>GD/L<span style="color:#f92672">=</span>SZ/O<span style="color:#f92672">=</span>devops/CN<span style="color:#f92672">=</span>wangendao.xyz -days <span style="color:#ae81ff">3650</span>
</span></span></code></pre></div><p><code>-subj</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>C：Country ，单位所在国家，为两位数的国家缩写，如： CN 就是中国
</span></span><span style="display:flex;"><span>ST：State/Province ，单位所在州或省
</span></span><span style="display:flex;"><span>L：Locality ，单位所在城市 / 或县区
</span></span><span style="display:flex;"><span>O：Organization ，网站的单位名称
</span></span><span style="display:flex;"><span>OU：Organization Unit，部门名称，也常常用于显示其他证书相关信息，如证书类型，证书产品名称或身份验证类型或验证内容等
</span></span><span style="display:flex;"><span>CN：Common Name ，网站的域名;
</span></span><span style="display:flex;"><span>EA：Email Address ，邮箱地址
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查看证书的信息</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -noout          - no certificate output</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -text           - print the certificate in text form</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>openssl x509 -noout -text -in server.crt
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查证书CN是否与域名匹配</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -checkhost host - check certificate matches &#34;host&#34;</span>
</span></span><span style="display:flex;"><span>openssl x509 -noout -checkhost seafile.example.com -in cert.pem  
</span></span><span style="display:flex;"><span>Hostname seafile.example.com does match certificate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  检查证书是否包含对应ip</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -checkip ipaddr - check certificate matches &#34;ipaddr&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@hdss7-21 certs<span style="color:#f92672">]</span><span style="color:#75715e"># openssl x509 -checkip 10.4.7.55 -in kubelet.pem </span>
</span></span><span style="display:flex;"><span>IP 10.4.7.55 does NOT match certificate
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  检查证书是否过期</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  -checkend arg   - check whether the cert expires in the next arg seconds</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                  exit 1 if so, 0 if not</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@hdss7-21 ssl<span style="color:#f92672">]</span><span style="color:#75715e"># openssl x509 -checkend 2592000 -in cert.pem          </span>
</span></span><span style="display:flex;"><span>Certificate will expire
</span></span></code></pre></div><p><strong>文件加密</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 生成私钥</span>
</span></span><span style="display:flex;"><span>openssl genrsa -out private.pem <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成公钥</span>
</span></span><span style="display:flex;"><span>openssl rsa -in private.pem -pubout -out public.pem
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建文件</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#ae81ff">12345678</span> &gt;a.txt
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加密文件</span>
</span></span><span style="display:flex;"><span>openssl rsautl -encrypt -in a.txt -inkey public.pem -pubin -out miwen.txt
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解密文件</span>
</span></span><span style="display:flex;"><span>openssl rsautl -decrypt -in miwen.txt -inkey private.pem -out b.txt
</span></span></code></pre></div><p>文件摘要（文件md5等验证是否被篡改）</p>
<pre tabindex="0"><code>openssl dgst -sign private.pem -md5 -out check a.txt
</code></pre><p><strong>生成随机数</strong></p>
<pre tabindex="0"><code>openssl rand -base64 10
openssl rand -hex 10
</code></pre><p><a href="https://www.cnblogs.com/technology178/p/14094375.html" target="_blank">https://www.cnblogs.com/technology178/p/14094375.html</a>
<a href="https://blog.csdn.net/qq_35014708/article/details/89351248" target="_blank">https://blog.csdn.net/qq_35014708/article/details/89351248</a>
<a href="https://github.com/ssllabs/research/wiki/SSL-and-TLS-Deployment-Best-Practices" target="_blank">https://github.com/ssllabs/research/wiki/SSL-and-TLS-Deployment-Best-Practices</a>
<a href="https://www.cnblogs.com/littleatp/p/5878763.html" target="_blank">https://www.cnblogs.com/littleatp/p/5878763.html</a></p>
<p><span id=dmidecode>查看主机型号：</span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@spa00x1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># dmidecode |grep &#39;Product Name&#39;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>Product Name: PowerEdge R720
</span></span><span style="display:flex;"><span>Product Name: 0X6FFV
</span></span></code></pre></div><p>查看主机序列号: <code>dmidecode |grep 'Serial Number'</code></p>
<p>查看操作系统：<code>cat /etc/redhat-release</code></p>
<p>查看cpu：<code>/proc/cpuinfo  </code></p>
<p>查看内存：<code>/proc/meminfo</code> <code>free -m</code></p>
<p>查看负载: <code>/proc/loadavg</code> <code>load</code> <code>uptime</code></p>
<p><span id=nc>nc</span>
<a href="https://www.jianshu.com/p/fa4eeac44e5c" target="_blank">网络命令nc</a></p>
<p><span id=folder><strong>centos中的目录</strong></span></p>
<table>
  <thead>
      <tr>
          <th>/etc/rsyslog</th>
          <th>日志配置文件</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>/var/spool/clientmqueue</td>
          <td>邮件队列</td>
      </tr>
      <tr>
          <td>/etc/motd</td>
          <td>添加登录时提示信息</td>
      </tr>
  </tbody>
</table>
<h3 id="打印ip的方法">打印ip的方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ifconfig eth0|awk -F <span style="color:#e6db74">&#34;[ :]+&#34;</span> <span style="color:#e6db74">&#39;NR==2{print $4}&#39;</span> 
</span></span><span style="display:flex;"><span>ifconfig eth0|awk -v FS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;[ :]+&#34;</span> <span style="color:#e6db74">&#39;NR==2{print $4}&#39;</span>
</span></span><span style="display:flex;"><span>ifconfig eth0|sed -n <span style="color:#e6db74">&#39;s/^.*addr:\(.*\)  Bcast.*$/\1/gp&#39;</span>
</span></span></code></pre></div><h3 id="awk-int">awk int()</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@seagullcore01-uat-s2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># echo &#34;1 0.1 2%&#34;|awk &#39;{print int($2)}&#39;  </span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div><h3 id="计算字符串长度">计算字符串长度</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>计算字符串长度的三种方法
</span></span><span style="display:flex;"><span>char<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>seq -s <span style="color:#e6db74">&#34;\t&#34;</span> 100<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">${#</span>char<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">${</span>char<span style="color:#e6db74">}</span>|wc -m
</span></span><span style="display:flex;"><span>echo <span style="color:#66d9ef">$(</span>expr length $char<span style="color:#66d9ef">)</span>  
</span></span></code></pre></div><h3 id="bash-魔法">bash 魔法</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#打印连续序列</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#f92672">{</span>0..10<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#打印偶数数列</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#f92672">{</span>0..10..2<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#打印组合数列</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#f92672">{</span>a..z<span style="color:#f92672">}{</span>a..z<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#f92672">{</span>0..10<span style="color:#f92672">}{</span>0..10..2<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#利用序列定义数组</span>
</span></span><span style="display:flex;"><span>letter_combos<span style="color:#f92672">=({</span>a..z<span style="color:#f92672">}{</span>a..z<span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">${</span>letter_combos[*]<span style="color:#e6db74">}</span> 
</span></span></code></pre></div><p>时间同步</p>
<ol>
<li>配置chrony</li>
<li>配置时区
ln -sf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone</li>
<li>手动时间同步</li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-b92cf9231f6f9197252551c27d29cc5f">postfix</h1>
	<div class="lead">centos7 配置 Postfix |linux</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-17" class="text-body-secondary">Tuesday, June 17, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<p>centos7 配置 Postfix</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y postfix mailx  install cyrus-sasl-plain cyrus-sasl-lib
</span></span></code></pre></div><ol>
<li>检查 /etc/postfix/main.cf 相关配置</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;&gt;/etc/postfix/main.cf<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relayhost = [smtp.qq.com]:587
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_sasl_auth_enable = yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_sasl_security_options = noanonymous
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_use_tls = yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_tls_CAfile = /etc/ssl/certs/ca-bundle.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">inet_protocols = ipv4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><ol start="2">
<li>检查 /etc/postfix/sasl_passwd 内容</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># [smtp.qq.com]:587 你的QQ邮箱@qq.com:授权码</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;[smtp.qq.com]:587 810654947@qq.com:kqaexaxpbrbdbajd&#34;</span> &gt;&gt;/etc/postfix/sasl_passwd
</span></span></code></pre></div><ol start="3">
<li>生成 hash 文件并设置权限</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo postmap /etc/postfix/sasl_passwd
</span></span><span style="display:flex;"><span>sudo chmod <span style="color:#ae81ff">600</span> /etc/postfix/sasl_passwd /etc/postfix/sasl_passwd.db
</span></span></code></pre></div><ol start="4">
<li>重启 Postfix</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl restart postfix
</span></span></code></pre></div><ol start="5">
<li>测试</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;good luck&#34;</span> | mail -s <span style="color:#e6db74">&#34;test&#34;</span> -r 810654947@qq.com 1209233066@qq.com
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-905550e769bb3ce68ebf7701485d4e9d">LVM (logical volume manager)</h1>
	<div class="lead">linux lvm</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-18" class="text-body-secondary">Sunday, May 18, 2025</time>
        
	</div>
	<p><strong>术语：</strong></p>
<p>&#x31;&#xfe0f;&#x20e3;<strong>物理卷PV</strong>(Physical Volume):  通过 <code>pvcreate</code> 创建的物理设备（如磁盘或分区），是LVM的基础存储单元。</p>
<p>&#x32;&#xfe0f;&#x20e3;<strong>物理块PE</strong>(Physical Extent) LVM管理的最小存储单元，默认大小为4MB</p>
<p>&#x33;&#xfe0f;&#x20e3;<strong>卷组VG</strong>(Volume Group) 由多个PV组合而成，构成逻辑存储池。</p>
<p>&#x34;&#xfe0f;&#x20e3;<strong>逻辑卷LV</strong>(Logical Volume) 从VG中划分的逻辑分区，可挂载使用。</p>
<p><img src="https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-8-Configuring_and_managing_logical_volumes-en-US/images/31bd96635c4120abe3e771a423f61cd6/basic-lvm-volume-components.png" alt=""></p>
<h3 id="环境准备">环境准备</h3>
<p><strong>创建pv</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@lvm:~# pvcreate /dev/sd<span style="color:#f92672">{</span>c..g<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#e6db74">&#34;/dev/sdc&#34;</span> successfully created.
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#e6db74">&#34;/dev/sdd&#34;</span> successfully created.
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#e6db74">&#34;/dev/sde&#34;</span> successfully created.
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#e6db74">&#34;/dev/sdf&#34;</span> successfully created.
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#e6db74">&#34;/dev/sdg&#34;</span> successfully created.
</span></span></code></pre></div><p><strong>创建vg</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@lvm:~# vgcreate data /dev/sd<span style="color:#f92672">{</span>c..f<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  Volume group <span style="color:#e6db74">&#34;data&#34;</span> successfully created
</span></span></code></pre></div><h3 id="逻辑卷类型">逻辑卷类型</h3>

  
  
  

  

  

<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>逻辑卷类型</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="线性卷" aria-controls="tabs-00-01" aria-selected="true">
        线性卷
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="条带化卷" aria-controls="tabs-00-02" aria-selected="false">
        条带化卷
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="raid卷" aria-controls="tabs-00-03" aria-selected="false">
        Raid卷
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-04" role="tab"
          data-td-tp-persist="精简卷" aria-controls="tabs-00-04" aria-selected="false">
        精简卷
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-nomarl --size 1g data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@pc:~# lvs --select lv_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test-nomarl&#34;</span> -o lv_name,vg_name,lv_size -o +seg_type
</span></span><span style="display:flex;"><span>  LV          VG   LSize Type  
</span></span><span style="display:flex;"><span>  test-nomarl data 1.00g linear
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <blockquote>
<p>&ndash;stripes 条带数量，不超过pv数量</p>
<p>&ndash;stripesize  条带大小，超过该值的大小保存到下一个pv上</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-stripes --stripes <span style="color:#ae81ff">4</span> --stripesize 64kb --size 1g  data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@lvm:~# lvs --select lv_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test-stripes&#34;</span> -o lv_name,vg_name,lv_size -o +seg_type
</span></span><span style="display:flex;"><span>  LV           VG   LSize Type   
</span></span><span style="display:flex;"><span>  test-stripes data 1.00g striped
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <blockquote>
<p>包括 RAID0、RAID1、RAID4、RAID5、RAID6 和 RAID10</p>
</blockquote>
<ul>
<li>RAID 4 的校验集中在一个磁盘，RAID 5 和 6 的校验分散在所有磁盘。</li>
<li>RAID 6 有两份独立的校验（如 P+Q 或 Reed-Solomon 编码），可承受双磁盘故障。</li>
</ul>
<table>
  <thead>
      <tr>
          <th>RAID级别</th>
          <th>校验方式</th>
          <th><strong>写入性能特点</strong></th>
          <th>容错能力</th>
          <th>最小磁盘数</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>RAID 4</td>
          <td><strong>专用校验盘</strong>（固定某个磁盘）</td>
          <td><strong>写入瓶颈</strong>：所有校验数据写入专用盘，高负载时易成为性能瓶颈。</td>
          <td>允许 <strong>1块磁盘故障</strong></td>
          <td>3块</td>
      </tr>
      <tr>
          <td>RAID 5</td>
          <td><strong>分布式校验</strong>（校验块轮流分布）</td>
          <td><strong>较高并发</strong>：校验分散，支持并行读写，但每次写操作需计算并更新校验块（读-改-写）。</td>
          <td>允许 <strong>1块磁盘故障</strong></td>
          <td>3块</td>
      </tr>
      <tr>
          <td>RAID 6</td>
          <td><strong>双重分布式校验</strong>（两套独立校验）</td>
          <td><strong>较低写入速度</strong>：相比 RAID 5，每次写入需计算两套校验，延迟更高（更高的 <em>写惩罚</em>）。</td>
          <td>允许 <strong>2块磁盘故障</strong></td>
          <td>4块</td>
      </tr>
  </tbody>
</table>
<ul>
<li>
<p>Raid0</p>
<blockquote>
<p>最少2块pv, 2个条带</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-raid0 --type raid0 --stripes <span style="color:#ae81ff">4</span> --stripesize 64k --size 1g data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@pc:~# lvs --select lv_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test-raid0&#34;</span> -o lv_name,vg_name -o +seg_type 
</span></span><span style="display:flex;"><span>  LV         VG   Type 
</span></span><span style="display:flex;"><span>  test-raid0 data raid0
</span></span></code></pre></div></li>
<li>
<p>raid4 ，raid5</p>
<blockquote>
<p>最少3块pv, 2个条带</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-raid4 --type raid4 --stripes <span style="color:#ae81ff">2</span> --stripesize 64k --size 1g data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@pc:~# lvs --select lv_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test-raid4&#34;</span> -o lv_name,vg_name -o +seg_type 
</span></span><span style="display:flex;"><span>  LV         VG   Type 
</span></span><span style="display:flex;"><span>  test-raid4 data raid4
</span></span></code></pre></div><p>raid5</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-raid5 --type raid5 --stripes <span style="color:#ae81ff">2</span> --stripesize 64k --size 100g data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@pc:~# lvs --select lv_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test-raid5&#34;</span> -o lv_name,vg_name -o +seg_type 
</span></span><span style="display:flex;"><span>  LV         VG   Type 
</span></span><span style="display:flex;"><span>  test-raid5 data raid5
</span></span></code></pre></div><p>raid6</p>
<blockquote>
<p>最少5块pv，3个条带</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-raid6 --type raid6 --stripes <span style="color:#ae81ff">3</span> --stripesize 64k --size 10g data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@pc:~# lvs --select lv_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test-raid6&#34;</span> -o lv_name,vg_name -o +seg_type 
</span></span><span style="display:flex;"><span>  LV         VG   Type 
</span></span><span style="display:flex;"><span>  test-raid6 data raid6
</span></span></code></pre></div></li>
<li>
<p>raid1</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># lvcreate --type raid1 --mirrors MirrorsNumber --size Size --name LogicalVolumeName VolumeGroupName</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name raid1 --type raid1 --mirrors <span style="color:#ae81ff">1</span> --size 1g data 
</span></span></code></pre></div></li>
<li>
<p>raid10</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># lvcreate --type raid10 --mirrors MirrorsNumber --stripes NumberOfStripes --stripesize StripeSize --size Size --name LogicalVolumeName VolumeGroupName</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name raid10 --type raid10 --mirrors <span style="color:#ae81ff">1</span> --stripes <span style="color:#ae81ff">2</span> --stripesize 64k --size 1g data 
</span></span></code></pre></div></li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-04" role="tabpanel" aria-labelled-by="tabs-00-04-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># lvcreate --type thin-pool --size PoolSize --name ThinPoolName VolumeGroupName</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name thinpool --type thin-pool --size 1g data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># lvcreate --type thin --virtualsize MaxVolumeSize --name ThinVolumeName --thinpool ThinPoolName VolumeGroupName</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lvcreate --name test-thin --type thin --virtualsize 100g --thinpool thinpool data
</span></span></code></pre></div>
    </div>
</div>

<h3 id="场景举例">场景举例</h3>
<p>场景：磁盘空间马上要满</p>
<p><strong>第一步：创建分区或增加一块硬盘</strong></p>
<p>vmware 扩展磁盘分区</p>
<p><strong>第二步：给刚才扩展的磁盘分配一个分区</strong></p>
<p>查看磁盘有多少未分区空间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># parted /dev/sda</span>
</span></span><span style="display:flex;"><span>GNU Parted 3.1
</span></span><span style="display:flex;"><span>使用 /dev/sda
</span></span><span style="display:flex;"><span>Welcome to GNU Parted! Type <span style="color:#e6db74">&#39;help&#39;</span> to view a list of commands.
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>parted<span style="color:#f92672">)</span> print free
</span></span><span style="display:flex;"><span>Model: VMware, VMware Virtual S <span style="color:#f92672">(</span>scsi<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Disk /dev/sda: 69.8GB
</span></span><span style="display:flex;"><span>Sector size <span style="color:#f92672">(</span>logical/physical<span style="color:#f92672">)</span>: 512B/512B
</span></span><span style="display:flex;"><span>Partition Table: msdos
</span></span><span style="display:flex;"><span>Disk Flags:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Number  Start   End     Size    Type     File system  标志
</span></span><span style="display:flex;"><span>        32.3kB  1049kB  1016kB           Free Space
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">1</span>      1049kB  1075MB  1074MB  primary  xfs          启动
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">2</span>      1075MB  21.5GB  20.4GB  primary               lvm
</span></span><span style="display:flex;"><span>        21.5GB  64.4GB  42.9GB           Free Space
</span></span></code></pre></div><p>创建分区</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># fdisk /dev/sda</span>
</span></span><span style="display:flex;"><span>Welcome to fdisk <span style="color:#f92672">(</span>util-linux 2.23.2<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Changes will remain in memory only, <span style="color:#66d9ef">until</span> you decide to write them.
</span></span><span style="display:flex;"><span>Be careful before using the write command.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Command <span style="color:#f92672">(</span>m <span style="color:#66d9ef">for</span> help<span style="color:#f92672">)</span>: n
</span></span><span style="display:flex;"><span>Partition type:
</span></span><span style="display:flex;"><span>   p   primary <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span> primary, <span style="color:#ae81ff">0</span> extended, <span style="color:#ae81ff">2</span> free<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>   e   extended
</span></span><span style="display:flex;"><span>Select <span style="color:#f92672">(</span>default p<span style="color:#f92672">)</span>: p
</span></span><span style="display:flex;"><span>Partition number <span style="color:#f92672">(</span>3,4, default 3<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>First sector <span style="color:#f92672">(</span>41943040-125829119, default 41943040<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>Using default value <span style="color:#ae81ff">41943040</span>
</span></span><span style="display:flex;"><span>Last sector, +sectors or +size<span style="color:#f92672">{</span>K,M,G<span style="color:#f92672">}</span> <span style="color:#f92672">(</span>41943040-125829119, default 125829119<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>Using default value <span style="color:#ae81ff">125829119</span>
</span></span><span style="display:flex;"><span>Partition <span style="color:#ae81ff">3</span> of type Linux and of size <span style="color:#ae81ff">40</span> GiB is set
</span></span><span style="display:flex;"><span>Command <span style="color:#f92672">(</span>m <span style="color:#66d9ef">for</span> help<span style="color:#f92672">)</span>: w
</span></span></code></pre></div><p>通知内核分区变动,否则需要重启操作系统</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># partprobe</span>
</span></span></code></pre></div><p><strong>第三步：把分区转换为pv</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># pvcreate /dev/sda3</span>
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#e6db74">&#34;/dev/sda3&#34;</span> successfully created.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># pvs</span>
</span></span><span style="display:flex;"><span>  PV         VG                                        Fmt  Attr PSize   PFree
</span></span><span style="display:flex;"><span>  /dev/sda2  centos                                    lvm2 a--  &lt;19.00g     <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  /dev/sda3                                            lvm2 ---   40.00g 40.00g
</span></span></code></pre></div><p><strong>第四步：扩展所在vg</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># vgextend centos /dev/sda3</span>
</span></span><span style="display:flex;"><span>  Volume group <span style="color:#e6db74">&#34;centos&#34;</span> successfully extended
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># vgs centos</span>
</span></span><span style="display:flex;"><span>  VG     <span style="color:#75715e">#PV #LV #SN Attr   VSize  VFree</span>
</span></span><span style="display:flex;"><span>  centos   <span style="color:#ae81ff">2</span>   <span style="color:#ae81ff">2</span>   <span style="color:#ae81ff">0</span> wz--n- 58.99g &lt;40.00g
</span></span></code></pre></div><p><strong>第四步：调整lv的空间大小</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># lvresize -L  +39g /dev/centos/root</span>
</span></span><span style="display:flex;"><span>  Size of logical volume centos/root changed from &lt;17.00 GiB <span style="color:#f92672">(</span><span style="color:#ae81ff">4351</span> extents<span style="color:#f92672">)</span> to &lt;56.00 GiB <span style="color:#f92672">(</span><span style="color:#ae81ff">14335</span> extents<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>  Logical volume centos/root successfully resized
</span></span></code></pre></div><p><strong>第五步：通知文件系统调整文件系统大小</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># xfs_growfs /dev/mapper/centos-root</span>
</span></span><span style="display:flex;"><span>meta-data<span style="color:#f92672">=</span>/dev/mapper/centos-root isize<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span>    agcount<span style="color:#f92672">=</span>4, agsize<span style="color:#f92672">=</span><span style="color:#ae81ff">1113856</span> blks
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">=</span>                       sectsz<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span>   attr<span style="color:#f92672">=</span>2, projid32bit<span style="color:#f92672">=</span>1
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">=</span>                       crc<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>        finobt<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> spinodes<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>data     <span style="color:#f92672">=</span>                       bsize<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>   blocks<span style="color:#f92672">=</span>4455424, imaxpct<span style="color:#f92672">=</span>25
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">=</span>                       sunit<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>      swidth<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> blks
</span></span><span style="display:flex;"><span>naming   <span style="color:#f92672">=</span>version <span style="color:#ae81ff">2</span>              bsize<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>   ascii-ci<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ftype<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>log      <span style="color:#f92672">=</span>internal               bsize<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>   blocks<span style="color:#f92672">=</span>2560, version<span style="color:#f92672">=</span>2
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">=</span>                       sectsz<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span>   sunit<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> blks, lazy-count<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>realtime <span style="color:#f92672">=</span>none                   extsz<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>   blocks<span style="color:#f92672">=</span>0, rtextents<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>data blocks changed from <span style="color:#ae81ff">4455424</span> to <span style="color:#ae81ff">14679040</span>
</span></span></code></pre></div><p><strong>完成</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># df -HT</span>
</span></span><span style="display:flex;"><span>文件系统                类型      容量  已用  可用 已用% 挂载点
</span></span><span style="display:flex;"><span>devtmpfs                devtmpfs  1.5G     <span style="color:#ae81ff">0</span>  1.5G    0% /dev
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     1.5G     <span style="color:#ae81ff">0</span>  1.5G    0% /dev/shm
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     1.5G   11M  1.5G    1% /run
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     1.5G     <span style="color:#ae81ff">0</span>  1.5G    0% /sys/fs/cgroup
</span></span><span style="display:flex;"><span>/dev/mapper/centos-root xfs        61G   15G   46G   25% /
</span></span><span style="display:flex;"><span>/dev/sda1               xfs       1.1G  224M  840M   22% /boot
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     1.5G   25k  1.5G    1% /var/lib/ceph/osd/ceph-1
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     1.5G   25k  1.5G    1% /var/lib/ceph/osd/ceph-0
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     1.5G   25k  1.5G    1% /var/lib/ceph/osd/ceph-2
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     297M   13k  297M    1% /run/user/42
</span></span><span style="display:flex;"><span>tmpfs                   tmpfs     297M     <span style="color:#ae81ff">0</span>  297M    0% /run/user/0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@lvm ~<span style="color:#f92672">]</span><span style="color:#75715e"># lsblk -f /dev/sda</span>
</span></span><span style="display:flex;"><span>NAME            FSTYPE      LABEL UUID                                   MOUNTPOINT
</span></span><span style="display:flex;"><span>sda
</span></span><span style="display:flex;"><span>├─sda1          xfs               2698408f-1135-4c91-b11c-02892e5208f8   /boot
</span></span><span style="display:flex;"><span>├─sda2          LVM2_member       eZESEK-nJJ1-UvCV-x3st-lJKM-m3Zx-JZNvWO
</span></span><span style="display:flex;"><span>│ ├─centos-root xfs               e011e279-e5c9-4dfd-87e9-ecfc7e46bccd   /
</span></span><span style="display:flex;"><span>│ └─centos-swap swap              e14f66e7-6647-486f-a9d7-acc044d455a1
</span></span><span style="display:flex;"><span>└─sda3          LVM2_member       ugnjZw-FN0H-V8vi-acLb-D6sC-YB1f-CtZIF7
</span></span><span style="display:flex;"><span>  └─centos-root xfs               e011e279-e5c9-4dfd-87e9-ecfc7e46bccd   /
</span></span></code></pre></div><p>参考
<a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/8/html-single/configuring_and_managing_logical_volumes/index" target="_blank">红帽</a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-6ac20a0b99b404f8617a619f7cf7fc51">rsyslog</h1>
	<div class="lead">centos7 配置 rsyslog|linux</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-09-17" class="text-body-secondary">Wednesday, September 17, 2025</time>
        
	</div>
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install rsyslog 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@zabbix ~<span style="color:#f92672">]</span><span style="color:#75715e"># grep -Ev &#39;^$|^#&#39; /etc/rsyslog.conf </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#开启udp/tcp 514 接收日志</span>
</span></span><span style="display:flex;"><span>$ModLoad imudp
</span></span><span style="display:flex;"><span>$UDPServerRun <span style="color:#ae81ff">514</span>
</span></span><span style="display:flex;"><span>$ModLoad imtcp
</span></span><span style="display:flex;"><span>$InputTCPServerRun <span style="color:#ae81ff">514</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#默认的日志格式模板，无需定义</span>
</span></span><span style="display:flex;"><span>$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat
</span></span><span style="display:flex;"><span><span style="color:#75715e">#屏蔽本机的日志</span>
</span></span><span style="display:flex;"><span>:fromhost-ip,!isequal,<span style="color:#e6db74">&#34;127.0.0.1&#34;</span> ?RSYSLOG_TraditionalFileFormat
</span></span><span style="display:flex;"><span><span style="color:#75715e">#所有类型.所以级别				: :ommysql:主机,库名,用户名,密码</span>
</span></span><span style="display:flex;"><span>*.*                          @filebeat:端口
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#检查语法rsyslog.conf </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@Nagios ~<span style="color:#f92672">]</span><span style="color:#75715e"># rsyslogd -f /etc/rsyslog.conf -N1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@Nagios ~<span style="color:#f92672">]</span><span style="color:#75715e"># /etc/init.d/rsyslog restart</span>
</span></span></code></pre></div><p>客户端配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>H3C 配置
</span></span><span style="display:flex;"><span>sys
</span></span><span style="display:flex;"><span>info-center loghost 168.204.37.50
</span></span><span style="display:flex;"><span>linux配置
</span></span><span style="display:flex;"><span>*.* 	@168.204.37.50  <span style="color:#75715e"># udp</span>
</span></span><span style="display:flex;"><span>*.* 	@@168.204.37.50  <span style="color:#75715e">## tcp</span>
</span></span></code></pre></div><p>rsyslog.conf</p>
<p>rsyslog中的数据库支持是通过可加载的插件模块集成的。要使用数据库功能，必须在使用第一个数据库表操作之前在配置文件中启用数据库插件。这是通过放置</p>
<p>$ModLoad ommysql</p>
<p>接下来，我们需要告诉rsyslogd将数据写入数据库。由于使用默认架构，因此无需为此定义模板。我们可以使用硬编码的代码（rsyslogd处理正确的模板链接）。因此，对于MySQL，我们需要做的就是在/etc/rsyslog.conf中添加一个简单的选择器行：</p>
<p><em>.</em>    :ommysql:database-server,database-name,database-userid,database-password</p>
<p>例如，如果您仅对来自邮件子系统的消息感兴趣，则可以使用以下选择器行：</p>
<p>mail.*    :ommysql:127.0.0.1,syslog,syslogwriter,topsecret</p>
<p>如果您要转发多个服务器，则可以很快完成。Rsyslog对操作的数量或类型没有限制，因此您可以定义任意多个目标。然而，重要的是要知道，全套指令构成了一个动作。因此，您不能简单地添加（仅）第二条转发规则，而还需要复制规则配置。请注意，对于第二个操作，请使用不同的队列文件名，否则将使系统混乱。</p>
<p>转发到两个主机的示例如下所示：</p>
<p>$ ModLoad imuxsock ＃本地消息接收</p>
<p>$ WorkDirectory / rsyslog / work ＃工作（假脱机）文件的默认位置</p>
<h2 id="记录系统日志消息的优先级"><em><strong>*记录系统日志消息的优先级*</strong></em><a href="#recording-the-priority-of-syslog-messages"><em><strong>*¶*</strong></em></a></h2>
<p>＃开始转发规则1</p>
<p>$ ActionQueueType LinkedList ＃使用异步处理</p>
<p>$ ActionQueueFileName srvrfwd1 ＃设置文件名，还启用磁盘模式</p>
<p>$ ActionResumeRetryCount -1 ＃插入失败时无限重试</p>
<p>$ ActionQueueSaveOnShutdown on ＃如果rsyslog关闭，则保存内存数据</p>
<p><em>.</em> @@ server1：端口</p>
<p>＃结束转发规则1</p>
<p>＃开始转发规则2</p>
<p>$ ActionQueueType LinkedList ＃使用异步处理</p>
<p>$ ActionQueueFileName srvrfwd2 ＃设置文件名，还启用磁盘模式</p>
<p>$ ActionResumeRetryCount -1 ＃插入失败时无限重试</p>
<p>$ ActionQueueSaveOnShutdown on ＃如果rsyslog关闭，则保存内存数据</p>
<p><em>.</em> @@ server2</p>
<p>＃结束转发规则2</p>
<p>配置日志模板：</p>
<pre tabindex="0"><code> $template 模板名称,&#34;%timegenerated% %HOSTNAME% %syslogtag%%msg%0
 $template RemoteLogs,&#34;/tmp/rsyslog/%$YEAR%-%$MONTH%/%fromhost-ip%/%fromhost-ip%_%$YEAR%-%$MONTH%-%$DAY%.log&#34;
 
</code></pre>
</div>





    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5e1eecb0ef0b07d2fc44652e2fc03e66">6 - nginx</h1>
    
	<p><em>简介</em></p>
<p>Nginx (engine x <a href="http://nginx.org" target="_blank">http://nginx.org</a>)是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP服务器。Nginx是由伊戈尔·赛索耶夫开发的，第一个公开版本0.1.0发布于2004年10月4日。其特点是占用内存少，并发能力强。</p>
<p><em>应用场景</em></p>
<table>
  <thead>
      <tr>
          <th>应用场景</th>
          <th>竞争产品</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>静态服务器（图片、视频服务器</td>
          <td>lighttpd</td>
      </tr>
      <tr>
          <td>动态服务</td>
          <td>nignx +fastcgi</td>
      </tr>
      <tr>
          <td>反向代理 负载均衡</td>
          <td>haproxy</td>
      </tr>
      <tr>
          <td>cache(web缓存)</td>
          <td>vanish</td>
      </tr>
  </tbody>
</table>
<h3 id="安装nginx">安装nginx</h3>
<h3 id="配置详解">配置详解</h3>
<ol>
<li>全局配置</li>
<li>http服务</li>
<li>location</li>
<li>upsteam</li>
<li>rewrite</li>
<li>log</li>
</ol>
<h3 id="模块">模块</h3>
<h4 id="ngx_http_autoindex_module">ngx_http_autoindex_module</h4>
<p>生成目录列表所用
<a href="https://nginx.org/en/docs/http/ngx_http_autoindex_module.html" target="_blank">https://nginx.org/en/docs/http/ngx_http_autoindex_module.html</a></p>
<p><code>http、 server、 location</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">autoindex</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">autoindex_exact_size</span> <span style="color:#66d9ef">on</span>; <span style="color:#75715e"># 精确输出文件大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">autoindex_format</span> <span style="color:#e6db74">html</span>;   <span style="color:#75715e"># 展示格式 html/xml/json/jsonp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">autoindex_localtime</span> <span style="color:#66d9ef">on</span>; <span style="color:#75715e"># 时间展示
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h4 id="ngx_"><a href="https://nginx.org/en/docs/http/ngx_http_stub_status_module.html" target="_blank">ngx_http_stub_status_module</a></h4>
<p><strong>stub_status</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">stub_status</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">syntax:</span> <span style="color:#e6db74">stub_status</span> <span style="color:#66d9ef">on</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">default:</span> <span style="color:#e6db74">None</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">context:</span> <span style="color:#e6db74">location</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">Enables</span> <span style="color:#e6db74">the</span> <span style="color:#e6db74">status</span> <span style="color:#e6db74">handler</span> <span style="color:#e6db74">in</span> <span style="color:#e6db74">this</span> <span style="color:#e6db74">location.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">/nginx_status</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stub_status</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">access_log</span>   <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">allow</span> <span style="color:#e6db74">SOME.IP.ADD.RESS</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">active</span> <span style="color:#e6db74">connections</span> <span style="color:#e6db74">--</span> <span style="color:#e6db74">number</span> <span style="color:#e6db74">of</span> <span style="color:#e6db74">all</span> <span style="color:#e6db74">open</span> <span style="color:#e6db74">connections</span> <span style="color:#e6db74">including</span> <span style="color:#e6db74">connections</span> <span style="color:#e6db74">to</span> <span style="color:#e6db74">backends</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">server</span> <span style="color:#e6db74">accepts</span> <span style="color:#e6db74">handled</span> <span style="color:#e6db74">requests</span> <span style="color:#e6db74">--</span> <span style="color:#e6db74">nginx</span> <span style="color:#e6db74">accepted</span> <span style="color:#ae81ff">16630948</span> <span style="color:#e6db74">connections,</span> <span style="color:#e6db74">handled</span> <span style="color:#ae81ff">16630948</span> <span style="color:#e6db74">connections</span> <span style="color:#e6db74">(no</span> <span style="color:#66d9ef">on</span><span style="color:#e6db74">e</span> <span style="color:#e6db74">was</span> <span style="color:#e6db74">closed</span> <span style="color:#e6db74">just</span> <span style="color:#e6db74">it</span> <span style="color:#e6db74">was</span> <span style="color:#e6db74">accepted),</span> <span style="color:#e6db74">and</span> <span style="color:#e6db74">handles</span> <span style="color:#ae81ff">31070465</span> <span style="color:#e6db74">requests</span> <span style="color:#e6db74">(1.8</span> <span style="color:#e6db74">requests</span> <span style="color:#e6db74">per</span> <span style="color:#e6db74">connection)</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">reading</span> <span style="color:#e6db74">--</span> <span style="color:#e6db74">nginx</span> <span style="color:#e6db74">reads</span> <span style="color:#e6db74">request</span> <span style="color:#e6db74">header</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">writing</span> <span style="color:#e6db74">--</span> <span style="color:#e6db74">nginx</span> <span style="color:#e6db74">reads</span> <span style="color:#e6db74">request</span> <span style="color:#e6db74">body,</span> <span style="color:#e6db74">processes</span> <span style="color:#e6db74">request,</span> <span style="color:#e6db74">or</span> <span style="color:#e6db74">writes</span> <span style="color:#e6db74">response</span> <span style="color:#e6db74">to</span> <span style="color:#e6db74">a</span> <span style="color:#e6db74">client</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">waiting</span> <span style="color:#e6db74">--</span> <span style="color:#e6db74">keep-alive</span> <span style="color:#e6db74">connections,</span> <span style="color:#e6db74">actually</span> <span style="color:#e6db74">it</span> <span style="color:#e6db74">is</span> <span style="color:#e6db74">active</span> <span style="color:#e6db74">-</span> <span style="color:#e6db74">(reading</span> <span style="color:#e6db74">+</span> <span style="color:#e6db74">writing)</span>
</span></span></code></pre></div><h4 id="gx_"><a href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html" target="_blank">gx_http_rewrite_module</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-84a82bd7aae117864d19f5961c931ac6">安装nginx</h1>
	<div class="lead">install|nginx</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-22" class="text-body-secondary">Thursday, May 22, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h3 id="安装部署">安装部署</h3>
<p>第一步：安装依赖


  
  
<ul class="nav nav-tabs justify-content-end" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="centos" aria-controls="tabs-00-00" aria-selected="true">
        centos
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="ubuntu" aria-controls="tabs-00-01" aria-selected="false">
        ubuntu
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#GCC (gun compiler collection)c语言编译器</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#gcc-c++ c++语言编译器</span>
</span></span><span style="display:flex;"><span>yum install gcc gcc-c++ -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># rewrite模块需要  pcre (perl compatible regular expression  per 兼容正则表达式) </span>
</span></span><span style="display:flex;"><span>yum install pcre pcre-devel -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># zlib 配置中gizp on 使用</span>
</span></span><span style="display:flex;"><span>yum install zlib zlib-devel -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># openssl 提供https 和md5 sha1等</span>
</span></span><span style="display:flex;"><span>yum install openssl openssl-devel -y
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 更新软件包列表</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装GCC和G++编译器</span>
</span></span><span style="display:flex;"><span>sudo apt-get install gcc g++ -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装PCRE库</span>
</span></span><span style="display:flex;"><span>sudo apt-get install libpcre3 libpcre3-dev -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装zlib库</span>
</span></span><span style="display:flex;"><span>sudo apt-get install zlib1g zlib1g-dev -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装OpenSSL库</span>
</span></span><span style="display:flex;"><span>sudo apt-get install openssl libssl-dev -y
</span></span></code></pre></div>
    </div>
</div>
</p>
<p>第二步下载源码并修改源代码（非必须）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget http://nginx.org/download/nginx-1.22.1.tar.gz
</span></span><span style="display:flex;"><span>tar xf nginx-1.22.1.tar.gz <span style="color:#f92672">&amp;&amp;</span> cd nginx-1.22.1
</span></span></code></pre></div><p><strong>隐藏nginx标识和版本信息</strong>:</p>
<blockquote>
<p>修改源码位置：src/http/ngx_http_header_filter_module.c</p>
</blockquote>



  
  
<ul class="nav nav-tabs justify-content-end" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="源码" aria-controls="tabs-01-00" aria-selected="true">
        源码
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="修改后" aria-controls="tabs-01-01" aria-selected="false">
        修改后
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_server_string[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Server: nginx&#34;</span> CRLF;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_server_full_string[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Server: &#34;</span> NGINX_VER CRLF;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_server_build_string[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Server: &#34;</span> NGINX_VER_BUILD CRLF;
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_server_string[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Server: IIS&#34;</span> CRLF;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_server_full_string[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Server: IIS&#34;</span> CRLF;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_server_build_string[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Server: IIS&#34;</span> CRLF;
</span></span></code></pre></div>
    </div>
</div>

<blockquote>
<p>修改源码位置：src/http/ngx_http_special_response.c</p>
</blockquote>


  
  

<ul class="nav nav-tabs justify-content-end" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          data-td-tp-persist="源码" aria-controls="tabs-02-00" aria-selected="true">
        源码
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="修改后" aria-controls="tabs-02-01" aria-selected="false">
        修改后
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_error_full_tail[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;hr&gt;&lt;center&gt;&#34;</span> NGINX_VER <span style="color:#e6db74">&#34;&lt;/center&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/body&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/html&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_error_build_tail[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;hr&gt;&lt;center&gt;&#34;</span> NGINX_VER_BUILD <span style="color:#e6db74">&#34;&lt;/center&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/body&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/html&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_error_tail[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/body&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/html&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span>;
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_error_full_tail[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;hr&gt;&lt;center&gt; IIS &lt;/center&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/body&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/html&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_error_build_tail[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;hr&gt;&lt;center&gt; IIS &lt;/center&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/body&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/html&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> u_char ngx_http_error_tail[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;hr&gt;&lt;center&gt;IIS&lt;/center&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/body&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&lt;/html&gt;&#34;</span> CRLF
</span></span><span style="display:flex;"><span>;
</span></span></code></pre></div>
    </div>
</div>

<p>第三步执行编译</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>useradd nginx -M -s /bin/nologin
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./configure <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--prefix<span style="color:#f92672">=</span>/opt/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--group<span style="color:#f92672">=</span>nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_flv_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_mp4_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_stub_status_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_gzip_static_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-pcre <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-debug
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make <span style="color:#f92672">&amp;&amp;</span> make install
</span></span><span style="display:flex;"><span><span style="color:#75715e">#查看编译信息</span>
</span></span><span style="display:flex;"><span>/opt/nginx/sbin/nginx -V
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 启动服务</span>
</span></span><span style="display:flex;"><span>/opt/nginx/sbin/nginx
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nginx-1.22.1<span style="color:#f92672">]</span><span style="color:#75715e"># curl -I 127.0.0.1</span>
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#ae81ff">200</span> OK
</span></span><span style="display:flex;"><span>Server: IIS
</span></span><span style="display:flex;"><span>Date: Thu, <span style="color:#ae81ff">22</span> May <span style="color:#ae81ff">2025</span> 07:39:59 GMT
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#ae81ff">615</span>
</span></span><span style="display:flex;"><span>Last-Modified: Thu, <span style="color:#ae81ff">22</span> May <span style="color:#ae81ff">2025</span> 07:39:16 GMT
</span></span><span style="display:flex;"><span>Connection: keep-alive
</span></span><span style="display:flex;"><span>ETag: <span style="color:#e6db74">&#34;682ed4a4-267&#34;</span>
</span></span><span style="display:flex;"><span>Accept-Ranges: bytes
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-2fb0f235e6fc12a93aed4b8df6d5a972">配置nginx</h1>
	<div class="lead">nginx.conf|nginx</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-23" class="text-body-secondary">Friday, May 23, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<hr>
<p>nginx 进程关系： nginx 由master和worker进程组成，master进程负责管理work进程，worker进程负责处理具体的任务.</p>
<p>配置文件结构：</p>
<pre class="mermaid">graph LR
    A[nginx.conf]
    B[global]
    C[http]
    C1[upstream]
    C2[server]
    C21[location]
    C211[if]
    D[stream]
    D1[upstream]
    D2[server]
    A -.-&gt;|worker进程配置| B
    A -.-&gt;|http服务配置| C
    C -.-&gt; C1
    C -.-&gt; C2
    C2 -.-&gt; C21
    C21 -.-&gt; C211
    D -.-&gt; D1
    D -.-&gt; D2
    A -.- |4层反向代理|D
    subgraph 反向代理和http服务  
    C1
    C2
    end 

    subgraph 7层服务配置
    C
    end 
    subgraph 4层反向代理
    D1
    D2
    end 
    subgraph 4层服务配置
    D
    end 

    subgraph 全局配置
    B
    end
    
    subgraph 主配置文件
    A
    end</pre>
<h3 id="配置模板">配置模板</h3>

<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 进程模式启动
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">daemon</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># master worker 模式运行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">master_process</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 错误日志设置 日志路径   日志记录级别（debug info notice warn error crit alert emerg）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">error_log</span> <span style="color:#e6db74">logs/error.log</span> <span style="color:#e6db74">error</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">user</span>  <span style="color:#e6db74">nginx</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">worker_cpu_affinity</span> <span style="color:#ae81ff">0001</span> <span style="color:#ae81ff">0010</span> <span style="color:#ae81ff">0100</span> <span style="color:#ae81ff">1000</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#worker_processes 8;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#worker_cpu_affinity 0001 0010 0100 1000 0001 0010 0100 1000;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 批量建立连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">multi_accept</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 对指定客户端执行debug,需要在编译时 --with-debug,否则不生效
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">debug_connection</span> 127.0.0.1;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug_connection</span> 192.168.0.0<span style="color:#e6db74">/24</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 使用epoll i/o模型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">use</span> <span style="color:#e6db74">epoll</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 单个进程最大连接数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">worker_connections</span> <span style="color:#ae81ff">15000</span>;  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指定work进程打开的最大文件数，可设置为系统ulimit -HSn的结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">worker_rlimit_nofile</span> <span style="color:#ae81ff">65535</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4层代理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">stream</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">log_format</span> <span style="color:#e6db74">main</span> <span style="color:#e6db74">&#39;</span>$remote_addr <span style="color:#e6db74">[</span>$time_local] <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;</span>$protocol $status $bytes_sent $bytes_received <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;</span>$session_time <span style="color:#e6db74">&#34;</span>$upstream_addr&#34; <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;&#34;</span>$upstream_bytes_sent&#34; <span style="color:#e6db74">&#34;</span>$upstream_bytes_received&#34; <span style="color:#e6db74">&#34;</span>$upstream_connect_time&#34;&#39;;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">upstream</span> <span style="color:#e6db74">mysql</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server</span> 172.16.100.10:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server</span> 172.16.100.11:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server</span> 172.16.100.12:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">listen</span> <span style="color:#ae81ff">3306</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#e6db74">2s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_timeout</span> <span style="color:#e6db74">900s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">mysql</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">access_log</span>  <span style="color:#e6db74">/dev/stdout</span> <span style="color:#e6db74">main</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>       <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>  <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_tokens</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 指定字符集
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">charset</span> <span style="color:#e6db74">utf-8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#sendfile参数控制文件高效传输模式，同时将tcp_nopush和tcp_nodelay设置为on防止网络阻塞
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">sendfile</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tcp_nopush</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#在keepalive开启才有效
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">tcp_nodelay</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#设置客户端保持会话的时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">keepalive_timeout</span> <span style="color:#ae81ff">60</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#设置客户端请求头读取超时时间，如果超过这个时间，客户端还没有发送任何数据，nginx将返回&#34;request time out(408)&#34;错误
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">client_header_timeout</span> <span style="color:#ae81ff">15</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#设置客户端请求主体读取超时时间，如果超过这个时间，客户端还没有发送任何数据，nginx将返回&#34;request time out(408)&#34;错误，默认时长60
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">send_timeout</span> <span style="color:#ae81ff">60</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">################################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#开启压缩
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#压缩对象的最小大小（小于1k不压缩）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_min_length</span> <span style="color:#ae81ff">1k</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#压缩缓冲区，申请4个单位为16k的内存空间作为缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_buffers</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">16k</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#压缩版本(默认1.1，前端为squid2.5时使用1.0)用于设置识别http协议版本，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#压缩比例 1压缩比最小 9压缩比最大
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_comp_level</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#指定压缩的类型，&#34;text/html&#34;类型总是被压缩.类型cat mime.types
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_types</span> <span style="color:#e6db74">text/plain</span> <span style="color:#e6db74">application/x-javascript</span> <span style="color:#e6db74">text/css</span> <span style="color:#e6db74">application/xml</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#告诉前端缓存服务器不要解压，到客户端时才解压.发送vary:Accept_Enconding 响应头字段，从而通知接收方我做了gzip 压缩
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#e6db74">gzip_vary</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># nginx做反向代理时，按照后端web服务器的压缩策略设置gzip 参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_proxied</span> <span style="color:#e6db74">any</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 关闭对ie6 的压缩
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_disable</span> <span style="color:#e6db74">&#34;msie6&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_names_hash_max_size</span>  <span style="color:#ae81ff">1024</span>;  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_names_hash_bucket_size</span>   <span style="color:#ae81ff">512</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 七层代理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">upstream</span> <span style="color:#e6db74">backend</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># backup 当其他主机失败后使用该主机，不能用在 hash ip_hash 和random 调度算法中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e"># down 当前主机不可用，当使用ip_hash 中标记为down不会影响hash值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">server</span> 172.16.100.10:<span style="color:#ae81ff">8080</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> 172.16.100.11:<span style="color:#ae81ff">8080</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> 172.16.100.12:<span style="color:#ae81ff">8080</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> 172.16.100.13:<span style="color:#ae81ff">8080</span>   <span style="color:#e6db74">backup</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> 172.16.100.14:<span style="color:#ae81ff">8080</span>   <span style="color:#e6db74">backup</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 设置X-Real-IP头，让服务端看到客户端的真实IP地址。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">proxy_set_header</span>  <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 设置X-Forwarded-For头，添加原始请求的IP地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">proxy_set_header</span>  <span style="color:#e6db74">X-Forwarded-For</span> $remote_addr;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 设置代理请求的Host头，使用请求的原始主机名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 设置客户端请求的最大body大小为50MB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">client_max_body_size</span> <span style="color:#ae81ff">50m</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 设置客户端请求body的缓冲区大小为256KB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">client_body_buffer_size</span> <span style="color:#ae81ff">256k</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/backend</span> {
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">localhost</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></details>

<h3 id="参数解释">参数解释</h3>
<p><strong>cup亲和力绑定</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>global</code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">worker_cpu_affinity</span> <span style="color:#ae81ff">0001</span> <span style="color:#ae81ff">0010</span> <span style="color:#ae81ff">0100</span> <span style="color:#ae81ff">1000</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#worker_processes 8;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#worker_cpu_affinity 0001 0010 0100 1000 0001 0010 0100 1000;
</span></span></span></code></pre></div><p><strong>事件模型优化</strong></p>


<div class="alert alert-primary" role="alert">


    <p>位置：全局 <code>global</code> 中<code>events</code>指令下</p>
<p>推荐：
在linux中使用<code>epoll</code>模型；
在freebsd中使用<code>kqueue</code>模型；
在solaris中使用<code>/dev/poll</code>的模式；
在windows中使用<code>icop</code>模型</p>


</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">use</span> <span style="color:#e6db74">epoll</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#单个进程最大连接数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">2048</span>;  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>单个worker可以打开的最大文件描述符</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>global</code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e">#指定work进程打开的最大文件数，可设置为系统ulimit -HSn的结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">worker_rlimit_nofile</span> <span style="color:#ae81ff">65535</span>;
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-d0f39a2ca728b30b9d3532605c8e36a3">http服务器</h1>
	<div class="lead">http服务器|nginx</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-22" class="text-body-secondary">Thursday, May 22, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<p>nginx 是一个高性能的HTTP和反向代理服务器，本章主要介绍nginx的http服务器配置。</p>
<h3 id="基于ip的多虚拟机">基于ip的多虚拟机</h3>

<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>       <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>  <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sendfile</span>        <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keepalive_timeout</span>  <span style="color:#ae81ff">65</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务一
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       192.168.0.106:<span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">localhost</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务二
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       192.168.0.236:<span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">localhost</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }    
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></details>

<h3 id="基于端口的多虚拟机">基于端口的多虚拟机</h3>

<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>       <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>  <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sendfile</span>        <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keepalive_timeout</span>  <span style="color:#ae81ff">65</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务一
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">localhost</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务二
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">81</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">localhost</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }    
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></details>

<h3 id="基于域名的多虚拟机">基于域名的多虚拟机</h3>

<details>
  <summary>Details</summary>
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>       <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>  <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sendfile</span>        <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keepalive_timeout</span>  <span style="color:#ae81ff">65</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务一
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">docs.zero-dew.com</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务二
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">blog.zero-dew.com</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }    
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></details>

<h3 id="基于用户名密码的简单认证">基于用户名密码的简单认证</h3>

<details>
  <summary>Details</summary>
  <p>生成用户名和密码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo user01:<span style="color:#e6db74">`</span>openssl passwd 456<span style="color:#e6db74">`</span> &gt;&gt;/opt/nginx/passwd
</span></span><span style="display:flex;"><span>echo user02:<span style="color:#e6db74">`</span>openssl passwd 456<span style="color:#e6db74">`</span> &gt;&gt;/opt/nginx/passwd
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>       <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>  <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sendfile</span>        <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keepalive_timeout</span>  <span style="color:#ae81ff">65</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">localhost</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">####
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">auth_basic</span> <span style="color:#e6db74">&#34;Restricted</span> <span style="color:#e6db74">Content&#34;</span>;  
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">auth_basic_user_file</span> <span style="color:#e6db74">passwd</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">####
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">error_page</span>   <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> = <span style="color:#e6db74">/50x.html</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></details>

<h3 id="基于ssl的https服务">基于SSL的HTTPS服务</h3>

<details>
  <summary>Details</summary>
  <p>生成证书</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /opt/nginx/conf/ssl
</span></span><span style="display:flex;"><span>cd /opt/nginx/conf/ssl
</span></span><span style="display:flex;"><span>openssl genrsa -out server.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl req -new -key server.key -out server.csr -subj <span style="color:#e6db74">&#34;/C=CN/ST=GD/L=SZ/O=zero-dew.com/CN=docs.zero-dew.com&#34;</span>
</span></span><span style="display:flex;"><span>openssl x509 -req -in server.csr -out server.crt -signkey server.key -days <span style="color:#ae81ff">3650</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>       <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>  <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sendfile</span>        <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keepalive_timeout</span>  <span style="color:#ae81ff">65</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span> <span style="color:#e6db74">docs.zero-dew.com</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 所有80端口的请求都重定向到443端口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">return</span> <span style="color:#ae81ff">301</span> <span style="color:#e6db74">https://</span>$host$request_uri;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server_name</span> <span style="color:#e6db74">docs.zero-dew.com</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 指定SSL证书和私钥的位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">ssl_certificate</span> <span style="color:#e6db74">ssl/server.crt</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ssl_certificate_key</span> <span style="color:#e6db74">ssl/server.key</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># SSL会话超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">ssl_session_timeout</span> <span style="color:#ae81ff">10m</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 指定SSL密码套件，使用安全的加密套件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">ssl_ciphers</span> <span style="color:#e6db74">ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 指定支持的TLS协议版本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">ssl_protocols</span> <span style="color:#e6db74">TLSv1</span> <span style="color:#e6db74">TLSv1.1</span> <span style="color:#e6db74">TLSv1.2</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 优先使用服务器指定的密码套件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">ssl_prefer_server_ciphers</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 配置HTTPS下的访问规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">root</span>   <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></details>

<h3 id="配置指令解释">配置指令解释</h3>
<p><strong>隐藏版本号</strong>


<div class="alert alert-primary" role="alert">


    位置： <code>http</code> 指令下

</div>
</p>
<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server_tokens</span> <span style="color:#66d9ef">off</span>;
</span></span></code></pre></div><p><strong>开启高效文件传输模式</strong>


<div class="alert alert-primary" role="alert">


    <p>Nginx的sendfile指令用于控制文件传输的高效模式，同时将tcp_nopush和tcp_nodelay设置为on防止网络阻塞。</p>
<p>位置：<code>http</code> 、<code>server</code> 或 <code>location</code> 指令下</p>


</div>
</p>
<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">sendfile</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">tcp_nopush</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">tcp_nodelay</span> <span style="color:#66d9ef">on</span>;  <span style="color:#75715e">#在keepalive开启才有效
</span></span></span></code></pre></div><p><strong>设置连接超时时间</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>http</code> 、<code>server</code>  指令下

</div>
</p>
<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e">#设置客户端保持会话的时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">keepalive_timeout</span> <span style="color:#ae81ff">60</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#设置客户端请求头读取超时时间，如果超过这个时间，客户端还没有发送任何数据，nginx将返回&#34;request time out(408)&#34;错误
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">client_header_timeout</span> <span style="color:#ae81ff">15</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#设置客户端请求主体读取超时时间，如果超过这个时间，客户端还没有发送任何数据，nginx将返回&#34;request time out(408)&#34;错误，默认时长60
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">send_timeout</span> <span style="color:#ae81ff">60</span>;
</span></span></code></pre></div><p><strong>nginx  gzip压缩功能</strong></p>


<div class="alert alert-primary" role="alert">


    位置：<code>http</code> 、<code>server</code>  指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e">#开启压缩
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#压缩对象的最小大小（小于1k不压缩）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_min_length</span> <span style="color:#ae81ff">1k</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#压缩缓冲区，申请4个单位为16k的内存空间作为缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_buffers</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">16k</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#压缩版本(默认1.1，前端为squid2.5时使用1.0)用于设置识别http协议版本，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.0</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#压缩比例 1压缩比最小 9压缩比最大
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_comp_level</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#指定压缩的类型，&#34;text/html&#34;类型总是被压缩.类型cat mime.types
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_types</span> <span style="color:#e6db74">text/plain</span> <span style="color:#e6db74">application/x-javascript</span> <span style="color:#e6db74">text/css</span> <span style="color:#e6db74">application/xml</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#告诉前端缓存服务器不要解压，到客户端时才解压.发送vary:Accept_Enconding 响应头字段，从而通知接收方我做了gzip 压缩
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">gzip_vary</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx做反向代理时，按照后端web服务器的压缩策略设置gzip 参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_proxied</span> <span style="color:#e6db74">any</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关闭对ie6 的压缩
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_disable</span> <span style="color:#e6db74">&#34;msie6&#34;</span>;
</span></span></code></pre></div><p><strong>浏览器缓存功能</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>http</code> 、<code>server</code> <code>location</code> 指令下

</div>
</p>
<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~<span style="color:#e6db74">.*\.(gif|jpg|png|bmp|swf)$</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expires</span> <span style="color:#e6db74">3650d</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~<span style="color:#e6db74">.*\.(js|css)?$</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expires</span> <span style="color:#e6db74">30d</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~<span style="color:#e6db74">(roboots.txt)</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">log_not_found</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">expires</span> <span style="color:#e6db74">7d</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>客户端请求的最大大小</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>http</code> 、<code>server</code> <code>location</code> 指令下

</div>
</p>
<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#超过这个值提示 413错误 ，值0=&gt;不控制 </span>
</span></span><span style="display:flex;"><span>client_max_body_size   16M;
</span></span></code></pre></div><p><strong>root</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>http, server, location</code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span>  <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">root</span>  <span style="color:#e6db74">/var/www/html</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>server</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>http</code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {}
</span></span></code></pre></div><p><strong>listen</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>server</code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">listen</span> 127.0.0.1:<span style="color:#ae81ff">8000</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">listen</span> 127.0.0.1;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">listen</span> <span style="color:#ae81ff">8000</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">listen</span> <span style="color:#e6db74">*:8000</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">listen</span> localhost:<span style="color:#ae81ff">8000</span>;
</span></span></code></pre></div><p><strong>server_name</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>server </code> 指令下

</div>



<div class="alert alert-primary" role="alert">


    <p>Nginx使用哈希表来快速查找匹配的server块，而这两个参数分别控制哈希表的总容量和每个桶的大小。max_size是哈希表的总槽位数，而bucket_size是每个槽位占用的内存大小</p>
<p>位置： <code>http</code> 指令下</p>


</div>



<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">报错提示</h4>

    <code>nginx: [warn] could not build optimal server_names_hash, you should increase either server_names_hash_max_size: 512 or server_names_hash_bucket_size: 64; ignoring server_names_hash_bucket_size</code>

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 支持多个
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">server_name</span> <span style="color:#e6db74">test1.go.dev</span> <span style="color:#e6db74">test2.go.dev</span> <span style="color:#e6db74">*.python.dev</span> <span style="color:#e6db74">test.dev.*</span>; 
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 为了提高匹配server_name的速度，nginx将server_name hash后存储,这里设置么个hash桶占用内存的大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">server_names_hash_bucket_size</span> <span style="color:#ae81ff">128</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 该值越大，hash冲突的可能性越小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">server_names_hash_max_size</span> <span style="color:#ae81ff">512</span>;  <span style="color:#75715e">#必须2的幂次方
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><strong>alias</strong></p>


<div class="alert alert-primary" role="alert">


    <p>位置：全局 <code>location</code> 指令下</p>
<p>语法：<code>alias file-path|directory-path;</code></p>


</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 例如请求 http://127.0.0.1/test/nginx.conf =&gt; /etc/nginx/conf/nginx.conf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/conf</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">aliase</span> <span style="color:#e6db74">/etc/nginx/conf/</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 例如请求 http://127.0.0.1/test/nginx.conf =&gt; /etc/nginx/conf/nginx.conf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">location</span> ~ <span style="color:#e6db74">^/test/(\w+)\.(\w+)$</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">aliase</span> <span style="color:#e6db74">/etc/nginx/</span>$2/$1.$2;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>index</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>server, location </code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span>  <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">root</span>  <span style="color:#e6db74">/var/www/html</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.php</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>error_page</strong></p>


<div class="alert alert-primary" role="alert">


    位置：全局 <code>http server location if </code> 指令下

</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">404</span> <span style="color:#e6db74">/404.html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span> <span style="color:#e6db74">/50x.html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">403</span> <span style="color:#e6db74">http://127.0.0.1/forbidden.html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 如果重定向后仍然与原来的相同，可以使用 如下格式修改状态码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">404</span> = <span style="color:#ae81ff">200</span> <span style="color:#e6db74">/empty.html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 如果不想修改状态码只是想让重定向到另一个location 可以这样写
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">404</span> = <span style="color:#e6db74">@fetch</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">@fetch</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://other</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>autoindex</strong></p>


<div class="alert alert-primary" role="alert">


    <p>模块：<code>ngx_http_autoindex_module</code></p>
<p>位置：全局 <code>http, server, location</code> 指令下</p>


</div>

<p>配置示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span>  <span style="color:#e6db74">/</span>  {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">autoindex</span>  <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>location指令详解</strong></p>


<div class="alert alert-primary" role="alert">


    <p>所属模块：<code>ngx_http_core_module</code></p>
<p>位置：<code>server、location</code></p>
<p>语法：<code>location [=|~|~*|^~|@] /uri/ { ... }</code></p>


</div>

<table>
  <thead>
      <tr>
          <th>匹配动作</th>
          <th>解释</th>
          <th>优先级</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>=</td>
          <td>精确匹配</td>
          <td>1</td>
      </tr>
      <tr>
          <td>^~</td>
          <td>匹配以xx开头,忽略正则</td>
          <td>2</td>
      </tr>
      <tr>
          <td>/html/</td>
          <td>匹配目录</td>
          <td>3</td>
      </tr>
      <tr>
          <td>~</td>
          <td>匹配正则 区分大小写</td>
          <td>4</td>
      </tr>
      <tr>
          <td>~*</td>
          <td>匹配正则 不区分大小写</td>
          <td>4</td>
      </tr>
      <tr>
          <td>/</td>
          <td>默认规则</td>
          <td>5</td>
      </tr>
      <tr>
          <td>@</td>
          <td>内部的重定向</td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><em>在location 最经常使用的参数为proxy_pass，接下来参照下图解释proxy_pass中路径拼接规则</em>


<div class="alert alert-primary" role="alert">


    <p><code>location /foo { proxy_pass http://host/bar; }</code>
如果 location 后面没有 /，Nginx 会把请求的 URI 不变地拼接到 proxy_pass 后的地址。</p>
<p><code>location /foo/ { proxy_pass http://host/bar/; }</code>
如果 location 后面有 /，Nginx 会把匹配到的前缀 /foo/ 去掉，然后把剩下的 URI 拼接到 proxy_pass 后的地址</p>


</div>
</p>
<p><strong>示例：</strong></p>
<pre class="mermaid">flowchart LR
    A(nginx)
    B(prometheus)
    C(alertmanager)
    D(grafana)
    
    z&gt;浏览器] --&gt; A
    
    A -..-&gt;|/prom| B
    A -..-&gt;|/alert| C
    A -..-&gt;|/grafana| D
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style C fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style D fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5</pre>


  
  
  
<ul class="nav nav-tabs" id="tabs-23" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-23-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-23-00" role="tab"
          data-td-tp-persist="location匹配不以`/`结尾" aria-controls="tabs-23-00" aria-selected="true">
        location匹配不以<code>/</code>结尾
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-23-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-23-01" role="tab"
          data-td-tp-persist="location匹配以`/`结尾(推荐)" aria-controls="tabs-23-01" aria-selected="false">
        location匹配以<code>/</code>结尾(推荐)
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-23-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-23-02" role="tab"
          data-td-tp-persist="修改访问url" aria-controls="tabs-23-02" aria-selected="false">
        修改访问url
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-23-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-23-00" role="tabpanel" aria-labelled-by="tabs-23-00-tab" tabindex="23">
        <div class="alert alert-primary" role="alert">
<h4 class="alert-heading">正确配置</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/graph 直接拼接到 http://192.168.0.161:9090/prom 后面，变成http://192.168.0.161:9090/prom/graph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom</span>;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>       }
</span></span></code></pre></div><div class="alert alert-warning" role="alert">
<h4 class="alert-heading">错误配置，显示404</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/graph 直接拼接到 http://192.168.0.161:9090/prom/ 后面，变成http://192.168.0.161:9090/prom//graph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom/</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-23-01" role="tabpanel" aria-labelled-by="tabs-23-01-tab" tabindex="23">
        <div class="alert alert-primary" role="alert">
<h4 class="alert-heading">正确配置</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/ 去掉，剩下 graph，拼接到 http://192.168.0.161:9090/prom/ 后面，变成http://192.168.0.161:9090/prom/graph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>         <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom/</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><div class="alert alert-warning" role="alert">
<h4 class="alert-heading">错误配置，显示404</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/ 去掉，剩下 graph，拼接到 http://192.168.0.161:9090/prom 后面，变成http://192.168.0.161:9090/promgraph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>         <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-23-02" role="tabpanel" aria-labelled-by="tabs-23-02-tab" tabindex="23">
        <p>默认情况下，nginx会将请求转发到后端的服务器上，而不会将请求的路径进行修改。如果需要将请求的路径进行修改，可以使用  <code>proxy_redirect</code> 指令。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>       <span style="color:#66d9ef">location</span> = <span style="color:#e6db74">/abc</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">return</span> <span style="color:#ae81ff">301</span> <span style="color:#e6db74">/abc/</span>;
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/abc/</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom/</span>;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_redirect</span> <span style="color:#e6db74">/prom/</span> <span style="color:#e6db74">/abc/</span>;
</span></span><span style="display:flex;"><span>       }
</span></span></code></pre></div>
    </div>
</div>


</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-bd8fa7533b3710dac09a20bf9487ec31">反向代理</h1>
	<div class="lead">7层反向代理|nginx</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-22" class="text-body-secondary">Thursday, May 22, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h1 id="反向代理">反向代理</h1>
<p>nginx 是一个高性能的HTTP和反向代理服务器，本章主要介绍nginx的反向代理配置。</p>

  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="四层代理" aria-controls="tabs-00-00" aria-selected="true">
        四层代理
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="七层代理" aria-controls="tabs-00-01" aria-selected="false">
        七层代理
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Info</h4>
<pre><code>nginx 在1.9 版本后开始支持 4层代理
</code></pre>
</div>
<p>配置文件示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">user</span>  <span style="color:#e6db74">nginx</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">stream</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">log_format</span> <span style="color:#e6db74">main</span> <span style="color:#e6db74">&#39;</span>$remote_addr <span style="color:#e6db74">[</span>$time_local] <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;</span>$protocol $status $bytes_sent $bytes_received <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;</span>$session_time <span style="color:#e6db74">&#34;</span>$upstream_addr&#34; <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;&#34;</span>$upstream_bytes_sent&#34; <span style="color:#e6db74">&#34;</span>$upstream_bytes_received&#34; <span style="color:#e6db74">&#34;</span>$upstream_connect_time&#34;&#39;;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">upstream</span> <span style="color:#e6db74">mysql</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server</span> 172.16.100.10:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server</span> 172.16.100.11:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server</span> 172.16.100.12:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">listen</span> <span style="color:#ae81ff">3306</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#e6db74">2s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_timeout</span> <span style="color:#e6db74">900s</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">mysql</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">access_log</span>  <span style="color:#e6db74">/dev/stdout</span> <span style="color:#e6db74">main</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">user</span>  <span style="color:#e6db74">nginx</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">worker_processes</span>  <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span><span style="color:#f92672">upstream</span> <span style="color:#e6db74">backend</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># backup 当其他主机失败后使用该主机，不能用在 hash ip_hash 和random 调度算法中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># down 当前主机不可用，当使用ip_hash 中标记为down不会影响hash值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> 172.16.100.10:<span style="color:#ae81ff">8080</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 172.16.100.11:<span style="color:#ae81ff">8080</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 172.16.100.12:<span style="color:#ae81ff">8080</span> <span style="color:#e6db74">weight=1</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 172.16.100.13:<span style="color:#ae81ff">8080</span>   <span style="color:#e6db74">backup</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 172.16.100.14:<span style="color:#ae81ff">8080</span>   <span style="color:#e6db74">backup</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 设置X-Real-IP头，让服务端看到客户端的真实IP地址。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_set_header</span>  <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 设置X-Forwarded-For头，添加原始请求的IP地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_set_header</span>  <span style="color:#e6db74">X-Forwarded-For</span> $remote_addr;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 设置代理请求的Host头，使用请求的原始主机名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 设置客户端请求的最大body大小为50MB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">client_max_body_size</span> <span style="color:#ae81ff">50m</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 设置客户端请求body的缓冲区大小为256KB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">client_body_buffer_size</span> <span style="color:#ae81ff">256k</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
</div>

<p>对于七层代理服务器主要有<a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html" target="_blank">ngx_http_upstream_module</a>和<a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html" target="_blank">ngx_http_proxy_module</a> 模块实现，</p>
<h3 id="ngx_"><strong>ngx_http_proxy_module</strong></h3>
<ol>
<li>
<p>proxy_set_header 设置 http 请求 header并传递给后端服务器。 格式 <code>proxy_set_header field value;</code></p>
</li>
<li>
<p>proxy_pass 把用户的请求转向到反向代理定义的 upstream 服务器池</p>
</li>
<li>
<p>proxy_redirect 重写location并刷新从upstream server收到的报文的首部；</p>
</li>
<li>
<p>client_body_buffer_size  指定客户端请求主体缓冲区大小</p>
</li>
<li>
<p>proxy_connect_timeout 30s; 反向代理与后端节点服务器连接的超时时间</p>
</li>
<li>
<p>proxy_send_timeout 在规定时间之内后端服务器必须传完所有数据，否则 Nginx 将断开这个连接</p>
</li>
<li>
<p>proxy_read_timeout Nginx 从代理的后端服务器获取信息的超时时间</p>
</li>
<li>
<p>proxy_buffering on; #如果缓冲区开启，把内容保存在由指令 proxy_buffer_size  proxy_buffers</p>
</li>
<li>
<p>proxy_buffer_size 32k;  #默认来说,该缓冲区大小等于指令proxy_buffers</p>
</li>
<li>
<p>proxy_buffers 32 4k;  设置缓冲区的数量和大小，Nginx 从代理的后端服务器获取的响应信息会放置到缓冲区</p>
</li>
<li>
<p>proxy_busy_buffers_size 64k;  设置系统很忙时使用的 proxy_buffers 大小，官方推荐为 proxy_buffers * 2</p>
</li>
<li>
<p>proxy_temp_file_write_size  指定 proxy 缓存临时文件的大小</p>
</li>
<li>
<p>proxy_next_upstream error timeout  #请求发生错误分配到写一个web</p>
</li>
<li>
<p>proxy_cookie_domain 将upstream server通过Set-Cookie首部设定的domain属性修改为指定的值，其值可以为一个字符串、正则表达式的模式或一个引用的变量；</p>
</li>
<li>
<p>proxy_cookie_path 将upstream server通过Set-Cookie首部设定的path属性修改为指定的值，其值可以为一个字符串、正则表达式的模式或一个引用的变量；</p>
</li>
<li>
<p>proxy_hide_header 设定发送给客户端的报文中需要隐藏的首部；</p>
</li>
</ol>
<p><strong>获取到真实的用户ip</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>server</code> <code>location </code> 指令下

</div>
</p>
<p>配置示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend_server</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;                      <span style="color:#75715e"># 客户端真实 IP（单值）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;  <span style="color:#75715e"># 记录完整的代理路径（多层代理时拼接所有中间节点 IP）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-Proto</span> $scheme;                   <span style="color:#75715e"># 协议（http/https）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><strong>重写发送给后端的http请求头的Host</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>server</code> <code>location </code> 指令下

</div>
</p>
<p>配置示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend_server</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>设置代理连接超时时间</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>server</code> <code>location </code> 指令下

</div>
</p>
<p>配置示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend_server</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#ae81ff">30</span>;           <span style="color:#75715e"># 设置代理连接超时时间为30秒。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_send_timeout</span> <span style="color:#ae81ff">30</span>;              <span style="color:#75715e"># 设置代理发送请求的超时时间为30秒。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_read_timeout</span> <span style="color:#ae81ff">60</span>;              <span style="color:#75715e"># 设置代理读取响应的超时时间为60秒。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><strong>设置代理buffer</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>server</code> <code>location </code> 指令下

</div>
</p>
<p>配置示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend_server</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_buffering</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_buffer_size</span> <span style="color:#ae81ff">32k</span>;            <span style="color:#75715e"># 设置代理缓冲区的大小为4KB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_buffers</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">32k</span>;             <span style="color:#75715e"># 设置代理缓冲区的数量和大小 为4*32KB。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_busy_buffers_size</span> <span style="color:#ae81ff">64k</span>;     <span style="color:#75715e"># 设置代理繁忙缓冲区的大小为64KB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><strong>提高代理的容错能力</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>server</code> <code>location </code> 指令下

</div>
</p>
<p>配置示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend_server</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 定义当出现错误、超时、无效头部、或HTTP状态码为500、503、404时，请求将被转发到下一个上游服务器。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_next_upstream</span> <span style="color:#e6db74">error</span> <span style="color:#e6db74">timeout</span> <span style="color:#e6db74">invalid_header</span> <span style="color:#e6db74">http_500</span> <span style="color:#e6db74">http_503</span> <span style="color:#e6db74">http_404</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>镜像静态内容到本地磁盘</strong>


<div class="alert alert-primary" role="alert">


    位置：<code>server</code> <code>location </code> 指令下

</div>
</p>
<p>配置示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend_server</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_store</span> <span style="color:#66d9ef">on</span>;                             <span style="color:#75715e"># 开启代理存储静态内容到磁盘的功能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_store_access</span> <span style="color:#e6db74">user:rw</span> <span style="color:#e6db74">group:rw</span> <span style="color:#e6db74">all:r</span>;  <span style="color:#75715e"># 设置代理存储文件的访问权限。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_temp_path</span> <span style="color:#e6db74">/dev/shm/nginx_proxy</span>;       <span style="color:#75715e"># 定义了代理临时文件存储的路径
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h3 id="调度算法">调度算法</h3>
<p>Nginx使用的负载均衡调度算法主要有以下几种：</p>
<ol>
<li>
<p><strong>轮询（rr Round Robin）</strong>：这是默认的负载均衡算法。每个请求按时间顺序逐一分配到不同的后端服务器，如果服务器down掉，能自动剔除。</p>
</li>
<li>
<p><strong>加权轮询（wrr Weighted Round Robin）</strong>：与轮询类似，但是不同的后端服务器可以设置不同的权重，可以根据服务器的处理能力，分配不同数量的请求。权重越高，分配的请求越多。</p>
</li>
<li>
<p><strong>最少连接（least_conn Least Connections）</strong>：优先分配给当前连接数最少的服务器，适用于请求处理时间相差较大的情况。</p>
</li>
<li>
<p><strong>IP Hash(ip_hash)</strong>：根据请求的IP的hash结果分配，每个请求会固定访问一个后端服务器，适用于需要会话保持的应用。这有助于为缓存服务器实现更高的缓存命中率,如果其中一台服务器需要临时删除，则应使用down参数标记该服务器，以保留客户端IP地址的当前哈希值</p>
</li>
<li>
<p><strong>URL Hash(url_hash)</strong>：根据请求的URL的hash结果来分配请求，使得每个URL定向到同一个后端服务器，适用于服务器缓存时提高效率。</p>
</li>
<li>
<p><strong>Fair（第三方）</strong>：按后端服务器的响应时间来分配请求，响应时间短的优先分配。</p>
</li>
<li>
<p><strong>URL参数（第三方）</strong>：按照URL中带的参数进行hash，然后进行请求分发，可以实现会话保持。</p>
</li>
</ol>
<p><em>以上算法可以通过在Nginx的http或stream模块中使用upstream指令来配置。</em></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-bb64f1e09c3c57ef9271a135603f6231">location指令</h1>
	<div class="lead">location指令|nginx</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-23" class="text-body-secondary">Friday, May 23, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<h3 id="location"><strong>location</strong></h3>


<div class="alert alert-primary" role="alert">


    <p>所属模块：<code>ngx_http_core_module</code></p>
<p>位置：<code>server、location</code></p>
<p>语法：<code>location [=|~|~*|^~|@] /uri/ { ... }</code></p>


</div>

<table>
  <thead>
      <tr>
          <th>匹配动作</th>
          <th>解释</th>
          <th>优先级</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>=</td>
          <td>精确匹配</td>
          <td>1</td>
      </tr>
      <tr>
          <td>^~</td>
          <td>匹配以xx开头,忽略正则</td>
          <td>2</td>
      </tr>
      <tr>
          <td>/html/</td>
          <td>匹配目录</td>
          <td>3</td>
      </tr>
      <tr>
          <td>~</td>
          <td>匹配正则 区分大小写</td>
          <td>4</td>
      </tr>
      <tr>
          <td>~*</td>
          <td>匹配正则 不区分大小写</td>
          <td>4</td>
      </tr>
      <tr>
          <td>/</td>
          <td>默认规则</td>
          <td>5</td>
      </tr>
      <tr>
          <td>@</td>
          <td>内部的重定向</td>
          <td></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~ <span style="color:#e6db74">.*\.(js|jpg|jpeg|JPEG|css|BMP|gif|GIF)$</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">access_log</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">expires</span> <span style="color:#e6db74">3650d</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~ <span style="color:#e6db74">^/images/.*\.(php|php5)$</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~ <span style="color:#e6db74">^/static..*\.(php|php5)$</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">^/data/(attachment|avatar)/.*\.(php|php5)</span>$ {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~ <span style="color:#e6db74">(roboots.txt)</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">log_not_found</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">expires</span> <span style="color:#e6db74">7d</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">set</span> $memcached_key $uri;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">memcached_pass</span>     name:<span style="color:#ae81ff">11211</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default_type</span>       <span style="color:#e6db74">text/html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">error_page</span>         <span style="color:#ae81ff">404</span> <span style="color:#e6db74">@fallback</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">location</span> <span style="color:#e6db74">@fallback</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><em>在location 最经常使用的参数为proxy_pass，接下来参照下图解释proxy_pass中路径拼接规则</em>


<div class="alert alert-primary" role="alert">


    <p><code>location /foo { proxy_pass http://host/bar; }</code>
如果 location 后面没有 /，Nginx 会把请求的 URI 不变地拼接到 proxy_pass 后的地址。</p>
<p><code>location /foo/ { proxy_pass http://host/bar/; }</code>
如果 location 后面有 /，Nginx 会把匹配到的前缀 /foo/ 去掉，然后把剩下的 URI 拼接到 proxy_pass 后的地址</p>


</div>
</p>
<p><strong>示例：</strong></p>
<pre class="mermaid">flowchart LR
    A(nginx)
    B(prometheus)
    C(alertmanager)
    D(grafana)
    
    z&gt;浏览器] --&gt; A
    
    A -..-&gt;|/prom| B
    A -..-&gt;|/alert| C
    A -..-&gt;|/grafana| D
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style C fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style D fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5</pre>


  
  
  
<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          data-td-tp-persist="location匹配不以`/`结尾" aria-controls="tabs-02-00" aria-selected="true">
        location匹配不以<code>/</code>结尾
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="location匹配以`/`结尾(推荐)" aria-controls="tabs-02-01" aria-selected="false">
        location匹配以<code>/</code>结尾(推荐)
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-02" role="tab"
          data-td-tp-persist="修改访问url" aria-controls="tabs-02-02" aria-selected="false">
        修改访问url
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        <div class="alert alert-primary" role="alert">
<h4 class="alert-heading">正确配置</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/graph 直接拼接到 http://192.168.0.161:9090/prom 后面，变成http://192.168.0.161:9090/prom/graph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom</span>;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>       }
</span></span></code></pre></div><div class="alert alert-warning" role="alert">
<h4 class="alert-heading">错误配置，显示404</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/graph 直接拼接到 http://192.168.0.161:9090/prom/ 后面，变成http://192.168.0.161:9090/prom//graph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom/</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="alert alert-primary" role="alert">
<h4 class="alert-heading">正确配置</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/ 去掉，剩下 graph，拼接到 http://192.168.0.161:9090/prom/ 后面，变成http://192.168.0.161:9090/prom/graph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>         <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom/</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><div class="alert alert-warning" role="alert">
<h4 class="alert-heading">错误配置，显示404</h4>
<pre><code>访问 /prom/graph 时，Nginx 会把 /prom/ 去掉，剩下 graph，拼接到 http://192.168.0.161:9090/prom 后面，变成http://192.168.0.161:9090/promgraph
</code></pre>
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>         <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-02" role="tabpanel" aria-labelled-by="tabs-02-02-tab" tabindex="2">
        <p>默认情况下，nginx会将请求转发到后端的服务器上，而不会将请求的路径进行修改。如果需要将请求的路径进行修改，可以使用  <code>proxy_redirect</code> 指令。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>       <span style="color:#66d9ef">location</span> = <span style="color:#e6db74">/abc</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">return</span> <span style="color:#ae81ff">301</span> <span style="color:#e6db74">/abc/</span>;
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/abc/</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.0.161:9090/prom/</span>;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">proxy_redirect</span> <span style="color:#e6db74">/prom/</span> <span style="color:#e6db74">/abc/</span>;
</span></span><span style="display:flex;"><span>       }
</span></span></code></pre></div>
    </div>
</div>

<h3 id="rewrite"><strong>rewrite</strong></h3>
<p>rewrite <a href="https://www.cnblogs.com/likwo/p/6513117.html" target="_blank">https://www.cnblogs.com/likwo/p/6513117.html</a></p>
<p>Nginx 的 <code>rewrite</code> 指令的主要作用是通过<strong>重写请求 URI</strong>，从而满足安全、兼容、优化或特定业务逻辑需求</p>


<div class="alert alert-primary" role="alert">


    <p>所属模块：<code>ngx_http_core_module</code></p>
<p>位置：<code>server、location</code></p>
<p>基本语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">关键字</span>       <span style="color:#e6db74">正则表达式</span>        <span style="color:#e6db74">代替的内容</span>           <span style="color:#e6db74">重写类型</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">rewrite</span>     <span style="color:#e6db74">&lt;regex&gt;</span>        <span style="color:#e6db74">&lt;replacement&gt;</span>        <span style="color:#e6db74">&lt;flag&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &lt;regex&gt;: 可以是字符串或者正则来表示想要匹配的目标URL   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># &lt;replacement&gt;: 将正则匹配的内容替换成replacement
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># &lt;flag&gt;: 重写类型：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># last: 本条规则匹配完成后，继续向下匹配新的location URI规则；相当于Apache里(L)标记，表示完成rewrite，浏览器地址栏URL地址不变；一般写在server和if中;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># break: 本条规则匹配完成后，终止匹配，不再匹配后面的规则，浏览器地址栏URL地址不变；一般使用在location中；
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># redirect: 返回302临时重定向，浏览器地址会显示跳转后的URL地址；
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># permanent: 返回301永久重定向，浏览器地址栏会显示跳转后的URL地址；
</span></span></span></code></pre></div>

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>  <span style="color:#75715e"># 访问 /last.html 的时候，页面内容重写到 /index.html 中，并继续后面的匹配，浏览器地址栏URL地址不变
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">/last.html</span> <span style="color:#e6db74">/index.html</span> <span style="color:#e6db74">last</span>;    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 访问 /break.html 的时候，页面内容重写到 /index.html 中，并停止后续的匹配，浏览器地址栏URL地址不变；    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">/break.html</span> <span style="color:#e6db74">/index.html</span> <span style="color:#e6db74">break</span>;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 访问 /redirect.html 的时候，页面直接302定向到 /index.html中，浏览器地址URL跳为index.html     
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">/redirect.html</span> <span style="color:#e6db74">/index.html</span> <span style="color:#e6db74">redirect</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 访问 /permanent.html 的时候，页面直接301定向到 /index.html中，浏览器地址URL跳为index.html   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">/permanent.html</span> <span style="color:#e6db74">/index.html</span> <span style="color:#e6db74">permanent</span>;     
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 把 /html/*.html =&gt; /post/*.html ，301定向  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^/html/(.+?).html</span>$ <span style="color:#e6db74">/post/</span>$1.html <span style="color:#e6db74">permanent</span>;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 把 /search/key =&gt;/search.html?keyword=key   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^/search\/([^\/]+?)(\/|</span>$<span style="color:#e6db74">)</span> <span style="color:#e6db74">/search.html?keyword=</span>$1 <span style="color:#e6db74">permanent</span>;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 把当前域名的请求，跳转到新域名上，域名变化但路径不变    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^/(.*)</span> <span style="color:#e6db74">http://www.jd.com/</span>$1 <span style="color:#e6db74">permanent</span>;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 隐藏真实目录
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">server</span> {     
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">root</span> <span style="color:#e6db74">/var/www/html</span>;     <span style="color:#75715e"># 用 /html_test 来掩饰 html   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {        
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">/html_test</span> <span style="color:#e6db74">/html</span> <span style="color:#e6db74">break</span>;  <span style="color:#75715e"># 使用break拿一旦匹配成功则忽略后续location      
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span> <span style="color:#f92672">location</span> <span style="color:#e6db74">/html</span> {      
</span></span><span style="display:flex;"><span> <span style="color:#f92672">return</span> <span style="color:#ae81ff">403</span>;         <span style="color:#75715e"># 访问真实地址直接报没权限 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }       
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 对/images/bla_500x400.jpg文件请求，重写到/resizer/bla.jpg?width=500&amp;height=400地址，并会继续尝试匹配location。  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^/images/(.*)_(\d+)x(\d+)\.(png|jpg|gif)</span>$ <span style="color:#e6db74">/resizer/</span>$1.$4?width=$2&amp;height=$3? <span style="color:#e6db74">last</span>;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">20.防盗链</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">\.(jpg|gif|png|swf|flv|wmv|asf|mp3|mmf|zip|rar)</span>${
</span></span><span style="display:flex;"><span><span style="color:#e6db74">vaild_referers</span> <span style="color:#e6db74">none</span> <span style="color:#e6db74">blocked</span> <span style="color:#e6db74">*.etiantian.org</span> <span style="color:#e6db74">etiantian.org</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(</span>$incalid_referer<span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">rewirte</span> <span style="color:#e6db74">^/http://www.etiantian.org/img/nolink.jpg</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">21</span><span style="color:#e6db74">.伪静态（discuz）</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">rewrite</span> <span style="color:#e6db74">^([^\.]*)/topic-(.+)\.html</span>$ $1/portal.php?mod=topic&amp;topic=$2 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/article-([0-9]+)-([0-9]+)\.html</span>$ $1/portal.php?mod=view&amp;aid=$2&amp;page=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/forum-(\w+)-([0-9]+)\.html</span>$ $1/forum.php?mod=forumdisplay&amp;fid=$2&amp;page=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/thread-([0-9]+)-([0-9]+)-([0-9]+)\.html</span>$ $1/forum.php?mod=viewthread&amp;tid=$2&amp;extra=page%3D$4&amp;page=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/group-([0-9]+)-([0-9]+)\.html</span>$ $1/forum.php?mod=group&amp;fid=$2&amp;page=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/space-(username|uid)-(.+)\.html</span>$ $1/home.php?mod=space&amp;$2=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/blog-([0-9]+)-([0-9]+)\.html</span>$ $1/home.php?mod=space&amp;uid=$2&amp;do=blog&amp;id=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/(fid|tid)-([0-9]+)\.html</span>$ $1/index.php?action=$2&amp;value=$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^([^\.]*)/([a-z]+[a-z0-9_]*)-([a-z0-9_\-]+)\.html</span>$ $1/plugin.php?id=$2:$3 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(!-e</span> $request_filename<span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">return</span> <span style="color:#ae81ff">404</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^/images/(.*\.jpg)</span>$  <span style="color:#e6db74">/images2/</span>$1 <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^/abc/.*</span>$ <span style="color:#e6db74">/</span>$1/abc/ <span style="color:#e6db74">last</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/images/(.*\.jpg)</span>$  <span style="color:#e6db74">/images2/</span>$1 <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/abc/.*</span>$ <span style="color:#e6db74">/</span>$1/abc/ <span style="color:#e6db74">last</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">/images/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/images/(.*\.jpg)</span>$  <span style="color:#e6db74">/images2/</span>$1 <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">location</span> <span style="color:#e6db74">/abc/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/abc/(.*)</span>$ <span style="color:#e6db74">/</span>$1/abc/ <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/images/.*\.jpg</span>$ <span style="color:#e6db74">/images/b.jpg</span> <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">http://172.16.100.1/images/b.jpg</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">rewrite</span> <span style="color:#e6db74">&#34;^/test/(.*\.jpg)</span>$&#34; <span style="color:#e6db74">&#34;/test/repire.jpg&#34;</span> <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rewrite</span> <span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">一、设置一个简单的URL重写：</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">比如，某网站原有的论坛访问路径为/forum/，但后来根据要求需要更改为/bbs，于是，就可以通过下面的方法实现：</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">rewrite</span> <span style="color:#e6db74">^/forum/?</span>$ <span style="color:#e6db74">/bbs/</span> <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">http://172.16.100.1/forum/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#e6db74">、if指令：</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">语法:</span> <span style="color:#e6db74">if</span> <span style="color:#e6db74">(condition)</span> { <span style="color:#f92672">...</span> <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">应用环境:</span> <span style="color:#e6db74">server,</span> <span style="color:#e6db74">location</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">条件:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#e6db74">、变量名</span>; <span style="color:#f92672">false</span> <span style="color:#e6db74">values</span> <span style="color:#e6db74">are:</span> <span style="color:#e6db74">empty</span> <span style="color:#e6db74">string</span> <span style="color:#e6db74">(&#34;&#34;,</span> <span style="color:#e6db74">or</span> <span style="color:#e6db74">any</span> <span style="color:#e6db74">string</span> <span style="color:#e6db74">starting</span> <span style="color:#e6db74">with</span> <span style="color:#e6db74">&#34;0&#34;</span>;<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span><span style="color:#e6db74">、对于变量进行的比较表达式，可使用=或!=进行测试</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">3、正则表达式的模式匹配:</span>
</span></span><span style="display:flex;"><span>~  <span style="color:#e6db74">区分大小的模式匹配</span>
</span></span><span style="display:flex;"><span>~<span style="color:#e6db74">*</span> <span style="color:#e6db74">不区分字母大小写的模式匹配</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">!~</span> <span style="color:#e6db74">和</span> <span style="color:#e6db74">!~*</span> <span style="color:#e6db74">分别对上面的两种测试取反</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span><span style="color:#e6db74">、测试文件是否存在-f或!-f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span><span style="color:#e6db74">、测试目录是否存在-d或!-d</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span><span style="color:#e6db74">、测试目录、文件或链接文件的存在性-e或!-e</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7</span><span style="color:#e6db74">、检查一个文件的执行权限-x或!-x</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">在正则表达式中，可以使用圆括号标记匹配到的字符串，并可以分别使用</span>$1,$2,...,$9进行引用；
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">例如：</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">判断用户的浏览器类型：</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">MSIE)</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rewrite</span>  <span style="color:#e6db74">^(.*)</span>$  <span style="color:#e6db74">/msie/</span>$1  <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">opera)</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rewrite</span>  <span style="color:#e6db74">^(.*)</span>$  <span style="color:#e6db74">/opera/</span>$1  <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">如果用户请求的页面不存在，实现自定义跳转：</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">if</span> <span style="color:#e6db74">(!-f</span> $request_filename<span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^(/.*)</span>$ <span style="color:#e6db74">/rewrite.html</span> <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">实现域名跳转</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">server</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">jump.magedu.com</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.php</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">root</span> <span style="color:#e6db74">/www/htdocs</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/</span> <span style="color:#e6db74">http://www.magedu.com/</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">实现域名镜像</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">server</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">server_name</span> <span style="color:#e6db74">mirror.magedu.com</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.php</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">root</span> <span style="color:#e6db74">/www/htdocs</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/(.*)</span>$ <span style="color:#e6db74">http://www.magedu.com/</span>$1 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">简单的防盗链配置：</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">\.(gif|jpg|png|swf|flv)</span>$ {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">valid_referers</span> <span style="color:#e6db74">none</span> <span style="color:#e6db74">blocked</span> <span style="color:#e6db74">www.magedu.com</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$invalid_referer<span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/</span> <span style="color:#e6db74">http://www.magedu.com/403.html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># return 404
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">第一行：gif|jpg|png|swf|flv</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">表示对gif、jpg、png、swf、flv后缀的文件实行防盗链</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">第二行：www.magedu.com</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">表示对www.magedu.com这个来路进行判断if</span>{}<span style="color:#f92672">里面内容的意思是，如果来路不是指定来路就跳转到错误页面，当然直接返回404也是可以的。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">if</span> <span style="color:#e6db74">(!-e</span> $request_filename<span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/user/([0-9]+)/?</span>$ <span style="color:#e6db74">/view.php?go=user_</span>$1 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/component/id/([0-9]+)/?</span>$ <span style="color:#e6db74">/page.php?pageid=</span>$1 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/component/([^/]+)/?</span>$ <span style="color:#e6db74">/page.php?pagealias=</span>$1 <span style="color:#e6db74">last</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/category\_([0-9]+)\.htm</span>$ <span style="color:#e6db74">http://</span>$host/category/$1/ <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/showday\_([0-9]+)\_([0-9]+)\_([0-9]+)\.htm</span>$ <span style="color:#e6db74">http://</span>$host/date/$1/$2/$3/ <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">showday_1_2_3.htm</span> $host/date/1/2/3/
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">server</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span> <span style="color:#e6db74">default</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server_name</span> <span style="color:#e6db74">*.mysite.com</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^</span> <span style="color:#e6db74">http://mysite.com</span>$request_uri <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="if">if</h3>


<div class="alert alert-primary" role="alert">


    <p>if判断自定义和内置全局环境变量</p>
<p>位置: 全局 <code>location</code> 指令下</p>
<p>语法: <code>if (表达式) { };</code></p>


</div>

<blockquote>
<p>例如访问： <code>http://localhost:81/download/stat.php?id=1585378&amp;web_id=1585378 </code>    <br>
root：/var/www/html</p>
</blockquote>
<table>
  <thead>
      <tr>
          <th>变量</th>
          <th>解释</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>$args</code></td>
          <td>这个变量等于请求行中的参数，同$query_string</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$content_length</code></td>
          <td>请求头中的Content-length字段</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$content_type</code></td>
          <td>请求头中的Content-Type字段</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$document_root</code></td>
          <td>当前请求在root指令中指定的值</td>
          <td>/var/www/html</td>
      </tr>
      <tr>
          <td><code>$host</code></td>
          <td>请求主机头字段，否则为服务器名称</td>
          <td>localhost</td>
      </tr>
      <tr>
          <td><code>$http_user_agent</code></td>
          <td>客户端agent信息</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$http_cookie</code></td>
          <td>客户端cookie信息</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$limit_rate</code></td>
          <td>这个变量可以限制连接速率</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$request_method</code></td>
          <td>客户端请求的动作，通常为GET或POST</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$request_body_file</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>$request_filename</code></td>
          <td>当前请求的文件路径，由root或alias指令与URI请求生成</td>
          <td>/var/www/html/download/stat.php</td>
      </tr>
      <tr>
          <td><code>$request_uri</code></td>
          <td>包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”</td>
          <td>/download/stat.php?id=1585378&amp;web_id=1585378</td>
      </tr>
      <tr>
          <td><code>$query_string</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>$remote_addr</code></td>
          <td>客户端的IP地址</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$remote_port</code></td>
          <td>客户端的端口</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$remote_user</code></td>
          <td>已经经过Auth Basic Module验证的用户名</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$scheme</code></td>
          <td>HTTP方法（如http，https）</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$server_protocol</code></td>
          <td>请求使用的协议，通常是HTTP/1.0或HTTP/1.1</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$server_addr</code></td>
          <td>服务器地址，在完成一次系统调用后可以确定这个值</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$server_name</code></td>
          <td>服务器名称</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$server_port</code></td>
          <td>请求到达服务器的端口号</td>
          <td>81</td>
      </tr>
      <tr>
          <td><code>$uri</code></td>
          <td>不带请求参数的当前URI，$uri不包含主机名，如”/foo/bar.html</td>
          <td></td>
      </tr>
      <tr>
          <td><code>$document_uri</code></td>
          <td>与$uri相同</td>
          <td>/download/stat.php</td>
      </tr>
  </tbody>
</table>
<p>条件表达式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">正则表达式匹配：</span>
</span></span><span style="display:flex;"><span>    ~<span style="color:#e6db74">：与指定正则表达式模式匹配时返回“真”，判断匹配与否时区分字符大小写；</span>
</span></span><span style="display:flex;"><span>    ~<span style="color:#e6db74">*：与指定正则表达式模式匹配时返回“真”，判断匹配与否时不区分字符大小写；</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">!~：与指定正则表达式模式不匹配时返回“真”，判断匹配与否时区分字符大小写；</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">!~*：与指定正则表达式模式不匹配时返回“真”，判断匹配与否时不区分字符大小写；</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">文件及目录匹配判断：</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-f,</span> <span style="color:#e6db74">!-f：判断指定的路径是否为存在且为文件；</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-d,</span> <span style="color:#e6db74">!-d：判断指定的路径是否为存在且为目录；</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-e,</span> <span style="color:#e6db74">!-e：判断指定的路径是否存在，文件或目录均可；</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">-x,</span> <span style="color:#e6db74">!-x：判断指定路径的文件是否存在且可执行；</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 如果文件不存在则返回400  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(!-f</span> $request_filename<span style="color:#e6db74">)</span> {     
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">return</span> <span style="color:#ae81ff">400</span>;    
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果host是www.360buy.com，则301到www.jd.com中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(</span> $host <span style="color:#e6db74">!=</span> <span style="color:#e6db74">&#34;www.jd.com&#34;</span> <span style="color:#e6db74">)</span>{
</span></span><span style="display:flex;"><span> <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/(.*)</span>$ <span style="color:#e6db74">https://www.jd.com/</span>$1 <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果请求类型是POST则返回405，return不能返回301,302
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(</span>$request_method = <span style="color:#e6db74">POST)</span> { 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">return</span> <span style="color:#ae81ff">405</span>; 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果参数中有 a=1 则301到指定域名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(</span>$args ~ <span style="color:#e6db74">a=1)</span> {     
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^</span> <span style="color:#e6db74">http://example.com/</span> <span style="color:#e6db74">permanent</span>;   
</span></span><span style="display:flex;"><span>}   
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 文件名及参数重写
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#66d9ef">location</span> = <span style="color:#e6db74">/index.html</span> {       
</span></span><span style="display:flex;"><span> <span style="color:#f92672">set</span> $name <span style="color:#e6db74">test</span>;    <span style="color:#75715e"># 修改默认值为         
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#f92672">if($args</span> ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">name=(\w+?)(&amp;|</span>$<span style="color:#e6db74">))</span> {      
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">set</span> $name $1;     <span style="color:#75715e"># 如果参数中有 name=xx 则使用该值 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> }
</span></span><span style="display:flex;"><span> <span style="color:#75715e">#permanent 301重定向     
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^</span> <span style="color:#e6db74">/</span>$name.html <span style="color:#e6db74">permanent</span>;      
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># 禁止指定IP访问
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$remote_addr = 192.168.1.253<span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">return</span> <span style="color:#ae81ff">403</span>;
</span></span><span style="display:flex;"><span>    }       
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果请求的文件不存在，则反向代理到localhost 。这里的break也是停止继续rewrite 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">(!-f</span> $request_filename<span style="color:#e6db74">)</span>{        
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">break</span>;      
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1</span>;     
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">&#34;andriod&#34;)</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://lb1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">&#34;iphome&#34;)</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://lb2</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">&#34;qihoobot|Baiduspider|Googlebot|Googlebot-Mobile|Googlebot-Image|Mediapartners-Google|Adsbot-Google|Feedfetcher-Google|Yahoo!</span> <span style="color:#e6db74">Slurp|Yahoo!</span> <span style="color:#e6db74">Slurp</span> <span style="color:#e6db74">China|YoudaoBot|Sosospider|Sogou</span> <span style="color:#e6db74">spider|Sogou</span> <span style="color:#e6db74">web</span> <span style="color:#e6db74">spider|MSNBot|ia_archiver|Tomato</span> <span style="color:#e6db74">Bot&#34;)</span> 
</span></span><span style="display:flex;"><span>   { 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">return</span> <span style="color:#ae81ff">403</span>; 
</span></span><span style="display:flex;"><span>   } 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">在location中使用if语句可以实现条件判断，其通常有一个return语句，且一般与有着last或break标记的rewrite规则一同使用。但其也可以按需要使用在多种场景下，需要注意的是，不当的使用可能会导致不可预料的后果。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$request_method == <span style="color:#e6db74">“PUT”)</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://upload.magedu.com:8080</span>;
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$request_uri ~ <span style="color:#e6db74">&#34;\.(jpg|gif|jpeg|png)$&#34;)</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://imageservers</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">agent</span> <span style="color:#e6db74">参数</span>    <span style="color:#e6db74">根基客户端设备不同选择主机</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">_______________________________________________________</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">upstream</span> <span style="color:#e6db74">LB1</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 10.0.0.2:<span style="color:#ae81ff">81</span> <span style="color:#e6db74">weight=10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 10.0.0.3:<span style="color:#ae81ff">82</span> <span style="color:#e6db74">weight=6</span> <span style="color:#e6db74">down</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 10.0.0.1:<span style="color:#ae81ff">83</span> <span style="color:#e6db74">weight=5</span> <span style="color:#e6db74">backup</span> <span style="color:#e6db74">max_fails=2</span> <span style="color:#e6db74">fail_timeout=20s</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ip_hash</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">upstream</span> <span style="color:#e6db74">LB2</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 10.0.0.2:<span style="color:#ae81ff">84</span> <span style="color:#e6db74">weight=10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 10.0.0.3:<span style="color:#ae81ff">85</span> <span style="color:#e6db74">weight=6</span> <span style="color:#e6db74">down</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 10.0.0.1:<span style="color:#ae81ff">86</span> <span style="color:#e6db74">weight=5</span> <span style="color:#e6db74">backup</span> <span style="color:#e6db74">max_fails=2</span> <span style="color:#e6db74">fail_timeout=20s</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ip_hash</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">blog.etiantian.org</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">&#34;andriod&#34;)</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://lb1</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">&#34;iphone&#34;)</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://lb2</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://lb1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">proxy_set_header</span>  <span style="color:#e6db74">X-Real-IP</span> $remote_addr; <span style="color:#f92672">后端服务器接收到真实的客户IP</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">proxy_set_header</span>  <span style="color:#e6db74">X-Forwarded-For</span> $remote_addr; <span style="color:#f92672">后端服务器接收到真实的客户IP</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">proxy_set_header</span>  <span style="color:#e6db74">Host</span> $host;   <span style="color:#f92672">按照负载均衡的server_name</span> <span style="color:#e6db74">名称查找后端的基于域名的虚拟主机</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>
</span></span></code></pre></div>
</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c8a277e554b08c5c1a52fa904ed67ca0">ansible</h1>
	
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-21" class="text-body-secondary">Wednesday, May 21, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-73cbbd40bbb62c473e2785f489790835">Quitstart</h1>
	<div class="lead">quitstart|ansible</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-05-21" class="text-body-secondary">Wednesday, May 21, 2025</time>
        
	</div>
	<p><img src="https://rpic.origz.com/api.php?category=photography" alt=""></p>
<p><em>Ansible 是一个 IT 自动化工具,每年大约发布三到四次新的 Ansible 主要版本。</em></p>
<p>文档使用版本2.9</p>
<h3 id="概念">概念</h3>
<ul>
<li>控制节点： 安装了ansible 的主机，window主机不能作为控制节点</li>
<li>被管理节点：受控制节点管理的主机</li>
<li>inventory :  被管理节点的主机清单</li>
<li>模块：ansible 调用的python包</li>
<li>tasks: 要ansible执行的任务</li>
<li>playbook: 通过编排后的task集合，可以完成复杂任务</li>
</ul>
<h3 id="工作原理">工作原理</h3>
<ul>
<li>选择被管理节点</li>
<li>通过ssh连接到节点</li>
<li>将一个或多个模块复制到被管理节点执行</li>
</ul>
<h3 id="快速开始">快速开始</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install ansible-2.9.27-1.el7.noarch
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2.9 开始支持补全功能</span>
</span></span><span style="display:flex;"><span>yum install epel-release
</span></span><span style="display:flex;"><span>yum install python-argcomplete
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m ping
</span></span></code></pre></div><p>主配置文件: <code>/etc/ansible/ansible.cfg</code></p>
<p>定义资产配置清单: <code>/etc/ansible/hosts</code></p>

  
  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>资产配置清单</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="ini格式" aria-controls="tabs-00-01" aria-selected="true">
        ini格式
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="yaml格式" aria-controls="tabs-00-02" aria-selected="false">
        yaml格式
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75715e"># /etc/ansible/hosts</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[master]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">10.4.7.9</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">10.4.7.1[0:1]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[node]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">node[1:15]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[all:vars]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ansible_ssh_user: root</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># /etc/ansible/hosts</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">all</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">master</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hosts</span>: <span style="color:#e6db74">&#34;10.4.7.9,10.4.7.1[0:1]&#34;</span>  <span style="color:#75715e"># 展开为 10.4.7.9, 10.4.7.10, 10.4.7.11</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">node</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hosts</span>: <span style="color:#e6db74">&#34;node[1:15]&#34;</span>              <span style="color:#75715e"># 展开为 node1, node2, ..., node15</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ansible_ssh_user</span>: <span style="color:#ae81ff">root            </span> <span style="color:#75715e"># 全局 SSH 用户设置为 root</span>
</span></span></code></pre></div>
    </div>
</div>

<p>查询配置清单中的主机</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible all --list-hosts
</span></span></code></pre></div><h3 id="模块">模块</h3>
<h5 id="ping--模块">ping  模块</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible all -m ping
</span></span></code></pre></div><h5 id="debug">debug</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible 127.0.0.1 -m debug -a <span style="color:#e6db74">&#34;msg=hello world&#34;</span>
</span></span></code></pre></div><h5 id="hostname">hostname</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 修改主机名</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m hostname -a <span style="color:#e6db74">&#34;name=ansible-master&#34;</span>
</span></span></code></pre></div><h5 id="fetch">fetch</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ansible-doc -s fetch 从远端拉取文件</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m fetch -a <span style="color:#e6db74">&#34;src=/etc/hosts dest=/tmp&#34;</span>
</span></span></code></pre></div><h5 id="file">file</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ansible-doc -s file  创建/删除 文件/目录/软连接</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m file -a <span style="color:#e6db74">&#34;path=/tmp/a.log state=touch&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m file -a <span style="color:#e6db74">&#34;path=/tmp/a.log state=absent&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m file -a <span style="color:#e6db74">&#34;path=/tmp/a/b state=directory recurse=yes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m file -a <span style="color:#e6db74">&#34;path=/tmp/a state=absent&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m file -a <span style="color:#e6db74">&#34;path=/tmp/a state=link src=/etc/hosts&#34;</span>
</span></span></code></pre></div><h5 id="blockinfile">blockinfile</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ansible-doc -s blockinfile  按照标记添加/删除文件内容</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 插入内容</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m blockinfile -a <span style="color:#e6db74">&#34;path=/tmp/a marker=#{mark}20220318 block=&#39;101.43.43.9  test.com&#39;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除标记位置内容</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m blockinfile -a <span style="color:#e6db74">&#34;path=/tmp/a marker=#{mark}20220318 state=absent&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在开头插入 BOF（begin of file）</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m blockinfile -a <span style="color:#e6db74">&#34;path=/tmp/a marker=#{mark}20220318 block=&#39;10.43.43.9 test.com&#39; insertbefore=BOF&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在结尾插入 EOF (end of file)</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m blockinfile -a <span style="color:#e6db74">&#34;path=/tmp/a marker=#{mark}20220318 block=&#39;10.43.43.9 test.com&#39; insertbefore=EOF&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在insertafter=&#39;^127.0.0.1&#39; 之后插入</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m blockinfile -a <span style="color:#e6db74">&#34;path=/tmp/a marker=#{mark}20220318 block=&#39;10.43.43.9 test.com&#39; insertafter=&#39;^127.0.0.1&#39;&#34;</span>
</span></span></code></pre></div><h5 id="lineinfile">lineinfile</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># sed -i &#39;s/^10/#############/g&#39; /tmp/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># backrefs=yes 支持正则分组引用 ，当正则不匹配时不执行动作</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m lineinfile -a <span style="color:#e6db74">&#34;path=/tmp/a regexp=&#39;^10&#39; line=&#39;#############&#39; backrefs=yes&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># sed -i &#39;s/^#(.*)/\1g&#39; /tmp/a</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m lineinfile -a <span style="color:#e6db74">&#34;path=/tmp/a regexp=&#39;^#(.*)&#39; line=&#39;\1&#39; backrefs=yes
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># sed - &#39;/#############/d&#39; /tmp/a</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m lineinfile -a <span style="color:#e6db74">&#34;path=/tmp/a line=&#39;#############&#39; state=absent&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># sed - &#39;/^.*20220318$/d&#39; /tmp/a</span>
</span></span><span style="display:flex;"><span>ansibel 127.0.0.1 -m lineinfile -a <span style="color:#e6db74">&#34;path=/tmp/a regexp=&#39;^.*20220318</span>$<span style="color:#e6db74">&#39; state=absent&#34;</span>
</span></span></code></pre></div><h5 id="find">find</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ansible-doc -s find</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m find -a <span style="color:#e6db74">&#34;paths=&#39;/root&#39; patterns=&#39;zookeeper.out&#39; recurse=yes&#34;</span>
</span></span></code></pre></div><h5 id="replace">replace</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># sed -i &#39;s/^[a-Z]/##/g&#39; /tmp/a</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m replace -a <span style="color:#e6db74">&#34;path=/tmp/a regexp=&#39;^[a-Z]&#39; replace=&#39;##&#39;&#34;</span>
</span></span></code></pre></div><h5 id="command">command</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible 127.0.0.1 -m  command -a <span style="color:#e6db74">&#34;chdir=&#39;/&#39; ls -a&#34;</span>
</span></span></code></pre></div><h5 id="shell">shell</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 支持管道，command 不支持</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m  shell -a <span style="color:#e6db74">&#34;chdir=&#39;/&#39; ls -a|wc&#34;</span>
</span></span></code></pre></div><p><strong>script</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># /tmp/1.sh 在运维主机</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m  script -a <span style="color:#e6db74">&#34;chdir=&#39;/&#39; /tmp/1.sh&#34;</span>
</span></span></code></pre></div><h5 id="cron">cron</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 添加定时任务</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># */5 * * * * usr/sbin/ntpdate ntpdate ntp.aliyun.com &gt;/dev/null 2&gt;&amp;1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m cron -a <span style="color:#e6db74">&#34;minute=*/5 hour=* name=&#39;ntp date&#39; job=&#39;/usr/sbin/ntpdate ntpdate ntp.aliyun.com &gt;/dev/null 2&gt;&amp;1&#39;&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 启用注释的定时任务</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m cron -a <span style="color:#e6db74">&#34;disabled=false name=&#39;ntp date&#39; job=&#39;/usr/sbin/ntpdate ntpdate ntp.aliyun.com &gt;/dev/null 2&gt;&amp;1&#39;&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 删除定时任务</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m cron -a <span style="color:#e6db74">&#34;state=absent name=&#39;ntp date&#39; backup=yes&#34;</span>
</span></span></code></pre></div><h5 id="yum">yum</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 安装</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m yum -a <span style="color:#e6db74">&#34;name=rsync,vim,lrzsz state=present&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 卸载</span>
</span></span><span style="display:flex;"><span>ansible 127.0.0.1 -m yum -a <span style="color:#e6db74">&#34;name=rsync,vim,lrzsz state=absent&#34;</span>
</span></span></code></pre></div><h5 id="systemd">systemd</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible all -m systemd -a <span style="color:#e6db74">&#34;name=network state=restarted enabled=yes&#34;</span>
</span></span></code></pre></div><h5 id="group">group</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># groupadd mysql</span>
</span></span><span style="display:flex;"><span>ansible all -m group -a <span style="color:#e6db74">&#34;name=mysql state=present&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># groupadd mysql</span>
</span></span><span style="display:flex;"><span>ansible all -m group -a <span style="color:#e6db74">&#34;name=db state=present&#34;</span>
</span></span></code></pre></div><h5 id="user">user</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># useradd -g mysql -G root,db  -M -s /bin/nologin mysql</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible all -m user -a <span style="color:#e6db74">&#34;name=mysql group=mysql groups=db,root create_home=no shell=/bin/nologin state=present&#34;</span>
</span></span></code></pre></div><h5 id="template">template</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">template:	# 与copy类似，支持变量解析</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">src</span>: <span style="color:#ae81ff">/tmp/nginx.conf.j2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/tmp/nginx.conf</span>
</span></span></code></pre></div><h3 id="剧本playbook">剧本playbook</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 检查语法</span>
</span></span><span style="display:flex;"><span>ansible-playbook --syntax-check /etc/ansible/play.yml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># dry-run</span>
</span></span><span style="display:flex;"><span>ansible-playbook --check /etc/ansible/play.yml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 执行剧本</span>
</span></span><span style="display:flex;"><span>ansible-playbook /etc/ansible/play.yml
</span></span><span style="display:flex;"><span>ansible-playbook /etc/ansible/play.yml --list-hosts
</span></span><span style="display:flex;"><span>ansible-playbook /etc/ansible/play.yml --list-tasks
</span></span><span style="display:flex;"><span>ansible-playbook /etc/ansible/play.yml --limit 10.4.7.21
</span></span></code></pre></div><h5 id="基本语法tasks">基本语法tasks</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># /etc/ansible/play.yml</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ping host</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ping</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>: 
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">10.4.7.11</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">10.4.7.12</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fetch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fetch</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">src</span>: <span style="color:#ae81ff">/etc/services</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/tmp</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">copy file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">copy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">src</span>: <span style="color:#ae81ff">/etc/services</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/tmp</span>
</span></span></code></pre></div><h5 id="基本语法handlers">基本语法handlers</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 通过notify 调用handlers</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">touch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">notify</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">wirte file</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">handlers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">wirte file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">blockinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">block</span>: <span style="color:#e6db74">&#39;this is first line&#39;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">remove file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span></code></pre></div><h5 id="基本语法meta">基本语法meta</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">touch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">notify</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">wirte file</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># python 按顺序执行，如果添加了meta: flush_handlers 对应的task完成后会直接触发handlers</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">meta</span>: <span style="color:#ae81ff">flush_handlers</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ping</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ping</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">handlers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">wirte file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">blockinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">block</span>: <span style="color:#e6db74">&#39;this is first line&#39;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">remove file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span></code></pre></div><h5 id="基本语法listen">基本语法listen</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">touch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">notify</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">group1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">handlers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">wirte file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span>: <span style="color:#ae81ff">group1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">blockinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">block</span>: <span style="color:#e6db74">&#39;this is first line&#39;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">modify file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span>: <span style="color:#ae81ff">group1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lineinfile</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">regexp</span>: <span style="color:#e6db74">&#39;(.*)first(.*)&#39;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">line</span>: <span style="color:#ae81ff">\1\2</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">backrefs</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><h5 id="基本语法tags">基本语法tags</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">touch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">notify</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">group1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ping</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ping</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tags</span>: <span style="color:#ae81ff">tag_ping</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">handlers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">wirte file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span>: <span style="color:#ae81ff">group1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">blockinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">block</span>: <span style="color:#e6db74">&#39;this is first line&#39;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">modify file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span>: <span style="color:#ae81ff">group1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lineinfile</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/file.prom</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">regexp</span>: <span style="color:#e6db74">&#39;(.*)first(.*)&#39;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">line</span>: <span style="color:#ae81ff">\1\2</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">backrefs</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查看有哪些tag</span>
</span></span><span style="display:flex;"><span>ansible-playbook --list-tags /etc/ansible/play.yml
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> ansible-playbook --tags<span style="color:#f92672">=</span>tag_ping /etc/ansible/play.yml
</span></span><span style="display:flex;"><span>ansible-playbook --skip-tags<span style="color:#f92672">=</span>tag_ping /etc/ansible/play.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有任务都不会被执行</span>
</span></span><span style="display:flex;"><span>ansible-playbook --skip-tags all /etc/ansible/play.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>ansible-playbook --tags tagged /etc/ansible/play.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>ansible-playbook --tags untagged /etc/ansible/play.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># always 默认执行，除非明确指定--skip-tags</span>
</span></span><span style="display:flex;"><span>ansible-playbook --skip-tags always /etc/ansible/play.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># never 在不明确指定的情况下默认不执行</span>
</span></span><span style="display:flex;"><span>ansible-playbook --tags never /etc/ansible/play.yml
</span></span></code></pre></div><h5 id="循环"><strong>循环</strong></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ item }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">with_items</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">first line</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">second line</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 带索引的列表</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{item.1}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">with_indexed_items</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">first line</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">second line</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># range(1,10,3)</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ item }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">with_sequence</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">start=1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">end=10</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">stride=3</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ item.name }}{{ item.age }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">with_items</span>:
</span></span><span style="display:flex;"><span>    - {<span style="color:#f92672">name: wangendao,age</span>: <span style="color:#ae81ff">31</span>}
</span></span><span style="display:flex;"><span>    - {<span style="color:#f92672">name: zhangsan,age</span>: <span style="color:#ae81ff">18</span>}
</span></span></code></pre></div><h5 id="判断"><strong>判断</strong></h5>
<ul>
<li><strong>when</strong></li>
</ul>
<pre tabindex="0"><code class="language-jinja2" data-lang="jinja2">- hosts:
  - all
  tasks:
  - debug:
    msg: &#34;{{ansible_hostname}}&#34;
    when:
    # 可以使系统变量或自定义变量
      ansible_hostname == &#34;hdss7-200&#34;
</code></pre><h5 id="变量">变量</h5>
<p><strong>一、系统变量：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># cpu  核心数</span>
</span></span><span style="display:flex;"><span>ansible_processor_vcpus
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 主机名</span>
</span></span><span style="display:flex;"><span>ansible_hostname
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ip</span>
</span></span><span style="display:flex;"><span>ansible_host
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 内存</span>
</span></span><span style="display:flex;"><span>ansible_memtotal_mb
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ansible的版本信息</span>
</span></span><span style="display:flex;"><span>ansible_version
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ansible-play 1.yml --list-host</span>
</span></span><span style="display:flex;"><span>play_hosts
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>groups
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 系统发行版</span>
</span></span><span style="display:flex;"><span>ansible_distribution
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 系统版本号</span>
</span></span><span style="display:flex;"><span>ansible_distribution_major_version 
</span></span></code></pre></div><p>二、用户自定义变量</p>
<p>在资产清单中定义</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># /etc/ansible/hosts</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">all</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">10.4.7.11</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">wangendao</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">10.4.7.12</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">10.4.7.200</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ansible_ssh_user</span>: <span style="color:#ae81ff">root </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ansible_ssh_pass</span>: <span style="color:#ae81ff">123</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">k8s_node</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">10.4.7.21</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">10.4.7.22</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ansible_ssh_user</span>: <span style="color:#ae81ff">root </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ansible_ssh_pass</span>: <span style="color:#ae81ff">123</span>
</span></span></code></pre></div><ul>
<li>
<p>主机变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[atlanta]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host1 http_port</span><span style="color:#f92672">=</span><span style="color:#e6db74">80 maxRequestsPerChild=808</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host2 http_port</span><span style="color:#f92672">=</span><span style="color:#e6db74">303 maxRequestsPerChild=909</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">all</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">atlanta</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">host1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">http_port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">maxRequestsPerChild</span>: <span style="color:#ae81ff">808</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">host2</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">http_port</span>: <span style="color:#ae81ff">303</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">maxRequestsPerChild</span>: <span style="color:#ae81ff">909</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[targets]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指定连接方式</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">localhost              ansible_connection</span><span style="color:#f92672">=</span><span style="color:#e6db74">local</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">other1.example.com     ansible_connection</span><span style="color:#f92672">=</span><span style="color:#e6db74">ssh        ansible_user=myuser</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">other2.example.com     ansible_connection</span><span style="color:#f92672">=</span><span style="color:#e6db74">ssh        ansible_user=myotheruser</span>
</span></span></code></pre></div><p>此外还可以在<code>/etc/ansible/host_vars/主机名</code> 举例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /etc/ansible/host_vars/localhost &lt;&lt;EOF
</span></span><span style="display:flex;"><span>username<span style="color:#f92672">=</span>admin
</span></span><span style="display:flex;"><span>passwd<span style="color:#f92672">=</span><span style="color:#ae81ff">123</span>
</span></span></code></pre></div></li>
<li>
<p>组变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[atlanta]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[atlanta:vars]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ntp_server</span><span style="color:#f92672">=</span><span style="color:#e6db74">ntp.atlanta.example.com</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">proxy</span><span style="color:#f92672">=</span><span style="color:#e6db74">proxy.atlanta.example.com</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">all</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">atlanta</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host2</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ntp_server</span>: <span style="color:#ae81ff">ntp.atlanta.example.com</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy</span>: <span style="color:#ae81ff">proxy.atlanta.example.com</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[atlanta]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[raleigh]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[southeast:children]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">atlanta</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">raleigh</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[southeast:vars]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">some_server</span><span style="color:#f92672">=</span><span style="color:#e6db74">foo.southeast.example.com</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">halon_system_timeout</span><span style="color:#f92672">=</span><span style="color:#e6db74">30</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">self_destruct_countdown</span><span style="color:#f92672">=</span><span style="color:#e6db74">60</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">escape_pods</span><span style="color:#f92672">=</span><span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[usa:children]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">southeast</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">northeast</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">southwest</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">northwest</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">all</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">usa</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">southeast</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">atlanta</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">host1</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">host2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">raleigh</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">host2</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">host3</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">some_server</span>: <span style="color:#ae81ff">foo.southeast.example.com</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">halon_system_timeout</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">self_destruct_countdown</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">escape_pods</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">northeast</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">northwest</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">southwest</span>:
</span></span></code></pre></div><p>此外还可以在<code>/etc/ansible/group_vars/分组名称/...</code> 举例：</p>
<p>ini格式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">tee /etc/ansible/group_vars/db &lt;&lt;EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">username</span><span style="color:#f92672">=</span><span style="color:#e6db74">root</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">passwd</span><span style="color:#f92672">=</span><span style="color:#e6db74">123</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EOF</span>
</span></span></code></pre></div><p>yaml格式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">tee /etc/ansible/group_vars/db &lt;&lt;EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">username</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">passwd</span>: <span style="color:#ae81ff">123</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>指定别名</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">jumper ansible_port</span><span style="color:#f92672">=</span><span style="color:#e6db74">5555 ansible_host=192.0.2.50</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">all</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jumper</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ansible_port</span>: <span style="color:#ae81ff">5555</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ansible_host</span>: <span style="color:#ae81ff">192.0.2.50</span>
</span></span></code></pre></div></li>
</ul>
<p>playbook中定义</p>
<p>书写方式一：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">127.0.0.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">info</span>: {<span style="color:#f92672">&#39;name&#39;</span>: <span style="color:#ae81ff">wangendao,&#39;age&#39;:31}</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">filename</span>: <span style="color:#ae81ff">f1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/{{filename}}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">touch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tags</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;name: {{ info.name }} age: {{ info.age }}&#34;</span>
</span></span></code></pre></div><p>书写方式二：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># vars.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">wangendao</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">age</span>: <span style="color:#ae81ff">31</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars_files</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">vars.yml</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ name }}{{age}}&#34;</span>
</span></span></code></pre></div><p>书写方式三：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 接收键盘输入</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">127.0.0.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars_prompt</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;name&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prompt</span>: <span style="color:#e6db74">&#34;please input your name: &#34;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># 显示输入的信息，默认隐藏</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">private</span>: <span style="color:#66d9ef">no</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;age&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prompt</span>: <span style="color:#e6db74">&#34;please input your age: &#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 显示输入的信息，默认隐藏</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">private</span>: <span style="color:#66d9ef">no</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ name }} {{ age }}&#34;</span>
</span></span></code></pre></div><p>书写方式四：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">127.0.0.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ name }}&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-e ,--extra-vars
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible-playbook  /etc/ansible/play_vars.yml  --extra-vars <span style="color:#e6db74">&#34;name=wangendao&#34;</span>
</span></span><span style="display:flex;"><span>ansible-playbook  /etc/ansible/play_vars.yml  -e <span style="color:#e6db74">&#34;name=wangendao&#34;</span>
</span></span></code></pre></div><p><strong>变量注册</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">127.0.0.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">info</span>: {<span style="color:#f92672">&#39;name&#39;</span>: <span style="color:#ae81ff">wangendao,&#39;age&#39;:31}</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">filename</span>: <span style="color:#ae81ff">f1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/{{filename}}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">touch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 把 touch file 的执行结果保存到变量AAA 中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">register</span>: <span style="color:#ae81ff">AAAA</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tags</span>: <span style="color:#ae81ff">touch file</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;name: {{ info.name }} age: {{ info.age }} {{ AAAA }}&#34;</span>
</span></span></code></pre></div><h3 id="roles">roles</h3>
<p>下载roles的方法</p>
<ol>
<li>
<p>ansible-galaxy install</p>
<ul>
<li>roles</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>roles
</span></span><span style="display:flex;"><span>  |- nginx
</span></span><span style="display:flex;"><span>	|- tasks
</span></span><span style="display:flex;"><span>		|- 定义任务列表
</span></span><span style="display:flex;"><span>    |- handler
</span></span><span style="display:flex;"><span>    	|- main.yml	定义handlers
</span></span><span style="display:flex;"><span>    |- vars
</span></span><span style="display:flex;"><span>    	|- main.yml	定义变量
</span></span><span style="display:flex;"><span>    |- templates
</span></span><span style="display:flex;"><span>    |- files
</span></span><span style="display:flex;"><span>    |- meta
</span></span><span style="display:flex;"><span>    	|- main.yml 作者、版本信息
</span></span><span style="display:flex;"><span>    |- defaults
</span></span><span style="display:flex;"><span>    	|- main.yml 定义变量的初始值
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 在/tmp 下创建一个标准的roles目录结构</span>
</span></span><span style="display:flex;"><span>ansible-galaxy init /tmp/nginx
</span></span></code></pre></div><p>从互联网 现在roles</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查找仓库中的role</span>
</span></span><span style="display:flex;"><span>ansible-galaxy search <span style="color:#e6db74">&#34;k8s&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看仓库中role信息</span>
</span></span><span style="display:flex;"><span>ansible-galaxy info 24_komal.ec2_k8s_master
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 下载到/tmp/roles下</span>
</span></span><span style="display:flex;"><span>ansible-galaxy install 24_komal.ec2_k8s_master -p /tmp/roles
</span></span></code></pre></div></li>
<li>
<p>通过requirements.yml 文件下载</p>
<p>requiremets.yml的格式如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 从galaxy 官网下载http://galaxy.ansible.com/</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">src</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从git下载</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">src</span>: <span style="color:#ae81ff">http://github.com/xxx/xxx.git</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scm</span>: <span style="color:#ae81ff">git</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">56200a54</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-acme</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 把roles 打包成tar.gz 上传到自检的http服务器后，要想从这个http服务器下载</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">src</span>: <span style="color:#ae81ff">http://127.0.0.1/my.tar.gz</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="二进制命令">二进制命令</h3>
<p><span id=command><strong>二进制命令</strong></span ></p>
<table>
  <thead>
      <tr>
          <th>名称</th>
          <th>功能</th>
          <th>举例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>ansible</td>
          <td>用于临时执行命令</td>
          <td><code>ansible all -m ping</code></td>
      </tr>
      <tr>
          <td>ansible-console</td>
          <td>交互式命令</td>
          <td></td>
      </tr>
      <tr>
          <td>ansible-vault</td>
          <td>由于文件加密和解密</td>
          <td></td>
      </tr>
      <tr>
          <td>ansible-galaxy</td>
          <td>用于和roles仓库交互</td>
          <td><code>ansible-galaxy  init</code></td>
      </tr>
      <tr>
          <td>ansible-playbook</td>
          <td>用于运行playbook</td>
          <td></td>
      </tr>
      <tr>
          <td>ansible-doc</td>
          <td>查询帮助</td>
          <td><code>ansible-doc -l</code><br/>ansible-doc -s ping</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 加密 yml</span>
</span></span><span style="display:flex;"><span>bash-4.4# ansible-vault encrypt /etc/ansible/play1.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看加密的 yml</span>
</span></span><span style="display:flex;"><span>bash-4.4# ansible-vault view /etc/ansible/play1.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 编辑加密的 yml</span>
</span></span><span style="display:flex;"><span>bash-4.4# ansible-vault edit /etc/ansible/play1.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改加密的密码</span>
</span></span><span style="display:flex;"><span>bash-4.4# ansible-vault rekey /etc/ansible/play1.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解密 yml</span>
</span></span><span style="display:flex;"><span>bash-4.4# ansible-vault decrypt /etc/ansible/play1.yml
</span></span></code></pre></div><h3 id="参考">参考</h3>
<p><a href="https://docs.ansible.com/ansible/latest/index.html" target="_blank"><em>官方文档</em></a></p>
<p><a href="http://www.ansible.com.cn/" target="_blank">Ansible中文权威指南- 国内最专业的Ansible中文官方学习手册</a></p>
<p><a href="https://galaxy.ansible.com/nn708/openwrt" target="_blank">Ansible Galaxy</a></p>
<p><a href="https://www.cnblogs.com/michael-xiang/p/10462749.html" target="_blank">https://www.cnblogs.com/michael-xiang/p/10462749.html</a>)</p>
<p><a href="http://docs.jinkan.org/docs/jinja2/" target="_blank">欢迎来到 Jinja2 — Jinja2 2.7 documentation (jinkan.org)</a></p>
<p>[yaml官网](</p>

</div>





    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-00c869c8082cb1d3aca423fe64068b59">7.2 - </h1>
    
	<!-- 添加状态显示区域 -->
<div id="status" style="padding: 10px; text-align: center; font-weight: bold;"></div>
<img id="video" style="max-width: 100%; margin: 0 auto; display: block;" />

<script>
const statusElement = document.getElementById('status');
const audioContext = new (window.AudioContext || window.webkitAudioContext)(); // 新增：音频上下文
let ws;
let reconnectTimeout;
const RECONNECT_DELAY = 5000; // 5秒重连间隔

function updateStatus(text, color) {
    statusElement.textContent = text;
    statusElement.style.backgroundColor = color;
}

function connectWebSocket() {
    // 清除之前的重连计时器（避免重复连接）
    clearTimeout(reconnectTimeout);
    
    ws = new WebSocket('ws://100.64.0.3:9000/ws');
    ws.binaryType = 'arraybuffer';

    // 连接建立时
    ws.onopen = () => {
        updateStatus('已连接到视频流', '#dff0d8'); // 绿色背景
    };

    // 接收视频帧时
    ws.onmessage = (event) => {
        const data = new Uint8Array(event.data);
        const type = data[0];
        const payload = data.slice(1);

        if (type === 0) { // 视频处理保持不变
            const img = document.getElementById('video');
            if (img.src) URL.revokeObjectURL(img.src);
            const blob = new Blob([payload], { type: 'image/jpeg' });
            img.src = URL.createObjectURL(blob);
        } else if (type === 1) { // 音频处理修改为手动创建AudioBuffer
            // 将Uint8Array转换为Int16Array（匹配后端paInt16格式）
            const pcmData = new Int16Array(payload.buffer);
            
            // 创建AudioBuffer（参数需与后端采样率/通道数一致）
            const audioBuffer = audioContext.createBuffer(
                1,                 // 单声道（与后端channels=1一致）
                pcmData.length,    // 数据长度
                44100              // 采样率44.1kHz（与后端rate=44100一致）
            );
            
            // 将PCM数据复制到AudioBuffer通道
            audioBuffer.copyToChannel(pcmData, 0);
            
            // 播放音频
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start(0);
        }
    };

    // 连接错误时
    ws.onerror = (error) => {
        updateStatus('连接错误，正在尝试重连...', '#f2dede'); // 红色背景
        ws.close();
        reconnectTimeout = setTimeout(connectWebSocket, RECONNECT_DELAY);
    };

    // 连接关闭时（正常或异常）
    ws.onclose = (event) => {
        if (!event.wasClean) { // 非正常关闭时触发重连
            updateStatus('连接断开，正在尝试重连...', '#fcf8e3'); // 黄色背景
            reconnectTimeout = setTimeout(connectWebSocket, RECONNECT_DELAY);
        }
    };
}

// 初始连接
updateStatus('正在连接视频流...', '#d9edf7'); // 蓝色背景
connectWebSocket();
</script>

</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="联系我" aria-label="联系我">
    <a target="_blank" rel="noopener" href="/about/#%e8%81%94%e7%b3%bb%e6%96%b9%e5%bc%8f" aria-label="联系我">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="微信" aria-label="微信">
    <a target="_blank" rel="noopener" href="/about/#%e8%81%94%e7%b3%bb%e6%96%b9%e5%bc%8f" aria-label="微信">
      <i class="fa-brands fa-weixin"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">零露云©2025版权所有</span>
      </div>
    </div>
  </div>
</footer>

    </div>
    
  <script type="module" async>
  import mermaid from "https:\/\/cdn.jsdelivr.net\/npm\/mermaid@10.9.0\/dist\/mermaid.esm.min.mjs";

  (function ($) {
    if ($('.mermaid').length == 0) {
      mermaid.initialize({ startOnLoad: false });
      return;
    }

    var params = {"version":"10.9.0"};

    
    
    var norm = function (defaultConfig, params) {
      var result = {};
      for (const key in defaultConfig) {
        const keyLower = key.toLowerCase();
        if (defaultConfig.hasOwnProperty(key) && params.hasOwnProperty(keyLower)) {
          if (typeof defaultConfig[key] === "object") {
            result[key] = norm(defaultConfig[key], params[keyLower]);
          } else {
            result[key] = params[keyLower];
          }
        }
      }
      return result;
    };

    var settings = norm(mermaid.mermaidAPI.defaultConfig, params);
    settings.startOnLoad = true;
    if ($('html[data-bs-theme="dark"]').length) {
      settings.theme = 'dark';
    }
    mermaid.initialize(settings);

    
    const lightDarkModeThemeChangeHandler = function (mutationsList, observer) {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
          
          
          
          location.reload();
        }
      }
    };

    const observer = new MutationObserver(lightDarkModeThemeChangeHandler);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-bs-theme']
    });
    

  })(jQuery);
</script>
<script src="/js/main.min.bf0cab613e991fc11bc28a4a07b0aedef47c7c7c2595703ac3adf962fd6a8099.js" integrity="sha256-vwyrYT6ZH8EbwopKB7Cu3vR8fHwllXA6w635Yv1qgJk=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
