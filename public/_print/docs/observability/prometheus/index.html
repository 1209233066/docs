<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://zero-dew.netlify.app/docs/observability/prometheus/">
<link rel="alternate" type="application/rss&#43;xml" href="https://zero-dew.netlify.app/docs/observability/prometheus/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>prometheus | 零露云</title>
<meta name="description" content="Prometheus是Go语言开发的开源监控和警报框架，遵循Apache 2.0许可协议。它起源于SoundCloud，并在2016年成为云原生计算基金会（CNCF）继Kubernetes之后的第二个项目。Prometheus不仅提供监控功能，还是一个时序数据库。
本示例架构图
location /prom { proxy_pass http://127.0.0.1:9090; } location /alert { proxy_pass http://127.0.0.1:9093; } location /grafana { proxy_pass http://127.0.0.1:3000; } flowchart LRA(nginx)B(prometheus)C(alertmanager)D(grafana)z&gt;浏览器] --&gt; AA -..-&gt;|/prom| BA -..-&gt;|/alert| CA -..-&gt;|/grafana| Dstyle A fill:#f9f,stroke:#333,stroke-width:2pxstyle B fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5style C fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5style D fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5">
<meta property="og:url" content="https://zero-dew.netlify.app/docs/observability/prometheus/">
  <meta property="og:site_name" content="零露云">
  <meta property="og:title" content="prometheus">
  <meta property="og:description" content="Prometheus是Go语言开发的开源监控和警报框架，遵循Apache 2.0许可协议。它起源于SoundCloud，并在2016年成为云原生计算基金会（CNCF）继Kubernetes之后的第二个项目。Prometheus不仅提供监控功能，还是一个时序数据库。
本示例架构图
location /prom { proxy_pass http://127.0.0.1:9090; } location /alert { proxy_pass http://127.0.0.1:9093; } location /grafana { proxy_pass http://127.0.0.1:3000; } flowchart LRA(nginx)B(prometheus)C(alertmanager)D(grafana)z&gt;浏览器] --&gt; AA -..-&gt;|/prom| BA -..-&gt;|/alert| CA -..-&gt;|/grafana| Dstyle A fill:#f9f,stroke:#333,stroke-width:2pxstyle B fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5style C fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5style D fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="prometheus">
  <meta itemprop="description" content="Prometheus是Go语言开发的开源监控和警报框架，遵循Apache 2.0许可协议。它起源于SoundCloud，并在2016年成为云原生计算基金会（CNCF）继Kubernetes之后的第二个项目。Prometheus不仅提供监控功能，还是一个时序数据库。
本示例架构图
location /prom { proxy_pass http://127.0.0.1:9090; } location /alert { proxy_pass http://127.0.0.1:9093; } location /grafana { proxy_pass http://127.0.0.1:3000; } flowchart LRA(nginx)B(prometheus)C(alertmanager)D(grafana)z&gt;浏览器] --&gt; AA -..-&gt;|/prom| BA -..-&gt;|/alert| CA -..-&gt;|/grafana| Dstyle A fill:#f9f,stroke:#333,stroke-width:2pxstyle B fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5style C fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5style D fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5">
  <meta itemprop="datePublished" content="2025-05-12T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-05-12T00:00:00+00:00">
  <meta itemprop="wordCount" content="57">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="prometheus">
  <meta name="twitter:description" content="Prometheus是Go语言开发的开源监控和警报框架，遵循Apache 2.0许可协议。它起源于SoundCloud，并在2016年成为云原生计算基金会（CNCF）继Kubernetes之后的第二个项目。Prometheus不仅提供监控功能，还是一个时序数据库。
本示例架构图
location /prom { proxy_pass http://127.0.0.1:9090; } location /alert { proxy_pass http://127.0.0.1:9093; } location /grafana { proxy_pass http://127.0.0.1:3000; } flowchart LRA(nginx)B(prometheus)C(alertmanager)D(grafana)z&gt;浏览器] --&gt; AA -..-&gt;|/prom| BA -..-&gt;|/alert| CA -..-&gt;|/grafana| Dstyle A fill:#f9f,stroke:#333,stroke-width:2pxstyle B fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5style C fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5style D fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5">
<link rel="preload" href="/scss/main.min.18c08ee35308968138c55945e86231cae563e39470a6efcb36f516f6b21b6a02.css" as="style" integrity="sha256-GMCO41MIloE4xVlF6GIxyuVj45Rwpu/LNvUW9rIbagI=" crossorigin="anonymous">
<link href="/scss/main.min.18c08ee35308968138c55945e86231cae563e39470a6efcb36f516f6b21b6a02.css" rel="stylesheet" integrity="sha256-GMCO41MIloE4xVlF6GIxyuVj45Rwpu/LNvUW9rIbagI=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">零露云</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/about"><i class="fa-solid fa-house"></i><span>关于</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/docs"><i class="fa-solid fa-book"></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/blog"><i class="fa-solid fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/google/docsy/" target="_blank" rel="noopener"><i class='fa-brands fa-github'></i><span></span></a>
      </li>
      <li class="td-light-dark-menu nav-item dropdown">
        <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
  <symbol id="check2" viewBox="0 0 16 16">
    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
  </symbol>
  <symbol id="circle-half" viewBox="0 0 16 16">
    <path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/>
  </symbol>
  <symbol id="moon-stars-fill" viewBox="0 0 16 16">
    <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
    <path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/>
  </symbol>
  <symbol id="sun-fill" viewBox="0 0 16 16">
    <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
  </symbol>
</svg>

<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center"
        id="bd-theme"
        type="button"
        aria-expanded="false"
        data-bs-toggle="dropdown"
        data-bs-display="static"
        aria-label="Toggle theme (auto)">
  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg>
</button>
<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#sun-fill"></use></svg>
      Light
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"></use></svg>
      Dark
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
      <svg class="bi me-2 opacity-50"><use href="#circle-half"></use></svg>
      Auto
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
</ul>

      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.a779bd279239ad7d8c03caec2282ddc3.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="25"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/observability/prometheus/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">prometheus</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-863efec26236baab21735f111ba52bf3">install</a></li>


    
  
    
    
	
<li>2: <a href="#pg-cbf04b1f9c33b34119d6b5481bfb28c0">operator</a></li>


    
  
    
    
	
<li>3: <a href="#pg-8dd2a702f5ca9e0b663fa00c19f6ce84">config</a></li>


    
  
    
    
	
<li>4: <a href="#pg-05ff6cc9cc00a9f65de4bbb0f9434aeb">kubernetes_sd_configs</a></li>


    
  
    
    
	
<li>5: <a href="#pg-882797a566a6d870802dfa95b7787f8a">consul_sd_configs</a></li>


    
  
    
    
	
<li>6: <a href="#pg-be6a851a8907242be24193da43e763a0">PromeQL</a></li>


    
  
    
    
	
<li>7: <a href="#pg-f429588e5a52c95dd5bec002541ac0aa">夜莺·监控系统</a></li>


    
  
    
    
	
<li>8: <a href="#pg-fc27d5a38407c7add3b1bb091b945197">federation</a></li>


    
  
    
    
	
<li>9: <a href="#pg-c6ca951d0441de2c3fbff37db4cd100a">附录</a></li>


    
  
    
    
	
<li>10: <a href="#pg-d5033e8c9a46dd0403d5bde3fa28069c">exporter</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.1: <a href="#pg-624d0b59238886cb73ea365101d34bb0">node_exporter</a></li>


    
  
    
    
	
<li>10.2: <a href="#pg-d2d65a85ce96b5d2e1c53c6332d4b35d">blackbox</a></li>


    
  
    
    
	
<li>10.3: <a href="#pg-f2088b66d721f30cecd45b9172151883">jmx_exporter</a></li>


    
  
    
    
	
<li>10.4: <a href="#pg-5d8b8cd5776ff486cdacaf0443afe506">nginx-exporter</a></li>


    
  
    
    
	
<li>10.5: <a href="#pg-a91649f35c1611e400ba18dd4dfe3c9a">minio</a></li>


    
  
    
    
	
<li>10.6: <a href="#pg-ab1b654ca9a964046d54e4a76701e2bc">redis-exporter</a></li>


    
  
    
    
	
<li>10.7: <a href="#pg-31569474fbadc76b9e8fdcd9f370ea84">mysql-exporter</a></li>


    
  
    
    
	
<li>10.8: <a href="#pg-b668d0cb90e19dfdc045d5bb7bc1a106">mongo-exporter</a></li>


    
  
    
    
	
<li>10.9: <a href="#pg-12149c930cfe1dac8487f4da8d8be7d2">prometheus-sdk</a></li>


    
  

    </ul>
    
  
    
    
	
<li>11: <a href="#pg-b0b1ba15faa9a6ebeb9137c6c9e73f6a">alertmanager</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>11.1: <a href="#pg-cdd3077d065775a419d9597d5a6c38ba">部署alertmanager</a></li>


    
  
    
    
	
<li>11.2: <a href="#pg-24c9374cc0495f3c971a09cf688a7112">配置alertmanager</a></li>


    
  
    
    
	
<li>11.3: <a href="#pg-c5c6014e5263533687c85e13e12dcd41">amtool</a></li>


    
  
    
    
	

    <li><a href="#pg-1ecaff05acb725a9eaabec72c0c0fa35">告警收敛</a></li>



    
  

    </ul>
    
  
    
    
	
<li>12: <a href="#pg-3c434868253797ecc1f1e40600c22b80">monitor</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>12.1: <a href="#pg-8d14d03086c49edb38caab12c6d62a82">prometheus</a></li>


    
  
    
    
	
<li>12.2: <a href="#pg-5605bee91439f7db78272ae6244fd177">alertmanager</a></li>


    
  
    
    
	
<li>12.3: <a href="#pg-8fb98d401496b16c1a7d7ad67b7b3bb1">pushgateway</a></li>


    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-09903d68b7f1b7714677112922b831b4">victorametrics</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	
<li>13.1: <a href="#pg-8c8d43a049d000cfadffd58670f39f1e">victoriaMetrics</a></li>


    
  

    </ul>
    
  
    
    
	
<li>14: <a href="#pg-bfa75dc49b199dd86701654b7a8dd70f">kubernetes</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>14.1: <a href="#pg-25b4a44cfb54668617235e697b78af35">kube-apiserver</a></li>


    
  
    
    
	
<li>14.2: <a href="#pg-7bb3b9db4f2ef41eaaf1bbd09fa2e996">kube-controller</a></li>


    
  
    
    
	
<li>14.3: <a href="#pg-e3a8bfe7e2de471dc46cdfcd846b0686">kube-controller</a></li>


    
  
    
    
	
<li>14.4: <a href="#pg-b2a97e471d481fe1bb9c8b592ca62eab">kube-proxy</a></li>


    
  
    
    
	
<li>14.5: <a href="#pg-92571de61259ce57bcb0c1a9e852b932">kubelet</a></li>


    
  
    
    
	
<li>14.6: <a href="#pg-31806350774a7c031b15b5c616430c3e">etcd</a></li>


    
  
    
    
	
<li>14.7: <a href="#pg-5cb338fcb7d2487aba8e3851f63fe4e9">coredns</a></li>


    
  
    
    
	
<li>14.8: <a href="#pg-8e244531e3aa17ff54cd0173cf6f4016">cadvisor</a></li>


    
  
    
    
	
<li>14.9: <a href="#pg-0f8ec29a41b1721d7cd9fe76cf6dc070">kube-state-metrics</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      <p>Prometheus是Go语言开发的开源监控和警报框架，遵循Apache 2.0许可协议。它起源于SoundCloud，并在2016年成为云原生计算基金会（CNCF）继Kubernetes之后的第二个项目。Prometheus不仅提供监控功能，还是一个时序<a href="https://db-engines.com/en/ranking" target="_blank">数据库</a>。</p>
<p>本示例架构图</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/prom</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:9090</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/alert</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:9093</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/grafana</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:3000</span>;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><pre class="mermaid">flowchart LR
	A(nginx)
	B(prometheus)
	C(alertmanager)
	D(grafana)
	
	z&gt;浏览器] --&gt; A
	
	A -..-&gt;|/prom| B
	A -..-&gt;|/alert| C
	A -..-&gt;|/grafana| D
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style C fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5
    style D fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5</pre>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-863efec26236baab21735f111ba52bf3">1 - install</h1>
    <div class="lead">安装|prometheus</div>
	<p><img src="https://prometheus.io/assets/architecture.png" alt="架构图"></p>
<h3 id="二进制安装">二进制安装</h3>
<ol>
<li>
<p>添加用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>useradd prometheus --system -s /sbin/nologin
</span></span></code></pre></div></li>
<li>
<p>挂载磁盘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建一个名为data的thinpool</span>
</span></span><span style="display:flex;"><span>vgName<span style="color:#f92672">=</span>centos
</span></span><span style="display:flex;"><span>lvcreate -L 100G --thinpool data <span style="color:#e6db74">${</span>vgName<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建名为prometheus的lv</span>
</span></span><span style="display:flex;"><span>lvcreate -n prometheus --virtualsize 500G --thinpool data <span style="color:#e6db74">${</span>vgName<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 格式化</span>
</span></span><span style="display:flex;"><span>mkfs.ext4 /dev/<span style="color:#e6db74">${</span>vgName<span style="color:#e6db74">}</span>/prometheus
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建prometheus目录</span>
</span></span><span style="display:flex;"><span>mkdir /data/prometheus -p
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开机自启动挂载</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>blkid /dev/mapper/<span style="color:#e6db74">${</span>vgName<span style="color:#e6db74">}</span>-prometheus|awk <span style="color:#e6db74">&#39;{print $2}&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74"> /data/prometheus ext4 defaults,noatime,nodelalloc 0 0&#34;</span>  &gt;&gt;/etc/fstab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 挂载验证</span>
</span></span><span style="display:flex;"><span>mount -a
</span></span><span style="display:flex;"><span>df -hT /data/prometheus/
</span></span></code></pre></div></li>
<li>
<p><a href="https://prometheus.io/docs/introduction/release-cycle/" target="_blank">下载长期支持版</a></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Release</th>
          <th style="text-align: left">Date</th>
          <th style="text-align: left">End of support</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Prometheus 2.37</td>
          <td style="text-align: left">2022-07-14</td>
          <td style="text-align: left">2023-07-31</td>
      </tr>
      <tr>
          <td style="text-align: left">Prometheus 2.45</td>
          <td style="text-align: left">2023-06-23</td>
          <td style="text-align: left">2024-07-31</td>
      </tr>
      <tr>
          <td style="text-align: left">Prometheus 2.53</td>
          <td style="text-align: left">2024-06-16</td>
          <td style="text-align: left">2025-07-31</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>version<span style="color:#f92672">=</span>2.53.0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/prometheus/prometheus/releases/download/v<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>/prometheus-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.linux-amd64.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf prometheus-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.linux-amd64.tar.gz -C /data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /data/prometheus/<span style="color:#f92672">{</span>bin,conf,conf/rules,data,log<span style="color:#f92672">}</span> -p
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cp /data/prometheus-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.linux-amd64/prometheus /data/prometheus/bin/
</span></span><span style="display:flex;"><span>cp /data/prometheus-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.linux-amd64/promtool /data/prometheus/bin/
</span></span><span style="display:flex;"><span>cp /data/prometheus-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.linux-amd64/prometheus.yml /data/prometheus/conf
</span></span><span style="display:flex;"><span>cp -a /data/prometheus-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.linux-amd64/console* /data/prometheus/conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown -R prometheus:prometheus /data/prometheus*
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/data/prometheus
</span></span><span style="display:flex;"><span>├── bin
</span></span><span style="display:flex;"><span>│   ├── prometheus
</span></span><span style="display:flex;"><span>│   └── promtool
</span></span><span style="display:flex;"><span>├── conf
</span></span><span style="display:flex;"><span>│   └── prometheus.yml
</span></span><span style="display:flex;"><span>├── data
</span></span><span style="display:flex;"><span>└── log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span> directories, <span style="color:#ae81ff">3</span> files
</span></span></code></pre></div></li>
<li>
<p>通过systemd管理服务</p>
<blockquote>
<p><sub><code>--storage.tsdb.retention.time 替代了--storage.tsdb.retention</code></sub></p>
<p><sub>提供远程写入到prometheus的功能:<br>老版本<code> --enable-feature=remote-write-receiver</code><br>新版本 <code>--web.enable-remote-write-receiver</code></sub></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/prometheus.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=promethues service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStartPre=/data/prometheus/bin/promtool check config /data/prometheus/conf/prometheus.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/prometheus/bin/prometheus \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=0.0.0.0:9090 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config.file=/data/prometheus/conf/prometheus.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.read-timeout=5m \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.max-connections=10 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--storage.tsdb.retention.time=15d \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--storage.tsdb.retention.size=100GB \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--storage.tsdb.path=/data/prometheus/data \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--query.max-concurrency=20 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--query.timeout=2m \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.console.templates=/data/prometheus/conf/consoles \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.console.libraries=/data/prometheus/conf/console_libraries \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.enable-lifecycle \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.enable-admin-api \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.external-url=/prom
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/usr/bin/curl -s -X POST 127.0.0.1:9090/-/reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable prometheus --now  
</span></span><span style="display:flex;"><span>systemctl status prometheus
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cbf04b1f9c33b34119d6b5481bfb28c0">2 - operator</h1>
    <div class="lead">安装|prometheus</div>
	<h3 id="基于prometheus-operator">基于<a href="https://github.com/prometheus-operator/prometheus-operator" target="_blank">prometheus-operator</a></h3>
<p>版本矩阵</p>
<table>
  <thead>
      <tr>
          <th>kube-prometheus stack</th>
          <th>Kubernetes 1.21</th>
          <th>Kubernetes 1.22</th>
          <th>Kubernetes 1.23</th>
          <th>Kubernetes 1.24</th>
          <th>Kubernetes 1.25</th>
          <th>Kubernetes 1.26</th>
          <th>Kubernetes 1.27</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.9" target="_blank"><code>release-0.9</code></a></td>
          <td>✔</td>
          <td>✔</td>
          <td>✗</td>
          <td>✗</td>
          <td>✗</td>
          <td>x</td>
          <td>x</td>
      </tr>
      <tr>
          <td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.10" target="_blank"><code>release-0.10</code></a></td>
          <td>✗</td>
          <td>✔</td>
          <td>✔</td>
          <td>✗</td>
          <td>✗</td>
          <td>x</td>
          <td>x</td>
      </tr>
      <tr>
          <td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.11" target="_blank"><code>release-0.11</code></a></td>
          <td>✗</td>
          <td>✗</td>
          <td>✔</td>
          <td>✔</td>
          <td>✗</td>
          <td>x</td>
          <td>x</td>
      </tr>
      <tr>
          <td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.12" target="_blank"><code>release-0.12</code></a></td>
          <td>✗</td>
          <td>✗</td>
          <td>✗</td>
          <td>✔</td>
          <td>✔</td>
          <td>x</td>
          <td>x</td>
      </tr>
      <tr>
          <td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/main" target="_blank"><code>main</code></a></td>
          <td>✗</td>
          <td>✗</td>
          <td>✗</td>
          <td>✗</td>
          <td>x</td>
          <td>✔</td>
          <td>✔</td>
      </tr>
  </tbody>
</table>
<ol>
<li>
<p>下载安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/prometheus-operator/kube-prometheus.git
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd kube-prometheus/
</span></span><span style="display:flex;"><span>git checkout -b release-0.10
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Create the namespace and CRDs, and then wait for them to be availble before creating the remaining resources</span>
</span></span><span style="display:flex;"><span>kubectl create -f manifests/setup
</span></span></code></pre></div><p>创建monitoring 名称空间，并创建以下crd</p>
<ul>
<li>
<p>alertmanagerconfigs.monitoring.coreos.com</p>
</li>
<li>
<p>alertmanagers.monitoring.coreos.com</p>
</li>
<li>
<p>podmonitors.monitoring.coreos.com</p>
</li>
<li>
<p>probes.monitoring.coreos.com</p>
</li>
<li>
<p>prometheuses.monitoring.coreos.com</p>
</li>
<li>
<p>prometheusagents.monitoring.coreos.com</p>
</li>
<li>
<p>prometheusrules.monitoring.coreos.com</p>
</li>
<li>
<p>scrapeconfigs.monitoring.coreos.com</p>
</li>
<li>
<p>servicemonitors.monitoring.coreos.com</p>
</li>
<li>
<p>thanosrulers.monitoring.coreos.com</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Wait until the &#34;servicemonitors&#34; CRD is created. The message &#34;No resources found&#34; means success in this context.until kubectl get servicemonitors --all-namespaces ; do date; sleep 1; echo &#34;&#34;; done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl create -f manifests/
</span></span></code></pre></div></li>
<li>
<p>验证</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl --namespace monitoring port-forward svc/prometheus-k8s <span style="color:#ae81ff">9090</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl --namespace monitoring port-forward svc/alertmanager-main <span style="color:#ae81ff">9093</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl --namespace monitoring port-forward svc/grafana <span style="color:#ae81ff">3000</span>
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8dd2a702f5ca9e0b663fa00c19f6ce84">3 - config</h1>
    <div class="lead">promethes.yaml|prometheus</div>
	<p>配置文件全景图</p>
<pre class="mermaid">  graph LR
  A&gt;prometheus.yml] ==&gt; |全局配置|B(&lt;a href=#global&gt;global&lt;/a&gt;)
  A ==&gt; |对接alert|C(&lt;a href=&#39;#alterings&#39;&gt;alterings&lt;/a&gt;)
  A ==&gt; |评估/告警规则|D(&lt;a href=&#39;#rule_files&#39;&gt;rule_files&lt;/a&gt;)
  A ==&gt; |指标抓取|E(&lt;a href=&#39;#scrape_configs&#39;&gt;scrape_configs&lt;/a&gt;)
  A ==&gt; |外部存储|F(remote_write/remote_read)
  E -..-&gt; |静态配置|E1(&lt;a href=#static_configs&gt;static_configs&lt;/a&gt;)
  E -..-&gt; |文件自动发现|E2(&lt;a href=#file_sd_configs&gt;file_sd_configs&lt;/a&gt;)
  E -..-&gt; |consul自动发现|E3(&lt;a href=#consul_sd_configs&gt;consul_sd_configs&lt;/a&gt;)
  E -..-&gt; |kubernetes自动发现|E4(&lt;a href=&#39;#kubernetes_sd_configs&#39;&gt;kubernetes_sd_configs&lt;/a&gt;)
  E -..-&gt; |dns自动发现|E5(&lt;a href=&#39;#dns_sd_configs&#39;&gt;dns_sd_configs&lt;/a&gt;)
  E -..-&gt; |基于单个job重新打标,在指标采集之前完成|E6(&lt;a href=&#39;#relabel_configs&#39;&gt;relabel_configs&lt;/a&gt;)
  E -..-&gt; |基于单个metrics重新打标,在指标采集之后数据存储之前完成|E7(metric_relabel_configs)
  E -..-&gt; |发送给alertmanger时重新打标|E8(alert_relabel_configs)
  E -..-&gt; |远程写入样本时重新打标|E9(write_relabel_configs)</pre>
<h3 id="global"><span id='global'><strong>global</strong></span></h3>
<p><em>配置示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1m 抓取一次target</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 10s 抓取不到超时</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">20s</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1m 评估一次rules</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">evaluation_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 全局标签(在每一个时间序列上添加zoon=shanghai 的标签)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">center</span>: <span style="color:#e6db74">&#34;shanghai&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#e6db74">&#34;staging&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 记录promql 的查询记录</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">query_log_file</span>: <span style="color:#e6db74">&#34;/data/prometheus/log/promql&#34;</span>
</span></span></code></pre></div><h3 id="alterings"><span id='alterings'><strong>alterings</strong></span></h3>
<p><em>配置示例：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1m 抓取一次target</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 10s 抓取不到超时</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">20s</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1m 评估一次rules</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">evaluation_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 全局标签(在每一个时间序列上添加zoon=shanghai 的标签)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">center</span>: <span style="color:#e6db74">&#34;shanghai&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#e6db74">&#34;staging&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 记录promql 的查询记录</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">query_log_file</span>: <span style="color:#e6db74">&#34;/data/prometheus/log/promql&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">alerting</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">alertmanagers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path_prefix</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targets</span>: <span style="color:#75715e"># 通常情况 这三个节点是一个集群</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;alert1:9093&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;alert2:9093&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;alert3:9093&#39;</span>
</span></span></code></pre></div><h3 id="rule_"><span id='rule_files'><strong>rule_files</strong></span></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1m 抓取一次target</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 10s 抓取不到超时</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">20s</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1m 评估一次rules</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">evaluation_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 全局标签(在每一个时间序列上添加zoon=shanghai 的标签)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">center</span>: <span style="color:#e6db74">&#34;shanghai&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#e6db74">&#34;staging&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 记录promql 的查询记录</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">query_log_file</span>: <span style="color:#e6db74">&#34;/data/prometheus/log/promql&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">alerting</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">alertmanagers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path_prefix</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targets</span>: <span style="color:#75715e"># 通常情况 这三个节点是一个集群</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;alert1:9093&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;alert2:9093&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;alert3:9093&#39;</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span><span style="color:#f92672">rule_files</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在prometheus.yml主配置文件加载 record规则 和 alert规则</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 相对于主配置文件</span>
</span></span><span style="display:flex;"><span>- <span style="color:#e6db74">&#34;./rules/*.yaml&#34;</span>
</span></span></code></pre></div>

  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="记录规则" aria-controls="tabs-00-00" aria-selected="true">
        记录规则
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="告警规则" aria-controls="tabs-00-01" aria-selected="false">
        告警规则
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <p><em>语法</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">30s        </span> <span style="color:#75715e"># 规则评估周期, 省略时使用全局配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limit</span>: <span style="color:#ae81ff">0</span>            <span style="color:#75715e"># 对时间序列的限制，0表示不做限制</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">query_offset</span>: <span style="color:#ae81ff">0</span>       <span style="color:#75715e"># 评估时的时间偏移量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:             <span style="color:#75715e"># 添加或修改标签</span>
</span></span><span style="display:flex;"><span>      -  <span style="color:#f92672">&lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;labelvalue&gt; </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">record</span>: <span style="color:#ae81ff">code:prometheus_http_requests_total:sum</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">sum by (code) (prometheus_http_requests_total)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:             <span style="color:#75715e"># 添加或修改标签</span>
</span></span><span style="display:flex;"><span>        -  <span style="color:#f92672">&lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;labelvalue&gt; </span>
</span></span></code></pre></div><p><em>示例</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">#./rules/record.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">node_cpu</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 命名规范 https://prometheus.io/docs/practices/rules/#recording-rules</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">record: instance:node_cpu_seconds:avg_rate5m  # record</span>: <span style="color:#ae81ff">level:metric:operation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">avg by (job,instance,mode) (rate(node_cpu_seconds_total[5m]))</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">record</span>: <span style="color:#ae81ff">instance:node_cpu_seconds:avg_rate5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">avg by (job,instance,mode) (rate(node_cpu_seconds_total[5m]))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">metric_type</span>: <span style="color:#e6db74">&#34;aggration&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/data/prometheus/bin/promtool check rules  ./rules/record.yaml
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="alert alert-primary" role="alert">
<pre><code>语法：相比record 规则，labels 支持&lt;strong&gt;字符串模版&lt;/strong&gt;
</code></pre>
</div>
<p><em>语法</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">30s        </span> <span style="color:#75715e"># 规则评估周期, 省略时使用全局配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limit</span>: <span style="color:#ae81ff">0</span>            <span style="color:#75715e"># 对时间序列的限制，0表示不做限制</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">query_offset</span>: <span style="color:#ae81ff">0</span>       <span style="color:#75715e"># 评估时的时间偏移量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:             <span style="color:#75715e"># 添加或修改标签</span>
</span></span><span style="display:flex;"><span>      -  <span style="color:#f92672">&lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;labelvalue&gt; </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">nodeCpuHight</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">100</span> * <span style="color:#ae81ff">(1 - avg(rate(node_cpu_seconds_total{mode=&#34;idle&#34;}[5m])) by(instance)) &gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">for</span>: <span style="color:#ae81ff">2m          </span> <span style="color:#75715e"># 达到expr 条件并持续2m,则告警从pending 转为firing</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">0s  </span> <span style="color:#75715e"># 不满足expr 条件后，告警继续保持的时长</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:           <span style="color:#75715e"># 添加或修改标签</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">&lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;tmpl_string&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">&lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;tmpl_string&gt; </span>
</span></span></code></pre></div><p><em>示例</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">#./rules/alert.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">node_cpu</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">nodeCpuHigh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">100</span> * <span style="color:#ae81ff">(1 - avg(rate(node_cpu_seconds_total{mode=&#34;idle&#34;}[5m])) by(instance)) &gt;85</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m </span> <span style="color:#75715e"># for 参数可省略。Alerting rules without the for clause will become active on the first evaluation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">WARNING</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机【Instance {{ $labels.instance }}】cpu 使用率高&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: {{<span style="color:#ae81ff">$labels.instance}} of job {{ $labels.job }} cpu 使用率超过85%,当前值{{ $value |printf &#34;%.1f&#34;}}%</span>
</span></span></code></pre></div>
    </div>
</div>

<h3 id="scrape_configs"><span id='scrape_configs'>scrape_configs</span></h3>

  

  

  

  



<ul class="nav nav-tabs justify-content-end" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="<span id='static_configs'>**static_configs**</span>" aria-controls="tabs-01-00" aria-selected="true">
        <span id='static_configs'><strong>static_configs</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="<span id='file_sd_configs'>**file_sd_configs**</span>" aria-controls="tabs-01-01" aria-selected="false">
        <span id='file_sd_configs'><strong>file_sd_configs</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="<span id='consul_sd_configs'>**consul_sd_configs**</span>" aria-controls="tabs-01-02" aria-selected="false">
        <span id='consul_sd_configs'><strong>consul_sd_configs</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="<span id='kubernetes_sd_configs'>**kubernetes_sd_configs**</span>" aria-controls="tabs-01-03" aria-selected="false">
        <span id='kubernetes_sd_configs'><strong>kubernetes_sd_configs</strong></span>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <p><em>示例</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">prometheus</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">10s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">targets</span>: [<span style="color:#e6db74">&#39;localhost:8080&#39;</span>,<span style="color:#e6db74">&#39;localhost:8081&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">env</span>: <span style="color:#e6db74">&#39;production&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;node&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">localhost:9100</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 只收集指定的指标</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">collect[]</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">cpu</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">meminfo</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">diskstats</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">netdev</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">filefd</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">filesystem</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">xfs</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">systemd</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># curl -g -X GET http://127.0.0.1:9100/metrcs?collect[]=cpu</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <p><em>示例</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">prometheus</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">10s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">file_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">files</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">file/*.yml</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">refresh_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span><span style="color:#75715e">#cat file/file_sd.yaml </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#ae81ff">172.29.1.11</span>:<span style="color:#ae81ff">9090</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">prometheus</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">job</span>: <span style="color:#ae81ff">primetheus</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <p><em>示例</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;node&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">consul_sd_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">server</span>: <span style="color:#e6db74">&#34;47.113.100.31:8500&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;nodes&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">refresh_interval</span>: <span style="color:#ae81ff">2m</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <p><em>示例</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kube-apiserver</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://127.0.0.1:6443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.pem</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/cert.pem</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/cert.key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">role</span>: <span style="color:#ae81ff">endpoints  </span> <span style="color:#75715e"># 如果prometheus部署在集群中，则使用endpoints,如果部署在集群外，则使用service或node</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">source_labels</span>:
</span></span><span style="display:flex;"><span>      [
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">__meta_kubernetes_namespace,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">__meta_kubernetes_service_name,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">__meta_kubernetes_endpoint_port_name,</span>
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">default;kubernetes;https</span>
</span></span></code></pre></div>
    </div>
</div>

<h3 id="relabel_"><span id='relabel_configs'><strong>relabel_configs</strong></span></h3>
<blockquote>
<p><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config" target="_blank">relabel_configs</a> 用于在指标抓取前对标签进行预处理。应用场景包括丢弃指定指标、替换抓取指标的端口、新增或修改label。</p>
</blockquote>
<p>语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#39; &lt;labelname&gt; [, ...] &#39;</span>]      	<span style="color:#75715e"># 定义预处理的标签列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">separator</span>: <span style="color:#ae81ff">&lt;string&gt; | default = ;       		# 定义source_labels 中的标签以哪个字符串作为分隔符</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">&lt;regex&gt; | default = (.*)         		# 对source_labels中的标签按照指定正则表达式匹配</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">&lt;relabel_action&gt; | default = replace  	# 正则匹配到的部分进行处理动作</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">&lt;labelname&gt;           			# 指明匹配到的标签计划被哪标签替换。对于replace来说标签是必须的 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">&lt;string&gt; | default = $1      		# relace中定义替换后 **值** 应该替换为什么，支持正则向后引用</span>
</span></span></code></pre></div><p><strong>source_labels 和 target_label</strong></p>
<blockquote>
<p>可以利用指标标签以及prometheus、consul、kubernetes等特有标签作为 <code>source_labels</code> 和 <code>target_labels</code></p>
</blockquote>
<p>例如prometheus 可以识别的标签:</p>
<table>
  <thead>
      <tr>
          <th>标签名</th>
          <th>标签值</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>__scheme__</code></td>
          <td>http 或 https</td>
      </tr>
      <tr>
          <td><code>__address__</code></td>
          <td>ip:port  instance标签会使用该值</td>
      </tr>
      <tr>
          <td><code>__metrics_path__</code></td>
          <td>默认为 /metrics</td>
      </tr>
      <tr>
          <td><code>__param__</code></td>
          <td>url 中传递过来的参数</td>
      </tr>
      <tr>
          <td><code>__scrape_interval__</code></td>
          <td>抓取周期</td>
      </tr>
      <tr>
          <td><code>__name__</code></td>
          <td>指标名称</td>
      </tr>
      <tr>
          <td><code>__tmp__</code></td>
          <td>在打标阶段需要存储临时标签</td>
      </tr>
  </tbody>
</table>
<p><strong>action</strong></p>
<blockquote>
<p>动作包括：replace、lowercase、uppercase、keep、drop、keepequal、dropequal、hashmod、labelmap、labeldrop、labelkeep</p>
</blockquote>
<p><strong>示例</strong>

  
  

  

  


  

  

  
<ul class="nav nav-tabs justify-content-end" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          aria-controls="tabs-02-00" aria-selected="false">
        <strong>action</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          data-td-tp-persist="<span id='static_configs'>**新增标签**</span>" aria-controls="tabs-02-01" aria-selected="true">
        <span id='static_configs'><strong>新增标签</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-02" role="tab"
          data-td-tp-persist="<span id='file_sd_configs'>**replace**</span>" aria-controls="tabs-02-02" aria-selected="false">
        <span id='file_sd_configs'><strong>replace</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-03" role="tab"
          data-td-tp-persist="<span id='consul_sd_configs'>**drop**</span>" aria-controls="tabs-02-03" aria-selected="false">
        <span id='consul_sd_configs'><strong>drop</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-04" role="tab"
          data-td-tp-persist="<span id='kubernetes_sd_configs'>**keep**</span>" aria-controls="tabs-02-04" aria-selected="false">
        <span id='kubernetes_sd_configs'><strong>keep</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-05-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-05" role="tab"
          data-td-tp-persist="<span id='dns_sd_configs'>**labeldrop**</span>" aria-controls="tabs-02-05" aria-selected="false">
        <span id='dns_sd_configs'><strong>labeldrop</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-06-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-06" role="tab"
          data-td-tp-persist="<span id='dns_sd_configs'>**labelkeep**</span>" aria-controls="tabs-02-06" aria-selected="false">
        <span id='dns_sd_configs'><strong>labelkeep</strong></span>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-body tab-pane fade"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:  <span style="color:#75715e"># 添加固定标签,给当前job添加一个env=&#34;pro&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">pro</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">env</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-02" role="tabpanel" aria-labelled-by="tabs-02-02-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#34;__address__&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">separator</span>: <span style="color:#e6db74">&#34;;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;(^[0-9].*):[0-9]+&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1&#34;</span>   <span style="color:#75715e"># 新的标签值</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target_label</span>: <span style="color:#e6db74">&#34;IP&#34;</span>  <span style="color:#75715e"># 新的标签名称</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-03" role="tabpanel" aria-labelled-by="tabs-02-03-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#34;__name__&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">separator</span>: <span style="color:#e6db74">&#34;;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;go_gc_duration_seconds&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">drop </span> <span style="color:#75715e"># 删除匹配的metrics</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-04" role="tabpanel" aria-labelled-by="tabs-02-04-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:  
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#34;__name__&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">separator</span>: <span style="color:#e6db74">&#34;;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;^(node|pod|kube|mysql|redis|mongo)&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep </span> <span style="color:#75715e"># 保存匹配的metrics</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-05" role="tabpanel" aria-labelled-by="tabs-02-05-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;job&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labeldrop</span> <span style="color:#75715e"># 删除了job 标签</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-02-06" role="tabpanel" aria-labelled-by="tabs-02-06-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_congfigs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;.*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelkeep</span>
</span></span></code></pre></div>
    </div>
</div>
</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-05ff6cc9cc00a9f65de4bbb0f9434aeb">4 - kubernetes_sd_configs</h1>
    <div class="lead">kubernetes_sd_configs|prometheus</div>
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># A scrape configuration for running Prometheus on a Kubernetes cluster.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This uses separate scrape configs for cluster components (i.e. API server, node)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># and services to allow each to use different authentication configs.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kubernetes labels will be added as Prometheus labels on metrics via the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># `labelmap` relabeling action.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If you are using Kubernetes 1.7.2 or earlier, please take note of the comments</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for the kubernetes-cadvisor job; you will need to edit or remove this job.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Keep at most 100 sets of details of targets dropped by relabeling.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This information is used to display in the UI for troubleshooting.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">keep_dropped_targets</span>: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Scrape config for API servers.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kubernetes exposes API servers as endpoints to the default/kubernetes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># service so this uses `endpoints` role and uses relabelling to only keep</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># the endpoints associated with the default/kubernetes service using the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># default named port `https`. This works for single API server deployments as</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># well as HA API server deployments.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-apiservers&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Default to scraping over https. If required, just disable this or change to</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># `http`.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># This TLS &amp; authorization config is used to connect to the actual scrape</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># endpoints for cluster components. This is separate to discovery auth</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># configuration because discovery &amp; scraping are two separate concerns in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Prometheus. The discovery auth config is automatic if Prometheus runs inside</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># the cluster. Otherwise, more config options have to be provided within the</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># &lt;kubernetes_sd_config&gt;.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># If your node certificates are self-signed or use a different CA to the</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># master CA, then disable certificate verification below. Note that</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># certificate verification is an integral part of a secure infrastructure</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># so this should only be disabled in a controlled environment. You can</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># disable certificate verification by uncommenting the line below.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># insecure_skip_verify: true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">credentials_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Keep only the default/kubernetes service endpoints for the https port. This</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># will add targets for each API server which Kubernetes adds an endpoint to</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># the default/kubernetes service.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>:
</span></span><span style="display:flex;"><span>          [
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">__meta_kubernetes_namespace,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">__meta_kubernetes_service_name,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">__meta_kubernetes_endpoint_port_name,</span>
</span></span><span style="display:flex;"><span>          ]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">default;kubernetes;https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Scrape config for nodes (kubelet).</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-nodes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Default to scraping over https. If required, just disable this or change to</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># `http`.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># This TLS &amp; authorization config is used to connect to the actual scrape</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># endpoints for cluster components. This is separate to discovery auth</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># configuration because discovery &amp; scraping are two separate concerns in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Prometheus. The discovery auth config is automatic if Prometheus runs inside</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># the cluster. Otherwise, more config options have to be provided within the</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># &lt;kubernetes_sd_config&gt;.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># If your node certificates are self-signed or use a different CA to the</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># master CA, then disable certificate verification below. Note that</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># certificate verification is an integral part of a secure infrastructure</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># so this should only be disabled in a controlled environment. You can</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># disable certificate verification by uncommenting the line below.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># insecure_skip_verify: true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">credentials_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_node_label_(.+)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Scrape config for Kubelet cAdvisor.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># This is required for Kubernetes 1.7.3 and later, where cAdvisor metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># (those whose names begin with &#39;container_&#39;) have been removed from the</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Kubelet metrics endpoint.  This job scrapes the cAdvisor endpoint to</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># retrieve those metrics.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># In Kubernetes 1.7.0-1.7.2, these metrics are only exposed on the cAdvisor</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># HTTP endpoint; use the &#34;/metrics&#34; endpoint on the 4194 port of nodes. In</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># that case (and ensure cAdvisor&#39;s HTTP server hasn&#39;t been disabled with the</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># --cadvisor-port=0 Kubelet flag).</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># This job is not necessary and should be removed in Kubernetes 1.6 and</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># earlier versions, or it will cause the metrics to be scraped twice.</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-cadvisor&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Default to scraping over https. If required, just disable this or change to</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># `http`.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Starting Kubernetes 1.7.3 the cAdvisor metrics are under /metrics/cadvisor.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Kubernetes CIS Benchmark recommends against enabling the insecure HTTP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># servers of Kubernetes, therefore the cAdvisor metrics on the secure handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># are used.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics/cadvisor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># This TLS &amp; authorization config is used to connect to the actual scrape</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># endpoints for cluster components. This is separate to discovery auth</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># configuration because discovery &amp; scraping are two separate concerns in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Prometheus. The discovery auth config is automatic if Prometheus runs inside</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># the cluster. Otherwise, more config options have to be provided within the</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># &lt;kubernetes_sd_config&gt;.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># If your node certificates are self-signed or use a different CA to the</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># master CA, then disable certificate verification below. Note that</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># certificate verification is an integral part of a secure infrastructure</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># so this should only be disabled in a controlled environment. You can</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># disable certificate verification by uncommenting the line below.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># insecure_skip_verify: true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">credentials_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_node_label_(.+)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Example scrape config for service endpoints.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The relabeling allows the actual service scrape endpoint to be configured</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># for all or only some endpoints.</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-service-endpoints&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to scrape only endpoints that have</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># &#34;example.io/should_be_scraped = true&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_service_annotation_example_io_should_be_scraped]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: keep</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to customize metric path based on endpoints</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># &#34;example.io/metric_path = &lt;metric path&gt;&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_service_annotation_example_io_metric_path]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: replace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    target_label: __metrics_path__</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: (.+)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to scrape only single, desired port for the service based</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># on endpoints &#34;example.io/scrape_port = &lt;port&gt;&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__address__, __meta_kubernetes_service_annotation_example_io_scrape_port]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: replace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: ([^:]+)(?::\d+)?;(\d+)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    replacement: $1:$2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    target_label: __address__</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to configure scrape scheme for all service scrape targets</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># based on endpoints &#34;example.io/scrape_scheme = &lt;scheme&gt;&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_service_annotation_example_io_scrape_scheme]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: replace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    target_label: __scheme__</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: (https?)</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_service_label_(.+)</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_namespace]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">namespace</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_service_name]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Example scrape config for probing services via the Blackbox Exporter.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The relabeling allows the actual service scrape endpoint to be configured</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># for all or only some services.</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-services&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/probe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">module</span>: [<span style="color:#ae81ff">http_2xx]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to probe only some services that have &#34;example.io/should_be_probed = true&#34; annotation</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_service_annotation_example_io_should_be_probed]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: keep</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: true</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__param_target</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">blackbox-exporter.example.com:9115</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__param_target]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">instance</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_service_label_(.+)</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_namespace]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">namespace</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_service_name]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Example scrape config for probing ingresses via the Blackbox Exporter.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The relabeling allows the actual ingress scrape endpoint to be configured</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># for all or only some services.</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-ingresses&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/probe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">module</span>: [<span style="color:#ae81ff">http_2xx]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">ingress</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to probe only some ingresses that have &#34;example.io/should_be_probed = true&#34; annotation</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_ingress_annotation_example_io_should_be_probed]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: keep</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: true</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>:
</span></span><span style="display:flex;"><span>          [
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">__meta_kubernetes_ingress_scheme,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">__address__,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">__meta_kubernetes_ingress_path,</span>
</span></span><span style="display:flex;"><span>          ]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.+);(.+);(.+)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">${1}://${2}${3}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__param_target</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">blackbox-exporter.example.com:9115</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__param_target]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">instance</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_ingress_label_(.+)</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_namespace]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">namespace</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_ingress_name]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">ingress</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Example scrape config for pods</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The relabeling allows the actual pod scrape to be configured</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># for all the declared ports (or port-free target if none is declared)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># or only some ports.</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kubernetes-pods&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">pod</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to scrape only pods that have</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># &#34;example.io/should_be_scraped = true&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_pod_annotation_example_io_should_be_scraped]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: keep</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to customize metric path based on pod</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># &#34;example.io/metric_path = &lt;metric path&gt;&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__meta_kubernetes_pod_annotation_example_io_metric_path]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: replace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    target_label: __metrics_path__</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: (.+)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Example relabel to scrape only single, desired port for the pod</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># based on pod &#34;example.io/scrape_port = &lt;port&gt;&#34; annotation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - source_labels: [__address__, __meta_kubernetes_pod_annotation_example_io_scrape_port]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    action: replace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    regex: ([^:]+)(?::\d+)?;(\d+)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    replacement: $1:$2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    target_label: __address__</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_pod_label_(.+)</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_namespace]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">namespace</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_pod_name]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">pod</span>
</span></span></code></pre></div><p><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config" target="_blank"><span id='kubernetes_sd_configs'><strong>kubernetes_sd_configs</strong></span></a></p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl --cacert /etc/kubernetes/pki/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert /etc/kubernetes/pki/apiserver-kubelet-client.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key /etc/kubernetes/pki/apiserver-kubelet-client.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>https://192.168.0.244:6443/api/v1/services?limit<span style="color:#f92672">=</span>100&amp;resourceVersion<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div></blockquote>
<p>node、service、pod、endpoints、endpointslice、ingress</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_node_name</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_node_label_&lt;labelname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernete_node_labelpressent_&lt;labelname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_node_annotation_&lt;annotationname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_node_annotationpresent_&lt;annotationname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_node_address_&lt;address_type&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">role</span>: <span style="color:#ae81ff">service</span> <span style="color:#75715e">#这通常对于服务的黑盒监视很有用</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_name</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_port_name</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_port_protocol</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_type</span> <span style="color:#75715e">#服务的类型</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_label_&lt;labelname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_labelpresent_&lt;labelname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_annotation_&lt;annotationname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_annotationpresent_&lt;annotationname&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_cluster_ip </span> <span style="color:#75715e"># 服务的群集 IP 地址</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_service_external_name</span> <span style="color:#75715e">#服务的群集 IP 地址</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">role</span>: <span style="color:#ae81ff">pod</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_namespace：容器对象的命名空间。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_name：容器对象的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_ip：容器对象的容器 IP。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_label_&lt;labelname&gt;：容器对象中的每个标签。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_labelpresent_&lt;labelname&gt;：对于容器对象中的每个标签。true</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_annotation_&lt;annotationname&gt;：来自容器对象的每个注释。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_annotationpresent_&lt;annotationname&gt;：对于容器对象中的每个注释。true</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_container_init：如果容器是InitContainertrue</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_container_name：目标地址指向的容器的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_container_port_name：容器端口的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_container_port_number：容器端口的编号。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_container_port_protocol：容器端口的协议。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_ready：设置为或表示容器的就绪状态。truefalse</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_phase：在生命周期中设置为 、、 或 。PendingRunningSucceededFailedUnknown</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_node_name：调度 Pod 所到的节点的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_host_ip：容器对象的当前主机 IP。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_uid：容器对象的 UID。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_controller_kind：容器控制器的对象类型。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_pod_controller_name：容器控制器的名称</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">role</span>: <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_namespace：终结点对象的命名空间。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoints_name：终结点对象的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">对于直接从终端节点列表中发现的所有目标（未从底层 Pod 额外推断出的目标），将附加以下标签：</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_hostname：终结点的主机名。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_node_name：承载终结点的节点的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_ready：设置为终结点的就绪状态或为其设置。truefalse</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_port_name：终结点端口的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_port_protocol：端点端口的协议。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_address_target_kind：终结点地址目标的类型。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_endpoint_address_target_name：终结点地址目标的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">如果终结点属于某个服务，则会附加发现的所有标签。role</span>: <span style="color:#ae81ff">service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">对于容器支持的所有目标，将附加发现的所有标签。role</span>: <span style="color:#ae81ff">pod</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">role</span>: <span style="color:#ae81ff">ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">该角色为每个入口的每个路径发现一个目标。这通常对于入口的黑盒监视很有用。该地址将设置为入口规范中指定的主机。ingress</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">可用的元标签：</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_namespace：入口对象的命名空间。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_name：入口对象的名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_label_&lt;labelname&gt;：入口对象中的每个标签。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_labelpresent_&lt;labelname&gt;：对于入口对象中的每个标签。true</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_annotation_&lt;annotationname&gt;：来自入口对象的每个批注。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_annotationpresent_&lt;annotationname&gt;：对于入口对象中的每个批注。true</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_class_name：入口规范中的类名（如果存在）。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_scheme：入口的协议方案（如果设置了 TLS 配置）。缺省值为 。httpshttp</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">__meta_kubernetes_ingress_path：入口规范的路径。缺省值为 。</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-882797a566a6d870802dfa95b7787f8a">5 - consul_sd_configs</h1>
    <div class="lead">kconsul_sd_configs|prometheus</div>
	<p><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#consul_sd_config" target="_blank"><span id='consul_sd_configs'><strong>consul_sd_configs</strong></span></a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 启动一个单实例的[consul](https://www.consul.io/downloads)</span>
</span></span><span style="display:flex;"><span>consul agent -bootstrap <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client<span style="color:#f92672">=</span>0.0.0.0  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-config-dir<span style="color:#f92672">=</span>/etc/conf.d <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-data-dir<span style="color:#f92672">=</span>/consul/data/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-enable-local-script-checks  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-ui
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在consul 中注册服务</span>
</span></span><span style="display:flex;"><span>vi /etc/conf.d/node.json
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;services&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;node_exporter-node01&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;node01&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;10.4.7.11&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;port&#34;</span>: 9100,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;tags&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;nodes&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;checks&#34;</span>: <span style="color:#f92672">[{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;http&#34;</span>: <span style="color:#e6db74">&#34;http://10.4.7.11:9100/metrics&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;interval&#34;</span>: <span style="color:#e6db74">&#34;5s&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;node_exporter-node02&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;node02&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;10.4.7.12&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;port&#34;</span>: 9100,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;tags&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;nodes&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;checks&#34;</span>: <span style="color:#f92672">[{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;http&#34;</span>: <span style="color:#e6db74">&#34;http://10.4.7.12:9100/metrics&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;interval&#34;</span>: <span style="color:#e6db74">&#34;5s&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加载配置文件/etc/conf.d/node.json</span>
</span></span><span style="display:flex;"><span>consul reload
</span></span><span style="display:flex;"><span>scrape_configs:
</span></span><span style="display:flex;"><span>- job_name: <span style="color:#e6db74">&#34;node&#34;</span>
</span></span><span style="display:flex;"><span>  consul_sd_configs:
</span></span><span style="display:flex;"><span>  - server: <span style="color:#e6db74">&#34;47.113.100.31:8500&#34;</span>
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;nodes&#34;</span>
</span></span><span style="display:flex;"><span>    refresh_interval: 2m
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 通过测试命令测试服务的注册发现</span>
</span></span><span style="display:flex;"><span>consul services register -id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;node_exporter-node02&#34;</span>
</span></span><span style="display:flex;"><span>consul services deregister -id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;node_exporter-node02&#34;</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-be6a851a8907242be24193da43e763a0">6 - PromeQL</h1>
    <div class="lead">PromeQL|prometheus</div>
	<p><a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank">promQL</a> 是prometheus时序数据库的查询语言，可以类比为关系数据库中的SQL。</p>
<h3 id="指标类型">指标类型</h3>
<hr>
<ul>
<li>
<p>gauge: 是一个状态的瞬时快照，值可增可减。配合 <code>changes</code> <code>delta</code> <code>predict_linear</code> <code>deriv</code></p>
</li>
<li>
<p>counter: 是一个累加的指标，自metrics启动以后该值一直累加。 配合 <code>rate</code> <code> irate</code> <code>increase</code></p>
</li>
<li>
<p>summary: 摘要可以展示数据分布 ,允许计算百分位数。 配合 <code>count</code> <code>sum</code> <code>quantitle</code></p>
</li>
<li>
<p>histogram: 直方图可以展示数据分布，按照桶把数据分布投递到不同桶中。直方图的数值是累计的，后一个包含前一个桶中的数据。配合 <code>histogram_quantile</code><br>
例如：<code>histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))</code></p>
</li>
</ul>
<h3 id="查询结果数据类型">查询结果数据类型</h3>
<hr>
<ul>
<li>
<p>即时矢量: 一组时间序列，其中包含每个时间序列的单个样本，所有时间序列共享相同的时间戳</p>
</li>
<li>
<p>范围向量: 一组时间序列，其中包含每个时间序列随时间变化的数据点范围.</p>
<p>例如：</p>
<p>[5m]表示的时间范围是5分钟。
s表示秒
m表示分钟
h表示小时
d表示天
w表示周</p>
</li>
<li>
<p>标量: 一个简单的数字浮点值</p>
</li>
<li>
<p>字符串: 一个简单的字符串值;</p>
</li>
</ul>
<h3 id="查询语句">查询语句</h3>
<hr>

  
  
  

  

  

<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>基本语法</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="示例格式一" aria-controls="tabs-00-01" aria-selected="true">
        示例格式一
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="示例格式二" aria-controls="tabs-00-02" aria-selected="false">
        示例格式二
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="示例格式三" aria-controls="tabs-00-03" aria-selected="false">
        示例格式三
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-04" role="tab"
          data-td-tp-persist="示例格式四" aria-controls="tabs-00-04" aria-selected="false">
        示例格式四
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span>,method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    	!<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                    	<span style="color:#f92672">=</span>~ 选择正则表达式与提供的字符串匹配的指标
</span></span><span style="display:flex;"><span>                    	!~ 选择正则表达式与提供的字符串不匹配的指标
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <p>通过label查询</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span>__name__<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http_requests_total&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>__name__<span style="color:#f92672">=</span>~<span style="color:#e6db74">&#34;.*total</span>$<span style="color:#e6db74">&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span>job<span style="color:#f92672">=</span>~<span style="color:#e6db74">&#34;.+&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>job<span style="color:#f92672">=</span>~<span style="color:#e6db74">&#34;.*&#34;</span>,method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span><span style="color:#f92672">}</span> 
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span>__name__<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http_requests_total&#34;</span><span style="color:#f92672">}[</span>1m<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                 				 ms
</span></span><span style="display:flex;"><span>                  				 s
</span></span><span style="display:flex;"><span>                  				 m
</span></span><span style="display:flex;"><span>                  				 h
</span></span><span style="display:flex;"><span>                  				 d
</span></span><span style="display:flex;"><span>                  				 w
</span></span><span style="display:flex;"><span>                  				 y
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-04" role="tabpanel" aria-labelled-by="tabs-00-04-tab" tabindex="0">
        <p>时间偏移量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http_requests_total @1609746000
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>http_requests_total<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">}</span> @1609746000<span style="color:#f92672">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http_requests_total offset 5m
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>http_requests_total<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">}</span> offset 5m<span style="color:#f92672">)</span>
</span></span></code></pre></div>
    </div>
</div>

<p><strong>标签表达式</strong></p>
<table>
  <thead>
      <tr>
          <th>表达式</th>
          <th>释义</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>=</strong></td>
          <td>精确匹配给定的值</td>
          <td></td>
      </tr>
      <tr>
          <td><strong>!=</strong></td>
          <td>精确不匹配给定的值</td>
          <td></td>
      </tr>
      <tr>
          <td><strong>=~</strong></td>
          <td>正则匹配给定的值</td>
          <td>`http_requests_total{environment=~&ldquo;staging</td>
      </tr>
      <tr>
          <td><strong>!~</strong></td>
          <td>正则不匹配给定的值</td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>运算符：</strong></p>

  
  
    
    

<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>运算符</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="算术运算" aria-controls="tabs-01-01" aria-selected="true">
        算术运算
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="比较运算符" aria-controls="tabs-01-02" aria-selected="false">
        比较运算符
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          data-td-tp-persist="逻辑运算符" aria-controls="tabs-01-03" aria-selected="false">
        逻辑运算符
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <ul>
<li>
<p>算术运算</p>
<p><sub>作用范围：（浮点数与浮点数  浮点数与瞬时向量    瞬时向量与瞬时向量），瞬时向量间标签k,v必须保持完全一致</sub></p>
<table>
  <thead>
      <tr>
          <th>运算符</th>
          <th>功能</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>+</td>
          <td>添加</td>
          <td></td>
      </tr>
      <tr>
          <td>-</td>
          <td>减法</td>
          <td></td>
      </tr>
      <tr>
          <td>*</td>
          <td>乘法</td>
          <td></td>
      </tr>
      <tr>
          <td>/</td>
          <td>取商</td>
          <td></td>
      </tr>
      <tr>
          <td>%</td>
          <td>取余数</td>
          <td></td>
      </tr>
      <tr>
          <td>^</td>
          <td>幂</td>
          <td></td>
      </tr>
  </tbody>
</table>
</li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <ul>
<li>
<p>比较运算符</p>
<p><sub>作用范围：（浮点数与浮点数  浮点数与瞬时向量    瞬时向量与瞬时向量）</sub></p>
<p>两个标量之间必须使用 <code>bool</code> 装饰器进行比较，返回0(flase) 或 1(true)</p>
<table>
  <thead>
      <tr>
          <th>运算符</th>
          <th>功能</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>==</td>
          <td>等于</td>
          <td></td>
      </tr>
      <tr>
          <td>!=</td>
          <td>不相等</td>
          <td></td>
      </tr>
      <tr>
          <td>&gt;</td>
          <td>大于</td>
          <td></td>
      </tr>
      <tr>
          <td>&lt;</td>
          <td>小于</td>
          <td></td>
      </tr>
      <tr>
          <td>&gt;=</td>
          <td>大于等于</td>
          <td></td>
      </tr>
      <tr>
          <td>&lt;=</td>
          <td>小于等于</td>
          <td></td>
      </tr>
  </tbody>
</table>
</li>
</ul>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <ul>
<li>
<p>逻辑运算符</p>
<blockquote>
<p><font color=red>逻辑运算两边的标签保持一致</font></p>
</blockquote>
<table>
  <thead>
      <tr>
          <th>运算符</th>
          <th>功能</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>and</td>
          <td>交集</td>
          <td></td>
      </tr>
      <tr>
          <td>or</td>
          <td>并集</td>
          <td></td>
      </tr>
      <tr>
          <td>unless</td>
          <td>补集,左侧有右侧没有的</td>
          <td></td>
      </tr>
  </tbody>
</table>
</li>
</ul>

    </div>
</div>

<p><strong>聚合操作：</strong></p>
<ol>
<li>基于标签聚合</li>
</ol>
<table>
  <thead>
      <tr>
          <th>分类</th>
          <th>运算符</th>
          <th>功能</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>聚合操作分组</td>
          <td>by</td>
          <td></td>
          <td><code>sum by(code) (method_code:http_errors:rate5m)</code></td>
      </tr>
      <tr>
          <td></td>
          <td>without</td>
          <td></td>
          <td><code>sum without(code) (method_code:http_errors:rate5m)</code></td>
      </tr>
      <tr>
          <td>聚合操作符</td>
          <td>sum</td>
          <td>求和</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>count</td>
          <td>计数</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>avg</td>
          <td>平均值</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>max</td>
          <td>最大值</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>min</td>
          <td>最小值</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>topk</td>
          <td>按样本值计算的最大 k 个元素</td>
          <td><code>topk(2,method_code:http_errors:rate5m)</code></td>
      </tr>
      <tr>
          <td></td>
          <td>bottomk</td>
          <td>按样本值排列的最小 k 个元素</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>quantile</td>
          <td>计算φ分位数（0 ≤ φ ≤ 1）的尺寸</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>count_values</td>
          <td>计算具有相同值的元素数</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>stddev</td>
          <td>标准偏差</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>stdvar</td>
          <td>标准与维度的方差</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>group</td>
          <td>结果向量中的所有值均为 1</td>
          <td></td>
      </tr>
  </tbody>
</table>
<ol start="2">
<li>
<p>基于时间聚合</p>
<p><code>_over_time</code> 可以做到保留标签</p>
</li>
</ol>
<p>向量匹配</p>
<ul>
<li>one-to-one</li>
<li>many-to-one and group_left</li>
<li>many-to-many</li>
</ul>
<p><span id='xiangliangpipei'><strong>向量匹配</strong></span></p>
<blockquote>
<p>必须具有相同的标签，如果一方标签过多可以使max by 保留指定标签</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>--collector.textfile --collector.textfile.directory<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.&#34;</span>
</span></span><span style="display:flex;"><span>vi httpcod.prom
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#输入示例：</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;404&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;put&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;501&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;404&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>method:http_requests:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>method:http_requests:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;del&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">34</span>
</span></span><span style="display:flex;"><span>method:http_requests:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">120</span>
</span></span></code></pre></div><p><strong>One-to-one:</strong> 两侧如果具有相同的标签和键  =&gt; 则匹配。<strong>on</strong> 在指定标签上进行匹配，<strong>ignoring</strong>则忽略指定标签</p>
<p>语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&lt;vector expr&gt; &lt;bin-op&gt; ignoring<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> &lt;vector expr&gt;
</span></span><span style="display:flex;"><span>&lt;vector expr&gt; &lt;bin-op&gt; on<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> &lt;vector expr&gt;
</span></span></code></pre></div><p>事例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># method_code:http_errors:rate5m{method=&#34;get&#34;, code=&#34;500&#34;}  24</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># method_code:http_errors:rate5m{method=&#34;post&#34;, code=&#34;500&#34;} 6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># method:http_requests:rate5m{method=&#34;get&#34;}  600</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># method:http_requests:rate5m{method=&#34;post&#34;} 120</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span> / ignoring<span style="color:#f92672">(</span>code<span style="color:#f92672">)</span> method:http_requests:rate5m
</span></span></code></pre></div><p>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span><span style="color:#f92672">}</span>  0.04            //  <span style="color:#ae81ff">24</span> / <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span><span style="color:#f92672">}</span> 0.05            //   <span style="color:#ae81ff">6</span> / <span style="color:#ae81ff">120</span>
</span></span></code></pre></div><p><strong>Many-to-one</strong> and <strong>one-to-many</strong> :  在向量的一侧可以找到多个与之对应的记录</p>
<p>少的一次都能在多的一侧找到对应的 指标。</p>
<p>使用 group_left 和 group_right 指定哪一侧位多的一侧</p>
<p>使用on 和 ignore 指定参照哪个标签进行运算</p>
<p>语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&lt;vector expr&gt; &lt;bin-op&gt; ignoring<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> group_left<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> &lt;vector expr&gt;
</span></span><span style="display:flex;"><span>&lt;vector expr&gt; &lt;bin-op&gt; ignoring<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> group_right<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> &lt;vector expr&gt;
</span></span><span style="display:flex;"><span>&lt;vector expr&gt; &lt;bin-op&gt; on<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> group_left<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> &lt;vector expr&gt;
</span></span><span style="display:flex;"><span>&lt;vector expr&gt; &lt;bin-op&gt; on<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> group_right<span style="color:#f92672">(</span>&lt;label list&gt;<span style="color:#f92672">)</span> &lt;vector expr&gt;
</span></span></code></pre></div><p>事例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#group_left 和 group_right 参照 one-to-many 的many 一侧</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m / ignoring<span style="color:#f92672">(</span>code<span style="color:#f92672">)</span> group_left method:http_requests:rate5m
</span></span></code></pre></div><p>结果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span>  0.04            //  <span style="color:#ae81ff">24</span> / <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;404&#34;</span><span style="color:#f92672">}</span>  0.05            //  <span style="color:#ae81ff">30</span> / <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span> 0.05            //   <span style="color:#ae81ff">6</span> / <span style="color:#ae81ff">120</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;404&#34;</span><span style="color:#f92672">}</span> 0.175           //  <span style="color:#ae81ff">21</span> / <span style="color:#ae81ff">120</span>
</span></span></code></pre></div><h3 id="函数">函数</h3>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>up</td>
          <td>target是否存活</td>
          <td></td>
      </tr>
      <tr>
          <td>absent</td>
          <td>即时向量指标存在什么都不返回，不存在返回1</td>
          <td></td>
      </tr>
      <tr>
          <td>abs</td>
          <td>绝对值</td>
          <td></td>
      </tr>
      <tr>
          <td>absent_over_time</td>
          <td>用于判断范围向量<code>absent_over_time(up1[10m])</code></td>
          <td></td>
      </tr>
      <tr>
          <td>ceil</td>
          <td>四舍五入</td>
          <td></td>
      </tr>
      <tr>
          <td>floor</td>
          <td>舍小数取整</td>
          <td></td>
      </tr>
      <tr>
          <td>time</td>
          <td>返回时间戳</td>
          <td></td>
      </tr>
      <tr>
          <td>changes</td>
          <td>记录变化的次数，比如一个任务从up 变为down 后又变为up  此时应该返回2</td>
          <td><code>changes(up[5m])&gt;0</code></td>
      </tr>
      <tr>
          <td>increase<sub>【用于counter】</sub></td>
          <td>截取 counter 类型一个时间段的增量</td>
          <td><code>increase(node_cpu_secound_total[1m])</code></td>
      </tr>
      <tr>
          <td>irate <sub>【用于counter】</sub></td>
          <td>每秒变化量</td>
          <td></td>
      </tr>
      <tr>
          <td>rate <sub>【用于counter】</sub></td>
          <td>每秒变化量</td>
          <td></td>
      </tr>
      <tr>
          <td>sort</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>sort_desc</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>topk</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>bottomk</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>delta</td>
          <td>截取 counter 类型一个时间段的增量</td>
          <td><code>delta(node_cpu_seconds_total[10m])</code></td>
      </tr>
      <tr>
          <td>last_over_time</td>
          <td>获取指定时间范围内最后一个非空值</td>
          <td><code>last_over_time(stock_price_change[60m])</code></td>
      </tr>
  </tbody>
</table>
<ol>
<li>
<p>label_replace</p>
<blockquote>
<p>替换标签和内容</p>
</blockquote>
<p><strong>语法</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>label_replace<span style="color:#f92672">(</span>__input_vector__,<span style="color:#e6db74">&#34;__dst__&#34;</span>,<span style="color:#e6db74">&#34;__replacement__&#34;</span>,<span style="color:#e6db74">&#34;__src__&#34;</span>,<span style="color:#e6db74">&#34;__regex__&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p><strong>举例</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>label_replace<span style="color:#f92672">(</span>lv_pool_total,<span style="color:#e6db74">&#34;lv_name_new&#34;</span>,<span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#34;lv_name&#34;</span>,<span style="color:#e6db74">&#34;(.*)&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div></li>
<li>
<p>label_join</p>
<p><strong>语法</strong></p>
<p><strong>举例</strong></p>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f429588e5a52c95dd5bec002541ac0aa">7 - 夜莺·监控系统</h1>
    <div class="lead">夜莺·监控系统</div>
	<p>通过自行构建image，快速体验夜莺</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/ccfos/nightingale.git
</span></span></code></pre></div><blockquote>
<p>位置 nightingale/Dockerfile.nightingale</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">node:16-alpine</span> <span style="color:#66d9ef">AS</span> <span style="color:#e6db74">fe-builder</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk add git<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> git clone https://github.com/n9e/fe.git <span style="color:#f92672">&amp;&amp;</span> cd fe <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    git checkout <span style="color:#66d9ef">$(</span>git describe --tags --abbrev<span style="color:#f92672">=</span>0<span style="color:#66d9ef">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    npm config set registry https://registry.npmmirror.com <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    npm install <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    npm run build<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">golang:1.23.4-alpine3.20</span> <span style="color:#66d9ef">AS</span> <span style="color:#e6db74">builder</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>fe-builder /fe/pub /pub<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk add git<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> git clone https://github.com/ccfos/nightingale.git <span style="color:#f92672">&amp;&amp;</span> cd nightingale <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    git checkout <span style="color:#66d9ef">$(</span>git describe --tags --abbrev<span style="color:#f92672">=</span>0<span style="color:#66d9ef">)</span> <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    export GOPROXY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://goproxy.cn,direct&#34;</span> <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    go install github.com/rakyll/statik@latest <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    statik --src<span style="color:#f92672">=</span>/pub -dest<span style="color:#f92672">=</span>./front <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    go build -ldflags <span style="color:#e6db74">&#34;-w -s -X github.com/ccfos/nightingale/v6/pkg/version.Version=</span><span style="color:#66d9ef">$(</span>git describe --tags --abbrev<span style="color:#f92672">=</span>0<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -o /n9e ./cmd/center/main.go<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">python:3-slim</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span> <span style="color:#e6db74">/app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>builder /n9e /app/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> etc /app/etc/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> integrations /app/integrations/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install requests -i https://pypi.tuna.tsinghua.edu.cn/simple<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span> <span style="color:#e6db74">17000</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/app/n9e&#34;</span>, <span style="color:#e6db74">&#34;-h&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><blockquote>
<p>位置 nightingale/docker/compose-bridge/docker-compose.yaml</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span>networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  nightingale:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    driver: bridge<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>services:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  mysql:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    image: <span style="color:#e6db74">&#34;mysql:8&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    container_name: mysql<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    hostname: mysql<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    restart: always<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      TZ: Asia/Shanghai<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      MYSQL_ROOT_PASSWORD: <span style="color:#ae81ff">1234</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    volumes:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - ./data/mysqldata:/var/lib/mysql/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - ../initsql:/docker-entrypoint-initdb.d/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - ./etc-mysql/my.cnf:/etc/my.cnf<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    ports:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;3306:3306&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  redis:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    image: <span style="color:#e6db74">&#34;redis:6.2&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    container_name: redis<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    hostname: redis<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    restart: always<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      TZ: Asia/Shanghai<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    ports:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;6379:6379&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e"># prometheus:</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   image: prom/prometheus</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   container_name: prometheus</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   hostname: prometheus</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   restart: always</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   environment:</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     TZ: Asia/Shanghai</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   volumes:</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - ./etc-prometheus:/etc/prometheus</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   command:</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;--config.file=/etc/prometheus/prometheus.yml&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;--storage.tsdb.path=/prometheus&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;--web.console.libraries=/usr/share/prometheus/console_libraries&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;--web.console.templates=/usr/share/prometheus/consoles&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;--enable-feature=remote-write-receiver&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;--query.lookback-delta=2m&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   networks:</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - nightingale</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#   ports:</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">#     - &#34;9090:9090&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  victoriametrics:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    image: victoriametrics/victoria-metrics:v1.79.12<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    container_name: victoriametrics<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    hostname: victoriametrics<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    restart: always<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      TZ: Asia/Shanghai<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    ports:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;8428:8428&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    command:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;--loggerTimezone=Asia/Shanghai&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    volumes:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;./data/victoriametrics:/victoria-metrics-data&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  loki:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    image: grafana/loki:3.5.0<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    container_name: loki<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    hostname: loki<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    restart: always<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    user: root<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      TZ: Asia/Shanghai<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    ports:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;3100:3100&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    volumes:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - ./data/loki:/loki<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span> <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  nightingale:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    build:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      context: ../..<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      dockerfile: Dockerfile.nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    container_name: nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    hostname: nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    restart: always<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      GIN_MODE: release<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      TZ: Asia/Shanghai<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      WAIT_HOSTS: mysql:3306, redis:6379<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    volumes:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - ./etc-nightingale:/app/etc<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    ports:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;17000:17000&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;20090:20090&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    depends_on:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - mysql<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - redis<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - victoriametrics<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    command: &gt;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      sh -c <span style="color:#e6db74">&#34;/app/n9e&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  categraf:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    image: <span style="color:#e6db74">&#34;flashcatcloud/categraf:latest&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    container_name: <span style="color:#e6db74">&#34;categraf&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    hostname: <span style="color:#e6db74">&#34;categraf01&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    restart: always<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      TZ: Asia/Shanghai<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      HOST_PROC: /hostfs/proc<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      HOST_SYS: /hostfs/sys<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      HOST_MOUNT_PREFIX: /hostfs<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      WAIT_HOSTS: nightingale:17000, nightingale:20090<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    volumes:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - ./etc-categraf:/etc/categraf/conf<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - /:/hostfs<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    depends_on:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - nightingale<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd nightingale/docker/compose-bridge/
</span></span><span style="display:flex;"><span>docker-compose up
</span></span><span style="display:flex;"><span><span style="color:#75715e"># root root.2020</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fc27d5a38407c7add3b1bb091b945197">8 - federation</h1>
    <div class="lead">federation|prometheus</div>
	<p>安装部署</p>
<blockquote>
<p>federation 可以实现全局视图。主节点不仅可以提取聚合指标，还可以为Grafana等工具暴露指标或者作为可视化的默认数据源</p>
</blockquote>

  
  

  




  

  

<ul class="nav nav-tabs justify-content-end" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>联邦配置</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="<span id='static_configs'>**节点1**</span>" aria-controls="tabs-00-01" aria-selected="true">
        <span id='static_configs'><strong>节点1</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="<span id='static_configs'>**节点2**</span>" aria-controls="tabs-00-02" aria-selected="false">
        <span id='static_configs'><strong>节点2</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="<span id='static_configs'>**节点3**</span>" aria-controls="tabs-00-03" aria-selected="false">
        <span id='static_configs'><strong>节点3</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-04" role="tab"
          data-td-tp-persist="<span id='dns_sd_configs'>**主节点**</span>" aria-controls="tabs-00-04" aria-selected="false">
        <span id='dns_sd_configs'><strong>主节点</strong></span>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">worker</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rule_files</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#e6db74">&#34;rules/node_rules.yml&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;node&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">file_sd_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">files</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">targets/nodes/*.json</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">refresh_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">modulus</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__tmp_hash</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">hashmod</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__tmp_hash]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">^0$</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">worker</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rule_files</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#e6db74">&#34;rules/node_rules.yml&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;node&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">file_sd_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">files</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">targets/nodes/*.json</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">refresh_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">modulus</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__tmp_hash</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">hashmod</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__tmp_hash]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">^1$</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">worker</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rule_files</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#e6db74">&#34;rules/node_rules.yml&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;node&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">file_sd_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">files</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">targets/nodes/*.json</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">refresh_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">modulus</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__tmp_hash</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">hashmod</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__tmp_hash]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">^2$</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-04" role="tabpanel" aria-labelled-by="tabs-00-04-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;federate&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">15s</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">honor_labels</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#e6db74">&#39;/federate&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#39;match[]&#39;</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#39;{job=&#34;prometheus&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#39;{__name__=~&#34;job:.*&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#39;source-prometheus-1:9090&#39;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#39;source-prometheus-2:9090&#39;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#39;source-prometheus-3:9090&#39;</span>
</span></span></code></pre></div>
    </div>
</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c6ca951d0441de2c3fbff37db4cd100a">9 - 附录</h1>
    <div class="lead">附录|prometheus</div>
	<h3 id="prometheus-兼容api">prometheus 兼容API</h3>
<hr>

  
  

  




     
    
     

   <ul class="nav nav-tabs justify-content-end" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>查询</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="<span id='static_configs'>**查询瞬时向量**</span>" aria-controls="tabs-00-01" aria-selected="true">
        <span id='static_configs'><strong>查询瞬时向量</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="<span id='static_configs'>**查询范围向量**</span>" aria-controls="tabs-00-02" aria-selected="false">
        <span id='static_configs'><strong>查询范围向量</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="<span id='static_configs'>**查询告警/记录规则**</span>" aria-controls="tabs-00-03" aria-selected="false">
        <span id='static_configs'><strong>查询告警/记录规则</strong></span>
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-04" role="tab"
          data-td-tp-persist="<span id='dns_sd_configs'>**查询活动的警报**</span>" aria-controls="tabs-00-04" aria-selected="false">
        <span id='dns_sd_configs'><strong>查询活动的警报</strong></span>
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -s http://127.0.0.1:9090/api/v1/query?query<span style="color:#f92672">=</span>prometheus_build_info
</span></span><span style="display:flex;"><span>curl -X POST -d <span style="color:#e6db74">&#34;query=prometheus_build_info&#34;</span>  http://127.0.0.1:9090/api/v1/query
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>curl -s http://127.0.0.1:9090/api/v1/query?query<span style="color:#f92672">=</span>node_cpu|jq
</span></span><span style="display:flex;"><span>curl -s -g <span style="color:#e6db74">&#39;http://127.0.0.1:9090/api/v1/query?query=node_cpu{cpu=&#34;cpu0&#34;}&#39;</span> |jq <span style="color:#e6db74">&#39;.data.result[3].value&#39;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -s -g <span style="color:#e6db74">&#39;http://127.0.0.1:9090/api/v1/query_range?query=rate(prometheus_tsdb_head_samples_appended_total[5m])&amp;start=1514764800&amp;end=1762830278&amp;step=60&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -XPOST -d <span style="color:#e6db74">&#39;query=rate(prometheus_tsdb_head_samples_appended_total[5m])&amp;start=1514764800&amp;end=1762830278&amp;step=60&#39;</span> http://127.0.0.1:9090/api/v1/query_range
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -s http://127.0.0.1:9090/api/v1/rules | jq
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-04" role="tabpanel" aria-labelled-by="tabs-00-04-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -s http://127.0.0.1:9090/api/v1/alerts | jq
</span></span></code></pre></div>
    </div>
</div>

<hr>
<h3 id="故障分析">故障分析</h3>
<p><strong>问题描述：</strong></p>
<ul>
<li>部分主机cpu使用率持续40分钟超94% 并，告警没有正常发出来。同一个告警下又有主机能够正常发出告警。</li>
</ul>
<p><strong>排查过程:</strong></p>
<pre class="mermaid">flowchart TB

 A[&#34;通过promQL 执行告警规则中的语句，确实达到了触发告警规则的基准&#34;]
 B[&#34;检查alertmanger,发现alertmanger并没有收到该告警&#34;]
 C[&#34;&lt;font color=red&gt;【隐蔽问题：重复第一步通过频繁查询发现有30%的概率查询不到符合告警规则的主机】&lt;/font&gt;&#34;]
 D[&#34;Prometheus开启了远程写入和查询，开始怀疑是不是远程查询导致的查询失败。
 通过promQL 执行其他查询语句，未发现上述【隐蔽问题】&#34;]
 E[&#34;尝试修改该告警规则中promQL 语句，意外发现上述隐蔽问题修复了!!&#34;]
 A -.-&gt;B-.-&gt;C-.-&gt;D-.-&gt;E</pre>


  
  
<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          data-td-tp-persist="修改前" aria-controls="tabs-01-00" aria-selected="true">
        修改前
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="修改后" aria-controls="tabs-01-01" aria-selected="false">
        修改后
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>label_replace<span style="color:#f92672">(</span>sum by<span style="color:#f92672">(</span>node<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>rate<span style="color:#f92672">(</span>container_cpu_usage_seconds_total<span style="color:#f92672">{</span>id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}[</span>2m<span style="color:#f92672">]))</span>,<span style="color:#e6db74">&#34;hostname&#34;</span>, <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;node&#34;</span>, <span style="color:#e6db74">&#34;(.*)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/ 
</span></span><span style="display:flex;"><span>label_replace<span style="color:#f92672">(</span>sum by<span style="color:#f92672">(</span>node<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>machine_cpu_cores<span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;hostname&#34;</span>, <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;node&#34;</span>, <span style="color:#e6db74">&#34;(.*)&#34;</span><span style="color:#f92672">)</span> * <span style="color:#ae81ff">100</span> &gt; <span style="color:#ae81ff">80</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>label_replace<span style="color:#f92672">(</span>sum by<span style="color:#f92672">(</span>node<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>rate<span style="color:#f92672">(</span>container_cpu_usage_seconds_total<span style="color:#f92672">{</span>id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}[</span>5m<span style="color:#f92672">]))</span>,<span style="color:#e6db74">&#34;hostname&#34;</span>, <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;node&#34;</span>, <span style="color:#e6db74">&#34;(.*)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/ 
</span></span><span style="display:flex;"><span>label_replace<span style="color:#f92672">(</span>sum by<span style="color:#f92672">(</span>node<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>machine_cpu_cores<span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;hostname&#34;</span>, <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;node&#34;</span>, <span style="color:#e6db74">&#34;(.*)&#34;</span><span style="color:#f92672">)</span> * <span style="color:#ae81ff">100</span> &gt; <span style="color:#ae81ff">80</span>
</span></span></code></pre></div>
    </div>
</div>

<p><strong>故障总结</strong></p>
<p>根本原因是<code>rate</code>计算速率的函数基于最后2个数据点执行计算，由于<code>rate()[2m]</code> 时间跨度刚好等于<code>scrape_interval</code> 因此存在一定概率2分钟内没有两个数据采集点位导致数据点缺失或时间对齐问题返回空值。</p>
<p>解决办法建议将范围扩大到 <code>scrape_interval</code>*4</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d5033e8c9a46dd0403d5bde3fa28069c">10 - exporter</h1>
    
	<table>
  <thead>
      <tr>
          <th style="text-align: left">范围</th>
          <th style="text-align: left">常用 Exporter</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">promethues组件</td>
          <td style="text-align: left">prometheus(9090)、pushgateway(9091)、alertmanager(9093)、grafana(3000)、consul(8500)</td>
      </tr>
      <tr>
          <td style="text-align: left">k8s组件</td>
          <td style="text-align: left">etcd(2379)、apiserver(6443)、scheduler、controllermanager、kubeproxy、kubelet、coredns(9153)、flanneld、traefik/nginx-ingress、cadvisor(8080)、kube_state_metrics</td>
      </tr>
      <tr>
          <td style="text-align: left">数据库</td>
          <td style="text-align: left">MySQL Exporter、Redis Exporter(9121)、MongoDB Exporter、MSSQL Exporter 等</td>
      </tr>
      <tr>
          <td style="text-align: left">硬件</td>
          <td style="text-align: left">Apcupsd Exporter、IoT Edison Exporter、IPMI Exporter、Node Exporter(9100) 等</td>
      </tr>
      <tr>
          <td style="text-align: left">消息队列</td>
          <td style="text-align: left">Zookeeper Exporter、Kafka Exporter、RabbitMQ Exporter、Beanstalkd Exporter 、NSQ Exporter等</td>
      </tr>
      <tr>
          <td style="text-align: left">存储</td>
          <td style="text-align: left">Minio、 Ceph Exporter、Gluster Exporter、HDFS Exporter、ScaleIO Exporter 等</td>
      </tr>
      <tr>
          <td style="text-align: left">HTTP服务</td>
          <td style="text-align: left">Apache Exporter、HAProxy Exporter、Nginx Exporter 等</td>
      </tr>
      <tr>
          <td style="text-align: left">API服务</td>
          <td style="text-align: left">AWS ECS Exporter、Docker Cloud Exporter、Docker Hub Exporter、GitHub Exporter 等</td>
      </tr>
      <tr>
          <td style="text-align: left">日志</td>
          <td style="text-align: left">Fluentd Exporter、Grok Exporter 等</td>
      </tr>
      <tr>
          <td style="text-align: left">监控系统</td>
          <td style="text-align: left">Collectd Exporter、Graphite Exporter、InfluxDB Exporter、Nagios Exporter、SNMP Exporter 等</td>
      </tr>
      <tr>
          <td style="text-align: left">java</td>
          <td style="text-align: left">jmx_exporter、tomcat</td>
      </tr>
      <tr>
          <td style="text-align: left">其它</td>
          <td style="text-align: left">Blockbox Exporter、JIRA Exporter、Jenkins Exporter、Confluence Exporter 等</td>
      </tr>
  </tbody>
</table>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-624d0b59238886cb73ea365101d34bb0">10.1 - node_exporter</h1>
    <div class="lead">node_exporter|exporter|prometheus</div>
	<p>提供操作系统级别的监控指标，<code>cpu</code> <code>memory</code> <code>disk space</code> <code>diskio</code> <code>network</code></p>

  
  
  

 <ul class="nav nav-tabs justify-content-end" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong><a href="https://prometheus.io/download/#node_exporter" target="_blank">部署安装</a></strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="二进制" aria-controls="tabs-00-01" aria-selected="true">
        二进制
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="kubernetes" aria-controls="tabs-00-02" aria-selected="false">
        kubernetes
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/prometheus/node_exporter/releases/download/v1.6.1/node_exporter-1.6.1.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf node_exporter-1.6.1.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>mv node_exporter-*.linux-amd64/node_exporter /usr/bin
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/node_exporter.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=node_exporter service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/node_exporter \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=:9100 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.telemetry-path=/metrics \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--collector.systemd \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--collector.systemd.unit-include=&#34;(sshd|docker|rsyslog|kubelet|kube-proxy).service&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--no-collector.arp \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log.format=json 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable node_exporter --now
</span></span><span style="display:flex;"><span>systemctl status node_exporter
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">app</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tolerations</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#e6db74">&#34;Exists&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">hostPID</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">image</span>: <span style="color:#ae81ff">quay.io/prometheus/node-exporter:v1.6.1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>            - --<span style="color:#ae81ff">path.rootfs=/host</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/host</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">root</span>
</span></span></code></pre></div>
    </div>
</div>

<p>​</p>

  
  





  

 <ul class="nav nav-tabs justify-content-end" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        <strong>添加prometheus配置</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          data-td-tp-persist="静态配置" aria-controls="tabs-01-01" aria-selected="true">
        静态配置
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          data-td-tp-persist="kuernetes_sd_configs" aria-controls="tabs-01-02" aria-selected="false">
        kuernetes_sd_configs
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-body tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">honor_timestamps</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">20s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">9100</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <blockquote>
<p><code>kubeconfig_file</code> 和 <code>api_server</code> 二选其一</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kubeconfig_file</span>: <span style="color:#ae81ff">/root/.kube/config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:9100&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">node-exporter-ca</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://192.168.0.244:6443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 测试改成false也没问题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:9100&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div>
    </div>
</div>

<p><em>由于node_export 返回大量指标，通过prometheus配置文件的collect 收集指定的指标</em></p>
<blockquote>
<p>curl -g -X GET 127.0.0.1:9100/metrics?collect[]=xfs
curl -g -X GET 127.0.0.1:9100/metrics?collect[]=cpu</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">prometheus</span>: <span style="color:#ae81ff">prom-xxx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">node_exporter</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">collect[]</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">cpu</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">meminfo</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">netstat</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">systemd</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">xfs</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">filefd</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">filesystem</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://127.0.0.1:6443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.pem</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/cert.pem</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/cert.key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 测试改成false也没问题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:9100&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div><ol start="2">
<li>
<p>常用指标</p>
<table>
  <thead>
      <tr>
          <th><strong>指标</strong></th>
          <th><strong>释义</strong></th>
          <th><strong>指标类型</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>irate(node_cpu_seconds_total{job=&quot;node_exporter&quot;,cpu=&quot;0&quot;}[5m])</code></td>
          <td>cpu0 每秒使用率</td>
          <td>counter</td>
      </tr>
      <tr>
          <td><code>avg(irate(node_cpu_seconds_total{job=&quot;node_exporter&quot;,cpu=&quot;0&quot;}[5m]))by(mode)</code></td>
          <td>cpu0 平均使用率</td>
          <td></td>
      </tr>
      <tr>
          <td><code>count(node_cpu_seconds_total{mode=&quot;idle&quot;})by(instance)</code></td>
          <td>查询有几个逻辑核心</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_memory_MemTotal_bytes</code></td>
          <td>内存总量</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_memory_Buffers_bytes</code></td>
          <td>buffer</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_memory_Cached_bytes</code></td>
          <td>cache</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_memory_MemFree_bytes</code></td>
          <td>free</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_memory_MemAvailable_bytes</code></td>
          <td>可用内存</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_memory_SUnreclaim_bytes</code></td>
          <td>不可回收slab</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_vmstat_pswpin</code></td>
          <td>磁盘加载到内存的字节数/s</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_vmstat_pswpout</code></td>
          <td>内存换出到磁盘的字节数/s</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_filesystem_size_bytes</code></td>
          <td>mount的文件系统大小</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_filesystem_free_bytes</code></td>
          <td>mount的文件系统空闲</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_systemd_unit_state</code></td>
          <td>systemd管理服务状态</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_uname_info</code></td>
          <td>主机名/os版本的信心</td>
          <td></td>
      </tr>
      <tr>
          <td><code>node_filesystem_readonly</code></td>
          <td>文件系统只读</td>
          <td></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>node_netstat_Tcp_CurrEstab  tcp连接数
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 入栈流量</span>
</span></span><span style="display:flex;"><span>rate<span style="color:#f92672">(</span>node_network_receive_bytes_total<span style="color:#f92672">{</span>device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;eth0&#34;</span><span style="color:#f92672">}[</span>5m<span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 出栈流量</span>
</span></span><span style="display:flex;"><span>rate<span style="color:#f92672">(</span>node_network_transmit_bytes_total<span style="color:#f92672">{</span>device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;eth0&#34;</span><span style="color:#f92672">}[</span>5m<span style="color:#f92672">])</span>
</span></span></code></pre></div></li>
<li>
<p>告警规则</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 1. 运行时间</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. cpu</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 内存</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. 磁盘</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. tcp 连接</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6. 网络流量</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 机器宕机告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeDown</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">up{job=~&#34;node(_|-|)exporter&#34;} == 0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机宕机 ({{ $labels.instance }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 已宕机超过5分钟 (Job: {{ $labels.job }})&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 文件系统只读告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">FilesystemReadOnly</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">node_filesystem_readonly{mountpoint=&#34;/&#34;} == 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机 ({{ $labels.instance }})挂载点 {{ $labels.mountpoint }} 只读&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 挂载点 {{ $labels.mountpoint }} 变为只读超过5分钟 (Job: {{ $labels.job }})&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># CPU使用率告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeCpuUsageHigh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      100 - (
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        avg by(instance) (
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          rate(node_cpu_seconds_total{mode=&#34;idle&#34;}[5m])
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ) * 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ) &gt; 85</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">warning</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机CPU使用率过高 ({{ $labels.instance }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} CPU使用率持续5分钟超过85%（当前值：{{ $value | printf \&#34;%.2f\&#34;}}%）&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 系统负载告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeLoad1High</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_load1 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &gt; on(instance) 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      count by(instance) (node_cpu_seconds_total{mode=&#34;idle&#34;}) * 2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">warning</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机1分钟负载过高 ({{ $labels.instance }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 1分钟负载超过CPU核心数2倍（当前值：{{ $value | printf \&#34;%.2f\&#34;}}）&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeLoad15High</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node_load15 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &gt; on(instance) 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      count by(instance) (node_cpu_seconds_total{mode=&#34;idle&#34;}) * 2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机15分钟负载过高 ({{ $labels.instance }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 15分钟负载持续超过CPU核心数2倍（当前值：{{ $value | printf \&#34;%.2f\&#34;}}）&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 内存使用率告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeMemoryUsageHigh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      (1 - 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        node_memory_MemAvailable_bytes{job=~&#34;node.*exporter&#34;} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        / 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        node_memory_MemTotal_bytes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ) * 100 &gt; 90</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机内存使用率过高 ({{ $labels.instance }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 内存使用率持续5分钟超过90%（当前值：{{ $value | printf \&#34;%.2f\&#34;}}%）&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 磁盘使用率告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeDiskUsageHigh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      (1 - 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        node_filesystem_free_bytes{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          fstype!~&#34;^(tmpfs|rootfs|autofs|devpts|devtmpfs|overlay)$&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          mountpoint!~&#34;^/(boot|run|var/lib/docker).*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        } 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        / 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        node_filesystem_size_bytes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ) * 100 &gt; 85</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">warning</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机磁盘使用率过高 ({{ $labels.instance }}:{{ $labels.mountpoint }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 挂载点 {{ $labels.mountpoint }} 使用率超过85%（当前值：{{ $value | printf \&#34;%.2f\&#34;}}%）&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 磁盘空间预测告警</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">NodeDiskWillFillIn8H</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      predict_linear(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        node_filesystem_free_bytes{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          fstype!~&#34;^(tmpfs|rootfs|autofs|devpts|devtmpfs|overlay)$&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          mountpoint!~&#34;^/(boot|run|var/lib/docker).*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }[6h],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        8*3600
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ) &lt; 0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keep_firing_for</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">warning</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;主机磁盘空间即将耗尽 ({{ $labels.instance }}:{{ $labels.mountpoint }})&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;实例 {{ $labels.instance }} 挂载点 {{ $labels.mountpoint }} 预计8小时内空间将耗尽（当前预测值：{{ $value | printf \&#34;%.2f\&#34;}}）&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 网络流量</span>
</span></span></code></pre></div><ul>
<li>
<p>cpu饱和度</p>
<p>通过1分钟 5分钟 15 分钟的负载展示。一般负载小于cpu 核心数1.5倍</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>node_load1 &gt;on <span style="color:#f92672">(</span>instance<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>count by<span style="color:#f92672">(</span>instance<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>node_cpu_seconds_total<span style="color:#f92672">{</span>mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;idle&#34;</span><span style="color:#f92672">})</span>*1
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>node_load5
</span></span><span style="display:flex;"><span>node_load15
</span></span></code></pre></div></li>
<li>
<p>内存使用率</p>
<blockquote>
<p><font color="#b2b503">[<strong>INFO</strong>]</font></p>
<p>node_memmory_MemeTotal_bytes
node_memmory_MemFress_bytes
node_memmory_Buffers_bytes
node_memmory_Cached_bytes</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>1-<span style="color:#f92672">(</span>node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes<span style="color:#f92672">)</span> &gt;0.85
</span></span></code></pre></div></li>
<li>
<p>内存饱和度,判断内存的繁忙程度</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>磁盘到到内存的  字节数/s
</span></span><span style="display:flex;"><span>node_vmstat_pswpin
</span></span><span style="display:flex;"><span>内存到到磁盘的 字节数/s
</span></span><span style="display:flex;"><span>node_vmstat_pswpout
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rate<span style="color:#f92672">(</span>node_vmstat_pswpout<span style="color:#f92672">[</span>1m<span style="color:#f92672">])</span>+rate<span style="color:#f92672">(</span>node_vmstat_pswpin<span style="color:#f92672">[</span>1m<span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>rate<span style="color:#f92672">(</span>node_vmstat_pswpout<span style="color:#f92672">[</span>1m<span style="color:#f92672">])</span>+rate<span style="color:#f92672">(</span>node_vmstat_pswpin<span style="color:#f92672">[</span>1m<span style="color:#f92672">]))</span>by<span style="color:#f92672">(</span>instance<span style="color:#f92672">)</span> *1024
</span></span></code></pre></div></li>
<li>
<p>磁盘使用率</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>node_filesystem_size_bytes<span style="color:#f92672">{</span>mountpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}</span> <span style="color:#75715e"># 总大小</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>node_filesystem_free_bytes<span style="color:#f92672">{</span>mountpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}</span> <span style="color:#75715e"># 空闲大小</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#使用比例</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>1-<span style="color:#f92672">(</span>node_filesystem_free_bytes<span style="color:#f92672">{</span>mountpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}</span>/node_filesystem_size_bytes<span style="color:#f92672">{</span>mountpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}))</span>&gt;0.85
</span></span></code></pre></div><p>使用predict_linear线性函数预测未来4个小时中磁盘的剩余空间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>predict_linear<span style="color:#f92672">(</span>node_filesystem_free_bytes<span style="color:#f92672">{</span>mountpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}[</span>1h<span style="color:#f92672">]</span>,4*3600<span style="color:#f92672">)</span>&lt;<span style="color:#ae81ff">0</span>
</span></span></code></pre></div></li>
<li>
<p>入栈流量速率</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>irate<span style="color:#f92672">(</span>node_network_receive_bytes_total<span style="color:#f92672">{</span>device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;eth0&#34;</span><span style="color:#f92672">}[</span>5m<span style="color:#f92672">])</span>
</span></span></code></pre></div></li>
<li>
<p>出栈网络速率</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>irate<span style="color:#f92672">(</span>node_network_transmit_bytes_total<span style="color:#f92672">{</span>device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;eth0&#34;</span><span style="color:#f92672">}[</span>5m<span style="color:#f92672">])</span>
</span></span></code></pre></div></li>
<li>
<p>服务异常</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>node_systemd_unit_state<span style="color:#f92672">{</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;docker.service&#34;</span><span style="color:#f92672">}</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div></li>
<li>
<p>bond 文件描述符 sr-iov 监控 tcp</p>
</li>
</ul>
</li>
<li>
<p>附录： 自定义指标</p>
<p>node_exporter 允许用户自定义监控指标，具体方法如下：</p>
<ol>
<li>
<p>修改node_exportrer启动文件,添加如下选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>--collector.textfile <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--collector.textfile.directory<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>在 <code>--collector.textfile.directory=</code> 定义的目录下写入要提供的指标内容，文件以<code>.prom</code> 结尾</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi httpcod.prom
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#输入示例：</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;404&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;put&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;501&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;500&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>method_code:http_errors:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>, code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;404&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>method:http_requests:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>method:http_requests:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;del&#34;</span><span style="color:#f92672">}</span>  <span style="color:#ae81ff">34</span>
</span></span><span style="display:flex;"><span>method:http_requests:rate5m<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">120</span>
</span></span></code></pre></div></li>
<li>
<p>重启node_exporter</p>
</li>
</ol>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d2d65a85ce96b5d2e1c53c6332d4b35d">10.2 - blackbox</h1>
    <div class="lead">blackbox|exporter|prometheus</div>
	<p>blackbox是一个黑盒监控的代表，他通过各种模块来探测监控对象，并将结果返回给prometheus</p>
<ol>
<li>
<p>部署安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.24.0/blackbox_exporter-0.24.0.linux-amd64.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf blackbox_exporter-0.24.0.linux-amd64.tar.gz 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /data/blackbox_exporter/<span style="color:#f92672">{</span>bin,conf<span style="color:#f92672">}</span> -p
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mv blackbox_exporter-*linux-amd64/blackbox_exporter /data/blackbox_exporter/bin/
</span></span><span style="display:flex;"><span>mv blackbox_exporter-*linux-amd64/blackbox.yml /data/blackbox_exporter/conf/
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/blackbox_exporter.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=blackbox_exporter service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/blackbox_exporter/bin/blackbox_exporter \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=:9115 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config.file=/data/blackbox_exporter/conf/blackbox.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>启动blackbox</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable blackbox_exporter --now
</span></span><span style="display:flex;"><span>systemctl status blackbox_exporter 	
</span></span></code></pre></div><p><a href="https://github.com/prometheus/blackbox_exporter/blob/master/example.yml" target="_blank">默认配置</a></p>
<p>功能验证,<code>probe_success  1</code>表示探测成功</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -s  <span style="color:#e6db74">&#34;http://127.0.0.1:9115/probe?module=http_2xx&amp;target=www.baidu.com&#34;</span>|grep probe_success
</span></span><span style="display:flex;"><span><span style="color:#75715e"># probe_success 1</span>
</span></span></code></pre></div></li>
<li>
<p>添加prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;blackbox-http&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/probe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">module</span>: [<span style="color:#ae81ff">http_2xx] </span> <span style="color:#75715e"># 指定模块</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">http://192.168.0.172:9999/magic/web/index.html </span> <span style="color:#75715e"># Target to probe with http.</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">https://sg-web-bjuat.pytech.cn/qc/dash  </span> <span style="color:#75715e"># Target to probe with https.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__param_target</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__param_target]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">instance</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">9115</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;blackbox-icmp&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/probe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">module</span>: [<span style="color:#ae81ff">icmp] </span> <span style="color:#75715e"># 指定模块</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">192.168.0.172</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__param_target</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__param_target]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">instance</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">9115</span>
</span></span></code></pre></div></li>
<li>
<p>常用指标</p>
<table>
  <thead>
      <tr>
          <th>主要指标</th>
          <th>解释</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>probe_dns_lookup_time_seconds </code></td>
          <td>dns解析耗时</td>
          <td></td>
      </tr>
      <tr>
          <td><code>probe_duration_seconds</code></td>
          <td>探测耗时</td>
          <td></td>
      </tr>
      <tr>
          <td><code>probe_http_status_code </code></td>
          <td>解析状态码</td>
          <td>200</td>
      </tr>
      <tr>
          <td><code>probe_success </code></td>
          <td>探测是否成功1成功</td>
          <td></td>
      </tr>
  </tbody>
</table>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f2088b66d721f30cecd45b9172151883">10.3 - jmx_exporter</h1>
    <div class="lead">jmx_exporter|exporter|prometheus</div>
	<ol>
<li>
<p><a href="https://github.com/prometheus/jmx_exporter" target="_blank">部署安装</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 下载地址1： https://github.com/prometheus/jmx_exporter/tree/release-0.20.0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 下载地址2： https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/1.0.1/jmx_prometheus_javaagent-1.0.1.jar
</span></span></code></pre></div><p>配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee javaagent.yaml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- pattern: &#34;.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>以javaagent方式启动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>java -jar -Duser.timezone<span style="color:#f92672">=</span>Asia/Shanghai <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-javaagent:jmx_prometheus_javaagent-1.0.1.jar<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>hostname -i<span style="color:#66d9ef">)</span>:<span style="color:#e6db74">${</span>M_PORT<span style="color:#66d9ef">:-</span><span style="color:#e6db74">&#34;12345&#34;</span><span style="color:#e6db74">}</span>:javaagent.yaml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>&lt;yourjar&gt;
</span></span></code></pre></div></li>
<li>
<p>添加prometheus配置</p>
</li>
<li>
<p>常用指标</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 堆内存使用量</span>
</span></span><span style="display:flex;"><span>jvm_memory_used_bytes<span style="color:#f92672">{</span>area<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;heap&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 堆内存提交量</span>
</span></span><span style="display:flex;"><span>jvm_memory_committed_bytes<span style="color:#f92672">{</span>area<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;heap&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 堆内存最大可用量</span>
</span></span><span style="display:flex;"><span>jvm_memory_max_bytes<span style="color:#f92672">{</span>area<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;heap&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Young GC 触发次数</span>
</span></span><span style="display:flex;"><span>jvm_gc_collection_seconds_count<span style="color:#f92672">{</span>gc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;G1 Young Generation&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  Old GC 总耗时</span>
</span></span><span style="display:flex;"><span>jvm_gc_collection_seconds_sum<span style="color:#f92672">{</span>gc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;G1 Old Generation&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 当前活动线程数</span>
</span></span><span style="display:flex;"><span>jvm_threads_current
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 守护线程数</span>
</span></span><span style="display:flex;"><span>jvm_threads_daemon
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  峰值线程数</span>
</span></span><span style="display:flex;"><span>jvm_threads_peak
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 总加载的类数量</span>
</span></span><span style="display:flex;"><span>jvm_classes_loaded_total
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 总卸载类数量</span>
</span></span><span style="display:flex;"><span>jvm_classes_unloaded_total
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 当前加载类数量</span>
</span></span><span style="display:flex;"><span>jvm_classes_currently_loaded
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5d8b8cd5776ff486cdacaf0443afe506">10.4 - nginx-exporter</h1>
    <div class="lead">nginx-exporter|exporter|prometheus</div>
	<p><a href="https://github.com/nginx/nginx-prometheus-exporter" target="_blank">nginx-exporter</a> 支持对nginx 、nginx plugin(nginx的企业版)、nginx-ingress 暴露符合prometheus格式的指标。该文档只讨论开源版本的nginx的实施方案。</p>
<p>前提条件nginx 需要开启<code>stub_status</code> 指令,样例格式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span> 127.0.0.1:<span style="color:#ae81ff">8080</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/stub_status</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">stub_status</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">access_log</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">allow</span> 127.0.0.1;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>部署安装</strong></p>
<blockquote>
<p>docker 镜像：<code>nginx/nginx-prometheus-exporter:1.4.0</code></p>
<p>二进制文件： <code> https://github.com/nginx/nginx-prometheus-exporter/releases/download/v1.4.0/nginx-prometheus-exporter_1.4.0_linux_amd64.tar.gz</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--net<span style="color:#f92672">=</span>host <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>nginx/nginx-prometheus-exporter:1.4.0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--nginx.scrape-uri<span style="color:#f92672">=</span>http://127.0.0.1:8080/stub_status
</span></span></code></pre></div><p><strong>添加prometheus配置</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">9113</span>
</span></span></code></pre></div><p><strong>常用指标</strong></p>
<table>
  <thead>
      <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Labels</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>nginx_up</code></td>
          <td>Gauge</td>
          <td>Shows the status of the last metric scrape: <code>1</code> for a successful scrape and <code>0</code> for a failed one</td>
          <td>[]</td>
      </tr>
  </tbody>
</table>
<p><a href="https://nginx.org/en/docs/http/ngx_http_stub_status_module.html" target="_blank">Stub status metrics</a></p>
<table>
  <thead>
      <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Labels</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>nginx_connections_accepted</code></td>
          <td>Counter</td>
          <td>接受的客户端连接总数</td>
          <td>[]</td>
      </tr>
      <tr>
          <td><code>nginx_connections_active</code></td>
          <td>Gauge</td>
          <td>活跃的连接数，包括处于等待状态的连接</td>
          <td>[]</td>
      </tr>
      <tr>
          <td><code>nginx_connections_handled</code></td>
          <td>Counter</td>
          <td>Handled client connections.</td>
          <td>[</td>
      </tr>
      <tr>
          <td><code>nginx_connections_reading</code></td>
          <td>Gauge</td>
          <td>nginx 读取的客户端请求头</td>
          <td>[]</td>
      </tr>
      <tr>
          <td><code>nginx_connections_waiting</code></td>
          <td>Gauge</td>
          <td>空闲的连接数</td>
          <td>[]</td>
      </tr>
      <tr>
          <td><code>nginx_connections_writing</code></td>
          <td>Gauge</td>
          <td>nginx 返回给客户端的响应.</td>
          <td>[]</td>
      </tr>
      <tr>
          <td><code>nginx_http_requests_total</code></td>
          <td>Counter</td>
          <td>客户端请求总数</td>
          <td>[]</td>
      </tr>
  </tbody>
</table>
<p>其他第三方方案</p>
<p><a href="https://github.com/knyar/nginx-lua-prometheus" target="_blank">nginx-lua-prometheus</a></p>
<p><a href="https://github.com/vozlt/nginx-module-vts" target="_blank">nginx-module-vts</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y GeoIP-devel.x86_64 pcre-devel openssl-devel 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget http://nginx.org/download/nginx-1.22.1.tar.gz
</span></span><span style="display:flex;"><span>tar xf nginx-1.22.1.tar.gz <span style="color:#f92672">&amp;&amp;</span> cd nginx-1.22.1
</span></span><span style="display:flex;"><span>git clone git://github.com/vozlt/nginx-module-vts.git
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./configure <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--prefix<span style="color:#f92672">=</span>/opt/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_geoip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_stub_status_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream<span style="color:#f92672">=</span>dynamic <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_geoip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--add-module<span style="color:#f92672">=</span>./nginx-module-vts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>make -j <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> make install
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./configure <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--prefix<span style="color:#f92672">=</span>/opt/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_geoip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_stub_status_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_geoip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--add-module<span style="color:#f92672">=</span>./nginx-module-vts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>make -j <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> make install
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./configure <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--prefix<span style="color:#f92672">=</span>/opt/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--sbin-path<span style="color:#f92672">=</span>/usr/bin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--conf-path<span style="color:#f92672">=</span>/etc/nginx/nginx.conf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_geoip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_stub_status_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_geoip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--add-module<span style="color:#f92672">=</span>./nginx-module-vts
</span></span></code></pre></div><p>基本的指标样例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">vhost_traffic_status_zone</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">server</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">location</span> <span style="color:#e6db74">/status</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">vhost_traffic_status_display</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">vhost_traffic_status_display_format</span> <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">access_log</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>统计客户端ip国家信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">geoip_country</span> <span style="color:#e6db74">/usr/share/GeoIP/GeoIP.dat</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">vhost_traffic_status_zone</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">vhost_traffic_status_filter_by_set_key</span> $geoip_country_code <span style="color:#e6db74">country::*</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">server</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">vhost_traffic_status_filter_by_set_key</span> $geoip_country_code <span style="color:#e6db74">country::</span>$server_name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">location</span> <span style="color:#e6db74">/status</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">vhost_traffic_status_display</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">vhost_traffic_status_display_format</span> <span style="color:#e6db74">html</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">nginx-module-vts</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/status/format/prometheus</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">127.0.0.1</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a91649f35c1611e400ba18dd4dfe3c9a">10.5 - minio</h1>
    <div class="lead">minio|exporter|prometheus</div>
	<ol>
<li>
<p>部署安装</p>
<blockquote>
<p>minio自身暴露了prometheus 兼容指标。我们只需要在启动前添加环境变量: <code>MINIO_PROMETHEUS_AUTH_TYPE=&quot;public&quot;</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://dl.min.io/server/minio/release/linux-amd64/minio
</span></span><span style="display:flex;"><span>chmod +x minio
</span></span><span style="display:flex;"><span>sudo mv minio /usr/local/bin/
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee  /etc/systemd/system/minio.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=minio serveice test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/data/minio/conf/minio.env
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/minio/bin/minio server \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/data/minio/data \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--address :9000 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--console-address :9001
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/minio/conf/minio.env<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MINIO_ROOT_USER=admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MINIO_ROOT_PASSWORD=admin12345
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MINIO_PROMETHEUS_AUTH_TYPE=&#34;public&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>添加prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>- job_name: minio
</span></span><span style="display:flex;"><span>  honor_timestamps: true
</span></span><span style="display:flex;"><span>  metrics_path: /minio/v2/metrics/cluster
</span></span><span style="display:flex;"><span>  follow_redirects: true
</span></span><span style="display:flex;"><span>  static_configs:
</span></span><span style="display:flex;"><span>  - targets:
</span></span><span style="display:flex;"><span>    - 10.4.7.251:9000
</span></span></code></pre></div></li>
<li>
<p>常用指标</p>
<p>minio 挂载磁盘的总大小，就是例子中 <code>/data/minio/data</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minio_node_disk_total_bytes
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minio_node_disk_free_bytes
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minio_node_disk_used_bytes
</span></span></code></pre></div><p>查看特定bucket池子的使用量 (gauge)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minio_bucket_usage_total_bytes<span style="color:#f92672">{</span>bucket<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;loki&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minio_bucket_usage_object_total<span style="color:#f92672">{</span>bucket<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;loki&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>对象存储大小分布 (gauge)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minio_bucket_objects_size_distribution
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ab1b654ca9a964046d54e4a76701e2bc">10.6 - redis-exporter</h1>
    <div class="lead">redis-exporter用于导出兼容redis协议的数据库指标给prometheus，例如Valkey和redis</div>
	

<div class="alert alert-warning" role="alert">


    redis-exporter(1.74.0版本) 支持redis 2.x-7.x

</div>

<ol>
<li>
<p><strong><a href="https://github.com/oliver006/redis_exporter" target="_blank">部署安装</a></strong></p>
<blockquote>
<p>容器镜像 <code>quay.io/oliver006/redis_exporter</code></p>
</blockquote>
<p><em>安装exporter</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/oliver006/redis_exporter/releases/download/v1.74.0/redis_exporter-v1.74.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>tar xf redis_exporter-v1.74.0.linux-amd64.tar.gz 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>mv redis_exporter-v1.74.0.linux-amd64/redis_exporter /usr/bin/
</span></span><span style="display:flex;"><span>rm -fr redis_exporter*
</span></span></code></pre></div><p><em>启动服务</em></p>
<blockquote>
<p><code>-is-cluster</code> 监控集群启动参数添加该选项</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/usr/lib/systemd/system/redis_exporter_redis01_6379.service<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description = redis-exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation = https://github.com/oliver006/redis_exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After = network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=Simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/redis_exporter \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-redis.password YSxeEr3e4ZdF \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-redis.addr 10.128.111.66:6379 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-export-client-list \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-include-system-metrics \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-connection-timeout 60s \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-web.listen-address :9121 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-config-command config \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-set-client-name redis_exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Group=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CPUQuota=20%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MemoryLimit=128m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable redis_exporter_redis01_6379 --now 
</span></span><span style="display:flex;"><span>systemctl status redis_exporter_redis01_6379
</span></span></code></pre></div></li>
<li>
<p><strong>添加prometheus配置</strong></p>
<p>指标接口： <code>http://127.0.0.1:9121/metrics</code></p>
<p>类似于blackbox,可以采集其他redis: <code>http://127.0.0.1:9121/scrape?127.0.0.1:6379</code></p>
</li>
<li>
<p><strong>dashboar和告警</strong></p>
<p><strong>进程相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th>判断依据</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_up</code></td>
          <td>进程状态1表示正常</td>
      </tr>
      <tr>
          <td><code>redis_uptime_in_seconds</code></td>
          <td>启动时长</td>
      </tr>
      <tr>
          <td><code>redis_instance_info</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>内存相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_memory_used_bytes</code></td>
          <td>内存使用量</td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_peak_bytes</code></td>
          <td>内存使用峰值</td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_rss_bytes</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_max_bytes</code></td>
          <td>maxmemory</td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_config_maxmemory</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_dataset_bytes</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_lua_bytes</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_scripts_bytes</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_startup_bytes</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_memory_used_overhead_bytes</code></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_allocator_rss_bytes</code></td>
          <td>分配出常驻内存</td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_active_defrag_running </code></td>
          <td>内存碎片整理</td>
          <td>表示没有活动的defrag任务正在运行，1表示有活动的defrag任务正在运行</td>
      </tr>
      <tr>
          <td><code>redis_allocator_frag_ratio</code></td>
          <td>内存碎片比</td>
          <td>used_memory_rss和used_memory之间的比率，小于1表示使用了swap，大于1表示碎片比较多</td>
      </tr>
  </tbody>
</table>
<p><strong>网络流量相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_net_input_bytes_total</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_net_output_bytes_total</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>持久化相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_aof_enabled </code></td>
          <td>是否开启aof持久化</td>
      </tr>
      <tr>
          <td><code>redis_aof_last_cow_size_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_aof_last_rewite_duration_sec</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_aof_last_write_status</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_aof_last_bgrewrite_status</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_aof_rewite_in_progress</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_aof_rewite_shceduled</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_aof_current_rewrite_duration_sec </code></td>
          <td>aof rewrite耗时</td>
      </tr>
  </tbody>
</table>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_rdb_bgsave_in_progress</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rdb_changes_since_last_save</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rdb_current_bgsave_duration_sec</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rdb_last_bgsave_duration_sec</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rdb_last_bgsave_status</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rdb_last_cow_size_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rdb_last_save_timestamp_seconds</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>key相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_db_keys</code></td>
          <td>实例keys数量</td>
      </tr>
      <tr>
          <td><code>redis_db_avg_ttl_seconds</code></td>
          <td>平均过期时长</td>
      </tr>
      <tr>
          <td><code>redis_db_keys_expiring</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_expired_keys_total</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_expired_stale_percentage</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_evicted_keys_total</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_keyspace_hits_total </code></td>
          <td>缓存命中量</td>
      </tr>
      <tr>
          <td><code>redis_keyspace_misses_total </code></td>
          <td>未命中缓存量</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>redis_keyspace_hits_total<span style="color:#f92672">{</span>cluster_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;123&#34;</span><span style="color:#f92672">})</span>/sum<span style="color:#f92672">(</span>redis_keyspace_hits_total<span style="color:#f92672">{</span>cluster_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;123&#34;</span><span style="color:#f92672">})</span>+sum<span style="color:#f92672">(</span>redis_keyspace_misses_total<span style="color:#f92672">{</span>cluster_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;123&#34;</span><span style="color:#f92672">})</span>
</span></span></code></pre></div><p><strong>客户端连接相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_connected_clients</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_connected_slaves</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_config_maxclients</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_rejected_connections_total</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_connections_received_total</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_blocked_clients</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_client_recent_max_input_buffer_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_client_recent_max_output_buffer_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_config_client_output_buffer_limit_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_config_client_output_buffer_limit_overcome_seconds</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>慢日志</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_slowlog_last_id</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_slowlog_length</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>性能</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_last_slow_execution_duration_seconds</code></td>
          <td>最慢的执行耗时</td>
      </tr>
      <tr>
          <td><code>redis_commands_duration_seconds_total</code></td>
          <td>命令出来耗时</td>
      </tr>
      <tr>
          <td><code>redis_commands_processed_total</code></td>
          <td>已处理命令的数量</td>
      </tr>
      <tr>
          <td><code>redis_commands_total</code></td>
          <td>每一个命令调用的次数</td>
      </tr>
  </tbody>
</table>
<p>tps</p>
<p>QPS</p>
<p><strong>主从复制相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>redis_connected_slaves</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_mem_clients_slaves</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_repl_backlog_first_byte_offset</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_repl_backlog_history_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_repl_backlog_is_active</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_replication_backlog_bytes</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_replica_partial_resync_accepted</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_replica_partial_resync_denied</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_replica_resyncs_full</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_master_repl_offset</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>redis_second_repl_offset</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>startMasterSlave<span style="color:#f92672">()</span> <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>docker run -d --net<span style="color:#f92672">=</span>host --name<span style="color:#f92672">=</span>redis6379 redis:6.0.20 redis-server --bind 10.4.7.10 --port <span style="color:#ae81ff">6379</span> --daemonize no
</span></span><span style="display:flex;"><span>docker run -d --net<span style="color:#f92672">=</span>host --name<span style="color:#f92672">=</span>redis6380 redis:6.0.20 redis-server --bind 10.4.7.10 --port <span style="color:#ae81ff">6380</span> --daemonize no  --SLAVEOF 10.4.7.10 <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>docker run -d --net<span style="color:#f92672">=</span>host --name<span style="color:#f92672">=</span>redis6381 redis:6.0.20 redis-server --bind 10.4.7.10 --port <span style="color:#ae81ff">6381</span> --daemonize no  --SLAVEOF 10.4.7.10 <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>startSentinel<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> port in <span style="color:#ae81ff">26379</span> <span style="color:#ae81ff">26380</span> 26381;<span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run -d --net<span style="color:#f92672">=</span>host --name<span style="color:#f92672">=</span>sentinel<span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span> redis:6.0.20 sh -c <span style="color:#e6db74">&#34;echo &#39;sentinel monitor mymaster 10.4.7.10 6379 2\n&#39; &gt;/etc/redis-sentinel.conf;echo &#39;sentinel down-after-milliseconds mymaster 30000\n&#39; &gt;&gt;/etc/redis-sentinel.conf;echo &#39;sentinel parallel-syncs mymaster 1\n&#39; &gt;&gt;/etc/redis-sentinel.conf;echo &#39;sentinel failover-timeout mymaster 180000\n&#39; &gt;&gt;/etc/redis-sentinel.conf; redis-server /etc/redis-sentinel.conf --sentinel --bind 10.4.7.10 --port </span><span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74"> --daemonize no&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stop<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>docker rm -f sentinel26379
</span></span><span style="display:flex;"><span>docker rm -f sentinel26380
</span></span><span style="display:flex;"><span>docker rm -f sentinel26381
</span></span><span style="display:flex;"><span>docker rm -f redis6379
</span></span><span style="display:flex;"><span>docker rm -f redis6380
</span></span><span style="display:flex;"><span>docker rm -f redis6381
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>stop
</span></span><span style="display:flex;"><span>startMasterSlave
</span></span><span style="display:flex;"><span>startSentinel
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@master01:~# docker exec -it sentinel26379 redis-cli -p <span style="color:#ae81ff">26379</span> -h 10.4.7.10 info sentinel
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sentinel</span>
</span></span><span style="display:flex;"><span>sentinel_masters:1
</span></span><span style="display:flex;"><span>sentinel_tilt:0
</span></span><span style="display:flex;"><span>sentinel_running_scripts:0
</span></span><span style="display:flex;"><span>sentinel_scripts_queue_length:0
</span></span><span style="display:flex;"><span>sentinel_simulate_failure_flags:0
</span></span><span style="display:flex;"><span>master0:name<span style="color:#f92672">=</span>mymaster,status<span style="color:#f92672">=</span>ok,address<span style="color:#f92672">=</span>10.4.7.10:6379,slaves<span style="color:#f92672">=</span>2,sentinels<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis_sentinel_master_ckquorum_status
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-31569474fbadc76b9e8fdcd9f370ea84">10.7 - mysql-exporter</h1>
    <div class="lead">mysql-exporter|exporter|prometheus</div>
	

<div class="alert alert-warning" role="alert">


    mysql-exporter(0.17.2版本) 支持mysql&gt;=5.6 、MariaDB &gt;= 10.3

</div>

<ol>
<li>
<p><strong><a href="https://github.com/prometheus/mysqld_exporter" target="_blank">部署安装</a></strong></p>
<blockquote>
<p>容器镜像 <code>prom/mysqld-exporter</code></p>
</blockquote>
<p><em>安装exporter</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.17.2/mysqld_exporter-0.17.2.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>tar xf mysqld_exporter-0.17.2.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>mv mysqld_exporter-0.17.2.linux-amd64/mysqld_exporter /usr/bin/
</span></span><span style="display:flex;"><span>rm -fr mysqld_exporter*
</span></span></code></pre></div><p><em>添加监控用户</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>CREATE USER <span style="color:#e6db74">&#39;exporter&#39;</span>@<span style="color:#e6db74">&#39;%&#39;</span> IDENTIFIED BY <span style="color:#e6db74">&#39;GlKUhymaO76zY&#39;</span> WITH MAX_USER_CONNECTIONS 3;
</span></span><span style="display:flex;"><span>GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO <span style="color:#e6db74">&#39;exporter&#39;</span>@<span style="color:#e6db74">&#39;%&#39;</span>;
</span></span></code></pre></div><p><em>启动服务</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/usr/lib/systemd/system/mysql_exporter_mysql01_3306.service<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description = mysql-exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation = https://github.com/prometheus/mysqld_exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After = network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=Simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;MYSQLD_EXPORTER_PASSWORD=GlKUhymaO76zY&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/mysqld_exporter \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--mysqld.address 10.128.99.158:6301 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--mysqld.username exporter 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Group=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CPUQuota=20%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MemoryLimit=128m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable mysql_exporter_mysql01_3306 --now 
</span></span><span style="display:flex;"><span>systemctl status mysql_exporter_mysql01_3306
</span></span></code></pre></div></li>
<li>
<p><strong>添加prometheus配置</strong></p>
<p>指标接口： <code>http://127.0.0.1:9104/metrics</code></p>
<p>类似于blackbox,可以采集其他redis: <code>http://127.0.0.1:9104/probe?127.0.0.1:3306</code></p>
</li>
<li>
<p><strong>dashboar和告警</strong></p>
<p><strong>进程相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th>判断依据</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>mysql_up</code></td>
          <td>进程状态1表示正常</td>
      </tr>
      <tr>
          <td><code>mysql_uptime_in_seconds</code></td>
          <td>启动时长</td>
      </tr>
      <tr>
          <td><code>mysql_instance_info</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>内存相关</strong></p>
<p><strong>网络流量相关</strong></p>
<p><strong>持久化相关</strong></p>
<p><strong>客户端连接相关</strong></p>
<p><strong>慢日志</strong></p>
<p><strong>性能</strong></p>
<p>tps</p>
<p>QPS</p>
<p><strong>主从复制相关</strong></p>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b668d0cb90e19dfdc045d5bb7bc1a106">10.8 - mongo-exporter</h1>
    <div class="lead">mongo-exporter|exporter|prometheus</div>
	

<div class="alert alert-warning" role="alert">


    mysql-exporter(0.40版本) 支持mongodb&gt;=4.4

</div>

<ol>
<li>
<p><strong><a href="https://github.com/percona/mongodb_exporter" target="_blank">部署安装</a></strong></p>
<blockquote>
<p>容器镜像 <code>percona/mongodb_exporter:0.40</code></p>
</blockquote>
<p><em>安装exporter</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"></code></pre></div><p><em>添加监控用户</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"></code></pre></div><p><em>启动服务</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;/usr/lib/systemd/system/mysql_exporter_mysql01_3306.service<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description = mysql-exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation = https://github.com/prometheus/mysqld_exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After = network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=Simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;MYSQLD_EXPORTER_PASSWORD=GlKUhymaO76zY&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/mysqld_exporter \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--mysqld.address 10.128.99.158:6301 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--mysqld.username exporter 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Group=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CPUQuota=20%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MemoryLimit=128m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable mysql_exporter_mysql01_3306 --now 
</span></span><span style="display:flex;"><span>systemctl status mysql_exporter_mysql01_3306
</span></span></code></pre></div></li>
<li>
<p><strong>添加prometheus配置</strong></p>
<p>指标接口： <code>http://127.0.0.1:9104/metrics</code></p>
<p>类似于blackbox,可以采集其他redis: <code>http://127.0.0.1:9104/probe?127.0.0.1:3306</code></p>
</li>
<li>
<p><strong>dashboar和告警</strong></p>
<p><strong>进程相关</strong></p>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th>判断依据</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>mysql_up</code></td>
          <td>进程状态1表示正常</td>
      </tr>
      <tr>
          <td><code>mysql_uptime_in_seconds</code></td>
          <td>启动时长</td>
      </tr>
      <tr>
          <td><code>mysql_instance_info</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>内存相关</strong></p>
<p><strong>网络流量相关</strong></p>
<p><strong>持久化相关</strong></p>
<p><strong>客户端连接相关</strong></p>
<p><strong>慢日志</strong></p>
<p><strong>性能</strong></p>
<p>tps</p>
<p>QPS</p>
<p><strong>主从复制相关</strong></p>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-12149c930cfe1dac8487f4da8d8be7d2">10.9 - prometheus-sdk</h1>
    <div class="lead">prometheus-sdk|exporter|prometheus</div>
	<p>promethues 为用户提供了自定义开发exporter的<a href="https://prometheus.io/docs/instrumenting/clientlibs/" target="_blank">sdk</a>, 支持大多数常见语言。</p>

  
  

<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>sdk</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="python" aria-controls="tabs-00-01" aria-selected="true">
        python
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="golang" aria-controls="tabs-00-02" aria-selected="false">
        golang
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> http.server
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> prometheus_client <span style="color:#f92672">import</span> start_http_server
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> prometheus_client <span style="color:#f92672">import</span> Counter  <span style="color:#75715e">#从prometheus_client 库导入 Counter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>REQUESTS <span style="color:#f92672">=</span> Counter(<span style="color:#e6db74">&#39;hello_worlds_total&#39;</span>,<span style="color:#e6db74">&#39;Hello Worlds requested.&#39;</span>) <span style="color:#75715e"># 定义`hello_worlds_total` 指标，帮助信息为&#39;Hello Worlds requested.&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyHandler</span>(http<span style="color:#f92672">.</span>server<span style="color:#f92672">.</span>BaseHTTPRequestHandler):
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_GET</span>(self):
</span></span><span style="display:flex;"><span>         REQUESTS<span style="color:#f92672">.</span>inc()  <span style="color:#75715e"># 请求后自动+1</span>
</span></span><span style="display:flex;"><span>         self<span style="color:#f92672">.</span>send_response(<span style="color:#ae81ff">200</span>)
</span></span><span style="display:flex;"><span>         self<span style="color:#f92672">.</span>end_headers()
</span></span><span style="display:flex;"><span>         self<span style="color:#f92672">.</span>wfile<span style="color:#f92672">.</span>write(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello World&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>   start_http_server(<span style="color:#ae81ff">8000</span>)
</span></span><span style="display:flex;"><span>   server <span style="color:#f92672">=</span> http<span style="color:#f92672">.</span>server<span style="color:#f92672">.</span>HTTPServer((<span style="color:#e6db74">&#39;localhost&#39;</span>, <span style="color:#ae81ff">8001</span>), MyHandler)
</span></span><span style="display:flex;"><span>   server<span style="color:#f92672">.</span>serve_forever()
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/prometheus/client_golang/prometheus&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/prometheus/client_golang/prometheus/promhttp&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;app&#34;</span>: <span style="color:#e6db74">&#34;ping&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;env&#34;</span>: <span style="color:#e6db74">&#34;pro&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pingCounter</span> = <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">NewCounter</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">CounterOpts</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Namespace</span>:   <span style="color:#e6db74">&#34;pay&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Subsystem</span>:   <span style="color:#e6db74">&#34;wechart&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Name</span>:        <span style="color:#e6db74">&#34;ping_request_count&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Help</span>:        <span style="color:#e6db74">&#34;No of request handled by Ping handler&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ConstLabels</span>: <span style="color:#a6e22e">l</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pingGuage</span> = <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">NewGauge</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">GaugeOpts</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Namespace</span>:   <span style="color:#e6db74">&#34;pay&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Subsystem</span>:   <span style="color:#e6db74">&#34;wechart&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Name</span>:        <span style="color:#e6db74">&#34;ping_request_gauge&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Help</span>:        <span style="color:#e6db74">&#34;No of request handled by Ping handler&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ConstLabels</span>: <span style="color:#a6e22e">l</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//http.HandleFunc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/ping&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">pingCounter</span>.<span style="color:#a6e22e">Inc</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">pingGuage</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#ae81ff">2.2</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprint</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;pong&#34;</span>)
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 注册metrics</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">MustRegister</span>(<span style="color:#a6e22e">pingCounter</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">MustRegister</span>(<span style="color:#a6e22e">pingGuage</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#e6db74">&#34;/metrics&#34;</span>, <span style="color:#a6e22e">promhttp</span>.<span style="color:#a6e22e">Handler</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//启动服务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:9998&#34;</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
</div>


</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b0b1ba15faa9a6ebeb9137c6c9e73f6a">11 - alertmanager</h1>
    
	<h3 id="告警规划">告警规划</h3>
<blockquote>
<p>要求：准确，及时，告警信息明确, 告警频率合理</p>
</blockquote>
<ul>
<li>
<p>漏报误报 ==》</p>
<ol>
<li>promethues 告警规则和评估周期</li>
</ol>
</li>
<li>
<p>针对通知信息不足，接收告警人员无法通过告警信息判断出当前出现的问题</p>
<ol>
<li>
<p>调整告警模版</p>
</li>
<li>
<p>通过开发脚本程序拦截告警添加更多标签，告警中新增富文本例如走势图</p>
</li>
</ol>
</li>
<li>
<p>告警滋扰 ==》</p>
<ol>
<li>通过分组，让同类告警分批次发出</li>
<li>路由，按照需要接收告警的人收告警
<ul>
<li>按照业务</li>
<li>按照故障等级</li>
</ul>
</li>
<li>抑制手段</li>
</ol>
</li>
</ul>
<p>alertmanger 负责管理告警的静默、抑制、聚合和发送告警，常见告警等级和处理时效。</p>
<table>
  <thead>
      <tr>
          <th>等级</th>
          <th>阿里</th>
          <th>腾讯</th>
          <th>先知</th>
          <th>海鸥</th>
          <th>定义方式</th>
          <th>认领（接手）时间</th>
          <th>解决（关闭）时间</th>
          <th>通知渠道</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>P1</td>
          <td>严重</td>
          <td>致命</td>
          <td>事故</td>
          <td>致命</td>
          <td>需要立即联系管理团队的关键性问题</td>
          <td>1min</td>
          <td>10min</td>
          <td>电话+短信+IM通知（钉钉等）配合升级策略确保问题在规定时间内处理</td>
      </tr>
      <tr>
          <td>P2</td>
          <td>警告</td>
          <td>严重</td>
          <td>故障</td>
          <td>严重</td>
          <td>严重影响许多客户使用产品的能力的关键性系统问题</td>
          <td>10min</td>
          <td>1h</td>
          <td>短信+IM通知（钉钉等）配合升级策略确保问题在规定时间内处理</td>
      </tr>
      <tr>
          <td>P3</td>
          <td>优化</td>
          <td>警告</td>
          <td>告警</td>
          <td>警告</td>
          <td>需要运维人员立即关注的稳定性问题或影响客户的小问题</td>
          <td>1h</td>
          <td>24h</td>
          <td>短信+IM通知（钉钉等）</td>
      </tr>
      <tr>
          <td>P4</td>
          <td>通知</td>
          <td>提示</td>
          <td>信息</td>
          <td>通知</td>
          <td>需要采取行动的小问题，但不影响客户使用产品</td>
          <td>24h</td>
          <td>7Day</td>
          <td>IM通知（钉钉等）</td>
      </tr>
  </tbody>
</table>
<h3 id="架构图">架构图</h3>
<p><img src="/docs/prometheus/alertmanager/img/%E5%91%8A%E8%AD%A6.png" alt="告警"></p>
<p><a href="https://www.cnblogs.com/fan-gx/p/12321351.html" target="_blank">curl</a></p>
<p><a href="https://blog.csdn.net/qq_43684922/article/details/126803822" target="_blank">【博客484】alertmanager&mdash;&ndash;告警处理源码剖析_alertmanager 重复告警_lulu的云原生笔记的博客-CSDN博客</a></p>
<p><a href="https://blog.51cto.com/starsliao/5763175" target="_blank">Alertmanager—配置详解(记得看完)_StarsL的技术博客_51CTO博客</a></p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cdd3077d065775a419d9597d5a6c38ba">11.1 - 部署alertmanager</h1>
    <div class="lead">install|alertmanager|prometheus</div>
	<h3 id="二进制安装">二进制安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /data/alertmanager/<span style="color:#f92672">{</span>bin,conf/templates,data<span style="color:#f92672">}</span> -p
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf alertmanager-0.26.0.linux-amd64.tar.gz 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mv alertmanager-*.linux-amd64/alertmanager /data/alertmanager/bin/
</span></span><span style="display:flex;"><span>mv alertmanager-*.linux-amd64/amtool /data/alertmanager/bin/
</span></span><span style="display:flex;"><span>mv alertmanager-*.linux-amd64/alertmanager.yml /data/alertmanager/conf/
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown -R prometheus:prometheus /data/alertmanager
</span></span></code></pre></div><blockquote>
<p>如果需要使用反向代理时启动参数新增： <code>--web.external-url=&quot;http://127.0.0.1:9003/alert&quot;</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/alertmanager.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=alertmanager service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStartPre=/data/alertmanager/bin/amtool check-config /data/alertmanager/conf/alertmanager.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/alertmanager/bin/alertmanager \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --config.file=/data/alertmanager/conf/alertmanager.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --storage.path=/data/alertmanager/data \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --data.retention=120h \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    --web.external-url=http://prometheus.pytc.com/alert
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable alertmanager --now
</span></span><span style="display:flex;"><span>systemctl status alertmanager
</span></span></code></pre></div><p>prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">alerting</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">alertmanagers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">9093</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path_prefix</span>: <span style="color:#ae81ff">/alert</span>
</span></span></code></pre></div><h4 id="告警接收器"><a href="https://prometheus.io/docs/alerting/latest/configuration/#receiver" target="_blank">告警接收器</a></h4>
<ul>
<li>
<p><input checked="" disabled="" type="checkbox"> webhook</p>
<blockquote>
<p>通过webhook 接收后可以放入数据库、消息队列等.</p>
</blockquote>
<ol>
<li>
<p>创建alertmanager配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee  /data/alertmanager/conf/alertmanager.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">route:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  receiver: &#39;webhook&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_by: [&#39;alertname&#39;,&#39;cluster&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_wait: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_interval: 5m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">receivers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;webhook&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - url: &#39;http://127.0.0.1:5001/&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>编写一个webhook接收告警

    
    
    
  <ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          aria-controls="tabs-00-00" aria-selected="false">
        <strong>webhook</strong>:
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="python" aria-controls="tabs-00-01" aria-selected="true">
        python
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="golang" aria-controls="tabs-00-02" aria-selected="false">
        golang
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        
    </div>
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <pre><code>tee app.py&lt;&lt;EOF

import json
 
from flask import Flask, request, jsonify
# import smtplib 
 
app = Flask(__name__)
 
@app.route('/', methods=['POST'])
def alert_webhook():
    # 获取post 请求传递是所有信息
    data=request.get_data()
    print(json.loads(data))
    return jsonify({'status': 'ok'})
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5001, debug=True)
EOF

python3 app.py
</code></pre>

    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <pre><code>  package main

  import (
    &quot;fmt&quot;
    &quot;io&quot;
    &quot;net/http&quot;
  )

  func handlePostRequest(w http.ResponseWriter, r *http.Request) {

    body, _ := io.ReadAll(r.Body)
    defer r.Body.Close()

    fmt.Println(string(body))
    //fmt.Fprint(w, &quot;POST request received&quot;)
  }

  func main() {
    http.HandleFunc(&quot;/&quot;, handlePostRequest)
    http.ListenAndServe(&quot;:5001&quot;, nil)
  }
</code></pre>

    </div>
</div>
</p>
</li>
<li>
<p>触发一条告警</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;[
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;labels&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;alertname&#34;: &#34;cpuHigh&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;instance&#34;: &#34;node01:9100&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;job&#34;: &#34;node_exporter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;severity&#34;: &#34;warning&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;annotations&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;description&#34;: &#34;node01:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 89.99%)&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;summary&#34;: &#34;Instance node01:9100 cpu usage more than 85%&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;generatorURL&#34;: &#34;http://prometheus.pytc.com/prom&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]&#39;</span> <span style="color:#e6db74">&#34;http://127.0.0.1:9093/alert/api/v2/alerts&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>alertmanager 接收到了一条告警信息</p>
<p><img src="/docs/prometheus/alertmanager/img/alertmanager01.png" alt="alertmanager01.png"></p>
</li>
<li>
<p>webhook接收到告警信息</p>
<blockquote>
<p><font color=#faf>[Warning]</font></p>
<p>细心的朋友发现<code>generatorurl</code> 和 <code>externalurl</code> 显示异常，可以通过修改启动命令调整。对于运行在容器中尤为有用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./prometheus --config.file<span style="color:#f92672">=</span>prometheus.yml --web.external-url<span style="color:#f92672">=</span>http://x.x.x.x:9090
</span></span><span style="display:flex;"><span>./alertmanager --config.file<span style="color:#f92672">=</span>alertmanager.yml --web.external-url<span style="color:#f92672">=</span>http://x.x.x.x:9093
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;receiver&#34;</span>: <span style="color:#e6db74">&#34;webhook&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;firing&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;alerts&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;firing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;labels&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;alertname&#34;</span>: <span style="color:#e6db74">&#34;cpuHigh&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;instance&#34;</span>: <span style="color:#e6db74">&#34;node01:9100&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;job&#34;</span>: <span style="color:#e6db74">&#34;node_exporter&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;severity&#34;</span>: <span style="color:#e6db74">&#34;warning&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;annotations&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;node01:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 89.99%)&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;summary&#34;</span>: <span style="color:#e6db74">&#34;Instance node01:9100 cpu usage more than 85%&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;startsAt&#34;</span>: <span style="color:#e6db74">&#34;2025-01-12T16:04:33.208058295+08:00&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;endsAt&#34;</span>: <span style="color:#e6db74">&#34;0001-01-01T00:00:00Z&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;generatorURL&#34;</span>: <span style="color:#e6db74">&#34;http://127.0.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;fingerprint&#34;</span>: <span style="color:#e6db74">&#34;d2a2fb28d1488138&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;groupLabels&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;alertname&#34;</span>: <span style="color:#e6db74">&#34;cpuHigh&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;commonLabels&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;alertname&#34;</span>: <span style="color:#e6db74">&#34;cpuHigh&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;instance&#34;</span>: <span style="color:#e6db74">&#34;node01:9100&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;job&#34;</span>: <span style="color:#e6db74">&#34;node_exporter&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;severity&#34;</span>: <span style="color:#e6db74">&#34;warning&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;commonAnnotations&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;node01:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 89.99%)&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;summary&#34;</span>: <span style="color:#e6db74">&#34;Instance node01:9100 cpu usage more than 85%&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;externalURL&#34;</span>: <span style="color:#e6db74">&#34;http://:9093/alert&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#e6db74">&#34;4&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;groupKey&#34;</span>: <span style="color:#e6db74">&#34;{}:{alertname=\&#34;cpuHigh\&#34;}&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;truncatedAlerts&#34;</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
</li>
<li>
<p><input checked="" disabled="" type="checkbox"> <a href="https://prometheus.io/docs/alerting/latest/configuration/#email_config" target="_blank">email</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/alertmanager/conf/alertmanager.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 全局定义
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # The smarthost 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_smarthost: &#39;smtp.qq.com:465&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # from who send email
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_from: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_auth_username: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_auth_password: &#39;kqaexaxpbrbdbajd&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  #
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_require_tls: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 告警媒介  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">receivers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;email&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  email_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - to: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    send_resolved: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;webhook&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - url: &#39;http://192.168.0.20:5001/&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 告警路由  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">route:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 根路由，任何子路由不能匹配的路由都会发送到根路由
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  receiver: &#39;email&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_by: [&#39;alertname&#39;,&#39;cluster&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_wait: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_interval: 5m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  routes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - receiver: &#39;webhook&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - alertname=~&#34;disk*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 告警模版 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">templates:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- &#39;/data/alertmanager/conf/templates/*.tmpl&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>告警模版支持html格式的渲染</p>
<ul>
<li>
<p>格式示例一：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/alertmanager/conf/templates/email.tmpl <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ define &#34;email.default.html&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ range .Alerts }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ if  eq .Status &#34;firing&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;span style=&#34;background-color:red&#34;&gt;[{{.Status}}]&lt;/span&gt;| {{ .Annotations.summary }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警级别: {{ .Labels.severity }} 级&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警名称: {{ .Labels.alertname }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警主机: {{ .Labels.instance }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警详情: {{ .Annotations.description }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        触发时间: {{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ else if eq .Status &#34;resolved&#34;  }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;span style=&#34;background-color:green&#34;&gt;[{{.Status}}]&lt;/span&gt;  {{ .Annotations.summary }} 已恢复正常&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警级别: {{ .Labels.severity }} 级&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警名称: {{ .Labels.alertname }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警主机: {{ .Labels.instance }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        告警详情: {{ .Annotations.description }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        恢复时间: {{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }} &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>模版效果</p>
<p><img src="/docs/prometheus/alertmanager/img/email01.png" alt="email01.png"></p>
<p><img src="/docs/prometheus/alertmanager/img/email02.png" alt="email02.png"></p>
</li>
<li>
<p>格式示例二：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/alertmanager/conf/templates/email.tmpl <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ define &#34;email.default.html&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;table border=1&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;告警来源&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;告警级别&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;告警名称&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;告警主机&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;告警主题&lt;/th&gt;   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;告警详情&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;th&gt;触发时间&lt;/th&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ range .Alerts }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;tr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;prometheus_alert&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;{{ .Labels.severity }}&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;{{ .Labels.alertname }} &lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;{{ .Labels.instance }}&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;{{ .Annotations.summary }}&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;{{ .Annotations.description }}&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;td&gt;{{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }}&lt;/td&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;/tr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/table&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>模版效果</p>
<p><img src="/docs/prometheus/alertmanager/img/email03.png" alt="email03"></p>
<p><img src="/docs/prometheus/alertmanager/img/email04.png" alt="email04.png"></p>
</li>
</ul>
</li>
<li>
<p><input checked="" disabled="" type="checkbox"> <a href="https://prometheus.io/docs/alerting/latest/configuration/#wechat_config" target="_blank">wechart</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/alertmanager/conf/alertmanager.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # The smarthost 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_smarthost: &#39;smtp.qq.com:465&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # from who send email
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_from: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_auth_username: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_auth_password: &#39;kqaexaxpbrbdbajd&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  #
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_require_tls: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">route:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  receiver: &#39;wechat&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_by: [&#39;alertname&#39;,&#39;cluster&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_wait: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_interval: 5m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">receivers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;email&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  email_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - to: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    send_resolved: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;wechat&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  wechat_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 企业ID。我的企业--企业信息中查看
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - corp_id: &#39;wwa5d04854e39e7784&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 应用ID。应用管理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    agent_id: &#39;1000002&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 应用secret。应用管理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    api_secret: &#39;Rc8nQbF8EiCvO1JP19S9vceTI4LJaNt-j-H1pCBba2U&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 发送给谁
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    to_user: &#34;@all&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 发送给哪个部门。部门ID， 在通讯录中查看
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    to_party: &#39;2&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">templates:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- &#39;/data/alertmanager/conf/templates/*.tmpl&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/alertmanager/conf/templates/wechat.tmpl <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ define &#34;wechat.default.message&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">状态: {{ .Status }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ range .Alerts }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">==============监控报警==============
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警程序: prometheus_alert
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警级别: {{ .Labels.severity }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警名称: {{ .Labels.alertname }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警主机: {{ .Labels.instance }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警主题: {{ .Annotations.summary }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警详情: {{ .Annotations.description }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">触发事件: {{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p><input checked="" disabled="" type="checkbox"> dingtalk</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/alertmanager/conf/alertmanager.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # The smarthost 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_smarthost: &#39;smtp.qq.com:465&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # from who send email
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_from: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_auth_username: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_auth_password: &#39;kqaexaxpbrbdbajd&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  #
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  smtp_require_tls: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">route:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  receiver: &#39;dingtalk&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_by: [&#39;alertname&#39;,&#39;cluster&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_wait: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  group_interval: 5m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">receivers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;email&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  email_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - to: &#39;810654947@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    send_resolved: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;wechat&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  wechat_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 企业ID。我的企业--企业信息中查看
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - corp_id: &#39;wwa5d04854e39e7784&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 应用ID。应用管理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    agent_id: &#39;1000002&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 应用secret。应用管理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    api_secret: &#39;Rc8nQbF8EiCvO1JP19S9vceTI4LJaNt-j-H1pCBba2U&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 发送给谁
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    to_user: &#34;@all&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 发送给哪个部门。部门ID， 在通讯录中查看
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    to_party: &#39;2&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: &#39;dingtalk&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - url: &#39;http://127.0.0.1:8060/dingtalk/webhook1/send&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">templates:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- &#39;/data/alertmanager/conf/templates/*.tmpl&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>安装钉钉webhook</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/timonwong/prometheus-webhook-dingtalk/main/web/ui/react-app/src/pages/PlaygroundDemoAlert.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 测试prometheus-webhook-dingtalk 是否可以使用</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master prometheus<span style="color:#f92672">]</span><span style="color:#75715e"># curl -X POST -d&#39;@PlaygroundDemoAlert.json&#39; http://10.4.7.10:8060/dingtalk/webhook1/send </span>
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /data/dingtalk/<span style="color:#f92672">{</span>bin,conf,conf/templates<span style="color:#f92672">}</span> -p
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/dingtalk/conf/config.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">templates:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- &#34;/prometheus-webhook-dingtalk/templates/*.tmpl&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targets:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook1:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url: https://oapi.dingtalk.com/robot/send?access_token=2a8703f74d0960dd8effc6b846c7473520363e4c171fbdfa044b586df3e29be0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # secret for signature
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    secret: SEC2475a4ecdfae996614c6310b18bf948ce95b4c5df306cf75b2842b7a061bba43
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    message:  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      text: &#39;{{ template &#34;ding.link.content&#34; . }}&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/dingtalk/bin/start.sh <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker rm -f dingtalk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker run --name dingtalk -d \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--restart=always \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-p8060:8060 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-v /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-v /data/dingtalk/conf/config.yml:/prometheus-webhook-dingtalk/config.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-v /data/dingtalk/conf/templates:/prometheus-webhook-dingtalk/templates \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">timonwong/prometheus-webhook-dingtalk:v2.0.0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config.file=/prometheus-webhook-dingtalk/config.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.enable-ui \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.enable-lifecycle \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log.level=debug
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http://192.168.0.161:8060/ui
</span></span></code></pre></div><p>格式示例一：</p>
<blockquote>
<p>修改后重启webhook</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/dingtalk/conf/templates/dingtalk.tmpl <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ define &#34;ding.link.content&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">状态: {{ .Status }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ range .Alerts }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">==============监控报警==============
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警程序: prometheus_alert
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警级别: {{ .Labels.severity }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警名称: {{ .Labels.alertname }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警主机: {{ .Labels.instance }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警主题: {{ .Annotations.summary }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">告警详情: {{ .Annotations.description }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">触发事件: {{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>格式示例二：</p>
<blockquote>
<p>修改后重启webhook</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/dingtalk/conf/templates/dingtalk.tmpl <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ define &#34;ding.link.content&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">状态: {{ .Status }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ range .Alerts }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">==============监控报警==============
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  | 告警程序         | 告警级别               | 告警名称                | 告警主机               | 告警主题                   | 告警详情                       | 告警时间                                     |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  | ---------------- | ---------------------- | ----------------------- | ---------------------- | -------------------------- | ------------------------------ | -------------------------------------------- |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  | prometheus_alert | {{ .Labels.severity }} | {{ .Labels.alertname }} | {{ .Labels.instance }} | {{ .Annotations.summary }} | {{ .Annotations.description }} | {{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }} |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>格式示例三：</p>
<blockquote>
<p>修改后重启webhook</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /data/dingtalk/conf/templates/dingtalk.tmpl <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ define &#34;ding.link.content&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">![](https://img1.baidu.com/it/u=1546227440,2897989905&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=889&amp;h=500)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ range .Alerts }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 【{{ .Status }}】
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&gt;【告警主题】&lt;br&gt; {{ .Annotations.summary }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&gt;【告警描述】&lt;br&gt; {{ .Annotations.description }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&gt;【触发时间】{{ .StartsAt.Format &#34;2006-01-02 15:04:05&#34; }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[查看详情](http://baidu.com)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p><img src="/docs/prometheus/alertmanager/img/dingtalk.png" alt="dingtalk"></p>
</li>
<li>
<p><input disabled="" type="checkbox"> message</p>
</li>
</ul>
<h3 id="高可用">高可用</h3>
<blockquote>
<p>集群间通过 gossip协议 管理成员和检测成员故障，集群成员默认通过<code>9094</code> 通讯，客户端通过<code>9093</code> 与alertmanager 通讯。</p>
<p>集群成员间并不存在主节点，所有节点对等，<code>alertmanager.yml</code> 配置文件内容相同，即使是3个节点的集群中2个成员都宕机也不影响功能</p>
</blockquote>
<p><strong>节点1：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/alertmanager.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=alertmanager service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStartPre=/data/alertmanager/bin/amtool check-config /data/alertmanager/conf/alertmanager.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/alertmanager/bin/alertmanager \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config.file=/data/alertmanager/conf/alertmanager.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--storage.path=&#34;/data/alertmanager/data&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--data.retention=120h \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=&#34;:9093&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.listen-address=&#34;0.0.0.0:9094&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.251:9094 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.252:9094 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.253:9094
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p><strong>节点2：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/alertmanager.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=alertmanager service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStartPre=/data/alertmanager/bin/amtool check-config /data/alertmanager/conf/alertmanager.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/alertmanager/bin/alertmanager \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config.file=/data/alertmanager/conf/alertmanager.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--storage.path=&#34;/data/alertmanager/data&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--data.retention=120h \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=&#34;:9093&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.listen-address=&#34;0.0.0.0:9094&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.251:9094 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.252:9094 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.253:9094
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p><strong>节点3：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/alertmanager.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=alertmanager service https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStartPre=/data/alertmanager/bin/amtool check-config /data/alertmanager/conf/alertmanager.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/data/alertmanager/bin/alertmanager \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config.file=/data/alertmanager/conf/alertmanager.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--storage.path=&#34;/data/alertmanager/data&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--data.retention=120h \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--web.listen-address=&#34;:9093&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.listen-address=&#34;0.0.0.0:9094&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.251:9094 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.252:9094 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster.peer 10.4.7.253:9094
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h3 id="部署在k8s环境">部署在k8s环境</h3>
<blockquote>
<p><a href="https://github.com/turnbullpress/prometheusbook-code/blob/master/12-13/alertmanager.yml" target="_blank">https://github.com/turnbullpress/prometheusbook-code/blob/master/12-13/alertmanager.yml</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager-webui</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">monitoring</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/scrape</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/port</span>: <span style="color:#e6db74">&#34;9093&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">external-dns.alpha.kubernetes.io/hostname</span>: <span style="color:#ae81ff">alertmanager.quicknuke.com.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9093</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">monitoring</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9093</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">monitoring</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">component</span>: <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">quay.io/prometheus/alertmanager:master</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#34;sh&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#34;-c&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/bin/alertmanager</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">config.file=/etc/alertmanager/config.yml</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">web.listen-address=0.0.0.0:9093</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">cluster.listen-address=0.0.0.0:8001</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">storage.path=/alertmanager</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">cluster.peer=&#34;alertmanager-0.alertmanager.monitoring.svc:8001&#34;</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">cluster.peer=&#34;alertmanager-1.alertmanager.monitoring.svc:8001&#34;</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">cluster.peer=&#34;alertmanager-2.alertmanager.monitoring.svc:8001&#34;</span>
</span></span><span style="display:flex;"><span>            --<span style="color:#ae81ff">log.level=debug</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">9093</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">web</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8001</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/api/v1/status</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">web</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/api/v1/status</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">web</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager-config-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/alertmanager/</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager-data-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/alertmanager/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager-config-volume</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMap</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager-server-conf</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager-data-volume</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">emptyDir</span>: {}
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-24c9374cc0495f3c971a09cf688a7112">11.2 - 配置alertmanager</h1>
    <div class="lead">config|alertmanager|prometheus</div>
	<h3 id="配置文件">配置文件</h3>
<p>alertmanager配置文件默认为 alertmanger.yaml主要包含5个顶级字段</p>
<pre class="mermaid">graph LR
A[alertmanager.yml]
B[&lt;a href=#global&gt;global&lt;/a&gt;]
C[&lt;a href=#route&gt;route&lt;/a&gt;]
D[&lt;a href=#receivers&gt;receivers&lt;/a&gt;]
E[&lt;a href=#template&gt;template&lt;/a&gt;]
F[&lt;a href=#inhibit_rules&gt;inhibit_rules&lt;/a&gt;]
A --&gt; B
A --&gt; C
A --&gt; D
A --&gt; E
A --&gt; F</pre>
<p><span id="global"><strong>global</strong></span></p>
<p>我们可以像这样什么都不定义</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The smarthost </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">smtp_smarthost</span>: <span style="color:#e6db74">&#39;smtp.qq.com:465&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># from who send email</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">smtp_from</span>: <span style="color:#e6db74">&#39;810654947@qq.com&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">smtp_auth_username</span>: <span style="color:#e6db74">&#39;810654947@qq.com&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">smtp_auth_password</span>: <span style="color:#e6db74">&#39;kqaexaxpbrbdbajd&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">smtp_require_tls</span>: <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p><span id="route"><a href="https://prometheus.io/docs/alerting/latest/configuration/#route" target="_blank"><strong>route</strong></a></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">route</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">receiver</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 通过报警规则中的label 来聚合报警</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group_by</span>: [<span style="color:#e6db74">&#39;alertname&#39;</span>,<span style="color:#e6db74">&#39;cluster&#39;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># When a new group of alerts is created, wait at</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># least &#39;group_wait&#39; to send the initial notification.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group_wait</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 在同一个分组中。第一个报警发出后,等待`group_interval`才会发下一个警报</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># If an alert has successfully been sent, wait &#39;repeat_interval&#39; to</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># resend them</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">repeat_interval</span>: <span style="color:#ae81ff">3h</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># match 和 match_re 在v1.0版本已经弃用</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">match</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[ &lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;labelvalue&gt;, ... ]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 使用正则匹配标签</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">match_re</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[ &lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;regex&gt;, ... ]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 子路由模块，拥有更高优先级</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">receiver</span>: <span style="color:#e6db74">&#39;database-pager&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group_wait</span>: <span style="color:#ae81ff">10s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">service=~&#34;mysql|cassandra&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">receiver</span>: <span style="color:#e6db74">&#39;frontend-pager&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group_by</span>: [<span style="color:#ae81ff">product, environment]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">team=&#34;frontend&#34;</span>
</span></span></code></pre></div><p><span id="receivers"><strong>receivers</strong></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">receivers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">email_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">to</span>: <span style="color:#e6db74">&#39;xxxxx@.com&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">send_resolved</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p><span id="template"><strong>template</strong></span></p>
<p><span id="inhibit_rules"><a href="https://prometheus.io/docs/alerting/latest/configuration/#inhibit_rule" target="_blank"><strong>inhibit_rules</strong></a></span></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Inhibition rules allow to mute(静音) a alert according to another alert</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">route</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">inhibit_rules</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 同一alertname的警报，如果存在 `critical` 级别的报警，则抑制 `warning` 级别的警报</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">source_matchers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">severity=&#34;critical&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">target_matchers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">severity=&#34;warning&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># alertname 相等</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">equal</span>: [<span style="color:#e6db74">&#39;alertname&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># DEPRECATED: Use target_matchers below.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Matchers that have to be fulfilled in the alerts to be muted.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">target_match</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[ &lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;labelvalue&gt;, ... ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DEPRECATED: Use target_matchers below.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">target_match_re</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[ &lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;regex&gt;, ... ]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># A list of matchers that have to be fulfilled by the target </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># alerts to be muted.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">target_matchers</span>:
</span></span><span style="display:flex;"><span>  [ - <span style="color:#ae81ff">&lt;matcher&gt; ... ]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DEPRECATED: Use source_matchers below.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Matchers for which one or more alerts have to exist for the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># inhibition to take effect.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">source_match</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[ &lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;labelvalue&gt;, ... ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DEPRECATED: Use source_matchers below.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">source_match_re</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[ &lt;labelname&gt;</span>: <span style="color:#ae81ff">&lt;regex&gt;, ... ]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># A list of matchers for which one or more alerts have </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># to exist for the inhibition to take effect.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">source_matchers</span>:
</span></span><span style="display:flex;"><span>  [ - <span style="color:#ae81ff">&lt;matcher&gt; ... ]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Labels that must have an equal value in the source and target</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># alert for the inhibition to take effect.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[ equal</span>: <span style="color:#e6db74">&#39;[&#39;</span> <span style="color:#ae81ff">&lt;labelname&gt;, ... &#39;]&#39; ]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master prometheus<span style="color:#f92672">]</span><span style="color:#75715e"># curl http://10.4.7.10:9093/-/healthy </span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master prometheus<span style="color:#f92672">]</span><span style="color:#75715e"># curl http://10.4.7.10:9093/-/ready</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master prometheus<span style="color:#f92672">]</span><span style="color:#75715e"># curl -X POST http://10.4.7.10:9093/-/reload</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c5c6014e5263533687c85e13e12dcd41">11.3 - amtool</h1>
    <div class="lead">amtool|alertmanager|prometheus</div>
	<h3 id="amtool">amtool</h3>
<p><code>amtool</code> is a cli tool for interacting with the Alertmanager API.</p>
<p>go get github.com/prometheus/alertmanager/cmd/amtool</p>
<p>配置文件</p>
<blockquote>
<p>需要配置到<code>/etc/amtool/config.yml</code></p>
<p>或<code>$HOME/.confg/amtool/config.yml</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /etc/amtool/config.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alertmanager.url: http://127.0.0.1:9093
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">author: &#34;1209233066@qq.com&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">require-comment: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output: josn
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">date.format: &#34;2006-01-02 15:04:05 MST&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>命令</th>
          <th>子命令</th>
          <th>举例</th>
          <th>举例解释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>alert</td>
          <td></td>
          <td><font color=#78bd5b80>amtool alert</font></td>
          <td>查看所有告警</td>
      </tr>
      <tr>
          <td></td>
          <td>add</td>
          <td><font color=#6ed6c680>amtool alert add alertname=test labe-a=value-b </font></td>
          <td>添加一个名称为<code>test</code>的带有标签为：<code>labe-a=value-b</code>的告警</td>
      </tr>
      <tr>
          <td></td>
          <td>query</td>
          <td><font color=#bda85b80>amtool alert query alertname=test labe-a=value-b</font></td>
          <td>查看指定标签的告警</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td><font color=#bda85b80>amtool alert query alertname=test labe-a=value-b -o json</font></td>
          <td>json 格式展示告警详细信息</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td><font color=#bda85b80>amtool alert query alertname=test labe-a=value-b -o extended</font></td>
          <td>扩展格式显示告警</td>
      </tr>
      <tr>
          <td>silence</td>
          <td></td>
          <td><font color=#78bd5b80>amtool silence </font></td>
          <td>查看所有维护期的告警</td>
      </tr>
      <tr>
          <td></td>
          <td>add</td>
          <td><font color=#6ed6c680>amtool silence add alertname=test labe-a=value-b  &ndash;commen “this is test”</font></td>
          <td>添加一个名称为<code>test</code>的带有标签为：<code>labe-a=value-b</code>的维护期，默认1h</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td><font color=#6ed6c680>amtool silence add alertname=test labe-a=value-b  &ndash;commen “this is test” &ndash;duration=&ldquo;2h&rdquo;</font></td>
          <td>设置2h维护期</td>
      </tr>
      <tr>
          <td></td>
          <td>query</td>
          <td><font color=#bda85b80>amtool silence query alertname=test labe-a=value-b -o extended</font></td>
          <td>查看指定标签的维护期</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td><font color=#bda85b80>amtool silence query alertname=test labe-a=value-b -o json</font></td>
          <td>json 格式展示维护期的详细信息</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td><font color=#bda85b80>amtool silence query alertname=test labe-a=value-b -o extended</font></td>
          <td>扩展格式显示维护期</td>
      </tr>
      <tr>
          <td></td>
          <td>expire</td>
          <td><font color=#f63bce80>amtool silence expire 223eb624-f49d-498d-ac7d-34bb7570adea</font></td>
          <td>提前取消维护期(id 通过 amtool silence 查询)</td>
      </tr>
      <tr>
          <td>config</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>template</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>check-config</td>
          <td></td>
          <td>amtool check-config alertmanager.yml</td>
          <td></td>
      </tr>
  </tbody>
</table>

</div>



    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-1ecaff05acb725a9eaabec72c0c0fa35">告警收敛</h1>
	<div class="lead">告警收敛,减少告警噪音</div>
	<div class="td-byline mb-4">
		By <b>wangendao</b> |
        
		<time datetime="2025-06-26" class="text-body-secondary">Thursday, June 26, 2025</time>
        
	</div>
	<p>需求：
1.按照故障等级，故障名称进行告警收敛
顶级路由<code>group_wait</code> 和 <code>repeat_interval</code> 验证步骤：</p>
<ol>
<li>发送告警示例1，预期30s后收到告警</li>
<li>等待步骤1完成后，再次发送告警示例1，预期10m + 30s 后收到告警
顶级路由<code>group_interval</code>  验证步骤：</li>
<li>发送告警示例1，在过20s后发送告警示例2，预期在告警2发送后20s收到告警</li>
</ol>
<p>子路由 <code>group_wait</code> 和 <code>repeat_interval</code> 验证步骤：</p>
<ol>
<li>发送告警示例3，预期10m后收到告警</li>
<li>等待步骤1完成后，再次发送告警示例3，预期1h后收到告警</li>
</ol>
<p>子路由 <code>group_interval</code>  验证步骤：</p>
<ol>
<li>发送告警示例3，在过5m后发送告警示例4，预期在告警4发送后10m收到告警</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resolve_timeout</span>: <span style="color:#ae81ff">30m</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">route</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">receiver</span>: <span style="color:#e6db74">&#39;webhook&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group_by</span>: [<span style="color:#e6db74">&#39;alertname&#39;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group_wait</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">repeat_interval</span>: <span style="color:#ae81ff">10m</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">receiver</span>: <span style="color:#e6db74">&#39;webhook&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group_by</span>: [<span style="color:#e6db74">&#39;alertname&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group_wait</span>: <span style="color:#ae81ff">10m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group_interval</span>: <span style="color:#ae81ff">20m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">repeat_interval</span>: <span style="color:#ae81ff">1h</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">alertname=~&#34;database|web&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">severity=&#34;E4&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">receivers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;webhook&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">webhook_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">url</span>: <span style="color:#e6db74">&#39;http://127.0.0.1:5001&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">send_resolved</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div>
  
  
  
  
<ul class="nav nav-tabs" id="tabs-0" role="tablist">
  <li class="nav-item">
      <button class="nav-link active"
          id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
          data-td-tp-persist="告警示例1" aria-controls="tabs-00-00" aria-selected="true">
        告警示例1
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
          data-td-tp-persist="告警示例2" aria-controls="tabs-00-01" aria-selected="false">
        告警示例2
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
          data-td-tp-persist="告警示例3" aria-controls="tabs-00-02" aria-selected="false">
        告警示例3
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
          data-td-tp-persist="告警示例4" aria-controls="tabs-00-03" aria-selected="false">
        告警示例4
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-0-content">
    <div class="tab-body tab-pane fade show active"
        id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;[
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;labels&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;alertname&#34;: &#34;cpuHigh&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;instance&#34;: &#34;node01:9100&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;job&#34;: &#34;node_exporter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;severity&#34;: &#34;E3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;annotations&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;description&#34;: &#34;node01:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 89.99%)&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;summary&#34;: &#34;Instance node01:9100 cpu usage more than 85%&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;generatorURL&#34;: &#34;http://prometheus.pytc.com/prom&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]&#39;</span> <span style="color:#e6db74">&#34;http://127.0.0.1:9093/alert/api/v2/alerts&#34;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;[
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;labels&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;alertname&#34;: &#34;cpuHigh&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;instance&#34;: &#34;node02:9100&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;job&#34;: &#34;node_exporter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;severity&#34;: &#34;E3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;annotations&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;description&#34;: &#34;node02:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 99.99%)&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;summary&#34;: &#34;Instance node02:9100 cpu usage more than 85%&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;generatorURL&#34;: &#34;http://prometheus.pytc.com/prom&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]&#39;</span> <span style="color:#e6db74">&#34;http://127.0.0.1:9093/alert/api/v2/alerts&#34;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;[
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;labels&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;alertname&#34;: &#34;database&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;instance&#34;: &#34;node01:9100&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;job&#34;: &#34;node_exporter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;severity&#34;: &#34;E3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;annotations&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;description&#34;: &#34;node01:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 89.99%)&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;summary&#34;: &#34;Instance node01:9100 cpu usage more than 85%&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;generatorURL&#34;: &#34;http://prometheus.pytc.com/prom&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]&#39;</span> <span style="color:#e6db74">&#34;http://127.0.0.1:9093/alert/api/v2/alerts&#34;</span>
</span></span></code></pre></div>
    </div>
    <div class="tab-body tab-pane fade"
        id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0">
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;[
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;labels&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;alertname&#34;: &#34;database&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;instance&#34;: &#34;node01:9100&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;job&#34;: &#34;node_exporter&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;severity&#34;: &#34;E4&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;annotations&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;description&#34;: &#34;node01:9100 of job node_exporter has been used cpu &gt;85 more than 5 minutes. (current value: 89.99%)&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;summary&#34;: &#34;Instance node01:9100 cpu usage more than 85%&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;generatorURL&#34;: &#34;http://prometheus.pytc.com/prom&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]&#39;</span> <span style="color:#e6db74">&#34;http://127.0.0.1:9093/alert/api/v2/alerts&#34;</span>
</span></span></code></pre></div>
    </div>
</div>


</div>





    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3c434868253797ecc1f1e40600c22b80">12 - monitor</h1>
    <div class="lead">exporter|prometheus</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-8d14d03086c49edb38caab12c6d62a82">12.1 - prometheus</h1>
    
	<ol>
<li>
<p>部署安装</p>
<p>参见部署<a href="zh-cn/%e5%ae%89%e8%a3%85promethues">prometheus</a></p>
</li>
<li>
<p>添加prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">prometheus</span>: <span style="color:#ae81ff">prom-xxx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">prometheus</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">5s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;localhost:9090&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>常用指标</p>
<table>
  <thead>
      <tr>
          <th>指标</th>
          <th>释义</th>
          <th>指标类型</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>prometheus_config_last_reload_successful</code></td>
          <td>最后重启是否成功 1 表示成功 0表示失败</td>
          <td></td>
      </tr>
      <tr>
          <td><code>ceil(time()-prometheus_config_last_reload_success_timestamp_seconds)</code></td>
          <td>最后成功重启的距离现在过去了多少秒</td>
          <td></td>
      </tr>
      <tr>
          <td><code>prometheus_notifications_alertmanagers_discovered</code></td>
          <td>发现alertmanager并处于活跃状态</td>
          <td></td>
      </tr>
      <tr>
          <td><code>delta(prometheus_notifications_dropped_total[1h])</code></td>
          <td>由于发生错误而导致发送到alert 失败的告警数量</td>
          <td></td>
      </tr>
      <tr>
          <td><code>prometheus_notifications_sent_total</code></td>
          <td>自最后一次启动发送了多少条告警通知</td>
          <td></td>
      </tr>
      <tr>
          <td><code>prometheus_notifications_queue_capacity</code></td>
          <td>prometheus 处理告警队列的配额</td>
          <td></td>
      </tr>
      <tr>
          <td><code>prometheus_notifications_queue_length</code></td>
          <td>有多少条告警位于当前队列中</td>
          <td></td>
      </tr>
      <tr>
          <td><code>irate(process_cpu_seconds_total{ job=&quot;prometheus&quot;}[15m])</code></td>
          <td>cpu 使用时长</td>
          <td></td>
      </tr>
      <tr>
          <td><code>process_open_fds{ job=&quot;prometheus&quot;}</code></td>
          <td>已打开文件描述符数量</td>
          <td></td>
      </tr>
      <tr>
          <td><code>prometheus_engine_query_duration_seconds</code></td>
          <td>prometheus 引擎查询响应时长</td>
          <td>summary</td>
      </tr>
      <tr>
          <td><code>sum(rate(prometheus_tsdb_head_samples_appended_total[15m]))</code></td>
          <td>指标采集率</td>
          <td></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>evaluation_intervalrule_group_iterations_missed_total
</span></span></code></pre></div><p>空间预估</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 预估磁盘大小</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># needed_disk_space = retention_time_seconds * ingested_samples_per_second * bytes_per_sample</span>
</span></span><span style="display:flex;"><span>						86400（1天）		   *  10000/s  					 * 2byte
</span></span></code></pre></div></li>
<li>
<p>告警</p>
<ol>
<li>服务不可用 [严重]</li>
<li>查询响应高[警告]</li>
<li>存在告警发出失败[警告]</li>
</ol>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5605bee91439f7db78272ae6244fd177">12.2 - alertmanager</h1>
    
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">alertmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_path</span>: <span style="color:#e6db74">&#34;/alert/metrics&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">9093</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8fb98d401496b16c1a7d7ad67b7b3bb1">12.3 - pushgateway</h1>
    
	<blockquote>
<p>pushgateway 用于将瞬时指标推送到prometheus，更倾向于解决服务级别的指标暴露，对于主机级别的瞬时指标可以使用<a href="https://github.com/prometheus/node_exporter/blob/master/README.md#textfile-collector" target="_blank">textfile</a></p>
</blockquote>
<p><font color=#102b6a><strong>安装部署</strong></font></p>

<details>
  <summary>Details</summary>
  <blockquote>
<p><code>docker run -d -p 9091:9091 prom/pushgateway</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">externalIPs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">10.4.7.10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9091</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">9091</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">prom/pushgateway:v1.5.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">9091</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">web.enable-admin-api</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">500m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">1024Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">200m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">512Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>: 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9091</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/-/ready</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>: 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9091</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/-/healthy</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>
</span></span></code></pre></div></details>

<p><font color=#102b6a><strong>指标推送</strong></font></p>
<ul>
<li>推送指标 <code>metrics_01{job=&quot;my_job&quot;} 1.0</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># metrics_01 和metrics_02 为自定义指标名称</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># job=&#34;my_job&#34;  为job名称</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;metrics_01 1.0&#34;</span> | curl --data-binary @-  http://127.0.0.1:9091/metrics/job/my_job
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;metrics_02 2.0&#34;</span> | curl --data-binary @- http://127.0.0.1:9091/metrics/job/my_job
</span></span></code></pre></div><ul>
<li>推送指标 <code>metrics_01{job=&quot;my_job&quot;,instance=&quot;host01&quot;,env=&quot;test&quot;} 1.0</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># /metrics/job/&lt;JOB_NAME&gt;{/&lt;LABEL_NAME&gt;/&lt;LABEL_VALUE&gt;}</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;metrics_01 1.0&#34;</span> | curl --data-binary @- http://127.0.0.1:9091/metrics/job/my_job/instance/host01/env/test
</span></span></code></pre></div><ul>
<li>删除指标</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#75715e"># 删除分组为job=&#34;my_job&#34;的指标</span>
</span></span><span style="display:flex;"><span> curl -X DELETE http://127.0.0.1:9091/metrics/job/my_job
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># 删除分组为job=&#34;my_job&#34; ,instance=&#34;host01&#34; 的指标</span>
</span></span><span style="display:flex;"><span>curl -X DELETE http://127.0.0.1:9091/metrics/job/my_job/instance/host01
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除所有分组指标，启动时需要开启--web.enable-admin-api</span>
</span></span><span style="display:flex;"><span>curl -X PUT http://127.0.0.1:9091/api/v1/admin/wipe
</span></span></code></pre></div><p><font color=#102b6a><strong>对接到promethues</strong></font></p>


<div class="alert alert-primary" role="alert">


    <code>honor_labels: true</code>,否则后面设置的job，instance等标签将会被舍弃

</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus</span>: <span style="color:#ae81ff">prom-xxx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">pushgateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">honor_labels</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;localhost:9091&#34;</span>
</span></span></code></pre></div><p><font color=#102b6a><strong>pushgatway开启认证</strong></font></p>
<p><em>使用httpd:2-aplines镜像生成bcrypt类型密码，使用格式如下：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it httpd:2-alpine htpasswd -nBC <span style="color:#ae81ff">12</span> admin
</span></span></code></pre></div><p><em>生成认证配置文件</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 加密密码123</span>
</span></span><span style="display:flex;"><span>cat &gt;auth.yaml<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basic_auth_users:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  admin: &#34;$2y$12$jmxtk0MBfUe6AsW5cWKhU.vsYLkaVkTfWgu3JKWxFcdwGzNpfGYKW&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p><em>启动带认证的pushgatway</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pushgateway  --web.config.file<span style="color:#f92672">=</span>auth.yaml
</span></span></code></pre></div><p><em>功能验证</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;metrics_01 1.0&#34;</span> | curl -u admin:123  --data-binary @-  http://127.0.0.1:9091/metrics/job/my_job
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> prometheus_client <span style="color:#f92672">import</span> CollectorRegistry, Gauge, push_to_gateway
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> prometheus_client.exposition <span style="color:#f92672">import</span> basic_auth_handler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">my_auth_handler</span>(url, method, timeout, headers, data):
</span></span><span style="display:flex;"><span>    username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;admin&#39;</span>
</span></span><span style="display:flex;"><span>    password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;123&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> basic_auth_handler(url, method, timeout, headers, data, username, password)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>registry <span style="color:#f92672">=</span> CollectorRegistry()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>g <span style="color:#f92672">=</span> Gauge(<span style="color:#e6db74">&#39;job_last_success_unixtime&#39;</span>, <span style="color:#e6db74">&#39;Last time a batch job successfully finished&#39;</span>, registry<span style="color:#f92672">=</span>registry)
</span></span><span style="display:flex;"><span>g<span style="color:#f92672">.</span>set_to_current_time()
</span></span><span style="display:flex;"><span>push_to_gateway(<span style="color:#e6db74">&#39;localhost:9091&#39;</span>, job<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;batchA&#39;</span>, registry<span style="color:#f92672">=</span>registry, handler<span style="color:#f92672">=</span>my_auth_handler)
</span></span></code></pre></div><p>参考:</p>
<p><a href="https://github.com/prometheus/client_python" target="_blank">client_python</a>|<a href="https://prometheus.github.io/client_python/" target="_blank">doc</a></p>
<p><a href="https://github.com/prometheus/client_golang" target="_blank">client_golang</a></p>
<p><a href="http://peter.bourgon.org/go-in-production/#formatting-and-style" target="_blank">Peter Bourgon · Go: Best Practices for Production Environments</a></p>
<p><a href="https://prometheus.io/docs/practices/pushing/" target="_blank">When to use the Pushgateway | Prometheus</a></p>

</div>



    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-09903d68b7f1b7714677112922b831b4">victorametrics</h1>
	<div class="lead">victorametrics|prometheus</div>
	<div class="td-byline mb-4">
		
        
		<time datetime="2025-05-12" class="text-body-secondary">Monday, May 12, 2025</time>
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-8c8d43a049d000cfadffd58670f39f1e">13.1 - victoriaMetrics</h1>
    <div class="lead">victoriaMetrics|prometheus</div>
	<p><a href="https://docs.victoriametrics.com/" target="_blank">doc</a></p>
<h2 id="victoriametrics">VictoriaMetrics</h2>
<p>系统选型，硬件规划，容量规划（磁盘、内存、带宽）</p>
<p><strong>文件系统： 建议选择ext4</strong></p>
<blockquote>
<p>如果您计划在 ext4 分区上存储超过 1TB 的数据或计划将其扩展到 16TB 以上，则建议将以下选项传</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># -O 64bit：启用64位文件系统特性，这允许文件系统支持大于2TB的文件和大于1EB的文件系统。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -O huge_file：启用大文件特性，这允许文件系统支持大于2TB的文件。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -O extent：启用扩展分配特性，这可以提高文件系统的效率，特别是在处理大文件时</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -T huge 选项指定了文件系统的类型</span>
</span></span><span style="display:flex;"><span>mkfs.ext4 ... -O 64bit,huge_file,extent -T huge
</span></span></code></pre></div></blockquote>
<h3 id="简介">简介</h3>
<p><code>VictoriaMetrics</code>是一个兼容<em>prometheus</em>的监控解决方案和分布式时序数据库。相比于<em>prometheus</em>、<em>thanos</em>具有<em>速度快</em>、<em>资源占用量低</em>、<em>可扩展</em>等特征。</p>
<p><strong>版本：</strong></p>
<ul>
<li>
<p>分为企业版和社区版。企业版支持<a href="https://docs.victoriametrics.com/lts-releases/" target="_blank">TLS</a>版本，社区版建议升级到最新版本。</p>
<table>
    <tr>
        <th>版本</th>
        <th>链接</th>
   </tr>
    <tr>
        <td>1.110.x</td>
        <td> https://github.com/VictoriaMetrics/VictoriaMetrics/releases/tag/v1.110.7</td>
    </tr>
    <tr>
        <td>1.102.x</td>
        <td>https://github.com/VictoriaMetrics/VictoriaMetrics/releases/tag/v1.102.20</td>
    </tr>
</table>
</li>
</ul>
<p><strong>主要功能:</strong></p>
<ul>
<li>时序数据库。长期存储prometheus 指标，直接对接grafana。</li>
<li>统一视图。支持多个promethues 对接到victorametrics中统一查询。</li>
<li>简单易用
<ol>
<li>启动文件是一个没有任何依赖的go编译文件</li>
<li>配置完全支持命令行参数</li>
<li>支持兼容promQL 的的查询语言</li>
</ol>
</li>
<li>易扩展。微服务开发，集群化部署。支持对单个/多个组件水平扩展。</li>
<li>支持多种方式数据抓取、采集和回填方式：
<ol>
<li>兼容<code>promethues exporter</code> 格式指标，<a href="https://docs.victoriametrics.com/#how-to-scrape-prometheus-exporters-such-as-node-exporter" target="_blank">exporter可以直接对接victoria</a></li>
<li><a href="https://docs.victoriametrics.com/#prometheus-setup" target="_blank">支持prometheus 远程写入</a></li>
<li>兼容prometheus 格式的数据导入<a href="https://docs.victoriametrics.com/#how-to-import-data-in-prometheus-exposition-format" target="_blank">doc</a></li>
</ol>
</li>
<li>支持标签<a href="https://docs.victoriametrics.com/#relabeling" target="_blank">relabeling</a></li>
</ul>
<p><strong>优势：</strong></p>
<ol>
<li>
<p>内存占用更小</p>
<p>It <a href="https://medium.com/@valyala/insert-benchmarks-with-inch-influxdb-vs-victoriametrics-e31a41ae2893" target="_blank">uses 10x less RAM than InfluxDB</a> and <a href="https://valyala.medium.com/prometheus-vs-victoriametrics-benchmark-on-node-exporter-metrics-4ca29c75590f" target="_blank">up to 7x less RAM than Prometheus, Thanos or Cortex</a> when dealing with millions of unique time series (aka <a href="https://docs.victoriametrics.com/FAQ.html#what-is-high-cardinality" target="_blank">high cardinality</a>).</p>
</li>
<li>
<p>更高的数据压缩比</p>
<p>It provides high data compression, so up to 70x more data points may be stored into limited storage comparing to TimescaleDB according to <a href="https://medium.com/@valyala/when-size-matters-benchmarking-victoriametrics-vs-timescale-and-influxdb-6035811952d4" target="_blank">these benchmarks</a> and up to 7x less storage space is required compared to Prometheus, Thanos or Cortex according to <a href="https://valyala.medium.com/prometheus-vs-victoriametrics-benchmark-on-node-exporter-metrics-4ca29c75590f" target="_blank">this benchmark</a>.</p>
</li>
</ol>
<p><strong>组件：</strong></p>
<p>在VictoriaMetrics 生态中包括以下成员：</p>
<ul>
<li>victoria-metrics : victorias的时序数据库</li>
<li><a href="https://docs.victoriametrics.com/vmagent/" target="_blank">vmagent</a>：服务发现、指标采集服务</li>
<li><a href="https://docs.victoriametrics.com/vmalert/" target="_blank">vmalert</a> ：告警和规则评估服务</li>
<li><a href="https://docs.victoriametrics.com/vmalert-tool/" target="_blank">vmalert-tool</a>: 校验告警和规则语法的工具</li>
<li><a href="https://docs.victoriametrics.com/vmauth/" target="_blank">vmauth</a>：是一个http代理。提供认证、路由、负载均衡的功能</li>
<li><a href="https://docs.victoriametrics.com/vmgateway/" target="_blank">vmgateway</a>：多租户下提供租户限速服务</li>
<li><a href="https://docs.victoriametrics.com/vmctl/" target="_blank">vmctl</a> ：数据迁移和合并工具</li>
<li><a href="https://docs.victoriametrics.com/vmbackup/" target="_blank">vmbackup</a>, <a href="https://docs.victoriametrics.com/vmrestore/" target="_blank">vmrestore</a> and <a href="https://docs.victoriametrics.com/vmbackupmanager/" target="_blank">vmbackupmanager</a> ：数据备份和还原工具</li>
</ul>
<h3 id="快速开始">快速开始</h3>
<ul>
<li>
<p><strong>部署<a href="https://docs.victoriametrics.com/Quick-Start.html" target="_blank">victoriaMetrics</a></strong></p>
<blockquote>
<p>功能实现： 启动单实例victoriaMetrics, 并将node-exporter中指标存储到victoria中</p>
<p>监听端口 8428</p>
<p>参数解释：</p>
<ul>
<li><code>-storageDataPath</code>数据文件默认存储在当前工作目录中<code>./victoria-metrics-data</code></li>
<li><code>-retentionPeriod</code>数据保存周期默认30d</li>
<li><code>-promscrape.config.strictParse</code> 必须严格遵守promethues.yaml 规则，主要用于校验<code>-promscrape.config</code> 参数指定的配置文件。默认为true</li>
<li><code>-promscrape.config</code> 指定抓取exporter的配置文件</li>
</ul>
</blockquote>
<p><strong>二进制方式</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.79.13/victoria-metrics-linux-amd64-v1.79.13.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar xf victoria-metrics-linux-amd64-v1.79.13.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /opt/victoria-metrics/<span style="color:#f92672">{</span>bin,conf,data<span style="color:#f92672">}</span> -p
</span></span><span style="display:flex;"><span>useradd victoria -s /usr/sbin/nologin
</span></span><span style="display:flex;"><span>cp victoria-metrics-prod  /opt/victoria-metrics/bin/
</span></span><span style="display:flex;"><span>chown -R victoria:victoria  /opt/victoria-metrics
</span></span></code></pre></div><blockquote>
<p><code>-storageDataPath=/opt/victoria-metrics/data </code> 数据存储目录</p>
<p><code>-retentionPeriod=1d </code> 保留存储的数据。默认31d, 最短1d</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /usr/lib/systemd/system/victoria.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=victoria service https://victoriametrics.com/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/victoria-metrics/bin/victoria-metrics-prod \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-storageDataPath=/opt/victoria-metrics/data \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-retentionPeriod=1d \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-promscrape.config.strictParse=false \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-promscrape.config=/etc/victoria-metrics/scrape.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=victoria
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>采集<em>node-exporter</em>指标</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee /etc/victoria-metrics/scrape.yml&lt;&lt;EOF
</span></span><span style="display:flex;"><span>scrape_configs:
</span></span><span style="display:flex;"><span>- job_name: pcloudcore
</span></span><span style="display:flex;"><span>  honor_labels: true
</span></span><span style="display:flex;"><span>  honor_timestamps: true
</span></span><span style="display:flex;"><span>  scrape_interval: 30s
</span></span><span style="display:flex;"><span>  scrape_timeout: 10s
</span></span><span style="display:flex;"><span>  metrics_path: /metrics
</span></span><span style="display:flex;"><span>  scheme: http
</span></span><span style="display:flex;"><span>  follow_redirects: true
</span></span><span style="display:flex;"><span>  enable_http2: true
</span></span><span style="display:flex;"><span>  static_configs:
</span></span><span style="display:flex;"><span>  - targets:
</span></span><span style="display:flex;"><span>    - 127.0.0.1:9100
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable victoria --now
</span></span></code></pre></div><p><span style="color:red">截止到这里victoriaMetrics 已经可以正常工作了，访问http://xxxx:8428验证功能</span></p>
</li>
<li>
<p><strong>对接prometheus</strong> <sub>prometheus版本 v2.12.0+</sub></p>
<blockquote>
<p><font color=orange size=5px>[info]</font></p>
<ol>
<li>
<p>promethues远程写入会导致promethues内存使用 上浮25%左右</p>
</li>
<li>
<p>对于高负载的 Prometheus 实例（每秒 200k+ 个样本），可以应用以下调整：</p>
<p><sub><code>queue_config</code> 字段，用于配置 <code>remote_write</code> 的发送队列:<br><br><code>max_samples_per_send</code>: 一个 HTTP 请求中包含的最大样本数，默认值为 <code>0</code>，表示没有限制。如果远程写入端点要求HTTP请求能够包含有限数量的样本，则可以设置此项。当超过指定数量时，Prometheus 会自动将队列中的数据拆分成多个请求来发送。<br><br><code>capacity</code>: 发送队列的最大缓存容量。当队列中的样本数量超过此值时，Prometheus 将会阻塞新的写入操作，直到队列中的样本数量下降到可接受的范围内。注意，队列满了时不会丢弃数据，而是会将新写入的数据缓存起来，等待队列有足够容量之后再进行发送。<br><br><code>max_shards</code>: 配置发送队列线程池中最大的线程数，默认值为 <code>1</code>。当 <code>remote_write</code> 并发写入的数量较大时，可以将此值调大，以便更快地处理写入请求。</sub></p>
<p>需要注意的是，队列中的数据可能会占用的内存较大，因此需要根据实际情况仔细考虑合理的配置。在实际使用时，应根据数据规模、写入速度、服务器资源等因素逐步调整参数，以平衡发送队列的性能和稳定性。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">remote_write</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">url</span>: <span style="color:#ae81ff">http://&lt;victoriametrics-addr&gt;:8428/api/v1/write</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">queue_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max_samples_per_send</span>: <span style="color:#ae81ff">10000</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">capacity</span>: <span style="color:#ae81ff">20000</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max_shards</span>: <span style="color:#ae81ff">30</span>
</span></span></code></pre></div></li>
</ol>
</blockquote>
<ol>
<li>
<p>为promethues添加全局标签（多个prometheus向同一victorametrics远程写入数据时）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">datacenter</span>: <span style="color:#ae81ff">dc-123</span>
</span></span></code></pre></div></li>
<li>
<p>增加远程写入</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># promethues.yml 中开启远程写入</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">remote_write</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">url</span>: <span style="color:#ae81ff">http://&lt;victoriametrics-addr&gt;:8428/api/v1/write</span>
</span></span></code></pre></div></li>
</ol>
</li>
<li>
<p><strong>对接grafana</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 数据源选择prometheus，地址填写</span>
</span></span><span style="display:flex;"><span>http://&lt;victoriametrics-addr&gt;:8428
</span></span></code></pre></div></li>
</ul>
<h3 id="集群架构"><a href="https://docs.victoriametrics.com/Cluster-VictoriaMetrics.html" target="_blank">集群架构</a></h3>
<p>集群模式支持单体架构的所有功能，同时<strong>支持多租户</strong>的功能。考虑到架构复杂度，官方建议指标采集率在 100w/s 时，可以使用单体架构。</p>
<h4 id="架构图">架构图</h4>
<p>VictoriaMetrics 集群由以下服务组成：</p>
<ul>
<li><code>vmstorage</code>- 存储原始数据，并返回给定标签过滤器在给定时间范围内查询的数据</li>
<li><code>vminsert</code>- 接受摄取的数据，并根据指标名称及其所有标签的一致哈希值将其分布在节点之间<code>vmstorage</code></li>
<li><code>vmselect</code>- 通过从所有配置的节点获取所需的数据来执行传入查询<code>vmstorage</code></li>
</ul>
<p><img src="https://docs.victoriametrics.com/victoriametrics/Cluster-VictoriaMetrics_cluster-scheme.webp" alt="img"></p>
<h4 id="安装部署">安装部署</h4>
<blockquote>
<p><font color=orange size=5px>[info]</font></p>
<p><sub>victoraMetrics 属于io密集型应用，<a href="https://docs.victoriametrics.com/BestPractices.html" target="_blank">官方建议使用ext4 文件系统</a>,如果计划存储超过1TB 文件系统格式化时添加一下参数：</sub></p>
<p><sub><code>mkfs.ext4 ... -O 64bit,huge_file,extent -T huge</code><br>例如：<br>
<code>lvcreate -n test -L 1g data</code><br>
<code>mkfs.ext4 /dev/data/test -O 64bit,huge_file,extent -T huge</code></sub></p>
</blockquote>
<table>
  <thead>
      <tr>
          <th>主机名</th>
          <th>ip</th>
          <th>服务(端口)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>victora-dev01-s2</td>
          <td>192.168.0.226</td>
          <td>|vmstorage(8400 8401 8482)|vminsert(8480) |vmselect(8481)</td>
      </tr>
      <tr>
          <td>victora-dev02-s2</td>
          <td>192.168.0.227</td>
          <td>|vmstorage(8400 8401 8482)|vminsert(8480) |vmselect(8481)</td>
      </tr>
      <tr>
          <td>victora-dev03-s2</td>
          <td>192.168.0.228</td>
          <td>|vmstorage(8400 8401 8482)|vminsert(8480) |vmselect(8481)</td>
      </tr>
  </tbody>
</table>
<ol>
<li>
<p><strong>软件下载</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pvcreate /dev/sdb
</span></span><span style="display:flex;"><span>vgcreate victora /dev/sdb
</span></span><span style="display:flex;"><span>lvcreate -L 49GB victora -n data
</span></span><span style="display:flex;"><span>mkfs.ext4 /dev/mapper/victora-data 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>base_dir<span style="color:#f92672">=</span>/data/victoriaMetrics
</span></span><span style="display:flex;"><span>mkdir $base_dir -p
</span></span><span style="display:flex;"><span>echo /dev/mapper/victora-data  $base_dir ext4 defaults <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>  &gt;&gt;/etc/fstab
</span></span><span style="display:flex;"><span>mount -a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df -hT <span style="color:#e6db74">${</span>base_dir<span style="color:#e6db74">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>version<span style="color:#f92672">=</span>v1.93.16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>/victoria-metrics-linux-amd64-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-cluster.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir <span style="color:#e6db74">${</span>base_dir<span style="color:#e6db74">}</span>/<span style="color:#f92672">{</span>bin,conf,data,log<span style="color:#f92672">}</span> -p
</span></span><span style="display:flex;"><span>tar xf victoria-metrics-linux-amd64-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>-cluster.tar.gz -C <span style="color:#e6db74">${</span>base_dir<span style="color:#e6db74">}</span>/bin
</span></span></code></pre></div></li>
<li>
<p><strong>安装vmstorage</strong></p>
<blockquote>
<p>vmstorage 同时监听 8400 8401 8482</p>
<p>8400 接受 vminsert 的写入</p>
<p>8401 接受 vmselect 的查询</p>
<p>8482 对接文件存储</p>
</blockquote>
<p>节点1：</p>
<blockquote>
<p><code>-retentionPeriod</code> 默认保留期为 1 个月。最短保留期为 24 小时或 1 天</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ipaddr<span style="color:#f92672">=</span>192.168.0.228
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tee /etc/systemd/system/vmstorage.service<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=victoriaMetrics vmstorage serveice
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=${base_dir}/bin/vmstorage-prod \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-storageDataPath ${base_dir}/data \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-retentionPeriod 10d \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-httpListenAddr ${ipaddr}:8482 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-vminsertAddr ${ipaddr}:8400 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-vmselectAddr ${ipaddr}:8401 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p><strong>安装vminsert</strong></p>
<blockquote>
<p>监听8480</p>
<p><code>-storageNode</code> 支持多个，用逗号分隔</p>
</blockquote>
<p>节点1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ipaddr<span style="color:#f92672">=</span>192.168.0.226
</span></span><span style="display:flex;"><span>storageNodeInsert<span style="color:#f92672">=</span>192.168.0.226:8400,192.168.0.227:8400,192.168.0.228:8400
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tee /etc/systemd/system/vminsert.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=victoriaMetrics vminsert serveice
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=${base_dir}/bin/vminsert-prod \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-storageNode=${storageNodeInsert} \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-httpListenAddr ${ipaddr}:8480
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p><strong>安装vmselect</strong></p>
<blockquote>
<p>监听8481</p>
<p><code>-storageNode</code> 支持多个，用逗号分隔</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ipaddr<span style="color:#f92672">=</span>192.168.0.227
</span></span><span style="display:flex;"><span>storageNodeSelect<span style="color:#f92672">=</span>192.168.0.226:8401,192.168.0.227:8401,192.168.0.228:8401
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tee /etc/systemd/system/vmselect.service<span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=victoriaMetrics vmselect serveice
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=${base_dir}/bin/vmselect-prod \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-storageNode=${storageNodeSelect} \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-httpListenAddr ${ipaddr}:8481
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div></li>
<li>
<p><strong>启动服务</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl enable vminsert --now <span style="color:#f92672">&amp;&amp;</span> systemctl status vminsert 
</span></span><span style="display:flex;"><span>systemctl enable vmselect --now <span style="color:#f92672">&amp;&amp;</span> systemctl status vmselect 
</span></span><span style="display:flex;"><span>systemctl enable vmstorage --now <span style="color:#f92672">&amp;&amp;</span> systemctl status vmstorage
</span></span></code></pre></div></li>
<li>
<p><strong>读写验证</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 写入测试</span>
</span></span><span style="display:flex;"><span>curl -d <span style="color:#e6db74">&#39;metric_name{foo=&#34;bar&#34;} 123&#39;</span> -X POST http://192.168.0.226:8480/insert/1/prometheus/api/v1/import/prometheus
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询测试</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.226:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除测试</span>
</span></span><span style="display:flex;"><span>curl -v http://192.168.0.226:8481/delete/1/prometheus/api/v1/admin/tsdb/delete_series -d <span style="color:#e6db74">&#39;match[]=metric_name&#39;</span>
</span></span></code></pre></div></li>
<li>
<p><strong>修改prometheus配置</strong></p>
<blockquote>
<p>对于高负载的 Prometheus 实例（每秒 200k+ 个样本），可以应用以下调整：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>remote_write:
</span></span><span style="display:flex;"><span>  - url: http://&lt;victoriametrics-addr&gt;:8480/insert/0/prometheus
</span></span><span style="display:flex;"><span>    queue_config:
</span></span><span style="display:flex;"><span>      max_samples_per_send: <span style="color:#ae81ff">10000</span>
</span></span><span style="display:flex;"><span>      capacity: <span style="color:#ae81ff">20000</span>
</span></span><span style="display:flex;"><span>      max_shards: <span style="color:#ae81ff">30</span>
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>remote_write:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#- url: http://&lt;victoriametrics-host&gt;:8480/insert/&lt;tenantId&gt;/&lt;suffix&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># prometheus and - for ingesting data with Prometheus remote write API.prometheus/api/v1/write</span>
</span></span><span style="display:flex;"><span>  - url: http://10.4.7.250:8480/insert/0/prometheus
</span></span><span style="display:flex;"><span>  - url: http://10.4.7.251:8480/insert/0/prometheus
</span></span></code></pre></div></li>
<li>
<p><strong>配置grafana数据源</strong></p>
<blockquote>
<p>victoraMetrics 与 grafana 存在兼容性问题：</p>
<ol>
<li>VictoriaMetrics v1.44 - v1.58.x 与 Grafana 5.0 - 7.5.x 兼容。</li>
<li>VictoriaMetrics v1.59.x - v1.65.x 与 Grafana 5.3 - 8.1.x 兼容（需要输入默认的 Prometheus 插件 URL）。</li>
</ol>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#http://&lt;victoriametrics-host&gt;:8480/insert/&lt;tenantId&gt;/&lt;suffix&gt;</span>
</span></span><span style="display:flex;"><span>http://10.4.7.250:8481/select/0/prometheus
</span></span></code></pre></div></li>
<li>
<p><strong>victoraMetrics ui</strong>【非必须】</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http://10.4.7.250:8481/select/0/vmui/
</span></span></code></pre></div></li>
<li>
<p><strong>组件暴露的监控指标</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>10.4.7.250:8480/metrics
</span></span><span style="display:flex;"><span>10.4.7.250:8481/metrics
</span></span><span style="display:flex;"><span>10.4.7.250:8482/metrics
</span></span></code></pre></div></li>
</ol>
<h4 id="vmauth"><strong>vmauth</strong></h4>
<p>vmauth 提供http的反向代理和用户鉴权认证</p>
<blockquote>
<p>8427</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>version<span style="color:#f92672">=</span>v1.93.16
</span></span><span style="display:flex;"><span>wget https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>/vmutils-linux-amd64-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xf vmutils-linux-amd64-<span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span>.tar.gz -C  <span style="color:#e6db74">${</span>base_dir<span style="color:#e6db74">}</span>/bin
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">tee ${base_dir}/conf/vmauth.yml &lt;&lt;EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">unauthorized_user</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">url_map</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">src_paths</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;/insert/.*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url_prefix</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;http://192.168.0.226:8480/&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;http://192.168.0.227:8480/&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;http://192.168.0.228:8480/&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">src_paths</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;/select/.*&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;/delete/.*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url_prefix</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;http://192.168.0.226:8481&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;http://192.168.0.227:8481&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;http://192.168.0.228:8481&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ipaddr<span style="color:#f92672">=</span>192.168.0.226
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tee /etc/systemd/system/vmauth.service <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=victoriaMetrics vmauth serveice
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=${base_dir}/bin/vmauth-prod -auth.config ${base_dir}/conf/vmauth.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-configCheckInterval 20s \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-httpListenAddr &#34;:8427&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl enable vmauth --now <span style="color:#f92672">&amp;&amp;</span> systemctl status vmauth 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 写入测试</span>
</span></span><span style="display:flex;"><span>curl -d <span style="color:#e6db74">&#39;metric_name{foo=&#34;bar&#34;} 456&#39;</span> -X POST http://192.168.0.226:8427/insert/1/prometheus/api/v1/import/prometheus
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询测试</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.226:8427/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.226:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.227:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.228:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除测试</span>
</span></span><span style="display:flex;"><span>curl -v http://192.168.0.226:8427/delete/1/prometheus/api/v1/admin/tsdb/delete_series -d <span style="color:#e6db74">&#39;match[]=metric_name&#39;</span>
</span></span></code></pre></div><p><strong>添加认证： 用户名和密码</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee <span style="color:#e6db74">${</span>base_dir<span style="color:#e6db74">}</span>/conf/vmauth.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">users:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- username: foo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  password: bar
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  url_map:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - src_paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;/insert/.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url_prefix:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.226:8480/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.227:8480/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.228:8480/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - src_paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;/select/.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;/delete/.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url_prefix:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.226:8481&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.227:8481&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.228:8481&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 写入测试</span>
</span></span><span style="display:flex;"><span>curl -ufoo:bar -d <span style="color:#e6db74">&#39;metric_name{foo=&#34;bar&#34;} 456&#39;</span> -X POST http://192.168.0.226:8427/insert/1/prometheus/api/v1/import/prometheus
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询测试</span>
</span></span><span style="display:flex;"><span>curl -ufoo:bar http://192.168.0.226:8427/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.226:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.227:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>curl http://192.168.0.228:8481/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除测试</span>
</span></span><span style="display:flex;"><span>curl -ufoo:bar -v http://192.168.0.226:8427/delete/1/prometheus/api/v1/admin/tsdb/delete_series -d <span style="color:#e6db74">&#39;match[]=metric_name&#39;</span>
</span></span></code></pre></div><p><strong>添加认证：token认证</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tee <span style="color:#e6db74">${</span>base_dir<span style="color:#e6db74">}</span>/conf/vmauth.yml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">users:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- bearer_token: ABCDEF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  url_map:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - src_paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;/insert/.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url_prefix:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.226:8480/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.227:8480/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.228:8480/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - src_paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;/select/.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;/delete/.*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url_prefix:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.226:8481&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.227:8481&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;http://192.168.0.228:8481&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl  -H <span style="color:#e6db74">&#34;Authorization: Bearer ABCDEF&#34;</span> -d <span style="color:#e6db74">&#39;metric_name{foo=&#34;bar&#34;} 789&#39;</span> -X POST http://192.168.0.226:8427/insert/1/prometheus/api/v1/import/prometheus
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl  -H <span style="color:#e6db74">&#34;Authorization: Bearer ABCDEF&#34;</span>  http://192.168.0.226:8427/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl  -H <span style="color:#e6db74">&#34;Authorization: Bearer ABCDEF&#34;</span>   http://192.168.0.226:8427/select/1/prometheus/api/v1/query -d <span style="color:#e6db74">&#39;query=metric_name&#39;</span>
</span></span></code></pre></div><h4 id="集群环境数据高可用">集群环境数据高可用</h4>
<p>默认数据是hash 后分片存储的，可以在vminsert 中修改参数，设置数据的高可用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./vminsert-prod --help|gep repli
</span></span><span style="display:flex;"><span>-replicationFactor int
</span></span><span style="display:flex;"><span>        Replication factor <span style="color:#66d9ef">for</span> the ingested data, i.e. how many copies to make among distinct -storageNode instances. Note that vmselect must run with -dedup.minScrapeInterval<span style="color:#f92672">=</span>1ms <span style="color:#66d9ef">for</span> data de-duplication when replicationFactor is greater than 1. Higher values <span style="color:#66d9ef">for</span> -dedup.minScrapeInterval at vmselect is OK <span style="color:#f92672">(</span>default 1<span style="color:#f92672">)</span>
</span></span></code></pre></div><h3 id="监控">监控</h3>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bfa75dc49b199dd86701654b7a8dd70f">14 - kubernetes</h1>
    <div class="lead">exporter|prometheus</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-25b4a44cfb54668617235e697b78af35">14.1 - kube-apiserver</h1>
    <div class="lead">exporter|prometheus</div>
	<ol>
<li>
<p>部署安装</p>
</li>
<li>
<p>添加prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kube-apiserver</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">honor_timestamps</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">follow_redirects</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enable_http2</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">192.168.0.244</span>:<span style="color:#ae81ff">6443</span>
</span></span></code></pre></div></li>
<li>
<p>常用指标</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cacert /etc/kubernetes/ssl/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert /etc/kubernetes/ssl/apiserver-kubelet-client.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key /etc/kubernetes/ssl/apiserver-kubelet-client.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>https://10.4.7.12:6443/metrics
</span></span></code></pre></div></blockquote>
<ul>
<li>
<p>apiserver 进程是否正常</p>
<pre tabindex="0"><code>up{job=&#34;kube-apiserver&#34;}
</code></pre></li>
<li>
<p>每秒QPS</p>
</li>
<li>
<p>API调用延时</p>
</li>
<li>
<p>ETCD调用延时</p>
</li>
</ul>
</li>
</ol>
<table>
  <thead>
      <tr>
          <th>指标名</th>
          <th>含义</th>
          <th>类型</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>apiserver_request_total</td>
          <td>请求总数</td>
          <td>counter</td>
      </tr>
      <tr>
          <td>apiserver_audit_event_total</td>
          <td>包含所有暴露的审计事件数量的指标。</td>
          <td>counter</td>
      </tr>
      <tr>
          <td>apiserver_audit_error_total</td>
          <td>在暴露时由于发生错误而被丢弃的事件的数量</td>
          <td>counter</td>
      </tr>
      <tr>
          <td>apiserver_request_duration_seconds_sum</td>
          <td>请求耗时</td>
          <td>gauge</td>
      </tr>
      <tr>
          <td>apiserver_request_duration_seconds_count</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>authentication_attempts</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>apiserver_tls_handshake_errors_total</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>apiserver_client_certificate_expiration_seconds_sum</td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><a href="https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/monitor-kube-apiserver" target="_blank">kube-apiserver组件监控介绍和常见异常指标_容器服务Kubernetes版(ACK)-阿里云帮助中心 (aliyun.com)</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7bb3b9db4f2ef41eaaf1bbd09fa2e996">14.2 - kube-controller</h1>
    <div class="lead">exporter|prometheus</div>
	
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e3a8bfe7e2de471dc46cdfcd846b0686">14.3 - kube-controller</h1>
    <div class="lead">exporter|prometheus</div>
	
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b2a97e471d481fe1bb9c8b592ca62eab">14.4 - kube-proxy</h1>
    <div class="lead">exporter|prometheus</div>
	<p>kube-proxy 监听在   http://127.0.0.1:10249/metrics</p>
<p>scheduler 监听在 https://127.0.0.1:10259/metrics</p>
<p>controller-manager监听在 https://127.0.0.1:10257/metrics</p>
<p>coredns http://172.168.0.10:9153/metric</p>
<p>收集k8s事件到mongodb  <a href="https://github.com/AliyunContainerService/kube-eventer" target="_blank">GitHub - AliyunContainerService/kube-eventer: kube-eventer emit kubernetes events to sinks</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>我来解释如何在 Kubernetes 中持久化事件（Events）。
</span></span><span style="display:flex;"><span>Kubernetes 事件默认只保留1小时，如果要持久化存储事件，有以下几种主要方案：
</span></span><span style="display:flex;"><span>使用 Event Exporter
</span></span><span style="display:flex;"><span>这是一个比较常用的方案，可以将 k8s 事件导出到外部存储系统。例如使用官方的 event-exporter：
</span></span><span style="display:flex;"><span>使用 Event Logger
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: event-exporter
</span></span><span style="display:flex;"><span>  namespace: monitoring
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: event-exporter
</span></span><span style="display:flex;"><span>        image: gcr.io/google-containers/event-exporter:v0.3.1
</span></span><span style="display:flex;"><span>        command:
</span></span><span style="display:flex;"><span>        - /event-exporter
</span></span><span style="display:flex;"><span>        - --sink-opts<span style="color:#f92672">=</span>elasticsearch?hosts<span style="color:#f92672">=</span>http://elasticsearch:9200
</span></span><span style="display:flex;"><span>可以部署一个自定义的 event logger，监听集群事件并写入到持久化存储中：
</span></span><span style="display:flex;"><span>修改 kube-apiserver 配置
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: event-logger
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: event-logger
</span></span><span style="display:flex;"><span>        image: k8s-event-logger
</span></span><span style="display:flex;"><span>        env:
</span></span><span style="display:flex;"><span>        - name: STORAGE_TYPE
</span></span><span style="display:flex;"><span>          value: <span style="color:#e6db74">&#34;elasticsearch&#34;</span>
</span></span><span style="display:flex;"><span>        - name: ES_HOST
</span></span><span style="display:flex;"><span>          value: <span style="color:#e6db74">&#34;elasticsearch-service:9200&#34;</span>
</span></span><span style="display:flex;"><span>可以通过修改 kube-apiserver 的配置来延长事件保留时间：
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: kube-apiserver
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - command:
</span></span><span style="display:flex;"><span>    - kube-apiserver
</span></span><span style="display:flex;"><span>    - --event-ttl<span style="color:#f92672">=</span>168h <span style="color:#75715e"># 保留7天</span>
</span></span><span style="display:flex;"><span>常见的事件持久化存储后端包括：
</span></span><span style="display:flex;"><span>Elasticsearch
</span></span><span style="display:flex;"><span>InfluxDB
</span></span><span style="display:flex;"><span>MongoDB
</span></span><span style="display:flex;"><span>MySQL/PostgreSQL
</span></span><span style="display:flex;"><span>建议：
</span></span><span style="display:flex;"><span>根据实际需求选择合适的存储后端
</span></span><span style="display:flex;"><span>注意设置合理的数据保留策略，避免存储空间耗尽
</span></span><span style="display:flex;"><span>考虑事件过滤，只存储重要事件
</span></span><span style="display:flex;"><span>建立监控告警，及时发现异常事件
</span></span><span style="display:flex;"><span>如果你需要具体某个存储方案的详细配置，我可以为你展开说明。
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-92571de61259ce57bcb0c1a9e852b932">14.5 - kubelet</h1>
    <div class="lead">exporter|prometheus</div>
	<p>kubelet 还会在 <code>/metrics/cadvisor</code>， <code>/metrics/resource</code> 和 <code>/metrics/probes</code> 端点中公开度量值</p>
<p>curl 127.0.0.1:10248/healthz</p>
<p>curl 127.0.0.1:10250/healthz</p>
<ol>
<li>
<p>部署安装</p>
<p>参见部署k8s</p>
</li>
<li>
<p>添加prometheus配置</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> prometheus 部署在k8s 内，需要提前rbac授权</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bearer_tonken_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/token  </span>
</span></span></code></pre></div><ul>
<li>
<p><input checked="" disabled="" type="checkbox"> prometheus 部署在k8s 外</p>
<blockquote>
<p>kubernetes_sd_configs 支持通过 api_server 或 kubeconfig_file 方式，二选一</p>
</blockquote>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cacert /etc/kubernetes/pki/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert /etc/kubernetes/pki/apiserver-kubelet-client.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key /etc/kubernetes/pki/apiserver-kubelet-client.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>https://192.168.0.243:10250/metrics
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kubelet</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kubeconfig_file</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:10250&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div><blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -k  -H <span style="color:#e6db74">&#34;Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Ik5jb3R0bGdBVmwtalBuVW9JR0h3VG5nblRkMmVJZUFMdDRVaDd6U1ZNMDQifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImFkbWluLXRva2VuLTduejlwIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiYzEyNjYyNDktMWFkNS00ZjA1LTljZDUtYjhjNTdjYWU2NDkzIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6YWRtaW4ifQ.TXZNfk12OsTh5Z_dkOJOHmIGxV_YNS6QEB-ItgddleoQrlz85S43OMED7mPfnxt9CTuDuuTjRRThXwiw1CF4cdtmwj789IU0z67LyDbkdHC4uUwMnqnQrw3aeSv_dgEHlCJr1btqIImRlxHzxvRsP3Yeqb95hjOqDIMVN_HgfYdk835foAHawrOksHdneMwtoOlpiqjVm9bzjIjEF5ckdVX86hwBu3xB1Ml4R4xZwGIecs06nQoBEKO6MlSARgq8e5VQqdRVip7WJuoAlyq80AYW1gAR7I6RvXJVWECu2NpXzQoTROZ132VyCLAhVQVqf_yLrpnQTTxdOKgvS1tskA&#34;</span> https://192.168.0.243:10250/metrics
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kubelet</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Bearer</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">#提前创建RBAC ,提取sa的secret 中token并保存到文件中 </span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">#kubectl create clusterrolebinding admin --clusterrole=cluster-admin --serviceaccount=default:admin</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">credentials_file</span>: <span style="color:#ae81ff">token</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kubeconfig_file</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:10250&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div></li>
<li>
<p><input checked="" disabled="" type="checkbox"> 通过api_server 执行动态发现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kubelet</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Bearer</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">#提前创建RBAC ,提取sa的secret 中token并保存到文件中 </span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">#kubectl create clusterrolebinding admin --clusterrole=cluster-admin --serviceaccount=default:admin</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">credentials_file</span>: <span style="color:#ae81ff">token</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://127.0.0.1:6443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.pem</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/cert.pem</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/cert.key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:10250&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>常用指标</p>
<p>各节点running容器数量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubelet_running_containers<span style="color:#f92672">{</span>container_state<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;running&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>各个节点运行pod数量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubelet_running_pods
</span></span></code></pre></div><p>各个节点运行ds数量</p>
<p>各个节点运行sts数量</p>
<p>各个节点运行job数量</p>
<p>各个节点运行cronjob数量</p>
<p>各个节点运行pvc数量</p>
<p>各个节点运行pv数量</p>
<p>各个节点容器日志占用量</p>
<p>kubelet 内存使用量</p>
<p>kubelet cpu使用量</p>
<p>节点是否ready</p>
<p>告警</p>
<p>kubelet 进程异常告警</p>
<p>有pod 被驱逐时告警</p>
<p>pod 、cpu 、memory数量即将超过限额告警</p>
<p>Kubelet是Kubernetes集群中的一个核心组件，用于管理和监控运行在节点上的容器。Kubelet会通过暴露一些监控指标来提供关于其自身和节点的健康状况、资源使用情况和性能数据。以下是一些kubelet暴露的常见监控指标：</p>
<ol>
<li>
<p>kubelet_runtime_operations_errors_total：Kubelet在容器运行时处理期间遇到的错误数。</p>
</li>
<li>
<p>kubelet_runtime_operations_latency_seconds：Kubelet处理容器运行时操作的延迟时间。</p>
</li>
<li>
<p>kubelet_volume_stats_available_bytes：节点上可用的存储卷容量。</p>
</li>
<li>
<p>kubelet_volume_stats_capacity_bytes：存储卷的总容量。</p>
</li>
<li>
<p>kubelet_volume_stats_used_bytes：已使用的存储卷容量。</p>
</li>
<li>
<p>kubelet_node_status_capacity_cpu_cores：节点上可用的CPU核心数量。</p>
</li>
<li>
<p>kubelet_node_status_capacity_memory_bytes：节点上可用的内存容量。</p>
</li>
<li>
<p>kubelet_node_status_allocatable_cpu_cores：节点上分配给Pod的可用CPU核心数量。</p>
</li>
<li>
<p>kubelet_node_status_allocatable_memory_bytes：节点上分配给Pod的可用内存容量。</p>
</li>
<li>
<p>kubelet_node_status_kubelet_version：Kubelet的版本信息。</p>
</li>
<li>
<p>kubelet_node_status_machine_id：节点的机器ID。</p>
</li>
<li>
<p>kubelet_node_status_system_uptime：节点的系统运行时间。</p>
</li>
<li>
<p>kubelet_volume_stats_inodes：存储卷的Inode使用情况。</p>
</li>
</ol>
<p>这些指标可以通过Prometheus等监控系统进行收集和分析，以监控和调优Kubernetes集群中的节点和容器的运行情况。</p>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-31806350774a7c031b15b5c616430c3e">14.6 - etcd</h1>
    <div class="lead">exporter|prometheus</div>
	<ol>
<li>
<p>部署安装</p>
<p>参见部署k8s</p>
<blockquote>
<p><sub>【参数说明】</sub></p>
<p><sub>snapshot-count  每50000次修改执行一次snapshot</sub></p>
<p><sub>auto-compaction-retention  自动压缩，默认为 0 不开启</sub></p>
<p><sub>max-request-bytes 单个请求最大字节，默认1.5MB</sub></p>
<p><sub>quota-backend-bytes  指定数据库在磁盘上的配额大小，默认2GB</sub></p>
<p><sub>heartbeat-interval leader向leaner发送心跳周期，默认 100ms</sub></p>
<p><sub>election-timeout  选举超时,默认1s</sub></p>
<p><sub>max-snapshots 最大保留快照数，默认 5 个</sub></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/opt/kube/bin/etcd <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --name<span style="color:#f92672">=</span>master3 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --cert-file<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --key-file<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --peer-cert-file<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --peer-key-file<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --trusted-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --peer-trusted-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --initial-advertise-peer-urls<span style="color:#f92672">=</span>https://10.4.7.12:2380 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --listen-peer-urls<span style="color:#f92672">=</span>https://10.4.7.12:2380 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --listen-client-urls<span style="color:#f92672">=</span>https://10.4.7.12:2379,http://127.0.0.1:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --advertise-client-urls<span style="color:#f92672">=</span>https://10.4.7.12:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --initial-cluster-token<span style="color:#f92672">=</span>etcd-cluster-0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --initial-cluster<span style="color:#f92672">=</span>master1<span style="color:#f92672">=</span>https://10.4.7.22:2380,master2<span style="color:#f92672">=</span>https://10.4.7.21:2380,master3<span style="color:#f92672">=</span>https://10.4.7.12:2380 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --initial-cluster-state<span style="color:#f92672">=</span>new <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --data-dir<span style="color:#f92672">=</span>/var/lib/etcd/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --snapshot-count<span style="color:#f92672">=</span><span style="color:#ae81ff">50000</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --auto-compaction-retention<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --max-request-bytes<span style="color:#f92672">=</span><span style="color:#ae81ff">10485760</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --enable-v2<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --quota-backend-bytes<span style="color:#f92672">=</span><span style="color:#ae81ff">8589934592</span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>always
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>LimitNOFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>OOMScoreAdjust<span style="color:#f92672">=</span>-999
</span></span></code></pre></div></li>
<li>
<p>添加prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;etcd&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/etcd/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/etcd/peer.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/etcd/peer.key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;192.168.0.244:2379&#39;</span>
</span></span></code></pre></div></li>
<li>
<p><a href="https://etcd.io/docs/v3.6/metrics/" target="_blank">监控指标</a></p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cacert /etc/kubernetes/pki/etcd/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert /etc/kubernetes/pki/etcd/peer.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key /etc/kubernetes/pki/etcd/peer.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>https://10.4.7.12:2379/metrics
</span></span></code></pre></div></blockquote>
<p>指标主要包含 ：</p>
<ul>
<li><strong>Server</strong>相关，所有指标以<code>etcd_server</code> 开头。</li>
<li><strong>Disk</strong>相关，所有指标以`etcd_disk 开头</li>
<li><strong>Network</strong>相关，所有指标以<code>etcd_network</code> 开头</li>
<li><strong>mvcc</strong>相关 ，所有指标以<code>etcd_mvcc</code> 开头</li>
<li><strong>snap</strong>相关，所有指标以<code>etcd_snap</code> 开头</li>
<li><strong>degugging</strong>相关，所有指标以<code>etcd_degugging</code> 开头</li>
</ul>
<p><strong>Server</strong>相关，所有指标以<code>etcd_server</code> 开头</p>
<table>
  <thead>
      <tr>
          <th>名称</th>
          <th>描述</th>
          <th>类型</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>etcd_server_has_leader</code></td>
          <td>是否存在leader。1表示存在，0表示不存在</td>
          <td>Gauge</td>
      </tr>
      <tr>
          <td><code>etcd_server_leader_changes_seen_total</code></td>
          <td>主从切换的总次数</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td><code>etcd_server_proposals_committed_total</code></td>
          <td>协商一致提交的请求</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td><code>etcd_server_proposals_applied_total</code></td>
          <td>协商一致处理的请求</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td><code>etcd_server_proposals_pending</code></td>
          <td>排队等待提交的提案数量</td>
          <td>Gauge</td>
      </tr>
      <tr>
          <td><code>etcd_server_proposals_failed_total</code></td>
          <td>失败的提案</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td><code>etcd_server_quota_backend_bytes</code></td>
          <td>数据库配额（磁盘）</td>
          <td>Gauge</td>
      </tr>
  </tbody>
</table>
<p><strong>Disk</strong>相关，所有指标以`etcd_disk 开头</p>
<table>
  <thead>
      <tr>
          <th>名称</th>
          <th>描述</th>
          <th>类型</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>etcd_disk_wal_fsync_duration_seconds</code></td>
          <td>wal 写入磁盘延迟时长</td>
          <td>Histogram</td>
      </tr>
      <tr>
          <td>etcd_disk_<code>backend_commit_duration_seconds</code></td>
          <td>增量快照写入磁盘延迟时长</td>
          <td>Histogram</td>
      </tr>
  </tbody>
</table>
<table>
  <thead>
      <tr>
          <th>名称</th>
          <th>描述</th>
          <th>类型</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>etcd_debugging_mvcc_keys_total</code></td>
          <td>key数量</td>
          <td>Gauge</td>
      </tr>
      <tr>
          <td>etcd_debugging_mvcc_db_total_size_in_bytes</td>
          <td>数据库大小</td>
          <td>Gauge</td>
      </tr>
  </tbody>
</table>
<p><strong>Network</strong>相关，所有指标以<code>etcd_network</code> 开头</p>
<table>
  <thead>
      <tr>
          <th>名称</th>
          <th>描述</th>
          <th>类型</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>peer_sent_bytes_total</td>
          <td>The total number of bytes sent to the peer with ID <code>To</code>.</td>
          <td>Counter(To)</td>
      </tr>
      <tr>
          <td>peer_received_bytes_total</td>
          <td>The total number of bytes received from the peer with ID <code>From</code>.</td>
          <td>Counter(From)</td>
      </tr>
      <tr>
          <td>peer_sent_failures_total</td>
          <td>The total number of send failures from the peer with ID <code>To</code>.</td>
          <td>Counter(To)</td>
      </tr>
      <tr>
          <td>peer_received_failures_total</td>
          <td>The total number of receive failures from the peer with ID <code>From</code>.</td>
          <td>Counter(From)</td>
      </tr>
      <tr>
          <td>peer_round_trip_time_seconds</td>
          <td>Round-Trip-Time histogram between peers.</td>
          <td>Histogram(To)</td>
      </tr>
      <tr>
          <td>client_grpc_sent_bytes_total</td>
          <td>The total number of bytes sent to grpc clients.</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td>client_grpc_received_bytes_total</td>
          <td>The total number of bytes received to grpc clients.</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td>process_open_fds</td>
          <td>Number of open file descriptors.</td>
          <td>Gauge</td>
      </tr>
      <tr>
          <td>process_max_fds</td>
          <td>Maximum number of open file descriptors.</td>
          <td>Gauge</td>
      </tr>
      <tr>
          <td>etcd_server_proposals_applied_total</td>
          <td>接收到的客户端请求</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td>etcd_server_etcd_network_peer_sent_bytes_total</td>
          <td>etcd 成员之间发送的请求</td>
          <td>Counter</td>
      </tr>
      <tr>
          <td>etcd_server_etcd_network_peer_latency_seconds</td>
          <td>etcd 成员之间网络延迟</td>
          <td>Gauge</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>告警规则</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Etcd&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 主从切换</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#e6db74">&#34;EtcdLeaderSwitch&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">etcd_server_is_leader != etcd_server_is_leader offset 10m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#e6db74">&#34;5m&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">etcd</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#e6db74">&#34;warnning&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;Etcd Role changes&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.instace }}&#39;s Role changes before 10 minute,now is {{ $value }}.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 宕机    </span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#e6db74">&#34;EtcdDown&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">up{job=~&#34;.*etcd.*&#34;} == 0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#e6db74">&#34;5m&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">etcd</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#e6db74">&#34;critical&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;Etcd is down &#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.instace }} is down for more than 5 minute.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 缺少leader    </span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#e6db74">&#34;EtcdNoLeader&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: <span style="color:#ae81ff">etcd_server_has_leader == 0 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#e6db74">&#34;5m&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">etcd</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#e6db74">&#34;critical&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;Etcd no leader&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;{{ $labels.instace }} no leader for more than 5 minute.&#34;</span>
</span></span></code></pre></div></li>
</ol>
<p><a href="https://zhuanlan.zhihu.com/p/466274302" target="_blank">etcd 问题、调优、监控 - 知乎 (zhihu.com)</a></p>
<p><a href="http://www.xuyasong.com/?p=1706" target="_blank">etcd 原理解析：读《etcd 技术内幕》 | Vermouth | 博客 | docker | k8s | python | go | 开发 (xuyasong.com)</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5cb338fcb7d2487aba8e3851f63fe4e9">14.7 - coredns</h1>
    <div class="lead">exporter|prometheus</div>
	
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8e244531e3aa17ff54cd0173cf6f4016">14.8 - cadvisor</h1>
    <div class="lead">exporter|prometheus</div>
	<ol>
<li>
<p><a href="https://github.com/google/cadvisor" target="_blank">部署安装</a> cadvisor提供容器资源cpu，内存、网络、文件系统等方面的信息，在k8s环境中通过daemonset 资源来部署相关资源</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>VERSION<span style="color:#f92672">=</span>v0.36.0 <span style="color:#75715e"># use the latest release version from https://github.com/google/cadvisor/releases</span>
</span></span><span style="display:flex;"><span>sudo docker run <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume<span style="color:#f92672">=</span>/:/rootfs:ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume<span style="color:#f92672">=</span>/var/run:/var/run:ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume<span style="color:#f92672">=</span>/sys:/sys:ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume<span style="color:#f92672">=</span>/var/lib/docker/:/var/lib/docker:ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume<span style="color:#f92672">=</span>/dev/disk/:/dev/disk:ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --publish<span style="color:#f92672">=</span>8080:8080 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --detach<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --name<span style="color:#f92672">=</span>cadvisor <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --privileged <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --device<span style="color:#f92672">=</span>/dev/kmsg <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcr.io/cadvisor/cadvisor:$VERSION
</span></span></code></pre></div></li>
<li>
<p>添加prometheus配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>- job_name: cadvisor
</span></span><span style="display:flex;"><span>  static_configs:
</span></span><span style="display:flex;"><span>  - targets:
</span></span><span style="display:flex;"><span>    - 10.4.7.251:8080
</span></span></code></pre></div></li>
<li>
<p>常用指标</p>
<table>
  <thead>
      <tr>
          <th>指标</th>
          <th>注释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>rate(container_cpu_usage_seconds_total{name=&quot;cadvisor&quot;}[1m])</code></td>
          <td>cup负载</td>
      </tr>
      <tr>
          <td><code>container_memory_usage_bytes{name=&quot;cadvisor&quot;}</code></td>
          <td>内存使用率</td>
      </tr>
      <tr>
          <td><code>rate(container_network_transmit_bytes_total{name=&quot;cadvisor&quot;}[1m])</code></td>
          <td>网络发送</td>
      </tr>
      <tr>
          <td><code>rate(container_network_receive_bytes_total{name=&quot;cadvisor&quot;}[1m])</code></td>
          <td>网络接收</td>
      </tr>
  </tbody>
</table>
</li>
</ol>
<p>应用自身指标暴露</p>
<pre tabindex="0"><code>annotations:
  prometheus.io/port: &#34;9153&#34;
  prometheus.io/scrape: &#34;true&#34;
</code></pre><p>github 和招商银行内部使用了内嵌入的cadvisor 配置方式</p>
<ul>
<li>
<p><input checked="" disabled="" type="checkbox"> 通过apiserver</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kubernetes-cadvisor</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">10s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">api_server</span>: <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespaces</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">names</span>: []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">bearer_token_file</span>: <span style="color:#ae81ff">/var/run/secrets/kubernetes.io/serviceaccount/token</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">separator</span>: <span style="color:#ae81ff">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">__meta_kubernetes_node_label_(.+)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">$1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">labelmap</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">separator</span>: <span style="color:#ae81ff">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">kubernetes.default.svc:443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__meta_kubernetes_node_name]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">separator</span>: <span style="color:#ae81ff">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.+)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__metrics_path__</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">/api/v1/nodes/${1}/proxy/metrics/cadvisor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span></code></pre></div></li>
<li>
<p><input checked="" disabled="" type="checkbox"> cadvisor 内嵌在kubelet 中</p>
<blockquote>
<p><em>prometheus运行在k8s外部</em></p>
<p>kubernetes_sd_configs:</p>
<p>​	<code>kubeconfig_file</code> 和 <code>api_server</code> 二选其一</p>
<p>https 可以通过证书方式认证或通过token 方法是认证</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">cadvisor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics/cadvisor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#authorization:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  type: Bearer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  credentials_file: token</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kubeconfig_file</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:10250&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">cadvisor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics/cadvisor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  cert_file: /etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  key_file: /etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Bearer</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">credentials_file</span>: <span style="color:#ae81ff">token</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://192.168.0.244:6443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">(.*):(.*)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#e6db74">&#34;$1:10250&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0f8ec29a41b1721d7cd9fe76cf6dc070">14.9 - kube-state-metrics</h1>
    <div class="lead">exporter|prometheus</div>
	<p><a href="https://github.com/kubernetes/kube-state-metrics" target="_blank">kube-state-metrics</a> 通过监听kube-apiserver生成资源状态指标。包括node、pod、container、deplpyment、statefulset、job、pv、pvc 等。</p>
<p>kube-state-metrics 使用client-go与kubernetes集成，因此在安装时需要选择对应的kubernetes版本。</p>
<blockquote>
<ul>
<li><code>✓</code>完全支持的版本范围。</li>
<li><code>-</code>Kubernetes 集群具有 client-go 库无法使用的功能（额外的 API 对象、已弃用的 API 等）。</li>
</ul>
</blockquote>
<table>
  <thead>
      <tr>
          <th>kube-state-metrics 指标</th>
          <th><strong>Kubernetes 1.20 版本</strong></th>
          <th><strong>Kubernetes 1.21 版本</strong></th>
          <th><strong>Kubernetes 1.22 版本</strong></th>
          <th><strong>Kubernetes 1.23 版本</strong></th>
          <th><strong>Kubernetes 1.24 版本</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>2.3.0 版</strong></td>
          <td>✓</td>
          <td>✓</td>
          <td>✓</td>
          <td>✓</td>
          <td>-</td>
      </tr>
      <tr>
          <td><strong>2.4.2 版</strong></td>
          <td>-/✓</td>
          <td>-/✓</td>
          <td>✓</td>
          <td>✓</td>
          <td>-</td>
      </tr>
      <tr>
          <td><strong>2.5.0 版</strong></td>
          <td>-/✓</td>
          <td>-/✓</td>
          <td>✓</td>
          <td>✓</td>
          <td>✓</td>
      </tr>
      <tr>
          <td><strong>2.6.0 版</strong></td>
          <td>-/✓</td>
          <td>-/✓</td>
          <td>✓</td>
          <td>✓</td>
          <td>✓</td>
      </tr>
  </tbody>
</table>
<hr>
<p>本示例kubernetes 版本 v1.23，kube-state-metrics版本2.6.0</p>
<blockquote>
<p>资源清单位置：kube-state-metrics/examples/standard</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">2.6.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">2.6.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">configmaps</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">secrets</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">nodes</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">pods</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">services</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">serviceaccounts</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">resourcequotas</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">replicationcontrollers</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">limitranges</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">persistentvolumeclaims</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">persistentvolumes</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">namespaces</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">apps</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">statefulsets</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">daemonsets</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">deployments</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">replicasets</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">batch</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">cronjobs</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">jobs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">autoscaling</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">horizontalpodautoscalers</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">authentication.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">tokenreviews</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">subjectaccessreviews</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">policy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">poddisruptionbudgets</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">certificates.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">certificatesigningrequests</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">storage.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">storageclasses</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">volumeattachments</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">admissionregistration.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">mutatingwebhookconfigurations</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">validatingwebhookconfigurations</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">networking.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">networkpolicies</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ingresses</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">coordination.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">leases</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">clusterrolebindings</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">clusterroles</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">rolebindings</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">roles</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">2.6.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">2.6.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">exporter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">2.6.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.6.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/healthz</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http-metrics</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">telemetry</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">capabilities</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">drop</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">ALL</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">readOnlyRootFilesystem</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">65534</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">kubernetes.io/os</span>: <span style="color:#ae81ff">linux</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">2.6.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/external</span>: <span style="color:#ae81ff">192.168.0.243</span> <span style="color:#75715e"># 为项目改造</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/ports</span>: <span style="color:#e6db74">&#34;32080&#34;</span> <span style="color:#75715e"># 为项目改造</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">32080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">http-metrics</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">telemetry</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">telemetry</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span></code></pre></div><ol>
<li>
<p>部署安装</p>
<blockquote>
<p>8080 端口提供k8s 指标</p>
<p>8081 端口提供kube_state_metrics 自身指标</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f kube-state-metrics.yml
</span></span></code></pre></div></li>
<li>
<p>添加prometheus配置</p>
<p>静态配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;kube-state-metrics&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;192.168.0.244:8080&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 添加所属环境</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">environment</span>
</span></span></code></pre></div><p>基于k8s动态发现</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl --cacert /etc/kubernetes/pki/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	 --cert /etc/kubernetes/pki/apiserver-kubelet-client.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	 --key /etc/kubernetes/pki/apiserver-kubelet-client.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	 https://192.168.0.244:6443/api/v1/services?limit<span style="color:#f92672">=</span>100&amp;resourceVersion<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p><code>kubeconfig_file</code>和 <code>api_server</code> 二者选一</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">api_server</span>: <span style="color:#ae81ff">https://192.168.0.244:6443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tls_config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ca_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cert_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key_file</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-kubelet-client.key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 测试改成false也没问题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#34;__meta_kubernetes_service_name&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">action</span>: <span style="color:#ae81ff">keep</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#e6db74">&#34;kube-state-metrics&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source_labels</span>: [<span style="color:#e6db74">&#34;__meta_kubernetes_service_label_prometheus_io_external&#34;</span>,<span style="color:#e6db74">&#34;__meta_kubernetes_service_label_prometheus_io_ports&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">regex</span>: <span style="color:#ae81ff">([0-9\.]+);(\d+)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">$1:$2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">action</span>: <span style="color:#ae81ff">replace</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span></code></pre></div><pre tabindex="0"><code>  - job_name: kube-state-metrics
    kubernetes_sd_configs:
    - kubeconfig_file: config
      role: service
    relabel_configs:
    - source_labels: [&#34;__meta_kubernetes_service_name&#34;]
      action: keep
      regex: &#34;kube-state-metrics&#34;
    - source_labels: [&#34;__meta_kubernetes_service_label_prometheus_io_external&#34;,&#34;__meta_kubernetes_service_label_prometheus_io_ports&#34;]
      regex: ([0-9\.]+);(\d+)
      replacement: $1:$2
      action: replace
      target_label: __address__
</code></pre></li>
<li>
<p>常用指标
集群状态指标是哪个
svc 状态（缺少endpoint）</p>
<ul>
<li>
<p>node</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#节点 数量</span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>kube_node_info<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#不可调度的节点数量</span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>kube_node_spec_unschedulable<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 集群cpu 数量</span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>kube_node_status_capacity<span style="color:#f92672">{</span>resource<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cpu&#34;</span><span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 集群内存 数量</span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">(</span>kube_node_status_capacity<span style="color:#f92672">{</span>resource<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;memory&#34;</span><span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 磁盘存在压力的节点</span>
</span></span><span style="display:flex;"><span>kube_node_status_condition<span style="color:#f92672">{</span>condition<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;DiskPressure&#34;</span>,status<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 内存存在压力的节点</span>
</span></span><span style="display:flex;"><span>kube_node_status_condition<span style="color:#f92672">{</span>condition<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;MemoryPressure&#34;</span>,status<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pid存在压力的节点</span>
</span></span><span style="display:flex;"><span>kube_node_status_condition<span style="color:#f92672">{</span>condition<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;PIDPressure&#34;</span>,status<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 存在网络不可达节点</span>
</span></span><span style="display:flex;"><span>kube_node_status_condition<span style="color:#f92672">{</span>condition<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;NetworkUnavailable&#34;</span>,status<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>namespace</p>
</li>
<li>
<p>pod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kube_pod_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Failed&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Pending&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Running&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Succeeded&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Unknown&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>container</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 容器状态</span>
</span></span><span style="display:flex;"><span>kube_pod_container_status_running
</span></span><span style="display:flex;"><span>kube_pod_container_status_waiting
</span></span><span style="display:flex;"><span>kube_pod_container_status_ready
</span></span><span style="display:flex;"><span>kube_pod_container_status_terminated
</span></span><span style="display:flex;"><span>kube_pod_container_status_terminated_reason
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 30分钟内重启过的pod</span>
</span></span><span style="display:flex;"><span>changes<span style="color:#f92672">(</span>kube_pod_container_status_restarts_total<span style="color:#f92672">[</span>30m<span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 容器资源配额</span>
</span></span><span style="display:flex;"><span>kube_pod_container_resource_requests<span style="color:#f92672">{</span>resource<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cpu&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_container_resource_limits<span style="color:#f92672">{</span>resource<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cpu&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_container_resource_requests<span style="color:#f92672">{</span>resource<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;memory&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_pod_container_resource_limits<span style="color:#f92672">{</span>resource<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;memory&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>replicaset</p>
</li>
<li>
<p>deploy</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#各个deployment的副本数量</span>
</span></span><span style="display:flex;"><span>kube_deployment_status_replicas
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#各个deployment不可用的副本数量</span>
</span></span><span style="display:flex;"><span>kube_deployment_status_replicas_unavailable
</span></span></code></pre></div></li>
<li>
<p>daemonset</p>
</li>
<li>
<p>sts</p>
</li>
<li>
<p>job</p>
</li>
<li>
<p>cronjob</p>
</li>
<li>
<p>service</p>
</li>
<li>
<p>endpoint</p>
</li>
<li>
<p>ingress</p>
</li>
<li>
<p>storageclass</p>
</li>
<li>
<p>persistentvolume</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kube_persistentvolume_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Available&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_persistentvolume_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Bound&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_persistentvolume_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Failed&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_persistentvolume_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Pending&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_persistentvolume_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Released&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>persistentvolumeclaim</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kube_persistentvolumeclaim_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Bound&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_persistentvolumeclaim_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Lost&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>kube_persistentvolumeclaim_status_phase<span style="color:#f92672">{</span>phase<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Pending&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>configmap</p>
</li>
<li>
<p>secret</p>
</li>
<li>
<p>poddisruptionbudget</p>
</li>
<li>
<p>horizontalpodautoscaler</p>
</li>
<li>
<p>networkpolicy</p>
</li>
<li>
<p>lease</p>
</li>
<li>
<p>limitrange</p>
</li>
<li>
<p>mutatingwebhookconfiguration</p>
</li>
<li>
<p>validatingwebhookconfiguration</p>
</li>
<li>
<p>volumeattachment</p>
</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-state-metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">KubeStateMetricsListErrors</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#ae81ff">kube-state-metrics is experiencing errors at an elevated rate in list operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#ae81ff">kube-state-metrics is experiencing errors in list operations.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      (sum(rate(kube_state_metrics_list_total{job=&#34;kube-state-metrics&#34;,result=&#34;error&#34;}[5m]))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        /
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      sum(rate(kube_state_metrics_list_total{job=&#34;kube-state-metrics&#34;}[5m])))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &gt; 0.01</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">15m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">KubeStateMetricsWatchErrors</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#ae81ff">kube-state-metrics is experiencing errors at an elevated rate in watch operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#ae81ff">kube-state-metrics is experiencing errors in watch operations.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      (sum(rate(kube_state_metrics_watch_total{job=&#34;kube-state-metrics&#34;,result=&#34;error&#34;}[5m]))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        /
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      sum(rate(kube_state_metrics_watch_total{job=&#34;kube-state-metrics&#34;}[5m])))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &gt; 0.01</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">15m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">KubeStateMetricsShardingMismatch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#ae81ff">kube-state-metrics pods are running with different --total-shards configuration, some Kubernetes objects may be exposed multiple times or not exposed at all.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#ae81ff">kube-state-metrics sharding is misconfigured.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      stdvar (kube_state_metrics_total_shards{job=&#34;kube-state-metrics&#34;}) != 0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">15m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">alert</span>: <span style="color:#ae81ff">KubeStateMetricsShardsMissing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#ae81ff">kube-state-metrics shards are missing, some Kubernetes objects are not being exposed.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#ae81ff">kube-state-metrics shards are missing.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">expr</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      2^max(kube_state_metrics_total_shards{job=&#34;kube-state-metrics&#34;}) - 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      sum( 2 ^ max by (shard_ordinal) (kube_state_metrics_shard_ordinal{job=&#34;kube-state-metrics&#34;}) )
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      != 0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">for</span>: <span style="color:#ae81ff">15m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">severity</span>: <span style="color:#ae81ff">critical</span>
</span></span></code></pre></div>
</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="联系我" aria-label="联系我">
    <a target="_blank" rel="noopener" href="/about/#%e8%81%94%e7%b3%bb%e6%96%b9%e5%bc%8f" aria-label="联系我">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="微信" aria-label="微信">
    <a target="_blank" rel="noopener" href="/about/#%e8%81%94%e7%b3%bb%e6%96%b9%e5%bc%8f" aria-label="微信">
      <i class="fa-brands fa-weixin"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">零露云©2025版权所有</span>
      </div>
    </div>
  </div>
</footer>

    </div>
    
  <script type="module" async>
  import mermaid from "https:\/\/cdn.jsdelivr.net\/npm\/mermaid@10.9.0\/dist\/mermaid.esm.min.mjs";

  (function ($) {
    if ($('.mermaid').length == 0) {
      mermaid.initialize({ startOnLoad: false });
      return;
    }

    var params = {"version":"10.9.0"};

    
    
    var norm = function (defaultConfig, params) {
      var result = {};
      for (const key in defaultConfig) {
        const keyLower = key.toLowerCase();
        if (defaultConfig.hasOwnProperty(key) && params.hasOwnProperty(keyLower)) {
          if (typeof defaultConfig[key] === "object") {
            result[key] = norm(defaultConfig[key], params[keyLower]);
          } else {
            result[key] = params[keyLower];
          }
        }
      }
      return result;
    };

    var settings = norm(mermaid.mermaidAPI.defaultConfig, params);
    settings.startOnLoad = true;
    if ($('html[data-bs-theme="dark"]').length) {
      settings.theme = 'dark';
    }
    mermaid.initialize(settings);

    
    const lightDarkModeThemeChangeHandler = function (mutationsList, observer) {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
          
          
          
          location.reload();
        }
      }
    };

    const observer = new MutationObserver(lightDarkModeThemeChangeHandler);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-bs-theme']
    });
    

  })(jQuery);
</script>
<script src="/js/main.min.bf0cab613e991fc11bc28a4a07b0aedef47c7c7c2595703ac3adf962fd6a8099.js" integrity="sha256-vwyrYT6ZH8EbwopKB7Cu3vR8fHwllXA6w635Yv1qgJk=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
